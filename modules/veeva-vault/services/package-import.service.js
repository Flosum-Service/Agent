const a336_0x20cefd=a336_0x190a;(function(_0xeb9fc2,_0x310cfd){const _0x24665b=a336_0x190a,_0x577ba4=_0xeb9fc2();while(!![]){try{const _0x4efc4f=parseInt(_0x24665b(0xab))/0x1*(parseInt(_0x24665b(0x9c))/0x2)+-parseInt(_0x24665b(0xac))/0x3+-parseInt(_0x24665b(0xc0))/0x4*(-parseInt(_0x24665b(0x8d))/0x5)+parseInt(_0x24665b(0x80))/0x6+-parseInt(_0x24665b(0x87))/0x7+parseInt(_0x24665b(0x8b))/0x8+parseInt(_0x24665b(0x9f))/0x9*(-parseInt(_0x24665b(0x94))/0xa);if(_0x4efc4f===_0x310cfd)break;else _0x577ba4['push'](_0x577ba4['shift']());}catch(_0x46a89b){_0x577ba4['push'](_0x577ba4['shift']());}}}(a336_0x578a,0x23c1b));const a336_0x3d42bc=(function(){let _0x3ae668=!![];return function(_0x3b07e9,_0x3562ae){const _0x56c9b4=_0x3ae668?function(){const _0x4e70ce=a336_0x190a;if(_0x3562ae){const _0x24e242=_0x3562ae[_0x4e70ce(0xdb)](_0x3b07e9,arguments);return _0x3562ae=null,_0x24e242;}}:function(){};return _0x3ae668=![],_0x56c9b4;};}()),a336_0x22921e=a336_0x3d42bc(this,function(){const _0x3d7e9d=a336_0x190a;return a336_0x22921e[_0x3d7e9d(0xd9)]()[_0x3d7e9d(0x97)]('(((.+)+)+)+$')[_0x3d7e9d(0xd9)]()['constructor'](a336_0x22921e)[_0x3d7e9d(0x97)](_0x3d7e9d(0xd4));});a336_0x22921e();'use strict';var __importDefault=this&&this[a336_0x20cefd(0xa7)]||function(_0xb56f54){const _0xf346=a336_0x20cefd;return _0xb56f54&&_0xb56f54[_0xf346(0x86)]?_0xb56f54:{'default':_0xb56f54};};Object[a336_0x20cefd(0xc4)](exports,a336_0x20cefd(0x86),{'value':!![]}),exports[a336_0x20cefd(0xa5)]=void 0x0;function a336_0x190a(_0xfe63b3,_0x5df778){const _0x350b91=a336_0x578a();return a336_0x190a=function(_0x22921e,_0x3d42bc){_0x22921e=_0x22921e-0x7e;let _0x578afe=_0x350b91[_0x22921e];return _0x578afe;},a336_0x190a(_0xfe63b3,_0x5df778);}const veeva_constants_1=require(a336_0x20cefd(0x90)),status_enums_1=require(a336_0x20cefd(0xcc)),veeva_error_1=require(a336_0x20cefd(0x9a)),form_data_1=__importDefault(require('form-data')),fs_1=require('fs'),veeva_auth_utils_1=require('../utils/veeva-auth.utils'),package_details_dto_1=require('../dtos/package-details.dto'),package_component_dto_1=require(a336_0x20cefd(0x8c)),array_utils_1=require(a336_0x20cefd(0xc2));function a336_0x578a(){const _0x40575e=['__esModule','875644xhytHX','name__v','package_components','Import\x20package','1867712VjhmUu','../dtos/package-component.dto','15DbhPEL','responseDetails','deployment_status__v','../constants/veeva.constants','createReadStream','ArrayUtils','replace','180QvuBlm','errors','Deployment.log','search','_logger','updateVeevaConnection','../classes/errors/veeva-error','PackageDetailsDto','504256nWjiNm','Wait\x20Executing\x20job','SUCCESS','197199XDqnis','links','VeevaPackageStatus','convertDeploymentAction','VeevaConstants','map','PackageImportService','getValidationDetailsAndSaveLog','__importDefault','importVpk','multipart/form-data','_saveLog','1WbHzxF','446940lBRbSK','find','PackageComponentDto','getJobResult','Validation.log','VeevaError','packageComponentList','href','deploymentAction','VERIFIED','deployPackage','DEPLOYED_WITH_WARNINGS','groupUniqueToMap','get','post','file','put','endsWith','Get\x20validation\x20details.','reduce','135488hEQAXX','default','../utils/array.utils','packageId','defineProperty','vaultPackage','status','url','responseStatus','filter','VeevaResponseStatus','formPackageComponentList','../enums/status.enums','getJobDetailUrl','log','Cannot\x20find\x20deployment\x20results','Package\x20not\x20verified','data','filename','Validation\x20Log','(((.+)+)+)+$','{package_id}','artifacts','ENDPOINT_EXPORT_IMPORT_PACKAGE','_veevaService','toString','_connection','apply','ENDPOINT_DEPLOY_PACKAGE','isDeployed','1366326MPHQfS','fillPackageDeploymentAction','getDeployDetailsAndSaveLog','getLogResultText','Deploy\x20Log','Deploy\x20package'];a336_0x578a=function(){return _0x40575e;};return a336_0x578a();}class PackageImportService{constructor({veevaService:_0x18ea14,connection:_0x4b64af,logger:_0x27df01,saveLog:_0x587eef}){const _0x27f900=a336_0x20cefd;this[_0x27f900(0xd8)]=_0x18ea14,this['_connection']=_0x4b64af,this[_0x27f900(0x98)]=_0x27df01,this[_0x27f900(0xaa)]=_0x587eef;}async['importVpk'](_0x4c249f,_0x53575e=0x1){const _0x556e9b=a336_0x20cefd;this[_0x556e9b(0x98)][_0x556e9b(0xce)](_0x556e9b(0x8a));const _0x4fb92f=new form_data_1[(_0x556e9b(0xc1))]();_0x4fb92f['append'](_0x556e9b(0xbb),(0x0,fs_1[_0x556e9b(0x91)])(_0x4c249f));const _0x448667=await this[_0x556e9b(0xda)][_0x556e9b(0xbc)](veeva_constants_1[_0x556e9b(0xa3)][_0x556e9b(0xd7)],_0x4fb92f,{'headers':{'Content-Type':_0x556e9b(0xa9)}}),_0x9bb672=_0x448667['data'];if(_0x9bb672[_0x556e9b(0xc8)]===status_enums_1[_0x556e9b(0xca)][_0x556e9b(0x9e)])return _0x9bb672['url'];else{if(_0x53575e>0x0)return await(0x0,veeva_auth_utils_1[_0x556e9b(0x99)])(this[_0x556e9b(0xda)]),await this[_0x556e9b(0xa8)](_0x4c249f,_0x53575e-0x1);throw new veeva_error_1[(_0x556e9b(0xb1))](_0x9bb672[_0x556e9b(0x95)]);}}async['deployPackage'](_0x2147d5){const _0x60e5fc=a336_0x20cefd;this[_0x60e5fc(0x98)][_0x60e5fc(0xce)](_0x60e5fc(0x85));const _0x4c9b0e=await this[_0x60e5fc(0xda)][_0x60e5fc(0xba)](veeva_constants_1[_0x60e5fc(0xa3)][_0x60e5fc(0x7e)][_0x60e5fc(0x93)](_0x60e5fc(0xd5),_0x2147d5)),_0x17ff76=await _0x4c9b0e[_0x60e5fc(0xd1)];if(_0x17ff76[_0x60e5fc(0xc8)]===status_enums_1[_0x60e5fc(0xca)][_0x60e5fc(0x9e)])return _0x17ff76[_0x60e5fc(0xc7)];else throw new veeva_error_1[(_0x60e5fc(0xb1))](_0x17ff76[_0x60e5fc(0x95)]);}async[a336_0x20cefd(0xcd)](_0x29ddab){const _0x365b7e=a336_0x20cefd;this[_0x365b7e(0x98)][_0x365b7e(0xce)](_0x365b7e(0x9d));const [_0x1df863]=await this['_veevaService'][_0x365b7e(0xaf)]([_0x29ddab]);return _0x1df863[_0x365b7e(0xa0)][_0x365b7e(0xad)](_0x268591=>_0x268591['rel']===_0x365b7e(0xd6))[_0x365b7e(0xb3)];}async[a336_0x20cefd(0xa6)](_0x39d35c){const _0x508359=a336_0x20cefd;this[_0x508359(0x98)][_0x508359(0xce)](_0x508359(0xbe));const {data:_0x4e974e}=await this[_0x508359(0xda)]['get'](_0x39d35c);if(_0x4e974e[_0x508359(0xc8)]===status_enums_1[_0x508359(0xca)][_0x508359(0x9e)]){const _0x5838f7=new package_details_dto_1[(_0x508359(0x9b))](),{log:_0x451121,id:_0x28e906,package_status:_0x58ee7b,package_steps:_0x3b50bd}=_0x4e974e[_0x508359(0xc5)],_0x538dfd=_0x451121[_0x508359(0xc9)](_0x152de6=>_0x152de6[_0x508359(0xd2)][_0x508359(0xbd)](_0x508359(0xb0))),_0x417bfe=await this[_0x508359(0x83)](_0x538dfd[0x0][_0x508359(0xc7)]);await this[_0x508359(0xaa)](_0x417bfe,_0x508359(0xd3)),_0x5838f7[_0x508359(0xc3)]=_0x28e906,_0x5838f7[_0x508359(0xb2)]=this[_0x508359(0xcb)](_0x3b50bd),await this['fillPackageDeploymentAction'](_0x5838f7);if(_0x58ee7b!==status_enums_1['VeevaPackageStatus'][_0x508359(0xb5)])throw new Error(_0x508359(0xd0));return _0x5838f7;}else throw new veeva_error_1['VeevaError'](_0x4e974e[_0x508359(0x95)]);}async['getDeployDetailsAndSaveLog'](_0xffc03b,_0x24ed3c){const _0x15bf3f=a336_0x20cefd;var _0x4451ec;this[_0x15bf3f(0x98)][_0x15bf3f(0xce)]('Get\x20deploy\x20result');const {data:_0x51210e}=await this[_0x15bf3f(0xda)]['get'](_0xffc03b);if(_0x51210e[_0x15bf3f(0xc8)]===status_enums_1['VeevaResponseStatus'][_0x15bf3f(0x9e)]){const {responseDetails:{deployment_log:_0x117f71,package_status__v:_0x458862},package_steps:_0xaf1fd3}=_0x51210e,_0x4f39d6=_0x117f71[_0x15bf3f(0xc9)](_0x49ab6e=>_0x49ab6e[_0x15bf3f(0xd2)][_0x15bf3f(0xbd)](_0x15bf3f(0x96))),_0x3ab4fc=await this[_0x15bf3f(0x83)](_0x4f39d6[0x0][_0x15bf3f(0xc7)]);await this[_0x15bf3f(0xaa)](_0x3ab4fc,_0x15bf3f(0x84)),_0x24ed3c[_0x15bf3f(0x7f)]=[status_enums_1[_0x15bf3f(0xa1)]['DEPLOYED'],status_enums_1['VeevaPackageStatus'][_0x15bf3f(0xb7)]]['includes'](_0x458862);const _0x26d762=array_utils_1[_0x15bf3f(0x92)][_0x15bf3f(0xb8)](this[_0x15bf3f(0xcb)](_0xaf1fd3),({uniqueName:_0x414bfc})=>_0x414bfc);for(const _0x341349 of _0x24ed3c[_0x15bf3f(0xb2)]){const _0x58cc3c=(_0x4451ec=_0x26d762[_0x15bf3f(0xb9)](_0x341349['uniqueName']))===null||_0x4451ec===void 0x0?void 0x0:_0x4451ec['status'];_0x58cc3c&&(_0x341349['status']=_0x58cc3c);}_0x24ed3c['packageComponentList']=_0x24ed3c['packageComponentList'][_0x15bf3f(0xc9)](_0x1588af=>_0x1588af[_0x15bf3f(0xc6)]!==status_enums_1['PackageComponentStatus']['VERIFIED']);if(!_0x24ed3c[_0x15bf3f(0xb2)]['length'])throw new Error(_0x15bf3f(0xcf));return _0x24ed3c;}else throw new veeva_error_1[(_0x15bf3f(0xb1))](_0x51210e[_0x15bf3f(0x95)]);}async['getLogResultText'](_0x112077){const _0x20fc7d=a336_0x20cefd,{data:_0xa3d151}=await this[_0x20fc7d(0xda)][_0x20fc7d(0xb9)](_0x112077,{'responseType':'text'});return _0xa3d151;}[a336_0x20cefd(0xcb)](_0x58bbc7){const _0x2ab271=a336_0x20cefd;return _0x58bbc7[_0x2ab271(0xbf)]((_0x44bfcc,_0x45e485)=>{const _0x1e64c1=_0x2ab271,_0x2a5ae9=_0x45e485[_0x1e64c1(0x89)][_0x1e64c1(0xa4)](_0x3c20ed=>new package_component_dto_1['PackageComponentDto']({'status':_0x45e485[_0x1e64c1(0x8f)],'stepName':_0x45e485[_0x1e64c1(0x88)],'component':_0x3c20ed}));return[..._0x44bfcc,..._0x2a5ae9];},[]);}async[a336_0x20cefd(0x81)](_0x4ebf3d){const _0x33350e=a336_0x20cefd,{data:_0x148bfb}=await this[_0x33350e(0xda)]['post'](veeva_constants_1[_0x33350e(0xa3)]['ENDPOINT_VALIDATE_PACKAGE'][_0x33350e(0x93)]('{package_id}',_0x4ebf3d['packageId']));if(_0x148bfb[_0x33350e(0xc8)]===status_enums_1[_0x33350e(0xca)]['SUCCESS']){const {package_steps:_0x493189}=_0x148bfb[_0x33350e(0x8e)],_0x5bc9f5=array_utils_1['ArrayUtils']['groupToMap'](_0x4ebf3d[_0x33350e(0xb2)],({stepName:_0x258b38})=>_0x258b38);for(const {name__v:_0x39fbed,deployment_action:_0x486fda}of _0x493189){for(const _0x3ee3d3 of _0x5bc9f5[_0x33350e(0xb9)](_0x39fbed)||[]){_0x3ee3d3[_0x33350e(0xb4)]=package_component_dto_1[_0x33350e(0xae)][_0x33350e(0xa2)](_0x486fda);}}}else throw new veeva_error_1[(_0x33350e(0xb1))](_0x148bfb[_0x33350e(0x95)]);}async['import'](_0x3fea1c){const _0x106362=a336_0x20cefd,_0x4a3025=await this[_0x106362(0xa8)](_0x3fea1c),_0x1924ea=await this[_0x106362(0xcd)](_0x4a3025),_0x111cf2=await this[_0x106362(0xa6)](_0x1924ea),_0x59e2a1=await this[_0x106362(0xb6)](_0x111cf2['packageId']),_0x42ee46=await this['getJobDetailUrl'](_0x59e2a1);return this[_0x106362(0x82)](_0x42ee46,_0x111cf2);}}exports[a336_0x20cefd(0xa5)]=PackageImportService;