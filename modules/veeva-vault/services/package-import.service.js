const a336_0x39e327=a336_0x58d9;function a336_0x5665(){const _0x53e09c=['responseStatus','links','getLogResultText','getJobDetailUrl','includes','replace','form-data','../utils/veeva-auth.utils','Cannot\x20find\x20deployment\x20results','VeevaResponseStatus','filename','Get\x20deploy\x20result','Import\x20package','VeevaConstants','1035154JCtAue','Deploy\x20package','endsWith','search','_connection','defineProperty','55587GurroP','_saveLog','DEPLOYED_WITH_WARNINGS','deployPackage','get','__importDefault','multipart/form-data','data','1102746ciBrKt','length','packageComponentList','__esModule','errors','22bKJpJb','filter','../constants/veeva.constants','default','deployment_status__v','50KHzZHm','(((.+)+)+)+$','PackageImportService','ENDPOINT_EXPORT_IMPORT_PACKAGE','_logger','constructor','216LhDeJc','uniqueName','vaultPackage','../utils/array.utils','status','url','2309913xJlqbR','getDeployDetailsAndSaveLog','VERIFIED','_veevaService','VeevaError','PackageComponentDto','updateVeevaConnection','artifacts','toString','SUCCESS','Deployment.log','DEPLOYED','import','packageId','fillPackageDeploymentAction','importVpk','ENDPOINT_VALIDATE_PACKAGE','isDeployed','Deploy\x20Log','apply','1EveGBw','groupUniqueToMap','ArrayUtils','formPackageComponentList','getJobResult','1132800cyorus','log','name__v','Validation.log','find','{package_id}','Package\x20not\x20verified','file','Validation\x20Log','20dmKPdE','459564sYONuC','213520eXcoMT','VeevaPackageStatus','createReadStream'];a336_0x5665=function(){return _0x53e09c;};return a336_0x5665();}(function(_0x4bd687,_0x28c261){const _0xaf761b=a336_0x58d9,_0x4d60ab=_0x4bd687();while(!![]){try{const _0x54b759=-parseInt(_0xaf761b(0x1ba))/0x1*(parseInt(_0xaf761b(0x1db))/0x2)+parseInt(_0xaf761b(0x1e9))/0x3+parseInt(_0xaf761b(0x1ca))/0x4*(-parseInt(_0xaf761b(0x1f3))/0x5)+parseInt(_0xaf761b(0x1bf))/0x6+-parseInt(_0xaf761b(0x1e1))/0x7*(-parseInt(_0xaf761b(0x1a0))/0x8)+parseInt(_0xaf761b(0x1a6))/0x9*(parseInt(_0xaf761b(0x1c8))/0xa)+parseInt(_0xaf761b(0x1ee))/0xb*(parseInt(_0xaf761b(0x1c9))/0xc);if(_0x54b759===_0x28c261)break;else _0x4d60ab['push'](_0x4d60ab['shift']());}catch(_0x392228){_0x4d60ab['push'](_0x4d60ab['shift']());}}}(a336_0x5665,0x4b848));const a336_0x26789c=(function(){let _0x278622=!![];return function(_0x206719,_0x55166b){const _0x2652aa=_0x278622?function(){const _0x838895=a336_0x58d9;if(_0x55166b){const _0x4bed69=_0x55166b[_0x838895(0x1b9)](_0x206719,arguments);return _0x55166b=null,_0x4bed69;}}:function(){};return _0x278622=![],_0x2652aa;};}()),a336_0x52c974=a336_0x26789c(this,function(){const _0xbb8446=a336_0x58d9;return a336_0x52c974['toString']()['search']('(((.+)+)+)+$')[_0xbb8446(0x1ae)]()[_0xbb8446(0x19f)](a336_0x52c974)[_0xbb8446(0x1de)](_0xbb8446(0x1f4));});a336_0x52c974();'use strict';function a336_0x58d9(_0x15578e,_0x58f607){const _0x2583e2=a336_0x5665();return a336_0x58d9=function(_0x52c974,_0x26789c){_0x52c974=_0x52c974-0x19d;let _0x5665cb=_0x2583e2[_0x52c974];return _0x5665cb;},a336_0x58d9(_0x15578e,_0x58f607);}var __importDefault=this&&this[a336_0x39e327(0x1e6)]||function(_0x890c94){return _0x890c94&&_0x890c94['__esModule']?_0x890c94:{'default':_0x890c94};};Object[a336_0x39e327(0x1e0)](exports,a336_0x39e327(0x1ec),{'value':!![]}),exports[a336_0x39e327(0x1f5)]=void 0x0;const veeva_constants_1=require(a336_0x39e327(0x1f0)),status_enums_1=require('../enums/status.enums'),veeva_error_1=require('../classes/errors/veeva-error'),form_data_1=__importDefault(require(a336_0x39e327(0x1d3))),fs_1=require('fs'),veeva_auth_utils_1=require(a336_0x39e327(0x1d4)),package_details_dto_1=require('../dtos/package-details.dto'),package_component_dto_1=require('../dtos/package-component.dto'),array_utils_1=require(a336_0x39e327(0x1a3));class PackageImportService{constructor({veevaService:_0x56317f,connection:_0x439111,logger:_0x5a8be8,saveLog:_0x8c92a7}){const _0x2af28f=a336_0x39e327;this[_0x2af28f(0x1a9)]=_0x56317f,this[_0x2af28f(0x1df)]=_0x439111,this[_0x2af28f(0x19e)]=_0x5a8be8,this[_0x2af28f(0x1e2)]=_0x8c92a7;}async[a336_0x39e327(0x1b5)](_0x174d1f,_0x48b5f9=0x1){const _0x28d32f=a336_0x39e327;this[_0x28d32f(0x19e)]['log'](_0x28d32f(0x1d9));const _0x23069c=new form_data_1[(_0x28d32f(0x1f1))]();_0x23069c['append'](_0x28d32f(0x1c6),(0x0,fs_1[_0x28d32f(0x1cc)])(_0x174d1f));const _0x42f8e3=await this[_0x28d32f(0x1df)]['put'](veeva_constants_1[_0x28d32f(0x1da)][_0x28d32f(0x19d)],_0x23069c,{'headers':{'Content-Type':_0x28d32f(0x1e7)}}),_0x695149=_0x42f8e3[_0x28d32f(0x1e8)];if(_0x695149[_0x28d32f(0x1cd)]===status_enums_1[_0x28d32f(0x1d6)][_0x28d32f(0x1af)])return _0x695149[_0x28d32f(0x1a5)];else{if(_0x48b5f9>0x0)return await(0x0,veeva_auth_utils_1[_0x28d32f(0x1ac)])(this[_0x28d32f(0x1df)]),await this[_0x28d32f(0x1b5)](_0x174d1f,_0x48b5f9-0x1);throw new veeva_error_1[(_0x28d32f(0x1aa))](_0x695149[_0x28d32f(0x1ed)]);}}async[a336_0x39e327(0x1e4)](_0x1efa57){const _0x4f7859=a336_0x39e327;this['_logger'][_0x4f7859(0x1c0)](_0x4f7859(0x1dc));const _0x2f0032=await this[_0x4f7859(0x1df)]['post'](veeva_constants_1[_0x4f7859(0x1da)]['ENDPOINT_DEPLOY_PACKAGE'][_0x4f7859(0x1d2)](_0x4f7859(0x1c4),_0x1efa57)),_0x84c228=await _0x2f0032[_0x4f7859(0x1e8)];if(_0x84c228[_0x4f7859(0x1cd)]===status_enums_1[_0x4f7859(0x1d6)][_0x4f7859(0x1af)])return _0x84c228['url'];else throw new veeva_error_1['VeevaError'](_0x84c228[_0x4f7859(0x1ed)]);}async[a336_0x39e327(0x1d0)](_0x3440ea){const _0x1d31a1=a336_0x39e327;this[_0x1d31a1(0x19e)][_0x1d31a1(0x1c0)]('Wait\x20Executing\x20job');const [_0x9857c6]=await this[_0x1d31a1(0x1a9)][_0x1d31a1(0x1be)]([_0x3440ea]);return _0x9857c6[_0x1d31a1(0x1ce)][_0x1d31a1(0x1c3)](_0x90c6e7=>_0x90c6e7['rel']===_0x1d31a1(0x1ad))['href'];}async['getValidationDetailsAndSaveLog'](_0x441a3b){const _0x1ce4bf=a336_0x39e327;this['_logger'][_0x1ce4bf(0x1c0)]('Get\x20validation\x20details.');const {data:_0x43ff2d}=await this[_0x1ce4bf(0x1df)][_0x1ce4bf(0x1e5)](_0x441a3b);if(_0x43ff2d[_0x1ce4bf(0x1cd)]===status_enums_1[_0x1ce4bf(0x1d6)][_0x1ce4bf(0x1af)]){const _0x255f2b=new package_details_dto_1['PackageDetailsDto'](),{log:_0x130edb,id:_0x4d1da0,package_status:_0xf1a734,package_steps:_0x20346c}=_0x43ff2d[_0x1ce4bf(0x1a2)],_0x1713d6=_0x130edb['filter'](_0x3c2ebc=>_0x3c2ebc[_0x1ce4bf(0x1d7)][_0x1ce4bf(0x1dd)](_0x1ce4bf(0x1c2))),_0x333cd0=await this['getLogResultText'](_0x1713d6[0x0]['url']);await this[_0x1ce4bf(0x1e2)](_0x333cd0,_0x1ce4bf(0x1c7)),_0x255f2b[_0x1ce4bf(0x1b3)]=_0x4d1da0,_0x255f2b[_0x1ce4bf(0x1eb)]=this[_0x1ce4bf(0x1bd)](_0x20346c),await this[_0x1ce4bf(0x1b4)](_0x255f2b);if(_0xf1a734!==status_enums_1[_0x1ce4bf(0x1cb)][_0x1ce4bf(0x1a8)])throw new Error(_0x1ce4bf(0x1c5));return _0x255f2b;}else throw new veeva_error_1['VeevaError'](_0x43ff2d[_0x1ce4bf(0x1ed)]);}async[a336_0x39e327(0x1a7)](_0xbd21b,_0x368e58){const _0x4b365d=a336_0x39e327;var _0x1590b3;this[_0x4b365d(0x19e)][_0x4b365d(0x1c0)](_0x4b365d(0x1d8));const {data:_0x43e0bf}=await this[_0x4b365d(0x1df)][_0x4b365d(0x1e5)](_0xbd21b);if(_0x43e0bf['responseStatus']===status_enums_1[_0x4b365d(0x1d6)][_0x4b365d(0x1af)]){const {responseDetails:{deployment_log:_0x5b4562,package_status__v:_0x2dd23f},package_steps:_0x925cb0}=_0x43e0bf,_0x70b4e8=_0x5b4562[_0x4b365d(0x1ef)](_0x58b501=>_0x58b501['filename']['endsWith'](_0x4b365d(0x1b0))),_0x4fe166=await this['getLogResultText'](_0x70b4e8[0x0][_0x4b365d(0x1a5)]);await this[_0x4b365d(0x1e2)](_0x4fe166,_0x4b365d(0x1b8)),_0x368e58[_0x4b365d(0x1b7)]=[status_enums_1[_0x4b365d(0x1cb)][_0x4b365d(0x1b1)],status_enums_1['VeevaPackageStatus'][_0x4b365d(0x1e3)]][_0x4b365d(0x1d1)](_0x2dd23f);const _0x44a964=array_utils_1[_0x4b365d(0x1bc)][_0x4b365d(0x1bb)](this[_0x4b365d(0x1bd)](_0x925cb0),({uniqueName:_0x20dc26})=>_0x20dc26);for(const _0x547d34 of _0x368e58[_0x4b365d(0x1eb)]){const _0x57202a=(_0x1590b3=_0x44a964[_0x4b365d(0x1e5)](_0x547d34[_0x4b365d(0x1a1)]))===null||_0x1590b3===void 0x0?void 0x0:_0x1590b3[_0x4b365d(0x1a4)];_0x57202a&&(_0x547d34[_0x4b365d(0x1a4)]=_0x57202a);}_0x368e58['packageComponentList']=_0x368e58[_0x4b365d(0x1eb)][_0x4b365d(0x1ef)](_0x45648b=>_0x45648b[_0x4b365d(0x1a4)]!==status_enums_1['PackageComponentStatus'][_0x4b365d(0x1a8)]);if(!_0x368e58[_0x4b365d(0x1eb)][_0x4b365d(0x1ea)])throw new Error(_0x4b365d(0x1d5));return _0x368e58;}else throw new veeva_error_1[(_0x4b365d(0x1aa))](_0x43e0bf[_0x4b365d(0x1ed)]);}async[a336_0x39e327(0x1cf)](_0x427bb4){const _0x467fb5=a336_0x39e327,{data:_0x5df64d}=await this[_0x467fb5(0x1df)][_0x467fb5(0x1e5)](_0x427bb4,{'responseType':'text'});return _0x5df64d;}['formPackageComponentList'](_0x100f4f){return _0x100f4f['reduce']((_0x51839f,_0x95391f)=>{const _0x2304d7=a336_0x58d9,_0x1d4aea=_0x95391f['package_components']['map'](_0xc7a9d2=>new package_component_dto_1['PackageComponentDto']({'status':_0x95391f[_0x2304d7(0x1f2)],'stepName':_0x95391f[_0x2304d7(0x1c1)],'component':_0xc7a9d2}));return[..._0x51839f,..._0x1d4aea];},[]);}async['fillPackageDeploymentAction'](_0x564ace){const _0x3eb2e1=a336_0x39e327,{data:_0x488e78}=await this[_0x3eb2e1(0x1df)]['post'](veeva_constants_1[_0x3eb2e1(0x1da)][_0x3eb2e1(0x1b6)]['replace'](_0x3eb2e1(0x1c4),_0x564ace['packageId']));if(_0x488e78[_0x3eb2e1(0x1cd)]===status_enums_1[_0x3eb2e1(0x1d6)]['SUCCESS']){const {package_steps:_0x3b35c4}=_0x488e78['responseDetails'],_0x22a3f8=array_utils_1[_0x3eb2e1(0x1bc)]['groupToMap'](_0x564ace[_0x3eb2e1(0x1eb)],({stepName:_0x31c002})=>_0x31c002);for(const {name__v:_0x42f42b,deployment_action:_0x45daa2}of _0x3b35c4){for(const _0x191dc2 of _0x22a3f8[_0x3eb2e1(0x1e5)](_0x42f42b)||[]){_0x191dc2['deploymentAction']=package_component_dto_1[_0x3eb2e1(0x1ab)]['convertDeploymentAction'](_0x45daa2);}}}else throw new veeva_error_1[(_0x3eb2e1(0x1aa))](_0x488e78[_0x3eb2e1(0x1ed)]);}async[a336_0x39e327(0x1b2)](_0x39ddc6){const _0x513e2e=a336_0x39e327,_0x506827=await this['importVpk'](_0x39ddc6),_0x17d8bb=await this[_0x513e2e(0x1d0)](_0x506827),_0x3aef60=await this['getValidationDetailsAndSaveLog'](_0x17d8bb),_0x2bacbf=await this[_0x513e2e(0x1e4)](_0x3aef60[_0x513e2e(0x1b3)]),_0x9d74eb=await this['getJobDetailUrl'](_0x2bacbf);return this['getDeployDetailsAndSaveLog'](_0x9d74eb,_0x3aef60);}}exports[a336_0x39e327(0x1f5)]=PackageImportService;