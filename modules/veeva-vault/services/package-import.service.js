const a360_0x3a8e32=a360_0x2753;(function(_0x415419,_0x320cf4){const _0x2596e8=a360_0x2753,_0x25f928=_0x415419();while(!![]){try{const _0x9a391=parseInt(_0x2596e8(0x171))/0x1+-parseInt(_0x2596e8(0x191))/0x2+parseInt(_0x2596e8(0x1bc))/0x3+parseInt(_0x2596e8(0x17d))/0x4*(parseInt(_0x2596e8(0x1a5))/0x5)+parseInt(_0x2596e8(0x189))/0x6+parseInt(_0x2596e8(0x1c9))/0x7*(parseInt(_0x2596e8(0x1ac))/0x8)+parseInt(_0x2596e8(0x17e))/0x9*(-parseInt(_0x2596e8(0x185))/0xa);if(_0x9a391===_0x320cf4)break;else _0x25f928['push'](_0x25f928['shift']());}catch(_0x9ba69f){_0x25f928['push'](_0x25f928['shift']());}}}(a360_0x4453,0xc52a4));function a360_0x2753(_0x41e2aa,_0xc46494){const _0x3a916c=a360_0x4453();return a360_0x2753=function(_0x56737d,_0x44b9cf){_0x56737d=_0x56737d-0x16c;let _0x44538d=_0x3a916c[_0x56737d];return _0x44538d;},a360_0x2753(_0x41e2aa,_0xc46494);}const a360_0x44b9cf=(function(){let _0x34de75=!![];return function(_0x31d4b3,_0x54e219){const _0x40c3cc=_0x34de75?function(){const _0x34b2a6=a360_0x2753;if(_0x54e219){const _0x3e1412=_0x54e219[_0x34b2a6(0x1af)](_0x31d4b3,arguments);return _0x54e219=null,_0x3e1412;}}:function(){};return _0x34de75=![],_0x40c3cc;};}()),a360_0x56737d=a360_0x44b9cf(this,function(){const _0x341c2e=a360_0x2753;return a360_0x56737d['toString']()[_0x341c2e(0x198)](_0x341c2e(0x199))[_0x341c2e(0x170)]()['constructor'](a360_0x56737d)[_0x341c2e(0x198)](_0x341c2e(0x199));});a360_0x56737d();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x4c35de){return _0x4c35de&&_0x4c35de['__esModule']?_0x4c35de:{'default':_0x4c35de};};Object[a360_0x3a8e32(0x1b5)](exports,a360_0x3a8e32(0x17c),{'value':!![]}),exports[a360_0x3a8e32(0x1ae)]=void 0x0;const veeva_constants_1=require(a360_0x3a8e32(0x195)),status_enums_1=require('../enums/status.enums'),veeva_error_1=require(a360_0x3a8e32(0x187)),form_data_1=__importDefault(require('form-data')),fs_1=require('fs'),veeva_auth_utils_1=require('../utils/veeva-auth.utils'),package_details_dto_1=require(a360_0x3a8e32(0x18e)),package_component_dto_1=require(a360_0x3a8e32(0x19a)),array_utils_1=require(a360_0x3a8e32(0x1b8));class PackageImportService{constructor({veevaService:_0xa100ec,connection:_0x416be5,logger:_0x225ef6,saveLog:_0x14e8ff}){const _0x59f5ea=a360_0x3a8e32;this[_0x59f5ea(0x177)]=_0xa100ec,this[_0x59f5ea(0x1c7)]=_0x416be5,this[_0x59f5ea(0x194)]=_0x225ef6,this[_0x59f5ea(0x19f)]=_0x14e8ff;}async['importVpk'](_0xc47f5e,_0x4b0a6b=0x1){const _0x207bbd=a360_0x3a8e32;this[_0x207bbd(0x194)][_0x207bbd(0x1a7)](_0x207bbd(0x1b0));const _0x25e023=new form_data_1['default']();_0x25e023[_0x207bbd(0x19b)](_0x207bbd(0x186),(0x0,fs_1[_0x207bbd(0x1ad)])(_0xc47f5e));const _0x1fad28=await this[_0x207bbd(0x1c7)][_0x207bbd(0x1b2)](veeva_constants_1['VeevaConstants'][_0x207bbd(0x16c)],_0x25e023,{'headers':{'Content-Type':_0x207bbd(0x1b7)}}),_0x4e5e2c=_0x1fad28[_0x207bbd(0x1be)];if(_0x4e5e2c[_0x207bbd(0x1c3)]===status_enums_1[_0x207bbd(0x1a8)][_0x207bbd(0x190)])return _0x4e5e2c[_0x207bbd(0x1bd)];else{if(_0x4b0a6b>0x0)return await(0x0,veeva_auth_utils_1[_0x207bbd(0x18b)])(this['_connection']),await this[_0x207bbd(0x176)](_0xc47f5e,_0x4b0a6b-0x1);throw new veeva_error_1[(_0x207bbd(0x1c1))](_0x4e5e2c[_0x207bbd(0x1bb)]);}}async[a360_0x3a8e32(0x1a0)](_0x48eda1){const _0x5d6137=a360_0x3a8e32;this[_0x5d6137(0x194)][_0x5d6137(0x1a7)](_0x5d6137(0x1b3));const _0x39b219=await this[_0x5d6137(0x1c7)][_0x5d6137(0x18c)](veeva_constants_1['VeevaConstants'][_0x5d6137(0x17f)][_0x5d6137(0x1c6)]('{package_id}',_0x48eda1)),_0x446e66=await _0x39b219[_0x5d6137(0x1be)];if(_0x446e66[_0x5d6137(0x1c3)]===status_enums_1[_0x5d6137(0x1a8)][_0x5d6137(0x190)])return _0x446e66[_0x5d6137(0x1bd)];else throw new veeva_error_1['VeevaError'](_0x446e66[_0x5d6137(0x1bb)]);}async['getJobDetailUrl'](_0x20f01c){const _0x12dd86=a360_0x3a8e32;this[_0x12dd86(0x194)][_0x12dd86(0x1a7)](_0x12dd86(0x197));const [_0x53dde3]=await this[_0x12dd86(0x177)][_0x12dd86(0x1a6)]([_0x20f01c]);return _0x53dde3[_0x12dd86(0x1b6)][_0x12dd86(0x188)](_0x2f7586=>_0x2f7586[_0x12dd86(0x172)]===_0x12dd86(0x178))['href'];}async[a360_0x3a8e32(0x1a4)](_0x21464d){const _0x5f559e=a360_0x3a8e32;this[_0x5f559e(0x194)][_0x5f559e(0x1a7)]('Get\x20validation\x20details.');const {data:_0x1eaedf}=await this[_0x5f559e(0x1c7)][_0x5f559e(0x1c0)](_0x21464d);if(_0x1eaedf[_0x5f559e(0x1c3)]===status_enums_1[_0x5f559e(0x1a8)][_0x5f559e(0x190)]){const _0x266d52=new package_details_dto_1[(_0x5f559e(0x16d))](),{log:_0x3caab7,id:_0x2734d3,package_status:_0x52abdc,package_steps:_0x5889fe}=_0x1eaedf[_0x5f559e(0x18f)],_0x4e7c2a=_0x3caab7[_0x5f559e(0x183)](_0x4bca8b=>_0x4bca8b['filename'][_0x5f559e(0x1c8)](_0x5f559e(0x182))),_0x1c4bfe=await this[_0x5f559e(0x1b4)](_0x4e7c2a[0x0]['url']);await this['_saveLog'](_0x1c4bfe,'Validation\x20Log'),_0x266d52[_0x5f559e(0x1a3)]=_0x2734d3,_0x266d52['packageComponentList']=this[_0x5f559e(0x193)](_0x5889fe),await this[_0x5f559e(0x180)](_0x266d52);if(_0x52abdc!==status_enums_1['VeevaPackageStatus']['VERIFIED'])throw new Error(_0x5f559e(0x1b9));return _0x266d52;}else throw new veeva_error_1['VeevaError'](_0x1eaedf[_0x5f559e(0x1bb)]);}async[a360_0x3a8e32(0x1a9)](_0x2a9d9a,_0x421816){const _0x4a83c6=a360_0x3a8e32;var _0x7b30f8;this[_0x4a83c6(0x194)][_0x4a83c6(0x1a7)](_0x4a83c6(0x192));const {data:_0x3d7944}=await this['_connection']['get'](_0x2a9d9a);if(_0x3d7944[_0x4a83c6(0x1c3)]===status_enums_1['VeevaResponseStatus'][_0x4a83c6(0x190)]){const {responseDetails:{deployment_log:_0x24d803,package_status__v:_0x438dd3},package_steps:_0x5b4b44}=_0x3d7944,_0x1b8da6=_0x24d803[_0x4a83c6(0x183)](_0x58637b=>_0x58637b[_0x4a83c6(0x17b)][_0x4a83c6(0x1c8)](_0x4a83c6(0x17a))),_0x116230=await this[_0x4a83c6(0x1b4)](_0x1b8da6[0x0][_0x4a83c6(0x1bd)]);await this['_saveLog'](_0x116230,_0x4a83c6(0x179)),_0x421816['isDeployed']=[status_enums_1['VeevaPackageStatus'][_0x4a83c6(0x184)],status_enums_1['VeevaPackageStatus'][_0x4a83c6(0x1c4)]][_0x4a83c6(0x1ba)](_0x438dd3);const _0x3feaf6=array_utils_1[_0x4a83c6(0x18a)][_0x4a83c6(0x18d)](this[_0x4a83c6(0x193)](_0x5b4b44),({uniqueName:_0x3b4caf})=>_0x3b4caf);for(const _0x360323 of _0x421816[_0x4a83c6(0x19c)]){const _0x7c23be=(_0x7b30f8=_0x3feaf6[_0x4a83c6(0x1c0)](_0x360323[_0x4a83c6(0x1c5)]))===null||_0x7b30f8===void 0x0?void 0x0:_0x7b30f8['status'];_0x7c23be&&(_0x360323[_0x4a83c6(0x1bf)]=_0x7c23be);}_0x421816['packageComponentList']=_0x421816[_0x4a83c6(0x19c)][_0x4a83c6(0x183)](_0x147613=>_0x147613[_0x4a83c6(0x1bf)]!==status_enums_1[_0x4a83c6(0x1a2)][_0x4a83c6(0x19d)]);if(!_0x421816[_0x4a83c6(0x19c)][_0x4a83c6(0x1aa)])throw new Error('Cannot\x20find\x20deployment\x20results');return _0x421816;}else throw new veeva_error_1[(_0x4a83c6(0x1c1))](_0x3d7944[_0x4a83c6(0x1bb)]);}async[a360_0x3a8e32(0x1b4)](_0x300f62){const _0x5127fe=a360_0x3a8e32,{data:_0x119ae6}=await this['_connection'][_0x5127fe(0x1c0)](_0x300f62,{'responseType':'text'});return _0x119ae6;}[a360_0x3a8e32(0x193)](_0x2c0c55){return _0x2c0c55['reduce']((_0x288bdd,_0xaf5a4a)=>{const _0x695660=a360_0x2753,_0x1843bb=_0xaf5a4a[_0x695660(0x174)][_0x695660(0x1b1)](_0xfe4b3b=>new package_component_dto_1['PackageComponentDto']({'status':_0xaf5a4a['deployment_status__v'],'stepName':_0xaf5a4a[_0x695660(0x16e)],'component':_0xfe4b3b}));return[..._0x288bdd,..._0x1843bb];},[]);}async['fillPackageDeploymentAction'](_0x2963e8){const _0x3360d0=a360_0x3a8e32,{data:_0x1ee455}=await this[_0x3360d0(0x1c7)][_0x3360d0(0x18c)](veeva_constants_1[_0x3360d0(0x1a1)][_0x3360d0(0x173)][_0x3360d0(0x1c6)](_0x3360d0(0x1ab),_0x2963e8[_0x3360d0(0x1a3)]));if(_0x1ee455[_0x3360d0(0x1c3)]===status_enums_1[_0x3360d0(0x1a8)][_0x3360d0(0x190)]){const {package_steps:_0xfc1c70}=_0x1ee455[_0x3360d0(0x175)],_0x48cd77=array_utils_1[_0x3360d0(0x18a)]['groupToMap'](_0x2963e8['packageComponentList'],({stepName:_0x102bdc})=>_0x102bdc);for(const {name__v:_0x442d8a,deployment_action:_0x1349b2}of _0xfc1c70){for(const _0x3b98b1 of _0x48cd77[_0x3360d0(0x1c0)](_0x442d8a)||[]){_0x3b98b1[_0x3360d0(0x1c2)]=package_component_dto_1[_0x3360d0(0x19e)][_0x3360d0(0x16f)](_0x1349b2);}}}else throw new veeva_error_1[(_0x3360d0(0x1c1))](_0x1ee455[_0x3360d0(0x1bb)]);}async[a360_0x3a8e32(0x181)](_0x4c0690){const _0xc41b57=a360_0x3a8e32,_0x43910a=await this['importVpk'](_0x4c0690),_0x3280fa=await this[_0xc41b57(0x196)](_0x43910a),_0x42157f=await this[_0xc41b57(0x1a4)](_0x3280fa),_0x49a127=await this[_0xc41b57(0x1a0)](_0x42157f[_0xc41b57(0x1a3)]),_0x59e561=await this[_0xc41b57(0x196)](_0x49a127);return this['getDeployDetailsAndSaveLog'](_0x59e561,_0x42157f);}}exports[a360_0x3a8e32(0x1ae)]=PackageImportService;function a360_0x4453(){const _0x43f0f2=['getJobDetailUrl','Wait\x20Executing\x20job','search','(((.+)+)+)+$','../dtos/package-component.dto','append','packageComponentList','VERIFIED','PackageComponentDto','_saveLog','deployPackage','VeevaConstants','PackageComponentStatus','packageId','getValidationDetailsAndSaveLog','5mnzRAE','getJobResult','log','VeevaResponseStatus','getDeployDetailsAndSaveLog','length','{package_id}','24YAzFYG','createReadStream','PackageImportService','apply','Import\x20package','map','put','Deploy\x20package','getLogResultText','defineProperty','links','multipart/form-data','../utils/array.utils','Package\x20not\x20verified','includes','errors','463044QKqJZo','url','data','status','get','VeevaError','deploymentAction','responseStatus','DEPLOYED_WITH_WARNINGS','uniqueName','replace','_connection','endsWith','3544765nMVymE','ENDPOINT_EXPORT_IMPORT_PACKAGE','PackageDetailsDto','name__v','convertDeploymentAction','toString','1033443AZjASW','rel','ENDPOINT_VALIDATE_PACKAGE','package_components','responseDetails','importVpk','_veevaService','artifacts','Deploy\x20Log','Deployment.log','filename','__esModule','6139448lbcIyz','6546249OeDUms','ENDPOINT_DEPLOY_PACKAGE','fillPackageDeploymentAction','import','Validation.log','filter','DEPLOYED','50FfiGzL','file','../classes/errors/veeva-error','find','1530600yslqpo','ArrayUtils','updateVeevaConnection','post','groupUniqueToMap','../dtos/package-details.dto','vaultPackage','SUCCESS','105090ztzGmt','Get\x20deploy\x20result','formPackageComponentList','_logger','../constants/veeva.constants'];a360_0x4453=function(){return _0x43f0f2;};return a360_0x4453();}