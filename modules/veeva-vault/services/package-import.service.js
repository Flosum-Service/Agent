const a336_0x154186=a336_0xd4f5;function a336_0xd4f5(_0x37a2dc,_0x310918){const _0x1e842a=a336_0x3986();return a336_0xd4f5=function(_0x38e1be,_0x96447e){_0x38e1be=_0x38e1be-0x102;let _0x3986e4=_0x1e842a[_0x38e1be];return _0x3986e4;},a336_0xd4f5(_0x37a2dc,_0x310918);}(function(_0x13425d,_0x37248f){const _0x720051=a336_0xd4f5,_0x398d63=_0x13425d();while(!![]){try{const _0x53c032=parseInt(_0x720051(0x156))/0x1+parseInt(_0x720051(0x10e))/0x2*(-parseInt(_0x720051(0x15a))/0x3)+parseInt(_0x720051(0x11a))/0x4*(-parseInt(_0x720051(0x135))/0x5)+-parseInt(_0x720051(0x109))/0x6*(-parseInt(_0x720051(0x105))/0x7)+-parseInt(_0x720051(0x14c))/0x8*(parseInt(_0x720051(0x10b))/0x9)+-parseInt(_0x720051(0x143))/0xa+-parseInt(_0x720051(0x15e))/0xb*(-parseInt(_0x720051(0x141))/0xc);if(_0x53c032===_0x37248f)break;else _0x398d63['push'](_0x398d63['shift']());}catch(_0xef2dcc){_0x398d63['push'](_0x398d63['shift']());}}}(a336_0x3986,0x7f8f5));const a336_0x96447e=(function(){let _0x8ec500=!![];return function(_0x11d823,_0x1cad74){const _0x16b7ac=_0x8ec500?function(){const _0x34cf1f=a336_0xd4f5;if(_0x1cad74){const _0x31e245=_0x1cad74[_0x34cf1f(0x12c)](_0x11d823,arguments);return _0x1cad74=null,_0x31e245;}}:function(){};return _0x8ec500=![],_0x16b7ac;};}()),a336_0x38e1be=a336_0x96447e(this,function(){const _0x4aaad7=a336_0xd4f5;return a336_0x38e1be[_0x4aaad7(0x10f)]()[_0x4aaad7(0x160)](_0x4aaad7(0x103))[_0x4aaad7(0x10f)]()[_0x4aaad7(0x106)](a336_0x38e1be)['search']('(((.+)+)+)+$');});a336_0x38e1be();'use strict';var __importDefault=this&&this[a336_0x154186(0x12d)]||function(_0x13d4c2){const _0x5cbc43=a336_0x154186;return _0x13d4c2&&_0x13d4c2[_0x5cbc43(0x129)]?_0x13d4c2:{'default':_0x13d4c2};};function a336_0x3986(){const _0x1397bf=['56203bGsEsV','constructor','../utils/veeva-auth.utils','text','372XABRtW','getDeployDetailsAndSaveLog','18aDJLKp','VERIFIED','errors','584900SdUynB','toString','Get\x20deploy\x20result','VeevaConstants','{package_id}','../dtos/package-details.dto','VeevaResponseStatus','includes','find','deploymentAction','formPackageComponentList','deployPackage','1304YYotTr','href','default','groupToMap','defineProperty','Deploy\x20package','_connection','replace','form-data','filename','import','ENDPOINT_EXPORT_IMPORT_PACKAGE','../utils/array.utils','status','VeevaError','__esModule','ArrayUtils','createReadStream','apply','__importDefault','Validation.log','package_components','convertDeploymentAction','post','file','url','packageId','2935mpWjFT','fillPackageDeploymentAction','ENDPOINT_DEPLOY_PACKAGE','groupUniqueToMap','get','isDeployed','Cannot\x20find\x20deployment\x20results','log','responseStatus','packageComponentList','SUCCESS','links','2025432ddRMut','name__v','1349890pnqVTY','importVpk','getJobDetailUrl','data','Wait\x20Executing\x20job','DEPLOYED','_veevaService','_saveLog','filter','3748072rNarHs','Deployment.log','PackageComponentStatus','getLogResultText','_logger','../constants/veeva.constants','endsWith','VeevaPackageStatus','PackageImportService','../enums/status.enums','567790matHWl','reduce','updateVeevaConnection','vaultPackage','3QpWnkC','artifacts','getValidationDetailsAndSaveLog','../classes/errors/veeva-error','66ovZKth','Get\x20validation\x20details.','search','PackageDetailsDto','(((.+)+)+)+$','rel'];a336_0x3986=function(){return _0x1397bf;};return a336_0x3986();}Object[a336_0x154186(0x11e)](exports,'__esModule',{'value':!![]}),exports[a336_0x154186(0x154)]=void 0x0;const veeva_constants_1=require(a336_0x154186(0x151)),status_enums_1=require(a336_0x154186(0x155)),veeva_error_1=require(a336_0x154186(0x15d)),form_data_1=__importDefault(require(a336_0x154186(0x122))),fs_1=require('fs'),veeva_auth_utils_1=require(a336_0x154186(0x107)),package_details_dto_1=require(a336_0x154186(0x113)),package_component_dto_1=require('../dtos/package-component.dto'),array_utils_1=require(a336_0x154186(0x126));class PackageImportService{constructor({veevaService:_0x405efb,connection:_0x54ee41,logger:_0x315fd9,saveLog:_0x21bd6c}){const _0x4c686c=a336_0x154186;this[_0x4c686c(0x149)]=_0x405efb,this[_0x4c686c(0x120)]=_0x54ee41,this[_0x4c686c(0x150)]=_0x315fd9,this['_saveLog']=_0x21bd6c;}async['importVpk'](_0x824c17,_0x2366b8=0x1){const _0x472284=a336_0x154186;this['_logger']['log']('Import\x20package');const _0x35bac1=new form_data_1[(_0x472284(0x11c))]();_0x35bac1['append'](_0x472284(0x132),(0x0,fs_1[_0x472284(0x12b)])(_0x824c17));const _0xa40877=await this[_0x472284(0x120)]['put'](veeva_constants_1[_0x472284(0x111)][_0x472284(0x125)],_0x35bac1,{'headers':{'Content-Type':'multipart/form-data'}}),_0x6c2adb=_0xa40877[_0x472284(0x146)];if(_0x6c2adb[_0x472284(0x13d)]===status_enums_1[_0x472284(0x114)]['SUCCESS'])return _0x6c2adb[_0x472284(0x133)];else{if(_0x2366b8>0x0)return await(0x0,veeva_auth_utils_1[_0x472284(0x158)])(this[_0x472284(0x120)]),await this[_0x472284(0x144)](_0x824c17,_0x2366b8-0x1);throw new veeva_error_1[(_0x472284(0x128))](_0x6c2adb[_0x472284(0x10d)]);}}async[a336_0x154186(0x119)](_0xeaf8d4){const _0x5b3258=a336_0x154186;this['_logger'][_0x5b3258(0x13c)](_0x5b3258(0x11f));const _0x9623a3=await this[_0x5b3258(0x120)]['post'](veeva_constants_1[_0x5b3258(0x111)][_0x5b3258(0x137)][_0x5b3258(0x121)]('{package_id}',_0xeaf8d4)),_0x355062=await _0x9623a3['data'];if(_0x355062[_0x5b3258(0x13d)]===status_enums_1[_0x5b3258(0x114)][_0x5b3258(0x13f)])return _0x355062[_0x5b3258(0x133)];else throw new veeva_error_1[(_0x5b3258(0x128))](_0x355062[_0x5b3258(0x10d)]);}async[a336_0x154186(0x145)](_0xc347d3){const _0x14cb71=a336_0x154186;this[_0x14cb71(0x150)]['log'](_0x14cb71(0x147));const [_0x590e20]=await this['_veevaService']['getJobResult']([_0xc347d3]);return _0x590e20[_0x14cb71(0x140)][_0x14cb71(0x116)](_0x1ceb4e=>_0x1ceb4e[_0x14cb71(0x104)]===_0x14cb71(0x15b))[_0x14cb71(0x11b)];}async[a336_0x154186(0x15c)](_0x34ba72){const _0x2e8f6a=a336_0x154186;this['_logger']['log'](_0x2e8f6a(0x15f));const {data:_0x108a4f}=await this[_0x2e8f6a(0x120)][_0x2e8f6a(0x139)](_0x34ba72);if(_0x108a4f[_0x2e8f6a(0x13d)]===status_enums_1[_0x2e8f6a(0x114)][_0x2e8f6a(0x13f)]){const _0x43b50d=new package_details_dto_1[(_0x2e8f6a(0x102))](),{log:_0xf856f8,id:_0xe7dc4e,package_status:_0x3fe4cf,package_steps:_0x169c3d}=_0x108a4f[_0x2e8f6a(0x159)],_0x32d03a=_0xf856f8[_0x2e8f6a(0x14b)](_0xee62dc=>_0xee62dc[_0x2e8f6a(0x123)][_0x2e8f6a(0x152)](_0x2e8f6a(0x12e))),_0x379bc0=await this[_0x2e8f6a(0x14f)](_0x32d03a[0x0][_0x2e8f6a(0x133)]);await this['_saveLog'](_0x379bc0,'Validation\x20Log'),_0x43b50d['packageId']=_0xe7dc4e,_0x43b50d['packageComponentList']=this[_0x2e8f6a(0x118)](_0x169c3d),await this[_0x2e8f6a(0x136)](_0x43b50d);if(_0x3fe4cf!==status_enums_1[_0x2e8f6a(0x153)][_0x2e8f6a(0x10c)])throw new Error('Package\x20not\x20verified');return _0x43b50d;}else throw new veeva_error_1[(_0x2e8f6a(0x128))](_0x108a4f[_0x2e8f6a(0x10d)]);}async[a336_0x154186(0x10a)](_0x97ad6e,_0x42545e){const _0x4a42d9=a336_0x154186;var _0x7bf885;this[_0x4a42d9(0x150)][_0x4a42d9(0x13c)](_0x4a42d9(0x110));const {data:_0x168aaa}=await this[_0x4a42d9(0x120)][_0x4a42d9(0x139)](_0x97ad6e);if(_0x168aaa[_0x4a42d9(0x13d)]===status_enums_1[_0x4a42d9(0x114)][_0x4a42d9(0x13f)]){const {responseDetails:{deployment_log:_0x5dbe6c,package_status__v:_0x77fab4},package_steps:_0x5dceb6}=_0x168aaa,_0x12aa18=_0x5dbe6c[_0x4a42d9(0x14b)](_0x41f63c=>_0x41f63c['filename']['endsWith'](_0x4a42d9(0x14d))),_0x20782f=await this['getLogResultText'](_0x12aa18[0x0]['url']);await this[_0x4a42d9(0x14a)](_0x20782f,'Deploy\x20Log'),_0x42545e[_0x4a42d9(0x13a)]=[status_enums_1[_0x4a42d9(0x153)][_0x4a42d9(0x148)],status_enums_1[_0x4a42d9(0x153)]['DEPLOYED_WITH_WARNINGS']][_0x4a42d9(0x115)](_0x77fab4);const _0x336b74=array_utils_1[_0x4a42d9(0x12a)][_0x4a42d9(0x138)](this[_0x4a42d9(0x118)](_0x5dceb6),({uniqueName:_0x8aa16b})=>_0x8aa16b);for(const _0x444ef5 of _0x42545e[_0x4a42d9(0x13e)]){const _0x2e453d=(_0x7bf885=_0x336b74[_0x4a42d9(0x139)](_0x444ef5['uniqueName']))===null||_0x7bf885===void 0x0?void 0x0:_0x7bf885['status'];_0x2e453d&&(_0x444ef5[_0x4a42d9(0x127)]=_0x2e453d);}_0x42545e['packageComponentList']=_0x42545e[_0x4a42d9(0x13e)][_0x4a42d9(0x14b)](_0x5d4b94=>_0x5d4b94['status']!==status_enums_1[_0x4a42d9(0x14e)]['VERIFIED']);if(!_0x42545e[_0x4a42d9(0x13e)]['length'])throw new Error(_0x4a42d9(0x13b));return _0x42545e;}else throw new veeva_error_1[(_0x4a42d9(0x128))](_0x168aaa[_0x4a42d9(0x10d)]);}async[a336_0x154186(0x14f)](_0x2d24b3){const _0x468537=a336_0x154186,{data:_0x3a5d33}=await this[_0x468537(0x120)][_0x468537(0x139)](_0x2d24b3,{'responseType':_0x468537(0x108)});return _0x3a5d33;}[a336_0x154186(0x118)](_0x261c59){const _0x5099e4=a336_0x154186;return _0x261c59[_0x5099e4(0x157)]((_0x5121b2,_0x66ea17)=>{const _0x58b320=_0x5099e4,_0x58bc99=_0x66ea17[_0x58b320(0x12f)]['map'](_0xa53455=>new package_component_dto_1['PackageComponentDto']({'status':_0x66ea17['deployment_status__v'],'stepName':_0x66ea17[_0x58b320(0x142)],'component':_0xa53455}));return[..._0x5121b2,..._0x58bc99];},[]);}async[a336_0x154186(0x136)](_0x28a8a2){const _0x50da2d=a336_0x154186,{data:_0x14a08b}=await this['_connection'][_0x50da2d(0x131)](veeva_constants_1[_0x50da2d(0x111)]['ENDPOINT_VALIDATE_PACKAGE'][_0x50da2d(0x121)](_0x50da2d(0x112),_0x28a8a2[_0x50da2d(0x134)]));if(_0x14a08b['responseStatus']===status_enums_1[_0x50da2d(0x114)][_0x50da2d(0x13f)]){const {package_steps:_0x11d540}=_0x14a08b['responseDetails'],_0x3ce2d7=array_utils_1['ArrayUtils'][_0x50da2d(0x11d)](_0x28a8a2['packageComponentList'],({stepName:_0x4cb0a2})=>_0x4cb0a2);for(const {name__v:_0x511282,deployment_action:_0xa5e6de}of _0x11d540){for(const _0x4858c6 of _0x3ce2d7[_0x50da2d(0x139)](_0x511282)||[]){_0x4858c6[_0x50da2d(0x117)]=package_component_dto_1['PackageComponentDto'][_0x50da2d(0x130)](_0xa5e6de);}}}else throw new veeva_error_1[(_0x50da2d(0x128))](_0x14a08b[_0x50da2d(0x10d)]);}async[a336_0x154186(0x124)](_0x2c6671){const _0x179f45=a336_0x154186,_0x5ad08a=await this['importVpk'](_0x2c6671),_0x9c0669=await this[_0x179f45(0x145)](_0x5ad08a),_0x53a8bf=await this[_0x179f45(0x15c)](_0x9c0669),_0x2c076c=await this[_0x179f45(0x119)](_0x53a8bf[_0x179f45(0x134)]),_0x740840=await this[_0x179f45(0x145)](_0x2c076c);return this[_0x179f45(0x10a)](_0x740840,_0x53a8bf);}}exports[a336_0x154186(0x154)]=PackageImportService;