const a336_0x2cc086=a336_0xa61e;(function(_0x586ef8,_0x3f7a8c){const _0x32cd89=a336_0xa61e,_0x573751=_0x586ef8();while(!![]){try{const _0x5cba4f=-parseInt(_0x32cd89(0x183))/0x1*(-parseInt(_0x32cd89(0x15a))/0x2)+-parseInt(_0x32cd89(0x16f))/0x3+parseInt(_0x32cd89(0x179))/0x4*(parseInt(_0x32cd89(0x18e))/0x5)+parseInt(_0x32cd89(0x1a0))/0x6+parseInt(_0x32cd89(0x18d))/0x7*(-parseInt(_0x32cd89(0x196))/0x8)+parseInt(_0x32cd89(0x1a9))/0x9*(-parseInt(_0x32cd89(0x18b))/0xa)+parseInt(_0x32cd89(0x174))/0xb;if(_0x5cba4f===_0x3f7a8c)break;else _0x573751['push'](_0x573751['shift']());}catch(_0x2887ce){_0x573751['push'](_0x573751['shift']());}}}(a336_0x453f,0x87736));const a336_0x1f4c0e=(function(){let _0x122a2c=!![];return function(_0x15f6ee,_0x5e7910){const _0x5803ef=_0x122a2c?function(){const _0x5c759a=a336_0xa61e;if(_0x5e7910){const _0xb9c477=_0x5e7910[_0x5c759a(0x155)](_0x15f6ee,arguments);return _0x5e7910=null,_0xb9c477;}}:function(){};return _0x122a2c=![],_0x5803ef;};}()),a336_0x56d585=a336_0x1f4c0e(this,function(){const _0x2160ad=a336_0xa61e;return a336_0x56d585[_0x2160ad(0x195)]()['search'](_0x2160ad(0x19b))[_0x2160ad(0x195)]()[_0x2160ad(0x162)](a336_0x56d585)[_0x2160ad(0x159)](_0x2160ad(0x19b));});a336_0x56d585();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x19120a){const _0x58d770=a336_0xa61e;return _0x19120a&&_0x19120a[_0x58d770(0x161)]?_0x19120a:{'default':_0x19120a};};Object[a336_0x2cc086(0x17d)](exports,a336_0x2cc086(0x161),{'value':!![]}),exports[a336_0x2cc086(0x152)]=void 0x0;const veeva_constants_1=require('../constants/veeva.constants'),status_enums_1=require(a336_0x2cc086(0x186)),veeva_error_1=require(a336_0x2cc086(0x15b)),form_data_1=__importDefault(require(a336_0x2cc086(0x18c))),fs_1=require('fs'),veeva_auth_utils_1=require(a336_0x2cc086(0x19e)),package_details_dto_1=require(a336_0x2cc086(0x194)),package_component_dto_1=require('../dtos/package-component.dto'),array_utils_1=require(a336_0x2cc086(0x193));class PackageImportService{constructor({veevaService:_0x540420,connection:_0x16bf9b,logger:_0x58f9b5,saveLog:_0xc376d3}){const _0x552ba8=a336_0x2cc086;this['_veevaService']=_0x540420,this[_0x552ba8(0x153)]=_0x16bf9b,this[_0x552ba8(0x164)]=_0x58f9b5,this[_0x552ba8(0x19f)]=_0xc376d3;}async['importVpk'](_0x45dad5,_0x37e812=0x1){const _0x127277=a336_0x2cc086;this['_logger'][_0x127277(0x1aa)]('Import\x20package');const _0x403437=new form_data_1[(_0x127277(0x1a5))]();_0x403437[_0x127277(0x173)]('file',(0x0,fs_1[_0x127277(0x158)])(_0x45dad5));const _0x4b4128=await this[_0x127277(0x153)][_0x127277(0x165)](veeva_constants_1[_0x127277(0x1a8)]['ENDPOINT_EXPORT_IMPORT_PACKAGE'],_0x403437,{'headers':{'Content-Type':_0x127277(0x175)}}),_0x1d4107=_0x4b4128[_0x127277(0x169)];if(_0x1d4107[_0x127277(0x1a6)]===status_enums_1[_0x127277(0x17f)][_0x127277(0x17b)])return _0x1d4107[_0x127277(0x19d)];else{if(_0x37e812>0x0)return await(0x0,veeva_auth_utils_1[_0x127277(0x191)])(this[_0x127277(0x153)]),await this[_0x127277(0x1a2)](_0x45dad5,_0x37e812-0x1);throw new veeva_error_1[(_0x127277(0x16b))](_0x1d4107[_0x127277(0x189)]);}}async[a336_0x2cc086(0x178)](_0x36c372){const _0x52d450=a336_0x2cc086;this['_logger'][_0x52d450(0x1aa)](_0x52d450(0x1a1));const _0x3b93d5=await this['_connection'][_0x52d450(0x15c)](veeva_constants_1['VeevaConstants']['ENDPOINT_DEPLOY_PACKAGE']['replace'](_0x52d450(0x167),_0x36c372)),_0x1a32ee=await _0x3b93d5[_0x52d450(0x169)];if(_0x1a32ee[_0x52d450(0x1a6)]===status_enums_1[_0x52d450(0x17f)][_0x52d450(0x17b)])return _0x1a32ee['url'];else throw new veeva_error_1[(_0x52d450(0x16b))](_0x1a32ee[_0x52d450(0x189)]);}async['getJobDetailUrl'](_0x48cb3a){const _0x50313f=a336_0x2cc086;this[_0x50313f(0x164)][_0x50313f(0x1aa)](_0x50313f(0x180));const [_0x11ccbf]=await this['_veevaService'][_0x50313f(0x151)]([_0x48cb3a]);return _0x11ccbf[_0x50313f(0x15d)][_0x50313f(0x154)](_0x25422d=>_0x25422d['rel']===_0x50313f(0x19a))['href'];}async[a336_0x2cc086(0x1ac)](_0x3e4d6c){const _0x15a375=a336_0x2cc086;this[_0x15a375(0x164)]['log'](_0x15a375(0x197));const {data:_0x5664dd}=await this[_0x15a375(0x153)][_0x15a375(0x199)](_0x3e4d6c);if(_0x5664dd[_0x15a375(0x1a6)]===status_enums_1[_0x15a375(0x17f)][_0x15a375(0x17b)]){const _0x2cebd6=new package_details_dto_1[(_0x15a375(0x156))](),{log:_0x235b24,id:_0x3148b7,package_status:_0x315d52,package_steps:_0x1525ad}=_0x5664dd[_0x15a375(0x16a)],_0x3d7e8a=_0x235b24[_0x15a375(0x188)](_0x210df5=>_0x210df5[_0x15a375(0x18a)][_0x15a375(0x163)](_0x15a375(0x16e))),_0x32237f=await this['getLogResultText'](_0x3d7e8a[0x0][_0x15a375(0x19d)]);await this[_0x15a375(0x19f)](_0x32237f,_0x15a375(0x181)),_0x2cebd6[_0x15a375(0x18f)]=_0x3148b7,_0x2cebd6[_0x15a375(0x184)]=this['formPackageComponentList'](_0x1525ad),await this['fillPackageDeploymentAction'](_0x2cebd6);if(_0x315d52!==status_enums_1[_0x15a375(0x1a4)][_0x15a375(0x160)])throw new Error('Package\x20not\x20verified');return _0x2cebd6;}else throw new veeva_error_1[(_0x15a375(0x16b))](_0x5664dd[_0x15a375(0x189)]);}async[a336_0x2cc086(0x1ab)](_0x153721,_0x22a424){const _0x1573a5=a336_0x2cc086;var _0x499584;this[_0x1573a5(0x164)][_0x1573a5(0x1aa)](_0x1573a5(0x192));const {data:_0x3661e3}=await this[_0x1573a5(0x153)]['get'](_0x153721);if(_0x3661e3['responseStatus']===status_enums_1['VeevaResponseStatus'][_0x1573a5(0x17b)]){const {responseDetails:{deployment_log:_0x32d782,package_status__v:_0x563c31},package_steps:_0x1aa984}=_0x3661e3,_0x3d12b4=_0x32d782[_0x1573a5(0x188)](_0x1429e7=>_0x1429e7[_0x1573a5(0x18a)]['endsWith']('Deployment.log')),_0x7d9c24=await this[_0x1573a5(0x15f)](_0x3d12b4[0x0][_0x1573a5(0x19d)]);await this['_saveLog'](_0x7d9c24,_0x1573a5(0x185)),_0x22a424[_0x1573a5(0x190)]=[status_enums_1[_0x1573a5(0x1a4)][_0x1573a5(0x17e)],status_enums_1[_0x1573a5(0x1a4)][_0x1573a5(0x1a3)]][_0x1573a5(0x16c)](_0x563c31);const _0x5d92fb=array_utils_1[_0x1573a5(0x187)][_0x1573a5(0x19c)](this[_0x1573a5(0x168)](_0x1aa984),({uniqueName:_0x3aa003})=>_0x3aa003);for(const _0xda74f1 of _0x22a424[_0x1573a5(0x184)]){const _0x3243f8=(_0x499584=_0x5d92fb[_0x1573a5(0x199)](_0xda74f1[_0x1573a5(0x166)]))===null||_0x499584===void 0x0?void 0x0:_0x499584[_0x1573a5(0x176)];_0x3243f8&&(_0xda74f1['status']=_0x3243f8);}_0x22a424['packageComponentList']=_0x22a424[_0x1573a5(0x184)][_0x1573a5(0x188)](_0x2b8f24=>_0x2b8f24['status']!==status_enums_1[_0x1573a5(0x172)][_0x1573a5(0x160)]);if(!_0x22a424['packageComponentList'][_0x1573a5(0x17a)])throw new Error(_0x1573a5(0x157));return _0x22a424;}else throw new veeva_error_1['VeevaError'](_0x3661e3['errors']);}async[a336_0x2cc086(0x15f)](_0xce1e94){const _0x3ca291=a336_0x2cc086,{data:_0x558bdc}=await this[_0x3ca291(0x153)][_0x3ca291(0x199)](_0xce1e94,{'responseType':_0x3ca291(0x198)});return _0x558bdc;}[a336_0x2cc086(0x168)](_0x19eeb1){return _0x19eeb1['reduce']((_0x22de07,_0x31588c)=>{const _0x402165=a336_0xa61e,_0x135e03=_0x31588c[_0x402165(0x15e)]['map'](_0x4a6780=>new package_component_dto_1[(_0x402165(0x17c))]({'status':_0x31588c['deployment_status__v'],'stepName':_0x31588c['name__v'],'component':_0x4a6780}));return[..._0x22de07,..._0x135e03];},[]);}async[a336_0x2cc086(0x150)](_0xe19ce9){const _0x3ecc02=a336_0x2cc086,{data:_0x48e9ab}=await this[_0x3ecc02(0x153)][_0x3ecc02(0x15c)](veeva_constants_1[_0x3ecc02(0x1a8)]['ENDPOINT_VALIDATE_PACKAGE'][_0x3ecc02(0x171)](_0x3ecc02(0x167),_0xe19ce9[_0x3ecc02(0x18f)]));if(_0x48e9ab[_0x3ecc02(0x1a6)]===status_enums_1[_0x3ecc02(0x17f)][_0x3ecc02(0x17b)]){const {package_steps:_0x364dd0}=_0x48e9ab[_0x3ecc02(0x16d)],_0x11df14=array_utils_1[_0x3ecc02(0x187)][_0x3ecc02(0x170)](_0xe19ce9[_0x3ecc02(0x184)],({stepName:_0x4db60a})=>_0x4db60a);for(const {name__v:_0x51d3bc,deployment_action:_0x1bff79}of _0x364dd0){for(const _0x50c195 of _0x11df14[_0x3ecc02(0x199)](_0x51d3bc)||[]){_0x50c195[_0x3ecc02(0x14f)]=package_component_dto_1[_0x3ecc02(0x17c)][_0x3ecc02(0x1a7)](_0x1bff79);}}}else throw new veeva_error_1[(_0x3ecc02(0x16b))](_0x48e9ab[_0x3ecc02(0x189)]);}async[a336_0x2cc086(0x182)](_0x18c898){const _0x5a9a57=a336_0x2cc086,_0x19c394=await this[_0x5a9a57(0x1a2)](_0x18c898),_0x4b766e=await this[_0x5a9a57(0x177)](_0x19c394),_0x29b5f0=await this[_0x5a9a57(0x1ac)](_0x4b766e),_0x4fc9ba=await this[_0x5a9a57(0x178)](_0x29b5f0[_0x5a9a57(0x18f)]),_0x2d7417=await this[_0x5a9a57(0x177)](_0x4fc9ba);return this[_0x5a9a57(0x1ab)](_0x2d7417,_0x29b5f0);}}function a336_0xa61e(_0x1ddc71,_0x386c4f){const _0x52c971=a336_0x453f();return a336_0xa61e=function(_0x56d585,_0x1f4c0e){_0x56d585=_0x56d585-0x14f;let _0x453f4e=_0x52c971[_0x56d585];return _0x453f4e;},a336_0xa61e(_0x1ddc71,_0x386c4f);}function a336_0x453f(){const _0x9e415f=['deploymentAction','fillPackageDeploymentAction','getJobResult','PackageImportService','_connection','find','apply','PackageDetailsDto','Cannot\x20find\x20deployment\x20results','createReadStream','search','1636WeEACK','../classes/errors/veeva-error','post','links','package_components','getLogResultText','VERIFIED','__esModule','constructor','endsWith','_logger','put','uniqueName','{package_id}','formPackageComponentList','data','vaultPackage','VeevaError','includes','responseDetails','Validation.log','2873310uZnQQe','groupToMap','replace','PackageComponentStatus','append','25163314CKBSED','multipart/form-data','status','getJobDetailUrl','deployPackage','361140ETwslG','length','SUCCESS','PackageComponentDto','defineProperty','DEPLOYED','VeevaResponseStatus','Wait\x20Executing\x20job','Validation\x20Log','import','653RezspH','packageComponentList','Deploy\x20Log','../enums/status.enums','ArrayUtils','filter','errors','filename','2690CPfVOD','form-data','7AvzunR','25ncSVPk','packageId','isDeployed','updateVeevaConnection','Get\x20deploy\x20result','../utils/array.utils','../dtos/package-details.dto','toString','7877656pNZESf','Get\x20validation\x20details.','text','get','artifacts','(((.+)+)+)+$','groupUniqueToMap','url','../utils/veeva-auth.utils','_saveLog','456318pWpjYl','Deploy\x20package','importVpk','DEPLOYED_WITH_WARNINGS','VeevaPackageStatus','default','responseStatus','convertDeploymentAction','VeevaConstants','28503OfpGsT','log','getDeployDetailsAndSaveLog','getValidationDetailsAndSaveLog'];a336_0x453f=function(){return _0x9e415f;};return a336_0x453f();}exports[a336_0x2cc086(0x152)]=PackageImportService;