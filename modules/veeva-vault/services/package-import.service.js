const a376_0x1513cd=a376_0x2e53;(function(_0x1423e1,_0x1ad119){const _0x702bed=a376_0x2e53,_0x114e16=_0x1423e1();while(!![]){try{const _0x1e936e=-parseInt(_0x702bed(0x1bb))/0x1+-parseInt(_0x702bed(0x1c9))/0x2+parseInt(_0x702bed(0x1b3))/0x3+parseInt(_0x702bed(0x18e))/0x4+parseInt(_0x702bed(0x19a))/0x5+parseInt(_0x702bed(0x178))/0x6+-parseInt(_0x702bed(0x1a9))/0x7;if(_0x1e936e===_0x1ad119)break;else _0x114e16['push'](_0x114e16['shift']());}catch(_0x1aa292){_0x114e16['push'](_0x114e16['shift']());}}}(a376_0x59ba,0x6d81c));const a376_0x187b59=(function(){let _0x21d6f4=!![];return function(_0x22e892,_0x330eb4){const _0x5decd8=_0x21d6f4?function(){const _0x3a2e56=a376_0x2e53;if(_0x330eb4){const _0x489934=_0x330eb4[_0x3a2e56(0x1b8)](_0x22e892,arguments);return _0x330eb4=null,_0x489934;}}:function(){};return _0x21d6f4=![],_0x5decd8;};}()),a376_0x44a64e=a376_0x187b59(this,function(){const _0x581dfa=a376_0x2e53;return a376_0x44a64e['toString']()[_0x581dfa(0x1c5)]('(((.+)+)+)+$')['toString']()[_0x581dfa(0x1bc)](a376_0x44a64e)[_0x581dfa(0x1c5)](_0x581dfa(0x1cd));});function a376_0x59ba(){const _0x104874=['../utils/array.utils','errors','_connection','_logger','2964016VQUCqH','log','Import\x20package','getLogResultText','createReadStream','filter','endsWith','VeevaError','ArrayUtils','responseStatus','groupUniqueToMap','VeevaResponseStatus','858165QSJOXx','__esModule','../enums/status.enums','url','replace','ENDPOINT_DEPLOY_PACKAGE','reduce','importVpk','rel','responseDetails','default','uniqueName','deployment_status__v','append','put','2979417oDyOqt','multipart/form-data','map','getValidationDetailsAndSaveLog','post','Wait\x20Executing\x20job','file','deployPackage','ENDPOINT_VALIDATE_PACKAGE','form-data','787728EjIfkr','status','../constants/veeva.constants','find','includes','apply','DEPLOYED_WITH_WARNINGS','packageComponentList','681199vhnBaq','constructor','vaultPackage','text','package_components','Get\x20deploy\x20result','../dtos/package-component.dto','_veevaService','VeevaPackageStatus','filename','search','../utils/veeva-auth.utils','{package_id}','get','779136gzMcfg','data','VERIFIED','Validation\x20Log','(((.+)+)+)+$','packageId','ENDPOINT_EXPORT_IMPORT_PACKAGE','name__v','4618350NUAtZl','getJobResult','_saveLog','defineProperty','SUCCESS','VeevaConstants','getDeployDetailsAndSaveLog','PackageComponentStatus','PackageComponentDto','fillPackageDeploymentAction','links','isDeployed','../dtos/package-details.dto','formPackageComponentList','getJobDetailUrl','length','groupToMap','PackageImportService'];a376_0x59ba=function(){return _0x104874;};return a376_0x59ba();}a376_0x44a64e();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x127a16){const _0x26744f=a376_0x2e53;return _0x127a16&&_0x127a16[_0x26744f(0x19b)]?_0x127a16:{'default':_0x127a16};};Object[a376_0x1513cd(0x17b)](exports,a376_0x1513cd(0x19b),{'value':!![]}),exports[a376_0x1513cd(0x189)]=void 0x0;const veeva_constants_1=require(a376_0x1513cd(0x1b5)),status_enums_1=require(a376_0x1513cd(0x19c)),veeva_error_1=require('../classes/errors/veeva-error'),form_data_1=__importDefault(require(a376_0x1513cd(0x1b2))),fs_1=require('fs'),veeva_auth_utils_1=require(a376_0x1513cd(0x1c6)),package_details_dto_1=require(a376_0x1513cd(0x184)),package_component_dto_1=require(a376_0x1513cd(0x1c1)),array_utils_1=require(a376_0x1513cd(0x18a));class PackageImportService{constructor({veevaService:_0x5718f1,connection:_0x1c86a1,logger:_0x2d4396,saveLog:_0x291883}){const _0x46a4b0=a376_0x1513cd;this[_0x46a4b0(0x1c2)]=_0x5718f1,this['_connection']=_0x1c86a1,this[_0x46a4b0(0x18d)]=_0x2d4396,this[_0x46a4b0(0x17a)]=_0x291883;}async[a376_0x1513cd(0x1a1)](_0x1c188a,_0xd20baf=0x1){const _0x395197=a376_0x1513cd;this[_0x395197(0x18d)]['log'](_0x395197(0x190));const _0x59ed9c=new form_data_1[(_0x395197(0x1a4))]();_0x59ed9c[_0x395197(0x1a7)](_0x395197(0x1af),(0x0,fs_1[_0x395197(0x192)])(_0x1c188a));const _0x3bf02e=await this[_0x395197(0x18c)][_0x395197(0x1a8)](veeva_constants_1['VeevaConstants'][_0x395197(0x176)],_0x59ed9c,{'headers':{'Content-Type':_0x395197(0x1aa)}}),_0x537a33=_0x3bf02e['data'];if(_0x537a33[_0x395197(0x197)]===status_enums_1[_0x395197(0x199)][_0x395197(0x17c)])return _0x537a33[_0x395197(0x19d)];else{if(_0xd20baf>0x0)return await(0x0,veeva_auth_utils_1['updateVeevaConnection'])(this['_connection']),await this[_0x395197(0x1a1)](_0x1c188a,_0xd20baf-0x1);throw new veeva_error_1[(_0x395197(0x195))](_0x537a33['errors']);}}async[a376_0x1513cd(0x1b0)](_0x1be8d9){const _0x5a5831=a376_0x1513cd;this[_0x5a5831(0x18d)]['log']('Deploy\x20package');const _0x22efc3=await this['_connection']['post'](veeva_constants_1[_0x5a5831(0x17d)][_0x5a5831(0x19f)][_0x5a5831(0x19e)](_0x5a5831(0x1c7),_0x1be8d9)),_0x8d75d1=await _0x22efc3[_0x5a5831(0x1ca)];if(_0x8d75d1[_0x5a5831(0x197)]===status_enums_1[_0x5a5831(0x199)][_0x5a5831(0x17c)])return _0x8d75d1['url'];else throw new veeva_error_1[(_0x5a5831(0x195))](_0x8d75d1[_0x5a5831(0x18b)]);}async['getJobDetailUrl'](_0x5be3f1){const _0x26f5e8=a376_0x1513cd;this[_0x26f5e8(0x18d)][_0x26f5e8(0x18f)](_0x26f5e8(0x1ae));const [_0x24e3f6]=await this['_veevaService'][_0x26f5e8(0x179)]([_0x5be3f1]);return _0x24e3f6[_0x26f5e8(0x182)][_0x26f5e8(0x1b6)](_0x4945ad=>_0x4945ad[_0x26f5e8(0x1a2)]==='artifacts')['href'];}async[a376_0x1513cd(0x1ac)](_0x592445){const _0x1673cd=a376_0x1513cd;this['_logger'][_0x1673cd(0x18f)]('Get\x20validation\x20details.');const {data:_0x228638}=await this[_0x1673cd(0x18c)][_0x1673cd(0x1c8)](_0x592445);if(_0x228638['responseStatus']===status_enums_1[_0x1673cd(0x199)][_0x1673cd(0x17c)]){const _0xa25575=new package_details_dto_1['PackageDetailsDto'](),{log:_0x32eb86,id:_0x552eaa,package_status:_0x362572,package_steps:_0x3b9203}=_0x228638[_0x1673cd(0x1bd)],_0x36616e=_0x32eb86[_0x1673cd(0x193)](_0x5274f6=>_0x5274f6[_0x1673cd(0x1c4)]['endsWith']('Validation.log')),_0x131229=await this[_0x1673cd(0x191)](_0x36616e[0x0][_0x1673cd(0x19d)]);await this['_saveLog'](_0x131229,_0x1673cd(0x1cc)),_0xa25575[_0x1673cd(0x1ce)]=_0x552eaa,_0xa25575[_0x1673cd(0x1ba)]=this[_0x1673cd(0x185)](_0x3b9203),await this[_0x1673cd(0x181)](_0xa25575);if(_0x362572!==status_enums_1[_0x1673cd(0x1c3)]['VERIFIED'])throw new Error('Package\x20not\x20verified');return _0xa25575;}else throw new veeva_error_1[(_0x1673cd(0x195))](_0x228638[_0x1673cd(0x18b)]);}async[a376_0x1513cd(0x17e)](_0x54b1c0,_0x191d82){const _0xd81f2e=a376_0x1513cd;var _0x2bc218;this[_0xd81f2e(0x18d)]['log'](_0xd81f2e(0x1c0));const {data:_0x4439ea}=await this['_connection'][_0xd81f2e(0x1c8)](_0x54b1c0);if(_0x4439ea['responseStatus']===status_enums_1[_0xd81f2e(0x199)][_0xd81f2e(0x17c)]){const {responseDetails:{deployment_log:_0x5e1179,package_status__v:_0x5b9931},package_steps:_0x3fa93f}=_0x4439ea,_0x243f55=_0x5e1179['filter'](_0x4a2a51=>_0x4a2a51[_0xd81f2e(0x1c4)][_0xd81f2e(0x194)]('Deployment.log')),_0x692290=await this[_0xd81f2e(0x191)](_0x243f55[0x0]['url']);await this[_0xd81f2e(0x17a)](_0x692290,'Deploy\x20Log'),_0x191d82[_0xd81f2e(0x183)]=[status_enums_1[_0xd81f2e(0x1c3)]['DEPLOYED'],status_enums_1['VeevaPackageStatus'][_0xd81f2e(0x1b9)]][_0xd81f2e(0x1b7)](_0x5b9931);const _0x4301e2=array_utils_1[_0xd81f2e(0x196)][_0xd81f2e(0x198)](this[_0xd81f2e(0x185)](_0x3fa93f),({uniqueName:_0x492075})=>_0x492075);for(const _0x231193 of _0x191d82['packageComponentList']){const _0x35e6e1=(_0x2bc218=_0x4301e2['get'](_0x231193[_0xd81f2e(0x1a5)]))===null||_0x2bc218===void 0x0?void 0x0:_0x2bc218[_0xd81f2e(0x1b4)];_0x35e6e1&&(_0x231193['status']=_0x35e6e1);}_0x191d82[_0xd81f2e(0x1ba)]=_0x191d82[_0xd81f2e(0x1ba)][_0xd81f2e(0x193)](_0x210da2=>_0x210da2[_0xd81f2e(0x1b4)]!==status_enums_1[_0xd81f2e(0x17f)][_0xd81f2e(0x1cb)]);if(!_0x191d82[_0xd81f2e(0x1ba)][_0xd81f2e(0x187)])throw new Error('Cannot\x20find\x20deployment\x20results');return _0x191d82;}else throw new veeva_error_1[(_0xd81f2e(0x195))](_0x4439ea[_0xd81f2e(0x18b)]);}async[a376_0x1513cd(0x191)](_0x30df69){const _0x2bf6dc=a376_0x1513cd,{data:_0x2eb3af}=await this[_0x2bf6dc(0x18c)]['get'](_0x30df69,{'responseType':_0x2bf6dc(0x1be)});return _0x2eb3af;}['formPackageComponentList'](_0x5a52ba){const _0x11054b=a376_0x1513cd;return _0x5a52ba[_0x11054b(0x1a0)]((_0x637ad8,_0x1c8ecb)=>{const _0x276bd8=_0x11054b,_0x5574e0=_0x1c8ecb[_0x276bd8(0x1bf)][_0x276bd8(0x1ab)](_0x5460b5=>new package_component_dto_1[(_0x276bd8(0x180))]({'status':_0x1c8ecb[_0x276bd8(0x1a6)],'stepName':_0x1c8ecb[_0x276bd8(0x177)],'component':_0x5460b5}));return[..._0x637ad8,..._0x5574e0];},[]);}async[a376_0x1513cd(0x181)](_0x44151e){const _0x216bae=a376_0x1513cd,{data:_0x132f63}=await this[_0x216bae(0x18c)][_0x216bae(0x1ad)](veeva_constants_1[_0x216bae(0x17d)][_0x216bae(0x1b1)]['replace'](_0x216bae(0x1c7),_0x44151e[_0x216bae(0x1ce)]));if(_0x132f63[_0x216bae(0x197)]===status_enums_1[_0x216bae(0x199)][_0x216bae(0x17c)]){const {package_steps:_0x1065e6}=_0x132f63[_0x216bae(0x1a3)],_0x1af91b=array_utils_1[_0x216bae(0x196)][_0x216bae(0x188)](_0x44151e[_0x216bae(0x1ba)],({stepName:_0x163395})=>_0x163395);for(const {name__v:_0xdc3c7b,deployment_action:_0x1b4b55}of _0x1065e6){for(const _0x248ebb of _0x1af91b[_0x216bae(0x1c8)](_0xdc3c7b)||[]){_0x248ebb['deploymentAction']=package_component_dto_1[_0x216bae(0x180)]['convertDeploymentAction'](_0x1b4b55);}}}else throw new veeva_error_1['VeevaError'](_0x132f63['errors']);}async['import'](_0x5e8442){const _0x390d64=a376_0x1513cd,_0x4c3d90=await this['importVpk'](_0x5e8442),_0x42da03=await this[_0x390d64(0x186)](_0x4c3d90),_0xd0e940=await this[_0x390d64(0x1ac)](_0x42da03),_0x55acd0=await this[_0x390d64(0x1b0)](_0xd0e940[_0x390d64(0x1ce)]),_0x13a5bd=await this['getJobDetailUrl'](_0x55acd0);return this[_0x390d64(0x17e)](_0x13a5bd,_0xd0e940);}}function a376_0x2e53(_0x32fa84,_0xebdd4c){const _0x4b45bb=a376_0x59ba();return a376_0x2e53=function(_0x44a64e,_0x187b59){_0x44a64e=_0x44a64e-0x176;let _0x59baf6=_0x4b45bb[_0x44a64e];return _0x59baf6;},a376_0x2e53(_0x32fa84,_0xebdd4c);}exports[a376_0x1513cd(0x189)]=PackageImportService;