const a376_0x6b7638=a376_0x1d0b;(function(_0x504815,_0x564a05){const _0x148dee=a376_0x1d0b,_0x50c5e0=_0x504815();while(!![]){try{const _0x30ab43=-parseInt(_0x148dee(0x14f))/0x1+-parseInt(_0x148dee(0x19d))/0x2*(parseInt(_0x148dee(0x17e))/0x3)+parseInt(_0x148dee(0x151))/0x4+parseInt(_0x148dee(0x198))/0x5*(-parseInt(_0x148dee(0x170))/0x6)+parseInt(_0x148dee(0x180))/0x7*(parseInt(_0x148dee(0x199))/0x8)+-parseInt(_0x148dee(0x15d))/0x9+parseInt(_0x148dee(0x161))/0xa;if(_0x30ab43===_0x564a05)break;else _0x50c5e0['push'](_0x50c5e0['shift']());}catch(_0x5e8de4){_0x50c5e0['push'](_0x50c5e0['shift']());}}}(a376_0x3863,0x91cfd));function a376_0x3863(){const _0x1d86e7=['Deploy\x20Log','290406WOQVnE','rel','3245512qrgOfn','__esModule','errors','uniqueName','Validation\x20Log','constructor','{package_id}','import','VeevaResponseStatus','multipart/form-data','DEPLOYED_WITH_WARNINGS','Deployment.log','10358820mQolgt','formPackageComponentList','append','responseDetails','16680990twHnKb','toString','Get\x20validation\x20details.','log','links','groupToMap','VeevaError','status','name__v','PackageComponentDto','packageComponentList','SUCCESS','isDeployed','getValidationDetailsAndSaveLog','map','1338894OgiBMQ','artifacts','filter','__importDefault','ENDPOINT_EXPORT_IMPORT_PACKAGE','getLogResultText','defineProperty','deployPackage','getJobResult','getJobDetailUrl','fillPackageDeploymentAction','getDeployDetailsAndSaveLog','(((.+)+)+)+$','_saveLog','3suJXsI','_connection','28OqpbAk','deployment_status__v','ENDPOINT_VALIDATE_PACKAGE','importVpk','ENDPOINT_DEPLOY_PACKAGE','DEPLOYED','../constants/veeva.constants','createReadStream','post','VERIFIED','VeevaPackageStatus','get','endsWith','search','_veevaService','apply','length','Import\x20package','url','href','packageId','PackageImportService','reduce','includes','5oYKURe','711496SGApEw','Deploy\x20package','Cannot\x20find\x20deployment\x20results','form-data','1146890mrKHBL','convertDeploymentAction','responseStatus','PackageComponentStatus','../dtos/package-component.dto','default','Wait\x20Executing\x20job','VeevaConstants','PackageDetailsDto','package_components','../utils/array.utils','deploymentAction','ArrayUtils','Validation.log','replace','Get\x20deploy\x20result','file','../classes/errors/veeva-error','_logger','find','filename'];a376_0x3863=function(){return _0x1d86e7;};return a376_0x3863();}const a376_0x4df8e2=(function(){let _0x48e76f=!![];return function(_0x3fa2f0,_0x348f90){const _0x4079b8=_0x48e76f?function(){const _0x4eada4=a376_0x1d0b;if(_0x348f90){const _0xbe81f7=_0x348f90[_0x4eada4(0x18f)](_0x3fa2f0,arguments);return _0x348f90=null,_0xbe81f7;}}:function(){};return _0x48e76f=![],_0x4079b8;};}()),a376_0x1b2164=a376_0x4df8e2(this,function(){const _0x10724b=a376_0x1d0b;return a376_0x1b2164[_0x10724b(0x162)]()[_0x10724b(0x18d)](_0x10724b(0x17c))[_0x10724b(0x162)]()[_0x10724b(0x156)](a376_0x1b2164)[_0x10724b(0x18d)](_0x10724b(0x17c));});a376_0x1b2164();'use strict';var __importDefault=this&&this[a376_0x6b7638(0x173)]||function(_0x4d5f59){const _0x4e3f83=a376_0x6b7638;return _0x4d5f59&&_0x4d5f59[_0x4e3f83(0x152)]?_0x4d5f59:{'default':_0x4d5f59};};Object[a376_0x6b7638(0x176)](exports,a376_0x6b7638(0x152),{'value':!![]}),exports[a376_0x6b7638(0x195)]=void 0x0;function a376_0x1d0b(_0x510167,_0x50333a){const _0xe29cbc=a376_0x3863();return a376_0x1d0b=function(_0x1b2164,_0x4df8e2){_0x1b2164=_0x1b2164-0x13c;let _0x386316=_0xe29cbc[_0x1b2164];return _0x386316;},a376_0x1d0b(_0x510167,_0x50333a);}const veeva_constants_1=require(a376_0x6b7638(0x186)),status_enums_1=require('../enums/status.enums'),veeva_error_1=require(a376_0x6b7638(0x14a)),form_data_1=__importDefault(require(a376_0x6b7638(0x19c))),fs_1=require('fs'),veeva_auth_utils_1=require('../utils/veeva-auth.utils'),package_details_dto_1=require('../dtos/package-details.dto'),package_component_dto_1=require(a376_0x6b7638(0x13d)),array_utils_1=require(a376_0x6b7638(0x143));class PackageImportService{constructor({veevaService:_0xf00399,connection:_0x4cbb13,logger:_0x592797,saveLog:_0x142f6b}){const _0x2ccb7a=a376_0x6b7638;this[_0x2ccb7a(0x18e)]=_0xf00399,this[_0x2ccb7a(0x17f)]=_0x4cbb13,this[_0x2ccb7a(0x14b)]=_0x592797,this[_0x2ccb7a(0x17d)]=_0x142f6b;}async[a376_0x6b7638(0x183)](_0xc80f2b,_0x42533d=0x1){const _0xbefa61=a376_0x6b7638;this[_0xbefa61(0x14b)][_0xbefa61(0x164)](_0xbefa61(0x191));const _0x4d1738=new form_data_1[(_0xbefa61(0x13e))]();_0x4d1738[_0xbefa61(0x15f)](_0xbefa61(0x149),(0x0,fs_1[_0xbefa61(0x187)])(_0xc80f2b));const _0x4387f3=await this['_connection']['put'](veeva_constants_1[_0xbefa61(0x140)][_0xbefa61(0x174)],_0x4d1738,{'headers':{'Content-Type':_0xbefa61(0x15a)}}),_0x4abbbd=_0x4387f3['data'];if(_0x4abbbd[_0xbefa61(0x19f)]===status_enums_1[_0xbefa61(0x159)]['SUCCESS'])return _0x4abbbd[_0xbefa61(0x192)];else{if(_0x42533d>0x0)return await(0x0,veeva_auth_utils_1['updateVeevaConnection'])(this[_0xbefa61(0x17f)]),await this['importVpk'](_0xc80f2b,_0x42533d-0x1);throw new veeva_error_1['VeevaError'](_0x4abbbd[_0xbefa61(0x153)]);}}async['deployPackage'](_0x4122ce){const _0x582dcd=a376_0x6b7638;this['_logger'][_0x582dcd(0x164)](_0x582dcd(0x19a));const _0x18f751=await this[_0x582dcd(0x17f)][_0x582dcd(0x188)](veeva_constants_1[_0x582dcd(0x140)][_0x582dcd(0x184)][_0x582dcd(0x147)](_0x582dcd(0x157),_0x4122ce)),_0x1f5e79=await _0x18f751['data'];if(_0x1f5e79[_0x582dcd(0x19f)]===status_enums_1[_0x582dcd(0x159)]['SUCCESS'])return _0x1f5e79[_0x582dcd(0x192)];else throw new veeva_error_1['VeevaError'](_0x1f5e79[_0x582dcd(0x153)]);}async[a376_0x6b7638(0x179)](_0x257e72){const _0x591d10=a376_0x6b7638;this[_0x591d10(0x14b)][_0x591d10(0x164)](_0x591d10(0x13f));const [_0x50e443]=await this[_0x591d10(0x18e)][_0x591d10(0x178)]([_0x257e72]);return _0x50e443[_0x591d10(0x165)][_0x591d10(0x14c)](_0x18e459=>_0x18e459[_0x591d10(0x150)]===_0x591d10(0x171))[_0x591d10(0x193)];}async[a376_0x6b7638(0x16e)](_0x12d763){const _0x3cedfe=a376_0x6b7638;this['_logger'][_0x3cedfe(0x164)](_0x3cedfe(0x163));const {data:_0x4713af}=await this[_0x3cedfe(0x17f)]['get'](_0x12d763);if(_0x4713af[_0x3cedfe(0x19f)]===status_enums_1[_0x3cedfe(0x159)][_0x3cedfe(0x16c)]){const _0x40aa04=new package_details_dto_1[(_0x3cedfe(0x141))](),{log:_0x135b67,id:_0x1c3cb5,package_status:_0x596e0a,package_steps:_0x1467cb}=_0x4713af['vaultPackage'],_0x532767=_0x135b67['filter'](_0x3e2bd9=>_0x3e2bd9[_0x3cedfe(0x14d)][_0x3cedfe(0x18c)](_0x3cedfe(0x146))),_0x5c426d=await this[_0x3cedfe(0x175)](_0x532767[0x0][_0x3cedfe(0x192)]);await this[_0x3cedfe(0x17d)](_0x5c426d,_0x3cedfe(0x155)),_0x40aa04[_0x3cedfe(0x194)]=_0x1c3cb5,_0x40aa04[_0x3cedfe(0x16b)]=this[_0x3cedfe(0x15e)](_0x1467cb),await this['fillPackageDeploymentAction'](_0x40aa04);if(_0x596e0a!==status_enums_1[_0x3cedfe(0x18a)][_0x3cedfe(0x189)])throw new Error('Package\x20not\x20verified');return _0x40aa04;}else throw new veeva_error_1['VeevaError'](_0x4713af[_0x3cedfe(0x153)]);}async[a376_0x6b7638(0x17b)](_0x4c6f93,_0x43b25c){const _0x4e171c=a376_0x6b7638;var _0x597c6a;this['_logger']['log'](_0x4e171c(0x148));const {data:_0x14c575}=await this[_0x4e171c(0x17f)]['get'](_0x4c6f93);if(_0x14c575['responseStatus']===status_enums_1['VeevaResponseStatus']['SUCCESS']){const {responseDetails:{deployment_log:_0x1054c3,package_status__v:_0x1f4daa},package_steps:_0x7033cd}=_0x14c575,_0x39399e=_0x1054c3['filter'](_0x11142f=>_0x11142f[_0x4e171c(0x14d)][_0x4e171c(0x18c)](_0x4e171c(0x15c))),_0xf593a0=await this[_0x4e171c(0x175)](_0x39399e[0x0][_0x4e171c(0x192)]);await this['_saveLog'](_0xf593a0,_0x4e171c(0x14e)),_0x43b25c[_0x4e171c(0x16d)]=[status_enums_1['VeevaPackageStatus'][_0x4e171c(0x185)],status_enums_1['VeevaPackageStatus'][_0x4e171c(0x15b)]][_0x4e171c(0x197)](_0x1f4daa);const _0x8c94ca=array_utils_1['ArrayUtils']['groupUniqueToMap'](this['formPackageComponentList'](_0x7033cd),({uniqueName:_0x456506})=>_0x456506);for(const _0x354016 of _0x43b25c['packageComponentList']){const _0x30a71e=(_0x597c6a=_0x8c94ca[_0x4e171c(0x18b)](_0x354016[_0x4e171c(0x154)]))===null||_0x597c6a===void 0x0?void 0x0:_0x597c6a['status'];_0x30a71e&&(_0x354016[_0x4e171c(0x168)]=_0x30a71e);}_0x43b25c['packageComponentList']=_0x43b25c[_0x4e171c(0x16b)][_0x4e171c(0x172)](_0x321d3b=>_0x321d3b['status']!==status_enums_1[_0x4e171c(0x13c)][_0x4e171c(0x189)]);if(!_0x43b25c[_0x4e171c(0x16b)][_0x4e171c(0x190)])throw new Error(_0x4e171c(0x19b));return _0x43b25c;}else throw new veeva_error_1[(_0x4e171c(0x167))](_0x14c575[_0x4e171c(0x153)]);}async[a376_0x6b7638(0x175)](_0x24bc0d){const _0x395654=a376_0x6b7638,{data:_0x527ed1}=await this['_connection'][_0x395654(0x18b)](_0x24bc0d,{'responseType':'text'});return _0x527ed1;}[a376_0x6b7638(0x15e)](_0x2b6d8c){const _0x146a4e=a376_0x6b7638;return _0x2b6d8c[_0x146a4e(0x196)]((_0x4061ca,_0x42cb04)=>{const _0x317262=_0x146a4e,_0x64981d=_0x42cb04[_0x317262(0x142)][_0x317262(0x16f)](_0x2e56f1=>new package_component_dto_1[(_0x317262(0x16a))]({'status':_0x42cb04[_0x317262(0x181)],'stepName':_0x42cb04[_0x317262(0x169)],'component':_0x2e56f1}));return[..._0x4061ca,..._0x64981d];},[]);}async[a376_0x6b7638(0x17a)](_0x3ed4af){const _0x45b488=a376_0x6b7638,{data:_0x52d2cd}=await this['_connection']['post'](veeva_constants_1[_0x45b488(0x140)][_0x45b488(0x182)]['replace'](_0x45b488(0x157),_0x3ed4af[_0x45b488(0x194)]));if(_0x52d2cd[_0x45b488(0x19f)]===status_enums_1[_0x45b488(0x159)][_0x45b488(0x16c)]){const {package_steps:_0x3689e2}=_0x52d2cd[_0x45b488(0x160)],_0x118767=array_utils_1[_0x45b488(0x145)][_0x45b488(0x166)](_0x3ed4af[_0x45b488(0x16b)],({stepName:_0x50a4c5})=>_0x50a4c5);for(const {name__v:_0x4bf6e2,deployment_action:_0x47190a}of _0x3689e2){for(const _0x36040c of _0x118767['get'](_0x4bf6e2)||[]){_0x36040c[_0x45b488(0x144)]=package_component_dto_1[_0x45b488(0x16a)][_0x45b488(0x19e)](_0x47190a);}}}else throw new veeva_error_1[(_0x45b488(0x167))](_0x52d2cd[_0x45b488(0x153)]);}async[a376_0x6b7638(0x158)](_0x1cfc9f){const _0x5da2ea=a376_0x6b7638,_0x327060=await this[_0x5da2ea(0x183)](_0x1cfc9f),_0x34a7a9=await this[_0x5da2ea(0x179)](_0x327060),_0x43cd4c=await this[_0x5da2ea(0x16e)](_0x34a7a9),_0x29dc95=await this[_0x5da2ea(0x177)](_0x43cd4c[_0x5da2ea(0x194)]),_0x4a5d00=await this[_0x5da2ea(0x179)](_0x29dc95);return this[_0x5da2ea(0x17b)](_0x4a5d00,_0x43cd4c);}}exports[a376_0x6b7638(0x195)]=PackageImportService;