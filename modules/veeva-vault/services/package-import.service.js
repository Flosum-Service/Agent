const a360_0x4473a2=a360_0x2232;(function(_0x199281,_0x3039b3){const _0x12835e=a360_0x2232,_0x52ff10=_0x199281();while(!![]){try{const _0x9d9074=-parseInt(_0x12835e(0xb7))/0x1+parseInt(_0x12835e(0xae))/0x2*(-parseInt(_0x12835e(0xca))/0x3)+parseInt(_0x12835e(0x9d))/0x4+parseInt(_0x12835e(0xa2))/0x5*(parseInt(_0x12835e(0xbf))/0x6)+parseInt(_0x12835e(0xb3))/0x7+parseInt(_0x12835e(0xa3))/0x8+-parseInt(_0x12835e(0x9e))/0x9;if(_0x9d9074===_0x3039b3)break;else _0x52ff10['push'](_0x52ff10['shift']());}catch(_0x25ddaa){_0x52ff10['push'](_0x52ff10['shift']());}}}(a360_0x341c,0xc7715));const a360_0x303157=(function(){let _0x4d0280=!![];return function(_0x5c183a,_0x367943){const _0x33a1c1=_0x4d0280?function(){const _0x249015=a360_0x2232;if(_0x367943){const _0x2ba203=_0x367943[_0x249015(0xbd)](_0x5c183a,arguments);return _0x367943=null,_0x2ba203;}}:function(){};return _0x4d0280=![],_0x33a1c1;};}()),a360_0x4f82eb=a360_0x303157(this,function(){const _0x89981a=a360_0x2232;return a360_0x4f82eb[_0x89981a(0x9c)]()[_0x89981a(0xa4)]('(((.+)+)+)+$')[_0x89981a(0x9c)]()[_0x89981a(0xf0)](a360_0x4f82eb)[_0x89981a(0xa4)](_0x89981a(0xcd));});a360_0x4f82eb();'use strict';var __importDefault=this&&this[a360_0x4473a2(0xd2)]||function(_0x571dcf){const _0x224170=a360_0x4473a2;return _0x571dcf&&_0x571dcf[_0x224170(0xda)]?_0x571dcf:{'default':_0x571dcf};};Object[a360_0x4473a2(0xd4)](exports,a360_0x4473a2(0xda),{'value':!![]}),exports['PackageImportService']=void 0x0;function a360_0x2232(_0x22045d,_0x4c6aa8){const _0x3e88b9=a360_0x341c();return a360_0x2232=function(_0x4f82eb,_0x303157){_0x4f82eb=_0x4f82eb-0x99;let _0x341cc0=_0x3e88b9[_0x4f82eb];return _0x341cc0;},a360_0x2232(_0x22045d,_0x4c6aa8);}const veeva_constants_1=require(a360_0x4473a2(0xaf)),status_enums_1=require(a360_0x4473a2(0xe5)),veeva_error_1=require('../classes/errors/veeva-error'),form_data_1=__importDefault(require(a360_0x4473a2(0xba))),fs_1=require('fs'),veeva_auth_utils_1=require(a360_0x4473a2(0xea)),package_details_dto_1=require(a360_0x4473a2(0xb4)),package_component_dto_1=require(a360_0x4473a2(0x9b)),array_utils_1=require('../utils/array.utils');class PackageImportService{constructor({veevaService:_0x582939,connection:_0x594c02,logger:_0x59264b,saveLog:_0xaac3cc}){const _0xa5d7cf=a360_0x4473a2;this[_0xa5d7cf(0xe1)]=_0x582939,this[_0xa5d7cf(0xc0)]=_0x594c02,this[_0xa5d7cf(0xbc)]=_0x59264b,this[_0xa5d7cf(0xa9)]=_0xaac3cc;}async[a360_0x4473a2(0xa1)](_0xb47c4e,_0x60710d=0x1){const _0x376a1e=a360_0x4473a2;this['_logger']['log'](_0x376a1e(0xdd));const _0x7fd7ff=new form_data_1[(_0x376a1e(0xad))]();_0x7fd7ff[_0x376a1e(0xe8)](_0x376a1e(0xe7),(0x0,fs_1[_0x376a1e(0xd1)])(_0xb47c4e));const _0x159ab6=await this['_connection'][_0x376a1e(0xa7)](veeva_constants_1[_0x376a1e(0xd6)]['ENDPOINT_EXPORT_IMPORT_PACKAGE'],_0x7fd7ff,{'headers':{'Content-Type':_0x376a1e(0xdc)}}),_0x410bfe=_0x159ab6[_0x376a1e(0xb5)];if(_0x410bfe[_0x376a1e(0xe2)]===status_enums_1[_0x376a1e(0xef)][_0x376a1e(0xee)])return _0x410bfe[_0x376a1e(0xc4)];else{if(_0x60710d>0x0)return await(0x0,veeva_auth_utils_1[_0x376a1e(0xe0)])(this['_connection']),await this['importVpk'](_0xb47c4e,_0x60710d-0x1);throw new veeva_error_1[(_0x376a1e(0xc5))](_0x410bfe['errors']);}}async[a360_0x4473a2(0xc3)](_0x4f50f8){const _0x36030f=a360_0x4473a2;this['_logger'][_0x36030f(0xd3)]('Deploy\x20package');const _0x515479=await this[_0x36030f(0xc0)]['post'](veeva_constants_1['VeevaConstants'][_0x36030f(0xe4)][_0x36030f(0xa5)](_0x36030f(0xc8),_0x4f50f8)),_0x2b70a1=await _0x515479[_0x36030f(0xb5)];if(_0x2b70a1[_0x36030f(0xe2)]===status_enums_1[_0x36030f(0xef)]['SUCCESS'])return _0x2b70a1['url'];else throw new veeva_error_1[(_0x36030f(0xc5))](_0x2b70a1[_0x36030f(0xc6)]);}async['getJobDetailUrl'](_0x187ed7){const _0x257fb8=a360_0x4473a2;this['_logger']['log'](_0x257fb8(0xeb));const [_0x5ab6ff]=await this[_0x257fb8(0xe1)]['getJobResult']([_0x187ed7]);return _0x5ab6ff[_0x257fb8(0xec)]['find'](_0x14d685=>_0x14d685[_0x257fb8(0xbe)]===_0x257fb8(0xa8))['href'];}async[a360_0x4473a2(0xb1)](_0x5e5c60){const _0x176111=a360_0x4473a2;this['_logger'][_0x176111(0xd3)](_0x176111(0xb8));const {data:_0x3b9b0c}=await this[_0x176111(0xc0)][_0x176111(0xc1)](_0x5e5c60);if(_0x3b9b0c[_0x176111(0xe2)]===status_enums_1['VeevaResponseStatus'][_0x176111(0xee)]){const _0x398b9c=new package_details_dto_1['PackageDetailsDto'](),{log:_0x678848,id:_0xa4d17e,package_status:_0x456cf5,package_steps:_0x395c9d}=_0x3b9b0c[_0x176111(0xcb)],_0x2a6964=_0x678848[_0x176111(0xb9)](_0x603771=>_0x603771[_0x176111(0xde)][_0x176111(0xa6)](_0x176111(0x9a))),_0xdd3787=await this['getLogResultText'](_0x2a6964[0x0]['url']);await this[_0x176111(0xa9)](_0xdd3787,'Validation\x20Log'),_0x398b9c[_0x176111(0xd0)]=_0xa4d17e,_0x398b9c[_0x176111(0xed)]=this[_0x176111(0xab)](_0x395c9d),await this[_0x176111(0xdb)](_0x398b9c);if(_0x456cf5!==status_enums_1[_0x176111(0xd5)][_0x176111(0x9f)])throw new Error(_0x176111(0x99));return _0x398b9c;}else throw new veeva_error_1[(_0x176111(0xc5))](_0x3b9b0c['errors']);}async[a360_0x4473a2(0xdf)](_0x22c294,_0x28ac77){const _0x4402e8=a360_0x4473a2;var _0x2d6b6b;this[_0x4402e8(0xbc)]['log'](_0x4402e8(0xc9));const {data:_0x1da2eb}=await this[_0x4402e8(0xc0)][_0x4402e8(0xc1)](_0x22c294);if(_0x1da2eb['responseStatus']===status_enums_1[_0x4402e8(0xef)][_0x4402e8(0xee)]){const {responseDetails:{deployment_log:_0x2c42a4,package_status__v:_0x4af22d},package_steps:_0x5b2207}=_0x1da2eb,_0x46b247=_0x2c42a4[_0x4402e8(0xb9)](_0x290a67=>_0x290a67[_0x4402e8(0xde)][_0x4402e8(0xa6)]('Deployment.log')),_0xb69e6f=await this[_0x4402e8(0xaa)](_0x46b247[0x0][_0x4402e8(0xc4)]);await this[_0x4402e8(0xa9)](_0xb69e6f,_0x4402e8(0xcc)),_0x28ac77[_0x4402e8(0xe3)]=[status_enums_1['VeevaPackageStatus'][_0x4402e8(0xe6)],status_enums_1['VeevaPackageStatus']['DEPLOYED_WITH_WARNINGS']][_0x4402e8(0xe9)](_0x4af22d);const _0xb345fc=array_utils_1['ArrayUtils']['groupUniqueToMap'](this['formPackageComponentList'](_0x5b2207),({uniqueName:_0x1d7da2})=>_0x1d7da2);for(const _0x34ba46 of _0x28ac77[_0x4402e8(0xed)]){const _0x498206=(_0x2d6b6b=_0xb345fc['get'](_0x34ba46['uniqueName']))===null||_0x2d6b6b===void 0x0?void 0x0:_0x2d6b6b['status'];_0x498206&&(_0x34ba46[_0x4402e8(0xb6)]=_0x498206);}_0x28ac77[_0x4402e8(0xed)]=_0x28ac77[_0x4402e8(0xed)][_0x4402e8(0xb9)](_0x11f7eb=>_0x11f7eb[_0x4402e8(0xb6)]!==status_enums_1['PackageComponentStatus'][_0x4402e8(0x9f)]);if(!_0x28ac77[_0x4402e8(0xed)][_0x4402e8(0xc7)])throw new Error(_0x4402e8(0xb0));return _0x28ac77;}else throw new veeva_error_1['VeevaError'](_0x1da2eb[_0x4402e8(0xc6)]);}async[a360_0x4473a2(0xaa)](_0x57dfd7){const _0x282017=a360_0x4473a2,{data:_0x4d72f1}=await this[_0x282017(0xc0)][_0x282017(0xc1)](_0x57dfd7,{'responseType':_0x282017(0xce)});return _0x4d72f1;}['formPackageComponentList'](_0x24e79d){const _0x280648=a360_0x4473a2;return _0x24e79d[_0x280648(0xc2)]((_0x24d7dc,_0x47d455)=>{const _0x4d6d40=_0x280648,_0x4905a1=_0x47d455[_0x4d6d40(0xcf)]['map'](_0x30df13=>new package_component_dto_1[(_0x4d6d40(0xd8))]({'status':_0x47d455['deployment_status__v'],'stepName':_0x47d455['name__v'],'component':_0x30df13}));return[..._0x24d7dc,..._0x4905a1];},[]);}async[a360_0x4473a2(0xdb)](_0xcb9c4a){const _0xb7b3dc=a360_0x4473a2,{data:_0x242273}=await this[_0xb7b3dc(0xc0)]['post'](veeva_constants_1[_0xb7b3dc(0xd6)]['ENDPOINT_VALIDATE_PACKAGE'][_0xb7b3dc(0xa5)](_0xb7b3dc(0xc8),_0xcb9c4a['packageId']));if(_0x242273[_0xb7b3dc(0xe2)]===status_enums_1[_0xb7b3dc(0xef)][_0xb7b3dc(0xee)]){const {package_steps:_0x249a42}=_0x242273[_0xb7b3dc(0xd9)],_0x50d541=array_utils_1[_0xb7b3dc(0xac)]['groupToMap'](_0xcb9c4a[_0xb7b3dc(0xed)],({stepName:_0x39a6d5})=>_0x39a6d5);for(const {name__v:_0x307e1d,deployment_action:_0x29c356}of _0x249a42){for(const _0xea3e72 of _0x50d541['get'](_0x307e1d)||[]){_0xea3e72[_0xb7b3dc(0xd7)]=package_component_dto_1['PackageComponentDto'][_0xb7b3dc(0xbb)](_0x29c356);}}}else throw new veeva_error_1[(_0xb7b3dc(0xc5))](_0x242273[_0xb7b3dc(0xc6)]);}async[a360_0x4473a2(0xb2)](_0x4c3140){const _0x496973=a360_0x4473a2,_0x3c5ba9=await this[_0x496973(0xa1)](_0x4c3140),_0x585051=await this['getJobDetailUrl'](_0x3c5ba9),_0x11cbd8=await this['getValidationDetailsAndSaveLog'](_0x585051),_0x245cfe=await this[_0x496973(0xc3)](_0x11cbd8[_0x496973(0xd0)]),_0x347ef8=await this[_0x496973(0xa0)](_0x245cfe);return this[_0x496973(0xdf)](_0x347ef8,_0x11cbd8);}}function a360_0x341c(){const _0x424335=['558665SjsBMt','Get\x20validation\x20details.','filter','form-data','convertDeploymentAction','_logger','apply','rel','84szINpl','_connection','get','reduce','deployPackage','url','VeevaError','errors','length','{package_id}','Get\x20deploy\x20result','60147GJTqcp','vaultPackage','Deploy\x20Log','(((.+)+)+)+$','text','package_components','packageId','createReadStream','__importDefault','log','defineProperty','VeevaPackageStatus','VeevaConstants','deploymentAction','PackageComponentDto','responseDetails','__esModule','fillPackageDeploymentAction','multipart/form-data','Import\x20package','filename','getDeployDetailsAndSaveLog','updateVeevaConnection','_veevaService','responseStatus','isDeployed','ENDPOINT_DEPLOY_PACKAGE','../enums/status.enums','DEPLOYED','file','append','includes','../utils/veeva-auth.utils','Wait\x20Executing\x20job','links','packageComponentList','SUCCESS','VeevaResponseStatus','constructor','Package\x20not\x20verified','Validation.log','../dtos/package-component.dto','toString','5534656GqEwjg','21481002jAPTLU','VERIFIED','getJobDetailUrl','importVpk','495265tXDcmN','5380568OXCMmp','search','replace','endsWith','put','artifacts','_saveLog','getLogResultText','formPackageComponentList','ArrayUtils','default','70DDWhpO','../constants/veeva.constants','Cannot\x20find\x20deployment\x20results','getValidationDetailsAndSaveLog','import','7147686TqpsYR','../dtos/package-details.dto','data','status'];a360_0x341c=function(){return _0x424335;};return a360_0x341c();}exports['PackageImportService']=PackageImportService;