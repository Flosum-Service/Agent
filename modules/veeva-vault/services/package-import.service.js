const a360_0x4bd0ad=a360_0x6e2e;(function(_0x51f766,_0x4acb29){const _0x1b5e88=a360_0x6e2e,_0x3343d8=_0x51f766();while(!![]){try{const _0x216d42=parseInt(_0x1b5e88(0x178))/0x1+parseInt(_0x1b5e88(0x18c))/0x2+parseInt(_0x1b5e88(0x192))/0x3+-parseInt(_0x1b5e88(0x191))/0x4*(parseInt(_0x1b5e88(0x197))/0x5)+-parseInt(_0x1b5e88(0x199))/0x6*(-parseInt(_0x1b5e88(0x171))/0x7)+parseInt(_0x1b5e88(0x15b))/0x8+parseInt(_0x1b5e88(0x175))/0x9*(-parseInt(_0x1b5e88(0x19e))/0xa);if(_0x216d42===_0x4acb29)break;else _0x3343d8['push'](_0x3343d8['shift']());}catch(_0xcc0ac){_0x3343d8['push'](_0x3343d8['shift']());}}}(a360_0x43c7,0xe6335));const a360_0x4a0d7a=(function(){let _0x3cb448=!![];return function(_0xee1304,_0x11e385){const _0x7080ad=_0x3cb448?function(){const _0x9aa2dc=a360_0x6e2e;if(_0x11e385){const _0x5afcba=_0x11e385[_0x9aa2dc(0x169)](_0xee1304,arguments);return _0x11e385=null,_0x5afcba;}}:function(){};return _0x3cb448=![],_0x7080ad;};}()),a360_0xb25061=a360_0x4a0d7a(this,function(){const _0x2e38eb=a360_0x6e2e;return a360_0xb25061[_0x2e38eb(0x195)]()[_0x2e38eb(0x16a)](_0x2e38eb(0x17a))[_0x2e38eb(0x195)]()[_0x2e38eb(0x1aa)](a360_0xb25061)['search']('(((.+)+)+)+$');});function a360_0x6e2e(_0x5577ad,_0x52494b){const _0x56e2c9=a360_0x43c7();return a360_0x6e2e=function(_0xb25061,_0x4a0d7a){_0xb25061=_0xb25061-0x154;let _0x43c718=_0x56e2c9[_0xb25061];return _0x43c718;},a360_0x6e2e(_0x5577ad,_0x52494b);}a360_0xb25061();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x301f75){const _0x1eb0d0=a360_0x6e2e;return _0x301f75&&_0x301f75[_0x1eb0d0(0x18a)]?_0x301f75:{'default':_0x301f75};};Object[a360_0x4bd0ad(0x165)](exports,a360_0x4bd0ad(0x18a),{'value':!![]}),exports[a360_0x4bd0ad(0x19f)]=void 0x0;const veeva_constants_1=require(a360_0x4bd0ad(0x179)),status_enums_1=require(a360_0x4bd0ad(0x16f)),veeva_error_1=require('../classes/errors/veeva-error'),form_data_1=__importDefault(require(a360_0x4bd0ad(0x190))),fs_1=require('fs'),veeva_auth_utils_1=require(a360_0x4bd0ad(0x17e)),package_details_dto_1=require('../dtos/package-details.dto'),package_component_dto_1=require(a360_0x4bd0ad(0x176)),array_utils_1=require(a360_0x4bd0ad(0x16e));function a360_0x43c7(){const _0xe6fc01=['apply','search','Get\x20deploy\x20result','append','responseDetails','../utils/array.utils','../enums/status.enums','Deploy\x20Log','71813cshfMI','VeevaConstants','put','PackageComponentDto','225xXwqMb','../dtos/package-component.dto','packageComponentList','360367dtxCKe','../constants/veeva.constants','(((.+)+)+)+$','getLogResultText','VeevaResponseStatus','endsWith','../utils/veeva-auth.utils','map','ArrayUtils','packageId','_veevaService','ENDPOINT_EXPORT_IMPORT_PACKAGE','data','DEPLOYED','getValidationDetailsAndSaveLog','VeevaError','importVpk','status','__esModule','fillPackageDeploymentAction','2013274aXChFu','get','Import\x20package','ENDPOINT_VALIDATE_PACKAGE','form-data','32sbruJS','1410540MbGfSn','getDeployDetailsAndSaveLog','links','toString','Deploy\x20package','623885IplbNu','Wait\x20Executing\x20job','276HGcxUY','getJobDetailUrl','filter','url','errors','242830qCSetj','PackageImportService','default','{package_id}','_logger','package_components','find','log','_saveLog','filename','deployment_status__v','responseStatus','constructor','SUCCESS','Cannot\x20find\x20deployment\x20results','includes','replace','length','text','deployPackage','formPackageComponentList','rel','1912752afrLxx','_connection','multipart/form-data','reduce','createReadStream','Get\x20validation\x20details.','post','ENDPOINT_DEPLOY_PACKAGE','getJobResult','Package\x20not\x20verified','defineProperty','VeevaPackageStatus','groupUniqueToMap','uniqueName'];a360_0x43c7=function(){return _0xe6fc01;};return a360_0x43c7();}class PackageImportService{constructor({veevaService:_0x391a69,connection:_0x2f2e64,logger:_0x3ff234,saveLog:_0x24bfc8}){const _0x48b8fb=a360_0x4bd0ad;this[_0x48b8fb(0x182)]=_0x391a69,this['_connection']=_0x2f2e64,this[_0x48b8fb(0x1a2)]=_0x3ff234,this['_saveLog']=_0x24bfc8;}async['importVpk'](_0x2b249b,_0x567838=0x1){const _0x51f516=a360_0x4bd0ad;this[_0x51f516(0x1a2)][_0x51f516(0x1a5)](_0x51f516(0x18e));const _0x2089c6=new form_data_1[(_0x51f516(0x1a0))]();_0x2089c6[_0x51f516(0x16c)]('file',(0x0,fs_1[_0x51f516(0x15f)])(_0x2b249b));const _0x392af3=await this[_0x51f516(0x15c)][_0x51f516(0x173)](veeva_constants_1[_0x51f516(0x172)][_0x51f516(0x183)],_0x2089c6,{'headers':{'Content-Type':_0x51f516(0x15d)}}),_0x590b73=_0x392af3['data'];if(_0x590b73[_0x51f516(0x1a9)]===status_enums_1['VeevaResponseStatus'][_0x51f516(0x1ab)])return _0x590b73[_0x51f516(0x19c)];else{if(_0x567838>0x0)return await(0x0,veeva_auth_utils_1['updateVeevaConnection'])(this[_0x51f516(0x15c)]),await this[_0x51f516(0x188)](_0x2b249b,_0x567838-0x1);throw new veeva_error_1[(_0x51f516(0x187))](_0x590b73[_0x51f516(0x19d)]);}}async[a360_0x4bd0ad(0x158)](_0xebf996){const _0x4b3ee0=a360_0x4bd0ad;this[_0x4b3ee0(0x1a2)][_0x4b3ee0(0x1a5)](_0x4b3ee0(0x196));const _0x42dad3=await this['_connection'][_0x4b3ee0(0x161)](veeva_constants_1['VeevaConstants'][_0x4b3ee0(0x162)][_0x4b3ee0(0x155)](_0x4b3ee0(0x1a1),_0xebf996)),_0xe3e672=await _0x42dad3[_0x4b3ee0(0x184)];if(_0xe3e672['responseStatus']===status_enums_1[_0x4b3ee0(0x17c)][_0x4b3ee0(0x1ab)])return _0xe3e672['url'];else throw new veeva_error_1[(_0x4b3ee0(0x187))](_0xe3e672[_0x4b3ee0(0x19d)]);}async[a360_0x4bd0ad(0x19a)](_0xf83ef5){const _0x393b28=a360_0x4bd0ad;this[_0x393b28(0x1a2)]['log'](_0x393b28(0x198));const [_0x4b6d84]=await this['_veevaService'][_0x393b28(0x163)]([_0xf83ef5]);return _0x4b6d84[_0x393b28(0x194)][_0x393b28(0x1a4)](_0x5a3663=>_0x5a3663[_0x393b28(0x15a)]==='artifacts')['href'];}async['getValidationDetailsAndSaveLog'](_0x37ab89){const _0x23112c=a360_0x4bd0ad;this[_0x23112c(0x1a2)][_0x23112c(0x1a5)](_0x23112c(0x160));const {data:_0x20b3af}=await this[_0x23112c(0x15c)][_0x23112c(0x18d)](_0x37ab89);if(_0x20b3af['responseStatus']===status_enums_1[_0x23112c(0x17c)][_0x23112c(0x1ab)]){const _0x52f05f=new package_details_dto_1['PackageDetailsDto'](),{log:_0x29a19b,id:_0x1edb23,package_status:_0x571c3d,package_steps:_0x41b3ae}=_0x20b3af['vaultPackage'],_0x3d5096=_0x29a19b[_0x23112c(0x19b)](_0x197518=>_0x197518[_0x23112c(0x1a7)][_0x23112c(0x17d)]('Validation.log')),_0x31ce41=await this[_0x23112c(0x17b)](_0x3d5096[0x0][_0x23112c(0x19c)]);await this[_0x23112c(0x1a6)](_0x31ce41,'Validation\x20Log'),_0x52f05f[_0x23112c(0x181)]=_0x1edb23,_0x52f05f[_0x23112c(0x177)]=this['formPackageComponentList'](_0x41b3ae),await this[_0x23112c(0x18b)](_0x52f05f);if(_0x571c3d!==status_enums_1[_0x23112c(0x166)]['VERIFIED'])throw new Error(_0x23112c(0x164));return _0x52f05f;}else throw new veeva_error_1['VeevaError'](_0x20b3af[_0x23112c(0x19d)]);}async[a360_0x4bd0ad(0x193)](_0x4443b6,_0x52c9d2){const _0x48bd74=a360_0x4bd0ad;var _0x285e5e;this[_0x48bd74(0x1a2)][_0x48bd74(0x1a5)](_0x48bd74(0x16b));const {data:_0x270144}=await this[_0x48bd74(0x15c)][_0x48bd74(0x18d)](_0x4443b6);if(_0x270144[_0x48bd74(0x1a9)]===status_enums_1[_0x48bd74(0x17c)][_0x48bd74(0x1ab)]){const {responseDetails:{deployment_log:_0x16d5bd,package_status__v:_0x385a41},package_steps:_0x11561e}=_0x270144,_0x3a47da=_0x16d5bd[_0x48bd74(0x19b)](_0x15a478=>_0x15a478[_0x48bd74(0x1a7)][_0x48bd74(0x17d)]('Deployment.log')),_0x18412c=await this[_0x48bd74(0x17b)](_0x3a47da[0x0]['url']);await this['_saveLog'](_0x18412c,_0x48bd74(0x170)),_0x52c9d2['isDeployed']=[status_enums_1[_0x48bd74(0x166)][_0x48bd74(0x185)],status_enums_1[_0x48bd74(0x166)]['DEPLOYED_WITH_WARNINGS']][_0x48bd74(0x154)](_0x385a41);const _0x438c59=array_utils_1[_0x48bd74(0x180)][_0x48bd74(0x167)](this['formPackageComponentList'](_0x11561e),({uniqueName:_0x492593})=>_0x492593);for(const _0x1839ec of _0x52c9d2['packageComponentList']){const _0x442efe=(_0x285e5e=_0x438c59[_0x48bd74(0x18d)](_0x1839ec[_0x48bd74(0x168)]))===null||_0x285e5e===void 0x0?void 0x0:_0x285e5e[_0x48bd74(0x189)];_0x442efe&&(_0x1839ec[_0x48bd74(0x189)]=_0x442efe);}_0x52c9d2[_0x48bd74(0x177)]=_0x52c9d2[_0x48bd74(0x177)][_0x48bd74(0x19b)](_0xa1073=>_0xa1073['status']!==status_enums_1['PackageComponentStatus']['VERIFIED']);if(!_0x52c9d2[_0x48bd74(0x177)][_0x48bd74(0x156)])throw new Error(_0x48bd74(0x1ac));return _0x52c9d2;}else throw new veeva_error_1[(_0x48bd74(0x187))](_0x270144[_0x48bd74(0x19d)]);}async['getLogResultText'](_0x782f15){const _0x6438b2=a360_0x4bd0ad,{data:_0x969ffa}=await this['_connection'][_0x6438b2(0x18d)](_0x782f15,{'responseType':_0x6438b2(0x157)});return _0x969ffa;}[a360_0x4bd0ad(0x159)](_0x1ac4c2){const _0x348ff7=a360_0x4bd0ad;return _0x1ac4c2[_0x348ff7(0x15e)]((_0x235c69,_0x2cb0a1)=>{const _0x38cb41=_0x348ff7,_0x56a886=_0x2cb0a1[_0x38cb41(0x1a3)][_0x38cb41(0x17f)](_0x2d2a7a=>new package_component_dto_1[(_0x38cb41(0x174))]({'status':_0x2cb0a1[_0x38cb41(0x1a8)],'stepName':_0x2cb0a1['name__v'],'component':_0x2d2a7a}));return[..._0x235c69,..._0x56a886];},[]);}async[a360_0x4bd0ad(0x18b)](_0x34852d){const _0x5808fd=a360_0x4bd0ad,{data:_0x129ea4}=await this['_connection'][_0x5808fd(0x161)](veeva_constants_1[_0x5808fd(0x172)][_0x5808fd(0x18f)][_0x5808fd(0x155)](_0x5808fd(0x1a1),_0x34852d[_0x5808fd(0x181)]));if(_0x129ea4['responseStatus']===status_enums_1['VeevaResponseStatus'][_0x5808fd(0x1ab)]){const {package_steps:_0x4cc616}=_0x129ea4[_0x5808fd(0x16d)],_0x1e61d4=array_utils_1[_0x5808fd(0x180)]['groupToMap'](_0x34852d[_0x5808fd(0x177)],({stepName:_0x59a3df})=>_0x59a3df);for(const {name__v:_0x2f99ed,deployment_action:_0x3910a9}of _0x4cc616){for(const _0xfe0821 of _0x1e61d4[_0x5808fd(0x18d)](_0x2f99ed)||[]){_0xfe0821['deploymentAction']=package_component_dto_1[_0x5808fd(0x174)]['convertDeploymentAction'](_0x3910a9);}}}else throw new veeva_error_1[(_0x5808fd(0x187))](_0x129ea4[_0x5808fd(0x19d)]);}async['import'](_0x2ece87){const _0x294a06=a360_0x4bd0ad,_0x4dad50=await this['importVpk'](_0x2ece87),_0x5a35e0=await this[_0x294a06(0x19a)](_0x4dad50),_0x58c57b=await this[_0x294a06(0x186)](_0x5a35e0),_0x2a4d09=await this['deployPackage'](_0x58c57b['packageId']),_0x5b4666=await this[_0x294a06(0x19a)](_0x2a4d09);return this[_0x294a06(0x193)](_0x5b4666,_0x58c57b);}}exports[a360_0x4bd0ad(0x19f)]=PackageImportService;