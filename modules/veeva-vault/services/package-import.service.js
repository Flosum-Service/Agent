const a360_0x1c01bc=a360_0xa27e;(function(_0x47af5e,_0x152bf8){const _0xcec3e4=a360_0xa27e,_0x319bd7=_0x47af5e();while(!![]){try{const _0x30c1b3=-parseInt(_0xcec3e4(0x192))/0x1+parseInt(_0xcec3e4(0x188))/0x2+parseInt(_0xcec3e4(0x182))/0x3*(-parseInt(_0xcec3e4(0x15e))/0x4)+-parseInt(_0xcec3e4(0x163))/0x5*(-parseInt(_0xcec3e4(0x1b3))/0x6)+parseInt(_0xcec3e4(0x17f))/0x7+-parseInt(_0xcec3e4(0x19d))/0x8+parseInt(_0xcec3e4(0x18d))/0x9*(parseInt(_0xcec3e4(0x18f))/0xa);if(_0x30c1b3===_0x152bf8)break;else _0x319bd7['push'](_0x319bd7['shift']());}catch(_0x8786a8){_0x319bd7['push'](_0x319bd7['shift']());}}}(a360_0x21c1,0x2b52e));const a360_0x442eb1=(function(){let _0x19b3b3=!![];return function(_0x10e2c7,_0x44bb00){const _0x17968a=_0x19b3b3?function(){const _0x23c9f7=a360_0xa27e;if(_0x44bb00){const _0x450c3c=_0x44bb00[_0x23c9f7(0x181)](_0x10e2c7,arguments);return _0x44bb00=null,_0x450c3c;}}:function(){};return _0x19b3b3=![],_0x17968a;};}()),a360_0x704261=a360_0x442eb1(this,function(){const _0x1442dd=a360_0xa27e;return a360_0x704261[_0x1442dd(0x193)]()['search'](_0x1442dd(0x1a0))[_0x1442dd(0x193)]()[_0x1442dd(0x173)](a360_0x704261)[_0x1442dd(0x16d)](_0x1442dd(0x1a0));});a360_0x704261();'use strict';var __importDefault=this&&this[a360_0x1c01bc(0x19c)]||function(_0x281fd6){return _0x281fd6&&_0x281fd6['__esModule']?_0x281fd6:{'default':_0x281fd6};};Object[a360_0x1c01bc(0x19b)](exports,a360_0x1c01bc(0x196),{'value':!![]}),exports[a360_0x1c01bc(0x16c)]=void 0x0;const veeva_constants_1=require(a360_0x1c01bc(0x16f)),status_enums_1=require(a360_0x1c01bc(0x191)),veeva_error_1=require(a360_0x1c01bc(0x1a4)),form_data_1=__importDefault(require(a360_0x1c01bc(0x17c))),fs_1=require('fs'),veeva_auth_utils_1=require(a360_0x1c01bc(0x1a8)),package_details_dto_1=require(a360_0x1c01bc(0x177)),package_component_dto_1=require(a360_0x1c01bc(0x1b8)),array_utils_1=require('../utils/array.utils');function a360_0xa27e(_0x342edb,_0x45185f){const _0x475a6d=a360_0x21c1();return a360_0xa27e=function(_0x704261,_0x442eb1){_0x704261=_0x704261-0x15e;let _0x21c1ed=_0x475a6d[_0x704261];return _0x21c1ed;},a360_0xa27e(_0x342edb,_0x45185f);}class PackageImportService{constructor({veevaService:_0x5c9685,connection:_0x315196,logger:_0x4d3d58,saveLog:_0x14ea1d}){const _0x48ee3c=a360_0x1c01bc;this[_0x48ee3c(0x1b5)]=_0x5c9685,this[_0x48ee3c(0x17b)]=_0x315196,this[_0x48ee3c(0x166)]=_0x4d3d58,this[_0x48ee3c(0x1bc)]=_0x14ea1d;}async['importVpk'](_0x40ef70,_0x2baffb=0x1){const _0x32e9e4=a360_0x1c01bc;this[_0x32e9e4(0x166)][_0x32e9e4(0x171)](_0x32e9e4(0x175));const _0x3696db=new form_data_1[(_0x32e9e4(0x161))]();_0x3696db[_0x32e9e4(0x1b6)](_0x32e9e4(0x185),(0x0,fs_1[_0x32e9e4(0x1ba)])(_0x40ef70));const _0x5ae818=await this[_0x32e9e4(0x17b)][_0x32e9e4(0x160)](veeva_constants_1[_0x32e9e4(0x1ae)][_0x32e9e4(0x1b7)],_0x3696db,{'headers':{'Content-Type':'multipart/form-data'}}),_0x3fdec0=_0x5ae818[_0x32e9e4(0x1a7)];if(_0x3fdec0['responseStatus']===status_enums_1[_0x32e9e4(0x17e)]['SUCCESS'])return _0x3fdec0['url'];else{if(_0x2baffb>0x0)return await(0x0,veeva_auth_utils_1[_0x32e9e4(0x18e)])(this['_connection']),await this[_0x32e9e4(0x1b0)](_0x40ef70,_0x2baffb-0x1);throw new veeva_error_1['VeevaError'](_0x3fdec0['errors']);}}async['deployPackage'](_0x3b75ea){const _0x92867=a360_0x1c01bc;this[_0x92867(0x166)]['log'](_0x92867(0x18b));const _0x49ad6b=await this['_connection'][_0x92867(0x1a6)](veeva_constants_1[_0x92867(0x1ae)][_0x92867(0x167)][_0x92867(0x186)](_0x92867(0x15f),_0x3b75ea)),_0x3bf932=await _0x49ad6b[_0x92867(0x1a7)];if(_0x3bf932[_0x92867(0x178)]===status_enums_1['VeevaResponseStatus'][_0x92867(0x1a1)])return _0x3bf932[_0x92867(0x180)];else throw new veeva_error_1[(_0x92867(0x1a9))](_0x3bf932['errors']);}async['getJobDetailUrl'](_0x541131){const _0x512e09=a360_0x1c01bc;this[_0x512e09(0x166)][_0x512e09(0x171)](_0x512e09(0x1a5));const [_0x28bb75]=await this[_0x512e09(0x1b5)][_0x512e09(0x1a3)]([_0x541131]);return _0x28bb75[_0x512e09(0x184)][_0x512e09(0x174)](_0x4d4233=>_0x4d4233[_0x512e09(0x164)]==='artifacts')[_0x512e09(0x1b1)];}async['getValidationDetailsAndSaveLog'](_0x55439c){const _0x19e2a0=a360_0x1c01bc;this[_0x19e2a0(0x166)][_0x19e2a0(0x171)]('Get\x20validation\x20details.');const {data:_0x57fe3d}=await this[_0x19e2a0(0x17b)]['get'](_0x55439c);if(_0x57fe3d['responseStatus']===status_enums_1[_0x19e2a0(0x17e)][_0x19e2a0(0x1a1)]){const _0x4f0747=new package_details_dto_1['PackageDetailsDto'](),{log:_0x36f7b7,id:_0x5398ab,package_status:_0x3cafd4,package_steps:_0x5ae3d2}=_0x57fe3d[_0x19e2a0(0x176)],_0x23a892=_0x36f7b7[_0x19e2a0(0x168)](_0x44a05e=>_0x44a05e[_0x19e2a0(0x1bb)][_0x19e2a0(0x183)](_0x19e2a0(0x17d))),_0x1fe068=await this[_0x19e2a0(0x19e)](_0x23a892[0x0][_0x19e2a0(0x180)]);await this[_0x19e2a0(0x1bc)](_0x1fe068,_0x19e2a0(0x195)),_0x4f0747[_0x19e2a0(0x1a2)]=_0x5398ab,_0x4f0747['packageComponentList']=this[_0x19e2a0(0x197)](_0x5ae3d2),await this[_0x19e2a0(0x162)](_0x4f0747);if(_0x3cafd4!==status_enums_1[_0x19e2a0(0x189)][_0x19e2a0(0x198)])throw new Error(_0x19e2a0(0x1b2));return _0x4f0747;}else throw new veeva_error_1[(_0x19e2a0(0x1a9))](_0x57fe3d['errors']);}async['getDeployDetailsAndSaveLog'](_0x36be6b,_0x3f5619){const _0x2c491c=a360_0x1c01bc;var _0x5586cc;this['_logger'][_0x2c491c(0x171)]('Get\x20deploy\x20result');const {data:_0x141236}=await this[_0x2c491c(0x17b)][_0x2c491c(0x19f)](_0x36be6b);if(_0x141236[_0x2c491c(0x178)]===status_enums_1[_0x2c491c(0x17e)][_0x2c491c(0x1a1)]){const {responseDetails:{deployment_log:_0x387628,package_status__v:_0x44cd74},package_steps:_0x43135a}=_0x141236,_0x31c9a1=_0x387628[_0x2c491c(0x168)](_0x3cfd05=>_0x3cfd05[_0x2c491c(0x1bb)][_0x2c491c(0x183)]('Deployment.log')),_0x44408b=await this['getLogResultText'](_0x31c9a1[0x0][_0x2c491c(0x180)]);await this['_saveLog'](_0x44408b,_0x2c491c(0x18c)),_0x3f5619[_0x2c491c(0x169)]=[status_enums_1[_0x2c491c(0x189)][_0x2c491c(0x179)],status_enums_1['VeevaPackageStatus'][_0x2c491c(0x1b9)]]['includes'](_0x44cd74);const _0x229a08=array_utils_1[_0x2c491c(0x172)][_0x2c491c(0x16e)](this['formPackageComponentList'](_0x43135a),({uniqueName:_0x4cdfe3})=>_0x4cdfe3);for(const _0x59971c of _0x3f5619[_0x2c491c(0x190)]){const _0x2e6f11=(_0x5586cc=_0x229a08[_0x2c491c(0x19f)](_0x59971c[_0x2c491c(0x165)]))===null||_0x5586cc===void 0x0?void 0x0:_0x5586cc[_0x2c491c(0x1aa)];_0x2e6f11&&(_0x59971c[_0x2c491c(0x1aa)]=_0x2e6f11);}_0x3f5619[_0x2c491c(0x190)]=_0x3f5619[_0x2c491c(0x190)][_0x2c491c(0x168)](_0xbd63c4=>_0xbd63c4[_0x2c491c(0x1aa)]!==status_enums_1[_0x2c491c(0x1ac)][_0x2c491c(0x198)]);if(!_0x3f5619[_0x2c491c(0x190)]['length'])throw new Error(_0x2c491c(0x16b));return _0x3f5619;}else throw new veeva_error_1[(_0x2c491c(0x1a9))](_0x141236[_0x2c491c(0x1ad)]);}async['getLogResultText'](_0x418e14){const _0x5715ff=a360_0x1c01bc,{data:_0x444479}=await this[_0x5715ff(0x17b)][_0x5715ff(0x19f)](_0x418e14,{'responseType':_0x5715ff(0x1b4)});return _0x444479;}[a360_0x1c01bc(0x197)](_0x4f0ce1){const _0x4a46af=a360_0x1c01bc;return _0x4f0ce1[_0x4a46af(0x1be)]((_0x5d39d2,_0x40f678)=>{const _0x520ade=_0x4a46af,_0x568171=_0x40f678[_0x520ade(0x18a)][_0x520ade(0x1bd)](_0x4e152b=>new package_component_dto_1[(_0x520ade(0x19a))]({'status':_0x40f678[_0x520ade(0x187)],'stepName':_0x40f678[_0x520ade(0x1ab)],'component':_0x4e152b}));return[..._0x5d39d2,..._0x568171];},[]);}async['fillPackageDeploymentAction'](_0xce2e3d){const _0x122a91=a360_0x1c01bc,{data:_0x347d00}=await this[_0x122a91(0x17b)][_0x122a91(0x1a6)](veeva_constants_1['VeevaConstants'][_0x122a91(0x16a)]['replace'](_0x122a91(0x15f),_0xce2e3d[_0x122a91(0x1a2)]));if(_0x347d00[_0x122a91(0x178)]===status_enums_1[_0x122a91(0x17e)]['SUCCESS']){const {package_steps:_0x2535ca}=_0x347d00['responseDetails'],_0x26260d=array_utils_1[_0x122a91(0x172)][_0x122a91(0x194)](_0xce2e3d[_0x122a91(0x190)],({stepName:_0x5964a9})=>_0x5964a9);for(const {name__v:_0x2cbef7,deployment_action:_0x180273}of _0x2535ca){for(const _0x303e5a of _0x26260d[_0x122a91(0x19f)](_0x2cbef7)||[]){_0x303e5a[_0x122a91(0x17a)]=package_component_dto_1[_0x122a91(0x19a)]['convertDeploymentAction'](_0x180273);}}}else throw new veeva_error_1[(_0x122a91(0x1a9))](_0x347d00['errors']);}async['import'](_0xe30118){const _0x255de1=a360_0x1c01bc,_0x58de52=await this[_0x255de1(0x1b0)](_0xe30118),_0x5a2129=await this['getJobDetailUrl'](_0x58de52),_0x4696a7=await this['getValidationDetailsAndSaveLog'](_0x5a2129),_0x156af2=await this[_0x255de1(0x199)](_0x4696a7[_0x255de1(0x1a2)]),_0x5bcdd3=await this[_0x255de1(0x170)](_0x156af2);return this[_0x255de1(0x1af)](_0x5bcdd3,_0x4696a7);}}function a360_0x21c1(){const _0x4c24ec=['isDeployed','ENDPOINT_VALIDATE_PACKAGE','Cannot\x20find\x20deployment\x20results','PackageImportService','search','groupUniqueToMap','../constants/veeva.constants','getJobDetailUrl','log','ArrayUtils','constructor','find','Import\x20package','vaultPackage','../dtos/package-details.dto','responseStatus','DEPLOYED','deploymentAction','_connection','form-data','Validation.log','VeevaResponseStatus','421001WuqLQu','url','apply','213aLJYCX','endsWith','links','file','replace','deployment_status__v','653412hnIHFK','VeevaPackageStatus','package_components','Deploy\x20package','Deploy\x20Log','198ggyyiY','updateVeevaConnection','117970ouWyxt','packageComponentList','../enums/status.enums','48981fqZIRC','toString','groupToMap','Validation\x20Log','__esModule','formPackageComponentList','VERIFIED','deployPackage','PackageComponentDto','defineProperty','__importDefault','2644896ApcmVj','getLogResultText','get','(((.+)+)+)+$','SUCCESS','packageId','getJobResult','../classes/errors/veeva-error','Wait\x20Executing\x20job','post','data','../utils/veeva-auth.utils','VeevaError','status','name__v','PackageComponentStatus','errors','VeevaConstants','getDeployDetailsAndSaveLog','importVpk','href','Package\x20not\x20verified','114BhbivS','text','_veevaService','append','ENDPOINT_EXPORT_IMPORT_PACKAGE','../dtos/package-component.dto','DEPLOYED_WITH_WARNINGS','createReadStream','filename','_saveLog','map','reduce','6644daMqst','{package_id}','put','default','fillPackageDeploymentAction','7525kaShpf','rel','uniqueName','_logger','ENDPOINT_DEPLOY_PACKAGE','filter'];a360_0x21c1=function(){return _0x4c24ec;};return a360_0x21c1();}exports[a360_0x1c01bc(0x16c)]=PackageImportService;