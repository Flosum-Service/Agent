const a336_0xd453ab=a336_0x4df0;(function(_0x3ed58d,_0x14974b){const _0x3ba021=a336_0x4df0,_0x2c015b=_0x3ed58d();while(!![]){try{const _0x2c2daf=-parseInt(_0x3ba021(0x17c))/0x1*(-parseInt(_0x3ba021(0x17b))/0x2)+-parseInt(_0x3ba021(0x14e))/0x3*(-parseInt(_0x3ba021(0x14f))/0x4)+-parseInt(_0x3ba021(0x154))/0x5*(-parseInt(_0x3ba021(0x152))/0x6)+parseInt(_0x3ba021(0x16e))/0x7+-parseInt(_0x3ba021(0x170))/0x8*(-parseInt(_0x3ba021(0x17a))/0x9)+-parseInt(_0x3ba021(0x19c))/0xa*(-parseInt(_0x3ba021(0x163))/0xb)+-parseInt(_0x3ba021(0x19a))/0xc;if(_0x2c2daf===_0x14974b)break;else _0x2c015b['push'](_0x2c015b['shift']());}catch(_0x3ec4b8){_0x2c015b['push'](_0x2c015b['shift']());}}}(a336_0x2ffd,0x20e0e));const a336_0x204d03=(function(){let _0x4d7b39=!![];return function(_0x4df214,_0x24f6e9){const _0x275ce1=_0x4d7b39?function(){const _0x4e13ef=a336_0x4df0;if(_0x24f6e9){const _0x585ebf=_0x24f6e9[_0x4e13ef(0x19e)](_0x4df214,arguments);return _0x24f6e9=null,_0x585ebf;}}:function(){};return _0x4d7b39=![],_0x275ce1;};}()),a336_0x4508a6=a336_0x204d03(this,function(){const _0x72f7d6=a336_0x4df0;return a336_0x4508a6[_0x72f7d6(0x181)]()[_0x72f7d6(0x174)](_0x72f7d6(0x17d))[_0x72f7d6(0x181)]()['constructor'](a336_0x4508a6)[_0x72f7d6(0x174)](_0x72f7d6(0x17d));});a336_0x4508a6();'use strict';function a336_0x4df0(_0x13c6a8,_0xe94dc9){const _0x13bf71=a336_0x2ffd();return a336_0x4df0=function(_0x4508a6,_0x204d03){_0x4508a6=_0x4508a6-0x149;let _0x2ffdc4=_0x13bf71[_0x4508a6];return _0x2ffdc4;},a336_0x4df0(_0x13c6a8,_0xe94dc9);}var __importDefault=this&&this['__importDefault']||function(_0x300bc4){return _0x300bc4&&_0x300bc4['__esModule']?_0x300bc4:{'default':_0x300bc4};};Object[a336_0xd453ab(0x151)](exports,'__esModule',{'value':!![]}),exports['PackageImportService']=void 0x0;const veeva_constants_1=require(a336_0xd453ab(0x184)),status_enums_1=require(a336_0xd453ab(0x19f)),veeva_error_1=require(a336_0xd453ab(0x158)),form_data_1=__importDefault(require(a336_0xd453ab(0x187))),fs_1=require('fs'),veeva_auth_utils_1=require('../utils/veeva-auth.utils'),package_details_dto_1=require(a336_0xd453ab(0x195)),package_component_dto_1=require(a336_0xd453ab(0x175)),array_utils_1=require('../utils/array.utils');function a336_0x2ffd(){const _0xc5dbe6=['ArrayUtils','data','VeevaResponseStatus','VeevaPackageStatus','log','href','1795052soBdFR','links','32jMIkws','Validation\x20Log','get','packageComponentList','search','../dtos/package-component.dto','Import\x20package','VeevaConstants','convertDeploymentAction','deploymentAction','19125mwpXFa','7842PPcIec','13eAjZVd','(((.+)+)+)+$','reduce','Deploy\x20package','rel','toString','getValidationDetailsAndSaveLog','Get\x20validation\x20details.','../constants/veeva.constants','errors','_connection','form-data','Cannot\x20find\x20deployment\x20results','deployPackage','{package_id}','_logger','packageId','Get\x20deploy\x20result','Deploy\x20Log','ENDPOINT_DEPLOY_PACKAGE','updateVeevaConnection','fillPackageDeploymentAction','PackageDetailsDto','SUCCESS','vaultPackage','../dtos/package-details.dto','importVpk','VERIFIED','url','VeevaError','5161524OwEmmE','status','10QPuDdY','getLogResultText','apply','../enums/status.enums','DEPLOYED','replace','Package\x20not\x20verified','filter','groupUniqueToMap','PackageComponentDto','30Immnmd','25128PKiQKC','Deployment.log','defineProperty','12omwNcE','includes','313000sfYcNe','responseDetails','append','post','../classes/errors/veeva-error','getDeployDetailsAndSaveLog','getJobResult','import','filename','length','PackageComponentStatus','_veevaService','_saveLog','formPackageComponentList','getJobDetailUrl','669548bzkvSX','package_components','responseStatus','file','default'];a336_0x2ffd=function(){return _0xc5dbe6;};return a336_0x2ffd();}class PackageImportService{constructor({veevaService:_0x308bdd,connection:_0x1ec798,logger:_0x10c923,saveLog:_0x10e247}){const _0xce7748=a336_0xd453ab;this['_veevaService']=_0x308bdd,this[_0xce7748(0x186)]=_0x1ec798,this[_0xce7748(0x18b)]=_0x10c923,this[_0xce7748(0x160)]=_0x10e247;}async[a336_0xd453ab(0x196)](_0x200556,_0x351658=0x1){const _0x25fe9f=a336_0xd453ab;this['_logger'][_0x25fe9f(0x16c)](_0x25fe9f(0x176));const _0x20854c=new form_data_1[(_0x25fe9f(0x167))]();_0x20854c[_0x25fe9f(0x156)](_0x25fe9f(0x166),(0x0,fs_1['createReadStream'])(_0x200556));const _0x29011b=await this['_connection']['put'](veeva_constants_1[_0x25fe9f(0x177)]['ENDPOINT_EXPORT_IMPORT_PACKAGE'],_0x20854c,{'headers':{'Content-Type':'multipart/form-data'}}),_0x11727f=_0x29011b[_0x25fe9f(0x169)];if(_0x11727f[_0x25fe9f(0x165)]===status_enums_1['VeevaResponseStatus'][_0x25fe9f(0x193)])return _0x11727f[_0x25fe9f(0x198)];else{if(_0x351658>0x0)return await(0x0,veeva_auth_utils_1[_0x25fe9f(0x190)])(this[_0x25fe9f(0x186)]),await this[_0x25fe9f(0x196)](_0x200556,_0x351658-0x1);throw new veeva_error_1[(_0x25fe9f(0x199))](_0x11727f[_0x25fe9f(0x185)]);}}async[a336_0xd453ab(0x189)](_0x40d89b){const _0x4d55d2=a336_0xd453ab;this['_logger'][_0x4d55d2(0x16c)](_0x4d55d2(0x17f));const _0x4954e3=await this[_0x4d55d2(0x186)]['post'](veeva_constants_1['VeevaConstants'][_0x4d55d2(0x18f)][_0x4d55d2(0x149)]('{package_id}',_0x40d89b)),_0x5d55c6=await _0x4954e3[_0x4d55d2(0x169)];if(_0x5d55c6[_0x4d55d2(0x165)]===status_enums_1[_0x4d55d2(0x16a)][_0x4d55d2(0x193)])return _0x5d55c6['url'];else throw new veeva_error_1['VeevaError'](_0x5d55c6[_0x4d55d2(0x185)]);}async[a336_0xd453ab(0x162)](_0x54aafe){const _0x1a6b04=a336_0xd453ab;this[_0x1a6b04(0x18b)][_0x1a6b04(0x16c)]('Wait\x20Executing\x20job');const [_0x28a53b]=await this[_0x1a6b04(0x15f)][_0x1a6b04(0x15a)]([_0x54aafe]);return _0x28a53b[_0x1a6b04(0x16f)]['find'](_0x28bee9=>_0x28bee9[_0x1a6b04(0x180)]==='artifacts')[_0x1a6b04(0x16d)];}async['getValidationDetailsAndSaveLog'](_0x108512){const _0x5c7d8d=a336_0xd453ab;this[_0x5c7d8d(0x18b)][_0x5c7d8d(0x16c)](_0x5c7d8d(0x183));const {data:_0x4e586d}=await this[_0x5c7d8d(0x186)]['get'](_0x108512);if(_0x4e586d['responseStatus']===status_enums_1[_0x5c7d8d(0x16a)][_0x5c7d8d(0x193)]){const _0x3289b7=new package_details_dto_1[(_0x5c7d8d(0x192))](),{log:_0x2e45ea,id:_0x403f1c,package_status:_0x19c02d,package_steps:_0x3c1d3e}=_0x4e586d[_0x5c7d8d(0x194)],_0x1a7604=_0x2e45ea[_0x5c7d8d(0x14b)](_0x411bec=>_0x411bec[_0x5c7d8d(0x15c)]['endsWith']('Validation.log')),_0x3adf02=await this[_0x5c7d8d(0x19d)](_0x1a7604[0x0][_0x5c7d8d(0x198)]);await this[_0x5c7d8d(0x160)](_0x3adf02,_0x5c7d8d(0x171)),_0x3289b7[_0x5c7d8d(0x18c)]=_0x403f1c,_0x3289b7[_0x5c7d8d(0x173)]=this[_0x5c7d8d(0x161)](_0x3c1d3e),await this[_0x5c7d8d(0x191)](_0x3289b7);if(_0x19c02d!==status_enums_1['VeevaPackageStatus'][_0x5c7d8d(0x197)])throw new Error(_0x5c7d8d(0x14a));return _0x3289b7;}else throw new veeva_error_1['VeevaError'](_0x4e586d[_0x5c7d8d(0x185)]);}async[a336_0xd453ab(0x159)](_0x22e575,_0x1e56e6){const _0x4283de=a336_0xd453ab;var _0x480e46;this[_0x4283de(0x18b)]['log'](_0x4283de(0x18d));const {data:_0x3b22a4}=await this['_connection'][_0x4283de(0x172)](_0x22e575);if(_0x3b22a4[_0x4283de(0x165)]===status_enums_1[_0x4283de(0x16a)][_0x4283de(0x193)]){const {responseDetails:{deployment_log:_0x429a69,package_status__v:_0x489b24},package_steps:_0x4a0da6}=_0x3b22a4,_0xf9890c=_0x429a69[_0x4283de(0x14b)](_0xf694eb=>_0xf694eb['filename']['endsWith'](_0x4283de(0x150))),_0x5d752b=await this[_0x4283de(0x19d)](_0xf9890c[0x0][_0x4283de(0x198)]);await this[_0x4283de(0x160)](_0x5d752b,_0x4283de(0x18e)),_0x1e56e6['isDeployed']=[status_enums_1[_0x4283de(0x16b)][_0x4283de(0x1a0)],status_enums_1['VeevaPackageStatus']['DEPLOYED_WITH_WARNINGS']][_0x4283de(0x153)](_0x489b24);const _0xf9982e=array_utils_1[_0x4283de(0x168)][_0x4283de(0x14c)](this[_0x4283de(0x161)](_0x4a0da6),({uniqueName:_0x3296ef})=>_0x3296ef);for(const _0x2a6361 of _0x1e56e6['packageComponentList']){const _0x426a83=(_0x480e46=_0xf9982e[_0x4283de(0x172)](_0x2a6361['uniqueName']))===null||_0x480e46===void 0x0?void 0x0:_0x480e46['status'];_0x426a83&&(_0x2a6361[_0x4283de(0x19b)]=_0x426a83);}_0x1e56e6['packageComponentList']=_0x1e56e6[_0x4283de(0x173)]['filter'](_0x1c6a09=>_0x1c6a09[_0x4283de(0x19b)]!==status_enums_1[_0x4283de(0x15e)][_0x4283de(0x197)]);if(!_0x1e56e6[_0x4283de(0x173)][_0x4283de(0x15d)])throw new Error(_0x4283de(0x188));return _0x1e56e6;}else throw new veeva_error_1[(_0x4283de(0x199))](_0x3b22a4[_0x4283de(0x185)]);}async[a336_0xd453ab(0x19d)](_0x267301){const _0xa48e37=a336_0xd453ab,{data:_0x226996}=await this[_0xa48e37(0x186)][_0xa48e37(0x172)](_0x267301,{'responseType':'text'});return _0x226996;}['formPackageComponentList'](_0x47cad6){const _0x433438=a336_0xd453ab;return _0x47cad6[_0x433438(0x17e)]((_0x62281a,_0x51b749)=>{const _0x569e86=_0x433438,_0x284bf9=_0x51b749[_0x569e86(0x164)]['map'](_0x55daef=>new package_component_dto_1[(_0x569e86(0x14d))]({'status':_0x51b749['deployment_status__v'],'stepName':_0x51b749['name__v'],'component':_0x55daef}));return[..._0x62281a,..._0x284bf9];},[]);}async['fillPackageDeploymentAction'](_0x4a9ad1){const _0x47434e=a336_0xd453ab,{data:_0xccd84c}=await this['_connection'][_0x47434e(0x157)](veeva_constants_1[_0x47434e(0x177)]['ENDPOINT_VALIDATE_PACKAGE'][_0x47434e(0x149)](_0x47434e(0x18a),_0x4a9ad1[_0x47434e(0x18c)]));if(_0xccd84c[_0x47434e(0x165)]===status_enums_1[_0x47434e(0x16a)][_0x47434e(0x193)]){const {package_steps:_0x8b24e9}=_0xccd84c[_0x47434e(0x155)],_0x4b6663=array_utils_1['ArrayUtils']['groupToMap'](_0x4a9ad1[_0x47434e(0x173)],({stepName:_0xd5cc7})=>_0xd5cc7);for(const {name__v:_0x225a1d,deployment_action:_0x471876}of _0x8b24e9){for(const _0xcc9330 of _0x4b6663[_0x47434e(0x172)](_0x225a1d)||[]){_0xcc9330[_0x47434e(0x179)]=package_component_dto_1['PackageComponentDto'][_0x47434e(0x178)](_0x471876);}}}else throw new veeva_error_1['VeevaError'](_0xccd84c['errors']);}async[a336_0xd453ab(0x15b)](_0x1efc41){const _0x2c42c9=a336_0xd453ab,_0x3ae3d9=await this['importVpk'](_0x1efc41),_0x44e27f=await this['getJobDetailUrl'](_0x3ae3d9),_0xe99e1f=await this[_0x2c42c9(0x182)](_0x44e27f),_0x25ee93=await this[_0x2c42c9(0x189)](_0xe99e1f[_0x2c42c9(0x18c)]),_0x2215bd=await this[_0x2c42c9(0x162)](_0x25ee93);return this['getDeployDetailsAndSaveLog'](_0x2215bd,_0xe99e1f);}}exports['PackageImportService']=PackageImportService;