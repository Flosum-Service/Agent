const a359_0x2a65b8=a359_0x430f;(function(_0xb469d6,_0xbd93a6){const _0x336564=a359_0x430f,_0x379490=_0xb469d6();while(!![]){try{const _0x5b629e=parseInt(_0x336564(0x1db))/0x1+-parseInt(_0x336564(0x1b2))/0x2+parseInt(_0x336564(0x1f8))/0x3+-parseInt(_0x336564(0x1b1))/0x4*(parseInt(_0x336564(0x1cc))/0x5)+-parseInt(_0x336564(0x1bd))/0x6*(-parseInt(_0x336564(0x206))/0x7)+-parseInt(_0x336564(0x1c6))/0x8*(parseInt(_0x336564(0x1aa))/0x9)+parseInt(_0x336564(0x1e0))/0xa;if(_0x5b629e===_0xbd93a6)break;else _0x379490['push'](_0x379490['shift']());}catch(_0xb74050){_0x379490['push'](_0x379490['shift']());}}}(a359_0x3600,0x72c06));const a359_0x1113d1=(function(){let _0x1ed71b=!![];return function(_0x4a23cd,_0x4d04fc){const _0x1f3f52=_0x1ed71b?function(){const _0x4b2bd8=a359_0x430f;if(_0x4d04fc){const _0x588214=_0x4d04fc[_0x4b2bd8(0x1d0)](_0x4a23cd,arguments);return _0x4d04fc=null,_0x588214;}}:function(){};return _0x1ed71b=![],_0x1f3f52;};}()),a359_0x5b55ce=a359_0x1113d1(this,function(){const _0x41c1c5=a359_0x430f;return a359_0x5b55ce[_0x41c1c5(0x1ce)]()[_0x41c1c5(0x1e3)]('(((.+)+)+)+$')['toString']()[_0x41c1c5(0x1c9)](a359_0x5b55ce)[_0x41c1c5(0x1e3)]('(((.+)+)+)+$');});a359_0x5b55ce();'use strict';var __importDefault=this&&this[a359_0x2a65b8(0x1b5)]||function(_0x565ce4){const _0x2bb13e=a359_0x2a65b8;return _0x565ce4&&_0x565ce4[_0x2bb13e(0x1ff)]?_0x565ce4:{'default':_0x565ce4};};function a359_0x3600(){const _0x94b305=['get','Validation.log','formPackageComponentList','../classes/errors/veeva-error','VeevaPackageStatus','_connection','PackageImportService','PackageComponentDto','PackageDetailsDto','filter','DEPLOYED_WITH_WARNINGS','1478343EGyzaB','find','groupToMap','links','packageId','default','package_components','__esModule','filename','data','fillPackageDeploymentAction','form-data','log','packageComponentList','98KzSWgr','import','VERIFIED','VeevaResponseStatus','517698tPscUM','_saveLog','importVpk','../dtos/package-component.dto','put','getJobResult','text','4XCrMYS','203126bFSJCd','responseStatus','errors','__importDefault','SUCCESS','url','isDeployed','status','Get\x20validation\x20details.','Deploy\x20Log','Validation\x20Log','88890qCdypr','includes','getLogResultText','getJobDetailUrl','name__v','createReadStream','../utils/array.utils','deployment_status__v','replace','8KYaqGU','Package\x20not\x20verified','VeevaError','constructor','uniqueName','getDeployDetailsAndSaveLog','1479575PaQTQD','updateVeevaConnection','toString','artifacts','apply','map','Get\x20deploy\x20result','groupUniqueToMap','rel','endsWith','DEPLOYED','post','../constants/veeva.constants','ENDPOINT_VALIDATE_PACKAGE','length','145581NyHXpg','PackageComponentStatus','deployPackage','Deploy\x20package','file','792500tBnIBM','{package_id}','deploymentAction','search','VeevaConstants','getValidationDetailsAndSaveLog','Wait\x20Executing\x20job','reduce','append','convertDeploymentAction','_logger','_veevaService','href'];a359_0x3600=function(){return _0x94b305;};return a359_0x3600();}Object['defineProperty'](exports,a359_0x2a65b8(0x1ff),{'value':!![]}),exports[a359_0x2a65b8(0x1f3)]=void 0x0;const veeva_constants_1=require(a359_0x2a65b8(0x1d8)),status_enums_1=require('../enums/status.enums'),veeva_error_1=require(a359_0x2a65b8(0x1f0)),form_data_1=__importDefault(require(a359_0x2a65b8(0x203))),fs_1=require('fs'),veeva_auth_utils_1=require('../utils/veeva-auth.utils'),package_details_dto_1=require('../dtos/package-details.dto'),package_component_dto_1=require(a359_0x2a65b8(0x1ad)),array_utils_1=require(a359_0x2a65b8(0x1c3));class PackageImportService{constructor({veevaService:_0x2ddded,connection:_0x40e588,logger:_0x1f63b7,saveLog:_0xf3e9cc}){const _0x1997ca=a359_0x2a65b8;this[_0x1997ca(0x1eb)]=_0x2ddded,this[_0x1997ca(0x1f2)]=_0x40e588,this['_logger']=_0x1f63b7,this[_0x1997ca(0x1ab)]=_0xf3e9cc;}async[a359_0x2a65b8(0x1ac)](_0x1a9ac9,_0x4de5aa=0x1){const _0x475e80=a359_0x2a65b8;this['_logger'][_0x475e80(0x204)]('Import\x20package');const _0x1531bb=new form_data_1[(_0x475e80(0x1fd))]();_0x1531bb[_0x475e80(0x1e8)](_0x475e80(0x1df),(0x0,fs_1[_0x475e80(0x1c2)])(_0x1a9ac9));const _0x18d366=await this[_0x475e80(0x1f2)][_0x475e80(0x1ae)](veeva_constants_1[_0x475e80(0x1e4)]['ENDPOINT_EXPORT_IMPORT_PACKAGE'],_0x1531bb,{'headers':{'Content-Type':'multipart/form-data'}}),_0x471808=_0x18d366[_0x475e80(0x201)];if(_0x471808['responseStatus']===status_enums_1[_0x475e80(0x1a9)]['SUCCESS'])return _0x471808[_0x475e80(0x1b7)];else{if(_0x4de5aa>0x0)return await(0x0,veeva_auth_utils_1[_0x475e80(0x1cd)])(this['_connection']),await this['importVpk'](_0x1a9ac9,_0x4de5aa-0x1);throw new veeva_error_1['VeevaError'](_0x471808[_0x475e80(0x1b4)]);}}async[a359_0x2a65b8(0x1dd)](_0xcddb0b){const _0x23466b=a359_0x2a65b8;this['_logger'][_0x23466b(0x204)](_0x23466b(0x1de));const _0x2f8838=await this[_0x23466b(0x1f2)][_0x23466b(0x1d7)](veeva_constants_1['VeevaConstants']['ENDPOINT_DEPLOY_PACKAGE']['replace'](_0x23466b(0x1e1),_0xcddb0b)),_0x5077a8=await _0x2f8838['data'];if(_0x5077a8[_0x23466b(0x1b3)]===status_enums_1[_0x23466b(0x1a9)]['SUCCESS'])return _0x5077a8[_0x23466b(0x1b7)];else throw new veeva_error_1[(_0x23466b(0x1c8))](_0x5077a8['errors']);}async['getJobDetailUrl'](_0x2651f3){const _0x5a0cd3=a359_0x2a65b8;this[_0x5a0cd3(0x1ea)][_0x5a0cd3(0x204)](_0x5a0cd3(0x1e6));const [_0x25fde8]=await this[_0x5a0cd3(0x1eb)][_0x5a0cd3(0x1af)]([_0x2651f3]);return _0x25fde8[_0x5a0cd3(0x1fb)][_0x5a0cd3(0x1f9)](_0x13d764=>_0x13d764[_0x5a0cd3(0x1d4)]===_0x5a0cd3(0x1cf))[_0x5a0cd3(0x1ec)];}async[a359_0x2a65b8(0x1e5)](_0xf9f9ce){const _0x46859b=a359_0x2a65b8;this[_0x46859b(0x1ea)][_0x46859b(0x204)](_0x46859b(0x1ba));const {data:_0x9e3d8b}=await this[_0x46859b(0x1f2)][_0x46859b(0x1ed)](_0xf9f9ce);if(_0x9e3d8b[_0x46859b(0x1b3)]===status_enums_1['VeevaResponseStatus']['SUCCESS']){const _0x44552a=new package_details_dto_1[(_0x46859b(0x1f5))](),{log:_0x3586e3,id:_0x1aeb93,package_status:_0x34320a,package_steps:_0x431654}=_0x9e3d8b['vaultPackage'],_0x1b963f=_0x3586e3[_0x46859b(0x1f6)](_0x40b488=>_0x40b488[_0x46859b(0x200)][_0x46859b(0x1d5)](_0x46859b(0x1ee))),_0x5f53bc=await this['getLogResultText'](_0x1b963f[0x0][_0x46859b(0x1b7)]);await this[_0x46859b(0x1ab)](_0x5f53bc,_0x46859b(0x1bc)),_0x44552a['packageId']=_0x1aeb93,_0x44552a[_0x46859b(0x205)]=this['formPackageComponentList'](_0x431654),await this[_0x46859b(0x202)](_0x44552a);if(_0x34320a!==status_enums_1[_0x46859b(0x1f1)][_0x46859b(0x1a8)])throw new Error(_0x46859b(0x1c7));return _0x44552a;}else throw new veeva_error_1[(_0x46859b(0x1c8))](_0x9e3d8b['errors']);}async['getDeployDetailsAndSaveLog'](_0x5025cb,_0x53535d){const _0x32535c=a359_0x2a65b8;var _0x3e0dfc;this[_0x32535c(0x1ea)][_0x32535c(0x204)](_0x32535c(0x1d2));const {data:_0x45e102}=await this[_0x32535c(0x1f2)]['get'](_0x5025cb);if(_0x45e102['responseStatus']===status_enums_1[_0x32535c(0x1a9)][_0x32535c(0x1b6)]){const {responseDetails:{deployment_log:_0x39a0df,package_status__v:_0x525324},package_steps:_0x393d1e}=_0x45e102,_0x1f6559=_0x39a0df[_0x32535c(0x1f6)](_0x97dac5=>_0x97dac5['filename'][_0x32535c(0x1d5)]('Deployment.log')),_0xb21818=await this['getLogResultText'](_0x1f6559[0x0][_0x32535c(0x1b7)]);await this[_0x32535c(0x1ab)](_0xb21818,_0x32535c(0x1bb)),_0x53535d[_0x32535c(0x1b8)]=[status_enums_1[_0x32535c(0x1f1)][_0x32535c(0x1d6)],status_enums_1[_0x32535c(0x1f1)][_0x32535c(0x1f7)]][_0x32535c(0x1be)](_0x525324);const _0x555ee5=array_utils_1['ArrayUtils'][_0x32535c(0x1d3)](this[_0x32535c(0x1ef)](_0x393d1e),({uniqueName:_0x207add})=>_0x207add);for(const _0xebc8ea of _0x53535d[_0x32535c(0x205)]){const _0x270755=(_0x3e0dfc=_0x555ee5[_0x32535c(0x1ed)](_0xebc8ea[_0x32535c(0x1ca)]))===null||_0x3e0dfc===void 0x0?void 0x0:_0x3e0dfc[_0x32535c(0x1b9)];_0x270755&&(_0xebc8ea[_0x32535c(0x1b9)]=_0x270755);}_0x53535d['packageComponentList']=_0x53535d[_0x32535c(0x205)][_0x32535c(0x1f6)](_0x397fa0=>_0x397fa0[_0x32535c(0x1b9)]!==status_enums_1[_0x32535c(0x1dc)][_0x32535c(0x1a8)]);if(!_0x53535d[_0x32535c(0x205)][_0x32535c(0x1da)])throw new Error('Cannot\x20find\x20deployment\x20results');return _0x53535d;}else throw new veeva_error_1[(_0x32535c(0x1c8))](_0x45e102[_0x32535c(0x1b4)]);}async[a359_0x2a65b8(0x1bf)](_0x327fe2){const _0x476763=a359_0x2a65b8,{data:_0xa2611b}=await this[_0x476763(0x1f2)][_0x476763(0x1ed)](_0x327fe2,{'responseType':_0x476763(0x1b0)});return _0xa2611b;}['formPackageComponentList'](_0x15e90d){const _0x10987e=a359_0x2a65b8;return _0x15e90d[_0x10987e(0x1e7)]((_0xfc258c,_0x30c308)=>{const _0xfab9f1=_0x10987e,_0x4a5878=_0x30c308[_0xfab9f1(0x1fe)][_0xfab9f1(0x1d1)](_0x411998=>new package_component_dto_1[(_0xfab9f1(0x1f4))]({'status':_0x30c308[_0xfab9f1(0x1c4)],'stepName':_0x30c308[_0xfab9f1(0x1c1)],'component':_0x411998}));return[..._0xfc258c,..._0x4a5878];},[]);}async['fillPackageDeploymentAction'](_0x1ba28a){const _0x528d40=a359_0x2a65b8,{data:_0x5e99a6}=await this[_0x528d40(0x1f2)][_0x528d40(0x1d7)](veeva_constants_1[_0x528d40(0x1e4)][_0x528d40(0x1d9)][_0x528d40(0x1c5)](_0x528d40(0x1e1),_0x1ba28a[_0x528d40(0x1fc)]));if(_0x5e99a6[_0x528d40(0x1b3)]===status_enums_1['VeevaResponseStatus'][_0x528d40(0x1b6)]){const {package_steps:_0x5b28a7}=_0x5e99a6['responseDetails'],_0x3deeb9=array_utils_1['ArrayUtils'][_0x528d40(0x1fa)](_0x1ba28a['packageComponentList'],({stepName:_0x42d819})=>_0x42d819);for(const {name__v:_0x3c1fc0,deployment_action:_0x5e2608}of _0x5b28a7){for(const _0x58ec45 of _0x3deeb9['get'](_0x3c1fc0)||[]){_0x58ec45[_0x528d40(0x1e2)]=package_component_dto_1[_0x528d40(0x1f4)][_0x528d40(0x1e9)](_0x5e2608);}}}else throw new veeva_error_1[(_0x528d40(0x1c8))](_0x5e99a6[_0x528d40(0x1b4)]);}async[a359_0x2a65b8(0x207)](_0x8dbea7){const _0x2eaa11=a359_0x2a65b8,_0x3f5b1e=await this[_0x2eaa11(0x1ac)](_0x8dbea7),_0x5e63c9=await this[_0x2eaa11(0x1c0)](_0x3f5b1e),_0x760093=await this['getValidationDetailsAndSaveLog'](_0x5e63c9),_0x460495=await this[_0x2eaa11(0x1dd)](_0x760093[_0x2eaa11(0x1fc)]),_0xf3459e=await this[_0x2eaa11(0x1c0)](_0x460495);return this[_0x2eaa11(0x1cb)](_0xf3459e,_0x760093);}}function a359_0x430f(_0xb96dc2,_0x7687e9){const _0x35f1bf=a359_0x3600();return a359_0x430f=function(_0x5b55ce,_0x1113d1){_0x5b55ce=_0x5b55ce-0x1a8;let _0x3600ee=_0x35f1bf[_0x5b55ce];return _0x3600ee;},a359_0x430f(_0xb96dc2,_0x7687e9);}exports['PackageImportService']=PackageImportService;