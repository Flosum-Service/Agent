const a392_0x28b1c0=a392_0xeb2e;function a392_0x10f7(){const _0x1b3467=['VeevaConstants','633024OZqWeo','4rJPtBy','packageComponentList','Cannot\x20find\x20deployment\x20results','default','artifacts','package_components','(((.+)+)+)+$','Deploy\x20package','DEPLOYED_WITH_WARNINGS','{package_id}','endsWith','2170016qYtjNL','296397GNzXXc','_veevaService','__esModule','_saveLog','getJobDetailUrl','file','errors','convertDeploymentAction','data','fillPackageDeploymentAction','Validation\x20Log','4120095fJAoOZ','12EKtfwC','responseDetails','Wait\x20Executing\x20job','3880xrnVnz','SUCCESS','includes','deployPackage','_logger','formPackageComponentList','13266HQporr','ENDPOINT_VALIDATE_PACKAGE','apply','__importDefault','PackageImportService','get','VERIFIED','packageId','getDeployDetailsAndSaveLog','createReadStream','Validation.log','DEPLOYED','VeevaPackageStatus','href','groupToMap','VeevaError','ENDPOINT_EXPORT_IMPORT_PACKAGE','347120EzANyI','filter','import','ENDPOINT_DEPLOY_PACKAGE','defineProperty','PackageComponentStatus','toString','707340lyoWHG','updateVeevaConnection','responseStatus','isDeployed','status','name__v','../dtos/package-details.dto','uniqueName','importVpk','deployment_status__v','PackageComponentDto','constructor','append','VeevaResponseStatus','getLogResultText','text','_connection','replace','Deploy\x20Log','log','groupUniqueToMap','url','deploymentAction','filename','find','ArrayUtils','Get\x20validation\x20details.','search','../dtos/package-component.dto','multipart/form-data','PackageDetailsDto','post'];a392_0x10f7=function(){return _0x1b3467;};return a392_0x10f7();}(function(_0x3e11d5,_0x4f8995){const _0x14ddd7=a392_0xeb2e,_0x13d830=_0x3e11d5();while(!![]){try{const _0x2cb38a=parseInt(_0x14ddd7(0x14d))/0x1+parseInt(_0x14ddd7(0x166))/0x2*(-parseInt(_0x14ddd7(0x15a))/0x3)+parseInt(_0x14ddd7(0x14e))/0x4*(-parseInt(_0x14ddd7(0x180))/0x5)+parseInt(_0x14ddd7(0x187))/0x6+-parseInt(_0x14ddd7(0x165))/0x7+parseInt(_0x14ddd7(0x159))/0x8+-parseInt(_0x14ddd7(0x16f))/0x9*(-parseInt(_0x14ddd7(0x169))/0xa);if(_0x2cb38a===_0x4f8995)break;else _0x13d830['push'](_0x13d830['shift']());}catch(_0x2c2a71){_0x13d830['push'](_0x13d830['shift']());}}}(a392_0x10f7,0x53ceb));function a392_0xeb2e(_0x550d3e,_0x45f4a9){const _0x59036d=a392_0x10f7();return a392_0xeb2e=function(_0x7f1f47,_0x5d7093){_0x7f1f47=_0x7f1f47-0x146;let _0x10f752=_0x59036d[_0x7f1f47];return _0x10f752;},a392_0xeb2e(_0x550d3e,_0x45f4a9);}const a392_0x5d7093=(function(){let _0x50334a=!![];return function(_0xfa3797,_0x33c1dd){const _0x25b3b5=_0x50334a?function(){const _0x308ab2=a392_0xeb2e;if(_0x33c1dd){const _0x117beb=_0x33c1dd[_0x308ab2(0x171)](_0xfa3797,arguments);return _0x33c1dd=null,_0x117beb;}}:function(){};return _0x50334a=![],_0x25b3b5;};}()),a392_0x7f1f47=a392_0x5d7093(this,function(){const _0x243005=a392_0xeb2e;return a392_0x7f1f47[_0x243005(0x186)]()[_0x243005(0x147)](_0x243005(0x154))[_0x243005(0x186)]()[_0x243005(0x192)](a392_0x7f1f47)[_0x243005(0x147)](_0x243005(0x154));});a392_0x7f1f47();'use strict';var __importDefault=this&&this[a392_0x28b1c0(0x172)]||function(_0x5eaa15){const _0x8d2d6a=a392_0x28b1c0;return _0x5eaa15&&_0x5eaa15[_0x8d2d6a(0x15c)]?_0x5eaa15:{'default':_0x5eaa15};};Object[a392_0x28b1c0(0x184)](exports,'__esModule',{'value':!![]}),exports[a392_0x28b1c0(0x173)]=void 0x0;const veeva_constants_1=require('../constants/veeva.constants'),status_enums_1=require('../enums/status.enums'),veeva_error_1=require('../classes/errors/veeva-error'),form_data_1=__importDefault(require('form-data')),fs_1=require('fs'),veeva_auth_utils_1=require('../utils/veeva-auth.utils'),package_details_dto_1=require(a392_0x28b1c0(0x18d)),package_component_dto_1=require(a392_0x28b1c0(0x148)),array_utils_1=require('../utils/array.utils');class PackageImportService{constructor({veevaService:_0xb7d2b2,connection:_0x24cd01,logger:_0x358c0,saveLog:_0x3bdb71}){const _0x520e1c=a392_0x28b1c0;this['_veevaService']=_0xb7d2b2,this[_0x520e1c(0x197)]=_0x24cd01,this[_0x520e1c(0x16d)]=_0x358c0,this['_saveLog']=_0x3bdb71;}async[a392_0x28b1c0(0x18f)](_0x54f789,_0x18fe46=0x1){const _0x5e2f21=a392_0x28b1c0;this['_logger']['log']('Import\x20package');const _0x11dc7b=new form_data_1[(_0x5e2f21(0x151))]();_0x11dc7b[_0x5e2f21(0x193)](_0x5e2f21(0x15f),(0x0,fs_1[_0x5e2f21(0x178)])(_0x54f789));const _0x29e77a=await this[_0x5e2f21(0x197)]['put'](veeva_constants_1[_0x5e2f21(0x14c)][_0x5e2f21(0x17f)],_0x11dc7b,{'headers':{'Content-Type':_0x5e2f21(0x149)}}),_0x4f923c=_0x29e77a[_0x5e2f21(0x162)];if(_0x4f923c[_0x5e2f21(0x189)]===status_enums_1['VeevaResponseStatus']['SUCCESS'])return _0x4f923c[_0x5e2f21(0x19c)];else{if(_0x18fe46>0x0)return await(0x0,veeva_auth_utils_1[_0x5e2f21(0x188)])(this['_connection']),await this[_0x5e2f21(0x18f)](_0x54f789,_0x18fe46-0x1);throw new veeva_error_1[(_0x5e2f21(0x17e))](_0x4f923c['errors']);}}async[a392_0x28b1c0(0x16c)](_0x5b2914){const _0x38a949=a392_0x28b1c0;this['_logger'][_0x38a949(0x19a)](_0x38a949(0x155));const _0x2ce819=await this['_connection'][_0x38a949(0x14b)](veeva_constants_1[_0x38a949(0x14c)][_0x38a949(0x183)][_0x38a949(0x198)](_0x38a949(0x157),_0x5b2914)),_0x5c6a42=await _0x2ce819['data'];if(_0x5c6a42[_0x38a949(0x189)]===status_enums_1[_0x38a949(0x194)][_0x38a949(0x16a)])return _0x5c6a42['url'];else throw new veeva_error_1['VeevaError'](_0x5c6a42[_0x38a949(0x160)]);}async[a392_0x28b1c0(0x15e)](_0x4ded9a){const _0x444c91=a392_0x28b1c0;this[_0x444c91(0x16d)]['log'](_0x444c91(0x168));const [_0xa730d]=await this[_0x444c91(0x15b)]['getJobResult']([_0x4ded9a]);return _0xa730d['links'][_0x444c91(0x19f)](_0x2ab733=>_0x2ab733['rel']===_0x444c91(0x152))[_0x444c91(0x17c)];}async['getValidationDetailsAndSaveLog'](_0x443f8a){const _0x4fe8d2=a392_0x28b1c0;this[_0x4fe8d2(0x16d)]['log'](_0x4fe8d2(0x146));const {data:_0x4b9871}=await this[_0x4fe8d2(0x197)]['get'](_0x443f8a);if(_0x4b9871['responseStatus']===status_enums_1['VeevaResponseStatus'][_0x4fe8d2(0x16a)]){const _0x2c4077=new package_details_dto_1[(_0x4fe8d2(0x14a))](),{log:_0x3dea35,id:_0x17817c,package_status:_0x3f458d,package_steps:_0x32a9a9}=_0x4b9871['vaultPackage'],_0x20fcbc=_0x3dea35[_0x4fe8d2(0x181)](_0x1f4afb=>_0x1f4afb[_0x4fe8d2(0x19e)][_0x4fe8d2(0x158)](_0x4fe8d2(0x179))),_0x1e226a=await this[_0x4fe8d2(0x195)](_0x20fcbc[0x0][_0x4fe8d2(0x19c)]);await this['_saveLog'](_0x1e226a,_0x4fe8d2(0x164)),_0x2c4077[_0x4fe8d2(0x176)]=_0x17817c,_0x2c4077['packageComponentList']=this[_0x4fe8d2(0x16e)](_0x32a9a9),await this[_0x4fe8d2(0x163)](_0x2c4077);if(_0x3f458d!==status_enums_1[_0x4fe8d2(0x17b)]['VERIFIED'])throw new Error('Package\x20not\x20verified');return _0x2c4077;}else throw new veeva_error_1['VeevaError'](_0x4b9871[_0x4fe8d2(0x160)]);}async['getDeployDetailsAndSaveLog'](_0x1c8578,_0x29c26){const _0x41e9d8=a392_0x28b1c0;var _0xda5d57;this[_0x41e9d8(0x16d)][_0x41e9d8(0x19a)]('Get\x20deploy\x20result');const {data:_0x317bde}=await this[_0x41e9d8(0x197)][_0x41e9d8(0x174)](_0x1c8578);if(_0x317bde[_0x41e9d8(0x189)]===status_enums_1['VeevaResponseStatus']['SUCCESS']){const {responseDetails:{deployment_log:_0x31c544,package_status__v:_0x3fa787},package_steps:_0x339a37}=_0x317bde,_0x59ab27=_0x31c544[_0x41e9d8(0x181)](_0x2c3304=>_0x2c3304[_0x41e9d8(0x19e)][_0x41e9d8(0x158)]('Deployment.log')),_0x23f504=await this[_0x41e9d8(0x195)](_0x59ab27[0x0][_0x41e9d8(0x19c)]);await this[_0x41e9d8(0x15d)](_0x23f504,_0x41e9d8(0x199)),_0x29c26[_0x41e9d8(0x18a)]=[status_enums_1['VeevaPackageStatus'][_0x41e9d8(0x17a)],status_enums_1[_0x41e9d8(0x17b)][_0x41e9d8(0x156)]][_0x41e9d8(0x16b)](_0x3fa787);const _0x74e940=array_utils_1[_0x41e9d8(0x1a0)][_0x41e9d8(0x19b)](this[_0x41e9d8(0x16e)](_0x339a37),({uniqueName:_0xeaf9e7})=>_0xeaf9e7);for(const _0x3d1784 of _0x29c26[_0x41e9d8(0x14f)]){const _0x59264b=(_0xda5d57=_0x74e940[_0x41e9d8(0x174)](_0x3d1784[_0x41e9d8(0x18e)]))===null||_0xda5d57===void 0x0?void 0x0:_0xda5d57['status'];_0x59264b&&(_0x3d1784[_0x41e9d8(0x18b)]=_0x59264b);}_0x29c26[_0x41e9d8(0x14f)]=_0x29c26[_0x41e9d8(0x14f)][_0x41e9d8(0x181)](_0x222b7e=>_0x222b7e[_0x41e9d8(0x18b)]!==status_enums_1[_0x41e9d8(0x185)][_0x41e9d8(0x175)]);if(!_0x29c26[_0x41e9d8(0x14f)]['length'])throw new Error(_0x41e9d8(0x150));return _0x29c26;}else throw new veeva_error_1[(_0x41e9d8(0x17e))](_0x317bde[_0x41e9d8(0x160)]);}async[a392_0x28b1c0(0x195)](_0x3cce2e){const _0x2331b5=a392_0x28b1c0,{data:_0x124081}=await this['_connection'][_0x2331b5(0x174)](_0x3cce2e,{'responseType':_0x2331b5(0x196)});return _0x124081;}[a392_0x28b1c0(0x16e)](_0x34c19f){return _0x34c19f['reduce']((_0x4d4c9e,_0x5655cb)=>{const _0x3d7584=a392_0xeb2e,_0x2df285=_0x5655cb[_0x3d7584(0x153)]['map'](_0x8072ba=>new package_component_dto_1[(_0x3d7584(0x191))]({'status':_0x5655cb[_0x3d7584(0x190)],'stepName':_0x5655cb[_0x3d7584(0x18c)],'component':_0x8072ba}));return[..._0x4d4c9e,..._0x2df285];},[]);}async[a392_0x28b1c0(0x163)](_0x24c59d){const _0x5d5680=a392_0x28b1c0,{data:_0x1d21b6}=await this[_0x5d5680(0x197)][_0x5d5680(0x14b)](veeva_constants_1['VeevaConstants'][_0x5d5680(0x170)][_0x5d5680(0x198)](_0x5d5680(0x157),_0x24c59d[_0x5d5680(0x176)]));if(_0x1d21b6[_0x5d5680(0x189)]===status_enums_1[_0x5d5680(0x194)][_0x5d5680(0x16a)]){const {package_steps:_0xff8908}=_0x1d21b6[_0x5d5680(0x167)],_0x4738d6=array_utils_1['ArrayUtils'][_0x5d5680(0x17d)](_0x24c59d[_0x5d5680(0x14f)],({stepName:_0x29d535})=>_0x29d535);for(const {name__v:_0x38d3f5,deployment_action:_0x48fdca}of _0xff8908){for(const _0x5e96ba of _0x4738d6[_0x5d5680(0x174)](_0x38d3f5)||[]){_0x5e96ba[_0x5d5680(0x19d)]=package_component_dto_1[_0x5d5680(0x191)][_0x5d5680(0x161)](_0x48fdca);}}}else throw new veeva_error_1[(_0x5d5680(0x17e))](_0x1d21b6[_0x5d5680(0x160)]);}async[a392_0x28b1c0(0x182)](_0x450b2e){const _0x2cc119=a392_0x28b1c0,_0xd5756e=await this['importVpk'](_0x450b2e),_0x12e737=await this[_0x2cc119(0x15e)](_0xd5756e),_0x9f5c43=await this['getValidationDetailsAndSaveLog'](_0x12e737),_0x21b0e1=await this['deployPackage'](_0x9f5c43[_0x2cc119(0x176)]),_0x4bc6be=await this['getJobDetailUrl'](_0x21b0e1);return this[_0x2cc119(0x177)](_0x4bc6be,_0x9f5c43);}}exports['PackageImportService']=PackageImportService;