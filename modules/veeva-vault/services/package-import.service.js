const a375_0x66ff9=a375_0x5a03;(function(_0x199426,_0xab3d10){const _0x248d5c=a375_0x5a03,_0x225acf=_0x199426();while(!![]){try{const _0x448e48=parseInt(_0x248d5c(0x17a))/0x1+-parseInt(_0x248d5c(0x1a6))/0x2*(parseInt(_0x248d5c(0x196))/0x3)+-parseInt(_0x248d5c(0x1a9))/0x4*(parseInt(_0x248d5c(0x1b4))/0x5)+parseInt(_0x248d5c(0x1aa))/0x6*(-parseInt(_0x248d5c(0x1b8))/0x7)+-parseInt(_0x248d5c(0x18a))/0x8+-parseInt(_0x248d5c(0x18b))/0x9+parseInt(_0x248d5c(0x19d))/0xa;if(_0x448e48===_0xab3d10)break;else _0x225acf['push'](_0x225acf['shift']());}catch(_0x49adf9){_0x225acf['push'](_0x225acf['shift']());}}}(a375_0x7ebe,0xe7e52));const a375_0x5b4417=(function(){let _0x4140bd=!![];return function(_0x1c10c4,_0x31c1ee){const _0x294a7e=_0x4140bd?function(){const _0x49091d=a375_0x5a03;if(_0x31c1ee){const _0xb4110=_0x31c1ee[_0x49091d(0x1b1)](_0x1c10c4,arguments);return _0x31c1ee=null,_0xb4110;}}:function(){};return _0x4140bd=![],_0x294a7e;};}()),a375_0x851e0b=a375_0x5b4417(this,function(){const _0x2cae39=a375_0x5a03;return a375_0x851e0b[_0x2cae39(0x1b3)]()['search'](_0x2cae39(0x1c7))['toString']()[_0x2cae39(0x1ad)](a375_0x851e0b)['search'](_0x2cae39(0x1c7));});a375_0x851e0b();'use strict';var __importDefault=this&&this[a375_0x66ff9(0x195)]||function(_0x291637){return _0x291637&&_0x291637['__esModule']?_0x291637:{'default':_0x291637};};Object[a375_0x66ff9(0x19c)](exports,a375_0x66ff9(0x18e),{'value':!![]}),exports[a375_0x66ff9(0x177)]=void 0x0;const veeva_constants_1=require(a375_0x66ff9(0x18c)),status_enums_1=require(a375_0x66ff9(0x178)),veeva_error_1=require('../classes/errors/veeva-error'),form_data_1=__importDefault(require('form-data')),fs_1=require('fs'),veeva_auth_utils_1=require(a375_0x66ff9(0x17d)),package_details_dto_1=require(a375_0x66ff9(0x1a2)),package_component_dto_1=require(a375_0x66ff9(0x179)),array_utils_1=require(a375_0x66ff9(0x1b5));function a375_0x7ebe(){const _0x260ce6=['VeevaResponseStatus','SUCCESS','../utils/veeva-auth.utils','fillPackageDeploymentAction','getLogResultText','VeevaPackageStatus','getJobDetailUrl','DEPLOYED_WITH_WARNINGS','PackageComponentDto','find','Cannot\x20find\x20deployment\x20results','get','groupUniqueToMap','_connection','package_components','7641040irGDhs','16377822kVVDXN','../constants/veeva.constants','getValidationDetailsAndSaveLog','__esModule','url','getDeployDetailsAndSaveLog','Deployment.log','log','uniqueName','packageComponentList','__importDefault','898932UYDfJL','post','groupToMap','status','VeevaConstants','packageId','defineProperty','46966070kINGmA','rel','Package\x20not\x20verified','append','artifacts','../dtos/package-details.dto','ArrayUtils','data','import','6PeQZYF','vaultPackage','VERIFIED','1459760txxZkb','48WWlmYS','replace','default','constructor','multipart/form-data','deploymentAction','includes','apply','filename','toString','5qEVYYv','../utils/array.utils','{package_id}','name__v','825405NFMCdG','_veevaService','_saveLog','Import\x20package','_logger','put','Get\x20validation\x20details.','deployment_status__v','errors','endsWith','filter','deployPackage','convertDeploymentAction','importVpk','formPackageComponentList','(((.+)+)+)+$','getJobResult','Validation\x20Log','map','Deploy\x20Log','reduce','ENDPOINT_EXPORT_IMPORT_PACKAGE','VeevaError','Deploy\x20package','responseStatus','DEPLOYED','PackageImportService','../enums/status.enums','../dtos/package-component.dto','1235315OSpxtw'];a375_0x7ebe=function(){return _0x260ce6;};return a375_0x7ebe();}class PackageImportService{constructor({veevaService:_0x4ff7a9,connection:_0x3e5d73,logger:_0x370082,saveLog:_0x5e9072}){const _0x360e87=a375_0x66ff9;this[_0x360e87(0x1b9)]=_0x4ff7a9,this[_0x360e87(0x188)]=_0x3e5d73,this[_0x360e87(0x1bc)]=_0x370082,this[_0x360e87(0x1ba)]=_0x5e9072;}async[a375_0x66ff9(0x1c5)](_0x346ba2,_0x40b841=0x1){const _0x12071f=a375_0x66ff9;this['_logger'][_0x12071f(0x192)](_0x12071f(0x1bb));const _0x1bd10b=new form_data_1[(_0x12071f(0x1ac))]();_0x1bd10b[_0x12071f(0x1a0)]('file',(0x0,fs_1['createReadStream'])(_0x346ba2));const _0x2173df=await this[_0x12071f(0x188)][_0x12071f(0x1bd)](veeva_constants_1[_0x12071f(0x19a)][_0x12071f(0x172)],_0x1bd10b,{'headers':{'Content-Type':_0x12071f(0x1ae)}}),_0x3ade20=_0x2173df[_0x12071f(0x1a4)];if(_0x3ade20['responseStatus']===status_enums_1[_0x12071f(0x17b)][_0x12071f(0x17c)])return _0x3ade20[_0x12071f(0x18f)];else{if(_0x40b841>0x0)return await(0x0,veeva_auth_utils_1['updateVeevaConnection'])(this[_0x12071f(0x188)]),await this[_0x12071f(0x1c5)](_0x346ba2,_0x40b841-0x1);throw new veeva_error_1[(_0x12071f(0x173))](_0x3ade20[_0x12071f(0x1c0)]);}}async[a375_0x66ff9(0x1c3)](_0x3c6c88){const _0xd02a1c=a375_0x66ff9;this[_0xd02a1c(0x1bc)][_0xd02a1c(0x192)](_0xd02a1c(0x174));const _0x25034b=await this['_connection']['post'](veeva_constants_1['VeevaConstants']['ENDPOINT_DEPLOY_PACKAGE'][_0xd02a1c(0x1ab)]('{package_id}',_0x3c6c88)),_0x5df8c6=await _0x25034b[_0xd02a1c(0x1a4)];if(_0x5df8c6['responseStatus']===status_enums_1['VeevaResponseStatus']['SUCCESS'])return _0x5df8c6[_0xd02a1c(0x18f)];else throw new veeva_error_1[(_0xd02a1c(0x173))](_0x5df8c6[_0xd02a1c(0x1c0)]);}async[a375_0x66ff9(0x181)](_0x3b3d12){const _0x467eef=a375_0x66ff9;this['_logger'][_0x467eef(0x192)]('Wait\x20Executing\x20job');const [_0x409192]=await this['_veevaService'][_0x467eef(0x1c8)]([_0x3b3d12]);return _0x409192['links'][_0x467eef(0x184)](_0x19a5d1=>_0x19a5d1[_0x467eef(0x19e)]===_0x467eef(0x1a1))['href'];}async[a375_0x66ff9(0x18d)](_0x159c23){const _0x1beaf8=a375_0x66ff9;this[_0x1beaf8(0x1bc)][_0x1beaf8(0x192)](_0x1beaf8(0x1be));const {data:_0x46e30a}=await this[_0x1beaf8(0x188)][_0x1beaf8(0x186)](_0x159c23);if(_0x46e30a[_0x1beaf8(0x175)]===status_enums_1[_0x1beaf8(0x17b)]['SUCCESS']){const _0x2c2940=new package_details_dto_1['PackageDetailsDto'](),{log:_0x422428,id:_0x1b3c2b,package_status:_0x3b8799,package_steps:_0x1746fd}=_0x46e30a[_0x1beaf8(0x1a7)],_0x2a9b39=_0x422428[_0x1beaf8(0x1c2)](_0x33299f=>_0x33299f[_0x1beaf8(0x1b2)][_0x1beaf8(0x1c1)]('Validation.log')),_0x45b84c=await this[_0x1beaf8(0x17f)](_0x2a9b39[0x0][_0x1beaf8(0x18f)]);await this[_0x1beaf8(0x1ba)](_0x45b84c,_0x1beaf8(0x1c9)),_0x2c2940[_0x1beaf8(0x19b)]=_0x1b3c2b,_0x2c2940[_0x1beaf8(0x194)]=this[_0x1beaf8(0x1c6)](_0x1746fd),await this['fillPackageDeploymentAction'](_0x2c2940);if(_0x3b8799!==status_enums_1[_0x1beaf8(0x180)]['VERIFIED'])throw new Error(_0x1beaf8(0x19f));return _0x2c2940;}else throw new veeva_error_1['VeevaError'](_0x46e30a[_0x1beaf8(0x1c0)]);}async[a375_0x66ff9(0x190)](_0x5856cc,_0x3b7af1){const _0x459979=a375_0x66ff9;var _0x2abf9c;this['_logger']['log']('Get\x20deploy\x20result');const {data:_0x56ae43}=await this[_0x459979(0x188)][_0x459979(0x186)](_0x5856cc);if(_0x56ae43[_0x459979(0x175)]===status_enums_1[_0x459979(0x17b)][_0x459979(0x17c)]){const {responseDetails:{deployment_log:_0x33ebf2,package_status__v:_0x177dd7},package_steps:_0x9944fa}=_0x56ae43,_0x184ef4=_0x33ebf2[_0x459979(0x1c2)](_0x136858=>_0x136858[_0x459979(0x1b2)][_0x459979(0x1c1)](_0x459979(0x191))),_0x54239b=await this[_0x459979(0x17f)](_0x184ef4[0x0][_0x459979(0x18f)]);await this['_saveLog'](_0x54239b,_0x459979(0x1cb)),_0x3b7af1['isDeployed']=[status_enums_1['VeevaPackageStatus'][_0x459979(0x176)],status_enums_1[_0x459979(0x180)][_0x459979(0x182)]][_0x459979(0x1b0)](_0x177dd7);const _0xebc918=array_utils_1[_0x459979(0x1a3)][_0x459979(0x187)](this[_0x459979(0x1c6)](_0x9944fa),({uniqueName:_0x554c37})=>_0x554c37);for(const _0xbf677a of _0x3b7af1[_0x459979(0x194)]){const _0x439fac=(_0x2abf9c=_0xebc918['get'](_0xbf677a[_0x459979(0x193)]))===null||_0x2abf9c===void 0x0?void 0x0:_0x2abf9c[_0x459979(0x199)];_0x439fac&&(_0xbf677a[_0x459979(0x199)]=_0x439fac);}_0x3b7af1[_0x459979(0x194)]=_0x3b7af1[_0x459979(0x194)][_0x459979(0x1c2)](_0x3eee7e=>_0x3eee7e['status']!==status_enums_1['PackageComponentStatus'][_0x459979(0x1a8)]);if(!_0x3b7af1['packageComponentList']['length'])throw new Error(_0x459979(0x185));return _0x3b7af1;}else throw new veeva_error_1[(_0x459979(0x173))](_0x56ae43['errors']);}async[a375_0x66ff9(0x17f)](_0x4d5ecd){const _0x14f08e=a375_0x66ff9,{data:_0x25d319}=await this[_0x14f08e(0x188)]['get'](_0x4d5ecd,{'responseType':'text'});return _0x25d319;}[a375_0x66ff9(0x1c6)](_0x435f43){const _0x10f61d=a375_0x66ff9;return _0x435f43[_0x10f61d(0x1cc)]((_0x2a4985,_0x273f7b)=>{const _0x550c04=_0x10f61d,_0x132a4a=_0x273f7b[_0x550c04(0x189)][_0x550c04(0x1ca)](_0x193629=>new package_component_dto_1[(_0x550c04(0x183))]({'status':_0x273f7b[_0x550c04(0x1bf)],'stepName':_0x273f7b[_0x550c04(0x1b7)],'component':_0x193629}));return[..._0x2a4985,..._0x132a4a];},[]);}async[a375_0x66ff9(0x17e)](_0x15db66){const _0x5a8dfc=a375_0x66ff9,{data:_0x44877e}=await this[_0x5a8dfc(0x188)][_0x5a8dfc(0x197)](veeva_constants_1[_0x5a8dfc(0x19a)]['ENDPOINT_VALIDATE_PACKAGE'][_0x5a8dfc(0x1ab)](_0x5a8dfc(0x1b6),_0x15db66[_0x5a8dfc(0x19b)]));if(_0x44877e['responseStatus']===status_enums_1[_0x5a8dfc(0x17b)][_0x5a8dfc(0x17c)]){const {package_steps:_0x419f7d}=_0x44877e['responseDetails'],_0x2f2766=array_utils_1[_0x5a8dfc(0x1a3)][_0x5a8dfc(0x198)](_0x15db66[_0x5a8dfc(0x194)],({stepName:_0x519458})=>_0x519458);for(const {name__v:_0x72358a,deployment_action:_0x6ad9b6}of _0x419f7d){for(const _0x2f1e07 of _0x2f2766[_0x5a8dfc(0x186)](_0x72358a)||[]){_0x2f1e07[_0x5a8dfc(0x1af)]=package_component_dto_1[_0x5a8dfc(0x183)][_0x5a8dfc(0x1c4)](_0x6ad9b6);}}}else throw new veeva_error_1[(_0x5a8dfc(0x173))](_0x44877e[_0x5a8dfc(0x1c0)]);}async[a375_0x66ff9(0x1a5)](_0x5ee097){const _0x224b6b=a375_0x66ff9,_0x4db178=await this['importVpk'](_0x5ee097),_0x213477=await this[_0x224b6b(0x181)](_0x4db178),_0x58f7d2=await this[_0x224b6b(0x18d)](_0x213477),_0xd7d563=await this[_0x224b6b(0x1c3)](_0x58f7d2[_0x224b6b(0x19b)]),_0x23f26f=await this[_0x224b6b(0x181)](_0xd7d563);return this[_0x224b6b(0x190)](_0x23f26f,_0x58f7d2);}}function a375_0x5a03(_0xa2b165,_0x444b48){const _0x1472d7=a375_0x7ebe();return a375_0x5a03=function(_0x851e0b,_0x5b4417){_0x851e0b=_0x851e0b-0x172;let _0x7ebe06=_0x1472d7[_0x851e0b];return _0x7ebe06;},a375_0x5a03(_0xa2b165,_0x444b48);}exports[a375_0x66ff9(0x177)]=PackageImportService;