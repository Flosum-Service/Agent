const a404_0x9a17ef=a404_0x44d0;function a404_0x44d0(_0x1ad8c9,_0x3fabf1){const _0x5e940c=a404_0x51de();return a404_0x44d0=function(_0x2641e9,_0x1d5a0c){_0x2641e9=_0x2641e9-0x178;let _0x51de90=_0x5e940c[_0x2641e9];return _0x51de90;},a404_0x44d0(_0x1ad8c9,_0x3fabf1);}(function(_0x3ab8fc,_0x275831){const _0x52a08d=a404_0x44d0,_0x30ec5e=_0x3ab8fc();while(!![]){try{const _0x4547ec=parseInt(_0x52a08d(0x190))/0x1*(-parseInt(_0x52a08d(0x1a4))/0x2)+-parseInt(_0x52a08d(0x184))/0x3+parseInt(_0x52a08d(0x181))/0x4+parseInt(_0x52a08d(0x198))/0x5+parseInt(_0x52a08d(0x1c5))/0x6+-parseInt(_0x52a08d(0x1b6))/0x7+parseInt(_0x52a08d(0x19b))/0x8;if(_0x4547ec===_0x275831)break;else _0x30ec5e['push'](_0x30ec5e['shift']());}catch(_0x28e027){_0x30ec5e['push'](_0x30ec5e['shift']());}}}(a404_0x51de,0xe33b4));const a404_0x1d5a0c=(function(){let _0x27e3ee=!![];return function(_0x27767a,_0x94e30f){const _0x57c54e=_0x27e3ee?function(){const _0x16b30f=a404_0x44d0;if(_0x94e30f){const _0x1ade5b=_0x94e30f[_0x16b30f(0x185)](_0x27767a,arguments);return _0x94e30f=null,_0x1ade5b;}}:function(){};return _0x27e3ee=![],_0x57c54e;};}()),a404_0x2641e9=a404_0x1d5a0c(this,function(){const _0x2662d7=a404_0x44d0;return a404_0x2641e9[_0x2662d7(0x195)]()['search'](_0x2662d7(0x188))['toString']()[_0x2662d7(0x187)](a404_0x2641e9)[_0x2662d7(0x1a2)](_0x2662d7(0x188));});a404_0x2641e9();'use strict';var __importDefault=this&&this[a404_0x9a17ef(0x1cb)]||function(_0x347714){const _0x11b746=a404_0x9a17ef;return _0x347714&&_0x347714[_0x11b746(0x1b7)]?_0x347714:{'default':_0x347714};};Object[a404_0x9a17ef(0x1a3)](exports,a404_0x9a17ef(0x1b7),{'value':!![]}),exports[a404_0x9a17ef(0x1bf)]=void 0x0;const veeva_constants_1=require(a404_0x9a17ef(0x1b0)),status_enums_1=require(a404_0x9a17ef(0x1bc)),veeva_error_1=require(a404_0x9a17ef(0x1b8)),form_data_1=__importDefault(require('form-data')),fs_1=require('fs'),veeva_auth_utils_1=require(a404_0x9a17ef(0x1c2)),package_details_dto_1=require('../dtos/package-details.dto'),package_component_dto_1=require('../dtos/package-component.dto'),array_utils_1=require(a404_0x9a17ef(0x182));class PackageImportService{constructor({veevaService:_0x28b565,connection:_0x2f7c46,logger:_0x2f3264,saveLog:_0x1e6f66}){const _0x866f8e=a404_0x9a17ef;this[_0x866f8e(0x199)]=_0x28b565,this[_0x866f8e(0x1b4)]=_0x2f7c46,this[_0x866f8e(0x1ba)]=_0x2f3264,this[_0x866f8e(0x1c1)]=_0x1e6f66;}async[a404_0x9a17ef(0x178)](_0x4b16f0,_0x291605=0x1){const _0x2d304c=a404_0x9a17ef;this['_logger']['log'](_0x2d304c(0x194));const _0x20f79c=new form_data_1['default']();_0x20f79c[_0x2d304c(0x17d)]('file',(0x0,fs_1[_0x2d304c(0x18b)])(_0x4b16f0));const _0x3bc05f=await this['_connection']['put'](veeva_constants_1['VeevaConstants']['ENDPOINT_EXPORT_IMPORT_PACKAGE'],_0x20f79c,{'headers':{'Content-Type':_0x2d304c(0x1cd)}}),_0x31828=_0x3bc05f[_0x2d304c(0x18e)];if(_0x31828[_0x2d304c(0x1c9)]===status_enums_1['VeevaResponseStatus']['SUCCESS'])return _0x31828['url'];else{if(_0x291605>0x0)return await(0x0,veeva_auth_utils_1[_0x2d304c(0x1ce)])(this[_0x2d304c(0x1b4)]),await this['importVpk'](_0x4b16f0,_0x291605-0x1);throw new veeva_error_1[(_0x2d304c(0x197))](_0x31828['errors']);}}async[a404_0x9a17ef(0x1af)](_0x53a802){const _0x546850=a404_0x9a17ef;this[_0x546850(0x1ba)][_0x546850(0x1b3)](_0x546850(0x1be));const _0x93f79e=await this[_0x546850(0x1b4)]['post'](veeva_constants_1[_0x546850(0x1cc)][_0x546850(0x1c7)][_0x546850(0x18a)]('{package_id}',_0x53a802)),_0x1f971c=await _0x93f79e[_0x546850(0x18e)];if(_0x1f971c['responseStatus']===status_enums_1[_0x546850(0x1a1)][_0x546850(0x1a7)])return _0x1f971c[_0x546850(0x1b1)];else throw new veeva_error_1[(_0x546850(0x197))](_0x1f971c[_0x546850(0x19a)]);}async[a404_0x9a17ef(0x18f)](_0x34d4ff){const _0x363689=a404_0x9a17ef;this[_0x363689(0x1ba)][_0x363689(0x1b3)](_0x363689(0x18c));const [_0x4300a0]=await this['_veevaService']['getJobResult']([_0x34d4ff]);return _0x4300a0['links'][_0x363689(0x17f)](_0x367026=>_0x367026[_0x363689(0x189)]==='artifacts')['href'];}async['getValidationDetailsAndSaveLog'](_0x15884e){const _0x1bcaed=a404_0x9a17ef;this['_logger'][_0x1bcaed(0x1b3)](_0x1bcaed(0x1c4));const {data:_0x1e839c}=await this[_0x1bcaed(0x1b4)]['get'](_0x15884e);if(_0x1e839c['responseStatus']===status_enums_1[_0x1bcaed(0x1a1)][_0x1bcaed(0x1a7)]){const _0x32df18=new package_details_dto_1[(_0x1bcaed(0x192))](),{log:_0x9c431d,id:_0x362820,package_status:_0x42e2fb,package_steps:_0x3b3968}=_0x1e839c[_0x1bcaed(0x193)],_0x151093=_0x9c431d[_0x1bcaed(0x1c8)](_0x5da180=>_0x5da180[_0x1bcaed(0x1c3)][_0x1bcaed(0x186)]('Validation.log')),_0x563912=await this[_0x1bcaed(0x17e)](_0x151093[0x0][_0x1bcaed(0x1b1)]);await this[_0x1bcaed(0x1c1)](_0x563912,_0x1bcaed(0x1bb)),_0x32df18[_0x1bcaed(0x191)]=_0x362820,_0x32df18[_0x1bcaed(0x1aa)]=this[_0x1bcaed(0x19c)](_0x3b3968),await this['fillPackageDeploymentAction'](_0x32df18);if(_0x42e2fb!==status_enums_1[_0x1bcaed(0x1ac)][_0x1bcaed(0x179)])throw new Error(_0x1bcaed(0x1ad));return _0x32df18;}else throw new veeva_error_1[(_0x1bcaed(0x197))](_0x1e839c['errors']);}async[a404_0x9a17ef(0x1a9)](_0x6f6396,_0x3d7ef5){const _0x4224ce=a404_0x9a17ef;var _0x40e0c7;this[_0x4224ce(0x1ba)][_0x4224ce(0x1b3)](_0x4224ce(0x1ca));const {data:_0x2068fa}=await this[_0x4224ce(0x1b4)][_0x4224ce(0x180)](_0x6f6396);if(_0x2068fa[_0x4224ce(0x1c9)]===status_enums_1['VeevaResponseStatus'][_0x4224ce(0x1a7)]){const {responseDetails:{deployment_log:_0x516427,package_status__v:_0x254de0},package_steps:_0x54198b}=_0x2068fa,_0x2c3917=_0x516427[_0x4224ce(0x1c8)](_0x56765c=>_0x56765c[_0x4224ce(0x1c3)][_0x4224ce(0x186)](_0x4224ce(0x1c6))),_0x38a4f3=await this[_0x4224ce(0x17e)](_0x2c3917[0x0][_0x4224ce(0x1b1)]);await this['_saveLog'](_0x38a4f3,_0x4224ce(0x1c0)),_0x3d7ef5[_0x4224ce(0x17a)]=[status_enums_1['VeevaPackageStatus']['DEPLOYED'],status_enums_1[_0x4224ce(0x1ac)]['DEPLOYED_WITH_WARNINGS']][_0x4224ce(0x1b5)](_0x254de0);const _0x1c924f=array_utils_1[_0x4224ce(0x1bd)][_0x4224ce(0x1a6)](this[_0x4224ce(0x19c)](_0x54198b),({uniqueName:_0x5f5cef})=>_0x5f5cef);for(const _0x3a91be of _0x3d7ef5[_0x4224ce(0x1aa)]){const _0x283eae=(_0x40e0c7=_0x1c924f['get'](_0x3a91be[_0x4224ce(0x196)]))===null||_0x40e0c7===void 0x0?void 0x0:_0x40e0c7[_0x4224ce(0x1ae)];_0x283eae&&(_0x3a91be[_0x4224ce(0x1ae)]=_0x283eae);}_0x3d7ef5[_0x4224ce(0x1aa)]=_0x3d7ef5[_0x4224ce(0x1aa)][_0x4224ce(0x1c8)](_0x3aff53=>_0x3aff53[_0x4224ce(0x1ae)]!==status_enums_1['PackageComponentStatus']['VERIFIED']);if(!_0x3d7ef5[_0x4224ce(0x1aa)][_0x4224ce(0x19e)])throw new Error('Cannot\x20find\x20deployment\x20results');return _0x3d7ef5;}else throw new veeva_error_1[(_0x4224ce(0x197))](_0x2068fa['errors']);}async[a404_0x9a17ef(0x17e)](_0x2f99f1){const _0x1fe505=a404_0x9a17ef,{data:_0x21b738}=await this[_0x1fe505(0x1b4)][_0x1fe505(0x180)](_0x2f99f1,{'responseType':_0x1fe505(0x1a8)});return _0x21b738;}[a404_0x9a17ef(0x19c)](_0x4d2fc5){const _0x7dc532=a404_0x9a17ef;return _0x4d2fc5[_0x7dc532(0x183)]((_0x1577b6,_0x293340)=>{const _0xabe633=_0x7dc532,_0x50a709=_0x293340[_0xabe633(0x1b2)][_0xabe633(0x17c)](_0x1c5d77=>new package_component_dto_1[(_0xabe633(0x1ab))]({'status':_0x293340[_0xabe633(0x1a5)],'stepName':_0x293340['name__v'],'component':_0x1c5d77}));return[..._0x1577b6,..._0x50a709];},[]);}async['fillPackageDeploymentAction'](_0x1f3ab2){const _0x335c1b=a404_0x9a17ef,{data:_0x590e37}=await this[_0x335c1b(0x1b4)]['post'](veeva_constants_1[_0x335c1b(0x1cc)][_0x335c1b(0x18d)][_0x335c1b(0x18a)]('{package_id}',_0x1f3ab2[_0x335c1b(0x191)]));if(_0x590e37[_0x335c1b(0x1c9)]===status_enums_1[_0x335c1b(0x1a1)]['SUCCESS']){const {package_steps:_0x44dbdf}=_0x590e37[_0x335c1b(0x1b9)],_0x5f3055=array_utils_1[_0x335c1b(0x1bd)][_0x335c1b(0x19d)](_0x1f3ab2[_0x335c1b(0x1aa)],({stepName:_0x5e3a03})=>_0x5e3a03);for(const {name__v:_0x56c6fe,deployment_action:_0x563255}of _0x44dbdf){for(const _0x16816f of _0x5f3055[_0x335c1b(0x180)](_0x56c6fe)||[]){_0x16816f[_0x335c1b(0x19f)]=package_component_dto_1[_0x335c1b(0x1ab)][_0x335c1b(0x17b)](_0x563255);}}}else throw new veeva_error_1[(_0x335c1b(0x197))](_0x590e37[_0x335c1b(0x19a)]);}async[a404_0x9a17ef(0x1a0)](_0x237690){const _0x1620ef=a404_0x9a17ef,_0x485b76=await this[_0x1620ef(0x178)](_0x237690),_0x55c0d7=await this[_0x1620ef(0x18f)](_0x485b76),_0xa2f82a=await this['getValidationDetailsAndSaveLog'](_0x55c0d7),_0x3196e0=await this[_0x1620ef(0x1af)](_0xa2f82a[_0x1620ef(0x191)]),_0x40d42b=await this['getJobDetailUrl'](_0x3196e0);return this['getDeployDetailsAndSaveLog'](_0x40d42b,_0xa2f82a);}}exports[a404_0x9a17ef(0x1bf)]=PackageImportService;function a404_0x51de(){const _0x409103=['includes','6783392nLZzuP','__esModule','../classes/errors/veeva-error','responseDetails','_logger','Validation\x20Log','../enums/status.enums','ArrayUtils','Deploy\x20package','PackageImportService','Deploy\x20Log','_saveLog','../utils/veeva-auth.utils','filename','Get\x20validation\x20details.','3689622MDofPp','Deployment.log','ENDPOINT_DEPLOY_PACKAGE','filter','responseStatus','Get\x20deploy\x20result','__importDefault','VeevaConstants','multipart/form-data','updateVeevaConnection','importVpk','VERIFIED','isDeployed','convertDeploymentAction','map','append','getLogResultText','find','get','406296jIUFBS','../utils/array.utils','reduce','5190243tuwTPv','apply','endsWith','constructor','(((.+)+)+)+$','rel','replace','createReadStream','Wait\x20Executing\x20job','ENDPOINT_VALIDATE_PACKAGE','data','getJobDetailUrl','1bGOVSc','packageId','PackageDetailsDto','vaultPackage','Import\x20package','toString','uniqueName','VeevaError','1848325skIHjN','_veevaService','errors','29840064tauyuY','formPackageComponentList','groupToMap','length','deploymentAction','import','VeevaResponseStatus','search','defineProperty','2372614bjwpZs','deployment_status__v','groupUniqueToMap','SUCCESS','text','getDeployDetailsAndSaveLog','packageComponentList','PackageComponentDto','VeevaPackageStatus','Package\x20not\x20verified','status','deployPackage','../constants/veeva.constants','url','package_components','log','_connection'];a404_0x51de=function(){return _0x409103;};return a404_0x51de();}