const a404_0x54a50f=a404_0xeac7;(function(_0x4ba48a,_0xe92dcc){const _0x2dd872=a404_0xeac7,_0x1880b0=_0x4ba48a();while(!![]){try{const _0x3e727e=-parseInt(_0x2dd872(0x8d))/0x1*(-parseInt(_0x2dd872(0xc1))/0x2)+-parseInt(_0x2dd872(0xbe))/0x3+-parseInt(_0x2dd872(0xc7))/0x4+-parseInt(_0x2dd872(0x6f))/0x5+parseInt(_0x2dd872(0x87))/0x6*(parseInt(_0x2dd872(0xb3))/0x7)+parseInt(_0x2dd872(0xc8))/0x8*(parseInt(_0x2dd872(0xb0))/0x9)+parseInt(_0x2dd872(0x98))/0xa;if(_0x3e727e===_0xe92dcc)break;else _0x1880b0['push'](_0x1880b0['shift']());}catch(_0x5473e9){_0x1880b0['push'](_0x1880b0['shift']());}}}(a404_0x309a,0x3c0da));const a404_0x4cdaa4=(function(){let _0x372a76=!![];return function(_0x1f989e,_0x466ead){const _0x5c839f=_0x372a76?function(){const _0x398935=a404_0xeac7;if(_0x466ead){const _0x187073=_0x466ead[_0x398935(0xb4)](_0x1f989e,arguments);return _0x466ead=null,_0x187073;}}:function(){};return _0x372a76=![],_0x5c839f;};}()),a404_0x263a8b=a404_0x4cdaa4(this,function(){const _0x455fad=a404_0xeac7;return a404_0x263a8b[_0x455fad(0xbb)]()[_0x455fad(0x94)](_0x455fad(0x75))['toString']()[_0x455fad(0xc9)](a404_0x263a8b)[_0x455fad(0x94)](_0x455fad(0x75));});a404_0x263a8b();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x22ddb7){return _0x22ddb7&&_0x22ddb7['__esModule']?_0x22ddb7:{'default':_0x22ddb7};};Object[a404_0x54a50f(0xae)](exports,a404_0x54a50f(0x9e),{'value':!![]}),exports['PackageImportService']=void 0x0;const veeva_constants_1=require('../constants/veeva.constants'),status_enums_1=require(a404_0x54a50f(0x8e)),veeva_error_1=require(a404_0x54a50f(0xa7)),form_data_1=__importDefault(require('form-data')),fs_1=require('fs'),veeva_auth_utils_1=require('../utils/veeva-auth.utils'),package_details_dto_1=require(a404_0x54a50f(0x8f)),package_component_dto_1=require('../dtos/package-component.dto'),array_utils_1=require(a404_0x54a50f(0xb8));class PackageImportService{constructor({veevaService:_0x4c2807,connection:_0x16809e,logger:_0x8e21ef,saveLog:_0x5509e6}){const _0x3bbcd8=a404_0x54a50f;this[_0x3bbcd8(0x91)]=_0x4c2807,this['_connection']=_0x16809e,this[_0x3bbcd8(0x9b)]=_0x8e21ef,this[_0x3bbcd8(0xb7)]=_0x5509e6;}async[a404_0x54a50f(0x9c)](_0x40dbf6,_0x2b22dd=0x1){const _0x1bfba6=a404_0x54a50f;this[_0x1bfba6(0x9b)]['log'](_0x1bfba6(0x77));const _0x40d034=new form_data_1['default']();_0x40d034[_0x1bfba6(0x78)](_0x1bfba6(0x71),(0x0,fs_1[_0x1bfba6(0xa5)])(_0x40dbf6));const _0x22cf49=await this['_connection'][_0x1bfba6(0x7a)](veeva_constants_1[_0x1bfba6(0x8b)][_0x1bfba6(0xb5)],_0x40d034,{'headers':{'Content-Type':_0x1bfba6(0xc6)}}),_0xcd77e7=_0x22cf49['data'];if(_0xcd77e7[_0x1bfba6(0x6e)]===status_enums_1['VeevaResponseStatus']['SUCCESS'])return _0xcd77e7[_0x1bfba6(0x80)];else{if(_0x2b22dd>0x0)return await(0x0,veeva_auth_utils_1[_0x1bfba6(0x73)])(this[_0x1bfba6(0xac)]),await this['importVpk'](_0x40dbf6,_0x2b22dd-0x1);throw new veeva_error_1[(_0x1bfba6(0x97))](_0xcd77e7[_0x1bfba6(0xa2)]);}}async[a404_0x54a50f(0x88)](_0x5e59b9){const _0x170331=a404_0x54a50f;this[_0x170331(0x9b)][_0x170331(0x7f)](_0x170331(0x82));const _0x5977a3=await this[_0x170331(0xac)][_0x170331(0xaf)](veeva_constants_1[_0x170331(0x8b)][_0x170331(0x7b)][_0x170331(0xa3)]('{package_id}',_0x5e59b9)),_0x1578b4=await _0x5977a3[_0x170331(0x86)];if(_0x1578b4[_0x170331(0x6e)]===status_enums_1['VeevaResponseStatus'][_0x170331(0x6d)])return _0x1578b4[_0x170331(0x80)];else throw new veeva_error_1['VeevaError'](_0x1578b4['errors']);}async['getJobDetailUrl'](_0x209380){const _0x65278b=a404_0x54a50f;this['_logger'][_0x65278b(0x7f)]('Wait\x20Executing\x20job');const [_0x28f3dc]=await this[_0x65278b(0x91)]['getJobResult']([_0x209380]);return _0x28f3dc['links'][_0x65278b(0xb1)](_0x2bfb76=>_0x2bfb76[_0x65278b(0x96)]===_0x65278b(0xa1))[_0x65278b(0x85)];}async['getValidationDetailsAndSaveLog'](_0x3e4267){const _0x387154=a404_0x54a50f;this[_0x387154(0x9b)][_0x387154(0x7f)](_0x387154(0x84));const {data:_0x270106}=await this[_0x387154(0xac)][_0x387154(0xc0)](_0x3e4267);if(_0x270106[_0x387154(0x6e)]===status_enums_1[_0x387154(0xa8)]['SUCCESS']){const _0x57046b=new package_details_dto_1[(_0x387154(0x7e))](),{log:_0x21a98f,id:_0x3dd0b0,package_status:_0x25dd58,package_steps:_0x590d27}=_0x270106['vaultPackage'],_0x4f1b51=_0x21a98f[_0x387154(0x79)](_0x5764b8=>_0x5764b8[_0x387154(0x92)][_0x387154(0x7d)](_0x387154(0x95))),_0x3a5df8=await this['getLogResultText'](_0x4f1b51[0x0][_0x387154(0x80)]);await this[_0x387154(0xb7)](_0x3a5df8,_0x387154(0xa0)),_0x57046b[_0x387154(0xbd)]=_0x3dd0b0,_0x57046b[_0x387154(0xad)]=this[_0x387154(0x7c)](_0x590d27),await this['fillPackageDeploymentAction'](_0x57046b);if(_0x25dd58!==status_enums_1['VeevaPackageStatus'][_0x387154(0x9a)])throw new Error('Package\x20not\x20verified');return _0x57046b;}else throw new veeva_error_1[(_0x387154(0x97))](_0x270106[_0x387154(0xa2)]);}async[a404_0x54a50f(0xa9)](_0x4f54df,_0x36c2e6){const _0x5bad3f=a404_0x54a50f;var _0x23c96a;this[_0x5bad3f(0x9b)][_0x5bad3f(0x7f)]('Get\x20deploy\x20result');const {data:_0x21daf9}=await this[_0x5bad3f(0xac)]['get'](_0x4f54df);if(_0x21daf9[_0x5bad3f(0x6e)]===status_enums_1[_0x5bad3f(0xa8)][_0x5bad3f(0x6d)]){const {responseDetails:{deployment_log:_0x50f9a6,package_status__v:_0x4ef811},package_steps:_0x1952d0}=_0x21daf9,_0x51bc17=_0x50f9a6[_0x5bad3f(0x79)](_0x12884f=>_0x12884f['filename'][_0x5bad3f(0x7d)](_0x5bad3f(0x8c))),_0x1bb1c7=await this['getLogResultText'](_0x51bc17[0x0][_0x5bad3f(0x80)]);await this['_saveLog'](_0x1bb1c7,_0x5bad3f(0x9f)),_0x36c2e6[_0x5bad3f(0x72)]=[status_enums_1[_0x5bad3f(0xc3)][_0x5bad3f(0x76)],status_enums_1['VeevaPackageStatus'][_0x5bad3f(0xc4)]][_0x5bad3f(0xaa)](_0x4ef811);const _0x33dc4b=array_utils_1['ArrayUtils']['groupUniqueToMap'](this['formPackageComponentList'](_0x1952d0),({uniqueName:_0x124648})=>_0x124648);for(const _0xf6db39 of _0x36c2e6[_0x5bad3f(0xad)]){const _0x342199=(_0x23c96a=_0x33dc4b[_0x5bad3f(0xc0)](_0xf6db39[_0x5bad3f(0xc5)]))===null||_0x23c96a===void 0x0?void 0x0:_0x23c96a[_0x5bad3f(0xa4)];_0x342199&&(_0xf6db39[_0x5bad3f(0xa4)]=_0x342199);}_0x36c2e6['packageComponentList']=_0x36c2e6[_0x5bad3f(0xad)][_0x5bad3f(0x79)](_0x4cc31a=>_0x4cc31a['status']!==status_enums_1['PackageComponentStatus'][_0x5bad3f(0x9a)]);if(!_0x36c2e6[_0x5bad3f(0xad)][_0x5bad3f(0x70)])throw new Error('Cannot\x20find\x20deployment\x20results');return _0x36c2e6;}else throw new veeva_error_1['VeevaError'](_0x21daf9[_0x5bad3f(0xa2)]);}async[a404_0x54a50f(0x99)](_0x35c4b3){const _0x3d3191=a404_0x54a50f,{data:_0x56329d}=await this['_connection'][_0x3d3191(0xc0)](_0x35c4b3,{'responseType':_0x3d3191(0x83)});return _0x56329d;}[a404_0x54a50f(0x7c)](_0x3cd984){const _0x4059e2=a404_0x54a50f;return _0x3cd984[_0x4059e2(0x90)]((_0x31d899,_0x31a9ef)=>{const _0x2ba855=_0x4059e2,_0x4749e9=_0x31a9ef[_0x2ba855(0xb6)][_0x2ba855(0xab)](_0x194ed8=>new package_component_dto_1[(_0x2ba855(0xc2))]({'status':_0x31a9ef[_0x2ba855(0xb2)],'stepName':_0x31a9ef[_0x2ba855(0xbf)],'component':_0x194ed8}));return[..._0x31d899,..._0x4749e9];},[]);}async[a404_0x54a50f(0xa6)](_0x4a2d4f){const _0x5b1db8=a404_0x54a50f,{data:_0x2aa27e}=await this[_0x5b1db8(0xac)][_0x5b1db8(0xaf)](veeva_constants_1['VeevaConstants'][_0x5b1db8(0xbc)][_0x5b1db8(0xa3)](_0x5b1db8(0x8a),_0x4a2d4f['packageId']));if(_0x2aa27e[_0x5b1db8(0x6e)]===status_enums_1['VeevaResponseStatus'][_0x5b1db8(0x6d)]){const {package_steps:_0x40789e}=_0x2aa27e[_0x5b1db8(0x89)],_0x12bea6=array_utils_1[_0x5b1db8(0x6c)][_0x5b1db8(0xba)](_0x4a2d4f['packageComponentList'],({stepName:_0x88d932})=>_0x88d932);for(const {name__v:_0x2348fe,deployment_action:_0x549ef4}of _0x40789e){for(const _0x64757a of _0x12bea6['get'](_0x2348fe)||[]){_0x64757a['deploymentAction']=package_component_dto_1[_0x5b1db8(0xc2)][_0x5b1db8(0x74)](_0x549ef4);}}}else throw new veeva_error_1[(_0x5b1db8(0x97))](_0x2aa27e[_0x5b1db8(0xa2)]);}async[a404_0x54a50f(0x9d)](_0x4ac96f){const _0x19cd21=a404_0x54a50f,_0x1d5932=await this['importVpk'](_0x4ac96f),_0x2f72f6=await this[_0x19cd21(0x81)](_0x1d5932),_0x4c8dc3=await this[_0x19cd21(0x93)](_0x2f72f6),_0x15a6c4=await this[_0x19cd21(0x88)](_0x4c8dc3[_0x19cd21(0xbd)]),_0x3e2210=await this[_0x19cd21(0x81)](_0x15a6c4);return this[_0x19cd21(0xa9)](_0x3e2210,_0x4c8dc3);}}exports[a404_0x54a50f(0xb9)]=PackageImportService;function a404_0xeac7(_0x3f8a6a,_0x56c858){const _0x3d46c2=a404_0x309a();return a404_0xeac7=function(_0x263a8b,_0x4cdaa4){_0x263a8b=_0x263a8b-0x6c;let _0x309ae8=_0x3d46c2[_0x263a8b];return _0x309ae8;},a404_0xeac7(_0x3f8a6a,_0x56c858);}function a404_0x309a(){const _0x30ef8e=['endsWith','PackageDetailsDto','log','url','getJobDetailUrl','Deploy\x20package','text','Get\x20validation\x20details.','href','data','30BRDxGJ','deployPackage','responseDetails','{package_id}','VeevaConstants','Deployment.log','452175ESFMEG','../enums/status.enums','../dtos/package-details.dto','reduce','_veevaService','filename','getValidationDetailsAndSaveLog','search','Validation.log','rel','VeevaError','3760890vFmOLL','getLogResultText','VERIFIED','_logger','importVpk','import','__esModule','Deploy\x20Log','Validation\x20Log','artifacts','errors','replace','status','createReadStream','fillPackageDeploymentAction','../classes/errors/veeva-error','VeevaResponseStatus','getDeployDetailsAndSaveLog','includes','map','_connection','packageComponentList','defineProperty','post','1494BmucgQ','find','deployment_status__v','263879VQBoOt','apply','ENDPOINT_EXPORT_IMPORT_PACKAGE','package_components','_saveLog','../utils/array.utils','PackageImportService','groupToMap','toString','ENDPOINT_VALIDATE_PACKAGE','packageId','914688tTUWjV','name__v','get','2VdPnCB','PackageComponentDto','VeevaPackageStatus','DEPLOYED_WITH_WARNINGS','uniqueName','multipart/form-data','435632WSueLI','2072UsFCfd','constructor','ArrayUtils','SUCCESS','responseStatus','1999805ZWWzWE','length','file','isDeployed','updateVeevaConnection','convertDeploymentAction','(((.+)+)+)+$','DEPLOYED','Import\x20package','append','filter','put','ENDPOINT_DEPLOY_PACKAGE','formPackageComponentList'];a404_0x309a=function(){return _0x30ef8e;};return a404_0x309a();}