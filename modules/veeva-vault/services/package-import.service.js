const a359_0x3fbdee=a359_0x56d6;function a359_0x3ee1(){const _0x37980c=['Import\x20package','ArrayUtils','46DQdkvG','Deploy\x20package','_connection','8KuSKaF','../classes/errors/veeva-error','4520RkEjmi','_veevaService','updateVeevaConnection','../dtos/package-component.dto','data','isDeployed','includes','../utils/veeva-auth.utils','getValidationDetailsAndSaveLog','2664pLJsbB','packageId','getJobResult','defineProperty','Validation.log','1472383IGOkzj','endsWith','VERIFIED','12iXyGyf','convertDeploymentAction','79338FIEWsJ','fillPackageDeploymentAction','groupUniqueToMap','{package_id}','VeevaPackageStatus','getLogResultText','links','PackageImportService','getDeployDetailsAndSaveLog','Validation\x20Log','PackageComponentStatus','formPackageComponentList','import','log','VeevaConstants','toString','182535MDPWKs','href','PackageComponentDto','SUCCESS','deployPackage','rel','vaultPackage','errors','append','groupToMap','ENDPOINT_EXPORT_IMPORT_PACKAGE','file','get','DEPLOYED','__importDefault','createReadStream','responseDetails','replace','reduce','5465nPieCT','18oolUWF','packageComponentList','ENDPOINT_DEPLOY_PACKAGE','_logger','artifacts','VeevaResponseStatus','filter','VeevaError','getJobDetailUrl','deployment_status__v','status','post','search','constructor','../dtos/package-details.dto','multipart/form-data','apply','url','(((.+)+)+)+$','responseStatus','4367sOATTA','default','PackageDetailsDto','uniqueName','length','name__v','ENDPOINT_VALIDATE_PACKAGE','form-data','__esModule','put','map','Package\x20not\x20verified','1860100OlhLsJ'];a359_0x3ee1=function(){return _0x37980c;};return a359_0x3ee1();}(function(_0x209b67,_0x10a5bb){const _0x1eb58a=a359_0x56d6,_0x285056=_0x209b67();while(!![]){try{const _0x127702=-parseInt(_0x1eb58a(0x17d))/0x1*(-parseInt(_0x1eb58a(0x18c))/0x2)+parseInt(_0x1eb58a(0x1b4))/0x3*(-parseInt(_0x1eb58a(0x18f))/0x4)+-parseInt(_0x1eb58a(0x1c7))/0x5*(parseInt(_0x1eb58a(0x1c8))/0x6)+parseInt(_0x1eb58a(0x1a4))/0x7+-parseInt(_0x1eb58a(0x191))/0x8*(parseInt(_0x1eb58a(0x19a))/0x9)+parseInt(_0x1eb58a(0x189))/0xa+parseInt(_0x1eb58a(0x19f))/0xb*(parseInt(_0x1eb58a(0x1a2))/0xc);if(_0x127702===_0x10a5bb)break;else _0x285056['push'](_0x285056['shift']());}catch(_0x4be13a){_0x285056['push'](_0x285056['shift']());}}}(a359_0x3ee1,0x220a5));function a359_0x56d6(_0xd86acd,_0x5a543c){const _0x15ffb2=a359_0x3ee1();return a359_0x56d6=function(_0x514ffe,_0x4214c3){_0x514ffe=_0x514ffe-0x177;let _0x3ee117=_0x15ffb2[_0x514ffe];return _0x3ee117;},a359_0x56d6(_0xd86acd,_0x5a543c);}const a359_0x4214c3=(function(){let _0x41a247=!![];return function(_0x2981be,_0x20b088){const _0x267ac3=_0x41a247?function(){const _0x2ea569=a359_0x56d6;if(_0x20b088){const _0x39abff=_0x20b088[_0x2ea569(0x179)](_0x2981be,arguments);return _0x20b088=null,_0x39abff;}}:function(){};return _0x41a247=![],_0x267ac3;};}()),a359_0x514ffe=a359_0x4214c3(this,function(){const _0x4bf318=a359_0x56d6;return a359_0x514ffe['toString']()[_0x4bf318(0x1d4)](_0x4bf318(0x17b))[_0x4bf318(0x1b3)]()[_0x4bf318(0x1d5)](a359_0x514ffe)['search'](_0x4bf318(0x17b));});a359_0x514ffe();'use strict';var __importDefault=this&&this[a359_0x3fbdee(0x1c2)]||function(_0x43af59){return _0x43af59&&_0x43af59['__esModule']?_0x43af59:{'default':_0x43af59};};Object[a359_0x3fbdee(0x19d)](exports,a359_0x3fbdee(0x185),{'value':!![]}),exports[a359_0x3fbdee(0x1ab)]=void 0x0;const veeva_constants_1=require('../constants/veeva.constants'),status_enums_1=require('../enums/status.enums'),veeva_error_1=require(a359_0x3fbdee(0x190)),form_data_1=__importDefault(require(a359_0x3fbdee(0x184))),fs_1=require('fs'),veeva_auth_utils_1=require(a359_0x3fbdee(0x198)),package_details_dto_1=require(a359_0x3fbdee(0x177)),package_component_dto_1=require(a359_0x3fbdee(0x194)),array_utils_1=require('../utils/array.utils');class PackageImportService{constructor({veevaService:_0x33b53d,connection:_0x135aa5,logger:_0x2906ed,saveLog:_0x430b8d}){const _0x3e7e92=a359_0x3fbdee;this[_0x3e7e92(0x192)]=_0x33b53d,this['_connection']=_0x135aa5,this[_0x3e7e92(0x1cb)]=_0x2906ed,this['_saveLog']=_0x430b8d;}async['importVpk'](_0x26d7d1,_0x2de932=0x1){const _0x442db4=a359_0x3fbdee;this[_0x442db4(0x1cb)][_0x442db4(0x1b1)](_0x442db4(0x18a));const _0x5418d1=new form_data_1[(_0x442db4(0x17e))]();_0x5418d1[_0x442db4(0x1bc)](_0x442db4(0x1bf),(0x0,fs_1[_0x442db4(0x1c3)])(_0x26d7d1));const _0x4385c0=await this['_connection'][_0x442db4(0x186)](veeva_constants_1[_0x442db4(0x1b2)][_0x442db4(0x1be)],_0x5418d1,{'headers':{'Content-Type':_0x442db4(0x178)}}),_0x44fbd6=_0x4385c0[_0x442db4(0x195)];if(_0x44fbd6[_0x442db4(0x17c)]===status_enums_1['VeevaResponseStatus'][_0x442db4(0x1b7)])return _0x44fbd6[_0x442db4(0x17a)];else{if(_0x2de932>0x0)return await(0x0,veeva_auth_utils_1[_0x442db4(0x193)])(this[_0x442db4(0x18e)]),await this['importVpk'](_0x26d7d1,_0x2de932-0x1);throw new veeva_error_1[(_0x442db4(0x1cf))](_0x44fbd6[_0x442db4(0x1bb)]);}}async[a359_0x3fbdee(0x1b8)](_0x3c8048){const _0x4960c5=a359_0x3fbdee;this[_0x4960c5(0x1cb)][_0x4960c5(0x1b1)](_0x4960c5(0x18d));const _0x1d2f55=await this[_0x4960c5(0x18e)][_0x4960c5(0x1d3)](veeva_constants_1[_0x4960c5(0x1b2)][_0x4960c5(0x1ca)][_0x4960c5(0x1c5)](_0x4960c5(0x1a7),_0x3c8048)),_0x29f07f=await _0x1d2f55[_0x4960c5(0x195)];if(_0x29f07f[_0x4960c5(0x17c)]===status_enums_1[_0x4960c5(0x1cd)][_0x4960c5(0x1b7)])return _0x29f07f[_0x4960c5(0x17a)];else throw new veeva_error_1[(_0x4960c5(0x1cf))](_0x29f07f[_0x4960c5(0x1bb)]);}async[a359_0x3fbdee(0x1d0)](_0x1fae2e){const _0x52af5c=a359_0x3fbdee;this[_0x52af5c(0x1cb)]['log']('Wait\x20Executing\x20job');const [_0x2c5475]=await this[_0x52af5c(0x192)][_0x52af5c(0x19c)]([_0x1fae2e]);return _0x2c5475[_0x52af5c(0x1aa)]['find'](_0x54e51a=>_0x54e51a[_0x52af5c(0x1b9)]===_0x52af5c(0x1cc))[_0x52af5c(0x1b5)];}async[a359_0x3fbdee(0x199)](_0x40f544){const _0x26194a=a359_0x3fbdee;this['_logger'][_0x26194a(0x1b1)]('Get\x20validation\x20details.');const {data:_0x138ea2}=await this[_0x26194a(0x18e)]['get'](_0x40f544);if(_0x138ea2[_0x26194a(0x17c)]===status_enums_1[_0x26194a(0x1cd)][_0x26194a(0x1b7)]){const _0x3af8fe=new package_details_dto_1[(_0x26194a(0x17f))](),{log:_0x42a731,id:_0x45f00b,package_status:_0xf4152,package_steps:_0x17bea2}=_0x138ea2[_0x26194a(0x1ba)],_0x4416cd=_0x42a731[_0x26194a(0x1ce)](_0x5db1fd=>_0x5db1fd['filename'][_0x26194a(0x1a0)](_0x26194a(0x19e))),_0x1d74fa=await this[_0x26194a(0x1a9)](_0x4416cd[0x0][_0x26194a(0x17a)]);await this['_saveLog'](_0x1d74fa,_0x26194a(0x1ad)),_0x3af8fe[_0x26194a(0x19b)]=_0x45f00b,_0x3af8fe[_0x26194a(0x1c9)]=this[_0x26194a(0x1af)](_0x17bea2),await this[_0x26194a(0x1a5)](_0x3af8fe);if(_0xf4152!==status_enums_1[_0x26194a(0x1a8)][_0x26194a(0x1a1)])throw new Error(_0x26194a(0x188));return _0x3af8fe;}else throw new veeva_error_1[(_0x26194a(0x1cf))](_0x138ea2[_0x26194a(0x1bb)]);}async[a359_0x3fbdee(0x1ac)](_0x43aac4,_0x5e83a6){const _0x9ec3f8=a359_0x3fbdee;var _0xcb4e0;this[_0x9ec3f8(0x1cb)][_0x9ec3f8(0x1b1)]('Get\x20deploy\x20result');const {data:_0x176d74}=await this['_connection']['get'](_0x43aac4);if(_0x176d74[_0x9ec3f8(0x17c)]===status_enums_1[_0x9ec3f8(0x1cd)][_0x9ec3f8(0x1b7)]){const {responseDetails:{deployment_log:_0x4651d9,package_status__v:_0x3c4f0c},package_steps:_0xe8f76b}=_0x176d74,_0x105dcf=_0x4651d9['filter'](_0x437a81=>_0x437a81['filename'][_0x9ec3f8(0x1a0)]('Deployment.log')),_0x379484=await this[_0x9ec3f8(0x1a9)](_0x105dcf[0x0][_0x9ec3f8(0x17a)]);await this['_saveLog'](_0x379484,'Deploy\x20Log'),_0x5e83a6[_0x9ec3f8(0x196)]=[status_enums_1[_0x9ec3f8(0x1a8)][_0x9ec3f8(0x1c1)],status_enums_1[_0x9ec3f8(0x1a8)]['DEPLOYED_WITH_WARNINGS']][_0x9ec3f8(0x197)](_0x3c4f0c);const _0x12c8ff=array_utils_1[_0x9ec3f8(0x18b)][_0x9ec3f8(0x1a6)](this[_0x9ec3f8(0x1af)](_0xe8f76b),({uniqueName:_0x2404f0})=>_0x2404f0);for(const _0x1294de of _0x5e83a6[_0x9ec3f8(0x1c9)]){const _0x490bc9=(_0xcb4e0=_0x12c8ff[_0x9ec3f8(0x1c0)](_0x1294de[_0x9ec3f8(0x180)]))===null||_0xcb4e0===void 0x0?void 0x0:_0xcb4e0[_0x9ec3f8(0x1d2)];_0x490bc9&&(_0x1294de[_0x9ec3f8(0x1d2)]=_0x490bc9);}_0x5e83a6[_0x9ec3f8(0x1c9)]=_0x5e83a6[_0x9ec3f8(0x1c9)]['filter'](_0x33f405=>_0x33f405[_0x9ec3f8(0x1d2)]!==status_enums_1[_0x9ec3f8(0x1ae)][_0x9ec3f8(0x1a1)]);if(!_0x5e83a6[_0x9ec3f8(0x1c9)][_0x9ec3f8(0x181)])throw new Error('Cannot\x20find\x20deployment\x20results');return _0x5e83a6;}else throw new veeva_error_1[(_0x9ec3f8(0x1cf))](_0x176d74[_0x9ec3f8(0x1bb)]);}async[a359_0x3fbdee(0x1a9)](_0x266037){const _0x5c0a6e=a359_0x3fbdee,{data:_0x41e8fe}=await this['_connection'][_0x5c0a6e(0x1c0)](_0x266037,{'responseType':'text'});return _0x41e8fe;}['formPackageComponentList'](_0x391e55){const _0x505981=a359_0x3fbdee;return _0x391e55[_0x505981(0x1c6)]((_0x1a67c3,_0x33463e)=>{const _0x4ee314=_0x505981,_0x2d317a=_0x33463e['package_components'][_0x4ee314(0x187)](_0x2e645e=>new package_component_dto_1['PackageComponentDto']({'status':_0x33463e[_0x4ee314(0x1d1)],'stepName':_0x33463e[_0x4ee314(0x182)],'component':_0x2e645e}));return[..._0x1a67c3,..._0x2d317a];},[]);}async[a359_0x3fbdee(0x1a5)](_0xa48422){const _0x1fcee1=a359_0x3fbdee,{data:_0x348767}=await this['_connection'][_0x1fcee1(0x1d3)](veeva_constants_1[_0x1fcee1(0x1b2)][_0x1fcee1(0x183)]['replace'](_0x1fcee1(0x1a7),_0xa48422[_0x1fcee1(0x19b)]));if(_0x348767[_0x1fcee1(0x17c)]===status_enums_1[_0x1fcee1(0x1cd)]['SUCCESS']){const {package_steps:_0x46e63d}=_0x348767[_0x1fcee1(0x1c4)],_0x11fd28=array_utils_1[_0x1fcee1(0x18b)][_0x1fcee1(0x1bd)](_0xa48422[_0x1fcee1(0x1c9)],({stepName:_0x4a7519})=>_0x4a7519);for(const {name__v:_0x56981d,deployment_action:_0x40fade}of _0x46e63d){for(const _0x6add76 of _0x11fd28[_0x1fcee1(0x1c0)](_0x56981d)||[]){_0x6add76['deploymentAction']=package_component_dto_1[_0x1fcee1(0x1b6)][_0x1fcee1(0x1a3)](_0x40fade);}}}else throw new veeva_error_1[(_0x1fcee1(0x1cf))](_0x348767[_0x1fcee1(0x1bb)]);}async[a359_0x3fbdee(0x1b0)](_0x4d65f0){const _0x1da7df=a359_0x3fbdee,_0x1ae85d=await this['importVpk'](_0x4d65f0),_0x1ccfb5=await this['getJobDetailUrl'](_0x1ae85d),_0x284c6b=await this['getValidationDetailsAndSaveLog'](_0x1ccfb5),_0x48f51b=await this[_0x1da7df(0x1b8)](_0x284c6b[_0x1da7df(0x19b)]),_0x13883e=await this[_0x1da7df(0x1d0)](_0x48f51b);return this[_0x1da7df(0x1ac)](_0x13883e,_0x284c6b);}}exports['PackageImportService']=PackageImportService;