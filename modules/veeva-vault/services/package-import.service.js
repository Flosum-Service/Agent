const a405_0x1bea12=a405_0x54f5;(function(_0x2b0b2a,_0x116a50){const _0x27fc0d=a405_0x54f5,_0x6ecf6b=_0x2b0b2a();while(!![]){try{const _0x1b5dd8=parseInt(_0x27fc0d(0xfa))/0x1*(-parseInt(_0x27fc0d(0xe9))/0x2)+-parseInt(_0x27fc0d(0xca))/0x3*(-parseInt(_0x27fc0d(0xcb))/0x4)+parseInt(_0x27fc0d(0xb2))/0x5+-parseInt(_0x27fc0d(0xe3))/0x6+parseInt(_0x27fc0d(0xbf))/0x7*(-parseInt(_0x27fc0d(0xdd))/0x8)+parseInt(_0x27fc0d(0xb5))/0x9+parseInt(_0x27fc0d(0xb1))/0xa*(-parseInt(_0x27fc0d(0xed))/0xb);if(_0x1b5dd8===_0x116a50)break;else _0x6ecf6b['push'](_0x6ecf6b['shift']());}catch(_0x53b487){_0x6ecf6b['push'](_0x6ecf6b['shift']());}}}(a405_0x34a3,0x30c20));const a405_0x35de3c=(function(){let _0x520225=!![];return function(_0xa2db59,_0x49cf35){const _0x5037e6=_0x520225?function(){const _0x5ed886=a405_0x54f5;if(_0x49cf35){const _0x1e1525=_0x49cf35[_0x5ed886(0xdf)](_0xa2db59,arguments);return _0x49cf35=null,_0x1e1525;}}:function(){};return _0x520225=![],_0x5037e6;};}()),a405_0x4bf689=a405_0x35de3c(this,function(){const _0x37f893=a405_0x54f5;return a405_0x4bf689['toString']()[_0x37f893(0xba)](_0x37f893(0xa6))[_0x37f893(0xbc)]()['constructor'](a405_0x4bf689)[_0x37f893(0xba)](_0x37f893(0xa6));});a405_0x4bf689();function a405_0x54f5(_0x3bead7,_0x44572e){const _0xeaab48=a405_0x34a3();return a405_0x54f5=function(_0x4bf689,_0x35de3c){_0x4bf689=_0x4bf689-0xa2;let _0x34a3aa=_0xeaab48[_0x4bf689];return _0x34a3aa;},a405_0x54f5(_0x3bead7,_0x44572e);}function a405_0x34a3(){const _0x124fb7=['getJobDetailUrl','10OpHhZH','1553065BAhysD','PackageComponentDto','VeevaResponseStatus','971721YSXkkk','put','_connection','DEPLOYED_WITH_WARNINGS','endsWith','search','getValidationDetailsAndSaveLog','toString','uniqueName','../utils/array.utils','47852rNXyeo','errors','replace','rel','getLogResultText','status','packageComponentList','Get\x20validation\x20details.','log','importVpk','getDeployDetailsAndSaveLog','3129IKRWJh','404IkwDkm','Deployment.log','responseDetails','ENDPOINT_VALIDATE_PACKAGE','href','name__v','../classes/errors/veeva-error','Wait\x20Executing\x20job','ENDPOINT_EXPORT_IMPORT_PACKAGE','_veevaService','VeevaPackageStatus','__esModule','filter','reduce','Import\x20package','_logger','multipart/form-data','PackageComponentStatus','296PuwcZu','SUCCESS','apply','package_components','Package\x20not\x20verified','responseStatus','75972IVsZBS','VeevaConstants','append','../constants/veeva.constants','post','deployment_status__v','23646ZHhMjr','Get\x20deploy\x20result','data','ArrayUtils','384703yBRNsD','PackageImportService','{package_id}','groupToMap','VERIFIED','createReadStream','includes','url','artifacts','filename','packageId','VeevaError','fillPackageDeploymentAction','2TtjJNG','text','Validation.log','../enums/status.enums','get','(((.+)+)+)+$','formPackageComponentList','deployPackage','updateVeevaConnection','defineProperty','_saveLog','map','isDeployed','Deploy\x20package','deploymentAction'];a405_0x34a3=function(){return _0x124fb7;};return a405_0x34a3();}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x142013){const _0x203c55=a405_0x54f5;return _0x142013&&_0x142013[_0x203c55(0xd6)]?_0x142013:{'default':_0x142013};};Object[a405_0x1bea12(0xaa)](exports,'__esModule',{'value':!![]}),exports[a405_0x1bea12(0xee)]=void 0x0;const veeva_constants_1=require(a405_0x1bea12(0xe6)),status_enums_1=require(a405_0x1bea12(0xa4)),veeva_error_1=require(a405_0x1bea12(0xd1)),form_data_1=__importDefault(require('form-data')),fs_1=require('fs'),veeva_auth_utils_1=require('../utils/veeva-auth.utils'),package_details_dto_1=require('../dtos/package-details.dto'),package_component_dto_1=require('../dtos/package-component.dto'),array_utils_1=require(a405_0x1bea12(0xbe));class PackageImportService{constructor({veevaService:_0x4a6bfb,connection:_0x2798ce,logger:_0x4c13ea,saveLog:_0x5f5db9}){const _0x489926=a405_0x1bea12;this[_0x489926(0xd4)]=_0x4a6bfb,this[_0x489926(0xb7)]=_0x2798ce,this[_0x489926(0xda)]=_0x4c13ea,this['_saveLog']=_0x5f5db9;}async[a405_0x1bea12(0xc8)](_0x170b9d,_0x4f9745=0x1){const _0x2191d2=a405_0x1bea12;this[_0x2191d2(0xda)][_0x2191d2(0xc7)](_0x2191d2(0xd9));const _0x192b9c=new form_data_1['default']();_0x192b9c[_0x2191d2(0xe5)]('file',(0x0,fs_1[_0x2191d2(0xf2)])(_0x170b9d));const _0x3396e4=await this[_0x2191d2(0xb7)][_0x2191d2(0xb6)](veeva_constants_1[_0x2191d2(0xe4)][_0x2191d2(0xd3)],_0x192b9c,{'headers':{'Content-Type':_0x2191d2(0xdb)}}),_0x8e8cbe=_0x3396e4[_0x2191d2(0xeb)];if(_0x8e8cbe[_0x2191d2(0xe2)]===status_enums_1[_0x2191d2(0xb4)]['SUCCESS'])return _0x8e8cbe[_0x2191d2(0xf4)];else{if(_0x4f9745>0x0)return await(0x0,veeva_auth_utils_1[_0x2191d2(0xa9)])(this['_connection']),await this[_0x2191d2(0xc8)](_0x170b9d,_0x4f9745-0x1);throw new veeva_error_1[(_0x2191d2(0xf8))](_0x8e8cbe[_0x2191d2(0xc0)]);}}async[a405_0x1bea12(0xa8)](_0x349c79){const _0x2270c5=a405_0x1bea12;this[_0x2270c5(0xda)]['log'](_0x2270c5(0xae));const _0x359464=await this[_0x2270c5(0xb7)]['post'](veeva_constants_1['VeevaConstants']['ENDPOINT_DEPLOY_PACKAGE'][_0x2270c5(0xc1)]('{package_id}',_0x349c79)),_0x4042b4=await _0x359464['data'];if(_0x4042b4[_0x2270c5(0xe2)]===status_enums_1[_0x2270c5(0xb4)]['SUCCESS'])return _0x4042b4['url'];else throw new veeva_error_1[(_0x2270c5(0xf8))](_0x4042b4[_0x2270c5(0xc0)]);}async['getJobDetailUrl'](_0x3aa53e){const _0xa7ccaa=a405_0x1bea12;this[_0xa7ccaa(0xda)][_0xa7ccaa(0xc7)](_0xa7ccaa(0xd2));const [_0x181f82]=await this['_veevaService']['getJobResult']([_0x3aa53e]);return _0x181f82['links']['find'](_0x461b21=>_0x461b21[_0xa7ccaa(0xc2)]===_0xa7ccaa(0xf5))[_0xa7ccaa(0xcf)];}async[a405_0x1bea12(0xbb)](_0x2b14ce){const _0x308b17=a405_0x1bea12;this[_0x308b17(0xda)]['log'](_0x308b17(0xc6));const {data:_0x25e5c5}=await this['_connection'][_0x308b17(0xa5)](_0x2b14ce);if(_0x25e5c5[_0x308b17(0xe2)]===status_enums_1['VeevaResponseStatus'][_0x308b17(0xde)]){const _0x31c285=new package_details_dto_1['PackageDetailsDto'](),{log:_0x43bb8c,id:_0xfe5890,package_status:_0x5b540d,package_steps:_0x18ade0}=_0x25e5c5['vaultPackage'],_0x395621=_0x43bb8c[_0x308b17(0xd7)](_0x2ffa38=>_0x2ffa38[_0x308b17(0xf6)][_0x308b17(0xb9)](_0x308b17(0xa3))),_0x4c1eb9=await this['getLogResultText'](_0x395621[0x0]['url']);await this[_0x308b17(0xab)](_0x4c1eb9,'Validation\x20Log'),_0x31c285[_0x308b17(0xf7)]=_0xfe5890,_0x31c285[_0x308b17(0xc5)]=this[_0x308b17(0xa7)](_0x18ade0),await this['fillPackageDeploymentAction'](_0x31c285);if(_0x5b540d!==status_enums_1[_0x308b17(0xd5)][_0x308b17(0xf1)])throw new Error(_0x308b17(0xe1));return _0x31c285;}else throw new veeva_error_1[(_0x308b17(0xf8))](_0x25e5c5['errors']);}async[a405_0x1bea12(0xc9)](_0x5ea8e8,_0x500242){const _0x1657ee=a405_0x1bea12;var _0x56bca8;this[_0x1657ee(0xda)]['log'](_0x1657ee(0xea));const {data:_0x4f6f28}=await this[_0x1657ee(0xb7)][_0x1657ee(0xa5)](_0x5ea8e8);if(_0x4f6f28[_0x1657ee(0xe2)]===status_enums_1[_0x1657ee(0xb4)][_0x1657ee(0xde)]){const {responseDetails:{deployment_log:_0x46600c,package_status__v:_0x590968},package_steps:_0x2c5764}=_0x4f6f28,_0x472b95=_0x46600c[_0x1657ee(0xd7)](_0x1ec4be=>_0x1ec4be['filename'][_0x1657ee(0xb9)](_0x1657ee(0xcc))),_0x5e2184=await this[_0x1657ee(0xc3)](_0x472b95[0x0][_0x1657ee(0xf4)]);await this['_saveLog'](_0x5e2184,'Deploy\x20Log'),_0x500242[_0x1657ee(0xad)]=[status_enums_1[_0x1657ee(0xd5)]['DEPLOYED'],status_enums_1[_0x1657ee(0xd5)][_0x1657ee(0xb8)]][_0x1657ee(0xf3)](_0x590968);const _0x82eb01=array_utils_1[_0x1657ee(0xec)]['groupUniqueToMap'](this['formPackageComponentList'](_0x2c5764),({uniqueName:_0xc966db})=>_0xc966db);for(const _0x3406f2 of _0x500242['packageComponentList']){const _0x38e045=(_0x56bca8=_0x82eb01[_0x1657ee(0xa5)](_0x3406f2[_0x1657ee(0xbd)]))===null||_0x56bca8===void 0x0?void 0x0:_0x56bca8[_0x1657ee(0xc4)];_0x38e045&&(_0x3406f2[_0x1657ee(0xc4)]=_0x38e045);}_0x500242[_0x1657ee(0xc5)]=_0x500242[_0x1657ee(0xc5)]['filter'](_0x4ec773=>_0x4ec773['status']!==status_enums_1[_0x1657ee(0xdc)][_0x1657ee(0xf1)]);if(!_0x500242[_0x1657ee(0xc5)]['length'])throw new Error('Cannot\x20find\x20deployment\x20results');return _0x500242;}else throw new veeva_error_1[(_0x1657ee(0xf8))](_0x4f6f28[_0x1657ee(0xc0)]);}async[a405_0x1bea12(0xc3)](_0x54ed22){const _0x8b9f32=a405_0x1bea12,{data:_0x68ed18}=await this[_0x8b9f32(0xb7)][_0x8b9f32(0xa5)](_0x54ed22,{'responseType':_0x8b9f32(0xa2)});return _0x68ed18;}['formPackageComponentList'](_0x5898d9){const _0x3a7bf8=a405_0x1bea12;return _0x5898d9[_0x3a7bf8(0xd8)]((_0x2f0174,_0x3e3101)=>{const _0x1bddc8=_0x3a7bf8,_0x1e3991=_0x3e3101[_0x1bddc8(0xe0)][_0x1bddc8(0xac)](_0x51c08d=>new package_component_dto_1[(_0x1bddc8(0xb3))]({'status':_0x3e3101[_0x1bddc8(0xe8)],'stepName':_0x3e3101[_0x1bddc8(0xd0)],'component':_0x51c08d}));return[..._0x2f0174,..._0x1e3991];},[]);}async[a405_0x1bea12(0xf9)](_0x5563a4){const _0x24c1cf=a405_0x1bea12,{data:_0x53282d}=await this[_0x24c1cf(0xb7)][_0x24c1cf(0xe7)](veeva_constants_1[_0x24c1cf(0xe4)][_0x24c1cf(0xce)][_0x24c1cf(0xc1)](_0x24c1cf(0xef),_0x5563a4[_0x24c1cf(0xf7)]));if(_0x53282d[_0x24c1cf(0xe2)]===status_enums_1['VeevaResponseStatus']['SUCCESS']){const {package_steps:_0x4eaac8}=_0x53282d[_0x24c1cf(0xcd)],_0x40f5d3=array_utils_1[_0x24c1cf(0xec)][_0x24c1cf(0xf0)](_0x5563a4[_0x24c1cf(0xc5)],({stepName:_0x3583c3})=>_0x3583c3);for(const {name__v:_0x346196,deployment_action:_0x56bd59}of _0x4eaac8){for(const _0x168f18 of _0x40f5d3[_0x24c1cf(0xa5)](_0x346196)||[]){_0x168f18[_0x24c1cf(0xaf)]=package_component_dto_1[_0x24c1cf(0xb3)]['convertDeploymentAction'](_0x56bd59);}}}else throw new veeva_error_1[(_0x24c1cf(0xf8))](_0x53282d[_0x24c1cf(0xc0)]);}async['import'](_0x5e29a8){const _0x3563c2=a405_0x1bea12,_0x1170ac=await this[_0x3563c2(0xc8)](_0x5e29a8),_0xda287c=await this[_0x3563c2(0xb0)](_0x1170ac),_0x1296ea=await this['getValidationDetailsAndSaveLog'](_0xda287c),_0x1fa3af=await this[_0x3563c2(0xa8)](_0x1296ea[_0x3563c2(0xf7)]),_0x891ca9=await this['getJobDetailUrl'](_0x1fa3af);return this[_0x3563c2(0xc9)](_0x891ca9,_0x1296ea);}}exports[a405_0x1bea12(0xee)]=PackageImportService;