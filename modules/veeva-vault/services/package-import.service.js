const a336_0xc23643=a336_0x569e;(function(_0x4e0bef,_0x49d661){const _0x4fc9b4=a336_0x569e,_0x1d59eb=_0x4e0bef();while(!![]){try{const _0x32343d=-parseInt(_0x4fc9b4(0x169))/0x1*(-parseInt(_0x4fc9b4(0x170))/0x2)+-parseInt(_0x4fc9b4(0x172))/0x3+-parseInt(_0x4fc9b4(0x177))/0x4+-parseInt(_0x4fc9b4(0x158))/0x5+-parseInt(_0x4fc9b4(0x173))/0x6+parseInt(_0x4fc9b4(0x174))/0x7+-parseInt(_0x4fc9b4(0x143))/0x8*(-parseInt(_0x4fc9b4(0x180))/0x9);if(_0x32343d===_0x49d661)break;else _0x1d59eb['push'](_0x1d59eb['shift']());}catch(_0x56eaec){_0x1d59eb['push'](_0x1d59eb['shift']());}}}(a336_0x29cc,0x2523a));function a336_0x569e(_0x336bb2,_0x8cd29d){const _0x75303a=a336_0x29cc();return a336_0x569e=function(_0x5dfd9e,_0x15533e){_0x5dfd9e=_0x5dfd9e-0x12b;let _0x29cc7c=_0x75303a[_0x5dfd9e];return _0x29cc7c;},a336_0x569e(_0x336bb2,_0x8cd29d);}const a336_0x15533e=(function(){let _0x584b8f=!![];return function(_0xe4e727,_0x32e5e3){const _0x3b8cbe=_0x584b8f?function(){const _0x458f83=a336_0x569e;if(_0x32e5e3){const _0x8616d9=_0x32e5e3[_0x458f83(0x175)](_0xe4e727,arguments);return _0x32e5e3=null,_0x8616d9;}}:function(){};return _0x584b8f=![],_0x3b8cbe;};}()),a336_0x5dfd9e=a336_0x15533e(this,function(){const _0x4df7bf=a336_0x569e;return a336_0x5dfd9e[_0x4df7bf(0x181)]()[_0x4df7bf(0x154)]('(((.+)+)+)+$')[_0x4df7bf(0x181)]()['constructor'](a336_0x5dfd9e)[_0x4df7bf(0x154)](_0x4df7bf(0x133));});a336_0x5dfd9e();'use strict';var __importDefault=this&&this[a336_0xc23643(0x153)]||function(_0x2fb203){const _0x175676=a336_0xc23643;return _0x2fb203&&_0x2fb203[_0x175676(0x183)]?_0x2fb203:{'default':_0x2fb203};};function a336_0x29cc(){const _0x5a6f4c=['get','_saveLog','reduce','groupUniqueToMap','packageId','../enums/status.enums','text','getJobResult','defineProperty','1EuZENl','find','status','getDeployDetailsAndSaveLog','{package_id}','SUCCESS','Get\x20validation\x20details.','11782BRisRY','append','734676GIhpdC','73212EimBxh','685545NnyEzx','apply','file','1006288rHdeaj','_connection','ENDPOINT_DEPLOY_PACKAGE','deployPackage','VeevaError','getValidationDetailsAndSaveLog','DEPLOYED','importVpk','post','27fAfEee','toString','../classes/errors/veeva-error','__esModule','put','errors','_logger','../utils/veeva-auth.utils','Deploy\x20Log','multipart/form-data','Get\x20deploy\x20result','deployment_status__v','VeevaConstants','package_components','(((.+)+)+)+$','ArrayUtils','replace','PackageImportService','updateVeevaConnection','url','convertDeploymentAction','Validation.log','rel','log','filter','Wait\x20Executing\x20job','vaultPackage','name__v','_veevaService','ENDPOINT_EXPORT_IMPORT_PACKAGE','2254176ewRETf','Import\x20package','Package\x20not\x20verified','../utils/array.utils','href','form-data','../dtos/package-details.dto','data','VeevaResponseStatus','deploymentAction','endsWith','fillPackageDeploymentAction','packageComponentList','ENDPOINT_VALIDATE_PACKAGE','responseDetails','responseStatus','__importDefault','search','VeevaPackageStatus','PackageDetailsDto','getJobDetailUrl','1441770BRMphW','createReadStream','Deployment.log','PackageComponentStatus','PackageComponentDto','getLogResultText','filename','uniqueName'];a336_0x29cc=function(){return _0x5a6f4c;};return a336_0x29cc();}Object[a336_0xc23643(0x168)](exports,a336_0xc23643(0x183),{'value':!![]}),exports[a336_0xc23643(0x136)]=void 0x0;const veeva_constants_1=require('../constants/veeva.constants'),status_enums_1=require(a336_0xc23643(0x165)),veeva_error_1=require(a336_0xc23643(0x182)),form_data_1=__importDefault(require(a336_0xc23643(0x148))),fs_1=require('fs'),veeva_auth_utils_1=require(a336_0xc23643(0x12c)),package_details_dto_1=require(a336_0xc23643(0x149)),package_component_dto_1=require('../dtos/package-component.dto'),array_utils_1=require(a336_0xc23643(0x146));class PackageImportService{constructor({veevaService:_0x1fa717,connection:_0x1b8012,logger:_0x4897dd,saveLog:_0x2dbb60}){const _0x3712f4=a336_0xc23643;this[_0x3712f4(0x141)]=_0x1fa717,this[_0x3712f4(0x178)]=_0x1b8012,this[_0x3712f4(0x12b)]=_0x4897dd,this[_0x3712f4(0x161)]=_0x2dbb60;}async['importVpk'](_0x229279,_0x373516=0x1){const _0xdc8df8=a336_0xc23643;this[_0xdc8df8(0x12b)][_0xdc8df8(0x13c)](_0xdc8df8(0x144));const _0x139088=new form_data_1['default']();_0x139088[_0xdc8df8(0x171)](_0xdc8df8(0x176),(0x0,fs_1[_0xdc8df8(0x159)])(_0x229279));const _0x4e244a=await this[_0xdc8df8(0x178)][_0xdc8df8(0x184)](veeva_constants_1[_0xdc8df8(0x131)][_0xdc8df8(0x142)],_0x139088,{'headers':{'Content-Type':_0xdc8df8(0x12e)}}),_0x58a57f=_0x4e244a[_0xdc8df8(0x14a)];if(_0x58a57f[_0xdc8df8(0x152)]===status_enums_1[_0xdc8df8(0x14b)][_0xdc8df8(0x16e)])return _0x58a57f[_0xdc8df8(0x138)];else{if(_0x373516>0x0)return await(0x0,veeva_auth_utils_1[_0xdc8df8(0x137)])(this[_0xdc8df8(0x178)]),await this[_0xdc8df8(0x17e)](_0x229279,_0x373516-0x1);throw new veeva_error_1['VeevaError'](_0x58a57f['errors']);}}async[a336_0xc23643(0x17a)](_0x3f219b){const _0x7de91b=a336_0xc23643;this[_0x7de91b(0x12b)][_0x7de91b(0x13c)]('Deploy\x20package');const _0x5c1e5e=await this[_0x7de91b(0x178)][_0x7de91b(0x17f)](veeva_constants_1['VeevaConstants'][_0x7de91b(0x179)][_0x7de91b(0x135)]('{package_id}',_0x3f219b)),_0x31632f=await _0x5c1e5e['data'];if(_0x31632f[_0x7de91b(0x152)]===status_enums_1['VeevaResponseStatus']['SUCCESS'])return _0x31632f[_0x7de91b(0x138)];else throw new veeva_error_1['VeevaError'](_0x31632f[_0x7de91b(0x185)]);}async[a336_0xc23643(0x157)](_0x1d74e2){const _0x3c4e2d=a336_0xc23643;this[_0x3c4e2d(0x12b)][_0x3c4e2d(0x13c)](_0x3c4e2d(0x13e));const [_0x1124f6]=await this['_veevaService'][_0x3c4e2d(0x167)]([_0x1d74e2]);return _0x1124f6['links'][_0x3c4e2d(0x16a)](_0x41044d=>_0x41044d[_0x3c4e2d(0x13b)]==='artifacts')[_0x3c4e2d(0x147)];}async[a336_0xc23643(0x17c)](_0x4a7d94){const _0x26eb7d=a336_0xc23643;this['_logger']['log'](_0x26eb7d(0x16f));const {data:_0x4d705d}=await this[_0x26eb7d(0x178)][_0x26eb7d(0x160)](_0x4a7d94);if(_0x4d705d['responseStatus']===status_enums_1[_0x26eb7d(0x14b)][_0x26eb7d(0x16e)]){const _0x43ad81=new package_details_dto_1[(_0x26eb7d(0x156))](),{log:_0x1a0fca,id:_0x32de7a,package_status:_0x37b450,package_steps:_0x870e9f}=_0x4d705d[_0x26eb7d(0x13f)],_0x1c25aa=_0x1a0fca['filter'](_0x3c9d4f=>_0x3c9d4f[_0x26eb7d(0x15e)][_0x26eb7d(0x14d)](_0x26eb7d(0x13a))),_0xeff7c6=await this[_0x26eb7d(0x15d)](_0x1c25aa[0x0][_0x26eb7d(0x138)]);await this['_saveLog'](_0xeff7c6,'Validation\x20Log'),_0x43ad81[_0x26eb7d(0x164)]=_0x32de7a,_0x43ad81[_0x26eb7d(0x14f)]=this['formPackageComponentList'](_0x870e9f),await this['fillPackageDeploymentAction'](_0x43ad81);if(_0x37b450!==status_enums_1[_0x26eb7d(0x155)]['VERIFIED'])throw new Error(_0x26eb7d(0x145));return _0x43ad81;}else throw new veeva_error_1[(_0x26eb7d(0x17b))](_0x4d705d[_0x26eb7d(0x185)]);}async[a336_0xc23643(0x16c)](_0x4b2595,_0x107dfa){const _0x5b6418=a336_0xc23643;var _0x51a0f1;this[_0x5b6418(0x12b)][_0x5b6418(0x13c)](_0x5b6418(0x12f));const {data:_0x53ed98}=await this[_0x5b6418(0x178)][_0x5b6418(0x160)](_0x4b2595);if(_0x53ed98[_0x5b6418(0x152)]===status_enums_1[_0x5b6418(0x14b)][_0x5b6418(0x16e)]){const {responseDetails:{deployment_log:_0x1a08b2,package_status__v:_0x2c99c5},package_steps:_0x32a22e}=_0x53ed98,_0x10bca9=_0x1a08b2['filter'](_0x35cace=>_0x35cace[_0x5b6418(0x15e)][_0x5b6418(0x14d)](_0x5b6418(0x15a))),_0x23aace=await this[_0x5b6418(0x15d)](_0x10bca9[0x0][_0x5b6418(0x138)]);await this[_0x5b6418(0x161)](_0x23aace,_0x5b6418(0x12d)),_0x107dfa['isDeployed']=[status_enums_1[_0x5b6418(0x155)][_0x5b6418(0x17d)],status_enums_1[_0x5b6418(0x155)]['DEPLOYED_WITH_WARNINGS']]['includes'](_0x2c99c5);const _0x452fbd=array_utils_1['ArrayUtils'][_0x5b6418(0x163)](this['formPackageComponentList'](_0x32a22e),({uniqueName:_0x3d894f})=>_0x3d894f);for(const _0x519a45 of _0x107dfa['packageComponentList']){const _0x5470a9=(_0x51a0f1=_0x452fbd[_0x5b6418(0x160)](_0x519a45[_0x5b6418(0x15f)]))===null||_0x51a0f1===void 0x0?void 0x0:_0x51a0f1['status'];_0x5470a9&&(_0x519a45['status']=_0x5470a9);}_0x107dfa[_0x5b6418(0x14f)]=_0x107dfa[_0x5b6418(0x14f)][_0x5b6418(0x13d)](_0x6d8ff4=>_0x6d8ff4[_0x5b6418(0x16b)]!==status_enums_1[_0x5b6418(0x15b)]['VERIFIED']);if(!_0x107dfa[_0x5b6418(0x14f)]['length'])throw new Error('Cannot\x20find\x20deployment\x20results');return _0x107dfa;}else throw new veeva_error_1['VeevaError'](_0x53ed98[_0x5b6418(0x185)]);}async[a336_0xc23643(0x15d)](_0x1db736){const _0x22ba48=a336_0xc23643,{data:_0x59559e}=await this[_0x22ba48(0x178)]['get'](_0x1db736,{'responseType':_0x22ba48(0x166)});return _0x59559e;}['formPackageComponentList'](_0x50dad0){const _0x42e0de=a336_0xc23643;return _0x50dad0[_0x42e0de(0x162)]((_0x5169aa,_0x31cb9e)=>{const _0x2dd416=_0x42e0de,_0x30096b=_0x31cb9e[_0x2dd416(0x132)]['map'](_0x26bf55=>new package_component_dto_1[(_0x2dd416(0x15c))]({'status':_0x31cb9e[_0x2dd416(0x130)],'stepName':_0x31cb9e[_0x2dd416(0x140)],'component':_0x26bf55}));return[..._0x5169aa,..._0x30096b];},[]);}async[a336_0xc23643(0x14e)](_0x58a6f4){const _0x2cb1c8=a336_0xc23643,{data:_0x54036d}=await this[_0x2cb1c8(0x178)]['post'](veeva_constants_1[_0x2cb1c8(0x131)][_0x2cb1c8(0x150)]['replace'](_0x2cb1c8(0x16d),_0x58a6f4[_0x2cb1c8(0x164)]));if(_0x54036d[_0x2cb1c8(0x152)]===status_enums_1['VeevaResponseStatus'][_0x2cb1c8(0x16e)]){const {package_steps:_0x5db046}=_0x54036d[_0x2cb1c8(0x151)],_0x8050ce=array_utils_1[_0x2cb1c8(0x134)]['groupToMap'](_0x58a6f4['packageComponentList'],({stepName:_0x2a5cb0})=>_0x2a5cb0);for(const {name__v:_0x469c69,deployment_action:_0x205380}of _0x5db046){for(const _0x568169 of _0x8050ce['get'](_0x469c69)||[]){_0x568169[_0x2cb1c8(0x14c)]=package_component_dto_1[_0x2cb1c8(0x15c)][_0x2cb1c8(0x139)](_0x205380);}}}else throw new veeva_error_1['VeevaError'](_0x54036d[_0x2cb1c8(0x185)]);}async['import'](_0x34dfd6){const _0x359808=a336_0xc23643,_0x23986f=await this[_0x359808(0x17e)](_0x34dfd6),_0x278e1f=await this[_0x359808(0x157)](_0x23986f),_0x439176=await this['getValidationDetailsAndSaveLog'](_0x278e1f),_0x12119b=await this[_0x359808(0x17a)](_0x439176['packageId']),_0x4eef2b=await this['getJobDetailUrl'](_0x12119b);return this[_0x359808(0x16c)](_0x4eef2b,_0x439176);}}exports[a336_0xc23643(0x136)]=PackageImportService;