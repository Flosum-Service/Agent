const a406_0x3dc3ea=a406_0x80af;(function(_0x5cde83,_0x3a48e3){const _0x417828=a406_0x80af,_0x40656f=_0x5cde83();while(!![]){try{const _0x4e7be1=-parseInt(_0x417828(0x13d))/0x1+-parseInt(_0x417828(0x154))/0x2+parseInt(_0x417828(0x163))/0x3*(-parseInt(_0x417828(0x189))/0x4)+-parseInt(_0x417828(0x11d))/0x5+parseInt(_0x417828(0x153))/0x6*(-parseInt(_0x417828(0x151))/0x7)+-parseInt(_0x417828(0x136))/0x8+parseInt(_0x417828(0x138))/0x9;if(_0x4e7be1===_0x3a48e3)break;else _0x40656f['push'](_0x40656f['shift']());}catch(_0x262873){_0x40656f['push'](_0x40656f['shift']());}}}(a406_0x4f0a,0x727b1));const a406_0x5f06a1=(function(){let _0xdf5290=!![];return function(_0x5dc323,_0x42f7f7){const _0x25e074=_0xdf5290?function(){const _0x1279b0=a406_0x80af;if(_0x42f7f7){const _0x338999=_0x42f7f7[_0x1279b0(0x116)](_0x5dc323,arguments);return _0x42f7f7=null,_0x338999;}}:function(){};return _0xdf5290=![],_0x25e074;};}()),a406_0x47b297=a406_0x5f06a1(this,function(){const _0x1ef5e8=a406_0x80af;return a406_0x47b297[_0x1ef5e8(0x156)]()[_0x1ef5e8(0x128)](_0x1ef5e8(0x164))['toString']()[_0x1ef5e8(0x165)](a406_0x47b297)[_0x1ef5e8(0x128)](_0x1ef5e8(0x164));});a406_0x47b297();'use strict';var __importDefault=this&&this[a406_0x3dc3ea(0x12c)]||function(_0x4fe91b){return _0x4fe91b&&_0x4fe91b['__esModule']?_0x4fe91b:{'default':_0x4fe91b};};Object['defineProperty'](exports,a406_0x3dc3ea(0x119),{'value':!![]}),exports[a406_0x3dc3ea(0x176)]=void 0x0;function a406_0x80af(_0x5e418f,_0x3b5d75){const _0x2832a3=a406_0x4f0a();return a406_0x80af=function(_0x47b297,_0x5f06a1){_0x47b297=_0x47b297-0x113;let _0x4f0ae0=_0x2832a3[_0x47b297];return _0x4f0ae0;},a406_0x80af(_0x5e418f,_0x3b5d75);}const jszip_1=__importDefault(require(a406_0x3dc3ea(0x12b))),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a406_0x3dc3ea(0x158)),metadata_item_dto_1=require(a406_0x3dc3ea(0x169)),constants_1=require(a406_0x3dc3ea(0x13f)),salesforce_service_1=require(a406_0x3dc3ea(0x144)),status_enums_1=require(a406_0x3dc3ea(0x17e)),salesforce_dml_error_1=require(a406_0x3dc3ea(0x121)),package_export_service_1=require(a406_0x3dc3ea(0x133)),type_and_name_veeva_component_retriever_1=require(a406_0x3dc3ea(0x11a)),type_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/type.veeva-component.retriever'),sync_1=require(a406_0x3dc3ea(0x122)),sync_2=require(a406_0x3dc3ea(0x175)),veeva_constants_1=require(a406_0x3dc3ea(0x17a)),path_1=__importDefault(require(a406_0x3dc3ea(0x134)));class SnapshotService{constructor({snapshotId:_0x5c55de,metadataLogId:_0x303bbc,selectedMetaTypes:_0x134bb4,selectedComponentMap:_0x2faed9,whereClause:_0x5631e9},_0x346599,_0x4105c9,_0x3cc62f){const _0x49dfa0=a406_0x3dc3ea;this['_connectionSalesforce']=_0x346599,this[_0x49dfa0(0x161)]=_0x4105c9,this['_logger']=_0x3cc62f,this[_0x49dfa0(0x16e)]=_0x5c55de,this[_0x49dfa0(0x18a)]=_0x303bbc,this[_0x49dfa0(0x184)]=_0x134bb4,this[_0x49dfa0(0x11b)]=_0x2faed9,this[_0x49dfa0(0x14a)]=_0x5631e9,this['_veevaService']=new veeva_service_1['VeevaService']({'connection':this[_0x49dfa0(0x161)],'logger':this[_0x49dfa0(0x14e)]}),this[_0x49dfa0(0x135)]=new salesforce_service_1['SalesforceService']({'connection':this['_connectionSalesforce']}),this[_0x49dfa0(0x115)]=new package_export_service_1[(_0x49dfa0(0x17d))]({'veevaService':this[_0x49dfa0(0x16d)],'connection':this[_0x49dfa0(0x161)],'logger':this['_logger']});}async['execute'](){const _0x4bb682=a406_0x3dc3ea;try{this['_logger']['log'](_0x4bb682(0x14d));const _0x4e8d4a=await this[_0x4bb682(0x137)]();await this['_logger'][_0x4bb682(0x162)]();const _0x68f128=await this['_packageExportService']['export'](_0x4e8d4a,SnapshotService['OUTBOUND_PACKAGE_NAME']);await this[_0x4bb682(0x14e)]['updateLog']();const _0x134cf6=await this[_0x4bb682(0x168)](_0x4e8d4a,_0x68f128);await this[_0x4bb682(0x178)](_0x134cf6),await this['_logger'][_0x4bb682(0x162)](),await this['finishSnapshot'](!![]);}catch(_0x46c088){this[_0x4bb682(0x14e)][_0x4bb682(0x188)](_0x46c088),await this['finishSnapshot'](![])['catch'](_0x262919=>this[_0x4bb682(0x14f)][_0x4bb682(0x11c)](_0x262919));}}async[a406_0x3dc3ea(0x137)](){const _0x40e343=a406_0x3dc3ea,_0xd4ed81={'veevaService':this[_0x40e343(0x16d)],'logger':this[_0x40e343(0x14e)]},_0x2a7532=Array[_0x40e343(0x186)](Object['values'](this[_0x40e343(0x11b)]))['length']?new type_and_name_veeva_component_retriever_1[(_0x40e343(0x170))]({'value':this[_0x40e343(0x11b)],..._0xd4ed81}):new type_veeva_component_retriever_1[(_0x40e343(0x155))]({'value':this[_0x40e343(0x184)],'whereClause':this[_0x40e343(0x14a)],..._0xd4ed81});return _0x2a7532[_0x40e343(0x177)]();}async[a406_0x3dc3ea(0x168)](_0x119d48,_0x9bc18a){const _0x222233=a406_0x3dc3ea;var _0x469662,_0x28761d;this[_0x222233(0x14e)]['log']('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x419fa3=this[_0x222233(0x17b)](_0x119d48),_0x517094=_0x419fa3['reduce']((_0x2a019f,_0x574da4)=>_0x2a019f[_0x222233(0x173)](_0x574da4[_0x222233(0x172)],_0x574da4),new Map());for(const _0x36f9a7 of _0x9bc18a){for(const _0xee1bb0 in _0x36f9a7[_0x222233(0x12a)]){const {base:_0x230cc2,name:_0x31a78d,dir:_0x111e84}=path_1['default'][_0x222233(0x11f)](_0xee1bb0),_0x129275=_0x31a78d+veeva_constants_1[_0x222233(0x148)][_0x222233(0x174)];if(_0x517094['has'](_0x230cc2)){const _0x5af3d4=await((_0x469662=_0x36f9a7[_0x222233(0x142)]([_0x111e84,_0x230cc2]['join'](path_1[_0x222233(0x185)][_0x222233(0x14b)][_0x222233(0x129)])))===null||_0x469662===void 0x0?void 0x0:_0x469662[_0x222233(0x13b)]('string')),_0x4f92bd=await((_0x28761d=_0x36f9a7[_0x222233(0x142)]([_0x111e84,_0x129275][_0x222233(0x140)](path_1[_0x222233(0x185)][_0x222233(0x14b)][_0x222233(0x129)])))===null||_0x28761d===void 0x0?void 0x0:_0x28761d['async'](_0x222233(0x166)));if(_0x5af3d4){const _0x4d295b=new jszip_1['default']();_0x4d295b[_0x222233(0x142)](_0x230cc2,_0x5af3d4),_0x4f92bd&&_0x4d295b['file'](_0x129275,this[_0x222233(0x11e)](_0x4f92bd)),_0x517094[_0x222233(0x117)](_0x230cc2)[_0x222233(0x15d)]=await _0x4d295b[_0x222233(0x15f)]({'type':_0x222233(0x12f)});}}}}return _0x419fa3['filter'](_0x30ca85=>!_0x30ca85[_0x222233(0x15d)])['forEach'](_0x3122d4=>{const _0x59bfea=_0x222233;this[_0x59bfea(0x14e)][_0x59bfea(0x16f)](_0x59bfea(0x16a)+_0x3122d4[_0x59bfea(0x182)]+'.'+_0x3122d4['name']+_0x59bfea(0x15b));}),_0x419fa3[_0x222233(0x160)](_0x1c2118=>_0x1c2118['body']);}[a406_0x3dc3ea(0x11e)](_0x5db3b6){const _0x46f7a8=a406_0x3dc3ea,_0x3cc3ca=(0x0,sync_1['parse'])(_0x5db3b6,{'columns':!![],'skip_empty_lines':!![]}),_0x15d578=_0x3cc3ca[_0x46f7a8(0x114)](({'In\x20Package':_0xf757d3,..._0x3a795e})=>_0x3a795e);return(0x0,sync_2[_0x46f7a8(0x125)])(_0x15d578,{'header':!![]});}[a406_0x3dc3ea(0x17b)](_0x236845){const _0x4b3ca8=a406_0x3dc3ea;return _0x236845[_0x4b3ca8(0x114)](_0x4c881a=>{const _0x1ad644=_0x4b3ca8,_0x2feded=new metadata_item_dto_1[(_0x1ad644(0x139))]();return _0x2feded[_0x1ad644(0x16c)]=_0x4c881a[_0x1ad644(0x16c)],_0x2feded[_0x1ad644(0x123)]=_0x4c881a['name'],_0x2feded['snapshotId']=this[_0x1ad644(0x16e)],_0x2feded[_0x1ad644(0x172)]=_0x4c881a[_0x1ad644(0x18b)]+'.'+_0x4c881a[_0x1ad644(0x16c)]+veeva_constants_1[_0x1ad644(0x148)][_0x1ad644(0x146)],_0x2feded[_0x1ad644(0x182)]=_0x4c881a[_0x1ad644(0x18b)],_0x2feded[_0x1ad644(0x183)]=_0x4c881a[_0x1ad644(0x183)],_0x2feded['isRetrieved']=![],_0x2feded;});}async[a406_0x3dc3ea(0x178)](_0x287f6e){const _0x3e177f=a406_0x3dc3ea;this[_0x3e177f(0x14e)]['log'](_0x3e177f(0x132)),await this[_0x3e177f(0x113)](_0x287f6e),this[_0x3e177f(0x14e)][_0x3e177f(0x16f)]('Saving\x20'+_0x287f6e['length']+'\x20Metadata\x20Items');const _0x53bc1f=_0x287f6e[_0x3e177f(0x114)](_0x1dd8fb=>{const _0x5516ab=_0x3e177f;return{[constants_1[_0x5516ab(0x124)]+'Name__c']:_0x1dd8fb[_0x5516ab(0x16c)],[constants_1[_0x5516ab(0x124)]+'API_Name__c']:_0x1dd8fb['apiName'],[constants_1[_0x5516ab(0x124)]+_0x5516ab(0x131)]:_0x1dd8fb['snapshotId'],[constants_1[_0x5516ab(0x124)]+_0x5516ab(0x150)]:_0x1dd8fb[_0x5516ab(0x172)],[constants_1[_0x5516ab(0x124)]+_0x5516ab(0x14c)]:_0x1dd8fb['isRetrieved'],[constants_1[_0x5516ab(0x124)]+_0x5516ab(0x13c)]:_0x1dd8fb[_0x5516ab(0x182)],[constants_1[_0x5516ab(0x124)]+_0x5516ab(0x130)]:_0x1dd8fb[_0x5516ab(0x143)],[constants_1[_0x5516ab(0x124)]+_0x5516ab(0x15a)]:_0x1dd8fb[_0x5516ab(0x183)]};}),_0x4235e0=await this[_0x3e177f(0x135)][_0x3e177f(0x13e)](constants_1[_0x3e177f(0x124)]+_0x3e177f(0x15c),_0x53bc1f);let _0x3a4b87=!![];_0x4235e0['forEach']((_0x7bf457,_0x2a6366)=>{const _0x59e5ce=_0x3e177f;this[_0x59e5ce(0x14e)][_0x59e5ce(0x16f)](_0x59e5ce(0x127)+_0x287f6e[_0x2a6366]['veevaComponentType']+'.'+_0x287f6e[_0x2a6366][_0x59e5ce(0x16c)]);if(!_0x7bf457[_0x59e5ce(0x126)]){_0x3a4b87=![];const _0x2842a1=new salesforce_dml_error_1[(_0x59e5ce(0x15e))](_0x7bf457['errors']);this[_0x59e5ce(0x14e)]['logError'](_0x2842a1);}});if(!_0x3a4b87)throw new Error(_0x3e177f(0x120));}async[a406_0x3dc3ea(0x113)](_0x35eb7e){const _0x507a26=a406_0x3dc3ea,_0x5d4764=this['formAttachments'](_0x35eb7e),_0x4aa492=await this[_0x507a26(0x135)][_0x507a26(0x13e)](SnapshotService[_0x507a26(0x16b)],_0x5d4764),_0x262549=[];_0x4aa492[_0x507a26(0x17c)]((_0x588952,_0x36a7f4)=>{const _0x64b957=_0x507a26;_0x588952[_0x64b957(0x126)]?(_0x35eb7e[_0x36a7f4][_0x64b957(0x143)]=_0x588952['id'],_0x35eb7e[_0x36a7f4]['isRetrieved']=!![]):_0x262549[_0x64b957(0x118)](..._0x588952[_0x64b957(0x145)]);});if(_0x262549['length'])throw new salesforce_dml_error_1[(_0x507a26(0x15e))](_0x262549);}[a406_0x3dc3ea(0x12d)](_0x1de295){const _0x8faf24=a406_0x3dc3ea;return _0x1de295['map'](_0x13e280=>({'ParentId':this['_snapshotId'],'Name':_0x13e280[_0x8faf24(0x182)],'ContentType':'application/zip','Body':_0x13e280[_0x8faf24(0x15d)],'Description':_0x13e280[_0x8faf24(0x182)]}));}async[a406_0x3dc3ea(0x179)](_0x3d02bc){const _0x4a2798=a406_0x3dc3ea,_0x7cabdf={[constants_1[_0x4a2798(0x124)]+_0x4a2798(0x149)]:!![],[constants_1[_0x4a2798(0x124)]+_0x4a2798(0x147)]:!_0x3d02bc},_0xbf899c={[constants_1[_0x4a2798(0x124)]+_0x4a2798(0x147)]:!_0x3d02bc,[constants_1[_0x4a2798(0x124)]+_0x4a2798(0x171)]:_0x3d02bc,[constants_1[_0x4a2798(0x124)]+'Status__c']:_0x3d02bc?status_enums_1[_0x4a2798(0x17f)]['COMPLETED']:status_enums_1[_0x4a2798(0x17f)][_0x4a2798(0x187)],[constants_1[_0x4a2798(0x124)]+_0x4a2798(0x152)]:!![]};await this[_0x4a2798(0x13a)][_0x4a2798(0x12e)](flosum_constants_1[_0x4a2798(0x180)][_0x4a2798(0x141)]+'/'+constants_1[_0x4a2798(0x124)]+_0x4a2798(0x159)+this[_0x4a2798(0x16e)],_0x7cabdf),await this['_connectionSalesforce'][_0x4a2798(0x12e)](flosum_constants_1[_0x4a2798(0x180)][_0x4a2798(0x141)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x4a2798(0x167)+this[_0x4a2798(0x18a)],_0xbf899c),this[_0x4a2798(0x14e)]['log']('Snapshot\x20completed\x20'+(_0x3d02bc?_0x4a2798(0x157):'with\x20error')+'.'),await this[_0x4a2798(0x14e)]['updateLog']();}}function a406_0x4f0a(){const _0x36b308=['__esModule','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','_selectedComponentMap','error','3284075HAUeNf','transformDependencyFile','parse','Cannot\x20Save\x20Metadata\x20Items','../classes/errors/salesforce-dml-error','csv-parse/sync','apiName','FLOSUM_NAMESPACE','stringify','success','Saving\x20','search','sep','files','jszip','__importDefault','formAttachments','patch','base64','Attachment_ID__c','Snapshot__c','Saving\x20Attachments.','./package-export.service','path','_salesforceService','1789744qrPUYd','retrieveVeevaComponents','25139934ntrtjT','MetadataItemDto','_connectionSalesforce','async','Veeva_Component_Type__c','127829wFjvDy','insertMultipleRecords','../../../constants','join','ENDPOINT_UPSERT_RECORD','file','attachmentId','./salesforce.service','errors','MDL_EXTENSION','Is_Error__c','VeevaConstants','Is_Completed__c','_whereClause','posix','Is_Retrieved__c','Snapshot\x20started.','_logger','_systemLogger','Label__c','866369QoSXRi','Job_Completed__c','30FzIhDK','1344710WhNZcZ','TypeVeevaComponentRetriever','toString','successfully','./veeva.service','Snapshot__c/','Last_Modified_Date__c','\x20from\x20outbound\x20package','Metadata_Item__c','body','SalesforceDmlError','generateAsync','filter','_connectionVeeva','updateLog','3czEZpT','(((.+)+)+)+$','constructor','string','Metadata_Log__c/','createMetadataItemListWithBody','../dtos/metadata-item.dto','Cannot\x20retrieve\x20','ATTACHMENT','name','_veevaService','_snapshotId','log','TypeAndNameVeevaComponentRetriever','Succeed__c','label','set','DEPENDENCY_EXTENSION','csv-stringify/sync','SnapshotService','retrieve','saveComponentsInSalesforce','finishSnapshot','../constants/veeva.constants','formMetadataItemDtoList','forEach','PackageExportService','../enums/status.enums','MetadataLogStatus','FlosumConstants','Snapshot','veevaComponentType','lastModifiedDate','_selectedMetaTypes','default','from','EXCEPTION','logError','99444GfONrW','_metadataLogId','type','saveAttachments','map','_packageExportService','apply','get','push'];a406_0x4f0a=function(){return _0x36b308;};return a406_0x4f0a();}exports[a406_0x3dc3ea(0x176)]=SnapshotService,SnapshotService['OUTBOUND_PACKAGE_NAME']=a406_0x3dc3ea(0x181),SnapshotService[a406_0x3dc3ea(0x16b)]='Attachment';