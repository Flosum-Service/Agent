const a407_0x5989e4=a407_0x54d1;(function(_0x435732,_0x1a6bdb){const _0x2c6c65=a407_0x54d1,_0x43d041=_0x435732();while(!![]){try{const _0x2f6511=parseInt(_0x2c6c65(0x148))/0x1*(-parseInt(_0x2c6c65(0x13e))/0x2)+-parseInt(_0x2c6c65(0x137))/0x3+parseInt(_0x2c6c65(0x106))/0x4+parseInt(_0x2c6c65(0xe0))/0x5+-parseInt(_0x2c6c65(0x144))/0x6+-parseInt(_0x2c6c65(0xf6))/0x7+parseInt(_0x2c6c65(0x127))/0x8;if(_0x2f6511===_0x1a6bdb)break;else _0x43d041['push'](_0x43d041['shift']());}catch(_0x28f19f){_0x43d041['push'](_0x43d041['shift']());}}}(a407_0x44b8,0x81c8c));const a407_0x3b0f4f=(function(){let _0x42053a=!![];return function(_0x2afec9,_0x56c459){const _0x41b5dd=_0x42053a?function(){const _0xe17c5=a407_0x54d1;if(_0x56c459){const _0x321917=_0x56c459[_0xe17c5(0xd9)](_0x2afec9,arguments);return _0x56c459=null,_0x321917;}}:function(){};return _0x42053a=![],_0x41b5dd;};}()),a407_0x5375bf=a407_0x3b0f4f(this,function(){const _0x2f4bf2=a407_0x54d1;return a407_0x5375bf[_0x2f4bf2(0x11f)]()[_0x2f4bf2(0x130)]('(((.+)+)+)+$')[_0x2f4bf2(0x11f)]()[_0x2f4bf2(0x11c)](a407_0x5375bf)[_0x2f4bf2(0x130)](_0x2f4bf2(0x132));});function a407_0x44b8(){const _0x248782=['apiName','1jqWwzq','snapshotId','log','values','Snapshot\x20started.','../constants/veeva.constants','TypeAndNameVeevaComponentRetriever','default','updateLog','transformDependencyFile','apply','veevaComponentType','posix','isRetrieved','string','Unpack\x20zip\x20and\x20create\x20metadata\x20items.','_selectedMetaTypes','4463355NUSBrN','MetadataLogStatus','saveAttachments','Saving\x20Attachments.','Status__c','csv-stringify/sync','FLOSUM_NAMESPACE','export','label','_connectionVeeva','_salesforceService','get','Is_Retrieved__c','API_Name__c','Is_Completed__c','filter','Saving\x20','insertMultipleRecords','length','SalesforceDmlError','Snapshot\x20completed\x20','finishSnapshot','2696757avrbea','attachmentId','createMetadataItemListWithBody','MetadataItemDto','PackageExportService','sep','patch','_selectedComponentMap','FlosumConstants','_logger','errors','Attachment_ID__c','Cannot\x20retrieve\x20','success','map','Is_Error__c','300624BjJcIj','ATTACHMENT','catch','Label__c','EXCEPTION','async','has','name','__esModule','execute','formMetadataItemDtoList','../enums/status.enums','Attachment','type','_whereClause','Veeva_Component_Type__c','join','ENDPOINT_UPSERT_RECORD','VeevaConstants','from','saveComponentsInSalesforce','Job_Completed__c','constructor','forEach','defineProperty','toString','\x20Metadata\x20Items','../classes/errors/salesforce-dml-error','application/zip','file','push','Snapshot','_packageExportService','8670688CuCkDN','__importDefault','VeevaService','_snapshotId','SnapshotService','_veevaService','logError','COMPLETED','body','search','parse','(((.+)+)+)+$','retrieveVeevaComponents','lastModifiedDate','base64','OUTBOUND_PACKAGE_NAME','693153kRfHak','stringify','error','_metadataLogId','Succeed__c','Name__c','_connectionSalesforce','922494KnvqhR','successfully','formAttachments','Metadata_Item__c','MDL_EXTENSION','Metadata_Log__c/','2655108iMlxPM','./salesforce.service','csv-parse/sync'];a407_0x44b8=function(){return _0x248782;};return a407_0x44b8();}a407_0x5375bf();function a407_0x54d1(_0x3f1ee6,_0x13b307){const _0x21dae1=a407_0x44b8();return a407_0x54d1=function(_0x5375bf,_0x3b0f4f){_0x5375bf=_0x5375bf-0xd1;let _0x44b828=_0x21dae1[_0x5375bf];return _0x44b828;},a407_0x54d1(_0x3f1ee6,_0x13b307);}'use strict';var __importDefault=this&&this[a407_0x5989e4(0x128)]||function(_0x3a3535){return _0x3a3535&&_0x3a3535['__esModule']?_0x3a3535:{'default':_0x3a3535};};Object[a407_0x5989e4(0x11e)](exports,a407_0x5989e4(0x10e),{'value':!![]}),exports['SnapshotService']=void 0x0;const jszip_1=__importDefault(require('jszip')),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require('./veeva.service'),metadata_item_dto_1=require('../dtos/metadata-item.dto'),constants_1=require('../../../constants'),salesforce_service_1=require(a407_0x5989e4(0x145)),status_enums_1=require(a407_0x5989e4(0x111)),salesforce_dml_error_1=require(a407_0x5989e4(0x121)),package_export_service_1=require('./package-export.service'),type_and_name_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever'),type_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/type.veeva-component.retriever'),sync_1=require(a407_0x5989e4(0x146)),sync_2=require(a407_0x5989e4(0xe5)),veeva_constants_1=require(a407_0x5989e4(0xd4)),path_1=__importDefault(require('path'));class SnapshotService{constructor({snapshotId:_0x13fef8,metadataLogId:_0x2768ad,selectedMetaTypes:_0x2e1af0,selectedComponentMap:_0x38e4d1,whereClause:_0x160c5d},_0x1fef83,_0x2601a1,_0x20bcb4){const _0x46d483=a407_0x5989e4;this['_connectionSalesforce']=_0x1fef83,this[_0x46d483(0xe9)]=_0x2601a1,this['_logger']=_0x20bcb4,this[_0x46d483(0x12a)]=_0x13fef8,this[_0x46d483(0x13a)]=_0x2768ad,this[_0x46d483(0xdf)]=_0x2e1af0,this[_0x46d483(0xfd)]=_0x38e4d1,this[_0x46d483(0x114)]=_0x160c5d,this[_0x46d483(0x12c)]=new veeva_service_1[(_0x46d483(0x129))]({'connection':this['_connectionVeeva'],'logger':this['_logger']}),this[_0x46d483(0xea)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x46d483(0x13d)]}),this[_0x46d483(0x126)]=new package_export_service_1[(_0x46d483(0xfa))]({'veevaService':this['_veevaService'],'connection':this[_0x46d483(0xe9)],'logger':this[_0x46d483(0xff)]});}async[a407_0x5989e4(0x10f)](){const _0x4439da=a407_0x5989e4;try{this['_logger']['log'](_0x4439da(0xd3));const _0x68b605=await this[_0x4439da(0x133)]();await this[_0x4439da(0xff)][_0x4439da(0xd7)]();const _0x310308=await this[_0x4439da(0x126)][_0x4439da(0xe7)](_0x68b605,SnapshotService[_0x4439da(0x136)]);await this['_logger'][_0x4439da(0xd7)]();const _0x201bf4=await this[_0x4439da(0xf8)](_0x68b605,_0x310308);await this[_0x4439da(0x11a)](_0x201bf4),await this[_0x4439da(0xff)][_0x4439da(0xd7)](),await this[_0x4439da(0xf5)](!![]);}catch(_0x574b90){this['_logger'][_0x4439da(0x12d)](_0x574b90),await this[_0x4439da(0xf5)](![])[_0x4439da(0x108)](_0x348431=>this['_systemLogger'][_0x4439da(0x139)](_0x348431));}}async[a407_0x5989e4(0x133)](){const _0x161b9b=a407_0x5989e4,_0x4194ca={'veevaService':this['_veevaService'],'logger':this['_logger']},_0x1f5696=Array[_0x161b9b(0x119)](Object[_0x161b9b(0xd2)](this['_selectedComponentMap']))['length']?new type_and_name_veeva_component_retriever_1[(_0x161b9b(0xd5))]({'value':this[_0x161b9b(0xfd)],..._0x4194ca}):new type_veeva_component_retriever_1['TypeVeevaComponentRetriever']({'value':this['_selectedMetaTypes'],'whereClause':this[_0x161b9b(0x114)],..._0x4194ca});return _0x1f5696['retrieve']();}async[a407_0x5989e4(0xf8)](_0xc9e4d4,_0x21ce57){const _0x339d9a=a407_0x5989e4;var _0x254587,_0x353b4d;this['_logger'][_0x339d9a(0xd1)](_0x339d9a(0xde));const _0x1bfb50=this[_0x339d9a(0x110)](_0xc9e4d4),_0xaf1239=_0x1bfb50['reduce']((_0x2d976d,_0x38ccc7)=>_0x2d976d['set'](_0x38ccc7[_0x339d9a(0xe8)],_0x38ccc7),new Map());for(const _0x54291c of _0x21ce57){for(const _0x5c7931 in _0x54291c['files']){const {base:_0x3630d3,name:_0x3afd2d,dir:_0xb3326}=path_1[_0x339d9a(0xd6)][_0x339d9a(0x131)](_0x5c7931),_0x3bb6a1=_0x3afd2d+veeva_constants_1[_0x339d9a(0x118)]['DEPENDENCY_EXTENSION'];if(_0xaf1239[_0x339d9a(0x10c)](_0x3630d3)){const _0x5bd4e2=await((_0x254587=_0x54291c[_0x339d9a(0x123)]([_0xb3326,_0x3630d3][_0x339d9a(0x116)](path_1[_0x339d9a(0xd6)][_0x339d9a(0xdb)][_0x339d9a(0xfb)])))===null||_0x254587===void 0x0?void 0x0:_0x254587['async'](_0x339d9a(0xdd))),_0x5764c5=await((_0x353b4d=_0x54291c['file']([_0xb3326,_0x3bb6a1]['join'](path_1['default'][_0x339d9a(0xdb)][_0x339d9a(0xfb)])))===null||_0x353b4d===void 0x0?void 0x0:_0x353b4d[_0x339d9a(0x10b)]('string'));if(_0x5bd4e2){const _0x2050fd=new jszip_1[(_0x339d9a(0xd6))]();_0x2050fd[_0x339d9a(0x123)](_0x3630d3,_0x5bd4e2),_0x5764c5&&_0x2050fd[_0x339d9a(0x123)](_0x3bb6a1,this[_0x339d9a(0xd8)](_0x5764c5)),_0xaf1239[_0x339d9a(0xeb)](_0x3630d3)[_0x339d9a(0x12f)]=await _0x2050fd['generateAsync']({'type':_0x339d9a(0x135)});}}}}return _0x1bfb50['filter'](_0x3477c6=>!_0x3477c6[_0x339d9a(0x12f)])[_0x339d9a(0x11d)](_0x4e7fb7=>{const _0x22edfe=_0x339d9a;this[_0x22edfe(0xff)][_0x22edfe(0xd1)](_0x22edfe(0x102)+_0x4e7fb7[_0x22edfe(0xda)]+'.'+_0x4e7fb7[_0x22edfe(0x10d)]+'\x20from\x20outbound\x20package');}),_0x1bfb50[_0x339d9a(0xef)](_0x50be7a=>_0x50be7a['body']);}[a407_0x5989e4(0xd8)](_0x49d900){const _0x3544f9=a407_0x5989e4,_0x2a247a=(0x0,sync_1[_0x3544f9(0x131)])(_0x49d900,{'columns':!![],'skip_empty_lines':!![]}),_0x5d4ab1=_0x2a247a[_0x3544f9(0x104)](({'In\x20Package':_0x11fef5,..._0x1d2f69})=>_0x1d2f69);return(0x0,sync_2[_0x3544f9(0x138)])(_0x5d4ab1,{'header':!![]});}[a407_0x5989e4(0x110)](_0x3a2a21){const _0x428f73=a407_0x5989e4;return _0x3a2a21[_0x428f73(0x104)](_0x39cbe2=>{const _0x574e1c=_0x428f73,_0x63f447=new metadata_item_dto_1[(_0x574e1c(0xf9))]();return _0x63f447[_0x574e1c(0x10d)]=_0x39cbe2[_0x574e1c(0x10d)],_0x63f447[_0x574e1c(0x147)]=_0x39cbe2['name'],_0x63f447[_0x574e1c(0x149)]=this[_0x574e1c(0x12a)],_0x63f447[_0x574e1c(0xe8)]=_0x39cbe2[_0x574e1c(0x113)]+'.'+_0x39cbe2['name']+veeva_constants_1[_0x574e1c(0x118)][_0x574e1c(0x142)],_0x63f447['veevaComponentType']=_0x39cbe2[_0x574e1c(0x113)],_0x63f447[_0x574e1c(0x134)]=_0x39cbe2[_0x574e1c(0x134)],_0x63f447[_0x574e1c(0xdc)]=![],_0x63f447;});}async[a407_0x5989e4(0x11a)](_0x3d2542){const _0x26e9b6=a407_0x5989e4;this[_0x26e9b6(0xff)][_0x26e9b6(0xd1)](_0x26e9b6(0xe3)),await this[_0x26e9b6(0xe2)](_0x3d2542),this[_0x26e9b6(0xff)][_0x26e9b6(0xd1)]('Saving\x20'+_0x3d2542[_0x26e9b6(0xf2)]+_0x26e9b6(0x120));const _0xaaf318=_0x3d2542[_0x26e9b6(0x104)](_0xd79c7=>{const _0x51df8b=_0x26e9b6;return{[constants_1['FLOSUM_NAMESPACE']+_0x51df8b(0x13c)]:_0xd79c7[_0x51df8b(0x10d)],[constants_1[_0x51df8b(0xe6)]+_0x51df8b(0xed)]:_0xd79c7['apiName'],[constants_1['FLOSUM_NAMESPACE']+'Snapshot__c']:_0xd79c7['snapshotId'],[constants_1[_0x51df8b(0xe6)]+_0x51df8b(0x109)]:_0xd79c7[_0x51df8b(0xe8)],[constants_1['FLOSUM_NAMESPACE']+_0x51df8b(0xec)]:_0xd79c7['isRetrieved'],[constants_1['FLOSUM_NAMESPACE']+_0x51df8b(0x115)]:_0xd79c7[_0x51df8b(0xda)],[constants_1[_0x51df8b(0xe6)]+_0x51df8b(0x101)]:_0xd79c7[_0x51df8b(0xf7)],[constants_1[_0x51df8b(0xe6)]+'Last_Modified_Date__c']:_0xd79c7['lastModifiedDate']};}),_0x4c8cca=await this[_0x26e9b6(0xea)][_0x26e9b6(0xf1)](constants_1[_0x26e9b6(0xe6)]+_0x26e9b6(0x141),_0xaaf318);let _0x243c10=!![];_0x4c8cca[_0x26e9b6(0x11d)]((_0x14987f,_0x1f494e)=>{const _0x27ca64=_0x26e9b6;this[_0x27ca64(0xff)]['log'](_0x27ca64(0xf0)+_0x3d2542[_0x1f494e][_0x27ca64(0xda)]+'.'+_0x3d2542[_0x1f494e][_0x27ca64(0x10d)]);if(!_0x14987f[_0x27ca64(0x103)]){_0x243c10=![];const _0xc00fce=new salesforce_dml_error_1[(_0x27ca64(0xf3))](_0x14987f[_0x27ca64(0x100)]);this[_0x27ca64(0xff)][_0x27ca64(0x12d)](_0xc00fce);}});if(!_0x243c10)throw new Error('Cannot\x20Save\x20Metadata\x20Items');}async[a407_0x5989e4(0xe2)](_0x5d7ae6){const _0x3f3977=a407_0x5989e4,_0x1a37f4=this[_0x3f3977(0x140)](_0x5d7ae6),_0x1a6132=await this[_0x3f3977(0xea)][_0x3f3977(0xf1)](SnapshotService[_0x3f3977(0x107)],_0x1a37f4),_0x21b42c=[];_0x1a6132[_0x3f3977(0x11d)]((_0x2ee652,_0x37fb0c)=>{const _0x570acf=_0x3f3977;_0x2ee652['success']?(_0x5d7ae6[_0x37fb0c][_0x570acf(0xf7)]=_0x2ee652['id'],_0x5d7ae6[_0x37fb0c]['isRetrieved']=!![]):_0x21b42c[_0x570acf(0x124)](..._0x2ee652[_0x570acf(0x100)]);});if(_0x21b42c['length'])throw new salesforce_dml_error_1[(_0x3f3977(0xf3))](_0x21b42c);}['formAttachments'](_0x319534){const _0x505b8b=a407_0x5989e4;return _0x319534[_0x505b8b(0x104)](_0x2babd0=>({'ParentId':this[_0x505b8b(0x12a)],'Name':_0x2babd0[_0x505b8b(0xda)],'ContentType':_0x505b8b(0x122),'Body':_0x2babd0['body'],'Description':_0x2babd0[_0x505b8b(0xda)]}));}async[a407_0x5989e4(0xf5)](_0x17fa64){const _0x360813=a407_0x5989e4,_0x4b51ea={[constants_1['FLOSUM_NAMESPACE']+_0x360813(0xee)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x360813(0x105)]:!_0x17fa64},_0x266888={[constants_1['FLOSUM_NAMESPACE']+_0x360813(0x105)]:!_0x17fa64,[constants_1[_0x360813(0xe6)]+_0x360813(0x13b)]:_0x17fa64,[constants_1[_0x360813(0xe6)]+_0x360813(0xe4)]:_0x17fa64?status_enums_1['MetadataLogStatus'][_0x360813(0x12e)]:status_enums_1[_0x360813(0xe1)][_0x360813(0x10a)],[constants_1[_0x360813(0xe6)]+_0x360813(0x11b)]:!![]};await this[_0x360813(0x13d)][_0x360813(0xfc)](flosum_constants_1[_0x360813(0xfe)][_0x360813(0x117)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Snapshot__c/'+this['_snapshotId'],_0x4b51ea),await this['_connectionSalesforce'][_0x360813(0xfc)](flosum_constants_1[_0x360813(0xfe)][_0x360813(0x117)]+'/'+constants_1[_0x360813(0xe6)]+_0x360813(0x143)+this[_0x360813(0x13a)],_0x266888),this[_0x360813(0xff)][_0x360813(0xd1)](_0x360813(0xf4)+(_0x17fa64?_0x360813(0x13f):'with\x20error')+'.'),await this['_logger'][_0x360813(0xd7)]();}}exports[a407_0x5989e4(0x12b)]=SnapshotService,SnapshotService[a407_0x5989e4(0x136)]=a407_0x5989e4(0x125),SnapshotService[a407_0x5989e4(0x107)]=a407_0x5989e4(0x112);