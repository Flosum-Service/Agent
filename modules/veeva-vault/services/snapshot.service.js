const a407_0x208c32=a407_0x272c;(function(_0xfa18ef,_0xedce60){const _0x22fc86=a407_0x272c,_0x247b29=_0xfa18ef();while(!![]){try{const _0x4308ee=-parseInt(_0x22fc86(0x257))/0x1*(parseInt(_0x22fc86(0x240))/0x2)+-parseInt(_0x22fc86(0x222))/0x3*(parseInt(_0x22fc86(0x255))/0x4)+-parseInt(_0x22fc86(0x1ff))/0x5*(-parseInt(_0x22fc86(0x26b))/0x6)+-parseInt(_0x22fc86(0x266))/0x7*(parseInt(_0x22fc86(0x1fd))/0x8)+parseInt(_0x22fc86(0x25f))/0x9*(-parseInt(_0x22fc86(0x24a))/0xa)+parseInt(_0x22fc86(0x26a))/0xb+-parseInt(_0x22fc86(0x258))/0xc*(-parseInt(_0x22fc86(0x226))/0xd);if(_0x4308ee===_0xedce60)break;else _0x247b29['push'](_0x247b29['shift']());}catch(_0xff66a1){_0x247b29['push'](_0x247b29['shift']());}}}(a407_0x3959,0x5f04d));const a407_0x53cd1b=(function(){let _0x4c7992=!![];return function(_0x330968,_0x290cee){const _0x15d8ba=_0x4c7992?function(){const _0x3988e7=a407_0x272c;if(_0x290cee){const _0x1f80ef=_0x290cee[_0x3988e7(0x250)](_0x330968,arguments);return _0x290cee=null,_0x1f80ef;}}:function(){};return _0x4c7992=![],_0x15d8ba;};}()),a407_0x5b9dfd=a407_0x53cd1b(this,function(){const _0x529058=a407_0x272c;return a407_0x5b9dfd[_0x529058(0x244)]()[_0x529058(0x22a)](_0x529058(0x21d))[_0x529058(0x244)]()['constructor'](a407_0x5b9dfd)[_0x529058(0x22a)](_0x529058(0x21d));});a407_0x5b9dfd();'use strict';function a407_0x3959(){const _0x4b862c=['body','with\x20error','Label__c','generateAsync','async','length','Metadata_Item__c','export','createMetadataItemListWithBody','\x20from\x20outbound\x20package','MetadataLogStatus','path','has','__esModule','API_Name__c','Saving\x20','success','(((.+)+)+)+$','FLOSUM_NAMESPACE','__importDefault','_connectionSalesforce','logError','147498drcQOe','join','file','snapshotId','1098617EHLGBO','OUTBOUND_PACKAGE_NAME','lastModifiedDate','_veevaService','search','Metadata_Log__c/','Is_Retrieved__c','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','FlosumConstants','Snapshot','updateLog','catch','saveAttachments','reduce','VeevaService','values','Name__c','csv-stringify/sync','_connectionVeeva','set','_whereClause','../classes/retrievers/veeva-components/type.veeva-component.retriever','apiName','attachmentId','EXCEPTION','Succeed__c','566TVDTig','Job_Completed__c','Cannot\x20Save\x20Metadata\x20Items','_selectedMetaTypes','toString','PackageExportService','SalesforceDmlError','Cannot\x20retrieve\x20','sep','name','1371850HquKRe','DEPENDENCY_EXTENSION','_packageExportService','SnapshotService','../dtos/metadata-item.dto','saveComponentsInSalesforce','apply','Is_Completed__c','../enums/status.enums','execute','string','44cbjmGK','MDL_EXTENSION','1195JKMLUb','156fIzdlY','patch','./package-export.service','_snapshotId','forEach','map','./salesforce.service','9PUwBqp','label','successfully','\x20Metadata\x20Items','../../../constants','stringify','Snapshot\x20completed\x20','581qOQMmk','formMetadataItemDtoList','defineProperty','COMPLETED','3182916ExNTte','2082108NZOUjb','VeevaConstants','Last_Modified_Date__c','isRetrieved','base64','_selectedComponentMap','./veeva.service','ATTACHMENT','Attachment_ID__c','posix','retrieveVeevaComponents','_metadataLogId','retrieve','TypeVeevaComponentRetriever','finishSnapshot','insertMultipleRecords','get','formAttachments','65216BTVUam','../classes/errors/salesforce-dml-error','10RzRzKp','veevaComponentType','SalesforceService','Is_Error__c','transformDependencyFile','Snapshot__c','_salesforceService','_systemLogger','Veeva_Component_Type__c','filter','default','log','_logger'];a407_0x3959=function(){return _0x4b862c;};return a407_0x3959();}var __importDefault=this&&this[a407_0x208c32(0x21f)]||function(_0x220939){return _0x220939&&_0x220939['__esModule']?_0x220939:{'default':_0x220939};};Object[a407_0x208c32(0x268)](exports,a407_0x208c32(0x219),{'value':!![]}),exports[a407_0x208c32(0x24d)]=void 0x0;const jszip_1=__importDefault(require('jszip')),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a407_0x208c32(0x1f1)),metadata_item_dto_1=require(a407_0x208c32(0x24e)),constants_1=require(a407_0x208c32(0x263)),salesforce_service_1=require(a407_0x208c32(0x25e)),status_enums_1=require(a407_0x208c32(0x252)),salesforce_dml_error_1=require(a407_0x208c32(0x1fe)),package_export_service_1=require(a407_0x208c32(0x25a)),type_and_name_veeva_component_retriever_1=require(a407_0x208c32(0x22d)),type_veeva_component_retriever_1=require(a407_0x208c32(0x23b)),sync_1=require('csv-parse/sync'),sync_2=require(a407_0x208c32(0x237)),veeva_constants_1=require('../constants/veeva.constants'),path_1=__importDefault(require(a407_0x208c32(0x217)));function a407_0x272c(_0x4e61f7,_0x27e813){const _0x1bb039=a407_0x3959();return a407_0x272c=function(_0x5b9dfd,_0x53cd1b){_0x5b9dfd=_0x5b9dfd-0x1ef;let _0x3959a5=_0x1bb039[_0x5b9dfd];return _0x3959a5;},a407_0x272c(_0x4e61f7,_0x27e813);}class SnapshotService{constructor({snapshotId:_0x18e7f6,metadataLogId:_0x160c90,selectedMetaTypes:_0x10cbec,selectedComponentMap:_0x33798e,whereClause:_0x478b06},_0x43d485,_0x5e752c,_0x437698){const _0x2e62af=a407_0x208c32;this['_connectionSalesforce']=_0x43d485,this[_0x2e62af(0x238)]=_0x5e752c,this['_logger']=_0x437698,this['_snapshotId']=_0x18e7f6,this[_0x2e62af(0x1f6)]=_0x160c90,this[_0x2e62af(0x243)]=_0x10cbec,this[_0x2e62af(0x1f0)]=_0x33798e,this[_0x2e62af(0x23a)]=_0x478b06,this[_0x2e62af(0x229)]=new veeva_service_1[(_0x2e62af(0x234))]({'connection':this['_connectionVeeva'],'logger':this[_0x2e62af(0x20b)]}),this[_0x2e62af(0x205)]=new salesforce_service_1[(_0x2e62af(0x201))]({'connection':this['_connectionSalesforce']}),this[_0x2e62af(0x24c)]=new package_export_service_1[(_0x2e62af(0x245))]({'veevaService':this[_0x2e62af(0x229)],'connection':this[_0x2e62af(0x238)],'logger':this[_0x2e62af(0x20b)]});}async[a407_0x208c32(0x253)](){const _0x3d1230=a407_0x208c32;try{this[_0x3d1230(0x20b)]['log']('Snapshot\x20started.');const _0x1d8dca=await this[_0x3d1230(0x1f5)]();await this[_0x3d1230(0x20b)][_0x3d1230(0x230)]();const _0x22e4ca=await this['_packageExportService'][_0x3d1230(0x213)](_0x1d8dca,SnapshotService['OUTBOUND_PACKAGE_NAME']);await this[_0x3d1230(0x20b)][_0x3d1230(0x230)]();const _0x4acdb4=await this['createMetadataItemListWithBody'](_0x1d8dca,_0x22e4ca);await this[_0x3d1230(0x24f)](_0x4acdb4),await this[_0x3d1230(0x20b)][_0x3d1230(0x230)](),await this[_0x3d1230(0x1f9)](!![]);}catch(_0x4f6ecd){this[_0x3d1230(0x20b)][_0x3d1230(0x221)](_0x4f6ecd),await this[_0x3d1230(0x1f9)](![])[_0x3d1230(0x231)](_0x348189=>this[_0x3d1230(0x206)]['error'](_0x348189));}}async[a407_0x208c32(0x1f5)](){const _0x3a31d6=a407_0x208c32,_0x4f337f={'veevaService':this[_0x3a31d6(0x229)],'logger':this['_logger']},_0x3902a1=Array['from'](Object[_0x3a31d6(0x235)](this[_0x3a31d6(0x1f0)]))['length']?new type_and_name_veeva_component_retriever_1['TypeAndNameVeevaComponentRetriever']({'value':this[_0x3a31d6(0x1f0)],..._0x4f337f}):new type_veeva_component_retriever_1[(_0x3a31d6(0x1f8))]({'value':this[_0x3a31d6(0x243)],'whereClause':this[_0x3a31d6(0x23a)],..._0x4f337f});return _0x3902a1[_0x3a31d6(0x1f7)]();}async[a407_0x208c32(0x214)](_0x5eb29d,_0x3192bb){const _0x1eef96=a407_0x208c32;var _0x30bf56,_0x444ece;this[_0x1eef96(0x20b)][_0x1eef96(0x20a)]('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x1493c9=this[_0x1eef96(0x267)](_0x5eb29d),_0x57d9aa=_0x1493c9[_0x1eef96(0x233)]((_0x564686,_0x39611d)=>_0x564686[_0x1eef96(0x239)](_0x39611d[_0x1eef96(0x260)],_0x39611d),new Map());for(const _0x5a5839 of _0x3192bb){for(const _0x107b28 in _0x5a5839['files']){const {base:_0x4ad5c5,name:_0x124373,dir:_0xf1ada6}=path_1[_0x1eef96(0x209)]['parse'](_0x107b28),_0x47c366=_0x124373+veeva_constants_1[_0x1eef96(0x26c)][_0x1eef96(0x24b)];if(_0x57d9aa[_0x1eef96(0x218)](_0x4ad5c5)){const _0x4e32e3=await((_0x30bf56=_0x5a5839[_0x1eef96(0x224)]([_0xf1ada6,_0x4ad5c5][_0x1eef96(0x223)](path_1[_0x1eef96(0x209)][_0x1eef96(0x1f4)][_0x1eef96(0x248)])))===null||_0x30bf56===void 0x0?void 0x0:_0x30bf56[_0x1eef96(0x210)](_0x1eef96(0x254))),_0x4621aa=await((_0x444ece=_0x5a5839[_0x1eef96(0x224)]([_0xf1ada6,_0x47c366][_0x1eef96(0x223)](path_1[_0x1eef96(0x209)]['posix']['sep'])))===null||_0x444ece===void 0x0?void 0x0:_0x444ece[_0x1eef96(0x210)]('string'));if(_0x4e32e3){const _0x45b879=new jszip_1[(_0x1eef96(0x209))]();_0x45b879[_0x1eef96(0x224)](_0x4ad5c5,_0x4e32e3),_0x4621aa&&_0x45b879[_0x1eef96(0x224)](_0x47c366,this['transformDependencyFile'](_0x4621aa)),_0x57d9aa[_0x1eef96(0x1fb)](_0x4ad5c5)[_0x1eef96(0x20c)]=await _0x45b879[_0x1eef96(0x20f)]({'type':_0x1eef96(0x1ef)});}}}}return _0x1493c9[_0x1eef96(0x208)](_0x1434c7=>!_0x1434c7[_0x1eef96(0x20c)])[_0x1eef96(0x25c)](_0x18abaf=>{const _0x57ec3c=_0x1eef96;this[_0x57ec3c(0x20b)][_0x57ec3c(0x20a)](_0x57ec3c(0x247)+_0x18abaf[_0x57ec3c(0x200)]+'.'+_0x18abaf[_0x57ec3c(0x249)]+_0x57ec3c(0x215));}),_0x1493c9['filter'](_0x3d242d=>_0x3d242d[_0x1eef96(0x20c)]);}[a407_0x208c32(0x203)](_0x343d82){const _0x52fe54=a407_0x208c32,_0x5a87dc=(0x0,sync_1['parse'])(_0x343d82,{'columns':!![],'skip_empty_lines':!![]}),_0xe7a62d=_0x5a87dc[_0x52fe54(0x25d)](({'In\x20Package':_0x3004cb,..._0x415d0b})=>_0x415d0b);return(0x0,sync_2[_0x52fe54(0x264)])(_0xe7a62d,{'header':!![]});}[a407_0x208c32(0x267)](_0x451405){const _0x2e79ce=a407_0x208c32;return _0x451405[_0x2e79ce(0x25d)](_0x228913=>{const _0x72aece=_0x2e79ce,_0x26f503=new metadata_item_dto_1['MetadataItemDto']();return _0x26f503[_0x72aece(0x249)]=_0x228913['name'],_0x26f503[_0x72aece(0x23c)]=_0x228913[_0x72aece(0x249)],_0x26f503[_0x72aece(0x225)]=this[_0x72aece(0x25b)],_0x26f503['label']=_0x228913['type']+'.'+_0x228913[_0x72aece(0x249)]+veeva_constants_1[_0x72aece(0x26c)][_0x72aece(0x256)],_0x26f503[_0x72aece(0x200)]=_0x228913['type'],_0x26f503['lastModifiedDate']=_0x228913[_0x72aece(0x228)],_0x26f503[_0x72aece(0x26e)]=![],_0x26f503;});}async[a407_0x208c32(0x24f)](_0x1754f7){const _0x4c2ee2=a407_0x208c32;this['_logger']['log']('Saving\x20Attachments.'),await this[_0x4c2ee2(0x232)](_0x1754f7),this[_0x4c2ee2(0x20b)][_0x4c2ee2(0x20a)](_0x4c2ee2(0x21b)+_0x1754f7[_0x4c2ee2(0x211)]+_0x4c2ee2(0x262));const _0x13e02b=_0x1754f7[_0x4c2ee2(0x25d)](_0x468040=>{const _0x630b74=_0x4c2ee2;return{[constants_1[_0x630b74(0x21e)]+_0x630b74(0x236)]:_0x468040[_0x630b74(0x249)],[constants_1['FLOSUM_NAMESPACE']+_0x630b74(0x21a)]:_0x468040[_0x630b74(0x23c)],[constants_1['FLOSUM_NAMESPACE']+_0x630b74(0x204)]:_0x468040['snapshotId'],[constants_1['FLOSUM_NAMESPACE']+_0x630b74(0x20e)]:_0x468040['label'],[constants_1[_0x630b74(0x21e)]+_0x630b74(0x22c)]:_0x468040[_0x630b74(0x26e)],[constants_1[_0x630b74(0x21e)]+_0x630b74(0x207)]:_0x468040[_0x630b74(0x200)],[constants_1['FLOSUM_NAMESPACE']+_0x630b74(0x1f3)]:_0x468040[_0x630b74(0x23d)],[constants_1[_0x630b74(0x21e)]+_0x630b74(0x26d)]:_0x468040[_0x630b74(0x228)]};}),_0x2119c4=await this['_salesforceService']['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+_0x4c2ee2(0x212),_0x13e02b);let _0x321925=!![];_0x2119c4[_0x4c2ee2(0x25c)]((_0x4d5bc6,_0x16766b)=>{const _0x1cd9f4=_0x4c2ee2;this[_0x1cd9f4(0x20b)][_0x1cd9f4(0x20a)](_0x1cd9f4(0x21b)+_0x1754f7[_0x16766b]['veevaComponentType']+'.'+_0x1754f7[_0x16766b][_0x1cd9f4(0x249)]);if(!_0x4d5bc6['success']){_0x321925=![];const _0xed2cce=new salesforce_dml_error_1[(_0x1cd9f4(0x246))](_0x4d5bc6['errors']);this['_logger'][_0x1cd9f4(0x221)](_0xed2cce);}});if(!_0x321925)throw new Error(_0x4c2ee2(0x242));}async[a407_0x208c32(0x232)](_0x1e7f8c){const _0x25d143=a407_0x208c32,_0x1a82b3=this[_0x25d143(0x1fc)](_0x1e7f8c),_0x28d898=await this['_salesforceService'][_0x25d143(0x1fa)](SnapshotService[_0x25d143(0x1f2)],_0x1a82b3),_0x4b5ca6=[];_0x28d898['forEach']((_0x288b2b,_0x220d7d)=>{const _0x239c51=_0x25d143;_0x288b2b[_0x239c51(0x21c)]?(_0x1e7f8c[_0x220d7d][_0x239c51(0x23d)]=_0x288b2b['id'],_0x1e7f8c[_0x220d7d]['isRetrieved']=!![]):_0x4b5ca6['push'](..._0x288b2b['errors']);});if(_0x4b5ca6[_0x25d143(0x211)])throw new salesforce_dml_error_1[(_0x25d143(0x246))](_0x4b5ca6);}[a407_0x208c32(0x1fc)](_0x2536e4){const _0x522e54=a407_0x208c32;return _0x2536e4[_0x522e54(0x25d)](_0x46e0d8=>({'ParentId':this['_snapshotId'],'Name':_0x46e0d8[_0x522e54(0x200)],'ContentType':'application/zip','Body':_0x46e0d8[_0x522e54(0x20c)],'Description':_0x46e0d8[_0x522e54(0x200)]}));}async[a407_0x208c32(0x1f9)](_0x1b35fa){const _0x323b43=a407_0x208c32,_0x4189ee={[constants_1[_0x323b43(0x21e)]+_0x323b43(0x251)]:!![],[constants_1[_0x323b43(0x21e)]+_0x323b43(0x202)]:!_0x1b35fa},_0x39c7ed={[constants_1['FLOSUM_NAMESPACE']+_0x323b43(0x202)]:!_0x1b35fa,[constants_1[_0x323b43(0x21e)]+_0x323b43(0x23f)]:_0x1b35fa,[constants_1[_0x323b43(0x21e)]+'Status__c']:_0x1b35fa?status_enums_1['MetadataLogStatus'][_0x323b43(0x269)]:status_enums_1[_0x323b43(0x216)][_0x323b43(0x23e)],[constants_1[_0x323b43(0x21e)]+_0x323b43(0x241)]:!![]};await this[_0x323b43(0x220)]['patch'](flosum_constants_1[_0x323b43(0x22e)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x323b43(0x21e)]+'Snapshot__c/'+this[_0x323b43(0x25b)],_0x4189ee),await this['_connectionSalesforce'][_0x323b43(0x259)](flosum_constants_1[_0x323b43(0x22e)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x323b43(0x21e)]+_0x323b43(0x22b)+this[_0x323b43(0x1f6)],_0x39c7ed),this[_0x323b43(0x20b)]['log'](_0x323b43(0x265)+(_0x1b35fa?_0x323b43(0x261):_0x323b43(0x20d))+'.'),await this[_0x323b43(0x20b)][_0x323b43(0x230)]();}}exports[a407_0x208c32(0x24d)]=SnapshotService,SnapshotService[a407_0x208c32(0x227)]=a407_0x208c32(0x22f),SnapshotService[a407_0x208c32(0x1f2)]='Attachment';