const a394_0x3e41cc=a394_0x2f4d;(function(_0x4bcbd5,_0x3270b2){const _0x13c996=a394_0x2f4d,_0x306d62=_0x4bcbd5();while(!![]){try{const _0x2de074=-parseInt(_0x13c996(0xde))/0x1+-parseInt(_0x13c996(0xd9))/0x2*(parseInt(_0x13c996(0xc0))/0x3)+-parseInt(_0x13c996(0xf4))/0x4+-parseInt(_0x13c996(0xc7))/0x5+parseInt(_0x13c996(0xf1))/0x6*(-parseInt(_0x13c996(0x12d))/0x7)+-parseInt(_0x13c996(0x125))/0x8+parseInt(_0x13c996(0xfc))/0x9*(parseInt(_0x13c996(0xea))/0xa);if(_0x2de074===_0x3270b2)break;else _0x306d62['push'](_0x306d62['shift']());}catch(_0x106a72){_0x306d62['push'](_0x306d62['shift']());}}}(a394_0x2395,0x4ac0d));function a394_0x2395(){const _0x118fc=['../../../constants','sep','type','generateAsync','SnapshotService','Last_Modified_Date__c','162nJoLeD','_whereClause','lastModifiedDate','MDL_EXTENSION','from','ATTACHMENT','get','286395TFwvGB','saveComponentsInSalesforce','finishSnapshot','Succeed__c','EXCEPTION','default','_metadataLogId','Attachment_ID__c','Saving\x20','apply','FLOSUM_NAMESPACE','logError','Unpack\x20zip\x20and\x20create\x20metadata\x20items.','__esModule','filter','_snapshotId','TypeAndNameVeevaComponentRetriever','_logger','21626ZMLLOn','path','name','veevaComponentType','file','550963uzheaG','VeevaConstants','forEach','csv-parse/sync','formMetadataItemDtoList','_systemLogger','../constants/veeva.constants','Is_Error__c','retrieve','_connectionSalesforce','OUTBOUND_PACKAGE_NAME','log','10uAlfwg','async','Is_Completed__c','apiName','../enums/status.enums','formAttachments','COMPLETED','208434zCjwUc','../constants/flosum.constants','(((.+)+)+)+$','25460eaXOhB','posix','catch','has','constructor','../classes/errors/salesforce-dml-error','map','label','18248355FnXghF','patch','body','push','_packageExportService','SalesforceDmlError','ENDPOINT_UPSERT_RECORD','defineProperty','FlosumConstants','jszip','files','../classes/retrievers/veeva-components/type.veeva-component.retriever','Status__c','Metadata_Log__c/','Job_Completed__c','Snapshot\x20started.','API_Name__c','Attachment','_selectedComponentMap','Snapshot__c/','_selectedMetaTypes','Snapshot__c','success','reduce','attachmentId','join','search','_veevaService','base64','isRetrieved','MetadataLogStatus','set','transformDependencyFile','length','./package-export.service','updateLog','Cannot\x20retrieve\x20','toString','parse','Metadata_Item__c','successfully','2793616PekYAs','Name__c','errors','_salesforceService','values','\x20from\x20outbound\x20package','snapshotId','_connectionVeeva','35FqrDVC','createMetadataItemListWithBody','insertMultipleRecords','MetadataItemDto','retrieveVeevaComponents','Snapshot','VeevaService','./salesforce.service','saveAttachments'];a394_0x2395=function(){return _0x118fc;};return a394_0x2395();}const a394_0x4fe9c8=(function(){let _0x5c64a9=!![];return function(_0x26b7fa,_0x141ae1){const _0x35b305=_0x5c64a9?function(){const _0x494ad5=a394_0x2f4d;if(_0x141ae1){const _0x2cbd82=_0x141ae1[_0x494ad5(0xd0)](_0x26b7fa,arguments);return _0x141ae1=null,_0x2cbd82;}}:function(){};return _0x5c64a9=![],_0x35b305;};}()),a394_0x5a928b=a394_0x4fe9c8(this,function(){const _0x4c3803=a394_0x2f4d;return a394_0x5a928b[_0x4c3803(0x121)]()['search']('(((.+)+)+)+$')[_0x4c3803(0x121)]()[_0x4c3803(0xf8)](a394_0x5a928b)[_0x4c3803(0x116)](_0x4c3803(0xf3));});a394_0x5a928b();function a394_0x2f4d(_0xbf1ab2,_0x1aea3e){const _0x35307f=a394_0x2395();return a394_0x2f4d=function(_0x5a928b,_0x4fe9c8){_0x5a928b=_0x5a928b-0xbd;let _0x2395b4=_0x35307f[_0x5a928b];return _0x2395b4;},a394_0x2f4d(_0xbf1ab2,_0x1aea3e);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x469c73){const _0x4fef50=a394_0x2f4d;return _0x469c73&&_0x469c73[_0x4fef50(0xd4)]?_0x469c73:{'default':_0x469c73};};Object[a394_0x3e41cc(0x103)](exports,a394_0x3e41cc(0xd4),{'value':!![]}),exports[a394_0x3e41cc(0xbe)]=void 0x0;const jszip_1=__importDefault(require(a394_0x3e41cc(0x105))),flosum_constants_1=require(a394_0x3e41cc(0xf2)),veeva_service_1=require('./veeva.service'),metadata_item_dto_1=require('../dtos/metadata-item.dto'),constants_1=require(a394_0x3e41cc(0x136)),salesforce_service_1=require(a394_0x3e41cc(0x134)),status_enums_1=require(a394_0x3e41cc(0xee)),salesforce_dml_error_1=require(a394_0x3e41cc(0xf9)),package_export_service_1=require(a394_0x3e41cc(0x11e)),type_and_name_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever'),type_veeva_component_retriever_1=require(a394_0x3e41cc(0x107)),sync_1=require(a394_0x3e41cc(0xe1)),sync_2=require('csv-stringify/sync'),veeva_constants_1=require(a394_0x3e41cc(0xe4)),path_1=__importDefault(require(a394_0x3e41cc(0xda)));class SnapshotService{constructor({snapshotId:_0x31ea5a,metadataLogId:_0x30e2e5,selectedMetaTypes:_0x4b067e,selectedComponentMap:_0x5aa52b,whereClause:_0x17202a},_0x4dfbb5,_0x5146f9,_0x2f390c){const _0x39e35a=a394_0x3e41cc;this['_connectionSalesforce']=_0x4dfbb5,this[_0x39e35a(0x12c)]=_0x5146f9,this[_0x39e35a(0xd8)]=_0x2f390c,this[_0x39e35a(0xd6)]=_0x31ea5a,this[_0x39e35a(0xcd)]=_0x30e2e5,this[_0x39e35a(0x110)]=_0x4b067e,this[_0x39e35a(0x10e)]=_0x5aa52b,this[_0x39e35a(0xc1)]=_0x17202a,this[_0x39e35a(0x117)]=new veeva_service_1[(_0x39e35a(0x133))]({'connection':this[_0x39e35a(0x12c)],'logger':this[_0x39e35a(0xd8)]}),this[_0x39e35a(0x128)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x39e35a(0xe7)]}),this[_0x39e35a(0x100)]=new package_export_service_1['PackageExportService']({'veevaService':this['_veevaService'],'connection':this[_0x39e35a(0x12c)],'logger':this[_0x39e35a(0xd8)]});}async['execute'](){const _0x3f8dc1=a394_0x3e41cc;try{this[_0x3f8dc1(0xd8)][_0x3f8dc1(0xe9)](_0x3f8dc1(0x10b));const _0x1bf524=await this[_0x3f8dc1(0x131)]();await this[_0x3f8dc1(0xd8)][_0x3f8dc1(0x11f)]();const _0x252b3b=await this['_packageExportService']['export'](_0x1bf524,SnapshotService[_0x3f8dc1(0xe8)]);await this[_0x3f8dc1(0xd8)][_0x3f8dc1(0x11f)]();const _0x17516c=await this[_0x3f8dc1(0x12e)](_0x1bf524,_0x252b3b);await this[_0x3f8dc1(0xc8)](_0x17516c),await this[_0x3f8dc1(0xd8)][_0x3f8dc1(0x11f)](),await this[_0x3f8dc1(0xc9)](!![]);}catch(_0x3d29ef){this[_0x3f8dc1(0xd8)][_0x3f8dc1(0xd2)](_0x3d29ef),await this['finishSnapshot'](![])[_0x3f8dc1(0xf6)](_0x56c11d=>this[_0x3f8dc1(0xe3)]['error'](_0x56c11d));}}async[a394_0x3e41cc(0x131)](){const _0x31689b=a394_0x3e41cc,_0x330322={'veevaService':this['_veevaService'],'logger':this[_0x31689b(0xd8)]},_0x37d8d4=Array[_0x31689b(0xc4)](Object[_0x31689b(0x129)](this[_0x31689b(0x10e)]))[_0x31689b(0x11d)]?new type_and_name_veeva_component_retriever_1[(_0x31689b(0xd7))]({'value':this[_0x31689b(0x10e)],..._0x330322}):new type_veeva_component_retriever_1['TypeVeevaComponentRetriever']({'value':this[_0x31689b(0x110)],'whereClause':this[_0x31689b(0xc1)],..._0x330322});return _0x37d8d4[_0x31689b(0xe6)]();}async['createMetadataItemListWithBody'](_0x15c14d,_0x192e04){const _0x1308f1=a394_0x3e41cc;var _0x2a4641,_0x6c9f01;this['_logger'][_0x1308f1(0xe9)](_0x1308f1(0xd3));const _0x5f2b39=this[_0x1308f1(0xe2)](_0x15c14d),_0xbbf018=_0x5f2b39[_0x1308f1(0x113)]((_0x41e7a4,_0x595cb7)=>_0x41e7a4[_0x1308f1(0x11b)](_0x595cb7['label'],_0x595cb7),new Map());for(const _0x124340 of _0x192e04){for(const _0xce95a7 in _0x124340[_0x1308f1(0x106)]){const {base:_0x1acb26,name:_0x3c150b,dir:_0x103a93}=path_1[_0x1308f1(0xcc)][_0x1308f1(0x122)](_0xce95a7),_0x92b986=_0x3c150b+veeva_constants_1[_0x1308f1(0xdf)]['DEPENDENCY_EXTENSION'];if(_0xbbf018[_0x1308f1(0xf7)](_0x1acb26)){const _0x33cc37=await((_0x2a4641=_0x124340[_0x1308f1(0xdd)]([_0x103a93,_0x1acb26][_0x1308f1(0x115)](path_1['default'][_0x1308f1(0xf5)]['sep'])))===null||_0x2a4641===void 0x0?void 0x0:_0x2a4641[_0x1308f1(0xeb)]('string')),_0x5c9f54=await((_0x6c9f01=_0x124340[_0x1308f1(0xdd)]([_0x103a93,_0x92b986]['join'](path_1['default'][_0x1308f1(0xf5)][_0x1308f1(0x137)])))===null||_0x6c9f01===void 0x0?void 0x0:_0x6c9f01[_0x1308f1(0xeb)]('string'));if(_0x33cc37){const _0x12b71e=new jszip_1[(_0x1308f1(0xcc))]();_0x12b71e[_0x1308f1(0xdd)](_0x1acb26,_0x33cc37),_0x5c9f54&&_0x12b71e[_0x1308f1(0xdd)](_0x92b986,this['transformDependencyFile'](_0x5c9f54)),_0xbbf018[_0x1308f1(0xc6)](_0x1acb26)[_0x1308f1(0xfe)]=await _0x12b71e[_0x1308f1(0xbd)]({'type':_0x1308f1(0x118)});}}}}return _0x5f2b39[_0x1308f1(0xd5)](_0x2884f3=>!_0x2884f3[_0x1308f1(0xfe)])[_0x1308f1(0xe0)](_0x4f5f6c=>{const _0x4fc2b1=_0x1308f1;this['_logger'][_0x4fc2b1(0xe9)](_0x4fc2b1(0x120)+_0x4f5f6c[_0x4fc2b1(0xdc)]+'.'+_0x4f5f6c[_0x4fc2b1(0xdb)]+_0x4fc2b1(0x12a));}),_0x5f2b39[_0x1308f1(0xd5)](_0x52193a=>_0x52193a[_0x1308f1(0xfe)]);}[a394_0x3e41cc(0x11c)](_0x5eb6b2){const _0x513b96=a394_0x3e41cc,_0x494eff=(0x0,sync_1['parse'])(_0x5eb6b2,{'columns':!![],'skip_empty_lines':!![]}),_0x4edc3b=_0x494eff[_0x513b96(0xfa)](({'In\x20Package':_0x592ad0,..._0x10fd2c})=>_0x10fd2c);return(0x0,sync_2['stringify'])(_0x4edc3b,{'header':!![]});}['formMetadataItemDtoList'](_0x120c45){return _0x120c45['map'](_0x237402=>{const _0x102581=a394_0x2f4d,_0x33f2b3=new metadata_item_dto_1[(_0x102581(0x130))]();return _0x33f2b3['name']=_0x237402[_0x102581(0xdb)],_0x33f2b3[_0x102581(0xed)]=_0x237402[_0x102581(0xdb)],_0x33f2b3['snapshotId']=this[_0x102581(0xd6)],_0x33f2b3[_0x102581(0xfb)]=_0x237402['type']+'.'+_0x237402[_0x102581(0xdb)]+veeva_constants_1[_0x102581(0xdf)][_0x102581(0xc3)],_0x33f2b3[_0x102581(0xdc)]=_0x237402[_0x102581(0x138)],_0x33f2b3[_0x102581(0xc2)]=_0x237402[_0x102581(0xc2)],_0x33f2b3[_0x102581(0x119)]=![],_0x33f2b3;});}async[a394_0x3e41cc(0xc8)](_0x34d950){const _0x485e75=a394_0x3e41cc;this[_0x485e75(0xd8)]['log']('Saving\x20Attachments.'),await this[_0x485e75(0x135)](_0x34d950),this[_0x485e75(0xd8)][_0x485e75(0xe9)](_0x485e75(0xcf)+_0x34d950[_0x485e75(0x11d)]+'\x20Metadata\x20Items');const _0xa24c2d=_0x34d950[_0x485e75(0xfa)](_0x44a16f=>{const _0x189807=_0x485e75;return{[constants_1[_0x189807(0xd1)]+_0x189807(0x126)]:_0x44a16f[_0x189807(0xdb)],[constants_1['FLOSUM_NAMESPACE']+_0x189807(0x10c)]:_0x44a16f[_0x189807(0xed)],[constants_1[_0x189807(0xd1)]+_0x189807(0x111)]:_0x44a16f[_0x189807(0x12b)],[constants_1['FLOSUM_NAMESPACE']+'Label__c']:_0x44a16f[_0x189807(0xfb)],[constants_1[_0x189807(0xd1)]+'Is_Retrieved__c']:_0x44a16f[_0x189807(0x119)],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Component_Type__c']:_0x44a16f['veevaComponentType'],[constants_1[_0x189807(0xd1)]+_0x189807(0xce)]:_0x44a16f[_0x189807(0x114)],[constants_1[_0x189807(0xd1)]+_0x189807(0xbf)]:_0x44a16f['lastModifiedDate']};}),_0x1b4ce4=await this[_0x485e75(0x128)][_0x485e75(0x12f)](constants_1[_0x485e75(0xd1)]+_0x485e75(0x123),_0xa24c2d);let _0x204d01=!![];_0x1b4ce4[_0x485e75(0xe0)]((_0x2d9a79,_0x3a0857)=>{const _0x13b431=_0x485e75;this['_logger'][_0x13b431(0xe9)](_0x13b431(0xcf)+_0x34d950[_0x3a0857][_0x13b431(0xdc)]+'.'+_0x34d950[_0x3a0857][_0x13b431(0xdb)]);if(!_0x2d9a79['success']){_0x204d01=![];const _0x27431c=new salesforce_dml_error_1[(_0x13b431(0x101))](_0x2d9a79[_0x13b431(0x127)]);this[_0x13b431(0xd8)][_0x13b431(0xd2)](_0x27431c);}});if(!_0x204d01)throw new Error('Cannot\x20Save\x20Metadata\x20Items');}async[a394_0x3e41cc(0x135)](_0x2a3061){const _0x32ee36=a394_0x3e41cc,_0x5a9ed7=this[_0x32ee36(0xef)](_0x2a3061),_0x525f9c=await this[_0x32ee36(0x128)][_0x32ee36(0x12f)](SnapshotService[_0x32ee36(0xc5)],_0x5a9ed7),_0x25880d=[];_0x525f9c[_0x32ee36(0xe0)]((_0x207210,_0x3625f3)=>{const _0x19dfc4=_0x32ee36;_0x207210[_0x19dfc4(0x112)]?(_0x2a3061[_0x3625f3][_0x19dfc4(0x114)]=_0x207210['id'],_0x2a3061[_0x3625f3][_0x19dfc4(0x119)]=!![]):_0x25880d[_0x19dfc4(0xff)](..._0x207210[_0x19dfc4(0x127)]);});if(_0x25880d[_0x32ee36(0x11d)])throw new salesforce_dml_error_1[(_0x32ee36(0x101))](_0x25880d);}[a394_0x3e41cc(0xef)](_0x4edfdd){const _0x282f49=a394_0x3e41cc;return _0x4edfdd[_0x282f49(0xfa)](_0x50b692=>({'ParentId':this['_snapshotId'],'Name':_0x50b692[_0x282f49(0xdc)],'ContentType':'application/zip','Body':_0x50b692[_0x282f49(0xfe)],'Description':_0x50b692[_0x282f49(0xdc)]}));}async[a394_0x3e41cc(0xc9)](_0xb5d758){const _0x5455fe=a394_0x3e41cc,_0x3ee0fd={[constants_1[_0x5455fe(0xd1)]+_0x5455fe(0xec)]:!![],[constants_1[_0x5455fe(0xd1)]+_0x5455fe(0xe5)]:!_0xb5d758},_0x57e2ec={[constants_1[_0x5455fe(0xd1)]+_0x5455fe(0xe5)]:!_0xb5d758,[constants_1['FLOSUM_NAMESPACE']+_0x5455fe(0xca)]:_0xb5d758,[constants_1[_0x5455fe(0xd1)]+_0x5455fe(0x108)]:_0xb5d758?status_enums_1['MetadataLogStatus'][_0x5455fe(0xf0)]:status_enums_1[_0x5455fe(0x11a)][_0x5455fe(0xcb)],[constants_1['FLOSUM_NAMESPACE']+_0x5455fe(0x10a)]:!![]};await this['_connectionSalesforce'][_0x5455fe(0xfd)](flosum_constants_1[_0x5455fe(0x104)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x5455fe(0x10f)+this['_snapshotId'],_0x3ee0fd),await this[_0x5455fe(0xe7)][_0x5455fe(0xfd)](flosum_constants_1['FlosumConstants'][_0x5455fe(0x102)]+'/'+constants_1[_0x5455fe(0xd1)]+_0x5455fe(0x109)+this[_0x5455fe(0xcd)],_0x57e2ec),this[_0x5455fe(0xd8)][_0x5455fe(0xe9)]('Snapshot\x20completed\x20'+(_0xb5d758?_0x5455fe(0x124):'with\x20error')+'.'),await this['_logger'][_0x5455fe(0x11f)]();}}exports[a394_0x3e41cc(0xbe)]=SnapshotService,SnapshotService[a394_0x3e41cc(0xe8)]=a394_0x3e41cc(0x132),SnapshotService[a394_0x3e41cc(0xc5)]=a394_0x3e41cc(0x10d);