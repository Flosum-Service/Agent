const a378_0x23f80e=a378_0x13e0;function a378_0x13e0(_0x1d4eca,_0x1c31c5){const _0x352735=a378_0x5e0a();return a378_0x13e0=function(_0x5f1755,_0x2c60cf){_0x5f1755=_0x5f1755-0xee;let _0x5e0a93=_0x352735[_0x5f1755];return _0x5e0a93;},a378_0x13e0(_0x1d4eca,_0x1c31c5);}(function(_0x2942b5,_0x4c223f){const _0xe09e05=a378_0x13e0,_0x51f7ad=_0x2942b5();while(!![]){try{const _0x2e5b24=-parseInt(_0xe09e05(0x161))/0x1+parseInt(_0xe09e05(0x150))/0x2*(parseInt(_0xe09e05(0x164))/0x3)+-parseInt(_0xe09e05(0x160))/0x4*(parseInt(_0xe09e05(0x130))/0x5)+-parseInt(_0xe09e05(0x12b))/0x6+-parseInt(_0xe09e05(0x122))/0x7+parseInt(_0xe09e05(0x133))/0x8+-parseInt(_0xe09e05(0x137))/0x9*(-parseInt(_0xe09e05(0x10c))/0xa);if(_0x2e5b24===_0x4c223f)break;else _0x51f7ad['push'](_0x51f7ad['shift']());}catch(_0x4413aa){_0x51f7ad['push'](_0x51f7ad['shift']());}}}(a378_0x5e0a,0xbbec2));const a378_0x2c60cf=(function(){let _0x32b72d=!![];return function(_0x3b3bd2,_0x46f923){const _0x6951b6=_0x32b72d?function(){const _0x2265d3=a378_0x13e0;if(_0x46f923){const _0x2cda60=_0x46f923[_0x2265d3(0x13e)](_0x3b3bd2,arguments);return _0x46f923=null,_0x2cda60;}}:function(){};return _0x32b72d=![],_0x6951b6;};}()),a378_0x5f1755=a378_0x2c60cf(this,function(){const _0x1d810f=a378_0x13e0;return a378_0x5f1755[_0x1d810f(0x14d)]()[_0x1d810f(0x141)](_0x1d810f(0x11e))[_0x1d810f(0x14d)]()[_0x1d810f(0x15e)](a378_0x5f1755)[_0x1d810f(0x141)](_0x1d810f(0x11e));});a378_0x5f1755();'use strict';var __importDefault=this&&this[a378_0x23f80e(0x127)]||function(_0x158e05){const _0x2056a2=a378_0x23f80e;return _0x158e05&&_0x158e05[_0x2056a2(0xf6)]?_0x158e05:{'default':_0x158e05};};Object[a378_0x23f80e(0x115)](exports,a378_0x23f80e(0xf6),{'value':!![]}),exports[a378_0x23f80e(0x100)]=void 0x0;const jszip_1=__importDefault(require(a378_0x23f80e(0x116))),flosum_constants_1=require(a378_0x23f80e(0x14c)),veeva_service_1=require(a378_0x23f80e(0x112)),metadata_item_dto_1=require('../dtos/metadata-item.dto'),constants_1=require(a378_0x23f80e(0x167)),salesforce_service_1=require(a378_0x23f80e(0xff)),status_enums_1=require(a378_0x23f80e(0x10d)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),package_export_service_1=require(a378_0x23f80e(0x10a)),type_and_name_veeva_component_retriever_1=require(a378_0x23f80e(0x120)),type_veeva_component_retriever_1=require(a378_0x23f80e(0x108)),sync_1=require(a378_0x23f80e(0x147)),sync_2=require(a378_0x23f80e(0x101)),veeva_constants_1=require(a378_0x23f80e(0x13a)),path_1=__importDefault(require(a378_0x23f80e(0xf7)));class SnapshotService{constructor({snapshotId:_0xc97d06,metadataLogId:_0x13cbc4,selectedMetaTypes:_0x151058,selectedComponentMap:_0x51a049,whereClause:_0x2b18d4},_0x10ed79,_0x1626e0,_0x272a40){const _0x28269f=a378_0x23f80e;this[_0x28269f(0x158)]=_0x10ed79,this['_connectionVeeva']=_0x1626e0,this[_0x28269f(0x139)]=_0x272a40,this[_0x28269f(0x14a)]=_0xc97d06,this[_0x28269f(0x15b)]=_0x13cbc4,this[_0x28269f(0x159)]=_0x151058,this['_selectedComponentMap']=_0x51a049,this[_0x28269f(0xfc)]=_0x2b18d4,this[_0x28269f(0x13b)]=new veeva_service_1[(_0x28269f(0xfb))]({'connection':this[_0x28269f(0x11f)],'logger':this[_0x28269f(0x139)]}),this[_0x28269f(0x124)]=new salesforce_service_1[(_0x28269f(0x154))]({'connection':this[_0x28269f(0x158)]}),this[_0x28269f(0xf4)]=new package_export_service_1[(_0x28269f(0xf5))]({'veevaService':this[_0x28269f(0x13b)],'connection':this[_0x28269f(0x11f)],'logger':this[_0x28269f(0x139)]});}async[a378_0x23f80e(0x138)](){const _0x566317=a378_0x23f80e;try{this[_0x566317(0x139)][_0x566317(0x104)]('Snapshot\x20started.');const _0x4c098a=await this['retrieveVeevaComponents']();await this[_0x566317(0x139)][_0x566317(0x157)]();const _0x2986a1=await this[_0x566317(0xf4)][_0x566317(0x134)](_0x4c098a,SnapshotService[_0x566317(0x105)]);await this[_0x566317(0x139)]['updateLog']();const _0x4b1431=await this[_0x566317(0x12a)](_0x4c098a,_0x2986a1);await this[_0x566317(0x10b)](_0x4b1431),await this[_0x566317(0x139)][_0x566317(0x157)](),await this['finishSnapshot'](!![]);}catch(_0x3acec0){this[_0x566317(0x139)]['logError'](_0x3acec0),await this[_0x566317(0x110)](![])[_0x566317(0x121)](_0x7aa839=>this['_systemLogger'][_0x566317(0x15f)](_0x7aa839));}}async[a378_0x23f80e(0xef)](){const _0x392ea3=a378_0x23f80e,_0x55ae75={'veevaService':this[_0x392ea3(0x13b)],'logger':this[_0x392ea3(0x139)]},_0x39f5ab=Array[_0x392ea3(0x145)](Object[_0x392ea3(0x15c)](this[_0x392ea3(0x126)]))[_0x392ea3(0xf2)]?new type_and_name_veeva_component_retriever_1['TypeAndNameVeevaComponentRetriever']({'value':this['_selectedComponentMap'],..._0x55ae75}):new type_veeva_component_retriever_1[(_0x392ea3(0x152))]({'value':this[_0x392ea3(0x159)],'whereClause':this[_0x392ea3(0xfc)],..._0x55ae75});return _0x39f5ab[_0x392ea3(0x155)]();}async[a378_0x23f80e(0x12a)](_0x31807a,_0x458687){const _0x327a8a=a378_0x23f80e;var _0xc70c8a,_0x3dd4ee;this[_0x327a8a(0x139)][_0x327a8a(0x104)](_0x327a8a(0x12e));const _0x1651b7=this[_0x327a8a(0xfd)](_0x31807a),_0xf0f0c7=_0x1651b7['reduce']((_0x2924c8,_0x187790)=>_0x2924c8['set'](_0x187790[_0x327a8a(0x102)],_0x187790),new Map());for(const _0x56ebae of _0x458687){for(const _0x18ae62 in _0x56ebae[_0x327a8a(0x136)]){const {base:_0x3cf567,name:_0x7a5732,dir:_0x4bfa04}=path_1[_0x327a8a(0x11d)][_0x327a8a(0x123)](_0x18ae62),_0x12ee10=_0x7a5732+veeva_constants_1[_0x327a8a(0x128)][_0x327a8a(0x143)];if(_0xf0f0c7['has'](_0x3cf567)){const _0x47adf3=await((_0xc70c8a=_0x56ebae['file']([_0x4bfa04,_0x3cf567][_0x327a8a(0x148)](path_1[_0x327a8a(0x11d)][_0x327a8a(0x14f)][_0x327a8a(0x125)])))===null||_0xc70c8a===void 0x0?void 0x0:_0xc70c8a[_0x327a8a(0x144)](_0x327a8a(0x146))),_0x260e34=await((_0x3dd4ee=_0x56ebae[_0x327a8a(0x14b)]([_0x4bfa04,_0x12ee10][_0x327a8a(0x148)](path_1['default'][_0x327a8a(0x14f)][_0x327a8a(0x125)])))===null||_0x3dd4ee===void 0x0?void 0x0:_0x3dd4ee[_0x327a8a(0x144)](_0x327a8a(0x146)));if(_0x47adf3){const _0x1f7971=new jszip_1[(_0x327a8a(0x11d))]();_0x1f7971[_0x327a8a(0x14b)](_0x3cf567,_0x47adf3),_0x260e34&&_0x1f7971[_0x327a8a(0x14b)](_0x12ee10,this[_0x327a8a(0x168)](_0x260e34)),_0xf0f0c7[_0x327a8a(0x149)](_0x3cf567)[_0x327a8a(0x113)]=await _0x1f7971[_0x327a8a(0x13d)]({'type':_0x327a8a(0x109)});}}}}return _0x1651b7['filter'](_0x22ebab=>!_0x22ebab[_0x327a8a(0x113)])['forEach'](_0x3dbcb5=>{const _0x2353b6=_0x327a8a;this[_0x2353b6(0x139)][_0x2353b6(0x104)](_0x2353b6(0x165)+_0x3dbcb5[_0x2353b6(0x103)]+'.'+_0x3dbcb5[_0x2353b6(0x111)]+_0x2353b6(0x11b));}),_0x1651b7['filter'](_0x33c8f5=>_0x33c8f5[_0x327a8a(0x113)]);}['transformDependencyFile'](_0x53cb73){const _0x7b3a97=a378_0x23f80e,_0x584689=(0x0,sync_1[_0x7b3a97(0x123)])(_0x53cb73,{'columns':!![],'skip_empty_lines':!![]}),_0x186e17=_0x584689[_0x7b3a97(0x129)](({'In\x20Package':_0x2b41de,..._0x32d547})=>_0x32d547);return(0x0,sync_2[_0x7b3a97(0xf9)])(_0x186e17,{'header':!![]});}['formMetadataItemDtoList'](_0x17daab){const _0xc4ba2e=a378_0x23f80e;return _0x17daab[_0xc4ba2e(0x129)](_0x29ad82=>{const _0x1448a9=_0xc4ba2e,_0x43b4fe=new metadata_item_dto_1['MetadataItemDto']();return _0x43b4fe['name']=_0x29ad82[_0x1448a9(0x111)],_0x43b4fe[_0x1448a9(0x12d)]=_0x29ad82[_0x1448a9(0x111)],_0x43b4fe['snapshotId']=this['_snapshotId'],_0x43b4fe['label']=_0x29ad82[_0x1448a9(0x131)]+'.'+_0x29ad82[_0x1448a9(0x111)]+veeva_constants_1['VeevaConstants']['MDL_EXTENSION'],_0x43b4fe[_0x1448a9(0x103)]=_0x29ad82[_0x1448a9(0x131)],_0x43b4fe['lastModifiedDate']=_0x29ad82[_0x1448a9(0xee)],_0x43b4fe['isRetrieved']=![],_0x43b4fe;});}async[a378_0x23f80e(0x10b)](_0x35e422){const _0x589ea3=a378_0x23f80e;this[_0x589ea3(0x139)][_0x589ea3(0x104)]('Saving\x20Attachments.'),await this[_0x589ea3(0x142)](_0x35e422),this['_logger'][_0x589ea3(0x104)](_0x589ea3(0x135)+_0x35e422['length']+_0x589ea3(0x119));const _0x1e47f0=_0x35e422['map'](_0xe0fe04=>{const _0xfbcb5=_0x589ea3;return{[constants_1[_0xfbcb5(0x169)]+_0xfbcb5(0x11a)]:_0xe0fe04[_0xfbcb5(0x111)],[constants_1[_0xfbcb5(0x169)]+_0xfbcb5(0xf1)]:_0xe0fe04[_0xfbcb5(0x12d)],[constants_1[_0xfbcb5(0x169)]+_0xfbcb5(0x153)]:_0xe0fe04['snapshotId'],[constants_1[_0xfbcb5(0x169)]+_0xfbcb5(0x163)]:_0xe0fe04[_0xfbcb5(0x102)],[constants_1[_0xfbcb5(0x169)]+'Is_Retrieved__c']:_0xe0fe04['isRetrieved'],[constants_1[_0xfbcb5(0x169)]+'Veeva_Component_Type__c']:_0xe0fe04['veevaComponentType'],[constants_1[_0xfbcb5(0x169)]+_0xfbcb5(0xfe)]:_0xe0fe04['attachmentId'],[constants_1[_0xfbcb5(0x169)]+_0xfbcb5(0x140)]:_0xe0fe04[_0xfbcb5(0xee)]};}),_0x56a035=await this[_0x589ea3(0x124)][_0x589ea3(0xf0)](constants_1[_0x589ea3(0x169)]+_0x589ea3(0x156),_0x1e47f0);let _0x1ae1f9=!![];_0x56a035[_0x589ea3(0xf3)]((_0x26d8ad,_0x502635)=>{const _0x1f6d57=_0x589ea3;this[_0x1f6d57(0x139)][_0x1f6d57(0x104)]('Saving\x20'+_0x35e422[_0x502635][_0x1f6d57(0x103)]+'.'+_0x35e422[_0x502635][_0x1f6d57(0x111)]);if(!_0x26d8ad[_0x1f6d57(0x117)]){_0x1ae1f9=![];const _0x24a219=new salesforce_dml_error_1['SalesforceDmlError'](_0x26d8ad[_0x1f6d57(0x13f)]);this[_0x1f6d57(0x139)][_0x1f6d57(0x14e)](_0x24a219);}});if(!_0x1ae1f9)throw new Error(_0x589ea3(0x107));}async[a378_0x23f80e(0x142)](_0x1a1d05){const _0x29847b=a378_0x23f80e,_0x45b041=this[_0x29847b(0xfa)](_0x1a1d05),_0x46f06a=await this['_salesforceService']['insertMultipleRecords'](SnapshotService['ATTACHMENT'],_0x45b041),_0x37da1a=[];_0x46f06a[_0x29847b(0xf3)]((_0x48e71c,_0x4cd04f)=>{const _0x6a6b03=_0x29847b;_0x48e71c[_0x6a6b03(0x117)]?(_0x1a1d05[_0x4cd04f]['attachmentId']=_0x48e71c['id'],_0x1a1d05[_0x4cd04f][_0x6a6b03(0x13c)]=!![]):_0x37da1a[_0x6a6b03(0x15d)](..._0x48e71c[_0x6a6b03(0x13f)]);});if(_0x37da1a['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x37da1a);}['formAttachments'](_0x2cfd95){const _0xffc1a4=a378_0x23f80e;return _0x2cfd95[_0xffc1a4(0x129)](_0x14d9eb=>({'ParentId':this[_0xffc1a4(0x14a)],'Name':_0x14d9eb[_0xffc1a4(0x103)],'ContentType':_0xffc1a4(0x151),'Body':_0x14d9eb[_0xffc1a4(0x113)],'Description':_0x14d9eb['veevaComponentType']}));}async[a378_0x23f80e(0x110)](_0x1addcd){const _0x4c26db=a378_0x23f80e,_0x4d22db={[constants_1[_0x4c26db(0x169)]+'Is_Completed__c']:!![],[constants_1[_0x4c26db(0x169)]+'Is_Error__c']:!_0x1addcd},_0x49a63b={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x1addcd,[constants_1[_0x4c26db(0x169)]+'Succeed__c']:_0x1addcd,[constants_1[_0x4c26db(0x169)]+_0x4c26db(0x162)]:_0x1addcd?status_enums_1[_0x4c26db(0x11c)][_0x4c26db(0x106)]:status_enums_1[_0x4c26db(0x11c)][_0x4c26db(0x10e)],[constants_1['FLOSUM_NAMESPACE']+_0x4c26db(0x132)]:!![]};await this[_0x4c26db(0x158)]['patch'](flosum_constants_1[_0x4c26db(0x10f)][_0x4c26db(0x118)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Snapshot__c/'+this[_0x4c26db(0x14a)],_0x4d22db),await this[_0x4c26db(0x158)]['patch'](flosum_constants_1['FlosumConstants'][_0x4c26db(0x118)]+'/'+constants_1[_0x4c26db(0x169)]+_0x4c26db(0x166)+this['_metadataLogId'],_0x49a63b),this[_0x4c26db(0x139)][_0x4c26db(0x104)](_0x4c26db(0x12c)+(_0x1addcd?_0x4c26db(0x114):_0x4c26db(0x15a))+'.'),await this[_0x4c26db(0x139)][_0x4c26db(0x157)]();}}function a378_0x5e0a(){const _0x46dffe=['4933480ciBLZU','export','Saving\x20','files','36570321lmMWWq','execute','_logger','../constants/veeva.constants','_veevaService','isRetrieved','generateAsync','apply','errors','Last_Modified_Date__c','search','saveAttachments','DEPENDENCY_EXTENSION','async','from','string','csv-parse/sync','join','get','_snapshotId','file','../constants/flosum.constants','toString','logError','posix','8054rJCrKu','application/zip','TypeVeevaComponentRetriever','Snapshot__c','SalesforceService','retrieve','Metadata_Item__c','updateLog','_connectionSalesforce','_selectedMetaTypes','with\x20error','_metadataLogId','values','push','constructor','error','722356RRmEND','528899bamcQh','Status__c','Label__c','105axUnbn','Cannot\x20retrieve\x20','Metadata_Log__c/','../../../constants','transformDependencyFile','FLOSUM_NAMESPACE','lastModifiedDate','retrieveVeevaComponents','insertMultipleRecords','API_Name__c','length','forEach','_packageExportService','PackageExportService','__esModule','path','Snapshot','stringify','formAttachments','VeevaService','_whereClause','formMetadataItemDtoList','Attachment_ID__c','./salesforce.service','SnapshotService','csv-stringify/sync','label','veevaComponentType','log','OUTBOUND_PACKAGE_NAME','COMPLETED','Cannot\x20Save\x20Metadata\x20Items','../classes/retrievers/veeva-components/type.veeva-component.retriever','base64','./package-export.service','saveComponentsInSalesforce','10gQJSTN','../enums/status.enums','EXCEPTION','FlosumConstants','finishSnapshot','name','./veeva.service','body','successfully','defineProperty','jszip','success','ENDPOINT_UPSERT_RECORD','\x20Metadata\x20Items','Name__c','\x20from\x20outbound\x20package','MetadataLogStatus','default','(((.+)+)+)+$','_connectionVeeva','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','catch','9841594WEzzDq','parse','_salesforceService','sep','_selectedComponentMap','__importDefault','VeevaConstants','map','createMetadataItemListWithBody','6197364ULogOi','Snapshot\x20completed\x20','apiName','Unpack\x20zip\x20and\x20create\x20metadata\x20items.','ATTACHMENT','30bTcHqX','type','Job_Completed__c'];a378_0x5e0a=function(){return _0x46dffe;};return a378_0x5e0a();}exports[a378_0x23f80e(0x100)]=SnapshotService,SnapshotService[a378_0x23f80e(0x105)]=a378_0x23f80e(0xf8),SnapshotService[a378_0x23f80e(0x12f)]='Attachment';