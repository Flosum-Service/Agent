const a363_0x612dbd=a363_0x1076;function a363_0x1a66(){const _0x4bb2aa=['SalesforceService','./salesforce.service','saveComponentsInSalesforce','VeevaService','Is_Error__c','../classes/errors/salesforce-dml-error','catch','Snapshot','MetadataLogStatus','API_Name__c','COMPLETED','forEach','file','42072888iFaTGU','7KPRXiF','name','../enums/status.enums','patch','finishSnapshot','Snapshot\x20completed\x20','length','Snapshot__c/','lastModifiedDate','TypeVeevaComponentRetriever','generateAsync','./package-export.service','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','from','2376UCWIcY','SalesforceDmlError','default','has','Is_Retrieved__c','string','veevaComponentType','reduce','_selectedComponentMap','formMetadataItemDtoList','sep','FLOSUM_NAMESPACE','transformDependencyFile','\x20from\x20outbound\x20package','1035279SnGxKi','Metadata_Log__c/','async','_connectionVeeva','search','retrieve','get','_logger','../constants/veeva.constants','__esModule','error','Saving\x20','isRetrieved','_packageExportService','Is_Completed__c','16ipJMzu','files','DEPENDENCY_EXTENSION','errors','145953QKRryR','SnapshotService','EXCEPTION','3003845QearuO','values','36usJlGd','csv-stringify/sync','csv-parse/sync','constructor','TypeAndNameVeevaComponentRetriever','Name__c','(((.+)+)+)+$','./veeva.service','43060Bnyoal','Status__c','_salesforceService','push','../constants/flosum.constants','OUTBOUND_PACKAGE_NAME','Job_Completed__c','PackageExportService','body','Cannot\x20Save\x20Metadata\x20Items','logError','success','ENDPOINT_UPSERT_RECORD','apply','type','_snapshotId','_metadataLogId','toString','MDL_EXTENSION','saveAttachments','stringify','retrieveVeevaComponents','_selectedMetaTypes','_connectionSalesforce','../classes/retrievers/veeva-components/type.veeva-component.retriever','execute','set','createMetadataItemListWithBody','join','path','Snapshot__c','4LuiULA','6474642muxcGc','jszip','map','_veevaService','Snapshot\x20started.','formAttachments','VeevaConstants','label','Last_Modified_Date__c','parse','_systemLogger','885473spsGOc','snapshotId','log','updateLog','Attachment_ID__c','insertMultipleRecords','posix','apiName'];a363_0x1a66=function(){return _0x4bb2aa;};return a363_0x1a66();}(function(_0x27b32c,_0x123ab2){const _0xf690d2=a363_0x1076,_0x12ed95=_0x27b32c();while(!![]){try{const _0x5015f5=parseInt(_0xf690d2(0xdc))/0x1+parseInt(_0xf690d2(0x126))/0x2*(-parseInt(_0xf690d2(0x121))/0x3)+parseInt(_0xf690d2(0xd0))/0x4*(-parseInt(_0xf690d2(0x124))/0x5)+-parseInt(_0xf690d2(0xd1))/0x6*(parseInt(_0xf690d2(0xf2))/0x7)+-parseInt(_0xf690d2(0x11d))/0x8*(parseInt(_0xf690d2(0x10e))/0x9)+-parseInt(_0xf690d2(0x12e))/0xa*(parseInt(_0xf690d2(0x100))/0xb)+parseInt(_0xf690d2(0xf1))/0xc;if(_0x5015f5===_0x123ab2)break;else _0x12ed95['push'](_0x12ed95['shift']());}catch(_0x5da94b){_0x12ed95['push'](_0x12ed95['shift']());}}}(a363_0x1a66,0xa4fd3));const a363_0x150b70=(function(){let _0x31bc6e=!![];return function(_0x57c02e,_0x3db4c8){const _0x597d5e=_0x31bc6e?function(){const _0x20f532=a363_0x1076;if(_0x3db4c8){const _0x2b03de=_0x3db4c8[_0x20f532(0x13b)](_0x57c02e,arguments);return _0x3db4c8=null,_0x2b03de;}}:function(){};return _0x31bc6e=![],_0x597d5e;};}()),a363_0x2e36d5=a363_0x150b70(this,function(){const _0x290ae4=a363_0x1076;return a363_0x2e36d5['toString']()[_0x290ae4(0x112)](_0x290ae4(0x12c))[_0x290ae4(0x13f)]()[_0x290ae4(0x129)](a363_0x2e36d5)[_0x290ae4(0x112)](_0x290ae4(0x12c));});a363_0x2e36d5();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3ea016){const _0x4e1f86=a363_0x1076;return _0x3ea016&&_0x3ea016[_0x4e1f86(0x117)]?_0x3ea016:{'default':_0x3ea016};};Object['defineProperty'](exports,a363_0x612dbd(0x117),{'value':!![]}),exports[a363_0x612dbd(0x122)]=void 0x0;const jszip_1=__importDefault(require(a363_0x612dbd(0xd2))),flosum_constants_1=require(a363_0x612dbd(0x132)),veeva_service_1=require(a363_0x612dbd(0x12d)),metadata_item_dto_1=require('../dtos/metadata-item.dto'),constants_1=require('../../../constants'),salesforce_service_1=require(a363_0x612dbd(0xe5)),status_enums_1=require(a363_0x612dbd(0xf4)),salesforce_dml_error_1=require(a363_0x612dbd(0xe9)),package_export_service_1=require(a363_0x612dbd(0xfd)),type_and_name_veeva_component_retriever_1=require(a363_0x612dbd(0xfe)),type_veeva_component_retriever_1=require(a363_0x612dbd(0xc9)),sync_1=require(a363_0x612dbd(0x128)),sync_2=require(a363_0x612dbd(0x127)),veeva_constants_1=require(a363_0x612dbd(0x116)),path_1=__importDefault(require(a363_0x612dbd(0xce)));class SnapshotService{constructor({snapshotId:_0x3ce618,metadataLogId:_0x5d5ed9,selectedMetaTypes:_0x323c15,selectedComponentMap:_0x419d66,whereClause:_0x25d3a1},_0x47235d,_0x2da063,_0x490b1a){const _0x14d3df=a363_0x612dbd;this[_0x14d3df(0xc8)]=_0x47235d,this['_connectionVeeva']=_0x2da063,this[_0x14d3df(0x115)]=_0x490b1a,this['_snapshotId']=_0x3ce618,this[_0x14d3df(0x13e)]=_0x5d5ed9,this[_0x14d3df(0xc7)]=_0x323c15,this[_0x14d3df(0x108)]=_0x419d66,this['_whereClause']=_0x25d3a1,this[_0x14d3df(0xd4)]=new veeva_service_1[(_0x14d3df(0xe7))]({'connection':this['_connectionVeeva'],'logger':this[_0x14d3df(0x115)]}),this[_0x14d3df(0x130)]=new salesforce_service_1[(_0x14d3df(0xe4))]({'connection':this[_0x14d3df(0xc8)]}),this[_0x14d3df(0x11b)]=new package_export_service_1[(_0x14d3df(0x135))]({'veevaService':this['_veevaService'],'connection':this[_0x14d3df(0x111)],'logger':this[_0x14d3df(0x115)]});}async[a363_0x612dbd(0xca)](){const _0x4621a1=a363_0x612dbd;try{this[_0x4621a1(0x115)][_0x4621a1(0xde)](_0x4621a1(0xd5));const _0xb4c137=await this[_0x4621a1(0xc6)]();await this[_0x4621a1(0x115)][_0x4621a1(0xdf)]();const _0x235636=await this[_0x4621a1(0x11b)]['export'](_0xb4c137,SnapshotService[_0x4621a1(0x133)]);await this['_logger'][_0x4621a1(0xdf)]();const _0x4e7cab=await this[_0x4621a1(0xcc)](_0xb4c137,_0x235636);await this[_0x4621a1(0xe6)](_0x4e7cab),await this['_logger'][_0x4621a1(0xdf)](),await this[_0x4621a1(0xf6)](!![]);}catch(_0x4b7c3){this[_0x4621a1(0x115)][_0x4621a1(0x138)](_0x4b7c3),await this['finishSnapshot'](![])[_0x4621a1(0xea)](_0x3c9a22=>this[_0x4621a1(0xdb)][_0x4621a1(0x118)](_0x3c9a22));}}async[a363_0x612dbd(0xc6)](){const _0x18a509=a363_0x612dbd,_0x3aa160={'veevaService':this['_veevaService'],'logger':this['_logger']},_0x3e64f3=Array[_0x18a509(0xff)](Object[_0x18a509(0x125)](this['_selectedComponentMap']))[_0x18a509(0xf8)]?new type_and_name_veeva_component_retriever_1[(_0x18a509(0x12a))]({'value':this[_0x18a509(0x108)],..._0x3aa160}):new type_veeva_component_retriever_1[(_0x18a509(0xfb))]({'value':this[_0x18a509(0xc7)],'whereClause':this['_whereClause'],..._0x3aa160});return _0x3e64f3[_0x18a509(0x113)]();}async[a363_0x612dbd(0xcc)](_0x737768,_0x1b6955){const _0x38e846=a363_0x612dbd;var _0x2c63d8,_0x40def0;this[_0x38e846(0x115)][_0x38e846(0xde)]('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x3cfdd8=this[_0x38e846(0x109)](_0x737768),_0x39d900=_0x3cfdd8[_0x38e846(0x107)]((_0x2f06ff,_0x3a3e00)=>_0x2f06ff[_0x38e846(0xcb)](_0x3a3e00['label'],_0x3a3e00),new Map());for(const _0x21debb of _0x1b6955){for(const _0x35d4cc in _0x21debb[_0x38e846(0x11e)]){const {base:_0xf3b958,name:_0x5aeb43,dir:_0x5b2070}=path_1[_0x38e846(0x102)][_0x38e846(0xda)](_0x35d4cc),_0x5152b4=_0x5aeb43+veeva_constants_1['VeevaConstants'][_0x38e846(0x11f)];if(_0x39d900[_0x38e846(0x103)](_0xf3b958)){const _0x5a2291=await((_0x2c63d8=_0x21debb['file']([_0x5b2070,_0xf3b958][_0x38e846(0xcd)](path_1['default'][_0x38e846(0xe2)][_0x38e846(0x10a)])))===null||_0x2c63d8===void 0x0?void 0x0:_0x2c63d8[_0x38e846(0x110)](_0x38e846(0x105))),_0x32c752=await((_0x40def0=_0x21debb['file']([_0x5b2070,_0x5152b4][_0x38e846(0xcd)](path_1['default'][_0x38e846(0xe2)]['sep'])))===null||_0x40def0===void 0x0?void 0x0:_0x40def0['async'](_0x38e846(0x105)));if(_0x5a2291){const _0x431d05=new jszip_1[(_0x38e846(0x102))]();_0x431d05[_0x38e846(0xf0)](_0xf3b958,_0x5a2291),_0x32c752&&_0x431d05[_0x38e846(0xf0)](_0x5152b4,this[_0x38e846(0x10c)](_0x32c752)),_0x39d900[_0x38e846(0x114)](_0xf3b958)['body']=await _0x431d05[_0x38e846(0xfc)]({'type':'base64'});}}}}return _0x3cfdd8['filter'](_0x24ff1c=>!_0x24ff1c[_0x38e846(0x136)])[_0x38e846(0xef)](_0x297343=>{const _0x6c13f9=_0x38e846;this[_0x6c13f9(0x115)][_0x6c13f9(0xde)]('Cannot\x20retrieve\x20'+_0x297343['veevaComponentType']+'.'+_0x297343['name']+_0x6c13f9(0x10d));}),_0x3cfdd8['filter'](_0x222264=>_0x222264[_0x38e846(0x136)]);}[a363_0x612dbd(0x10c)](_0x41ad20){const _0x2633c8=a363_0x612dbd,_0xdb5bf3=(0x0,sync_1[_0x2633c8(0xda)])(_0x41ad20,{'columns':!![],'skip_empty_lines':!![]}),_0x562cdf=_0xdb5bf3[_0x2633c8(0xd3)](({'In\x20Package':_0x1a7261,..._0x41a65a})=>_0x41a65a);return(0x0,sync_2[_0x2633c8(0xc5)])(_0x562cdf,{'header':!![]});}[a363_0x612dbd(0x109)](_0x14e8e7){const _0x5ecdf8=a363_0x612dbd;return _0x14e8e7[_0x5ecdf8(0xd3)](_0x4ecd87=>{const _0x428dd3=_0x5ecdf8,_0x399daa=new metadata_item_dto_1['MetadataItemDto']();return _0x399daa['name']=_0x4ecd87[_0x428dd3(0xf3)],_0x399daa[_0x428dd3(0xe3)]=_0x4ecd87[_0x428dd3(0xf3)],_0x399daa[_0x428dd3(0xdd)]=this[_0x428dd3(0x13d)],_0x399daa[_0x428dd3(0xd8)]=_0x4ecd87[_0x428dd3(0x13c)]+'.'+_0x4ecd87['name']+veeva_constants_1[_0x428dd3(0xd7)][_0x428dd3(0x140)],_0x399daa[_0x428dd3(0x106)]=_0x4ecd87['type'],_0x399daa[_0x428dd3(0xfa)]=_0x4ecd87[_0x428dd3(0xfa)],_0x399daa[_0x428dd3(0x11a)]=![],_0x399daa;});}async[a363_0x612dbd(0xe6)](_0x339776){const _0x59c79c=a363_0x612dbd;this[_0x59c79c(0x115)]['log']('Saving\x20Attachments.'),await this[_0x59c79c(0x141)](_0x339776),this['_logger']['log'](_0x59c79c(0x119)+_0x339776[_0x59c79c(0xf8)]+'\x20Metadata\x20Items');const _0x431583=_0x339776[_0x59c79c(0xd3)](_0x53a055=>{const _0x50d727=_0x59c79c;return{[constants_1[_0x50d727(0x10b)]+_0x50d727(0x12b)]:_0x53a055['name'],[constants_1[_0x50d727(0x10b)]+_0x50d727(0xed)]:_0x53a055['apiName'],[constants_1[_0x50d727(0x10b)]+_0x50d727(0xcf)]:_0x53a055[_0x50d727(0xdd)],[constants_1[_0x50d727(0x10b)]+'Label__c']:_0x53a055[_0x50d727(0xd8)],[constants_1[_0x50d727(0x10b)]+_0x50d727(0x104)]:_0x53a055[_0x50d727(0x11a)],[constants_1[_0x50d727(0x10b)]+'Veeva_Component_Type__c']:_0x53a055[_0x50d727(0x106)],[constants_1[_0x50d727(0x10b)]+_0x50d727(0xe0)]:_0x53a055['attachmentId'],[constants_1['FLOSUM_NAMESPACE']+_0x50d727(0xd9)]:_0x53a055['lastModifiedDate']};}),_0x2ad15d=await this[_0x59c79c(0x130)][_0x59c79c(0xe1)](constants_1[_0x59c79c(0x10b)]+'Metadata_Item__c',_0x431583);let _0x5ee146=!![];_0x2ad15d[_0x59c79c(0xef)]((_0x3f588b,_0xa69503)=>{const _0x38c70d=_0x59c79c;this[_0x38c70d(0x115)][_0x38c70d(0xde)](_0x38c70d(0x119)+_0x339776[_0xa69503][_0x38c70d(0x106)]+'.'+_0x339776[_0xa69503][_0x38c70d(0xf3)]);if(!_0x3f588b[_0x38c70d(0x139)]){_0x5ee146=![];const _0x454f57=new salesforce_dml_error_1['SalesforceDmlError'](_0x3f588b['errors']);this[_0x38c70d(0x115)][_0x38c70d(0x138)](_0x454f57);}});if(!_0x5ee146)throw new Error(_0x59c79c(0x137));}async[a363_0x612dbd(0x141)](_0x5216d6){const _0x20455f=a363_0x612dbd,_0x1f220a=this[_0x20455f(0xd6)](_0x5216d6),_0x264454=await this['_salesforceService']['insertMultipleRecords'](SnapshotService['ATTACHMENT'],_0x1f220a),_0x428005=[];_0x264454[_0x20455f(0xef)]((_0xbaa712,_0x13d421)=>{const _0xa3948e=_0x20455f;_0xbaa712[_0xa3948e(0x139)]?(_0x5216d6[_0x13d421]['attachmentId']=_0xbaa712['id'],_0x5216d6[_0x13d421][_0xa3948e(0x11a)]=!![]):_0x428005[_0xa3948e(0x131)](..._0xbaa712[_0xa3948e(0x120)]);});if(_0x428005['length'])throw new salesforce_dml_error_1[(_0x20455f(0x101))](_0x428005);}[a363_0x612dbd(0xd6)](_0x27f070){const _0x15c01a=a363_0x612dbd;return _0x27f070[_0x15c01a(0xd3)](_0xa7be9a=>({'ParentId':this['_snapshotId'],'Name':_0xa7be9a[_0x15c01a(0x106)],'ContentType':'application/zip','Body':_0xa7be9a[_0x15c01a(0x136)],'Description':_0xa7be9a['veevaComponentType']}));}async[a363_0x612dbd(0xf6)](_0x4be7fb){const _0x3cd604=a363_0x612dbd,_0x4f02ba={[constants_1[_0x3cd604(0x10b)]+_0x3cd604(0x11c)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x3cd604(0xe8)]:!_0x4be7fb},_0x418332={[constants_1[_0x3cd604(0x10b)]+_0x3cd604(0xe8)]:!_0x4be7fb,[constants_1['FLOSUM_NAMESPACE']+'Succeed__c']:_0x4be7fb,[constants_1[_0x3cd604(0x10b)]+_0x3cd604(0x12f)]:_0x4be7fb?status_enums_1['MetadataLogStatus'][_0x3cd604(0xee)]:status_enums_1[_0x3cd604(0xec)][_0x3cd604(0x123)],[constants_1[_0x3cd604(0x10b)]+_0x3cd604(0x134)]:!![]};await this[_0x3cd604(0xc8)][_0x3cd604(0xf5)](flosum_constants_1['FlosumConstants'][_0x3cd604(0x13a)]+'/'+constants_1[_0x3cd604(0x10b)]+_0x3cd604(0xf9)+this['_snapshotId'],_0x4f02ba),await this[_0x3cd604(0xc8)][_0x3cd604(0xf5)](flosum_constants_1['FlosumConstants'][_0x3cd604(0x13a)]+'/'+constants_1[_0x3cd604(0x10b)]+_0x3cd604(0x10f)+this['_metadataLogId'],_0x418332),this['_logger'][_0x3cd604(0xde)](_0x3cd604(0xf7)+(_0x4be7fb?'successfully':'with\x20error')+'.'),await this[_0x3cd604(0x115)][_0x3cd604(0xdf)]();}}function a363_0x1076(_0x1bcea5,_0x52f60a){const _0x2ddaae=a363_0x1a66();return a363_0x1076=function(_0x2e36d5,_0x150b70){_0x2e36d5=_0x2e36d5-0xc5;let _0x1a665e=_0x2ddaae[_0x2e36d5];return _0x1a665e;},a363_0x1076(_0x1bcea5,_0x52f60a);}exports[a363_0x612dbd(0x122)]=SnapshotService,SnapshotService[a363_0x612dbd(0x133)]=a363_0x612dbd(0xeb),SnapshotService['ATTACHMENT']='Attachment';