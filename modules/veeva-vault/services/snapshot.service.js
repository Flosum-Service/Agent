const a339_0x45f97b=a339_0xd8ac;(function(_0x3c71d0,_0x815de0){const _0x44f7dc=a339_0xd8ac,_0x4184de=_0x3c71d0();while(!![]){try{const _0x100e19=parseInt(_0x44f7dc(0x155))/0x1*(-parseInt(_0x44f7dc(0x11f))/0x2)+parseInt(_0x44f7dc(0x112))/0x3*(-parseInt(_0x44f7dc(0x101))/0x4)+parseInt(_0x44f7dc(0x109))/0x5+parseInt(_0x44f7dc(0x105))/0x6+parseInt(_0x44f7dc(0x129))/0x7*(-parseInt(_0x44f7dc(0x144))/0x8)+-parseInt(_0x44f7dc(0x162))/0x9*(parseInt(_0x44f7dc(0x13b))/0xa)+parseInt(_0x44f7dc(0x151))/0xb*(parseInt(_0x44f7dc(0x15b))/0xc);if(_0x100e19===_0x815de0)break;else _0x4184de['push'](_0x4184de['shift']());}catch(_0x3ea899){_0x4184de['push'](_0x4184de['shift']());}}}(a339_0x2322,0x4aba4));const a339_0x3e3640=(function(){let _0x5de6a1=!![];return function(_0x548ab3,_0x284cd0){const _0x5b3a3b=_0x5de6a1?function(){const _0x47fe91=a339_0xd8ac;if(_0x284cd0){const _0x3e8056=_0x284cd0[_0x47fe91(0x12a)](_0x548ab3,arguments);return _0x284cd0=null,_0x3e8056;}}:function(){};return _0x5de6a1=![],_0x5b3a3b;};}()),a339_0x2bf25a=a339_0x3e3640(this,function(){const _0x377221=a339_0xd8ac;return a339_0x2bf25a['toString']()[_0x377221(0x14a)](_0x377221(0x123))[_0x377221(0x13e)]()[_0x377221(0x11e)](a339_0x2bf25a)[_0x377221(0x14a)](_0x377221(0x123));});a339_0x2bf25a();function a339_0xd8ac(_0x10d73a,_0x2f432e){const _0x49e80b=a339_0x2322();return a339_0xd8ac=function(_0x2bf25a,_0x3e3640){_0x2bf25a=_0x2bf25a-0xf0;let _0x232229=_0x49e80b[_0x2bf25a];return _0x232229;},a339_0xd8ac(_0x10d73a,_0x2f432e);}'use strict';var __importDefault=this&&this[a339_0x45f97b(0x120)]||function(_0x6daab){const _0x3b0ff7=a339_0x45f97b;return _0x6daab&&_0x6daab[_0x3b0ff7(0xf7)]?_0x6daab:{'default':_0x6daab};};Object[a339_0x45f97b(0xf9)](exports,'__esModule',{'value':!![]}),exports[a339_0x45f97b(0x111)]=void 0x0;const jszip_1=__importDefault(require('jszip')),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require('./veeva.service'),metadata_item_dto_1=require(a339_0x45f97b(0x135)),constants_1=require(a339_0x45f97b(0x110)),salesforce_service_1=require('./salesforce.service'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a339_0x45f97b(0x132)),package_export_service_1=require('./package-export.service'),type_and_name_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever'),type_veeva_component_retriever_1=require(a339_0x45f97b(0x114));class SnapshotService{constructor(_0x42d8cb,_0x31b834,_0x59f6c5,_0x28c6c8){const _0x218236=a339_0x45f97b;this[_0x218236(0xf3)]=_0x31b834,this[_0x218236(0xfe)]=_0x59f6c5,this[_0x218236(0x158)]=_0x28c6c8,this['_snapshotId']=_0x42d8cb[_0x218236(0x10d)],this['_metadataLogId']=_0x42d8cb[_0x218236(0x138)],this[_0x218236(0xf5)]=_0x42d8cb['attachmentLogId'],this[_0x218236(0x13a)]=_0x42d8cb[_0x218236(0x148)],this[_0x218236(0x160)]=_0x42d8cb[_0x218236(0x12c)],this[_0x218236(0x159)]=_0x42d8cb['selectedComponentMap'],this[_0x218236(0x100)]=new veeva_service_1['VeevaService']({'connection':this[_0x218236(0xfe)],'logger':this['_logger']}),this[_0x218236(0x11d)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x218236(0xf3)]}),this['_packageExportService']=new package_export_service_1[(_0x218236(0x131))]({'veevaService':this[_0x218236(0x100)],'connection':this[_0x218236(0xfe)],'logger':this[_0x218236(0x158)]});}async[a339_0x45f97b(0x15d)](){const _0x3c3396=a339_0x45f97b;try{this['_logger'][_0x3c3396(0x141)](_0x3c3396(0x146));const _0x3ec9d5=await this[_0x3c3396(0x106)]();await this[_0x3c3396(0x158)]['updateLog']();const _0x64bb8=await this['_packageExportService'][_0x3c3396(0x157)](_0x3ec9d5,SnapshotService[_0x3c3396(0x153)]);await this[_0x3c3396(0x158)][_0x3c3396(0xf8)]();const _0x34e9f1=await this[_0x3c3396(0x11a)](_0x3ec9d5,_0x64bb8);await this[_0x3c3396(0x10f)](_0x34e9f1),await this[_0x3c3396(0x158)][_0x3c3396(0xf8)](),await this[_0x3c3396(0x12d)](!![]);}catch(_0x27245e){this[_0x3c3396(0x158)][_0x3c3396(0x122)](_0x27245e),await this[_0x3c3396(0x12d)](![])['catch'](_0x3b181e=>this[_0x3c3396(0x12f)][_0x3c3396(0x15a)](_0x3b181e));}}async[a339_0x45f97b(0x106)](){const _0x35bc88=a339_0x45f97b,_0x53cbc0={'veevaService':this[_0x35bc88(0x100)],'logger':this[_0x35bc88(0x158)]},_0xcbaeea=Array[_0x35bc88(0x121)](Object[_0x35bc88(0xf1)](this[_0x35bc88(0x159)]))[_0x35bc88(0x136)]?new type_and_name_veeva_component_retriever_1[(_0x35bc88(0x10a))]({'value':this['_selectedComponentMap'],..._0x53cbc0}):new type_veeva_component_retriever_1[(_0x35bc88(0x12b))]({'value':this[_0x35bc88(0x160)],..._0x53cbc0});return _0xcbaeea[_0x35bc88(0x107)]();}async['createMetadataItemListWithBody'](_0x336862,_0x1cb6a0){const _0x3ef8b5=a339_0x45f97b;var _0x403b03;this[_0x3ef8b5(0x158)][_0x3ef8b5(0x141)]('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x3b29bd=this[_0x3ef8b5(0x143)](_0x336862),_0x24da77=_0x3b29bd[_0x3ef8b5(0x103)]((_0x1dd384,_0x2b5ffc)=>_0x1dd384[_0x3ef8b5(0xf0)](_0x2b5ffc['label'],_0x2b5ffc),new Map());for(const _0x6482e8 of _0x1cb6a0){for(const _0x18e587 in _0x6482e8[_0x3ef8b5(0x102)]){const _0x390082=_0x18e587['split']('/')['at'](-0x1);if(_0x24da77['has'](_0x390082)){const _0xdfabd1=await((_0x403b03=_0x6482e8[_0x3ef8b5(0xfd)](_0x18e587))===null||_0x403b03===void 0x0?void 0x0:_0x403b03['async'](_0x3ef8b5(0x150)));if(_0xdfabd1){const _0x9722f5=new jszip_1[(_0x3ef8b5(0x13c))]();_0x9722f5['file'](_0x390082,_0xdfabd1),_0x24da77[_0x3ef8b5(0x15c)](_0x390082)[_0x3ef8b5(0x127)]=await _0x9722f5['generateAsync']({'type':'base64'});}}}}return _0x3b29bd[_0x3ef8b5(0x115)](_0x41b6f6=>!_0x41b6f6[_0x3ef8b5(0x127)])[_0x3ef8b5(0x163)](_0x5093c5=>{const _0x53c4e1=_0x3ef8b5;this[_0x53c4e1(0x158)]['log']('Cannot\x20retrieve\x20'+_0x5093c5[_0x53c4e1(0x10e)]+'.'+_0x5093c5[_0x53c4e1(0x140)]+_0x53c4e1(0x156));}),_0x3b29bd[_0x3ef8b5(0x115)](_0x716835=>_0x716835[_0x3ef8b5(0x127)]);}['formMetadataItemDtoList'](_0x30b539){const _0x48155f=a339_0x45f97b;return _0x30b539[_0x48155f(0x14b)](_0x2ff8e8=>{const _0x4d8f07=_0x48155f,_0x3b58d4=new metadata_item_dto_1['MetadataItemDto']();return _0x3b58d4['name']=_0x2ff8e8[_0x4d8f07(0x140)],_0x3b58d4[_0x4d8f07(0x161)]=_0x2ff8e8[_0x4d8f07(0x140)],_0x3b58d4[_0x4d8f07(0x10d)]=this[_0x4d8f07(0x142)],_0x3b58d4[_0x4d8f07(0x126)]=_0x2ff8e8[_0x4d8f07(0x154)]+'.'+_0x2ff8e8['name']+'.mdl',_0x3b58d4['veevaComponentType']=_0x2ff8e8[_0x4d8f07(0x154)],_0x3b58d4['lastModifiedDate']=_0x2ff8e8[_0x4d8f07(0x108)],_0x3b58d4[_0x4d8f07(0x152)]=![],_0x3b58d4;});}async[a339_0x45f97b(0x10f)](_0xf1287){const _0x41a93d=a339_0x45f97b;this[_0x41a93d(0x158)][_0x41a93d(0x141)](_0x41a93d(0x116)),await this['saveAttachments'](_0xf1287),this[_0x41a93d(0x158)][_0x41a93d(0x141)](_0x41a93d(0x15e)+_0xf1287['length']+_0x41a93d(0x133));const _0x34228c=_0xf1287[_0x41a93d(0x14b)](_0x5c9f2c=>{const _0x2701d8=_0x41a93d;return{[constants_1[_0x2701d8(0x14f)]+_0x2701d8(0x14d)]:_0x5c9f2c[_0x2701d8(0x140)],[constants_1['FLOSUM_NAMESPACE']+_0x2701d8(0xfc)]:_0x5c9f2c['apiName'],[constants_1[_0x2701d8(0x14f)]+_0x2701d8(0x118)]:_0x5c9f2c[_0x2701d8(0x10d)],[constants_1[_0x2701d8(0x14f)]+_0x2701d8(0x11c)]:_0x5c9f2c['label'],[constants_1[_0x2701d8(0x14f)]+_0x2701d8(0x113)]:_0x5c9f2c[_0x2701d8(0x152)],[constants_1[_0x2701d8(0x14f)]+_0x2701d8(0xfa)]:_0x5c9f2c[_0x2701d8(0x10e)],[constants_1[_0x2701d8(0x14f)]+'Attachment_ID__c']:_0x5c9f2c['attachmentId'],[constants_1[_0x2701d8(0x14f)]+_0x2701d8(0x14c)]:_0x5c9f2c['lastModifiedDate']};}),_0x2ca8da=await this[_0x41a93d(0x11d)]['insertMultipleRecords'](constants_1[_0x41a93d(0x14f)]+_0x41a93d(0x10c),_0x34228c);let _0x17b4f5=!![];_0x2ca8da[_0x41a93d(0x163)]((_0xaed002,_0x49bf04)=>{const _0x51afe8=_0x41a93d;this[_0x51afe8(0x158)][_0x51afe8(0x141)](_0x51afe8(0x15e)+_0xf1287[_0x49bf04][_0x51afe8(0x10e)]+'.'+_0xf1287[_0x49bf04][_0x51afe8(0x140)]);if(!_0xaed002['success']){_0x17b4f5=![];const _0x592fc1=new salesforce_dml_error_1[(_0x51afe8(0x147))](_0xaed002[_0x51afe8(0x137)]);this[_0x51afe8(0x158)]['logError'](_0x592fc1);}});if(!_0x17b4f5)throw new Error(_0x41a93d(0x11b));}async[a339_0x45f97b(0x125)](_0x4ed7f3){const _0x5ef831=a339_0x45f97b,_0x5bb422=this[_0x5ef831(0x13f)](_0x4ed7f3),_0x24e24a=await this[_0x5ef831(0x11d)]['insertMultipleRecords'](SnapshotService[_0x5ef831(0x149)],_0x5bb422),_0x8048c8=[];_0x24e24a['forEach']((_0x43afdb,_0x2ef440)=>{const _0x44060b=_0x5ef831;_0x43afdb[_0x44060b(0x117)]?(_0x4ed7f3[_0x2ef440]['attachmentId']=_0x43afdb['id'],_0x4ed7f3[_0x2ef440][_0x44060b(0x152)]=!![]):_0x8048c8[_0x44060b(0x104)](..._0x43afdb[_0x44060b(0x137)]);});if(_0x8048c8[_0x5ef831(0x136)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x8048c8);}['formAttachments'](_0x3df732){const _0x8ebe1f=a339_0x45f97b;return _0x3df732[_0x8ebe1f(0x14b)](_0x54fb47=>({'ParentId':this[_0x8ebe1f(0x142)],'Name':_0x54fb47[_0x8ebe1f(0x10e)],'ContentType':_0x8ebe1f(0x145),'Body':_0x54fb47['body'],'Description':_0x54fb47[_0x8ebe1f(0x10e)]}));}async[a339_0x45f97b(0x12d)](_0x1dd6fd){const _0x21110a=a339_0x45f97b,_0xf3cb43={[constants_1[_0x21110a(0x14f)]+_0x21110a(0x12e)]:!![],[constants_1[_0x21110a(0x14f)]+_0x21110a(0x13d)]:!_0x1dd6fd},_0x4b0c88={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x1dd6fd,[constants_1[_0x21110a(0x14f)]+'Succeed__c']:_0x1dd6fd,[constants_1[_0x21110a(0x14f)]+_0x21110a(0xf6)]:_0x1dd6fd?status_enums_1['MetadataLogStatus'][_0x21110a(0x139)]:status_enums_1[_0x21110a(0x130)][_0x21110a(0xfb)],[constants_1[_0x21110a(0x14f)]+_0x21110a(0xff)]:!![]};await this[_0x21110a(0xf3)][_0x21110a(0xf2)](flosum_constants_1[_0x21110a(0x14e)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+'Snapshot__c/'+this[_0x21110a(0x142)],_0xf3cb43),await this[_0x21110a(0xf3)]['patch'](flosum_constants_1['FlosumConstants'][_0x21110a(0x119)]+'/'+constants_1[_0x21110a(0x14f)]+'Metadata_Log__c/'+this[_0x21110a(0x15f)],_0x4b0c88),this[_0x21110a(0x158)][_0x21110a(0x141)](_0x21110a(0x134)+(_0x1dd6fd?_0x21110a(0xf4):_0x21110a(0x128))+'.'),await this[_0x21110a(0x158)]['updateLog']();}}function a339_0x2322(){const _0x3af10a=['retrieve','lastModifiedDate','370525IIyldx','TypeAndNameVeevaComponentRetriever','Snapshot','Metadata_Item__c','snapshotId','veevaComponentType','saveComponentsInSalesforce','../../../constants','SnapshotService','9BiYDqJ','Is_Retrieved__c','../classes/retrievers/veeva-components/type.veeva-component.retriever','filter','Saving\x20Attachments.','success','Snapshot__c','ENDPOINT_UPSERT_RECORD','createMetadataItemListWithBody','Cannot\x20Save\x20Metadata\x20Items','Label__c','_salesforceService','constructor','10rWkivF','__importDefault','from','logError','(((.+)+)+)+$','Attachment','saveAttachments','label','body','with\x20error','691369SCyXYN','apply','TypeVeevaComponentRetriever','selectedMetaTypes','finishSnapshot','Is_Completed__c','_systemLogger','MetadataLogStatus','PackageExportService','../classes/errors/salesforce-dml-error','\x20Metadata\x20Items','Snapshot\x20completed\x20','../dtos/metadata-item.dto','length','errors','metadataLogId','COMPLETED','_timeZone','12810MbDvXv','default','Is_Error__c','toString','formAttachments','name','log','_snapshotId','formMetadataItemDtoList','16RqHFsQ','application/zip','Snapshot\x20started.','SalesforceDmlError','timeZone','ATTACHMENT','search','map','Last_Modified_Date__c','Name__c','FlosumConstants','FLOSUM_NAMESPACE','string','10186FRinAH','isRetrieved','OUTBOUND_PACKAGE_NAME','type','95143CsEWnn','\x20from\x20outbound\x20package','export','_logger','_selectedComponentMap','error','15504GFeNwV','get','execute','Saving\x20','_metadataLogId','_selectedMetaTypes','apiName','3924rgaRIf','forEach','set','values','patch','_connectionSalesforce','successfully','_attachmentLogId','Status__c','__esModule','updateLog','defineProperty','Veeva_Component_Type__c','EXCEPTION','API_Name__c','file','_connectionVeeva','Job_Completed__c','_veevaService','434276OYedsh','files','reduce','push','3558354cvzscC','retrieveVeevaComponents'];a339_0x2322=function(){return _0x3af10a;};return a339_0x2322();}exports[a339_0x45f97b(0x111)]=SnapshotService,SnapshotService['OUTBOUND_PACKAGE_NAME']=a339_0x45f97b(0x10b),SnapshotService[a339_0x45f97b(0x149)]=a339_0x45f97b(0x124);