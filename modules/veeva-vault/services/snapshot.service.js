const a339_0x119cbf=a339_0x3cd1;(function(_0x423ef6,_0x54bcb3){const _0x12c485=a339_0x3cd1,_0x2686ee=_0x423ef6();while(!![]){try{const _0x1d7132=-parseInt(_0x12c485(0xec))/0x1*(parseInt(_0x12c485(0xe5))/0x2)+parseInt(_0x12c485(0xf3))/0x3+parseInt(_0x12c485(0x134))/0x4+-parseInt(_0x12c485(0x101))/0x5+parseInt(_0x12c485(0x104))/0x6+parseInt(_0x12c485(0x11f))/0x7*(parseInt(_0x12c485(0x102))/0x8)+parseInt(_0x12c485(0x130))/0x9*(parseInt(_0x12c485(0x118))/0xa);if(_0x1d7132===_0x54bcb3)break;else _0x2686ee['push'](_0x2686ee['shift']());}catch(_0x1fa7c0){_0x2686ee['push'](_0x2686ee['shift']());}}}(a339_0x1616,0xad92c));const a339_0x31fff3=(function(){let _0xf7c4d2=!![];return function(_0x215a1c,_0x1ab968){const _0x2c1dc2=_0xf7c4d2?function(){const _0x5d6e40=a339_0x3cd1;if(_0x1ab968){const _0x319ec9=_0x1ab968[_0x5d6e40(0x137)](_0x215a1c,arguments);return _0x1ab968=null,_0x319ec9;}}:function(){};return _0xf7c4d2=![],_0x2c1dc2;};}()),a339_0x4a8726=a339_0x31fff3(this,function(){const _0x2e3e58=a339_0x3cd1;return a339_0x4a8726[_0x2e3e58(0x11d)]()['search'](_0x2e3e58(0x135))['toString']()[_0x2e3e58(0xf4)](a339_0x4a8726)[_0x2e3e58(0xf0)](_0x2e3e58(0x135));});a339_0x4a8726();function a339_0x3cd1(_0x48defd,_0x4d80b3){const _0x147968=a339_0x1616();return a339_0x3cd1=function(_0x4a8726,_0x31fff3){_0x4a8726=_0x4a8726-0xe1;let _0x161672=_0x147968[_0x4a8726];return _0x161672;},a339_0x3cd1(_0x48defd,_0x4d80b3);}'use strict';var __importDefault=this&&this[a339_0x119cbf(0x116)]||function(_0x2f8cbb){const _0x4a373e=a339_0x119cbf;return _0x2f8cbb&&_0x2f8cbb[_0x4a373e(0x152)]?_0x2f8cbb:{'default':_0x2f8cbb};};Object['defineProperty'](exports,a339_0x119cbf(0x152),{'value':!![]}),exports[a339_0x119cbf(0x12a)]=void 0x0;const jszip_1=__importDefault(require(a339_0x119cbf(0x132))),flosum_constants_1=require(a339_0x119cbf(0xee)),veeva_service_1=require(a339_0x119cbf(0x13a)),metadata_item_dto_1=require('../dtos/metadata-item.dto'),constants_1=require(a339_0x119cbf(0xf8)),salesforce_service_1=require('./salesforce.service'),status_enums_1=require(a339_0x119cbf(0xe2)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),package_export_service_1=require('./package-export.service'),type_and_name_veeva_component_retriever_1=require(a339_0x119cbf(0xf9)),type_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/type.veeva-component.retriever');function a339_0x1616(){const _0x514914=['Status__c','apiName','Saving\x20Attachments.','SalesforceDmlError','../enums/status.enums','_attachmentLogId','_connectionVeeva','8goBoiZ','ATTACHMENT','_systemLogger','label','body','Saving\x20','EXCEPTION','54763aPxCzn','timeZone','../constants/flosum.constants','get','search','generateAsync','Attachment_ID__c','2130927VqpxAb','constructor','Label__c','has','_selectedMetaTypes','../../../constants','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','Name__c','application/zip','attachmentLogId','reduce','Veeva_Component_Type__c','MetadataLogStatus','ENDPOINT_UPSERT_RECORD','6351725tHuYyG','853144XUOjvh','base64','5045682zAnaHr','_salesforceService','SalesforceService','_connectionSalesforce','export','updateLog','lastModifiedDate','_metadataLogId','formMetadataItemDtoList','_selectedComponentMap','_snapshotId','Unpack\x20zip\x20and\x20create\x20metadata\x20items.','push','logError','saveAttachments','with\x20error','log','finishSnapshot','__importDefault','.mdl','605370PSWHku','filter','selectedComponentMap','_logger','name','toString','isRetrieved','7bbsBFA','retrieve','formAttachments','MetadataItemDto','split','catch','API_Name__c','metadataLogId','length','files','TypeAndNameVeevaComponentRetriever','SnapshotService','from','snapshotId','success','execute','veevaComponentType','18rgvghU','Succeed__c','jszip','type','1685520yrUPEr','(((.+)+)+)+$','Metadata_Item__c','apply','errors','TypeVeevaComponentRetriever','./veeva.service','_veevaService','createMetadataItemListWithBody','patch','forEach','_timeZone','Snapshot__c','string','insertMultipleRecords','FLOSUM_NAMESPACE','Snapshot\x20started.','error','Snapshot','PackageExportService','selectedMetaTypes','map','Is_Error__c','file','set','FlosumConstants','saveComponentsInSalesforce','OUTBOUND_PACKAGE_NAME','Attachment','Snapshot\x20completed\x20','__esModule','Cannot\x20retrieve\x20','default'];a339_0x1616=function(){return _0x514914;};return a339_0x1616();}class SnapshotService{constructor(_0x26cf9d,_0x4d882e,_0x67ccf4,_0x4718b5){const _0x1f5b4c=a339_0x119cbf;this['_connectionSalesforce']=_0x4d882e,this[_0x1f5b4c(0xe4)]=_0x67ccf4,this[_0x1f5b4c(0x11b)]=_0x4718b5,this[_0x1f5b4c(0x10e)]=_0x26cf9d[_0x1f5b4c(0x12c)],this[_0x1f5b4c(0x10b)]=_0x26cf9d[_0x1f5b4c(0x126)],this[_0x1f5b4c(0xe3)]=_0x26cf9d[_0x1f5b4c(0xfc)],this[_0x1f5b4c(0x13f)]=_0x26cf9d[_0x1f5b4c(0xed)],this[_0x1f5b4c(0xf7)]=_0x26cf9d[_0x1f5b4c(0x148)],this[_0x1f5b4c(0x10d)]=_0x26cf9d[_0x1f5b4c(0x11a)],this[_0x1f5b4c(0x13b)]=new veeva_service_1['VeevaService']({'connection':this[_0x1f5b4c(0xe4)],'logger':this['_logger']}),this[_0x1f5b4c(0x105)]=new salesforce_service_1[(_0x1f5b4c(0x106))]({'connection':this[_0x1f5b4c(0x107)]}),this['_packageExportService']=new package_export_service_1[(_0x1f5b4c(0x147))]({'veevaService':this[_0x1f5b4c(0x13b)],'connection':this[_0x1f5b4c(0xe4)],'logger':this[_0x1f5b4c(0x11b)]});}async[a339_0x119cbf(0x12e)](){const _0x2acc9f=a339_0x119cbf;try{this[_0x2acc9f(0x11b)][_0x2acc9f(0x114)](_0x2acc9f(0x144));const _0x394a97=await this['retrieveVeevaComponents']();await this[_0x2acc9f(0x11b)][_0x2acc9f(0x109)]();const _0x404320=await this['_packageExportService'][_0x2acc9f(0x108)](_0x394a97,SnapshotService[_0x2acc9f(0x14f)]);await this[_0x2acc9f(0x11b)][_0x2acc9f(0x109)]();const _0x310aff=await this[_0x2acc9f(0x13c)](_0x394a97,_0x404320);await this[_0x2acc9f(0x14e)](_0x310aff),await this[_0x2acc9f(0x11b)][_0x2acc9f(0x109)](),await this['finishSnapshot'](!![]);}catch(_0x56c95e){this[_0x2acc9f(0x11b)]['logError'](_0x56c95e),await this[_0x2acc9f(0x115)](![])[_0x2acc9f(0x124)](_0x18c3f9=>this[_0x2acc9f(0xe7)][_0x2acc9f(0x145)](_0x18c3f9));}}async['retrieveVeevaComponents'](){const _0x1274c8=a339_0x119cbf,_0x255f71={'veevaService':this['_veevaService'],'logger':this[_0x1274c8(0x11b)]},_0x4d2a1a=Array[_0x1274c8(0x12b)](Object['values'](this[_0x1274c8(0x10d)]))[_0x1274c8(0x127)]?new type_and_name_veeva_component_retriever_1[(_0x1274c8(0x129))]({'value':this[_0x1274c8(0x10d)],..._0x255f71}):new type_veeva_component_retriever_1[(_0x1274c8(0x139))]({'value':this[_0x1274c8(0xf7)],..._0x255f71});return _0x4d2a1a[_0x1274c8(0x120)]();}async['createMetadataItemListWithBody'](_0x1af6f8,_0x233a31){const _0x1379e4=a339_0x119cbf;var _0x31ed1d;this[_0x1379e4(0x11b)][_0x1379e4(0x114)](_0x1379e4(0x10f));const _0x1f37d8=this[_0x1379e4(0x10c)](_0x1af6f8),_0x5aa071=_0x1f37d8[_0x1379e4(0xfd)]((_0x3458c9,_0x18569c)=>_0x3458c9[_0x1379e4(0x14c)](_0x18569c[_0x1379e4(0xe8)],_0x18569c),new Map());for(const _0x5dd3c6 of _0x233a31){for(const _0x305de3 in _0x5dd3c6[_0x1379e4(0x128)]){const _0x58af0c=_0x305de3[_0x1379e4(0x123)]('/')['at'](-0x1);if(_0x5aa071[_0x1379e4(0xf6)](_0x58af0c)){const _0x14a838=await((_0x31ed1d=_0x5dd3c6[_0x1379e4(0x14b)](_0x305de3))===null||_0x31ed1d===void 0x0?void 0x0:_0x31ed1d['async'](_0x1379e4(0x141)));if(_0x14a838){const _0x2a99fd=new jszip_1[(_0x1379e4(0x154))]();_0x2a99fd[_0x1379e4(0x14b)](_0x58af0c,_0x14a838),_0x5aa071[_0x1379e4(0xef)](_0x58af0c)[_0x1379e4(0xe9)]=await _0x2a99fd[_0x1379e4(0xf1)]({'type':_0x1379e4(0x103)});}}}}return _0x1f37d8[_0x1379e4(0x119)](_0x115f87=>!_0x115f87[_0x1379e4(0xe9)])['forEach'](_0x227689=>{const _0x43d304=_0x1379e4;this[_0x43d304(0x11b)][_0x43d304(0x114)](_0x43d304(0x153)+_0x227689[_0x43d304(0x12f)]+'.'+_0x227689[_0x43d304(0x11c)]+'\x20from\x20outbound\x20package');}),_0x1f37d8[_0x1379e4(0x119)](_0x20d902=>_0x20d902[_0x1379e4(0xe9)]);}[a339_0x119cbf(0x10c)](_0x222508){const _0x37474f=a339_0x119cbf;return _0x222508[_0x37474f(0x149)](_0x74c2b2=>{const _0x37d06c=_0x37474f,_0x37d310=new metadata_item_dto_1[(_0x37d06c(0x122))]();return _0x37d310['name']=_0x74c2b2[_0x37d06c(0x11c)],_0x37d310[_0x37d06c(0x156)]=_0x74c2b2[_0x37d06c(0x11c)],_0x37d310[_0x37d06c(0x12c)]=this['_snapshotId'],_0x37d310[_0x37d06c(0xe8)]=_0x74c2b2['type']+'.'+_0x74c2b2[_0x37d06c(0x11c)]+_0x37d06c(0x117),_0x37d310[_0x37d06c(0x12f)]=_0x74c2b2[_0x37d06c(0x133)],_0x37d310[_0x37d06c(0x10a)]=_0x74c2b2[_0x37d06c(0x10a)],_0x37d310['isRetrieved']=![],_0x37d310;});}async['saveComponentsInSalesforce'](_0x56c438){const _0x2112f3=a339_0x119cbf;this[_0x2112f3(0x11b)][_0x2112f3(0x114)](_0x2112f3(0x157)),await this['saveAttachments'](_0x56c438),this[_0x2112f3(0x11b)]['log'](_0x2112f3(0xea)+_0x56c438[_0x2112f3(0x127)]+'\x20Metadata\x20Items');const _0x5138df=_0x56c438[_0x2112f3(0x149)](_0x37f650=>{const _0x3249e5=_0x2112f3;return{[constants_1[_0x3249e5(0x143)]+_0x3249e5(0xfa)]:_0x37f650[_0x3249e5(0x11c)],[constants_1[_0x3249e5(0x143)]+_0x3249e5(0x125)]:_0x37f650[_0x3249e5(0x156)],[constants_1['FLOSUM_NAMESPACE']+_0x3249e5(0x140)]:_0x37f650[_0x3249e5(0x12c)],[constants_1['FLOSUM_NAMESPACE']+_0x3249e5(0xf5)]:_0x37f650[_0x3249e5(0xe8)],[constants_1[_0x3249e5(0x143)]+'Is_Retrieved__c']:_0x37f650[_0x3249e5(0x11e)],[constants_1['FLOSUM_NAMESPACE']+_0x3249e5(0xfe)]:_0x37f650[_0x3249e5(0x12f)],[constants_1['FLOSUM_NAMESPACE']+_0x3249e5(0xf2)]:_0x37f650['attachmentId'],[constants_1[_0x3249e5(0x143)]+'Last_Modified_Date__c']:_0x37f650[_0x3249e5(0x10a)]};}),_0x109d98=await this[_0x2112f3(0x105)][_0x2112f3(0x142)](constants_1[_0x2112f3(0x143)]+_0x2112f3(0x136),_0x5138df);let _0x474d60=!![];_0x109d98[_0x2112f3(0x13e)]((_0x1049a4,_0x1391d2)=>{const _0x30b0db=_0x2112f3;this[_0x30b0db(0x11b)][_0x30b0db(0x114)]('Saving\x20'+_0x56c438[_0x1391d2]['veevaComponentType']+'.'+_0x56c438[_0x1391d2]['name']);if(!_0x1049a4[_0x30b0db(0x12d)]){_0x474d60=![];const _0x3fc0f2=new salesforce_dml_error_1[(_0x30b0db(0xe1))](_0x1049a4[_0x30b0db(0x138)]);this['_logger'][_0x30b0db(0x111)](_0x3fc0f2);}});if(!_0x474d60)throw new Error('Cannot\x20Save\x20Metadata\x20Items');}async[a339_0x119cbf(0x112)](_0x3d6211){const _0x29d8b8=a339_0x119cbf,_0x12acbd=this[_0x29d8b8(0x121)](_0x3d6211),_0x42192e=await this['_salesforceService']['insertMultipleRecords'](SnapshotService[_0x29d8b8(0xe6)],_0x12acbd),_0x1e1aee=[];_0x42192e[_0x29d8b8(0x13e)]((_0xab33ad,_0x1129e1)=>{const _0x11d4e0=_0x29d8b8;_0xab33ad[_0x11d4e0(0x12d)]?(_0x3d6211[_0x1129e1]['attachmentId']=_0xab33ad['id'],_0x3d6211[_0x1129e1]['isRetrieved']=!![]):_0x1e1aee[_0x11d4e0(0x110)](..._0xab33ad[_0x11d4e0(0x138)]);});if(_0x1e1aee[_0x29d8b8(0x127)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x1e1aee);}[a339_0x119cbf(0x121)](_0x454254){const _0x44c102=a339_0x119cbf;return _0x454254[_0x44c102(0x149)](_0x29dfe9=>({'ParentId':this[_0x44c102(0x10e)],'Name':_0x29dfe9[_0x44c102(0x12f)],'ContentType':_0x44c102(0xfb),'Body':_0x29dfe9[_0x44c102(0xe9)],'Description':_0x29dfe9[_0x44c102(0x12f)]}));}async[a339_0x119cbf(0x115)](_0x3b8c8f){const _0xf83a80=a339_0x119cbf,_0x46f4b4={[constants_1['FLOSUM_NAMESPACE']+'Is_Completed__c']:!![],[constants_1[_0xf83a80(0x143)]+_0xf83a80(0x14a)]:!_0x3b8c8f},_0x57d216={[constants_1[_0xf83a80(0x143)]+_0xf83a80(0x14a)]:!_0x3b8c8f,[constants_1[_0xf83a80(0x143)]+_0xf83a80(0x131)]:_0x3b8c8f,[constants_1[_0xf83a80(0x143)]+_0xf83a80(0x155)]:_0x3b8c8f?status_enums_1[_0xf83a80(0xff)]['COMPLETED']:status_enums_1[_0xf83a80(0xff)][_0xf83a80(0xeb)],[constants_1[_0xf83a80(0x143)]+'Job_Completed__c']:!![]};await this[_0xf83a80(0x107)][_0xf83a80(0x13d)](flosum_constants_1[_0xf83a80(0x14d)][_0xf83a80(0x100)]+'/'+constants_1[_0xf83a80(0x143)]+'Snapshot__c/'+this[_0xf83a80(0x10e)],_0x46f4b4),await this[_0xf83a80(0x107)][_0xf83a80(0x13d)](flosum_constants_1[_0xf83a80(0x14d)][_0xf83a80(0x100)]+'/'+constants_1[_0xf83a80(0x143)]+'Metadata_Log__c/'+this[_0xf83a80(0x10b)],_0x57d216),this[_0xf83a80(0x11b)][_0xf83a80(0x114)](_0xf83a80(0x151)+(_0x3b8c8f?'successfully':_0xf83a80(0x113))+'.'),await this['_logger']['updateLog']();}}exports[a339_0x119cbf(0x12a)]=SnapshotService,SnapshotService['OUTBOUND_PACKAGE_NAME']=a339_0x119cbf(0x146),SnapshotService[a339_0x119cbf(0xe6)]=a339_0x119cbf(0x150);