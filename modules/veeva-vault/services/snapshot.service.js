const a407_0x329e23=a407_0xc6f9;(function(_0x4cfc6a,_0x1cb477){const _0x423251=a407_0xc6f9,_0x573baa=_0x4cfc6a();while(!![]){try{const _0x287481=-parseInt(_0x423251(0x182))/0x1*(-parseInt(_0x423251(0x1c7))/0x2)+parseInt(_0x423251(0x19d))/0x3+parseInt(_0x423251(0x19e))/0x4+parseInt(_0x423251(0x1b7))/0x5*(-parseInt(_0x423251(0x1de))/0x6)+parseInt(_0x423251(0x1d1))/0x7+-parseInt(_0x423251(0x1cf))/0x8*(-parseInt(_0x423251(0x1d5))/0x9)+parseInt(_0x423251(0x173))/0xa*(-parseInt(_0x423251(0x190))/0xb);if(_0x287481===_0x1cb477)break;else _0x573baa['push'](_0x573baa['shift']());}catch(_0x5e1166){_0x573baa['push'](_0x573baa['shift']());}}}(a407_0x1603,0x19c52));function a407_0xc6f9(_0xf91ca7,_0x2a79a1){const _0x3dbdaa=a407_0x1603();return a407_0xc6f9=function(_0x100e90,_0x5e7b84){_0x100e90=_0x100e90-0x164;let _0x16038e=_0x3dbdaa[_0x100e90];return _0x16038e;},a407_0xc6f9(_0xf91ca7,_0x2a79a1);}function a407_0x1603(){const _0xdd2c35=['54aXBHzU','SnapshotService','Snapshot__c','Metadata_Item__c','_logger','_selectedMetaTypes','_connectionVeeva','Cannot\x20Save\x20Metadata\x20Items','Name__c','198ybmkRL','_salesforceService','posix','search','../classes/errors/salesforce-dml-error','application/zip','path','(((.+)+)+)+$','string','toString','../enums/status.enums','FlosumConstants','body','VeevaConstants','constructor','../constants/veeva.constants','updateLog','4369210JyDheD','_whereClause','TypeVeevaComponentRetriever','MDL_EXTENSION','success','\x20from\x20outbound\x20package','generateAsync','./package-export.service','\x20Metadata\x20Items','formAttachments','label','../constants/flosum.constants','Is_Error__c','EXCEPTION','MetadataLogStatus','112PibCZd','from','../../../constants','successfully','with\x20error','snapshotId','DEPENDENCY_EXTENSION','retrieveVeevaComponents','errors','parse','saveComponentsInSalesforce','finishSnapshot','Label__c','ATTACHMENT','11bXHrQI','_systemLogger','VeevaService','Attachment_ID__c','log','error','file','attachmentId','join','_selectedComponentMap','logError','_connectionSalesforce','csv-parse/sync','304908AFgVsr','827980WRlNCa','../classes/retrievers/veeva-components/type.veeva-component.retriever','__esModule','length','Status__c','Last_Modified_Date__c','ENDPOINT_UPSERT_RECORD','filter','PackageExportService','SalesforceDmlError','Snapshot\x20completed\x20','apiName','sep','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','apply','COMPLETED','_metadataLogId','Unpack\x20zip\x20and\x20create\x20metadata\x20items.','stringify','transformDependencyFile','formMetadataItemDtoList','map','createMetadataItemListWithBody','veevaComponentType','has','2230ncqvZC','Cannot\x20retrieve\x20','isRetrieved','async','name','Veeva_Component_Type__c','_veevaService','Is_Retrieved__c','Snapshot\x20started.','_packageExportService','lastModifiedDate','values','_snapshotId','files','default','type','3346EsXUzo','./veeva.service','export','push','MetadataItemDto','forEach','Succeed__c','./salesforce.service','56824vqwsOQ','retrieve','129976wYvkWS','FLOSUM_NAMESPACE','patch','OUTBOUND_PACKAGE_NAME'];a407_0x1603=function(){return _0xdd2c35;};return a407_0x1603();}const a407_0x5e7b84=(function(){let _0x290b86=!![];return function(_0x2ff5cb,_0x1e2d2d){const _0xa7977f=_0x290b86?function(){const _0x39bb60=a407_0xc6f9;if(_0x1e2d2d){const _0x490434=_0x1e2d2d[_0x39bb60(0x1ac)](_0x2ff5cb,arguments);return _0x1e2d2d=null,_0x490434;}}:function(){};return _0x290b86=![],_0xa7977f;};}()),a407_0x100e90=a407_0x5e7b84(this,function(){const _0x466934=a407_0xc6f9;return a407_0x100e90['toString']()[_0x466934(0x165)](_0x466934(0x169))[_0x466934(0x16b)]()[_0x466934(0x170)](a407_0x100e90)[_0x466934(0x165)](_0x466934(0x169));});a407_0x100e90();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x41ea4b){return _0x41ea4b&&_0x41ea4b['__esModule']?_0x41ea4b:{'default':_0x41ea4b};};Object['defineProperty'](exports,a407_0x329e23(0x1a0),{'value':!![]}),exports[a407_0x329e23(0x1d6)]=void 0x0;const jszip_1=__importDefault(require('jszip')),flosum_constants_1=require(a407_0x329e23(0x17e)),veeva_service_1=require(a407_0x329e23(0x1c8)),metadata_item_dto_1=require('../dtos/metadata-item.dto'),constants_1=require(a407_0x329e23(0x184)),salesforce_service_1=require(a407_0x329e23(0x1ce)),status_enums_1=require(a407_0x329e23(0x16c)),salesforce_dml_error_1=require(a407_0x329e23(0x166)),package_export_service_1=require(a407_0x329e23(0x17a)),type_and_name_veeva_component_retriever_1=require(a407_0x329e23(0x1ab)),type_veeva_component_retriever_1=require(a407_0x329e23(0x19f)),sync_1=require(a407_0x329e23(0x19c)),sync_2=require('csv-stringify/sync'),veeva_constants_1=require(a407_0x329e23(0x171)),path_1=__importDefault(require(a407_0x329e23(0x168)));class SnapshotService{constructor({snapshotId:_0x518f49,metadataLogId:_0x417a55,selectedMetaTypes:_0x541953,selectedComponentMap:_0x49beda,whereClause:_0x475cf0},_0x4a77c4,_0x151ccd,_0x26740a){const _0x4f175f=a407_0x329e23;this[_0x4f175f(0x19b)]=_0x4a77c4,this['_connectionVeeva']=_0x151ccd,this[_0x4f175f(0x1d9)]=_0x26740a,this[_0x4f175f(0x1c3)]=_0x518f49,this[_0x4f175f(0x1ae)]=_0x417a55,this[_0x4f175f(0x1da)]=_0x541953,this[_0x4f175f(0x199)]=_0x49beda,this[_0x4f175f(0x174)]=_0x475cf0,this[_0x4f175f(0x1bd)]=new veeva_service_1[(_0x4f175f(0x192))]({'connection':this['_connectionVeeva'],'logger':this[_0x4f175f(0x1d9)]}),this[_0x4f175f(0x1df)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x4f175f(0x19b)]}),this[_0x4f175f(0x1c0)]=new package_export_service_1[(_0x4f175f(0x1a6))]({'veevaService':this[_0x4f175f(0x1bd)],'connection':this[_0x4f175f(0x1db)],'logger':this[_0x4f175f(0x1d9)]});}async['execute'](){const _0x57d7b1=a407_0x329e23;try{this[_0x57d7b1(0x1d9)]['log'](_0x57d7b1(0x1bf));const _0xe9a314=await this[_0x57d7b1(0x189)]();await this[_0x57d7b1(0x1d9)][_0x57d7b1(0x172)]();const _0xa8aead=await this[_0x57d7b1(0x1c0)][_0x57d7b1(0x1c9)](_0xe9a314,SnapshotService[_0x57d7b1(0x1d4)]);await this[_0x57d7b1(0x1d9)][_0x57d7b1(0x172)]();const _0x142f8e=await this[_0x57d7b1(0x1b4)](_0xe9a314,_0xa8aead);await this[_0x57d7b1(0x18c)](_0x142f8e),await this['_logger']['updateLog'](),await this[_0x57d7b1(0x18d)](!![]);}catch(_0x4f8e61){this[_0x57d7b1(0x1d9)][_0x57d7b1(0x19a)](_0x4f8e61),await this[_0x57d7b1(0x18d)](![])['catch'](_0x254606=>this[_0x57d7b1(0x191)][_0x57d7b1(0x195)](_0x254606));}}async[a407_0x329e23(0x189)](){const _0x117b61=a407_0x329e23,_0x55f8e1={'veevaService':this[_0x117b61(0x1bd)],'logger':this[_0x117b61(0x1d9)]},_0x303bb5=Array[_0x117b61(0x183)](Object[_0x117b61(0x1c2)](this[_0x117b61(0x199)]))[_0x117b61(0x1a1)]?new type_and_name_veeva_component_retriever_1['TypeAndNameVeevaComponentRetriever']({'value':this[_0x117b61(0x199)],..._0x55f8e1}):new type_veeva_component_retriever_1[(_0x117b61(0x175))]({'value':this[_0x117b61(0x1da)],'whereClause':this[_0x117b61(0x174)],..._0x55f8e1});return _0x303bb5[_0x117b61(0x1d0)]();}async[a407_0x329e23(0x1b4)](_0x3df043,_0x2dbacb){const _0x2713c9=a407_0x329e23;var _0x17d3a1,_0x54107b;this[_0x2713c9(0x1d9)][_0x2713c9(0x194)](_0x2713c9(0x1af));const _0x340523=this['formMetadataItemDtoList'](_0x3df043),_0x13d86d=_0x340523['reduce']((_0x252dde,_0x1eeb78)=>_0x252dde['set'](_0x1eeb78[_0x2713c9(0x17d)],_0x1eeb78),new Map());for(const _0x112aa4 of _0x2dbacb){for(const _0x485cf0 in _0x112aa4[_0x2713c9(0x1c4)]){const {base:_0x1e64b1,name:_0x21ec54,dir:_0x426482}=path_1[_0x2713c9(0x1c5)][_0x2713c9(0x18b)](_0x485cf0),_0x5c5bab=_0x21ec54+veeva_constants_1[_0x2713c9(0x16f)][_0x2713c9(0x188)];if(_0x13d86d[_0x2713c9(0x1b6)](_0x1e64b1)){const _0x5b2541=await((_0x17d3a1=_0x112aa4[_0x2713c9(0x196)]([_0x426482,_0x1e64b1][_0x2713c9(0x198)](path_1['default'][_0x2713c9(0x164)]['sep'])))===null||_0x17d3a1===void 0x0?void 0x0:_0x17d3a1[_0x2713c9(0x1ba)](_0x2713c9(0x16a))),_0x5f55b4=await((_0x54107b=_0x112aa4[_0x2713c9(0x196)]([_0x426482,_0x5c5bab][_0x2713c9(0x198)](path_1['default']['posix'][_0x2713c9(0x1aa)])))===null||_0x54107b===void 0x0?void 0x0:_0x54107b[_0x2713c9(0x1ba)](_0x2713c9(0x16a)));if(_0x5b2541){const _0x3293e4=new jszip_1[(_0x2713c9(0x1c5))]();_0x3293e4[_0x2713c9(0x196)](_0x1e64b1,_0x5b2541),_0x5f55b4&&_0x3293e4[_0x2713c9(0x196)](_0x5c5bab,this[_0x2713c9(0x1b1)](_0x5f55b4)),_0x13d86d['get'](_0x1e64b1)[_0x2713c9(0x16e)]=await _0x3293e4[_0x2713c9(0x179)]({'type':'base64'});}}}}return _0x340523[_0x2713c9(0x1a5)](_0x4c60fe=>!_0x4c60fe['body'])['forEach'](_0x31d47b=>{const _0x33cf2e=_0x2713c9;this[_0x33cf2e(0x1d9)][_0x33cf2e(0x194)](_0x33cf2e(0x1b8)+_0x31d47b['veevaComponentType']+'.'+_0x31d47b[_0x33cf2e(0x1bb)]+_0x33cf2e(0x178));}),_0x340523[_0x2713c9(0x1a5)](_0x1e0219=>_0x1e0219['body']);}[a407_0x329e23(0x1b1)](_0x1b7dc9){const _0x5442b2=a407_0x329e23,_0x1fab99=(0x0,sync_1[_0x5442b2(0x18b)])(_0x1b7dc9,{'columns':!![],'skip_empty_lines':!![]}),_0x556b56=_0x1fab99['map'](({'In\x20Package':_0x4a66bb,..._0x508011})=>_0x508011);return(0x0,sync_2[_0x5442b2(0x1b0)])(_0x556b56,{'header':!![]});}[a407_0x329e23(0x1b2)](_0x3e5df5){const _0x22312c=a407_0x329e23;return _0x3e5df5[_0x22312c(0x1b3)](_0x1bf5bc=>{const _0x2198c8=_0x22312c,_0x553d3f=new metadata_item_dto_1[(_0x2198c8(0x1cb))]();return _0x553d3f['name']=_0x1bf5bc[_0x2198c8(0x1bb)],_0x553d3f['apiName']=_0x1bf5bc[_0x2198c8(0x1bb)],_0x553d3f[_0x2198c8(0x187)]=this[_0x2198c8(0x1c3)],_0x553d3f[_0x2198c8(0x17d)]=_0x1bf5bc[_0x2198c8(0x1c6)]+'.'+_0x1bf5bc[_0x2198c8(0x1bb)]+veeva_constants_1[_0x2198c8(0x16f)][_0x2198c8(0x176)],_0x553d3f['veevaComponentType']=_0x1bf5bc[_0x2198c8(0x1c6)],_0x553d3f[_0x2198c8(0x1c1)]=_0x1bf5bc[_0x2198c8(0x1c1)],_0x553d3f['isRetrieved']=![],_0x553d3f;});}async['saveComponentsInSalesforce'](_0x1937e7){const _0x5198f0=a407_0x329e23;this[_0x5198f0(0x1d9)][_0x5198f0(0x194)]('Saving\x20Attachments.'),await this['saveAttachments'](_0x1937e7),this['_logger'][_0x5198f0(0x194)]('Saving\x20'+_0x1937e7[_0x5198f0(0x1a1)]+_0x5198f0(0x17b));const _0x54e317=_0x1937e7[_0x5198f0(0x1b3)](_0x10804b=>{const _0x4c77ff=_0x5198f0;return{[constants_1[_0x4c77ff(0x1d2)]+_0x4c77ff(0x1dd)]:_0x10804b[_0x4c77ff(0x1bb)],[constants_1['FLOSUM_NAMESPACE']+'API_Name__c']:_0x10804b[_0x4c77ff(0x1a9)],[constants_1[_0x4c77ff(0x1d2)]+_0x4c77ff(0x1d7)]:_0x10804b[_0x4c77ff(0x187)],[constants_1[_0x4c77ff(0x1d2)]+_0x4c77ff(0x18e)]:_0x10804b[_0x4c77ff(0x17d)],[constants_1[_0x4c77ff(0x1d2)]+_0x4c77ff(0x1be)]:_0x10804b[_0x4c77ff(0x1b9)],[constants_1[_0x4c77ff(0x1d2)]+_0x4c77ff(0x1bc)]:_0x10804b['veevaComponentType'],[constants_1['FLOSUM_NAMESPACE']+_0x4c77ff(0x193)]:_0x10804b[_0x4c77ff(0x197)],[constants_1[_0x4c77ff(0x1d2)]+_0x4c77ff(0x1a3)]:_0x10804b[_0x4c77ff(0x1c1)]};}),_0x7ada07=await this[_0x5198f0(0x1df)]['insertMultipleRecords'](constants_1[_0x5198f0(0x1d2)]+_0x5198f0(0x1d8),_0x54e317);let _0x4412e1=!![];_0x7ada07[_0x5198f0(0x1cc)]((_0x5d0ee4,_0x4e7055)=>{const _0x1b37d1=_0x5198f0;this['_logger'][_0x1b37d1(0x194)]('Saving\x20'+_0x1937e7[_0x4e7055][_0x1b37d1(0x1b5)]+'.'+_0x1937e7[_0x4e7055][_0x1b37d1(0x1bb)]);if(!_0x5d0ee4[_0x1b37d1(0x177)]){_0x4412e1=![];const _0x1ad731=new salesforce_dml_error_1[(_0x1b37d1(0x1a7))](_0x5d0ee4[_0x1b37d1(0x18a)]);this[_0x1b37d1(0x1d9)][_0x1b37d1(0x19a)](_0x1ad731);}});if(!_0x4412e1)throw new Error(_0x5198f0(0x1dc));}async['saveAttachments'](_0x7e5a2d){const _0x11baf1=a407_0x329e23,_0x2d625b=this[_0x11baf1(0x17c)](_0x7e5a2d),_0x251d9a=await this['_salesforceService']['insertMultipleRecords'](SnapshotService[_0x11baf1(0x18f)],_0x2d625b),_0x47e04e=[];_0x251d9a[_0x11baf1(0x1cc)]((_0x248b9d,_0x2f3dde)=>{const _0x1fa16c=_0x11baf1;_0x248b9d['success']?(_0x7e5a2d[_0x2f3dde][_0x1fa16c(0x197)]=_0x248b9d['id'],_0x7e5a2d[_0x2f3dde][_0x1fa16c(0x1b9)]=!![]):_0x47e04e[_0x1fa16c(0x1ca)](..._0x248b9d['errors']);});if(_0x47e04e[_0x11baf1(0x1a1)])throw new salesforce_dml_error_1[(_0x11baf1(0x1a7))](_0x47e04e);}[a407_0x329e23(0x17c)](_0x1f80a1){const _0xa8f8df=a407_0x329e23;return _0x1f80a1['map'](_0x4ba198=>({'ParentId':this[_0xa8f8df(0x1c3)],'Name':_0x4ba198[_0xa8f8df(0x1b5)],'ContentType':_0xa8f8df(0x167),'Body':_0x4ba198[_0xa8f8df(0x16e)],'Description':_0x4ba198[_0xa8f8df(0x1b5)]}));}async[a407_0x329e23(0x18d)](_0x305269){const _0x21b872=a407_0x329e23,_0x2edfd8={[constants_1[_0x21b872(0x1d2)]+'Is_Completed__c']:!![],[constants_1[_0x21b872(0x1d2)]+'Is_Error__c']:!_0x305269},_0x206d07={[constants_1[_0x21b872(0x1d2)]+_0x21b872(0x17f)]:!_0x305269,[constants_1[_0x21b872(0x1d2)]+_0x21b872(0x1cd)]:_0x305269,[constants_1[_0x21b872(0x1d2)]+_0x21b872(0x1a2)]:_0x305269?status_enums_1[_0x21b872(0x181)][_0x21b872(0x1ad)]:status_enums_1['MetadataLogStatus'][_0x21b872(0x180)],[constants_1['FLOSUM_NAMESPACE']+'Job_Completed__c']:!![]};await this['_connectionSalesforce'][_0x21b872(0x1d3)](flosum_constants_1['FlosumConstants'][_0x21b872(0x1a4)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Snapshot__c/'+this[_0x21b872(0x1c3)],_0x2edfd8),await this['_connectionSalesforce'][_0x21b872(0x1d3)](flosum_constants_1[_0x21b872(0x16d)][_0x21b872(0x1a4)]+'/'+constants_1[_0x21b872(0x1d2)]+'Metadata_Log__c/'+this[_0x21b872(0x1ae)],_0x206d07),this['_logger'][_0x21b872(0x194)](_0x21b872(0x1a8)+(_0x305269?_0x21b872(0x185):_0x21b872(0x186))+'.'),await this[_0x21b872(0x1d9)][_0x21b872(0x172)]();}}exports['SnapshotService']=SnapshotService,SnapshotService[a407_0x329e23(0x1d4)]='Snapshot',SnapshotService['ATTACHMENT']='Attachment';