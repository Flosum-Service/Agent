const a406_0x434f5b=a406_0x2d52;(function(_0x1e8ad8,_0xf1047f){const _0xc0c72=a406_0x2d52,_0x26ddb8=_0x1e8ad8();while(!![]){try{const _0x1db19f=-parseInt(_0xc0c72(0x1e6))/0x1*(-parseInt(_0xc0c72(0x21a))/0x2)+parseInt(_0xc0c72(0x228))/0x3+-parseInt(_0xc0c72(0x241))/0x4*(parseInt(_0xc0c72(0x1dd))/0x5)+parseInt(_0xc0c72(0x1ff))/0x6+parseInt(_0xc0c72(0x21f))/0x7*(parseInt(_0xc0c72(0x24f))/0x8)+-parseInt(_0xc0c72(0x202))/0x9*(parseInt(_0xc0c72(0x1ed))/0xa)+parseInt(_0xc0c72(0x246))/0xb;if(_0x1db19f===_0xf1047f)break;else _0x26ddb8['push'](_0x26ddb8['shift']());}catch(_0x14ac5f){_0x26ddb8['push'](_0x26ddb8['shift']());}}}(a406_0x2d40,0x80eb3));function a406_0x2d52(_0xa0c645,_0x5c7bce){const _0xdb3139=a406_0x2d40();return a406_0x2d52=function(_0x1b18e6,_0x3e9cf3){_0x1b18e6=_0x1b18e6-0x1d9;let _0x2d4099=_0xdb3139[_0x1b18e6];return _0x2d4099;},a406_0x2d52(_0xa0c645,_0x5c7bce);}const a406_0x3e9cf3=(function(){let _0x4648e9=!![];return function(_0x4a2be8,_0x47ecf6){const _0x443f0f=_0x4648e9?function(){const _0x138b40=a406_0x2d52;if(_0x47ecf6){const _0x424174=_0x47ecf6[_0x138b40(0x223)](_0x4a2be8,arguments);return _0x47ecf6=null,_0x424174;}}:function(){};return _0x4648e9=![],_0x443f0f;};}()),a406_0x1b18e6=a406_0x3e9cf3(this,function(){const _0xbaf7a2=a406_0x2d52;return a406_0x1b18e6['toString']()['search'](_0xbaf7a2(0x1e9))[_0xbaf7a2(0x222)]()[_0xbaf7a2(0x24c)](a406_0x1b18e6)[_0xbaf7a2(0x258)](_0xbaf7a2(0x1e9));});a406_0x1b18e6();'use strict';var __importDefault=this&&this[a406_0x434f5b(0x235)]||function(_0x2aec31){const _0x5c9e67=a406_0x434f5b;return _0x2aec31&&_0x2aec31[_0x5c9e67(0x226)]?_0x2aec31:{'default':_0x2aec31};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a406_0x434f5b(0x23f)]=void 0x0;function a406_0x2d40(){const _0x5a8f01=['formMetadataItemDtoList','1939DQtXZd','csv-parse/sync','./salesforce.service','toString','apply','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','retrieveVeevaComponents','__esModule','./package-export.service','2204196bYYHCz','SalesforceService','files','../constants/flosum.constants','../classes/retrievers/veeva-components/type.veeva-component.retriever','_snapshotId','has','Cannot\x20retrieve\x20','TypeAndNameVeevaComponentRetriever','lastModifiedDate','Attachment_ID__c','values','Label__c','__importDefault','../../../constants','application/zip','Is_Error__c','with\x20error','PackageExportService','Name__c','FlosumConstants','type','_logger','SnapshotService','forEach','4604reCDnW','base64','formAttachments','Metadata_Item__c','saveAttachments','1389520VUeZmw','path','../classes/errors/salesforce-dml-error','label','execute','TypeVeevaComponentRetriever','constructor','Cannot\x20Save\x20Metadata\x20Items','set','15216CtVPLw','Last_Modified_Date__c','_metadataLogId','\x20Metadata\x20Items','attachmentId','_selectedMetaTypes','Attachment','MetadataLogStatus','error','search','apiName','_salesforceService','_connectionVeeva','snapshotId','3830yHDmAC','async','FLOSUM_NAMESPACE','VeevaConstants','catch','./veeva.service','stringify','retrieve','COMPLETED','9887YMmleS','posix','veevaComponentType','(((.+)+)+)+$','API_Name__c','Veeva_Component_Type__c','Snapshot','3930nQVGgy','Is_Completed__c','file','Saving\x20','body','Succeed__c','DEPENDENCY_EXTENSION','map','generateAsync','_selectedComponentMap','Unpack\x20zip\x20and\x20create\x20metadata\x20items.','Snapshot__c/','ENDPOINT_UPSERT_RECORD','export','_whereClause','saveComponentsInSalesforce','csv-stringify/sync','filter','1821558rkQjdt','_veevaService','Saving\x20Attachments.','10755nHbjoX','Snapshot\x20completed\x20','Snapshot__c','OUTBOUND_PACKAGE_NAME','log','transformDependencyFile','string','updateLog','../enums/status.enums','sep','finishSnapshot','insertMultipleRecords','get','createMetadataItemListWithBody','reduce','_connectionSalesforce','isRetrieved','MetadataItemDto','SalesforceDmlError','default','length','EXCEPTION','errors','_packageExportService','38zyQrjZ','parse','name','../constants/veeva.constants'];a406_0x2d40=function(){return _0x5a8f01;};return a406_0x2d40();}const jszip_1=__importDefault(require('jszip')),flosum_constants_1=require(a406_0x434f5b(0x22b)),veeva_service_1=require(a406_0x434f5b(0x1e2)),metadata_item_dto_1=require('../dtos/metadata-item.dto'),constants_1=require(a406_0x434f5b(0x236)),salesforce_service_1=require(a406_0x434f5b(0x221)),status_enums_1=require(a406_0x434f5b(0x20a)),salesforce_dml_error_1=require(a406_0x434f5b(0x248)),package_export_service_1=require(a406_0x434f5b(0x227)),type_and_name_veeva_component_retriever_1=require(a406_0x434f5b(0x224)),type_veeva_component_retriever_1=require(a406_0x434f5b(0x22c)),sync_1=require(a406_0x434f5b(0x220)),sync_2=require(a406_0x434f5b(0x1fd)),veeva_constants_1=require(a406_0x434f5b(0x21d)),path_1=__importDefault(require(a406_0x434f5b(0x247)));class SnapshotService{constructor({snapshotId:_0x1e2656,metadataLogId:_0x414d64,selectedMetaTypes:_0x455c14,selectedComponentMap:_0x5d29c5,whereClause:_0x233b96},_0x350955,_0x26e546,_0x5f574d){const _0x37d159=a406_0x434f5b;this[_0x37d159(0x211)]=_0x350955,this[_0x37d159(0x1db)]=_0x26e546,this[_0x37d159(0x23e)]=_0x5f574d,this[_0x37d159(0x22d)]=_0x1e2656,this['_metadataLogId']=_0x414d64,this[_0x37d159(0x254)]=_0x455c14,this[_0x37d159(0x1f6)]=_0x5d29c5,this['_whereClause']=_0x233b96,this[_0x37d159(0x200)]=new veeva_service_1['VeevaService']({'connection':this['_connectionVeeva'],'logger':this[_0x37d159(0x23e)]}),this['_salesforceService']=new salesforce_service_1[(_0x37d159(0x229))]({'connection':this['_connectionSalesforce']}),this[_0x37d159(0x219)]=new package_export_service_1[(_0x37d159(0x23a))]({'veevaService':this[_0x37d159(0x200)],'connection':this[_0x37d159(0x1db)],'logger':this[_0x37d159(0x23e)]});}async[a406_0x434f5b(0x24a)](){const _0x2eaa32=a406_0x434f5b;try{this[_0x2eaa32(0x23e)][_0x2eaa32(0x206)]('Snapshot\x20started.');const _0x1c602c=await this[_0x2eaa32(0x225)]();await this[_0x2eaa32(0x23e)]['updateLog']();const _0x4cd862=await this[_0x2eaa32(0x219)][_0x2eaa32(0x1fa)](_0x1c602c,SnapshotService[_0x2eaa32(0x205)]);await this['_logger']['updateLog']();const _0x125694=await this['createMetadataItemListWithBody'](_0x1c602c,_0x4cd862);await this['saveComponentsInSalesforce'](_0x125694),await this[_0x2eaa32(0x23e)][_0x2eaa32(0x209)](),await this[_0x2eaa32(0x20c)](!![]);}catch(_0x393204){this[_0x2eaa32(0x23e)]['logError'](_0x393204),await this['finishSnapshot'](![])[_0x2eaa32(0x1e1)](_0x9a11b4=>this['_systemLogger'][_0x2eaa32(0x257)](_0x9a11b4));}}async['retrieveVeevaComponents'](){const _0x413171=a406_0x434f5b,_0x2e058f={'veevaService':this['_veevaService'],'logger':this[_0x413171(0x23e)]},_0x41edbd=Array['from'](Object[_0x413171(0x233)](this[_0x413171(0x1f6)]))[_0x413171(0x216)]?new type_and_name_veeva_component_retriever_1[(_0x413171(0x230))]({'value':this[_0x413171(0x1f6)],..._0x2e058f}):new type_veeva_component_retriever_1[(_0x413171(0x24b))]({'value':this[_0x413171(0x254)],'whereClause':this[_0x413171(0x1fb)],..._0x2e058f});return _0x41edbd[_0x413171(0x1e4)]();}async[a406_0x434f5b(0x20f)](_0x44b90a,_0x3c798a){const _0x2759cc=a406_0x434f5b;var _0x2b00f7,_0x5a9478;this['_logger']['log'](_0x2759cc(0x1f7));const _0x41d461=this[_0x2759cc(0x21e)](_0x44b90a),_0x1bad70=_0x41d461[_0x2759cc(0x210)]((_0x2c4542,_0xcb247e)=>_0x2c4542[_0x2759cc(0x24e)](_0xcb247e[_0x2759cc(0x249)],_0xcb247e),new Map());for(const _0x229818 of _0x3c798a){for(const _0x20419d in _0x229818[_0x2759cc(0x22a)]){const {base:_0x5153a1,name:_0x50a49b,dir:_0x4bc12e}=path_1[_0x2759cc(0x215)][_0x2759cc(0x21b)](_0x20419d),_0x5cb7cd=_0x50a49b+veeva_constants_1[_0x2759cc(0x1e0)][_0x2759cc(0x1f3)];if(_0x1bad70[_0x2759cc(0x22e)](_0x5153a1)){const _0xca9d03=await((_0x2b00f7=_0x229818[_0x2759cc(0x1ef)]([_0x4bc12e,_0x5153a1]['join'](path_1[_0x2759cc(0x215)]['posix'][_0x2759cc(0x20b)])))===null||_0x2b00f7===void 0x0?void 0x0:_0x2b00f7[_0x2759cc(0x1de)](_0x2759cc(0x208))),_0x54f516=await((_0x5a9478=_0x229818[_0x2759cc(0x1ef)]([_0x4bc12e,_0x5cb7cd]['join'](path_1[_0x2759cc(0x215)][_0x2759cc(0x1e7)][_0x2759cc(0x20b)])))===null||_0x5a9478===void 0x0?void 0x0:_0x5a9478[_0x2759cc(0x1de)](_0x2759cc(0x208)));if(_0xca9d03){const _0x1e4ed=new jszip_1[(_0x2759cc(0x215))]();_0x1e4ed['file'](_0x5153a1,_0xca9d03),_0x54f516&&_0x1e4ed[_0x2759cc(0x1ef)](_0x5cb7cd,this[_0x2759cc(0x207)](_0x54f516)),_0x1bad70[_0x2759cc(0x20e)](_0x5153a1)[_0x2759cc(0x1f1)]=await _0x1e4ed[_0x2759cc(0x1f5)]({'type':_0x2759cc(0x242)});}}}}return _0x41d461['filter'](_0x51a2fc=>!_0x51a2fc[_0x2759cc(0x1f1)])[_0x2759cc(0x240)](_0x4fe7ab=>{const _0x49c007=_0x2759cc;this[_0x49c007(0x23e)][_0x49c007(0x206)](_0x49c007(0x22f)+_0x4fe7ab[_0x49c007(0x1e8)]+'.'+_0x4fe7ab[_0x49c007(0x21c)]+'\x20from\x20outbound\x20package');}),_0x41d461[_0x2759cc(0x1fe)](_0x24b809=>_0x24b809['body']);}[a406_0x434f5b(0x207)](_0x58bbb9){const _0x58ccbc=a406_0x434f5b,_0x471050=(0x0,sync_1[_0x58ccbc(0x21b)])(_0x58bbb9,{'columns':!![],'skip_empty_lines':!![]}),_0x5b8f41=_0x471050[_0x58ccbc(0x1f4)](({'In\x20Package':_0x4e0345,..._0x2f55db})=>_0x2f55db);return(0x0,sync_2[_0x58ccbc(0x1e3)])(_0x5b8f41,{'header':!![]});}[a406_0x434f5b(0x21e)](_0x208f65){const _0x2b5b36=a406_0x434f5b;return _0x208f65[_0x2b5b36(0x1f4)](_0x136148=>{const _0x2ba1f8=_0x2b5b36,_0x48e2bd=new metadata_item_dto_1[(_0x2ba1f8(0x213))]();return _0x48e2bd[_0x2ba1f8(0x21c)]=_0x136148[_0x2ba1f8(0x21c)],_0x48e2bd[_0x2ba1f8(0x1d9)]=_0x136148[_0x2ba1f8(0x21c)],_0x48e2bd[_0x2ba1f8(0x1dc)]=this['_snapshotId'],_0x48e2bd[_0x2ba1f8(0x249)]=_0x136148[_0x2ba1f8(0x23d)]+'.'+_0x136148[_0x2ba1f8(0x21c)]+veeva_constants_1[_0x2ba1f8(0x1e0)]['MDL_EXTENSION'],_0x48e2bd[_0x2ba1f8(0x1e8)]=_0x136148[_0x2ba1f8(0x23d)],_0x48e2bd[_0x2ba1f8(0x231)]=_0x136148[_0x2ba1f8(0x231)],_0x48e2bd[_0x2ba1f8(0x212)]=![],_0x48e2bd;});}async[a406_0x434f5b(0x1fc)](_0x349574){const _0xb5dfc3=a406_0x434f5b;this['_logger']['log'](_0xb5dfc3(0x201)),await this['saveAttachments'](_0x349574),this[_0xb5dfc3(0x23e)]['log'](_0xb5dfc3(0x1f0)+_0x349574['length']+_0xb5dfc3(0x252));const _0x426bbb=_0x349574[_0xb5dfc3(0x1f4)](_0x3f0a83=>{const _0x3109f6=_0xb5dfc3;return{[constants_1[_0x3109f6(0x1df)]+_0x3109f6(0x23b)]:_0x3f0a83[_0x3109f6(0x21c)],[constants_1[_0x3109f6(0x1df)]+_0x3109f6(0x1ea)]:_0x3f0a83[_0x3109f6(0x1d9)],[constants_1[_0x3109f6(0x1df)]+_0x3109f6(0x204)]:_0x3f0a83['snapshotId'],[constants_1['FLOSUM_NAMESPACE']+_0x3109f6(0x234)]:_0x3f0a83['label'],[constants_1[_0x3109f6(0x1df)]+'Is_Retrieved__c']:_0x3f0a83[_0x3109f6(0x212)],[constants_1[_0x3109f6(0x1df)]+_0x3109f6(0x1eb)]:_0x3f0a83[_0x3109f6(0x1e8)],[constants_1[_0x3109f6(0x1df)]+_0x3109f6(0x232)]:_0x3f0a83[_0x3109f6(0x253)],[constants_1[_0x3109f6(0x1df)]+_0x3109f6(0x250)]:_0x3f0a83[_0x3109f6(0x231)]};}),_0x1ab91e=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0xb5dfc3(0x1df)]+_0xb5dfc3(0x244),_0x426bbb);let _0x16b7d3=!![];_0x1ab91e[_0xb5dfc3(0x240)]((_0x3972bb,_0x32f60f)=>{const _0x3f4f40=_0xb5dfc3;this[_0x3f4f40(0x23e)][_0x3f4f40(0x206)](_0x3f4f40(0x1f0)+_0x349574[_0x32f60f][_0x3f4f40(0x1e8)]+'.'+_0x349574[_0x32f60f][_0x3f4f40(0x21c)]);if(!_0x3972bb['success']){_0x16b7d3=![];const _0x40e32e=new salesforce_dml_error_1[(_0x3f4f40(0x214))](_0x3972bb[_0x3f4f40(0x218)]);this[_0x3f4f40(0x23e)]['logError'](_0x40e32e);}});if(!_0x16b7d3)throw new Error(_0xb5dfc3(0x24d));}async[a406_0x434f5b(0x245)](_0x3f0cea){const _0xbf16fd=a406_0x434f5b,_0x53465c=this[_0xbf16fd(0x243)](_0x3f0cea),_0x4baa86=await this[_0xbf16fd(0x1da)][_0xbf16fd(0x20d)](SnapshotService['ATTACHMENT'],_0x53465c),_0x4408a8=[];_0x4baa86[_0xbf16fd(0x240)]((_0x5d9303,_0x4539e6)=>{const _0x3ffcd5=_0xbf16fd;_0x5d9303['success']?(_0x3f0cea[_0x4539e6][_0x3ffcd5(0x253)]=_0x5d9303['id'],_0x3f0cea[_0x4539e6]['isRetrieved']=!![]):_0x4408a8['push'](..._0x5d9303['errors']);});if(_0x4408a8[_0xbf16fd(0x216)])throw new salesforce_dml_error_1[(_0xbf16fd(0x214))](_0x4408a8);}[a406_0x434f5b(0x243)](_0x17954a){const _0x2b11ea=a406_0x434f5b;return _0x17954a[_0x2b11ea(0x1f4)](_0x4127a0=>({'ParentId':this['_snapshotId'],'Name':_0x4127a0[_0x2b11ea(0x1e8)],'ContentType':_0x2b11ea(0x237),'Body':_0x4127a0[_0x2b11ea(0x1f1)],'Description':_0x4127a0['veevaComponentType']}));}async['finishSnapshot'](_0xe2e327){const _0x43ac2d=a406_0x434f5b,_0xf18aec={[constants_1['FLOSUM_NAMESPACE']+_0x43ac2d(0x1ee)]:!![],[constants_1[_0x43ac2d(0x1df)]+_0x43ac2d(0x238)]:!_0xe2e327},_0x3d4f7e={[constants_1[_0x43ac2d(0x1df)]+_0x43ac2d(0x238)]:!_0xe2e327,[constants_1['FLOSUM_NAMESPACE']+_0x43ac2d(0x1f2)]:_0xe2e327,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0xe2e327?status_enums_1[_0x43ac2d(0x256)][_0x43ac2d(0x1e5)]:status_enums_1['MetadataLogStatus'][_0x43ac2d(0x217)],[constants_1[_0x43ac2d(0x1df)]+'Job_Completed__c']:!![]};await this[_0x43ac2d(0x211)]['patch'](flosum_constants_1[_0x43ac2d(0x23c)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x43ac2d(0x1df)]+_0x43ac2d(0x1f8)+this[_0x43ac2d(0x22d)],_0xf18aec),await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x43ac2d(0x23c)][_0x43ac2d(0x1f9)]+'/'+constants_1[_0x43ac2d(0x1df)]+'Metadata_Log__c/'+this[_0x43ac2d(0x251)],_0x3d4f7e),this[_0x43ac2d(0x23e)][_0x43ac2d(0x206)](_0x43ac2d(0x203)+(_0xe2e327?'successfully':_0x43ac2d(0x239))+'.'),await this[_0x43ac2d(0x23e)][_0x43ac2d(0x209)]();}}exports[a406_0x434f5b(0x23f)]=SnapshotService,SnapshotService[a406_0x434f5b(0x205)]=a406_0x434f5b(0x1ec),SnapshotService['ATTACHMENT']=a406_0x434f5b(0x255);