const a378_0x1b02fe=a378_0x4f78;function a378_0xd7c1(){const _0x3de510=['_metadataLogId','COMPLETED','SalesforceService','../classes/errors/salesforce-dml-error','execute','_logger','Snapshot\x20started.','values','\x20from\x20outbound\x20package','parse','MDL_EXTENSION','type','OUTBOUND_PACKAGE_NAME','SalesforceDmlError','name','Cannot\x20Save\x20Metadata\x20Items','csv-parse/sync','saveAttachments','forEach','with\x20error','body','VeevaConstants','1598634XllYUd','_connectionVeeva','generateAsync','from','FLOSUM_NAMESPACE','Metadata_Item__c','label','../dtos/metadata-item.dto','has','insertMultipleRecords','retrieve','constructor','FlosumConstants','length','export','set','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','../classes/retrievers/veeva-components/type.veeva-component.retriever','stringify','SnapshotService','saveComponentsInSalesforce','__importDefault','success','snapshotId','map','isRetrieved','successfully','Last_Modified_Date__c','attachmentId','filter','TypeAndNameVeevaComponentRetriever','7192bhgdZP','Snapshot__c/','_packageExportService','posix','toString','async','catch','Is_Retrieved__c','logError','application/zip','log','Attachment_ID__c','__esModule','_salesforceService','_veevaService','file','_snapshotId','Is_Completed__c','_selectedComponentMap','\x20Metadata\x20Items','sep','44RRLcBa','(((.+)+)+)+$','search','join','../constants/flosum.constants','get','DEPENDENCY_EXTENSION','Saving\x20','Attachment','reduce','./package-export.service','../../../constants','Succeed__c','base64','./veeva.service','patch','VeevaService','formMetadataItemDtoList','Is_Error__c','1546572jbFbKS','7577874YWaJJj','finishSnapshot','veevaComponentType','6611612cnJWMn','Metadata_Log__c/','formAttachments','lastModifiedDate','updateLog','errors','push','Snapshot__c','apply','transformDependencyFile','Snapshot','10KXLDpc','defineProperty','4561784bGwhvj','_connectionSalesforce','default','ATTACHMENT','string','../enums/status.enums','createMetadataItemListWithBody','_systemLogger','retrieveVeevaComponents','4174196pfqwms','_whereClause','Saving\x20Attachments.','MetadataLogStatus','_selectedMetaTypes'];a378_0xd7c1=function(){return _0x3de510;};return a378_0xd7c1();}(function(_0x19371c,_0x4e6829){const _0x5acea8=a378_0x4f78,_0x1b7f74=_0x19371c();while(!![]){try{const _0x4c37d0=parseInt(_0x5acea8(0x1cf))/0x1*(parseInt(_0x5acea8(0x1ba))/0x2)+-parseInt(_0x5acea8(0x1e2))/0x3+parseInt(_0x5acea8(0x180))/0x4+parseInt(_0x5acea8(0x1f1))/0x5*(parseInt(_0x5acea8(0x19b))/0x6)+-parseInt(_0x5acea8(0x1e6))/0x7+-parseInt(_0x5acea8(0x1f3))/0x8+parseInt(_0x5acea8(0x1e3))/0x9;if(_0x4c37d0===_0x4e6829)break;else _0x1b7f74['push'](_0x1b7f74['shift']());}catch(_0x4410f8){_0x1b7f74['push'](_0x1b7f74['shift']());}}}(a378_0xd7c1,0x85646));const a378_0x168622=(function(){let _0x18aca8=!![];return function(_0x2f639f,_0x4e26f5){const _0x1a4882=_0x18aca8?function(){const _0x2146d4=a378_0x4f78;if(_0x4e26f5){const _0x5f49cd=_0x4e26f5[_0x2146d4(0x1ee)](_0x2f639f,arguments);return _0x4e26f5=null,_0x5f49cd;}}:function(){};return _0x18aca8=![],_0x1a4882;};}()),a378_0x18e6a2=a378_0x168622(this,function(){const _0x5b6c20=a378_0x4f78;return a378_0x18e6a2[_0x5b6c20(0x1be)]()[_0x5b6c20(0x1d1)](_0x5b6c20(0x1d0))[_0x5b6c20(0x1be)]()[_0x5b6c20(0x1a6)](a378_0x18e6a2)[_0x5b6c20(0x1d1)]('(((.+)+)+)+$');});a378_0x18e6a2();'use strict';var __importDefault=this&&this[a378_0x1b02fe(0x1b0)]||function(_0x4906ab){const _0x4c71e0=a378_0x1b02fe;return _0x4906ab&&_0x4906ab[_0x4c71e0(0x1c6)]?_0x4906ab:{'default':_0x4906ab};};function a378_0x4f78(_0x315821,_0xe1306c){const _0x178408=a378_0xd7c1();return a378_0x4f78=function(_0x18e6a2,_0x168622){_0x18e6a2=_0x18e6a2-0x17e;let _0xd7c11e=_0x178408[_0x18e6a2];return _0xd7c11e;},a378_0x4f78(_0x315821,_0xe1306c);}Object[a378_0x1b02fe(0x1f2)](exports,a378_0x1b02fe(0x1c6),{'value':!![]}),exports[a378_0x1b02fe(0x1ae)]=void 0x0;const jszip_1=__importDefault(require('jszip')),flosum_constants_1=require(a378_0x1b02fe(0x1d3)),veeva_service_1=require(a378_0x1b02fe(0x1dd)),metadata_item_dto_1=require(a378_0x1b02fe(0x1a2)),constants_1=require(a378_0x1b02fe(0x1da)),salesforce_service_1=require('./salesforce.service'),status_enums_1=require(a378_0x1b02fe(0x1f8)),salesforce_dml_error_1=require(a378_0x1b02fe(0x188)),package_export_service_1=require(a378_0x1b02fe(0x1d9)),type_and_name_veeva_component_retriever_1=require(a378_0x1b02fe(0x1ab)),type_veeva_component_retriever_1=require(a378_0x1b02fe(0x1ac)),sync_1=require(a378_0x1b02fe(0x195)),sync_2=require('csv-stringify/sync'),veeva_constants_1=require('../constants/veeva.constants'),path_1=__importDefault(require('path'));class SnapshotService{constructor({snapshotId:_0x3ae0a6,metadataLogId:_0x296eae,selectedMetaTypes:_0x5e6c8f,selectedComponentMap:_0x273c81,whereClause:_0x3f5584},_0x389616,_0x27221e,_0x50ea63){const _0xc1065=a378_0x1b02fe;this[_0xc1065(0x1f4)]=_0x389616,this[_0xc1065(0x19c)]=_0x27221e,this[_0xc1065(0x18a)]=_0x50ea63,this['_snapshotId']=_0x3ae0a6,this['_metadataLogId']=_0x296eae,this[_0xc1065(0x184)]=_0x5e6c8f,this[_0xc1065(0x1cc)]=_0x273c81,this[_0xc1065(0x181)]=_0x3f5584,this[_0xc1065(0x1c8)]=new veeva_service_1[(_0xc1065(0x1df))]({'connection':this[_0xc1065(0x19c)],'logger':this[_0xc1065(0x18a)]}),this[_0xc1065(0x1c7)]=new salesforce_service_1[(_0xc1065(0x187))]({'connection':this[_0xc1065(0x1f4)]}),this[_0xc1065(0x1bc)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0xc1065(0x1c8)],'connection':this[_0xc1065(0x19c)],'logger':this['_logger']});}async[a378_0x1b02fe(0x189)](){const _0x2f4260=a378_0x1b02fe;try{this[_0x2f4260(0x18a)]['log'](_0x2f4260(0x18b));const _0x34128c=await this[_0x2f4260(0x17f)]();await this[_0x2f4260(0x18a)][_0x2f4260(0x1ea)]();const _0x38fb98=await this[_0x2f4260(0x1bc)][_0x2f4260(0x1a9)](_0x34128c,SnapshotService['OUTBOUND_PACKAGE_NAME']);await this[_0x2f4260(0x18a)][_0x2f4260(0x1ea)]();const _0x11443a=await this[_0x2f4260(0x1f9)](_0x34128c,_0x38fb98);await this[_0x2f4260(0x1af)](_0x11443a),await this[_0x2f4260(0x18a)][_0x2f4260(0x1ea)](),await this['finishSnapshot'](!![]);}catch(_0x420ab7){this[_0x2f4260(0x18a)][_0x2f4260(0x1c2)](_0x420ab7),await this[_0x2f4260(0x1e4)](![])[_0x2f4260(0x1c0)](_0x255d2a=>this[_0x2f4260(0x17e)]['error'](_0x255d2a));}}async['retrieveVeevaComponents'](){const _0x27d2e7=a378_0x1b02fe,_0x4fa5e1={'veevaService':this[_0x27d2e7(0x1c8)],'logger':this[_0x27d2e7(0x18a)]},_0x303a65=Array[_0x27d2e7(0x19e)](Object[_0x27d2e7(0x18c)](this[_0x27d2e7(0x1cc)]))[_0x27d2e7(0x1a8)]?new type_and_name_veeva_component_retriever_1[(_0x27d2e7(0x1b9))]({'value':this['_selectedComponentMap'],..._0x4fa5e1}):new type_veeva_component_retriever_1['TypeVeevaComponentRetriever']({'value':this[_0x27d2e7(0x184)],'whereClause':this[_0x27d2e7(0x181)],..._0x4fa5e1});return _0x303a65[_0x27d2e7(0x1a5)]();}async[a378_0x1b02fe(0x1f9)](_0x51a57c,_0x337def){const _0x10a658=a378_0x1b02fe;var _0x18b494,_0xbb49ff;this[_0x10a658(0x18a)][_0x10a658(0x1c4)]('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x6282a9=this[_0x10a658(0x1e0)](_0x51a57c),_0x5eafe9=_0x6282a9[_0x10a658(0x1d8)]((_0x5f41fa,_0x148db7)=>_0x5f41fa[_0x10a658(0x1aa)](_0x148db7[_0x10a658(0x1a1)],_0x148db7),new Map());for(const _0x652dfe of _0x337def){for(const _0x4a3248 in _0x652dfe['files']){const {base:_0x5218c4,name:_0x4b8c5e,dir:_0x5d6e4d}=path_1[_0x10a658(0x1f5)][_0x10a658(0x18e)](_0x4a3248),_0x4293ea=_0x4b8c5e+veeva_constants_1[_0x10a658(0x19a)][_0x10a658(0x1d5)];if(_0x5eafe9[_0x10a658(0x1a3)](_0x5218c4)){const _0x2bf350=await((_0x18b494=_0x652dfe['file']([_0x5d6e4d,_0x5218c4][_0x10a658(0x1d2)](path_1[_0x10a658(0x1f5)][_0x10a658(0x1bd)][_0x10a658(0x1ce)])))===null||_0x18b494===void 0x0?void 0x0:_0x18b494[_0x10a658(0x1bf)](_0x10a658(0x1f7))),_0x414cd1=await((_0xbb49ff=_0x652dfe[_0x10a658(0x1c9)]([_0x5d6e4d,_0x4293ea]['join'](path_1[_0x10a658(0x1f5)][_0x10a658(0x1bd)]['sep'])))===null||_0xbb49ff===void 0x0?void 0x0:_0xbb49ff['async']('string'));if(_0x2bf350){const _0x2831ee=new jszip_1[(_0x10a658(0x1f5))]();_0x2831ee[_0x10a658(0x1c9)](_0x5218c4,_0x2bf350),_0x414cd1&&_0x2831ee[_0x10a658(0x1c9)](_0x4293ea,this[_0x10a658(0x1ef)](_0x414cd1)),_0x5eafe9[_0x10a658(0x1d4)](_0x5218c4)['body']=await _0x2831ee[_0x10a658(0x19d)]({'type':_0x10a658(0x1dc)});}}}}return _0x6282a9[_0x10a658(0x1b8)](_0x36a994=>!_0x36a994[_0x10a658(0x199)])['forEach'](_0x304706=>{const _0x4df9f8=_0x10a658;this[_0x4df9f8(0x18a)][_0x4df9f8(0x1c4)]('Cannot\x20retrieve\x20'+_0x304706[_0x4df9f8(0x1e5)]+'.'+_0x304706[_0x4df9f8(0x193)]+_0x4df9f8(0x18d));}),_0x6282a9['filter'](_0x43523a=>_0x43523a[_0x10a658(0x199)]);}[a378_0x1b02fe(0x1ef)](_0x82608d){const _0x2b3d5f=a378_0x1b02fe,_0x144896=(0x0,sync_1[_0x2b3d5f(0x18e)])(_0x82608d,{'columns':!![],'skip_empty_lines':!![]}),_0x11dd1c=_0x144896['map'](({'In\x20Package':_0x3e3c66,..._0x41f233})=>_0x41f233);return(0x0,sync_2[_0x2b3d5f(0x1ad)])(_0x11dd1c,{'header':!![]});}['formMetadataItemDtoList'](_0x20c9eb){const _0x24f920=a378_0x1b02fe;return _0x20c9eb[_0x24f920(0x1b3)](_0x591699=>{const _0x48b836=_0x24f920,_0x32a73c=new metadata_item_dto_1['MetadataItemDto']();return _0x32a73c[_0x48b836(0x193)]=_0x591699[_0x48b836(0x193)],_0x32a73c['apiName']=_0x591699[_0x48b836(0x193)],_0x32a73c[_0x48b836(0x1b2)]=this[_0x48b836(0x1ca)],_0x32a73c['label']=_0x591699[_0x48b836(0x190)]+'.'+_0x591699[_0x48b836(0x193)]+veeva_constants_1[_0x48b836(0x19a)][_0x48b836(0x18f)],_0x32a73c['veevaComponentType']=_0x591699[_0x48b836(0x190)],_0x32a73c['lastModifiedDate']=_0x591699[_0x48b836(0x1e9)],_0x32a73c[_0x48b836(0x1b4)]=![],_0x32a73c;});}async[a378_0x1b02fe(0x1af)](_0x50c556){const _0x27e364=a378_0x1b02fe;this[_0x27e364(0x18a)][_0x27e364(0x1c4)](_0x27e364(0x182)),await this[_0x27e364(0x196)](_0x50c556),this['_logger'][_0x27e364(0x1c4)](_0x27e364(0x1d6)+_0x50c556[_0x27e364(0x1a8)]+_0x27e364(0x1cd));const _0x2a1967=_0x50c556[_0x27e364(0x1b3)](_0x1431d3=>{const _0x2899ac=_0x27e364;return{[constants_1[_0x2899ac(0x19f)]+'Name__c']:_0x1431d3[_0x2899ac(0x193)],[constants_1['FLOSUM_NAMESPACE']+'API_Name__c']:_0x1431d3['apiName'],[constants_1[_0x2899ac(0x19f)]+_0x2899ac(0x1ed)]:_0x1431d3['snapshotId'],[constants_1['FLOSUM_NAMESPACE']+'Label__c']:_0x1431d3[_0x2899ac(0x1a1)],[constants_1[_0x2899ac(0x19f)]+_0x2899ac(0x1c1)]:_0x1431d3[_0x2899ac(0x1b4)],[constants_1[_0x2899ac(0x19f)]+'Veeva_Component_Type__c']:_0x1431d3[_0x2899ac(0x1e5)],[constants_1[_0x2899ac(0x19f)]+_0x2899ac(0x1c5)]:_0x1431d3[_0x2899ac(0x1b7)],[constants_1[_0x2899ac(0x19f)]+_0x2899ac(0x1b6)]:_0x1431d3[_0x2899ac(0x1e9)]};}),_0x2c9c88=await this[_0x27e364(0x1c7)][_0x27e364(0x1a4)](constants_1[_0x27e364(0x19f)]+_0x27e364(0x1a0),_0x2a1967);let _0x2fa0f5=!![];_0x2c9c88[_0x27e364(0x197)]((_0xc1f096,_0x4189b7)=>{const _0x186da0=_0x27e364;this[_0x186da0(0x18a)]['log'](_0x186da0(0x1d6)+_0x50c556[_0x4189b7][_0x186da0(0x1e5)]+'.'+_0x50c556[_0x4189b7][_0x186da0(0x193)]);if(!_0xc1f096['success']){_0x2fa0f5=![];const _0x34903d=new salesforce_dml_error_1[(_0x186da0(0x192))](_0xc1f096['errors']);this[_0x186da0(0x18a)]['logError'](_0x34903d);}});if(!_0x2fa0f5)throw new Error(_0x27e364(0x194));}async[a378_0x1b02fe(0x196)](_0x3e2578){const _0x131b78=a378_0x1b02fe,_0x3edebb=this['formAttachments'](_0x3e2578),_0x35afed=await this[_0x131b78(0x1c7)]['insertMultipleRecords'](SnapshotService[_0x131b78(0x1f6)],_0x3edebb),_0x4a2640=[];_0x35afed[_0x131b78(0x197)]((_0x59d668,_0x539dab)=>{const _0x4bc8aa=_0x131b78;_0x59d668[_0x4bc8aa(0x1b1)]?(_0x3e2578[_0x539dab][_0x4bc8aa(0x1b7)]=_0x59d668['id'],_0x3e2578[_0x539dab][_0x4bc8aa(0x1b4)]=!![]):_0x4a2640[_0x4bc8aa(0x1ec)](..._0x59d668[_0x4bc8aa(0x1eb)]);});if(_0x4a2640[_0x131b78(0x1a8)])throw new salesforce_dml_error_1[(_0x131b78(0x192))](_0x4a2640);}[a378_0x1b02fe(0x1e8)](_0x2f7fae){const _0x1ffe53=a378_0x1b02fe;return _0x2f7fae[_0x1ffe53(0x1b3)](_0x49d82d=>({'ParentId':this['_snapshotId'],'Name':_0x49d82d[_0x1ffe53(0x1e5)],'ContentType':_0x1ffe53(0x1c3),'Body':_0x49d82d[_0x1ffe53(0x199)],'Description':_0x49d82d['veevaComponentType']}));}async['finishSnapshot'](_0x2f96aa){const _0x4919d2=a378_0x1b02fe,_0x5a6360={[constants_1[_0x4919d2(0x19f)]+_0x4919d2(0x1cb)]:!![],[constants_1[_0x4919d2(0x19f)]+'Is_Error__c']:!_0x2f96aa},_0x5cea6e={[constants_1[_0x4919d2(0x19f)]+_0x4919d2(0x1e1)]:!_0x2f96aa,[constants_1[_0x4919d2(0x19f)]+_0x4919d2(0x1db)]:_0x2f96aa,[constants_1[_0x4919d2(0x19f)]+'Status__c']:_0x2f96aa?status_enums_1[_0x4919d2(0x183)][_0x4919d2(0x186)]:status_enums_1[_0x4919d2(0x183)]['EXCEPTION'],[constants_1[_0x4919d2(0x19f)]+'Job_Completed__c']:!![]};await this[_0x4919d2(0x1f4)]['patch'](flosum_constants_1[_0x4919d2(0x1a7)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x4919d2(0x19f)]+_0x4919d2(0x1bb)+this['_snapshotId'],_0x5a6360),await this['_connectionSalesforce'][_0x4919d2(0x1de)](flosum_constants_1[_0x4919d2(0x1a7)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x4919d2(0x19f)]+_0x4919d2(0x1e7)+this[_0x4919d2(0x185)],_0x5cea6e),this['_logger'][_0x4919d2(0x1c4)]('Snapshot\x20completed\x20'+(_0x2f96aa?_0x4919d2(0x1b5):_0x4919d2(0x198))+'.'),await this[_0x4919d2(0x18a)][_0x4919d2(0x1ea)]();}}exports['SnapshotService']=SnapshotService,SnapshotService[a378_0x1b02fe(0x191)]=a378_0x1b02fe(0x1f0),SnapshotService[a378_0x1b02fe(0x1f6)]=a378_0x1b02fe(0x1d7);