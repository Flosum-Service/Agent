const a394_0x30db44=a394_0x3ac8;(function(_0x31effe,_0x1c3315){const _0x1c2382=a394_0x3ac8,_0x1661ab=_0x31effe();while(!![]){try{const _0x4b4129=-parseInt(_0x1c2382(0x219))/0x1+-parseInt(_0x1c2382(0x224))/0x2*(-parseInt(_0x1c2382(0x243))/0x3)+-parseInt(_0x1c2382(0x220))/0x4*(-parseInt(_0x1c2382(0x247))/0x5)+parseInt(_0x1c2382(0x22c))/0x6*(-parseInt(_0x1c2382(0x1f8))/0x7)+parseInt(_0x1c2382(0x214))/0x8*(-parseInt(_0x1c2382(0x1cd))/0x9)+parseInt(_0x1c2382(0x21e))/0xa*(-parseInt(_0x1c2382(0x1d0))/0xb)+-parseInt(_0x1c2382(0x1ca))/0xc*(-parseInt(_0x1c2382(0x1e0))/0xd);if(_0x4b4129===_0x1c3315)break;else _0x1661ab['push'](_0x1661ab['shift']());}catch(_0x1bd2f9){_0x1661ab['push'](_0x1661ab['shift']());}}}(a394_0x6b14,0xc0de4));function a394_0x3ac8(_0x4096ab,_0x423b9b){const _0x33624d=a394_0x6b14();return a394_0x3ac8=function(_0x4f57da,_0x432c73){_0x4f57da=_0x4f57da-0x1ca;let _0x6b1481=_0x33624d[_0x4f57da];return _0x6b1481;},a394_0x3ac8(_0x4096ab,_0x423b9b);}const a394_0x432c73=(function(){let _0x49fb57=!![];return function(_0x5cb9ba,_0x2acea4){const _0xda677c=_0x49fb57?function(){const _0x483429=a394_0x3ac8;if(_0x2acea4){const _0x3aa9d9=_0x2acea4[_0x483429(0x248)](_0x5cb9ba,arguments);return _0x2acea4=null,_0x3aa9d9;}}:function(){};return _0x49fb57=![],_0xda677c;};}()),a394_0x4f57da=a394_0x432c73(this,function(){const _0x1c668b=a394_0x3ac8;return a394_0x4f57da[_0x1c668b(0x221)]()[_0x1c668b(0x21c)](_0x1c668b(0x205))[_0x1c668b(0x221)]()['constructor'](a394_0x4f57da)['search'](_0x1c668b(0x205));});a394_0x4f57da();'use strict';var __importDefault=this&&this[a394_0x30db44(0x212)]||function(_0x491d9a){const _0x293549=a394_0x30db44;return _0x491d9a&&_0x491d9a[_0x293549(0x1d8)]?_0x491d9a:{'default':_0x491d9a};};function a394_0x6b14(){const _0x18736e=['type','_selectedComponentMap','_snapshotId','PackageExportService','lastModifiedDate','FlosumConstants','filter','Name__c','Is_Error__c','defineProperty','Metadata_Log__c/','Snapshot\x20started.','Is_Completed__c','isRetrieved','Snapshot__c/','logError','API_Name__c','from','../dtos/metadata-item.dto','_connectionVeeva','OUTBOUND_PACKAGE_NAME','insertMultipleRecords','31743FFHYeQ','VeevaService','sep','reduce','30qIODyb','apply','../classes/retrievers/veeva-components/type.veeva-component.retriever','1776hqxKWT','Snapshot','log','5121axZyQN','ENDPOINT_UPSERT_RECORD','parse','1111VaaJZU','finishSnapshot','posix','Unpack\x20zip\x20and\x20create\x20metadata\x20items.','updateLog','csv-parse/sync','jszip','string','__esModule','saveAttachments','FLOSUM_NAMESPACE','Job_Completed__c','Label__c','Attachment','base64','join','383539CdksXl','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','DEPENDENCY_EXTENSION','../constants/veeva.constants','saveComponentsInSalesforce','file','transformDependencyFile','execute','successfully','push','retrieveVeevaComponents','set','_veevaService','forEach','apiName','error','generateAsync','snapshotId','SalesforceService','success','Cannot\x20Save\x20Metadata\x20Items','Veeva_Component_Type__c','Snapshot__c','createMetadataItemListWithBody','11949VxGdGN','length','_logger','label','_systemLogger','name','\x20Metadata\x20Items','SalesforceDmlError','_salesforceService','Is_Retrieved__c','MDL_EXTENSION','stringify','../enums/status.enums','(((.+)+)+)+$','_connectionSalesforce','_selectedMetaTypes','Attachment_ID__c','../classes/errors/salesforce-dml-error','files','VeevaConstants','path','../constants/flosum.constants','has','values','TypeVeevaComponentRetriever','with\x20error','__importDefault','SnapshotService','17216HXOmZL','./salesforce.service','\x20from\x20outbound\x20package','_metadataLogId','map','1298063NoWQTb','export','Saving\x20Attachments.','search','ATTACHMENT','143890vUlhPS','default','591844KppSEv','toString','body','application/zip','150zwXMVO','Saving\x20','formMetadataItemDtoList','veevaComponentType','async','formAttachments','TypeAndNameVeevaComponentRetriever','./veeva.service','4506wNuYvZ'];a394_0x6b14=function(){return _0x18736e;};return a394_0x6b14();}Object[a394_0x30db44(0x236)](exports,a394_0x30db44(0x1d8),{'value':!![]}),exports[a394_0x30db44(0x213)]=void 0x0;const jszip_1=__importDefault(require(a394_0x30db44(0x1d6))),flosum_constants_1=require(a394_0x30db44(0x20d)),veeva_service_1=require(a394_0x30db44(0x22b)),metadata_item_dto_1=require(a394_0x30db44(0x23f)),constants_1=require('../../../constants'),salesforce_service_1=require(a394_0x30db44(0x215)),status_enums_1=require(a394_0x30db44(0x204)),salesforce_dml_error_1=require(a394_0x30db44(0x209)),package_export_service_1=require('./package-export.service'),type_and_name_veeva_component_retriever_1=require(a394_0x30db44(0x1e1)),type_veeva_component_retriever_1=require(a394_0x30db44(0x249)),sync_1=require(a394_0x30db44(0x1d5)),sync_2=require('csv-stringify/sync'),veeva_constants_1=require(a394_0x30db44(0x1e3)),path_1=__importDefault(require(a394_0x30db44(0x20c)));class SnapshotService{constructor({snapshotId:_0x42711b,metadataLogId:_0x2f5d55,selectedMetaTypes:_0x144423,selectedComponentMap:_0x497868,whereClause:_0x17f85c},_0x24ec48,_0x3dd6c8,_0x1183e7){const _0x17b7a0=a394_0x30db44;this[_0x17b7a0(0x206)]=_0x24ec48,this[_0x17b7a0(0x240)]=_0x3dd6c8,this['_logger']=_0x1183e7,this[_0x17b7a0(0x22f)]=_0x42711b,this[_0x17b7a0(0x217)]=_0x2f5d55,this[_0x17b7a0(0x207)]=_0x144423,this[_0x17b7a0(0x22e)]=_0x497868,this['_whereClause']=_0x17f85c,this[_0x17b7a0(0x1ec)]=new veeva_service_1[(_0x17b7a0(0x244))]({'connection':this[_0x17b7a0(0x240)],'logger':this[_0x17b7a0(0x1fa)]}),this[_0x17b7a0(0x200)]=new salesforce_service_1[(_0x17b7a0(0x1f2))]({'connection':this[_0x17b7a0(0x206)]}),this['_packageExportService']=new package_export_service_1[(_0x17b7a0(0x230))]({'veevaService':this[_0x17b7a0(0x1ec)],'connection':this[_0x17b7a0(0x240)],'logger':this[_0x17b7a0(0x1fa)]});}async[a394_0x30db44(0x1e7)](){const _0x4b1473=a394_0x30db44;try{this[_0x4b1473(0x1fa)]['log'](_0x4b1473(0x238));const _0x1cb572=await this[_0x4b1473(0x1ea)]();await this[_0x4b1473(0x1fa)][_0x4b1473(0x1d4)]();const _0xe69cc6=await this['_packageExportService'][_0x4b1473(0x21a)](_0x1cb572,SnapshotService[_0x4b1473(0x241)]);await this[_0x4b1473(0x1fa)][_0x4b1473(0x1d4)]();const _0x350f6b=await this['createMetadataItemListWithBody'](_0x1cb572,_0xe69cc6);await this['saveComponentsInSalesforce'](_0x350f6b),await this[_0x4b1473(0x1fa)][_0x4b1473(0x1d4)](),await this['finishSnapshot'](!![]);}catch(_0x18b910){this[_0x4b1473(0x1fa)][_0x4b1473(0x23c)](_0x18b910),await this[_0x4b1473(0x1d1)](![])['catch'](_0x4822b2=>this[_0x4b1473(0x1fc)][_0x4b1473(0x1ef)](_0x4822b2));}}async[a394_0x30db44(0x1ea)](){const _0x3cc4f4=a394_0x30db44,_0x58eb46={'veevaService':this[_0x3cc4f4(0x1ec)],'logger':this[_0x3cc4f4(0x1fa)]},_0x1db292=Array[_0x3cc4f4(0x23e)](Object[_0x3cc4f4(0x20f)](this['_selectedComponentMap']))[_0x3cc4f4(0x1f9)]?new type_and_name_veeva_component_retriever_1[(_0x3cc4f4(0x22a))]({'value':this[_0x3cc4f4(0x22e)],..._0x58eb46}):new type_veeva_component_retriever_1[(_0x3cc4f4(0x210))]({'value':this[_0x3cc4f4(0x207)],'whereClause':this['_whereClause'],..._0x58eb46});return _0x1db292['retrieve']();}async[a394_0x30db44(0x1f7)](_0x336b74,_0x539b23){const _0xa8be3b=a394_0x30db44;var _0x16ef5e,_0x4cb860;this[_0xa8be3b(0x1fa)][_0xa8be3b(0x1cc)](_0xa8be3b(0x1d3));const _0x234302=this[_0xa8be3b(0x226)](_0x336b74),_0x182425=_0x234302[_0xa8be3b(0x246)]((_0x154d19,_0x5a195b)=>_0x154d19[_0xa8be3b(0x1eb)](_0x5a195b[_0xa8be3b(0x1fb)],_0x5a195b),new Map());for(const _0x30f4fa of _0x539b23){for(const _0x3eb43c in _0x30f4fa[_0xa8be3b(0x20a)]){const {base:_0x3f86d1,name:_0x34fb01,dir:_0x4cc74c}=path_1['default']['parse'](_0x3eb43c),_0x409bfa=_0x34fb01+veeva_constants_1[_0xa8be3b(0x20b)][_0xa8be3b(0x1e2)];if(_0x182425[_0xa8be3b(0x20e)](_0x3f86d1)){const _0x310ba1=await((_0x16ef5e=_0x30f4fa[_0xa8be3b(0x1e5)]([_0x4cc74c,_0x3f86d1][_0xa8be3b(0x1df)](path_1[_0xa8be3b(0x21f)][_0xa8be3b(0x1d2)][_0xa8be3b(0x245)])))===null||_0x16ef5e===void 0x0?void 0x0:_0x16ef5e[_0xa8be3b(0x228)](_0xa8be3b(0x1d7))),_0x2f6f53=await((_0x4cb860=_0x30f4fa[_0xa8be3b(0x1e5)]([_0x4cc74c,_0x409bfa][_0xa8be3b(0x1df)](path_1[_0xa8be3b(0x21f)][_0xa8be3b(0x1d2)][_0xa8be3b(0x245)])))===null||_0x4cb860===void 0x0?void 0x0:_0x4cb860[_0xa8be3b(0x228)](_0xa8be3b(0x1d7)));if(_0x310ba1){const _0x4a4859=new jszip_1[(_0xa8be3b(0x21f))]();_0x4a4859[_0xa8be3b(0x1e5)](_0x3f86d1,_0x310ba1),_0x2f6f53&&_0x4a4859[_0xa8be3b(0x1e5)](_0x409bfa,this['transformDependencyFile'](_0x2f6f53)),_0x182425['get'](_0x3f86d1)['body']=await _0x4a4859[_0xa8be3b(0x1f0)]({'type':_0xa8be3b(0x1de)});}}}}return _0x234302[_0xa8be3b(0x233)](_0x36f795=>!_0x36f795[_0xa8be3b(0x222)])[_0xa8be3b(0x1ed)](_0x41eadc=>{const _0x8ae428=_0xa8be3b;this[_0x8ae428(0x1fa)][_0x8ae428(0x1cc)]('Cannot\x20retrieve\x20'+_0x41eadc[_0x8ae428(0x227)]+'.'+_0x41eadc['name']+_0x8ae428(0x216));}),_0x234302[_0xa8be3b(0x233)](_0x11ef4a=>_0x11ef4a[_0xa8be3b(0x222)]);}[a394_0x30db44(0x1e6)](_0x52bf30){const _0x47ec7b=a394_0x30db44,_0x2ddf05=(0x0,sync_1[_0x47ec7b(0x1cf)])(_0x52bf30,{'columns':!![],'skip_empty_lines':!![]}),_0x570ff4=_0x2ddf05[_0x47ec7b(0x218)](({'In\x20Package':_0x2c808d,..._0x24ba60})=>_0x24ba60);return(0x0,sync_2[_0x47ec7b(0x203)])(_0x570ff4,{'header':!![]});}['formMetadataItemDtoList'](_0x39bfb4){const _0x3337ed=a394_0x30db44;return _0x39bfb4[_0x3337ed(0x218)](_0x58a2db=>{const _0x4e389c=_0x3337ed,_0x3fffe6=new metadata_item_dto_1['MetadataItemDto']();return _0x3fffe6['name']=_0x58a2db[_0x4e389c(0x1fd)],_0x3fffe6['apiName']=_0x58a2db[_0x4e389c(0x1fd)],_0x3fffe6[_0x4e389c(0x1f1)]=this[_0x4e389c(0x22f)],_0x3fffe6['label']=_0x58a2db[_0x4e389c(0x22d)]+'.'+_0x58a2db[_0x4e389c(0x1fd)]+veeva_constants_1['VeevaConstants'][_0x4e389c(0x202)],_0x3fffe6[_0x4e389c(0x227)]=_0x58a2db[_0x4e389c(0x22d)],_0x3fffe6[_0x4e389c(0x231)]=_0x58a2db[_0x4e389c(0x231)],_0x3fffe6[_0x4e389c(0x23a)]=![],_0x3fffe6;});}async[a394_0x30db44(0x1e4)](_0x29ee4e){const _0x37096e=a394_0x30db44;this[_0x37096e(0x1fa)][_0x37096e(0x1cc)](_0x37096e(0x21b)),await this[_0x37096e(0x1d9)](_0x29ee4e),this['_logger'][_0x37096e(0x1cc)](_0x37096e(0x225)+_0x29ee4e[_0x37096e(0x1f9)]+_0x37096e(0x1fe));const _0xc143f4=_0x29ee4e[_0x37096e(0x218)](_0x2a7d6e=>{const _0xd7cd73=_0x37096e;return{[constants_1['FLOSUM_NAMESPACE']+_0xd7cd73(0x234)]:_0x2a7d6e[_0xd7cd73(0x1fd)],[constants_1[_0xd7cd73(0x1da)]+_0xd7cd73(0x23d)]:_0x2a7d6e[_0xd7cd73(0x1ee)],[constants_1[_0xd7cd73(0x1da)]+_0xd7cd73(0x1f6)]:_0x2a7d6e[_0xd7cd73(0x1f1)],[constants_1[_0xd7cd73(0x1da)]+_0xd7cd73(0x1dc)]:_0x2a7d6e[_0xd7cd73(0x1fb)],[constants_1[_0xd7cd73(0x1da)]+_0xd7cd73(0x201)]:_0x2a7d6e['isRetrieved'],[constants_1[_0xd7cd73(0x1da)]+_0xd7cd73(0x1f5)]:_0x2a7d6e[_0xd7cd73(0x227)],[constants_1[_0xd7cd73(0x1da)]+_0xd7cd73(0x208)]:_0x2a7d6e['attachmentId'],[constants_1['FLOSUM_NAMESPACE']+'Last_Modified_Date__c']:_0x2a7d6e[_0xd7cd73(0x231)]};}),_0x37ffd3=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x37096e(0x1da)]+'Metadata_Item__c',_0xc143f4);let _0x33b6b5=!![];_0x37ffd3[_0x37096e(0x1ed)]((_0x482a94,_0x41b1a7)=>{const _0x46655c=_0x37096e;this[_0x46655c(0x1fa)][_0x46655c(0x1cc)](_0x46655c(0x225)+_0x29ee4e[_0x41b1a7][_0x46655c(0x227)]+'.'+_0x29ee4e[_0x41b1a7][_0x46655c(0x1fd)]);if(!_0x482a94[_0x46655c(0x1f3)]){_0x33b6b5=![];const _0x34b312=new salesforce_dml_error_1[(_0x46655c(0x1ff))](_0x482a94['errors']);this[_0x46655c(0x1fa)][_0x46655c(0x23c)](_0x34b312);}});if(!_0x33b6b5)throw new Error(_0x37096e(0x1f4));}async[a394_0x30db44(0x1d9)](_0x87d27b){const _0x287d7a=a394_0x30db44,_0x237b92=this[_0x287d7a(0x229)](_0x87d27b),_0x530390=await this[_0x287d7a(0x200)][_0x287d7a(0x242)](SnapshotService[_0x287d7a(0x21d)],_0x237b92),_0x3ad22a=[];_0x530390[_0x287d7a(0x1ed)]((_0x36e6a0,_0x12f3b4)=>{const _0xeb5a95=_0x287d7a;_0x36e6a0['success']?(_0x87d27b[_0x12f3b4]['attachmentId']=_0x36e6a0['id'],_0x87d27b[_0x12f3b4]['isRetrieved']=!![]):_0x3ad22a[_0xeb5a95(0x1e9)](..._0x36e6a0['errors']);});if(_0x3ad22a[_0x287d7a(0x1f9)])throw new salesforce_dml_error_1[(_0x287d7a(0x1ff))](_0x3ad22a);}['formAttachments'](_0xfb0378){const _0x521a0d=a394_0x30db44;return _0xfb0378[_0x521a0d(0x218)](_0x18998c=>({'ParentId':this[_0x521a0d(0x22f)],'Name':_0x18998c['veevaComponentType'],'ContentType':_0x521a0d(0x223),'Body':_0x18998c[_0x521a0d(0x222)],'Description':_0x18998c['veevaComponentType']}));}async[a394_0x30db44(0x1d1)](_0x101591){const _0x5ab84a=a394_0x30db44,_0x1e4512={[constants_1['FLOSUM_NAMESPACE']+_0x5ab84a(0x239)]:!![],[constants_1[_0x5ab84a(0x1da)]+_0x5ab84a(0x235)]:!_0x101591},_0xf0207b={[constants_1[_0x5ab84a(0x1da)]+_0x5ab84a(0x235)]:!_0x101591,[constants_1[_0x5ab84a(0x1da)]+'Succeed__c']:_0x101591,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x101591?status_enums_1['MetadataLogStatus']['COMPLETED']:status_enums_1['MetadataLogStatus']['EXCEPTION'],[constants_1[_0x5ab84a(0x1da)]+_0x5ab84a(0x1db)]:!![]};await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x5ab84a(0x232)][_0x5ab84a(0x1ce)]+'/'+constants_1[_0x5ab84a(0x1da)]+_0x5ab84a(0x23b)+this[_0x5ab84a(0x22f)],_0x1e4512),await this[_0x5ab84a(0x206)]['patch'](flosum_constants_1['FlosumConstants'][_0x5ab84a(0x1ce)]+'/'+constants_1[_0x5ab84a(0x1da)]+_0x5ab84a(0x237)+this['_metadataLogId'],_0xf0207b),this[_0x5ab84a(0x1fa)][_0x5ab84a(0x1cc)]('Snapshot\x20completed\x20'+(_0x101591?_0x5ab84a(0x1e8):_0x5ab84a(0x211))+'.'),await this[_0x5ab84a(0x1fa)]['updateLog']();}}exports['SnapshotService']=SnapshotService,SnapshotService[a394_0x30db44(0x241)]=a394_0x30db44(0x1cb),SnapshotService[a394_0x30db44(0x21d)]=a394_0x30db44(0x1dd);