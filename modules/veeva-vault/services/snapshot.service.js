const a363_0x1fbf68=a363_0x2949;function a363_0x2cfd(){const _0x4cae7f=['toString','./salesforce.service','Status__c','112392zWAEbr','string','16340NRMdQt','base64','Metadata_Item__c','success','SalesforceService','../constants/veeva.constants','with\x20error','transformDependencyFile','forEach','values','(((.+)+)+)+$','saveComponentsInSalesforce','Cannot\x20retrieve\x20','patch','Saving\x20Attachments.','defineProperty','snapshotId','files','_connectionVeeva','4802739xdMiSF','async','updateLog','Label__c','FLOSUM_NAMESPACE','filter','catch','VeevaService','EXCEPTION','MetadataLogStatus','_selectedComponentMap','FlosumConstants','lastModifiedDate','Is_Error__c','map','7914270fNNNBv','type','2ezzPtN','search','length','generateAsync','_salesforceService','TypeVeevaComponentRetriever','_packageExportService','OUTBOUND_PACKAGE_NAME','Is_Retrieved__c','../../../constants','_snapshotId','_veevaService','_metadataLogId','veevaComponentType','TypeAndNameVeevaComponentRetriever','log','16881174CzNclL','join','export','formAttachments','default','Attachment_ID__c','csv-parse/sync','formMetadataItemDtoList','apiName','_logger','SalesforceDmlError','errors','../enums/status.enums','from','path','logError','saveAttachments','Snapshot','./veeva.service','SnapshotService','name','../classes/retrievers/veeva-components/type.veeva-component.retriever','Unpack\x20zip\x20and\x20create\x20metadata\x20items.','\x20Metadata\x20Items','label','Cannot\x20Save\x20Metadata\x20Items','PackageExportService','1992848jrqORM','posix','insertMultipleRecords','Job_Completed__c','DEPENDENCY_EXTENSION','retrieveVeevaComponents','constructor','successfully','file','Succeed__c','isRetrieved','Saving\x20','_whereClause','Veeva_Component_Type__c','../constants/flosum.constants','__esModule','stringify','csv-stringify/sync','Snapshot\x20completed\x20','sep','Snapshot__c/','apply','ATTACHMENT','body','_connectionSalesforce','set','ENDPOINT_UPSERT_RECORD','createMetadataItemListWithBody','execute','parse','../dtos/metadata-item.dto','45QNboQf','\x20from\x20outbound\x20package','1407959oQAIXH','finishSnapshot'];a363_0x2cfd=function(){return _0x4cae7f;};return a363_0x2cfd();}(function(_0x5bac76,_0x1470fe){const _0x521b39=a363_0x2949,_0x49d516=_0x5bac76();while(!![]){try{const _0x13b570=-parseInt(_0x521b39(0x173))/0x1+-parseInt(_0x521b39(0x197))/0x2*(parseInt(_0x521b39(0x186))/0x3)+parseInt(_0x521b39(0x1e8))/0x4*(-parseInt(_0x521b39(0x1e1))/0x5)+parseInt(_0x521b39(0x195))/0x6+-parseInt(_0x521b39(0x1e3))/0x7+-parseInt(_0x521b39(0x1c2))/0x8+parseInt(_0x521b39(0x1a7))/0x9;if(_0x13b570===_0x1470fe)break;else _0x49d516['push'](_0x49d516['shift']());}catch(_0x232ea0){_0x49d516['push'](_0x49d516['shift']());}}}(a363_0x2cfd,0xd5771));const a363_0x52d3d3=(function(){let _0x557406=!![];return function(_0x12b4db,_0x32d5fb){const _0x75f662=_0x557406?function(){const _0x1fc97d=a363_0x2949;if(_0x32d5fb){const _0x24af29=_0x32d5fb[_0x1fc97d(0x1d7)](_0x12b4db,arguments);return _0x32d5fb=null,_0x24af29;}}:function(){};return _0x557406=![],_0x75f662;};}()),a363_0x5cd554=a363_0x52d3d3(this,function(){const _0x1c95e5=a363_0x2949;return a363_0x5cd554[_0x1c95e5(0x1e5)]()[_0x1c95e5(0x198)](_0x1c95e5(0x17d))['toString']()[_0x1c95e5(0x1c8)](a363_0x5cd554)[_0x1c95e5(0x198)](_0x1c95e5(0x17d));});a363_0x5cd554();function a363_0x2949(_0x36774f,_0x5e9008){const _0x30779c=a363_0x2cfd();return a363_0x2949=function(_0x5cd554,_0x52d3d3){_0x5cd554=_0x5cd554-0x173;let _0x2cfdac=_0x30779c[_0x5cd554];return _0x2cfdac;},a363_0x2949(_0x36774f,_0x5e9008);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x298111){return _0x298111&&_0x298111['__esModule']?_0x298111:{'default':_0x298111};};Object[a363_0x1fbf68(0x182)](exports,a363_0x1fbf68(0x1d1),{'value':!![]}),exports['SnapshotService']=void 0x0;const jszip_1=__importDefault(require('jszip')),flosum_constants_1=require(a363_0x1fbf68(0x1d0)),veeva_service_1=require(a363_0x1fbf68(0x1b9)),metadata_item_dto_1=require(a363_0x1fbf68(0x1e0)),constants_1=require(a363_0x1fbf68(0x1a0)),salesforce_service_1=require(a363_0x1fbf68(0x1e6)),status_enums_1=require(a363_0x1fbf68(0x1b3)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),package_export_service_1=require('./package-export.service'),type_and_name_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever'),type_veeva_component_retriever_1=require(a363_0x1fbf68(0x1bc)),sync_1=require(a363_0x1fbf68(0x1ad)),sync_2=require(a363_0x1fbf68(0x1d3)),veeva_constants_1=require(a363_0x1fbf68(0x178)),path_1=__importDefault(require(a363_0x1fbf68(0x1b5)));class SnapshotService{constructor({snapshotId:_0x2eb07e,metadataLogId:_0x2b66c6,selectedMetaTypes:_0x15b4c1,selectedComponentMap:_0x4586f0,whereClause:_0x37d7c9},_0x51368b,_0x270036,_0x4cf248){const _0x2066f0=a363_0x1fbf68;this[_0x2066f0(0x1da)]=_0x51368b,this['_connectionVeeva']=_0x270036,this[_0x2066f0(0x1b0)]=_0x4cf248,this[_0x2066f0(0x1a1)]=_0x2eb07e,this[_0x2066f0(0x1a3)]=_0x2b66c6,this['_selectedMetaTypes']=_0x15b4c1,this['_selectedComponentMap']=_0x4586f0,this[_0x2066f0(0x1ce)]=_0x37d7c9,this[_0x2066f0(0x1a2)]=new veeva_service_1[(_0x2066f0(0x18d))]({'connection':this[_0x2066f0(0x185)],'logger':this[_0x2066f0(0x1b0)]}),this[_0x2066f0(0x19b)]=new salesforce_service_1[(_0x2066f0(0x177))]({'connection':this['_connectionSalesforce']}),this[_0x2066f0(0x19d)]=new package_export_service_1[(_0x2066f0(0x1c1))]({'veevaService':this[_0x2066f0(0x1a2)],'connection':this['_connectionVeeva'],'logger':this[_0x2066f0(0x1b0)]});}async[a363_0x1fbf68(0x1de)](){const _0x531f18=a363_0x1fbf68;try{this[_0x531f18(0x1b0)][_0x531f18(0x1a6)]('Snapshot\x20started.');const _0x2d9468=await this[_0x531f18(0x1c7)]();await this[_0x531f18(0x1b0)][_0x531f18(0x188)]();const _0x3d98f2=await this[_0x531f18(0x19d)][_0x531f18(0x1a9)](_0x2d9468,SnapshotService['OUTBOUND_PACKAGE_NAME']);await this[_0x531f18(0x1b0)]['updateLog']();const _0x1dccb6=await this['createMetadataItemListWithBody'](_0x2d9468,_0x3d98f2);await this[_0x531f18(0x17e)](_0x1dccb6),await this[_0x531f18(0x1b0)][_0x531f18(0x188)](),await this[_0x531f18(0x1e4)](!![]);}catch(_0x43c5a2){this[_0x531f18(0x1b0)][_0x531f18(0x1b6)](_0x43c5a2),await this[_0x531f18(0x1e4)](![])[_0x531f18(0x18c)](_0x3b732e=>this['_systemLogger']['error'](_0x3b732e));}}async[a363_0x1fbf68(0x1c7)](){const _0x2317ce=a363_0x1fbf68,_0x348567={'veevaService':this[_0x2317ce(0x1a2)],'logger':this[_0x2317ce(0x1b0)]},_0x1a76cb=Array[_0x2317ce(0x1b4)](Object[_0x2317ce(0x17c)](this[_0x2317ce(0x190)]))[_0x2317ce(0x199)]?new type_and_name_veeva_component_retriever_1[(_0x2317ce(0x1a5))]({'value':this[_0x2317ce(0x190)],..._0x348567}):new type_veeva_component_retriever_1[(_0x2317ce(0x19c))]({'value':this['_selectedMetaTypes'],'whereClause':this[_0x2317ce(0x1ce)],..._0x348567});return _0x1a76cb['retrieve']();}async[a363_0x1fbf68(0x1dd)](_0x525de2,_0x148448){const _0x471037=a363_0x1fbf68;var _0x536673,_0x19c6f9;this[_0x471037(0x1b0)][_0x471037(0x1a6)](_0x471037(0x1bd));const _0x198fae=this[_0x471037(0x1ae)](_0x525de2),_0x3786ec=_0x198fae['reduce']((_0x34fc42,_0x55a52a)=>_0x34fc42[_0x471037(0x1db)](_0x55a52a[_0x471037(0x1bf)],_0x55a52a),new Map());for(const _0x3e95d9 of _0x148448){for(const _0x213c4f in _0x3e95d9[_0x471037(0x184)]){const {base:_0x1922f9,name:_0x2d5079,dir:_0x3497a4}=path_1[_0x471037(0x1ab)][_0x471037(0x1df)](_0x213c4f),_0x1999e4=_0x2d5079+veeva_constants_1['VeevaConstants'][_0x471037(0x1c6)];if(_0x3786ec['has'](_0x1922f9)){const _0x445160=await((_0x536673=_0x3e95d9[_0x471037(0x1ca)]([_0x3497a4,_0x1922f9][_0x471037(0x1a8)](path_1[_0x471037(0x1ab)][_0x471037(0x1c3)][_0x471037(0x1d5)])))===null||_0x536673===void 0x0?void 0x0:_0x536673[_0x471037(0x187)](_0x471037(0x1e9))),_0x15b1c0=await((_0x19c6f9=_0x3e95d9[_0x471037(0x1ca)]([_0x3497a4,_0x1999e4][_0x471037(0x1a8)](path_1[_0x471037(0x1ab)]['posix'][_0x471037(0x1d5)])))===null||_0x19c6f9===void 0x0?void 0x0:_0x19c6f9[_0x471037(0x187)](_0x471037(0x1e9)));if(_0x445160){const _0x56dda5=new jszip_1[(_0x471037(0x1ab))]();_0x56dda5[_0x471037(0x1ca)](_0x1922f9,_0x445160),_0x15b1c0&&_0x56dda5[_0x471037(0x1ca)](_0x1999e4,this[_0x471037(0x17a)](_0x15b1c0)),_0x3786ec['get'](_0x1922f9)['body']=await _0x56dda5[_0x471037(0x19a)]({'type':_0x471037(0x174)});}}}}return _0x198fae['filter'](_0x480233=>!_0x480233[_0x471037(0x1d9)])[_0x471037(0x17b)](_0x2ab0d0=>{const _0x3d8b8b=_0x471037;this['_logger']['log'](_0x3d8b8b(0x17f)+_0x2ab0d0['veevaComponentType']+'.'+_0x2ab0d0[_0x3d8b8b(0x1bb)]+_0x3d8b8b(0x1e2));}),_0x198fae[_0x471037(0x18b)](_0x5117f5=>_0x5117f5[_0x471037(0x1d9)]);}[a363_0x1fbf68(0x17a)](_0x3ccac6){const _0x2369d7=a363_0x1fbf68,_0x5506a6=(0x0,sync_1['parse'])(_0x3ccac6,{'columns':!![],'skip_empty_lines':!![]}),_0x5efcb1=_0x5506a6[_0x2369d7(0x194)](({'In\x20Package':_0x26c7b0,..._0x3e8908})=>_0x3e8908);return(0x0,sync_2[_0x2369d7(0x1d2)])(_0x5efcb1,{'header':!![]});}['formMetadataItemDtoList'](_0x107d12){return _0x107d12['map'](_0x2a9987=>{const _0x34d3a9=a363_0x2949,_0x2b924d=new metadata_item_dto_1['MetadataItemDto']();return _0x2b924d[_0x34d3a9(0x1bb)]=_0x2a9987[_0x34d3a9(0x1bb)],_0x2b924d['apiName']=_0x2a9987[_0x34d3a9(0x1bb)],_0x2b924d[_0x34d3a9(0x183)]=this['_snapshotId'],_0x2b924d[_0x34d3a9(0x1bf)]=_0x2a9987[_0x34d3a9(0x196)]+'.'+_0x2a9987[_0x34d3a9(0x1bb)]+veeva_constants_1['VeevaConstants']['MDL_EXTENSION'],_0x2b924d[_0x34d3a9(0x1a4)]=_0x2a9987[_0x34d3a9(0x196)],_0x2b924d[_0x34d3a9(0x192)]=_0x2a9987[_0x34d3a9(0x192)],_0x2b924d['isRetrieved']=![],_0x2b924d;});}async[a363_0x1fbf68(0x17e)](_0x24b3cf){const _0x2653b5=a363_0x1fbf68;this[_0x2653b5(0x1b0)][_0x2653b5(0x1a6)](_0x2653b5(0x181)),await this['saveAttachments'](_0x24b3cf),this[_0x2653b5(0x1b0)][_0x2653b5(0x1a6)](_0x2653b5(0x1cd)+_0x24b3cf['length']+_0x2653b5(0x1be));const _0x1619f1=_0x24b3cf[_0x2653b5(0x194)](_0x4f20bf=>{const _0x3a00d0=_0x2653b5;return{[constants_1[_0x3a00d0(0x18a)]+'Name__c']:_0x4f20bf[_0x3a00d0(0x1bb)],[constants_1['FLOSUM_NAMESPACE']+'API_Name__c']:_0x4f20bf[_0x3a00d0(0x1af)],[constants_1[_0x3a00d0(0x18a)]+'Snapshot__c']:_0x4f20bf[_0x3a00d0(0x183)],[constants_1[_0x3a00d0(0x18a)]+_0x3a00d0(0x189)]:_0x4f20bf[_0x3a00d0(0x1bf)],[constants_1[_0x3a00d0(0x18a)]+_0x3a00d0(0x19f)]:_0x4f20bf[_0x3a00d0(0x1cc)],[constants_1[_0x3a00d0(0x18a)]+_0x3a00d0(0x1cf)]:_0x4f20bf[_0x3a00d0(0x1a4)],[constants_1[_0x3a00d0(0x18a)]+_0x3a00d0(0x1ac)]:_0x4f20bf['attachmentId'],[constants_1[_0x3a00d0(0x18a)]+'Last_Modified_Date__c']:_0x4f20bf[_0x3a00d0(0x192)]};}),_0x28b95c=await this[_0x2653b5(0x19b)][_0x2653b5(0x1c4)](constants_1['FLOSUM_NAMESPACE']+_0x2653b5(0x175),_0x1619f1);let _0x28a0f9=!![];_0x28b95c[_0x2653b5(0x17b)]((_0x1a62d3,_0x365e49)=>{const _0x51a655=_0x2653b5;this[_0x51a655(0x1b0)][_0x51a655(0x1a6)]('Saving\x20'+_0x24b3cf[_0x365e49][_0x51a655(0x1a4)]+'.'+_0x24b3cf[_0x365e49][_0x51a655(0x1bb)]);if(!_0x1a62d3[_0x51a655(0x176)]){_0x28a0f9=![];const _0x969ca8=new salesforce_dml_error_1[(_0x51a655(0x1b1))](_0x1a62d3[_0x51a655(0x1b2)]);this['_logger'][_0x51a655(0x1b6)](_0x969ca8);}});if(!_0x28a0f9)throw new Error(_0x2653b5(0x1c0));}async[a363_0x1fbf68(0x1b7)](_0x3b836d){const _0x1d5f94=a363_0x1fbf68,_0x5288fc=this['formAttachments'](_0x3b836d),_0x4a5a4c=await this[_0x1d5f94(0x19b)][_0x1d5f94(0x1c4)](SnapshotService[_0x1d5f94(0x1d8)],_0x5288fc),_0x3385b6=[];_0x4a5a4c['forEach']((_0x93e08e,_0x1b73f3)=>{const _0x34047f=_0x1d5f94;_0x93e08e['success']?(_0x3b836d[_0x1b73f3]['attachmentId']=_0x93e08e['id'],_0x3b836d[_0x1b73f3][_0x34047f(0x1cc)]=!![]):_0x3385b6['push'](..._0x93e08e['errors']);});if(_0x3385b6[_0x1d5f94(0x199)])throw new salesforce_dml_error_1[(_0x1d5f94(0x1b1))](_0x3385b6);}[a363_0x1fbf68(0x1aa)](_0x402643){const _0xfcc497=a363_0x1fbf68;return _0x402643[_0xfcc497(0x194)](_0x46cfe3=>({'ParentId':this[_0xfcc497(0x1a1)],'Name':_0x46cfe3[_0xfcc497(0x1a4)],'ContentType':'application/zip','Body':_0x46cfe3[_0xfcc497(0x1d9)],'Description':_0x46cfe3['veevaComponentType']}));}async[a363_0x1fbf68(0x1e4)](_0x4ee75c){const _0x535eda=a363_0x1fbf68,_0x29f936={[constants_1[_0x535eda(0x18a)]+'Is_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x535eda(0x193)]:!_0x4ee75c},_0x53e3fa={[constants_1[_0x535eda(0x18a)]+'Is_Error__c']:!_0x4ee75c,[constants_1[_0x535eda(0x18a)]+_0x535eda(0x1cb)]:_0x4ee75c,[constants_1['FLOSUM_NAMESPACE']+_0x535eda(0x1e7)]:_0x4ee75c?status_enums_1['MetadataLogStatus']['COMPLETED']:status_enums_1[_0x535eda(0x18f)][_0x535eda(0x18e)],[constants_1[_0x535eda(0x18a)]+_0x535eda(0x1c5)]:!![]};await this[_0x535eda(0x1da)][_0x535eda(0x180)](flosum_constants_1[_0x535eda(0x191)][_0x535eda(0x1dc)]+'/'+constants_1[_0x535eda(0x18a)]+_0x535eda(0x1d6)+this[_0x535eda(0x1a1)],_0x29f936),await this[_0x535eda(0x1da)][_0x535eda(0x180)](flosum_constants_1[_0x535eda(0x191)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x535eda(0x18a)]+'Metadata_Log__c/'+this['_metadataLogId'],_0x53e3fa),this[_0x535eda(0x1b0)][_0x535eda(0x1a6)](_0x535eda(0x1d4)+(_0x4ee75c?_0x535eda(0x1c9):_0x535eda(0x179))+'.'),await this[_0x535eda(0x1b0)][_0x535eda(0x188)]();}}exports[a363_0x1fbf68(0x1ba)]=SnapshotService,SnapshotService[a363_0x1fbf68(0x19e)]=a363_0x1fbf68(0x1b8),SnapshotService['ATTACHMENT']='Attachment';