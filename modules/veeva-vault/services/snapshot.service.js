const a407_0x10b6bc=a407_0x1a2b;(function(_0x3184ea,_0xe862ee){const _0x3fa0c2=a407_0x1a2b,_0x555446=_0x3184ea();while(!![]){try{const _0x41ab7f=-parseInt(_0x3fa0c2(0x10d))/0x1*(parseInt(_0x3fa0c2(0xde))/0x2)+parseInt(_0x3fa0c2(0x103))/0x3+-parseInt(_0x3fa0c2(0xcd))/0x4+-parseInt(_0x3fa0c2(0x12a))/0x5*(parseInt(_0x3fa0c2(0xe6))/0x6)+parseInt(_0x3fa0c2(0xf7))/0x7+-parseInt(_0x3fa0c2(0x11b))/0x8+-parseInt(_0x3fa0c2(0xf4))/0x9*(-parseInt(_0x3fa0c2(0x107))/0xa);if(_0x41ab7f===_0xe862ee)break;else _0x555446['push'](_0x555446['shift']());}catch(_0x5d6744){_0x555446['push'](_0x555446['shift']());}}}(a407_0x5359,0x84bad));const a407_0x5936f6=(function(){let _0x3c018e=!![];return function(_0x3f3e38,_0x204088){const _0x1e2c61=_0x3c018e?function(){if(_0x204088){const _0x58db57=_0x204088['apply'](_0x3f3e38,arguments);return _0x204088=null,_0x58db57;}}:function(){};return _0x3c018e=![],_0x1e2c61;};}()),a407_0xbfa1b0=a407_0x5936f6(this,function(){const _0x38da3d=a407_0x1a2b;return a407_0xbfa1b0['toString']()['search'](_0x38da3d(0x129))[_0x38da3d(0x105)]()[_0x38da3d(0xce)](a407_0xbfa1b0)[_0x38da3d(0xea)](_0x38da3d(0x129));});a407_0xbfa1b0();'use strict';var __importDefault=this&&this[a407_0x10b6bc(0x138)]||function(_0x3ed2b7){const _0x52f72d=a407_0x10b6bc;return _0x3ed2b7&&_0x3ed2b7[_0x52f72d(0xf2)]?_0x3ed2b7:{'default':_0x3ed2b7};};function a407_0x5359(){const _0x51f8af=['lastModifiedDate','success','logError','ATTACHMENT','(((.+)+)+)+$','22495bepMyn','retrieve','_salesforceService','../../../constants','join','generateAsync','Saving\x20','saveComponentsInSalesforce','API_Name__c','_selectedComponentMap','Attachment','FLOSUM_NAMESPACE','_connectionSalesforce','body','__importDefault','filter','Attachment_ID__c','ENDPOINT_UPSERT_RECORD','\x20from\x20outbound\x20package','updateLog','Snapshot','sep','log','SnapshotService','VeevaService','VeevaConstants','../dtos/metadata-item.dto','has','from','Status__c','FlosumConstants','./veeva.service','COMPLETED','Name__c','TypeAndNameVeevaComponentRetriever','1026632EQoxVK','constructor','DEPENDENCY_EXTENSION','SalesforceService','veevaComponentType','csv-parse/sync','stringify','_snapshotId','name','Metadata_Log__c/','base64','async','type','default','errors','defineProperty','successfully','15794LbzUiC','error','Succeed__c','isRetrieved','map','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','with\x20error','Label__c','42gWeUBR','apiName','SalesforceDmlError','catch','search','push','../classes/retrievers/veeva-components/type.veeva-component.retriever','posix','../constants/flosum.constants','Is_Completed__c','_selectedMetaTypes','_systemLogger','__esModule','_logger','5375736sUNRaM','_metadataLogId','application/zip','2987901kCQJMI','formAttachments','MDL_EXTENSION','_packageExportService','attachmentId','formMetadataItemDtoList','set','Is_Error__c','finishSnapshot','Snapshot__c/','reduce','MetadataLogStatus','1186041wsCyZF','retrieveVeevaComponents','toString','_whereClause','20iBiRxO','Cannot\x20retrieve\x20','label','TypeVeevaComponentRetriever','jszip','../constants/veeva.constants','137nkIOpc','\x20Metadata\x20Items','OUTBOUND_PACKAGE_NAME','Is_Retrieved__c','_connectionVeeva','path','PackageExportService','EXCEPTION','parse','insertMultipleRecords','saveAttachments','_veevaService','transformDependencyFile','string','824776DKQHLw','../enums/status.enums','Job_Completed__c','Cannot\x20Save\x20Metadata\x20Items','patch','Metadata_Item__c','length','createMetadataItemListWithBody','forEach','file'];a407_0x5359=function(){return _0x51f8af;};return a407_0x5359();}Object[a407_0x10b6bc(0xdc)](exports,a407_0x10b6bc(0xf2),{'value':!![]}),exports[a407_0x10b6bc(0x141)]=void 0x0;function a407_0x1a2b(_0x2f7070,_0x468940){const _0x50851a=a407_0x5359();return a407_0x1a2b=function(_0xbfa1b0,_0x5936f6){_0xbfa1b0=_0xbfa1b0-0xcc;let _0x535991=_0x50851a[_0xbfa1b0];return _0x535991;},a407_0x1a2b(_0x2f7070,_0x468940);}const jszip_1=__importDefault(require(a407_0x10b6bc(0x10b))),flosum_constants_1=require(a407_0x10b6bc(0xee)),veeva_service_1=require(a407_0x10b6bc(0x149)),metadata_item_dto_1=require(a407_0x10b6bc(0x144)),constants_1=require(a407_0x10b6bc(0x12d)),salesforce_service_1=require('./salesforce.service'),status_enums_1=require(a407_0x10b6bc(0x11c)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),package_export_service_1=require('./package-export.service'),type_and_name_veeva_component_retriever_1=require(a407_0x10b6bc(0xe3)),type_veeva_component_retriever_1=require(a407_0x10b6bc(0xec)),sync_1=require(a407_0x10b6bc(0xd2)),sync_2=require('csv-stringify/sync'),veeva_constants_1=require(a407_0x10b6bc(0x10c)),path_1=__importDefault(require(a407_0x10b6bc(0x112)));class SnapshotService{constructor({snapshotId:_0x1aa569,metadataLogId:_0x148b70,selectedMetaTypes:_0x31cbfa,selectedComponentMap:_0x1e9646,whereClause:_0x2b7450},_0x524244,_0x2feb2a,_0x5b68e8){const _0x6cbf7a=a407_0x10b6bc;this['_connectionSalesforce']=_0x524244,this[_0x6cbf7a(0x111)]=_0x2feb2a,this[_0x6cbf7a(0xf3)]=_0x5b68e8,this[_0x6cbf7a(0xd4)]=_0x1aa569,this[_0x6cbf7a(0xf5)]=_0x148b70,this[_0x6cbf7a(0xf0)]=_0x31cbfa,this[_0x6cbf7a(0x133)]=_0x1e9646,this[_0x6cbf7a(0x106)]=_0x2b7450,this[_0x6cbf7a(0x118)]=new veeva_service_1[(_0x6cbf7a(0x142))]({'connection':this[_0x6cbf7a(0x111)],'logger':this[_0x6cbf7a(0xf3)]}),this[_0x6cbf7a(0x12c)]=new salesforce_service_1[(_0x6cbf7a(0xd0))]({'connection':this[_0x6cbf7a(0x136)]}),this[_0x6cbf7a(0xfa)]=new package_export_service_1[(_0x6cbf7a(0x113))]({'veevaService':this['_veevaService'],'connection':this[_0x6cbf7a(0x111)],'logger':this[_0x6cbf7a(0xf3)]});}async['execute'](){const _0x25f82f=a407_0x10b6bc;try{this[_0x25f82f(0xf3)][_0x25f82f(0x140)]('Snapshot\x20started.');const _0x1a2963=await this[_0x25f82f(0x104)]();await this[_0x25f82f(0xf3)][_0x25f82f(0x13d)]();const _0x88f237=await this[_0x25f82f(0xfa)]['export'](_0x1a2963,SnapshotService[_0x25f82f(0x10f)]);await this[_0x25f82f(0xf3)][_0x25f82f(0x13d)]();const _0x5e5b90=await this[_0x25f82f(0x122)](_0x1a2963,_0x88f237);await this[_0x25f82f(0x131)](_0x5e5b90),await this['_logger'][_0x25f82f(0x13d)](),await this[_0x25f82f(0xff)](!![]);}catch(_0x37702b){this[_0x25f82f(0xf3)][_0x25f82f(0x127)](_0x37702b),await this[_0x25f82f(0xff)](![])[_0x25f82f(0xe9)](_0x17576e=>this[_0x25f82f(0xf1)][_0x25f82f(0xdf)](_0x17576e));}}async['retrieveVeevaComponents'](){const _0xdf4a8d=a407_0x10b6bc,_0x3e7ecb={'veevaService':this[_0xdf4a8d(0x118)],'logger':this[_0xdf4a8d(0xf3)]},_0x49eeeb=Array[_0xdf4a8d(0x146)](Object['values'](this[_0xdf4a8d(0x133)]))[_0xdf4a8d(0x121)]?new type_and_name_veeva_component_retriever_1[(_0xdf4a8d(0xcc))]({'value':this[_0xdf4a8d(0x133)],..._0x3e7ecb}):new type_veeva_component_retriever_1[(_0xdf4a8d(0x10a))]({'value':this[_0xdf4a8d(0xf0)],'whereClause':this[_0xdf4a8d(0x106)],..._0x3e7ecb});return _0x49eeeb[_0xdf4a8d(0x12b)]();}async[a407_0x10b6bc(0x122)](_0x5f3b6a,_0x20cd73){const _0x807fa1=a407_0x10b6bc;var _0x41f56f,_0x5218d8;this[_0x807fa1(0xf3)][_0x807fa1(0x140)]('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x2227b2=this[_0x807fa1(0xfc)](_0x5f3b6a),_0x18a4e2=_0x2227b2[_0x807fa1(0x101)]((_0x19edaa,_0x1fdda0)=>_0x19edaa[_0x807fa1(0xfd)](_0x1fdda0[_0x807fa1(0x109)],_0x1fdda0),new Map());for(const _0x47a830 of _0x20cd73){for(const _0x126039 in _0x47a830['files']){const {base:_0x2ac8ac,name:_0x56588c,dir:_0x191380}=path_1[_0x807fa1(0xda)][_0x807fa1(0x115)](_0x126039),_0x8e5b6c=_0x56588c+veeva_constants_1[_0x807fa1(0x143)][_0x807fa1(0xcf)];if(_0x18a4e2[_0x807fa1(0x145)](_0x2ac8ac)){const _0x198cef=await((_0x41f56f=_0x47a830[_0x807fa1(0x124)]([_0x191380,_0x2ac8ac][_0x807fa1(0x12e)](path_1[_0x807fa1(0xda)][_0x807fa1(0xed)]['sep'])))===null||_0x41f56f===void 0x0?void 0x0:_0x41f56f[_0x807fa1(0xd8)]('string')),_0xa8058e=await((_0x5218d8=_0x47a830['file']([_0x191380,_0x8e5b6c][_0x807fa1(0x12e)](path_1['default'][_0x807fa1(0xed)][_0x807fa1(0x13f)])))===null||_0x5218d8===void 0x0?void 0x0:_0x5218d8[_0x807fa1(0xd8)](_0x807fa1(0x11a)));if(_0x198cef){const _0xfca63e=new jszip_1[(_0x807fa1(0xda))]();_0xfca63e[_0x807fa1(0x124)](_0x2ac8ac,_0x198cef),_0xa8058e&&_0xfca63e[_0x807fa1(0x124)](_0x8e5b6c,this[_0x807fa1(0x119)](_0xa8058e)),_0x18a4e2['get'](_0x2ac8ac)[_0x807fa1(0x137)]=await _0xfca63e[_0x807fa1(0x12f)]({'type':_0x807fa1(0xd7)});}}}}return _0x2227b2[_0x807fa1(0x139)](_0x283c4c=>!_0x283c4c[_0x807fa1(0x137)])[_0x807fa1(0x123)](_0x252c06=>{const _0x3f3a42=_0x807fa1;this['_logger'][_0x3f3a42(0x140)](_0x3f3a42(0x108)+_0x252c06[_0x3f3a42(0xd1)]+'.'+_0x252c06[_0x3f3a42(0xd5)]+_0x3f3a42(0x13c));}),_0x2227b2[_0x807fa1(0x139)](_0x2bd952=>_0x2bd952['body']);}['transformDependencyFile'](_0x1495d7){const _0x183042=a407_0x10b6bc,_0x48981b=(0x0,sync_1[_0x183042(0x115)])(_0x1495d7,{'columns':!![],'skip_empty_lines':!![]}),_0x2e6d2e=_0x48981b['map'](({'In\x20Package':_0x2e388c,..._0x456c3a})=>_0x456c3a);return(0x0,sync_2[_0x183042(0xd3)])(_0x2e6d2e,{'header':!![]});}[a407_0x10b6bc(0xfc)](_0x466fcc){const _0x50549d=a407_0x10b6bc;return _0x466fcc[_0x50549d(0xe2)](_0x215a34=>{const _0x53b5c2=_0x50549d,_0x1e282c=new metadata_item_dto_1['MetadataItemDto']();return _0x1e282c[_0x53b5c2(0xd5)]=_0x215a34['name'],_0x1e282c[_0x53b5c2(0xe7)]=_0x215a34[_0x53b5c2(0xd5)],_0x1e282c['snapshotId']=this['_snapshotId'],_0x1e282c[_0x53b5c2(0x109)]=_0x215a34[_0x53b5c2(0xd9)]+'.'+_0x215a34[_0x53b5c2(0xd5)]+veeva_constants_1[_0x53b5c2(0x143)][_0x53b5c2(0xf9)],_0x1e282c[_0x53b5c2(0xd1)]=_0x215a34[_0x53b5c2(0xd9)],_0x1e282c['lastModifiedDate']=_0x215a34[_0x53b5c2(0x125)],_0x1e282c[_0x53b5c2(0xe1)]=![],_0x1e282c;});}async[a407_0x10b6bc(0x131)](_0x1c5360){const _0x191703=a407_0x10b6bc;this[_0x191703(0xf3)][_0x191703(0x140)]('Saving\x20Attachments.'),await this[_0x191703(0x117)](_0x1c5360),this[_0x191703(0xf3)][_0x191703(0x140)](_0x191703(0x130)+_0x1c5360[_0x191703(0x121)]+_0x191703(0x10e));const _0x3f0f2b=_0x1c5360[_0x191703(0xe2)](_0x2f8db5=>{const _0x5144e2=_0x191703;return{[constants_1[_0x5144e2(0x135)]+_0x5144e2(0x14b)]:_0x2f8db5['name'],[constants_1['FLOSUM_NAMESPACE']+_0x5144e2(0x132)]:_0x2f8db5[_0x5144e2(0xe7)],[constants_1[_0x5144e2(0x135)]+'Snapshot__c']:_0x2f8db5['snapshotId'],[constants_1[_0x5144e2(0x135)]+_0x5144e2(0xe5)]:_0x2f8db5[_0x5144e2(0x109)],[constants_1['FLOSUM_NAMESPACE']+_0x5144e2(0x110)]:_0x2f8db5[_0x5144e2(0xe1)],[constants_1[_0x5144e2(0x135)]+'Veeva_Component_Type__c']:_0x2f8db5[_0x5144e2(0xd1)],[constants_1[_0x5144e2(0x135)]+_0x5144e2(0x13a)]:_0x2f8db5[_0x5144e2(0xfb)],[constants_1[_0x5144e2(0x135)]+'Last_Modified_Date__c']:_0x2f8db5[_0x5144e2(0x125)]};}),_0x4a81ec=await this['_salesforceService'][_0x191703(0x116)](constants_1[_0x191703(0x135)]+_0x191703(0x120),_0x3f0f2b);let _0x5e1358=!![];_0x4a81ec[_0x191703(0x123)]((_0x468f82,_0x4e2869)=>{const _0x570600=_0x191703;this[_0x570600(0xf3)]['log'](_0x570600(0x130)+_0x1c5360[_0x4e2869][_0x570600(0xd1)]+'.'+_0x1c5360[_0x4e2869]['name']);if(!_0x468f82['success']){_0x5e1358=![];const _0x4e0bca=new salesforce_dml_error_1[(_0x570600(0xe8))](_0x468f82['errors']);this['_logger'][_0x570600(0x127)](_0x4e0bca);}});if(!_0x5e1358)throw new Error(_0x191703(0x11e));}async['saveAttachments'](_0x1aa022){const _0x33e525=a407_0x10b6bc,_0x5a0d59=this[_0x33e525(0xf8)](_0x1aa022),_0x1b7a85=await this[_0x33e525(0x12c)][_0x33e525(0x116)](SnapshotService[_0x33e525(0x128)],_0x5a0d59),_0x456601=[];_0x1b7a85[_0x33e525(0x123)]((_0x1c4918,_0x4c0b7a)=>{const _0x26d2ed=_0x33e525;_0x1c4918[_0x26d2ed(0x126)]?(_0x1aa022[_0x4c0b7a][_0x26d2ed(0xfb)]=_0x1c4918['id'],_0x1aa022[_0x4c0b7a][_0x26d2ed(0xe1)]=!![]):_0x456601[_0x26d2ed(0xeb)](..._0x1c4918[_0x26d2ed(0xdb)]);});if(_0x456601['length'])throw new salesforce_dml_error_1[(_0x33e525(0xe8))](_0x456601);}['formAttachments'](_0x23da41){const _0x29f886=a407_0x10b6bc;return _0x23da41[_0x29f886(0xe2)](_0x202a65=>({'ParentId':this[_0x29f886(0xd4)],'Name':_0x202a65[_0x29f886(0xd1)],'ContentType':_0x29f886(0xf6),'Body':_0x202a65['body'],'Description':_0x202a65['veevaComponentType']}));}async[a407_0x10b6bc(0xff)](_0xd44256){const _0x240b45=a407_0x10b6bc,_0x249e0d={[constants_1[_0x240b45(0x135)]+_0x240b45(0xef)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x240b45(0xfe)]:!_0xd44256},_0x44582b={[constants_1['FLOSUM_NAMESPACE']+_0x240b45(0xfe)]:!_0xd44256,[constants_1[_0x240b45(0x135)]+_0x240b45(0xe0)]:_0xd44256,[constants_1[_0x240b45(0x135)]+_0x240b45(0x147)]:_0xd44256?status_enums_1[_0x240b45(0x102)][_0x240b45(0x14a)]:status_enums_1['MetadataLogStatus'][_0x240b45(0x114)],[constants_1[_0x240b45(0x135)]+_0x240b45(0x11d)]:!![]};await this['_connectionSalesforce'][_0x240b45(0x11f)](flosum_constants_1[_0x240b45(0x148)][_0x240b45(0x13b)]+'/'+constants_1[_0x240b45(0x135)]+_0x240b45(0x100)+this['_snapshotId'],_0x249e0d),await this[_0x240b45(0x136)][_0x240b45(0x11f)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x240b45(0x135)]+_0x240b45(0xd6)+this[_0x240b45(0xf5)],_0x44582b),this[_0x240b45(0xf3)][_0x240b45(0x140)]('Snapshot\x20completed\x20'+(_0xd44256?_0x240b45(0xdd):_0x240b45(0xe4))+'.'),await this['_logger'][_0x240b45(0x13d)]();}}exports['SnapshotService']=SnapshotService,SnapshotService['OUTBOUND_PACKAGE_NAME']=a407_0x10b6bc(0x13e),SnapshotService['ATTACHMENT']=a407_0x10b6bc(0x134);