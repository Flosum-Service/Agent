const a407_0x3bc2db=a407_0x3419;function a407_0x3419(_0x9d0e30,_0x161dd9){const _0x1f5d1c=a407_0x2c7b();return a407_0x3419=function(_0x46816a,_0x221c33){_0x46816a=_0x46816a-0x14e;let _0x2c7b37=_0x1f5d1c[_0x46816a];return _0x2c7b37;},a407_0x3419(_0x9d0e30,_0x161dd9);}(function(_0x350727,_0x521901){const _0x28cb80=a407_0x3419,_0x54aa0e=_0x350727();while(!![]){try{const _0x17dbf2=-parseInt(_0x28cb80(0x169))/0x1+parseInt(_0x28cb80(0x156))/0x2*(parseInt(_0x28cb80(0x1a1))/0x3)+-parseInt(_0x28cb80(0x198))/0x4*(-parseInt(_0x28cb80(0x179))/0x5)+parseInt(_0x28cb80(0x1c3))/0x6+parseInt(_0x28cb80(0x1bc))/0x7*(-parseInt(_0x28cb80(0x15c))/0x8)+parseInt(_0x28cb80(0x170))/0x9+parseInt(_0x28cb80(0x1a9))/0xa;if(_0x17dbf2===_0x521901)break;else _0x54aa0e['push'](_0x54aa0e['shift']());}catch(_0x482e75){_0x54aa0e['push'](_0x54aa0e['shift']());}}}(a407_0x2c7b,0x60189));const a407_0x221c33=(function(){let _0x4692b9=!![];return function(_0x47be7f,_0x58bd42){const _0x2bd4d0=_0x4692b9?function(){const _0x274715=a407_0x3419;if(_0x58bd42){const _0x4153cc=_0x58bd42[_0x274715(0x1c4)](_0x47be7f,arguments);return _0x58bd42=null,_0x4153cc;}}:function(){};return _0x4692b9=![],_0x2bd4d0;};}()),a407_0x46816a=a407_0x221c33(this,function(){const _0x168458=a407_0x3419;return a407_0x46816a[_0x168458(0x1c6)]()[_0x168458(0x1b7)]('(((.+)+)+)+$')[_0x168458(0x1c6)]()['constructor'](a407_0x46816a)[_0x168458(0x1b7)](_0x168458(0x171));});a407_0x46816a();'use strict';var __importDefault=this&&this[a407_0x3bc2db(0x188)]||function(_0x385b5f){const _0x5f0873=a407_0x3bc2db;return _0x385b5f&&_0x385b5f[_0x5f0873(0x1b4)]?_0x385b5f:{'default':_0x385b5f};};Object[a407_0x3bc2db(0x17a)](exports,a407_0x3bc2db(0x1b4),{'value':!![]}),exports[a407_0x3bc2db(0x19f)]=void 0x0;function a407_0x2c7b(){const _0x3e180b=['apiName','../classes/retrievers/veeva-components/type.veeva-component.retriever','EXCEPTION','Cannot\x20retrieve\x20','join','8NYVdUr','values','get','Job_Completed__c','_connectionSalesforce','transformDependencyFile','finishSnapshot','_packageExportService','Snapshot__c','type','./package-export.service','_selectedMetaTypes','retrieveVeevaComponents','476654QepsyH','insertMultipleRecords','_connectionVeeva','_logger','FLOSUM_NAMESPACE','_veevaService','push','2269368dVYoqc','(((.+)+)+)+$','../../../constants','_snapshotId','saveAttachments','FlosumConstants','SalesforceDmlError','_metadataLogId','_selectedComponentMap','295zbrDwi','defineProperty','MetadataLogStatus','formAttachments','snapshotId','MDL_EXTENSION','Attachment','updateLog','successfully','Metadata_Item__c','with\x20error','OUTBOUND_PACKAGE_NAME','map','log','execute','__importDefault','formMetadataItemDtoList','Cannot\x20Save\x20Metadata\x20Items','_whereClause','lastModifiedDate','attachmentId','Saving\x20Attachments.','forEach','Veeva_Component_Type__c','./veeva.service','Is_Error__c','stringify','../constants/flosum.constants','success','./salesforce.service','patch','23596CvthMd','ENDPOINT_UPSERT_RECORD','DEPENDENCY_EXTENSION','VeevaConstants','default','length','string','SnapshotService','isRetrieved','3867owOmzU','saveComponentsInSalesforce','VeevaService','sep','veevaComponentType','catch','error','label','1598970UCXYcY','async','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','TypeVeevaComponentRetriever','generateAsync','_salesforceService','../constants/veeva.constants','has','Last_Modified_Date__c','filter','SalesforceService','__esModule','name','MetadataItemDto','search','Snapshot__c/','parse','logError','TypeAndNameVeevaComponentRetriever','3263197kViPpO','posix','from','Metadata_Log__c/','retrieve','createMetadataItemListWithBody','body','78306xzILtX','apply','ATTACHMENT','toString','Succeed__c','Snapshot','file','errors','Snapshot\x20completed\x20','Saving\x20','../dtos/metadata-item.dto','csv-parse/sync','Name__c','Label__c','874gkOVma'];a407_0x2c7b=function(){return _0x3e180b;};return a407_0x2c7b();}const jszip_1=__importDefault(require('jszip')),flosum_constants_1=require(a407_0x3bc2db(0x194)),veeva_service_1=require(a407_0x3bc2db(0x191)),metadata_item_dto_1=require(a407_0x3bc2db(0x152)),constants_1=require(a407_0x3bc2db(0x172)),salesforce_service_1=require(a407_0x3bc2db(0x196)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),package_export_service_1=require(a407_0x3bc2db(0x166)),type_and_name_veeva_component_retriever_1=require(a407_0x3bc2db(0x1ab)),type_veeva_component_retriever_1=require(a407_0x3bc2db(0x158)),sync_1=require(a407_0x3bc2db(0x153)),sync_2=require('csv-stringify/sync'),veeva_constants_1=require(a407_0x3bc2db(0x1af)),path_1=__importDefault(require('path'));class SnapshotService{constructor({snapshotId:_0x2e348c,metadataLogId:_0x3fff16,selectedMetaTypes:_0x15146e,selectedComponentMap:_0x4af88b,whereClause:_0x30c97c},_0x284f4f,_0x53239f,_0x47aef0){const _0x208e85=a407_0x3bc2db;this[_0x208e85(0x160)]=_0x284f4f,this[_0x208e85(0x16b)]=_0x53239f,this[_0x208e85(0x16c)]=_0x47aef0,this[_0x208e85(0x173)]=_0x2e348c,this['_metadataLogId']=_0x3fff16,this[_0x208e85(0x167)]=_0x15146e,this[_0x208e85(0x178)]=_0x4af88b,this[_0x208e85(0x18b)]=_0x30c97c,this[_0x208e85(0x16e)]=new veeva_service_1[(_0x208e85(0x1a3))]({'connection':this[_0x208e85(0x16b)],'logger':this[_0x208e85(0x16c)]}),this['_salesforceService']=new salesforce_service_1[(_0x208e85(0x1b3))]({'connection':this[_0x208e85(0x160)]}),this[_0x208e85(0x163)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x208e85(0x16e)],'connection':this[_0x208e85(0x16b)],'logger':this['_logger']});}async[a407_0x3bc2db(0x187)](){const _0x184cdd=a407_0x3bc2db;try{this[_0x184cdd(0x16c)][_0x184cdd(0x186)]('Snapshot\x20started.');const _0x258b49=await this['retrieveVeevaComponents']();await this[_0x184cdd(0x16c)][_0x184cdd(0x180)]();const _0x18b962=await this[_0x184cdd(0x163)]['export'](_0x258b49,SnapshotService[_0x184cdd(0x184)]);await this[_0x184cdd(0x16c)][_0x184cdd(0x180)]();const _0x227e0b=await this['createMetadataItemListWithBody'](_0x258b49,_0x18b962);await this[_0x184cdd(0x1a2)](_0x227e0b),await this[_0x184cdd(0x16c)][_0x184cdd(0x180)](),await this[_0x184cdd(0x162)](!![]);}catch(_0x517298){this['_logger'][_0x184cdd(0x1ba)](_0x517298),await this['finishSnapshot'](![])[_0x184cdd(0x1a6)](_0x505756=>this['_systemLogger'][_0x184cdd(0x1a7)](_0x505756));}}async[a407_0x3bc2db(0x168)](){const _0x170560=a407_0x3bc2db,_0x2b692e={'veevaService':this['_veevaService'],'logger':this[_0x170560(0x16c)]},_0x10b9a4=Array[_0x170560(0x1be)](Object[_0x170560(0x15d)](this['_selectedComponentMap']))[_0x170560(0x19d)]?new type_and_name_veeva_component_retriever_1[(_0x170560(0x1bb))]({'value':this[_0x170560(0x178)],..._0x2b692e}):new type_veeva_component_retriever_1[(_0x170560(0x1ac))]({'value':this[_0x170560(0x167)],'whereClause':this['_whereClause'],..._0x2b692e});return _0x10b9a4[_0x170560(0x1c0)]();}async[a407_0x3bc2db(0x1c1)](_0x10c112,_0x6a2439){const _0x2f28fd=a407_0x3bc2db;var _0x3fd99f,_0x5d485a;this['_logger'][_0x2f28fd(0x186)]('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x3128f5=this[_0x2f28fd(0x189)](_0x10c112),_0x5c5f37=_0x3128f5['reduce']((_0x438e3b,_0x11f9a4)=>_0x438e3b['set'](_0x11f9a4[_0x2f28fd(0x1a8)],_0x11f9a4),new Map());for(const _0x1c9a9a of _0x6a2439){for(const _0x4b4e62 in _0x1c9a9a['files']){const {base:_0x1ee9c8,name:_0x22ab4a,dir:_0x478331}=path_1[_0x2f28fd(0x19c)][_0x2f28fd(0x1b9)](_0x4b4e62),_0x2198d6=_0x22ab4a+veeva_constants_1[_0x2f28fd(0x19b)][_0x2f28fd(0x19a)];if(_0x5c5f37[_0x2f28fd(0x1b0)](_0x1ee9c8)){const _0x4f0d25=await((_0x3fd99f=_0x1c9a9a[_0x2f28fd(0x14e)]([_0x478331,_0x1ee9c8][_0x2f28fd(0x15b)](path_1[_0x2f28fd(0x19c)]['posix'][_0x2f28fd(0x1a4)])))===null||_0x3fd99f===void 0x0?void 0x0:_0x3fd99f[_0x2f28fd(0x1aa)](_0x2f28fd(0x19e))),_0x1ec75e=await((_0x5d485a=_0x1c9a9a[_0x2f28fd(0x14e)]([_0x478331,_0x2198d6][_0x2f28fd(0x15b)](path_1[_0x2f28fd(0x19c)][_0x2f28fd(0x1bd)][_0x2f28fd(0x1a4)])))===null||_0x5d485a===void 0x0?void 0x0:_0x5d485a[_0x2f28fd(0x1aa)](_0x2f28fd(0x19e)));if(_0x4f0d25){const _0x5494b8=new jszip_1['default']();_0x5494b8[_0x2f28fd(0x14e)](_0x1ee9c8,_0x4f0d25),_0x1ec75e&&_0x5494b8['file'](_0x2198d6,this[_0x2f28fd(0x161)](_0x1ec75e)),_0x5c5f37[_0x2f28fd(0x15e)](_0x1ee9c8)[_0x2f28fd(0x1c2)]=await _0x5494b8[_0x2f28fd(0x1ad)]({'type':'base64'});}}}}return _0x3128f5[_0x2f28fd(0x1b2)](_0x38a64d=>!_0x38a64d[_0x2f28fd(0x1c2)])[_0x2f28fd(0x18f)](_0x1ea639=>{const _0x412f4f=_0x2f28fd;this[_0x412f4f(0x16c)][_0x412f4f(0x186)](_0x412f4f(0x15a)+_0x1ea639[_0x412f4f(0x1a5)]+'.'+_0x1ea639[_0x412f4f(0x1b5)]+'\x20from\x20outbound\x20package');}),_0x3128f5[_0x2f28fd(0x1b2)](_0xf4081d=>_0xf4081d[_0x2f28fd(0x1c2)]);}[a407_0x3bc2db(0x161)](_0x5a5d25){const _0x3f8c72=a407_0x3bc2db,_0x5dc7fb=(0x0,sync_1[_0x3f8c72(0x1b9)])(_0x5a5d25,{'columns':!![],'skip_empty_lines':!![]}),_0x4e064c=_0x5dc7fb[_0x3f8c72(0x185)](({'In\x20Package':_0x4243a4,..._0x4be002})=>_0x4be002);return(0x0,sync_2[_0x3f8c72(0x193)])(_0x4e064c,{'header':!![]});}['formMetadataItemDtoList'](_0x59eb32){const _0x3b8b4b=a407_0x3bc2db;return _0x59eb32[_0x3b8b4b(0x185)](_0x327dbe=>{const _0x19a8f4=_0x3b8b4b,_0x5f52bd=new metadata_item_dto_1[(_0x19a8f4(0x1b6))]();return _0x5f52bd[_0x19a8f4(0x1b5)]=_0x327dbe['name'],_0x5f52bd[_0x19a8f4(0x157)]=_0x327dbe['name'],_0x5f52bd[_0x19a8f4(0x17d)]=this[_0x19a8f4(0x173)],_0x5f52bd[_0x19a8f4(0x1a8)]=_0x327dbe[_0x19a8f4(0x165)]+'.'+_0x327dbe[_0x19a8f4(0x1b5)]+veeva_constants_1[_0x19a8f4(0x19b)][_0x19a8f4(0x17e)],_0x5f52bd['veevaComponentType']=_0x327dbe['type'],_0x5f52bd[_0x19a8f4(0x18c)]=_0x327dbe[_0x19a8f4(0x18c)],_0x5f52bd[_0x19a8f4(0x1a0)]=![],_0x5f52bd;});}async[a407_0x3bc2db(0x1a2)](_0x4650fe){const _0x103988=a407_0x3bc2db;this[_0x103988(0x16c)][_0x103988(0x186)](_0x103988(0x18e)),await this['saveAttachments'](_0x4650fe),this['_logger'][_0x103988(0x186)](_0x103988(0x151)+_0x4650fe[_0x103988(0x19d)]+'\x20Metadata\x20Items');const _0x4c8a54=_0x4650fe[_0x103988(0x185)](_0x2c0a38=>{const _0x571406=_0x103988;return{[constants_1[_0x571406(0x16d)]+_0x571406(0x154)]:_0x2c0a38[_0x571406(0x1b5)],[constants_1[_0x571406(0x16d)]+'API_Name__c']:_0x2c0a38[_0x571406(0x157)],[constants_1[_0x571406(0x16d)]+_0x571406(0x164)]:_0x2c0a38['snapshotId'],[constants_1[_0x571406(0x16d)]+_0x571406(0x155)]:_0x2c0a38[_0x571406(0x1a8)],[constants_1[_0x571406(0x16d)]+'Is_Retrieved__c']:_0x2c0a38[_0x571406(0x1a0)],[constants_1['FLOSUM_NAMESPACE']+_0x571406(0x190)]:_0x2c0a38[_0x571406(0x1a5)],[constants_1[_0x571406(0x16d)]+'Attachment_ID__c']:_0x2c0a38['attachmentId'],[constants_1[_0x571406(0x16d)]+_0x571406(0x1b1)]:_0x2c0a38[_0x571406(0x18c)]};}),_0x1d000b=await this[_0x103988(0x1ae)][_0x103988(0x16a)](constants_1[_0x103988(0x16d)]+_0x103988(0x182),_0x4c8a54);let _0x318284=!![];_0x1d000b[_0x103988(0x18f)]((_0x5e1d8a,_0x1db18a)=>{const _0x5d22d4=_0x103988;this[_0x5d22d4(0x16c)][_0x5d22d4(0x186)](_0x5d22d4(0x151)+_0x4650fe[_0x1db18a]['veevaComponentType']+'.'+_0x4650fe[_0x1db18a]['name']);if(!_0x5e1d8a[_0x5d22d4(0x195)]){_0x318284=![];const _0x22033f=new salesforce_dml_error_1[(_0x5d22d4(0x176))](_0x5e1d8a[_0x5d22d4(0x14f)]);this['_logger'][_0x5d22d4(0x1ba)](_0x22033f);}});if(!_0x318284)throw new Error(_0x103988(0x18a));}async[a407_0x3bc2db(0x174)](_0x43caee){const _0x2575e1=a407_0x3bc2db,_0x125113=this['formAttachments'](_0x43caee),_0x468aca=await this[_0x2575e1(0x1ae)][_0x2575e1(0x16a)](SnapshotService[_0x2575e1(0x1c5)],_0x125113),_0x3943cd=[];_0x468aca['forEach']((_0x564886,_0x447ca3)=>{const _0x52a679=_0x2575e1;_0x564886[_0x52a679(0x195)]?(_0x43caee[_0x447ca3][_0x52a679(0x18d)]=_0x564886['id'],_0x43caee[_0x447ca3][_0x52a679(0x1a0)]=!![]):_0x3943cd[_0x52a679(0x16f)](..._0x564886[_0x52a679(0x14f)]);});if(_0x3943cd[_0x2575e1(0x19d)])throw new salesforce_dml_error_1[(_0x2575e1(0x176))](_0x3943cd);}[a407_0x3bc2db(0x17c)](_0x236e58){const _0x582ca=a407_0x3bc2db;return _0x236e58[_0x582ca(0x185)](_0x379e29=>({'ParentId':this['_snapshotId'],'Name':_0x379e29['veevaComponentType'],'ContentType':'application/zip','Body':_0x379e29[_0x582ca(0x1c2)],'Description':_0x379e29['veevaComponentType']}));}async['finishSnapshot'](_0xe9450d){const _0x4fb538=a407_0x3bc2db,_0xed5ff8={[constants_1['FLOSUM_NAMESPACE']+'Is_Completed__c']:!![],[constants_1[_0x4fb538(0x16d)]+_0x4fb538(0x192)]:!_0xe9450d},_0x42ff09={[constants_1[_0x4fb538(0x16d)]+_0x4fb538(0x192)]:!_0xe9450d,[constants_1[_0x4fb538(0x16d)]+_0x4fb538(0x1c7)]:_0xe9450d,[constants_1[_0x4fb538(0x16d)]+'Status__c']:_0xe9450d?status_enums_1[_0x4fb538(0x17b)]['COMPLETED']:status_enums_1[_0x4fb538(0x17b)][_0x4fb538(0x159)],[constants_1[_0x4fb538(0x16d)]+_0x4fb538(0x15f)]:!![]};await this[_0x4fb538(0x160)]['patch'](flosum_constants_1[_0x4fb538(0x175)][_0x4fb538(0x199)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x4fb538(0x1b8)+this[_0x4fb538(0x173)],_0xed5ff8),await this[_0x4fb538(0x160)][_0x4fb538(0x197)](flosum_constants_1[_0x4fb538(0x175)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x4fb538(0x1bf)+this[_0x4fb538(0x177)],_0x42ff09),this[_0x4fb538(0x16c)][_0x4fb538(0x186)](_0x4fb538(0x150)+(_0xe9450d?_0x4fb538(0x181):_0x4fb538(0x183))+'.'),await this['_logger'][_0x4fb538(0x180)]();}}exports[a407_0x3bc2db(0x19f)]=SnapshotService,SnapshotService['OUTBOUND_PACKAGE_NAME']=a407_0x3bc2db(0x1c8),SnapshotService['ATTACHMENT']=a407_0x3bc2db(0x17f);