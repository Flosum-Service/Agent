const a362_0x150bab=a362_0x5312;(function(_0x39ec23,_0x161f7b){const _0x5144ca=a362_0x5312,_0x555a5a=_0x39ec23();while(!![]){try{const _0xb710e1=-parseInt(_0x5144ca(0x14f))/0x1*(-parseInt(_0x5144ca(0x152))/0x2)+-parseInt(_0x5144ca(0x193))/0x3*(parseInt(_0x5144ca(0x18c))/0x4)+-parseInt(_0x5144ca(0x175))/0x5+-parseInt(_0x5144ca(0x16b))/0x6*(-parseInt(_0x5144ca(0x16f))/0x7)+parseInt(_0x5144ca(0x1b3))/0x8+parseInt(_0x5144ca(0x1be))/0x9+-parseInt(_0x5144ca(0x1bf))/0xa;if(_0xb710e1===_0x161f7b)break;else _0x555a5a['push'](_0x555a5a['shift']());}catch(_0x1ace09){_0x555a5a['push'](_0x555a5a['shift']());}}}(a362_0x57cb,0x1ca2f));function a362_0x5312(_0x47d3d2,_0x5f1315){const _0x49f870=a362_0x57cb();return a362_0x5312=function(_0x400af3,_0x3c436b){_0x400af3=_0x400af3-0x148;let _0x57cb67=_0x49f870[_0x400af3];return _0x57cb67;},a362_0x5312(_0x47d3d2,_0x5f1315);}const a362_0x3c436b=(function(){let _0x22ed83=!![];return function(_0x3c2b73,_0x3edb2a){const _0x40e4ec=_0x22ed83?function(){const _0x27ea13=a362_0x5312;if(_0x3edb2a){const _0xdb304b=_0x3edb2a[_0x27ea13(0x1ba)](_0x3c2b73,arguments);return _0x3edb2a=null,_0xdb304b;}}:function(){};return _0x22ed83=![],_0x40e4ec;};}()),a362_0x400af3=a362_0x3c436b(this,function(){const _0x354e3c=a362_0x5312;return a362_0x400af3[_0x354e3c(0x199)]()['search'](_0x354e3c(0x164))['toString']()[_0x354e3c(0x184)](a362_0x400af3)[_0x354e3c(0x160)]('(((.+)+)+)+$');});a362_0x400af3();'use strict';var __importDefault=this&&this[a362_0x150bab(0x16e)]||function(_0x467641){const _0x3f0d79=a362_0x150bab;return _0x467641&&_0x467641[_0x3f0d79(0x17b)]?_0x467641:{'default':_0x467641};};Object['defineProperty'](exports,a362_0x150bab(0x17b),{'value':!![]}),exports['SnapshotService']=void 0x0;const jszip_1=__importDefault(require(a362_0x150bab(0x149))),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a362_0x150bab(0x14e)),metadata_item_dto_1=require(a362_0x150bab(0x1c5)),constants_1=require(a362_0x150bab(0x14a)),salesforce_service_1=require('./salesforce.service'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),package_export_service_1=require('./package-export.service'),type_and_name_veeva_component_retriever_1=require(a362_0x150bab(0x1ca)),type_veeva_component_retriever_1=require(a362_0x150bab(0x189)),sync_1=require(a362_0x150bab(0x1c8)),sync_2=require(a362_0x150bab(0x163)),veeva_constants_1=require(a362_0x150bab(0x174)),path_1=__importDefault(require(a362_0x150bab(0x196)));function a362_0x57cb(){const _0x46f8b6=['generateAsync','FLOSUM_NAMESPACE','_connectionSalesforce','./veeva.service','1zSiMYi','set','MDL_EXTENSION','448982mplbyz','error','Saving\x20','Snapshot\x20started.','_logger','updateLog','ENDPOINT_UPSERT_RECORD','Snapshot__c','_connectionVeeva','\x20Metadata\x20Items','_veevaService','SnapshotService','push','finishSnapshot','search','Attachment_ID__c','Status__c','csv-stringify/sync','(((.+)+)+)+$','with\x20error','selectedComponentMap','Cannot\x20Save\x20Metadata\x20Items','Cannot\x20retrieve\x20','Job_Completed__c','veevaComponentType','314124ONcLer','Succeed__c','Is_Completed__c','__importDefault','21mKMlLz','errors','\x20from\x20outbound\x20package','snapshotId','lastModifiedDate','../constants/veeva.constants','759160IdtjzG','_salesforceService','retrieve','string','COMPLETED','length','__esModule','timeZone','VeevaConstants','successfully','reduce','_snapshotId','_systemLogger','saveComponentsInSalesforce','file','constructor','parse','Metadata_Item__c','default','saveAttachments','../classes/retrievers/veeva-components/type.veeva-component.retriever','map','ATTACHMENT','24308DwoXCw','name','formAttachments','_metadataLogId','attachmentLogId','insertMultipleRecords','_timeZone','63qkVIOi','logError','Last_Modified_Date__c','path','patch','Is_Error__c','toString','Snapshot__c/','SalesforceDmlError','Is_Retrieved__c','Label__c','Metadata_Log__c/','Name__c','transformDependencyFile','label','metadataLogId','createMetadataItemListWithBody','isRetrieved','SalesforceService','PackageExportService','_attachmentLogId','MetadataItemDto','Saving\x20Attachments.','values','execute','VeevaService','API_Name__c','body','files','forEach','OUTBOUND_PACKAGE_NAME','TypeVeevaComponentRetriever','84016xNaRAz','formMetadataItemDtoList','_selectedMetaTypes','attachmentId','_selectedComponentMap','log','stringify','apply','DEPENDENCY_EXTENSION','async','retrieveVeevaComponents','113076PAYLqf','78750OuISTa','selectedMetaTypes','join','from','success','_packageExportService','../dtos/metadata-item.dto','Snapshot\x20completed\x20','get','csv-parse/sync','catch','../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever','MetadataLogStatus','type','apiName','jszip','../../../constants'];a362_0x57cb=function(){return _0x46f8b6;};return a362_0x57cb();}class SnapshotService{constructor(_0x450239,_0x5ed90e,_0x20915b,_0x3d02ee){const _0x46df7f=a362_0x150bab;this[_0x46df7f(0x14d)]=_0x5ed90e,this[_0x46df7f(0x15a)]=_0x20915b,this['_logger']=_0x3d02ee,this[_0x46df7f(0x180)]=_0x450239[_0x46df7f(0x172)],this[_0x46df7f(0x18f)]=_0x450239[_0x46df7f(0x1a2)],this[_0x46df7f(0x1a7)]=_0x450239[_0x46df7f(0x190)],this[_0x46df7f(0x192)]=_0x450239[_0x46df7f(0x17c)],this[_0x46df7f(0x1b5)]=_0x450239[_0x46df7f(0x1c0)],this[_0x46df7f(0x1b7)]=_0x450239[_0x46df7f(0x166)],this['_veevaService']=new veeva_service_1[(_0x46df7f(0x1ac))]({'connection':this[_0x46df7f(0x15a)],'logger':this[_0x46df7f(0x156)]}),this[_0x46df7f(0x176)]=new salesforce_service_1[(_0x46df7f(0x1a5))]({'connection':this['_connectionSalesforce']}),this['_packageExportService']=new package_export_service_1[(_0x46df7f(0x1a6))]({'veevaService':this[_0x46df7f(0x15c)],'connection':this[_0x46df7f(0x15a)],'logger':this['_logger']});}async[a362_0x150bab(0x1ab)](){const _0x592a53=a362_0x150bab;try{this[_0x592a53(0x156)][_0x592a53(0x1b8)](_0x592a53(0x155));const _0x1e4375=await this[_0x592a53(0x1bd)]();await this['_logger'][_0x592a53(0x157)]();const _0x35ff6a=await this[_0x592a53(0x1c4)]['export'](_0x1e4375,SnapshotService['OUTBOUND_PACKAGE_NAME']);await this[_0x592a53(0x156)][_0x592a53(0x157)]();const _0x578de8=await this[_0x592a53(0x1a3)](_0x1e4375,_0x35ff6a);await this['saveComponentsInSalesforce'](_0x578de8),await this[_0x592a53(0x156)]['updateLog'](),await this[_0x592a53(0x15f)](!![]);}catch(_0xaa03e6){this[_0x592a53(0x156)][_0x592a53(0x194)](_0xaa03e6),await this[_0x592a53(0x15f)](![])[_0x592a53(0x1c9)](_0x5c3e14=>this[_0x592a53(0x181)][_0x592a53(0x153)](_0x5c3e14));}}async[a362_0x150bab(0x1bd)](){const _0x194c2d=a362_0x150bab,_0x195356={'veevaService':this[_0x194c2d(0x15c)],'logger':this['_logger']},_0x1c0df2=Array[_0x194c2d(0x1c2)](Object[_0x194c2d(0x1aa)](this[_0x194c2d(0x1b7)]))['length']?new type_and_name_veeva_component_retriever_1['TypeAndNameVeevaComponentRetriever']({'value':this[_0x194c2d(0x1b7)],..._0x195356}):new type_veeva_component_retriever_1[(_0x194c2d(0x1b2))]({'value':this[_0x194c2d(0x1b5)],..._0x195356});return _0x1c0df2[_0x194c2d(0x177)]();}async[a362_0x150bab(0x1a3)](_0x3ce1ac,_0x51eec5){const _0x5c0e22=a362_0x150bab;var _0x38d07a,_0x55602e;this[_0x5c0e22(0x156)]['log']('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x285eb2=this[_0x5c0e22(0x1b4)](_0x3ce1ac),_0x2d9307=_0x285eb2[_0x5c0e22(0x17f)]((_0x8a22f6,_0x1732e5)=>_0x8a22f6[_0x5c0e22(0x150)](_0x1732e5[_0x5c0e22(0x1a1)],_0x1732e5),new Map());for(const _0x523f3a of _0x51eec5){for(const _0x1bd978 in _0x523f3a[_0x5c0e22(0x1af)]){const {base:_0x2d9446,name:_0x365d33,dir:_0x1c9352}=path_1[_0x5c0e22(0x187)][_0x5c0e22(0x185)](_0x1bd978),_0x169b23=_0x365d33+veeva_constants_1[_0x5c0e22(0x17d)][_0x5c0e22(0x1bb)];if(_0x2d9307['has'](_0x2d9446)){const _0x169379=await((_0x38d07a=_0x523f3a['file'](path_1['default'][_0x5c0e22(0x1c1)](_0x1c9352,_0x2d9446)))===null||_0x38d07a===void 0x0?void 0x0:_0x38d07a[_0x5c0e22(0x1bc)](_0x5c0e22(0x178))),_0xce7b61=await((_0x55602e=_0x523f3a[_0x5c0e22(0x183)](path_1[_0x5c0e22(0x187)][_0x5c0e22(0x1c1)](_0x1c9352,_0x169b23)))===null||_0x55602e===void 0x0?void 0x0:_0x55602e['async'](_0x5c0e22(0x178)));if(_0x169379&&_0xce7b61){const _0x534de4=new jszip_1[(_0x5c0e22(0x187))]();_0x534de4[_0x5c0e22(0x183)](_0x2d9446,_0x169379),_0x534de4[_0x5c0e22(0x183)](_0x169b23,this[_0x5c0e22(0x1a0)](_0xce7b61)),_0x2d9307[_0x5c0e22(0x1c7)](_0x2d9446)['body']=await _0x534de4[_0x5c0e22(0x14b)]({'type':'base64'});}}}}return _0x285eb2['filter'](_0x485776=>!_0x485776['body'])[_0x5c0e22(0x1b0)](_0x2ff7b5=>{const _0x229927=_0x5c0e22;this['_logger'][_0x229927(0x1b8)](_0x229927(0x168)+_0x2ff7b5['veevaComponentType']+'.'+_0x2ff7b5[_0x229927(0x18d)]+_0x229927(0x171));}),_0x285eb2['filter'](_0x19bd4b=>_0x19bd4b[_0x5c0e22(0x1ae)]);}[a362_0x150bab(0x1a0)](_0x4ef450){const _0x3c7711=a362_0x150bab,_0x554708=(0x0,sync_1[_0x3c7711(0x185)])(_0x4ef450,{'columns':!![],'skip_empty_lines':!![]}),_0x3b9d67=_0x554708[_0x3c7711(0x18a)](({'In\x20Package':_0x21d8df,..._0x4213e3})=>_0x4213e3);return(0x0,sync_2[_0x3c7711(0x1b9)])(_0x3b9d67,{'header':!![]});}['formMetadataItemDtoList'](_0x14571d){return _0x14571d['map'](_0x3e041b=>{const _0x22ae9a=a362_0x5312,_0x334cc9=new metadata_item_dto_1[(_0x22ae9a(0x1a8))]();return _0x334cc9[_0x22ae9a(0x18d)]=_0x3e041b[_0x22ae9a(0x18d)],_0x334cc9[_0x22ae9a(0x148)]=_0x3e041b[_0x22ae9a(0x18d)],_0x334cc9['snapshotId']=this[_0x22ae9a(0x180)],_0x334cc9[_0x22ae9a(0x1a1)]=_0x3e041b[_0x22ae9a(0x1cc)]+'.'+_0x3e041b[_0x22ae9a(0x18d)]+veeva_constants_1[_0x22ae9a(0x17d)][_0x22ae9a(0x151)],_0x334cc9[_0x22ae9a(0x16a)]=_0x3e041b['type'],_0x334cc9[_0x22ae9a(0x173)]=_0x3e041b[_0x22ae9a(0x173)],_0x334cc9[_0x22ae9a(0x1a4)]=![],_0x334cc9;});}async[a362_0x150bab(0x182)](_0x3fb48f){const _0x31bde9=a362_0x150bab;this[_0x31bde9(0x156)][_0x31bde9(0x1b8)](_0x31bde9(0x1a9)),await this[_0x31bde9(0x188)](_0x3fb48f),this[_0x31bde9(0x156)][_0x31bde9(0x1b8)](_0x31bde9(0x154)+_0x3fb48f[_0x31bde9(0x17a)]+_0x31bde9(0x15b));const _0x419655=_0x3fb48f[_0x31bde9(0x18a)](_0x56d28c=>{const _0x3e92be=_0x31bde9;return{[constants_1['FLOSUM_NAMESPACE']+_0x3e92be(0x19f)]:_0x56d28c['name'],[constants_1[_0x3e92be(0x14c)]+_0x3e92be(0x1ad)]:_0x56d28c[_0x3e92be(0x148)],[constants_1[_0x3e92be(0x14c)]+_0x3e92be(0x159)]:_0x56d28c[_0x3e92be(0x172)],[constants_1['FLOSUM_NAMESPACE']+_0x3e92be(0x19d)]:_0x56d28c['label'],[constants_1[_0x3e92be(0x14c)]+_0x3e92be(0x19c)]:_0x56d28c[_0x3e92be(0x1a4)],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Component_Type__c']:_0x56d28c[_0x3e92be(0x16a)],[constants_1[_0x3e92be(0x14c)]+_0x3e92be(0x161)]:_0x56d28c[_0x3e92be(0x1b6)],[constants_1[_0x3e92be(0x14c)]+_0x3e92be(0x195)]:_0x56d28c[_0x3e92be(0x173)]};}),_0x4f40fb=await this['_salesforceService'][_0x31bde9(0x191)](constants_1['FLOSUM_NAMESPACE']+_0x31bde9(0x186),_0x419655);let _0xee1554=!![];_0x4f40fb[_0x31bde9(0x1b0)]((_0x34b4df,_0x46dfc1)=>{const _0x2d025b=_0x31bde9;this[_0x2d025b(0x156)]['log'](_0x2d025b(0x154)+_0x3fb48f[_0x46dfc1][_0x2d025b(0x16a)]+'.'+_0x3fb48f[_0x46dfc1]['name']);if(!_0x34b4df['success']){_0xee1554=![];const _0xd0644=new salesforce_dml_error_1[(_0x2d025b(0x19b))](_0x34b4df['errors']);this['_logger'][_0x2d025b(0x194)](_0xd0644);}});if(!_0xee1554)throw new Error(_0x31bde9(0x167));}async['saveAttachments'](_0x1522b2){const _0x5090a7=a362_0x150bab,_0x2e5175=this[_0x5090a7(0x18e)](_0x1522b2),_0xf3d354=await this[_0x5090a7(0x176)][_0x5090a7(0x191)](SnapshotService[_0x5090a7(0x18b)],_0x2e5175),_0x3e80f7=[];_0xf3d354[_0x5090a7(0x1b0)]((_0x2c1236,_0x52e286)=>{const _0x482d8e=_0x5090a7;_0x2c1236[_0x482d8e(0x1c3)]?(_0x1522b2[_0x52e286][_0x482d8e(0x1b6)]=_0x2c1236['id'],_0x1522b2[_0x52e286][_0x482d8e(0x1a4)]=!![]):_0x3e80f7[_0x482d8e(0x15e)](..._0x2c1236[_0x482d8e(0x170)]);});if(_0x3e80f7['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x3e80f7);}[a362_0x150bab(0x18e)](_0x1e4e25){const _0x41188f=a362_0x150bab;return _0x1e4e25[_0x41188f(0x18a)](_0x60013=>({'ParentId':this[_0x41188f(0x180)],'Name':_0x60013[_0x41188f(0x16a)],'ContentType':'application/zip','Body':_0x60013[_0x41188f(0x1ae)],'Description':_0x60013[_0x41188f(0x16a)]}));}async['finishSnapshot'](_0x31ce75){const _0x33ee12=a362_0x150bab,_0x162a57={[constants_1[_0x33ee12(0x14c)]+_0x33ee12(0x16d)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x33ee12(0x198)]:!_0x31ce75},_0x47df7b={[constants_1['FLOSUM_NAMESPACE']+_0x33ee12(0x198)]:!_0x31ce75,[constants_1[_0x33ee12(0x14c)]+_0x33ee12(0x16c)]:_0x31ce75,[constants_1[_0x33ee12(0x14c)]+_0x33ee12(0x162)]:_0x31ce75?status_enums_1[_0x33ee12(0x1cb)][_0x33ee12(0x179)]:status_enums_1[_0x33ee12(0x1cb)]['EXCEPTION'],[constants_1[_0x33ee12(0x14c)]+_0x33ee12(0x169)]:!![]};await this[_0x33ee12(0x14d)][_0x33ee12(0x197)](flosum_constants_1['FlosumConstants'][_0x33ee12(0x158)]+'/'+constants_1[_0x33ee12(0x14c)]+_0x33ee12(0x19a)+this[_0x33ee12(0x180)],_0x162a57),await this[_0x33ee12(0x14d)][_0x33ee12(0x197)](flosum_constants_1['FlosumConstants'][_0x33ee12(0x158)]+'/'+constants_1[_0x33ee12(0x14c)]+_0x33ee12(0x19e)+this[_0x33ee12(0x18f)],_0x47df7b),this[_0x33ee12(0x156)][_0x33ee12(0x1b8)](_0x33ee12(0x1c6)+(_0x31ce75?_0x33ee12(0x17e):_0x33ee12(0x165))+'.'),await this['_logger'][_0x33ee12(0x157)]();}}exports[a362_0x150bab(0x15d)]=SnapshotService,SnapshotService[a362_0x150bab(0x1b1)]='Snapshot',SnapshotService[a362_0x150bab(0x18b)]='Attachment';