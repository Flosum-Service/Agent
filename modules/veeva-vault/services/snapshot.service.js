const a407_0xd520b4=a407_0x52bc;function a407_0x3f4a(){const _0x537e18=['FlosumConstants','516KdbhFT','347793iavxRv','Is_Completed__c','../enums/status.enums','generateAsync','__importDefault','_veevaService','label','patch','string','isRetrieved','finishSnapshot','filter','COMPLETED','base64','VeevaConstants','jszip','toString','1172599ltYQYk','_connectionSalesforce','reduce','EXCEPTION','apiName','body','Cannot\x20retrieve\x20','from','./veeva.service','constructor','_salesforceService','errors','async','8KXcfVj','33378ZImzTn','retrieveVeevaComponents','_connectionVeeva','length','execute','veevaComponentType','search','Snapshot__c/','snapshotId','_metadataLogId','Saving\x20','SnapshotService','PackageExportService','../constants/veeva.constants','map','42830LnmmAa','Metadata_Item__c','Name__c','FLOSUM_NAMESPACE','Veeva_Component_Type__c','(((.+)+)+)+$','success','attachmentId','error','forEach','_selectedComponentMap','TypeVeevaComponentRetriever','insertMultipleRecords','ENDPOINT_UPSERT_RECORD','20pvwaMm','Attachment_ID__c','Is_Error__c','TypeAndNameVeevaComponentRetriever','_logger','get','createMetadataItemListWithBody','join','transformDependencyFile','9757566nTQqXD','API_Name__c','../dtos/metadata-item.dto','stringify','../../../constants','Job_Completed__c','updateLog','_snapshotId','MDL_EXTENSION','default','formAttachments','_packageExportService','name','25350130kJjEjQ','../constants/flosum.constants','Snapshot\x20started.','apply','Cannot\x20Save\x20Metadata\x20Items','./package-export.service','SalesforceDmlError','defineProperty','sep','parse','posix','type','SalesforceService','\x20Metadata\x20Items','Label__c','ATTACHMENT','7129073ffkpTW','Snapshot\x20completed\x20','file','lastModifiedDate','logError','saveComponentsInSalesforce','../classes/retrievers/veeva-components/type.veeva-component.retriever','_systemLogger','\x20from\x20outbound\x20package','with\x20error','Snapshot','csv-stringify/sync','_selectedMetaTypes','Last_Modified_Date__c','Saving\x20Attachments.','Is_Retrieved__c','push','csv-parse/sync','DEPENDENCY_EXTENSION','OUTBOUND_PACKAGE_NAME','./salesforce.service','saveAttachments','__esModule','application/zip','log','formMetadataItemDtoList','values','retrieve'];a407_0x3f4a=function(){return _0x537e18;};return a407_0x3f4a();}(function(_0x573c06,_0x3e64ff){const _0x4bb69a=a407_0x52bc,_0x313268=_0x573c06();while(!![]){try{const _0x13b7b5=parseInt(_0x4bb69a(0x10f))/0x1+parseInt(_0x4bb69a(0xba))/0x2*(parseInt(_0x4bb69a(0xfe))/0x3)+-parseInt(_0x4bb69a(0xfd))/0x4*(parseInt(_0x4bb69a(0xac))/0x5)+parseInt(_0x4bb69a(0x9d))/0x6+-parseInt(_0x4bb69a(0xe0))/0x7*(-parseInt(_0x4bb69a(0x11c))/0x8)+parseInt(_0x4bb69a(0xc3))/0x9+-parseInt(_0x4bb69a(0xd0))/0xa;if(_0x13b7b5===_0x3e64ff)break;else _0x313268['push'](_0x313268['shift']());}catch(_0x8f002f){_0x313268['push'](_0x313268['shift']());}}}(a407_0x3f4a,0xc353a));const a407_0x3a7fdf=(function(){let _0x5f2a78=!![];return function(_0x36a941,_0x2960ba){const _0x108b47=_0x5f2a78?function(){const _0x2490a1=a407_0x52bc;if(_0x2960ba){const _0x50a11e=_0x2960ba[_0x2490a1(0xd3)](_0x36a941,arguments);return _0x2960ba=null,_0x50a11e;}}:function(){};return _0x5f2a78=![],_0x108b47;};}()),a407_0x355814=a407_0x3a7fdf(this,function(){const _0x4a24ff=a407_0x52bc;return a407_0x355814[_0x4a24ff(0x10e)]()['search']('(((.+)+)+)+$')['toString']()[_0x4a24ff(0x118)](a407_0x355814)[_0x4a24ff(0xa3)](_0x4a24ff(0xb1));});a407_0x355814();'use strict';var __importDefault=this&&this[a407_0xd520b4(0x102)]||function(_0xe29be9){const _0x3e4fee=a407_0xd520b4;return _0xe29be9&&_0xe29be9[_0x3e4fee(0xf6)]?_0xe29be9:{'default':_0xe29be9};};function a407_0x52bc(_0x1902fc,_0x3d551c){const _0x10e23b=a407_0x3f4a();return a407_0x52bc=function(_0x355814,_0x3a7fdf){_0x355814=_0x355814-0x9d;let _0x3f4a85=_0x10e23b[_0x355814];return _0x3f4a85;},a407_0x52bc(_0x1902fc,_0x3d551c);}Object[a407_0xd520b4(0xd7)](exports,a407_0xd520b4(0xf6),{'value':!![]}),exports['SnapshotService']=void 0x0;const jszip_1=__importDefault(require(a407_0xd520b4(0x10d))),flosum_constants_1=require(a407_0xd520b4(0xd1)),veeva_service_1=require(a407_0xd520b4(0x117)),metadata_item_dto_1=require(a407_0xd520b4(0xc5)),constants_1=require(a407_0xd520b4(0xc7)),salesforce_service_1=require(a407_0xd520b4(0xf4)),status_enums_1=require(a407_0xd520b4(0x100)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),package_export_service_1=require(a407_0xd520b4(0xd5)),type_and_name_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/type-and-name.veeva-component.retriever'),type_veeva_component_retriever_1=require(a407_0xd520b4(0xe6)),sync_1=require(a407_0xd520b4(0xf1)),sync_2=require(a407_0xd520b4(0xeb)),veeva_constants_1=require(a407_0xd520b4(0xaa)),path_1=__importDefault(require('path'));class SnapshotService{constructor({snapshotId:_0xd191,metadataLogId:_0x315ed7,selectedMetaTypes:_0x21fdeb,selectedComponentMap:_0x314fa1,whereClause:_0xf2fbca},_0x5cbb87,_0xe64d92,_0x5ce4ea){const _0x1d9446=a407_0xd520b4;this[_0x1d9446(0x110)]=_0x5cbb87,this[_0x1d9446(0x9f)]=_0xe64d92,this['_logger']=_0x5ce4ea,this[_0x1d9446(0xca)]=_0xd191,this[_0x1d9446(0xa6)]=_0x315ed7,this[_0x1d9446(0xec)]=_0x21fdeb,this[_0x1d9446(0xb6)]=_0x314fa1,this['_whereClause']=_0xf2fbca,this[_0x1d9446(0x103)]=new veeva_service_1['VeevaService']({'connection':this[_0x1d9446(0x9f)],'logger':this[_0x1d9446(0xbe)]}),this[_0x1d9446(0x119)]=new salesforce_service_1[(_0x1d9446(0xdc))]({'connection':this[_0x1d9446(0x110)]}),this[_0x1d9446(0xce)]=new package_export_service_1[(_0x1d9446(0xa9))]({'veevaService':this[_0x1d9446(0x103)],'connection':this[_0x1d9446(0x9f)],'logger':this['_logger']});}async[a407_0xd520b4(0xa1)](){const _0x5acb6c=a407_0xd520b4;try{this[_0x5acb6c(0xbe)][_0x5acb6c(0xf8)](_0x5acb6c(0xd2));const _0x448e20=await this['retrieveVeevaComponents']();await this[_0x5acb6c(0xbe)][_0x5acb6c(0xc9)]();const _0xbc78fd=await this[_0x5acb6c(0xce)]['export'](_0x448e20,SnapshotService[_0x5acb6c(0xf3)]);await this[_0x5acb6c(0xbe)][_0x5acb6c(0xc9)]();const _0x13fe6d=await this['createMetadataItemListWithBody'](_0x448e20,_0xbc78fd);await this[_0x5acb6c(0xe5)](_0x13fe6d),await this[_0x5acb6c(0xbe)]['updateLog'](),await this[_0x5acb6c(0x108)](!![]);}catch(_0x43a605){this['_logger']['logError'](_0x43a605),await this[_0x5acb6c(0x108)](![])['catch'](_0x2afa5a=>this[_0x5acb6c(0xe7)][_0x5acb6c(0xb4)](_0x2afa5a));}}async[a407_0xd520b4(0x9e)](){const _0x49d3d9=a407_0xd520b4,_0xf16ce7={'veevaService':this[_0x49d3d9(0x103)],'logger':this[_0x49d3d9(0xbe)]},_0x22029b=Array[_0x49d3d9(0x116)](Object[_0x49d3d9(0xfa)](this['_selectedComponentMap']))[_0x49d3d9(0xa0)]?new type_and_name_veeva_component_retriever_1[(_0x49d3d9(0xbd))]({'value':this[_0x49d3d9(0xb6)],..._0xf16ce7}):new type_veeva_component_retriever_1[(_0x49d3d9(0xb7))]({'value':this[_0x49d3d9(0xec)],'whereClause':this['_whereClause'],..._0xf16ce7});return _0x22029b[_0x49d3d9(0xfb)]();}async[a407_0xd520b4(0xc0)](_0x327f85,_0x97ce3d){const _0x5af8a4=a407_0xd520b4;var _0x14c07b,_0x29ced7;this['_logger'][_0x5af8a4(0xf8)]('Unpack\x20zip\x20and\x20create\x20metadata\x20items.');const _0x4c9691=this[_0x5af8a4(0xf9)](_0x327f85),_0x3e9cd7=_0x4c9691[_0x5af8a4(0x111)]((_0x576bdf,_0xa58cd6)=>_0x576bdf['set'](_0xa58cd6[_0x5af8a4(0x104)],_0xa58cd6),new Map());for(const _0x19626c of _0x97ce3d){for(const _0x137ba0 in _0x19626c['files']){const {base:_0x48d67c,name:_0x2b4204,dir:_0x9acf00}=path_1[_0x5af8a4(0xcc)][_0x5af8a4(0xd9)](_0x137ba0),_0x367f48=_0x2b4204+veeva_constants_1[_0x5af8a4(0x10c)][_0x5af8a4(0xf2)];if(_0x3e9cd7['has'](_0x48d67c)){const _0x546e8d=await((_0x14c07b=_0x19626c[_0x5af8a4(0xe2)]([_0x9acf00,_0x48d67c]['join'](path_1['default'][_0x5af8a4(0xda)][_0x5af8a4(0xd8)])))===null||_0x14c07b===void 0x0?void 0x0:_0x14c07b[_0x5af8a4(0x11b)](_0x5af8a4(0x106))),_0x30ac87=await((_0x29ced7=_0x19626c[_0x5af8a4(0xe2)]([_0x9acf00,_0x367f48][_0x5af8a4(0xc1)](path_1[_0x5af8a4(0xcc)][_0x5af8a4(0xda)][_0x5af8a4(0xd8)])))===null||_0x29ced7===void 0x0?void 0x0:_0x29ced7[_0x5af8a4(0x11b)](_0x5af8a4(0x106)));if(_0x546e8d){const _0x58b1b3=new jszip_1[(_0x5af8a4(0xcc))]();_0x58b1b3[_0x5af8a4(0xe2)](_0x48d67c,_0x546e8d),_0x30ac87&&_0x58b1b3['file'](_0x367f48,this[_0x5af8a4(0xc2)](_0x30ac87)),_0x3e9cd7[_0x5af8a4(0xbf)](_0x48d67c)[_0x5af8a4(0x114)]=await _0x58b1b3[_0x5af8a4(0x101)]({'type':_0x5af8a4(0x10b)});}}}}return _0x4c9691[_0x5af8a4(0x109)](_0x4ffdf7=>!_0x4ffdf7[_0x5af8a4(0x114)])['forEach'](_0x149a3e=>{const _0x8ea8fd=_0x5af8a4;this[_0x8ea8fd(0xbe)][_0x8ea8fd(0xf8)](_0x8ea8fd(0x115)+_0x149a3e['veevaComponentType']+'.'+_0x149a3e[_0x8ea8fd(0xcf)]+_0x8ea8fd(0xe8));}),_0x4c9691[_0x5af8a4(0x109)](_0x52080b=>_0x52080b[_0x5af8a4(0x114)]);}[a407_0xd520b4(0xc2)](_0x9890e0){const _0x32cf74=a407_0xd520b4,_0x52809c=(0x0,sync_1[_0x32cf74(0xd9)])(_0x9890e0,{'columns':!![],'skip_empty_lines':!![]}),_0x3e882e=_0x52809c[_0x32cf74(0xab)](({'In\x20Package':_0x409f69,..._0x4ebeb7})=>_0x4ebeb7);return(0x0,sync_2[_0x32cf74(0xc6)])(_0x3e882e,{'header':!![]});}[a407_0xd520b4(0xf9)](_0x274884){const _0x34d6fb=a407_0xd520b4;return _0x274884[_0x34d6fb(0xab)](_0x374bcf=>{const _0x47d1c0=_0x34d6fb,_0x1fc825=new metadata_item_dto_1['MetadataItemDto']();return _0x1fc825[_0x47d1c0(0xcf)]=_0x374bcf[_0x47d1c0(0xcf)],_0x1fc825[_0x47d1c0(0x113)]=_0x374bcf[_0x47d1c0(0xcf)],_0x1fc825[_0x47d1c0(0xa5)]=this['_snapshotId'],_0x1fc825[_0x47d1c0(0x104)]=_0x374bcf[_0x47d1c0(0xdb)]+'.'+_0x374bcf[_0x47d1c0(0xcf)]+veeva_constants_1[_0x47d1c0(0x10c)][_0x47d1c0(0xcb)],_0x1fc825[_0x47d1c0(0xa2)]=_0x374bcf['type'],_0x1fc825[_0x47d1c0(0xe3)]=_0x374bcf[_0x47d1c0(0xe3)],_0x1fc825[_0x47d1c0(0x107)]=![],_0x1fc825;});}async['saveComponentsInSalesforce'](_0x2792bb){const _0x23e2d1=a407_0xd520b4;this['_logger'][_0x23e2d1(0xf8)](_0x23e2d1(0xee)),await this[_0x23e2d1(0xf5)](_0x2792bb),this['_logger'][_0x23e2d1(0xf8)](_0x23e2d1(0xa7)+_0x2792bb[_0x23e2d1(0xa0)]+_0x23e2d1(0xdd));const _0x220091=_0x2792bb[_0x23e2d1(0xab)](_0x3e7ecd=>{const _0x218173=_0x23e2d1;return{[constants_1['FLOSUM_NAMESPACE']+_0x218173(0xae)]:_0x3e7ecd['name'],[constants_1[_0x218173(0xaf)]+_0x218173(0xc4)]:_0x3e7ecd[_0x218173(0x113)],[constants_1[_0x218173(0xaf)]+'Snapshot__c']:_0x3e7ecd[_0x218173(0xa5)],[constants_1[_0x218173(0xaf)]+_0x218173(0xde)]:_0x3e7ecd[_0x218173(0x104)],[constants_1[_0x218173(0xaf)]+_0x218173(0xef)]:_0x3e7ecd[_0x218173(0x107)],[constants_1[_0x218173(0xaf)]+_0x218173(0xb0)]:_0x3e7ecd['veevaComponentType'],[constants_1['FLOSUM_NAMESPACE']+_0x218173(0xbb)]:_0x3e7ecd[_0x218173(0xb3)],[constants_1[_0x218173(0xaf)]+_0x218173(0xed)]:_0x3e7ecd[_0x218173(0xe3)]};}),_0x3cf712=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x23e2d1(0xaf)]+_0x23e2d1(0xad),_0x220091);let _0x5a70fd=!![];_0x3cf712[_0x23e2d1(0xb5)]((_0x975199,_0x536a45)=>{const _0x8f80a6=_0x23e2d1;this[_0x8f80a6(0xbe)]['log'](_0x8f80a6(0xa7)+_0x2792bb[_0x536a45][_0x8f80a6(0xa2)]+'.'+_0x2792bb[_0x536a45][_0x8f80a6(0xcf)]);if(!_0x975199[_0x8f80a6(0xb2)]){_0x5a70fd=![];const _0x562b31=new salesforce_dml_error_1[(_0x8f80a6(0xd6))](_0x975199[_0x8f80a6(0x11a)]);this[_0x8f80a6(0xbe)][_0x8f80a6(0xe4)](_0x562b31);}});if(!_0x5a70fd)throw new Error(_0x23e2d1(0xd4));}async[a407_0xd520b4(0xf5)](_0x3e97f3){const _0x4bd9d3=a407_0xd520b4,_0x5ae3ed=this['formAttachments'](_0x3e97f3),_0x18f0d7=await this[_0x4bd9d3(0x119)][_0x4bd9d3(0xb8)](SnapshotService[_0x4bd9d3(0xdf)],_0x5ae3ed),_0x28b188=[];_0x18f0d7[_0x4bd9d3(0xb5)]((_0x51f9bb,_0x5ac715)=>{const _0x3bdcbc=_0x4bd9d3;_0x51f9bb[_0x3bdcbc(0xb2)]?(_0x3e97f3[_0x5ac715][_0x3bdcbc(0xb3)]=_0x51f9bb['id'],_0x3e97f3[_0x5ac715]['isRetrieved']=!![]):_0x28b188[_0x3bdcbc(0xf0)](..._0x51f9bb['errors']);});if(_0x28b188[_0x4bd9d3(0xa0)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x28b188);}[a407_0xd520b4(0xcd)](_0x526643){const _0x3b4dd0=a407_0xd520b4;return _0x526643[_0x3b4dd0(0xab)](_0x5c8013=>({'ParentId':this[_0x3b4dd0(0xca)],'Name':_0x5c8013[_0x3b4dd0(0xa2)],'ContentType':_0x3b4dd0(0xf7),'Body':_0x5c8013[_0x3b4dd0(0x114)],'Description':_0x5c8013[_0x3b4dd0(0xa2)]}));}async[a407_0xd520b4(0x108)](_0x5ebe5f){const _0x545325=a407_0xd520b4,_0x4f31ee={[constants_1['FLOSUM_NAMESPACE']+_0x545325(0xff)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x545325(0xbc)]:!_0x5ebe5f},_0x4e0711={[constants_1[_0x545325(0xaf)]+'Is_Error__c']:!_0x5ebe5f,[constants_1[_0x545325(0xaf)]+'Succeed__c']:_0x5ebe5f,[constants_1[_0x545325(0xaf)]+'Status__c']:_0x5ebe5f?status_enums_1['MetadataLogStatus'][_0x545325(0x10a)]:status_enums_1['MetadataLogStatus'][_0x545325(0x112)],[constants_1['FLOSUM_NAMESPACE']+_0x545325(0xc8)]:!![]};await this[_0x545325(0x110)]['patch'](flosum_constants_1[_0x545325(0xfc)][_0x545325(0xb9)]+'/'+constants_1[_0x545325(0xaf)]+_0x545325(0xa4)+this[_0x545325(0xca)],_0x4f31ee),await this[_0x545325(0x110)][_0x545325(0x105)](flosum_constants_1[_0x545325(0xfc)][_0x545325(0xb9)]+'/'+constants_1[_0x545325(0xaf)]+'Metadata_Log__c/'+this[_0x545325(0xa6)],_0x4e0711),this[_0x545325(0xbe)][_0x545325(0xf8)](_0x545325(0xe1)+(_0x5ebe5f?'successfully':_0x545325(0xe9))+'.'),await this['_logger'][_0x545325(0xc9)]();}}exports[a407_0xd520b4(0xa8)]=SnapshotService,SnapshotService[a407_0xd520b4(0xf3)]=a407_0xd520b4(0xea),SnapshotService[a407_0xd520b4(0xdf)]='Attachment';