const a402_0x7c620e=a402_0x2b42;function a402_0x2b42(_0x243230,_0x4adae9){const _0x1ffd8e=a402_0x53da();return a402_0x2b42=function(_0x212a53,_0x397313){_0x212a53=_0x212a53-0xf1;let _0x53da00=_0x1ffd8e[_0x212a53];return _0x53da00;},a402_0x2b42(_0x243230,_0x4adae9);}(function(_0x2205ca,_0x211107){const _0x519693=a402_0x2b42,_0xfc99f8=_0x2205ca();while(!![]){try{const _0x342810=-parseInt(_0x519693(0x15b))/0x1*(parseInt(_0x519693(0x17c))/0x2)+-parseInt(_0x519693(0x180))/0x3+parseInt(_0x519693(0x193))/0x4+parseInt(_0x519693(0x15f))/0x5+parseInt(_0x519693(0x14b))/0x6*(parseInt(_0x519693(0x14e))/0x7)+parseInt(_0x519693(0x153))/0x8*(parseInt(_0x519693(0x185))/0x9)+parseInt(_0x519693(0xfd))/0xa*(-parseInt(_0x519693(0x17d))/0xb);if(_0x342810===_0x211107)break;else _0xfc99f8['push'](_0xfc99f8['shift']());}catch(_0x1ddc19){_0xfc99f8['push'](_0xfc99f8['shift']());}}}(a402_0x53da,0xb977e));const a402_0x397313=(function(){let _0x4a027c=!![];return function(_0x45e0ba,_0xcfd256){const _0x529f=_0x4a027c?function(){if(_0xcfd256){const _0x11dbec=_0xcfd256['apply'](_0x45e0ba,arguments);return _0xcfd256=null,_0x11dbec;}}:function(){};return _0x4a027c=![],_0x529f;};}()),a402_0x212a53=a402_0x397313(this,function(){const _0x58a37e=a402_0x2b42;return a402_0x212a53[_0x58a37e(0x181)]()['search']('(((.+)+)+)+$')[_0x58a37e(0x181)]()[_0x58a37e(0x121)](a402_0x212a53)[_0x58a37e(0x146)](_0x58a37e(0x189));});a402_0x212a53();'use strict';var __importDefault=this&&this[a402_0x7c620e(0x108)]||function(_0x1a6369){const _0x1dba51=a402_0x7c620e;return _0x1a6369&&_0x1a6369[_0x1dba51(0x149)]?_0x1a6369:{'default':_0x1a6369};};Object[a402_0x7c620e(0x145)](exports,a402_0x7c620e(0x149),{'value':!![]}),exports[a402_0x7c620e(0x17a)]=void 0x0;function a402_0x53da(){const _0x34bc30=['Deploy\x20completed\x20','get','./veeva.service','retrieveAttachments','base64','isDeployed','bind','createZip','Deployment','map','Activity_Item__c','defineProperty','search','Backup','MetadataLogStatus','__esModule','veeva-deploy','66PlVFYM','Action__c','BACKUP_ZIP_NAME','454888RZhRHC','_tempFolder','_branchId','ENDPOINT_UPSERT_RECORD','_systemLogger','5112AmEgPl','_organisationName','Retrieving\x20components','_vpkService','import','_organisationId','_componentIdList','_veevaService','704612nXunvX','generate','_packageExportService','toLowerCase','7077555YHPwPq','_deploymentName','_packageImportService','/vpk__','status','errors','saveBackup','validate','reduce','application/zip','deploymentAction','componentName','Save\x20Backup\x20to\x20Salesforce','FlosumConstants','\x20has\x20been\x20created.','\x20of\x20branch\x20to\x20Organization\x20','execute','/Attachment','_metadataLogId','insertMultipleRecords','filter','Metadata_Log__c/','Cannot\x20retrieve\x20all\x20components.','Create\x20Backup','retrieve','generateAsync','set','DeployService','successfully','2ncBMir','77OebemU','success','./salesforce.service','86454JLjMCu','toString','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Failure','_logger','15597MqdeZK','patch','Success','createVpk','(((.+)+)+)+$','type','COMPLETED','Component_History__c','Join\x20all\x20mdl\x20into\x20one\x20zip','Logger','has','_attachmentLogId','Branch__c','Veeva_Step_Name__c','2044460PIEXfk','Cannot\x20Backup\x20more\x20than\x20200\x20components.','../../shared/utils/fetch-attachments','Branch','componentHistoryId','componentType','finishDeploy','_instanceUrl','Form\x20Deployment\x20Results','saveDeploymentResults','Save\x20Deployment\x20Results','catch','Retrieving\x20attachments','3222470XWfXKc','PackageImportService','EXCEPTION','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','PackageExportService','from','default','Save\x20log','Veeva\x20Deployment','finishDeployWithError','formFlosumDeploymentResults','__importDefault','Deployment_Result__c','Metadata_Log__c','Create\x20vpk\x20package','slice','export','./package-import.service','\x20</a>','timeZone','<a\x20href=','stepName','FlosumComponentVeevaComponentRetriever','getFlosumComponents','../enums/status.enums','Activity_Type__c','packageComponentList','</a>','shortid','packageId','Org__c','_timeZone','log','TargetId__c','SalesforceDmlError','logError','constructor','fs/promises','../../../core','_connectionSalesforce','post','VeevaService','name','.zip','BranchComponentHistoryFlosumComponentRetriever','../classes/errors/salesforce-dml-error','_connectionVeeva','Component_Name__c','FLOSUM_NAMESPACE','../../../constants','flat','componentIdList','branchId','createBackup','organisationName','length','External_Deployment_Id__c','values','updateLog','Status__c','saveLog'];a402_0x53da=function(){return _0x34bc30;};return a402_0x53da();}const jszip_1=__importDefault(require('jszip')),promises_1=require(a402_0x7c620e(0x122)),constants_1=require(a402_0x7c620e(0x12e)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a402_0x7c620e(0x13c)),salesforce_service_1=require(a402_0x7c620e(0x17f)),core_1=require(a402_0x7c620e(0x123)),status_enums_1=require(a402_0x7c620e(0x115)),salesforce_dml_error_1=require(a402_0x7c620e(0x12a)),shortid_1=__importDefault(require(a402_0x7c620e(0x119))),fetch_attachments_1=require(a402_0x7c620e(0xf2)),package_import_service_1=require(a402_0x7c620e(0x10e)),branch_component_history_flosum_component_retriever_1=require(a402_0x7c620e(0x182)),flosum_component_veeva_component_retriever_1=require(a402_0x7c620e(0x100)),package_export_service_1=require('./package-export.service'),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0xac13d7,_0x57f054,_0x593b80,_0x329f20,_0x3ad89d,_0x6086){const _0x1e225d=a402_0x7c620e;this[_0x1e225d(0x124)]=_0x57f054,this['_connectionVeeva']=_0x593b80,this['_logger']=_0x329f20,this[_0x1e225d(0x14f)]=_0x3ad89d,this[_0x1e225d(0xf7)]=_0x6086,this['_branchId']=_0xac13d7[_0x1e225d(0x131)],this['_metadataLogId']=_0xac13d7['metadataLogId'],this[_0x1e225d(0x190)]=_0xac13d7['attachmentLogId'],this[_0x1e225d(0x158)]=_0xac13d7['organisationId'],this[_0x1e225d(0x11c)]=_0xac13d7[_0x1e225d(0x110)],this['_organisationName']=_0xac13d7[_0x1e225d(0x133)],this[_0x1e225d(0x159)]=_0xac13d7[_0x1e225d(0x130)],this[_0x1e225d(0x160)]=_0xac13d7['deploymentName'],this[_0x1e225d(0x152)]=new core_1[(_0x1e225d(0x18e))](_0x1e225d(0x14a)),this[_0x1e225d(0x15a)]=new veeva_service_1[(_0x1e225d(0x126))]({'connection':this[_0x1e225d(0x12b)],'logger':this[_0x1e225d(0x184)]}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':this[_0x1e225d(0x124)]}),this[_0x1e225d(0x161)]=new package_import_service_1[(_0x1e225d(0xfe))]({'veevaService':this[_0x1e225d(0x15a)],'connection':this[_0x1e225d(0x12b)],'logger':this[_0x1e225d(0x184)],'saveLog':this[_0x1e225d(0x139)][_0x1e225d(0x140)](this)}),this[_0x1e225d(0x15d)]=new package_export_service_1[(_0x1e225d(0x101))]({'veevaService':this[_0x1e225d(0x15a)],'connection':this['_connectionVeeva'],'logger':this[_0x1e225d(0x184)]}),this['_vpkService']=new vpk_service_1['VpkService']({'connection':this[_0x1e225d(0x12b)]});}async[a402_0x7c620e(0x16f)](){const _0x4eb5e2=a402_0x7c620e;try{const _0x4122c8=await this[_0x4eb5e2(0x114)]();await this['_logger']['updateLog']();const _0x214c5e=await this[_0x4eb5e2(0x132)](_0x4122c8);await this[_0x4eb5e2(0x165)](_0x214c5e);const _0x208732=await this[_0x4eb5e2(0x13d)](_0x4122c8),_0x52fe66=await this['createZip'](_0x208732),_0x573084=await this[_0x4eb5e2(0x188)](_0x52fe66);await this[_0x4eb5e2(0x184)]['updateLog']();const _0x1dcded=await this['_packageImportService'][_0x4eb5e2(0x157)](_0x573084);await this[_0x4eb5e2(0x184)][_0x4eb5e2(0x137)]();const _0x5c9281=this[_0x4eb5e2(0x107)](_0x4122c8,_0x1dcded[_0x4eb5e2(0x117)]);await this[_0x4eb5e2(0xf9)](_0x5c9281),await this[_0x4eb5e2(0xf6)](_0x1dcded[_0x4eb5e2(0x13f)],![],_0x1dcded[_0x4eb5e2(0x11a)]);}catch(_0x31425f){await this['finishDeployWithError'](_0x31425f)[_0x4eb5e2(0xfb)](_0x2fb349=>this[_0x4eb5e2(0x152)]['error'](_0x2fb349));}}async[a402_0x7c620e(0x114)](){const _0x2582ba=a402_0x7c620e,_0x3a8c55=new Set(this['_componentIdList']);this[_0x2582ba(0x184)][_0x2582ba(0x11d)](_0x2582ba(0x155));const _0x1a9741=await new branch_component_history_flosum_component_retriever_1[(_0x2582ba(0x129))]({'value':this[_0x2582ba(0x150)],'salesforceService':this['_salesforceService']})[_0x2582ba(0x177)](),_0x4d4aca=_0x1a9741[_0x2582ba(0x173)](_0xdd1760=>_0x3a8c55[_0x2582ba(0x18f)](_0xdd1760['id']));if(_0x4d4aca[_0x2582ba(0x134)]!==this[_0x2582ba(0x159)]['length'])throw new Error(_0x2582ba(0x175));return _0x4d4aca;}async[a402_0x7c620e(0x132)](_0xb3332){const _0x3c9f1e=a402_0x7c620e;var _0x98705d;this[_0x3c9f1e(0x184)][_0x3c9f1e(0x11d)](_0x3c9f1e(0x176));const _0x341599=await new flosum_component_veeva_component_retriever_1[(_0x3c9f1e(0x113))]({'value':_0xb3332,'veevaService':this['_veevaService'],'logger':this[_0x3c9f1e(0x184)]})[_0x3c9f1e(0x177)](),_0x2a68c0=await this[_0x3c9f1e(0x15d)][_0x3c9f1e(0x10d)](_0x341599,_0x3c9f1e(0x147));if(_0x2a68c0['length']>0x1)throw new Error(_0x3c9f1e(0xf1));return(_0x98705d=_0x2a68c0[0x0])!==null&&_0x98705d!==void 0x0?_0x98705d:_0x2a68c0[0x0]=new jszip_1[(_0x3c9f1e(0x103))](),_0x2a68c0[0x0][_0x3c9f1e(0x178)]({'type':_0x3c9f1e(0x13e)});}async[a402_0x7c620e(0x165)](_0x5d1be8){const _0x4544aa=a402_0x7c620e;this[_0x4544aa(0x184)][_0x4544aa(0x11d)](_0x4544aa(0x16b));const _0x1cc026={'Body':_0x5d1be8,'ContentType':_0x4544aa(0x168),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x4544aa(0x16c)][_0x4544aa(0x14d)]};await this['_connectionSalesforce'][_0x4544aa(0x125)](flosum_constants_1['FlosumConstants'][_0x4544aa(0x151)]+_0x4544aa(0x170),_0x1cc026);}async['retrieveAttachments'](_0x29e2c0){const _0x1cdb14=a402_0x7c620e;this['_logger'][_0x1cdb14(0x11d)](_0x1cdb14(0xfc));const _0x5dadf0=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this['_connectionSalesforce'],_0x29e2c0['map'](_0x526fd4=>_0x526fd4[_0x1cdb14(0xf4)])),_0x16039f=await(0x0,fetch_attachments_1[_0x1cdb14(0x13d)])(_0x5dadf0,this[_0x1cdb14(0x124)]);if(_0x16039f['length']!==this[_0x1cdb14(0x159)][_0x1cdb14(0x134)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x16039f[_0x1cdb14(0x143)](_0xb1b522=>_0xb1b522[_0x1cdb14(0x136)]['Body']);}async[a402_0x7c620e(0x141)](_0x428dbc){const _0x537239=a402_0x7c620e;this[_0x537239(0x184)][_0x537239(0x11d)](_0x537239(0x18d));const _0x25b825=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x428dbc,'deploymentName':this[_0x537239(0x160)]})['execute'](),_0x1e3119=this[_0x537239(0x14f)]+'/'+(0x0,shortid_1['default'])()+_0x537239(0x128);return await(0x0,promises_1['writeFile'])(_0x1e3119,_0x25b825),_0x1e3119;}async[a402_0x7c620e(0x188)](_0x1c2c92){const _0x36de2f=a402_0x7c620e;this[_0x36de2f(0x184)][_0x36de2f(0x11d)](_0x36de2f(0x10b));const _0xd6f47a=await this['_vpkService'][_0x36de2f(0x15c)](_0x1c2c92),_0x9b398c=this[_0x36de2f(0x14f)]+_0x36de2f(0x162)+_0x1c2c92[_0x36de2f(0x10c)](_0x1c2c92['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x9b398c,_0xd6f47a),await this[_0x36de2f(0x156)][_0x36de2f(0x166)](_0x9b398c),_0x9b398c;}async[a402_0x7c620e(0x139)](_0x5422e0,_0x13ebe8){const _0x4561c3=a402_0x7c620e;this[_0x4561c3(0x184)][_0x4561c3(0x11d)](_0x4561c3(0x104));const _0x29bec1={'Body':Buffer[_0x4561c3(0x102)](_0x5422e0)['toString'](_0x4561c3(0x13e)),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x13ebe8};await this[_0x4561c3(0x124)]['post'](flosum_constants_1['FlosumConstants'][_0x4561c3(0x151)]+_0x4561c3(0x170),_0x29bec1);}[a402_0x7c620e(0x107)](_0x5098f2,_0x232603){const _0x4fcdc2=a402_0x7c620e;this['_logger'][_0x4fcdc2(0x11d)](_0x4fcdc2(0xf8));const _0x483d5e=_0x5098f2[_0x4fcdc2(0x167)]((_0x685604,_0x46a695)=>_0x685604[_0x4fcdc2(0x179)]((_0x46a695[_0x4fcdc2(0xf5)]+'.'+_0x46a695[_0x4fcdc2(0x16a)])['toLowerCase'](),_0x46a695),new Map());return _0x232603[_0x4fcdc2(0x143)](_0x1203f2=>{const _0x59811c=_0x4fcdc2;this[_0x59811c(0x184)][_0x59811c(0x11d)](_0x1203f2[_0x59811c(0x18a)]+'.'+_0x1203f2[_0x59811c(0x127)]+'\x20:\x20'+_0x1203f2[_0x59811c(0x163)]);const _0x5b9ecf=(_0x1203f2['type']+'.'+_0x1203f2['name'])[_0x59811c(0x15e)](),_0xca5282=_0x483d5e[_0x59811c(0x13b)](_0x5b9ecf);return{[constants_1[_0x59811c(0x12d)]+'Type__c']:'Deployment\x20Result',[constants_1[_0x59811c(0x12d)]+_0x59811c(0x138)]:_0x1203f2[_0x59811c(0x163)]===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x59811c(0x187):_0x59811c(0x183),[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x1203f2[_0x59811c(0x169)],[constants_1[_0x59811c(0x12d)]+_0x59811c(0x12c)]:_0x1203f2[_0x59811c(0x127)],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x1203f2['type'],[constants_1['FLOSUM_NAMESPACE']+_0x59811c(0x192)]:_0x1203f2[_0x59811c(0x112)],[constants_1[_0x59811c(0x12d)]+_0x59811c(0x11b)]:this[_0x59811c(0x158)],[constants_1['FLOSUM_NAMESPACE']+_0x59811c(0x10a)]:this['_metadataLogId'],[constants_1[_0x59811c(0x12d)]+_0x59811c(0x18c)]:_0xca5282[_0x59811c(0xf4)]};});}async[a402_0x7c620e(0xf9)](_0x2331fc){const _0x1ebe2e=a402_0x7c620e;this[_0x1ebe2e(0x184)][_0x1ebe2e(0x11d)](_0x1ebe2e(0xfa));const _0xb84c9a=await this['_salesforceService'][_0x1ebe2e(0x172)](constants_1['FLOSUM_NAMESPACE']+_0x1ebe2e(0x109),_0x2331fc),_0x615606=_0xb84c9a[_0x1ebe2e(0x173)](_0xa12fbb=>!_0xa12fbb[_0x1ebe2e(0x17e)])['map'](_0x131e24=>_0x131e24[_0x1ebe2e(0x164)])[_0x1ebe2e(0x12f)]();if(_0x615606[_0x1ebe2e(0x134)])throw new salesforce_dml_error_1[(_0x1ebe2e(0x11f))](_0x615606);}async[a402_0x7c620e(0x106)](_0x2ca79d){const _0x2c4295=a402_0x7c620e;this['_logger'][_0x2c4295(0x120)](_0x2ca79d),await this['_logger']['updateLog'](),await this[_0x2c4295(0xf6)](![],!![],'');}async[a402_0x7c620e(0xf6)](_0x58d6f9,_0x3b6466,_0x37cda9){const _0x53a7d9=a402_0x7c620e,_0x5a4ad8=_0x53a7d9(0x111)+this[_0x53a7d9(0xf7)]+'/'+this[_0x53a7d9(0x171)]+'\x20>\x20'+_0x53a7d9(0x105)+_0x53a7d9(0x10f),_0x1ef952=_0x53a7d9(0x111)+this[_0x53a7d9(0xf7)]+'/'+this[_0x53a7d9(0x158)]+'\x20>'+this[_0x53a7d9(0x154)]+_0x53a7d9(0x118),_0x42f423=_0x5a4ad8+_0x53a7d9(0x16e)+_0x1ef952+_0x53a7d9(0x16d),_0x54af70={[constants_1[_0x53a7d9(0x12d)]+_0x53a7d9(0x14c)]:_0x42f423,[constants_1[_0x53a7d9(0x12d)]+'Date__c']:new Date(),[constants_1[_0x53a7d9(0x12d)]+_0x53a7d9(0x191)]:this[_0x53a7d9(0x150)],[constants_1[_0x53a7d9(0x12d)]+_0x53a7d9(0x144)]:_0x53a7d9(0xf3),[constants_1['FLOSUM_NAMESPACE']+_0x53a7d9(0x116)]:_0x53a7d9(0x142),[constants_1[_0x53a7d9(0x12d)]+_0x53a7d9(0x11e)]:this[_0x53a7d9(0x158)]},_0x1693e1={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x58d6f9,[constants_1[_0x53a7d9(0x12d)]+'Succeed__c']:_0x58d6f9,[constants_1[_0x53a7d9(0x12d)]+_0x53a7d9(0x138)]:_0x3b6466?status_enums_1[_0x53a7d9(0x148)][_0x53a7d9(0xff)]:status_enums_1[_0x53a7d9(0x148)][_0x53a7d9(0x18b)],[constants_1[_0x53a7d9(0x12d)]+'Job_Completed__c']:!![],[constants_1[_0x53a7d9(0x12d)]+_0x53a7d9(0x135)]:_0x37cda9};await this[_0x53a7d9(0x124)][_0x53a7d9(0x186)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x53a7d9(0x12d)]+_0x53a7d9(0x174)+this['_metadataLogId'],_0x1693e1),await this[_0x53a7d9(0x124)][_0x53a7d9(0x125)](flosum_constants_1[_0x53a7d9(0x16c)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x53a7d9(0x12d)]+'Log__c',_0x54af70),this['_logger']['log'](_0x53a7d9(0x13a)+(_0x58d6f9?_0x53a7d9(0x17b):'with\x20error')+'.'),await this['_logger'][_0x53a7d9(0x137)]();}}exports[a402_0x7c620e(0x17a)]=DeployService;