const a374_0x52c79d=a374_0x1c90;(function(_0x2c4eea,_0x2e0409){const _0x497403=a374_0x1c90,_0x167e58=_0x2c4eea();while(!![]){try{const _0x1a4797=-parseInt(_0x497403(0x1e7))/0x1*(-parseInt(_0x497403(0x213))/0x2)+-parseInt(_0x497403(0x19f))/0x3+-parseInt(_0x497403(0x176))/0x4*(parseInt(_0x497403(0x1e8))/0x5)+parseInt(_0x497403(0x1b6))/0x6*(parseInt(_0x497403(0x184))/0x7)+parseInt(_0x497403(0x1a2))/0x8*(-parseInt(_0x497403(0x1e0))/0x9)+parseInt(_0x497403(0x1cd))/0xa+parseInt(_0x497403(0x212))/0xb;if(_0x1a4797===_0x2e0409)break;else _0x167e58['push'](_0x167e58['shift']());}catch(_0x1fdce9){_0x167e58['push'](_0x167e58['shift']());}}}(a374_0x3be6,0x77367));const a374_0x5b2bb0=(function(){let _0x438866=!![];return function(_0x13caf1,_0xedaa11){const _0x23ea3d=_0x438866?function(){const _0x265862=a374_0x1c90;if(_0xedaa11){const _0xc2ffe3=_0xedaa11[_0x265862(0x1f2)](_0x13caf1,arguments);return _0xedaa11=null,_0xc2ffe3;}}:function(){};return _0x438866=![],_0x23ea3d;};}()),a374_0x35ce22=a374_0x5b2bb0(this,function(){const _0x479917=a374_0x1c90;return a374_0x35ce22[_0x479917(0x197)]()[_0x479917(0x18c)](_0x479917(0x1ea))[_0x479917(0x197)]()['constructor'](a374_0x35ce22)[_0x479917(0x18c)](_0x479917(0x1ea));});a374_0x35ce22();'use strict';var __importDefault=this&&this[a374_0x52c79d(0x1c4)]||function(_0x376e50){const _0x4266fa=a374_0x52c79d;return _0x376e50&&_0x376e50[_0x4266fa(0x1af)]?_0x376e50:{'default':_0x376e50};};function a374_0x1c90(_0x36d280,_0x29f06e){const _0x5b52d5=a374_0x3be6();return a374_0x1c90=function(_0x35ce22,_0x5b2bb0){_0x35ce22=_0x35ce22-0x173;let _0x3be68b=_0x5b52d5[_0x35ce22];return _0x3be68b;},a374_0x1c90(_0x36d280,_0x29f06e);}Object[a374_0x52c79d(0x1b3)](exports,'__esModule',{'value':!![]}),exports[a374_0x52c79d(0x1e5)]=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a374_0x52c79d(0x180)),constants_1=require(a374_0x52c79d(0x1c9)),flosum_constants_1=require(a374_0x52c79d(0x193)),veeva_service_1=require(a374_0x52c79d(0x17e)),salesforce_service_1=require('./salesforce.service'),core_1=require('../../../core'),status_enums_1=require(a374_0x52c79d(0x18d)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a374_0x52c79d(0x175))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a374_0x52c79d(0x1c1)),branch_component_history_flosum_component_retriever_1=require(a374_0x52c79d(0x1c3)),flosum_component_veeva_component_retriever_1=require(a374_0x52c79d(0x19a)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a374_0x52c79d(0x1c5)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x3f680d,_0x303d72,_0xc0d6af,_0x1965fd,_0x2440fd,_0x2c7317){const _0x25f3aa=a374_0x52c79d;this['_connectionSalesforce']=_0x303d72,this['_connectionVeeva']=_0xc0d6af,this[_0x25f3aa(0x1d5)]=_0x1965fd,this[_0x25f3aa(0x1d8)]=_0x2440fd,this[_0x25f3aa(0x17a)]=_0x2c7317,this[_0x25f3aa(0x189)]=_0x3f680d[_0x25f3aa(0x20c)],this['_metadataLogId']=_0x3f680d[_0x25f3aa(0x1f9)],this['_attachmentLogId']=_0x3f680d[_0x25f3aa(0x1b0)],this['_organisationId']=_0x3f680d['organisationId'],this[_0x25f3aa(0x178)]=_0x3f680d[_0x25f3aa(0x1df)],this[_0x25f3aa(0x1d7)]=_0x3f680d[_0x25f3aa(0x188)],this['_componentIdList']=_0x3f680d['componentIdList'],this[_0x25f3aa(0x1bf)]=_0x3f680d[_0x25f3aa(0x205)],this[_0x25f3aa(0x1c8)]=new core_1[(_0x25f3aa(0x1c0))](_0x25f3aa(0x1e2)),this[_0x25f3aa(0x20d)]=new veeva_service_1[(_0x25f3aa(0x186))]({'connection':this[_0x25f3aa(0x19b)],'logger':this[_0x25f3aa(0x1d5)]}),this['_salesforceService']=new salesforce_service_1[(_0x25f3aa(0x1dc))]({'connection':this['_connectionSalesforce']}),this[_0x25f3aa(0x1f1)]=new package_import_service_1[(_0x25f3aa(0x1a4))]({'veevaService':this[_0x25f3aa(0x20d)],'connection':this[_0x25f3aa(0x19b)],'logger':this[_0x25f3aa(0x1d5)],'saveLog':this[_0x25f3aa(0x1be)][_0x25f3aa(0x1d2)](this)}),this[_0x25f3aa(0x1a6)]=new package_export_service_1[(_0x25f3aa(0x1ce))]({'veevaService':this[_0x25f3aa(0x20d)],'connection':this[_0x25f3aa(0x19b)],'logger':this[_0x25f3aa(0x1d5)]}),this[_0x25f3aa(0x1b5)]=new vpk_service_1['VpkService']({'connection':this[_0x25f3aa(0x19b)]});}async[a374_0x52c79d(0x1bb)](){const _0x5551e1=a374_0x52c79d;try{const _0x5443f9=await this[_0x5551e1(0x1c6)]();await this[_0x5551e1(0x1d5)]['updateLog']();const _0x4023ec=await this['createBackup'](_0x5443f9);await this[_0x5551e1(0x1db)](_0x4023ec);const _0x2b7d9e=await this[_0x5551e1(0x19c)](_0x5443f9),_0x4a3cc8=await this[_0x5551e1(0x1e1)](_0x2b7d9e),_0x292c2b=await this[_0x5551e1(0x19e)](_0x4a3cc8);await this[_0x5551e1(0x1d5)][_0x5551e1(0x1a9)]();const _0x5cbc85=await this[_0x5551e1(0x1f1)][_0x5551e1(0x206)](_0x292c2b);await this['_logger']['updateLog']();const _0x1733f1=this[_0x5551e1(0x1ef)](_0x5443f9,_0x5cbc85[_0x5551e1(0x1dd)]);await this['saveDeploymentResults'](_0x1733f1),await this[_0x5551e1(0x1a0)](_0x5cbc85[_0x5551e1(0x1cc)],![],_0x5cbc85[_0x5551e1(0x1b4)]);}catch(_0x11b8be){await this[_0x5551e1(0x20a)](_0x11b8be)[_0x5551e1(0x187)](_0x32ea00=>this['_systemLogger'][_0x5551e1(0x18b)](_0x32ea00));}}async[a374_0x52c79d(0x1c6)](){const _0x4344c2=a374_0x52c79d,_0x4e53f1=new Set(this[_0x4344c2(0x1d9)]);this[_0x4344c2(0x1d5)][_0x4344c2(0x1e6)](_0x4344c2(0x1f4));const _0x2c5b5a=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x4344c2(0x189)],'salesforceService':this[_0x4344c2(0x1bc)]})['retrieve'](),_0x1fe01e=_0x2c5b5a[_0x4344c2(0x1b1)](_0x4071a8=>_0x4e53f1['has'](_0x4071a8['id']));if(_0x1fe01e['length']!==this[_0x4344c2(0x1d9)]['length'])throw new Error(_0x4344c2(0x182));return _0x1fe01e;}async['createBackup'](_0x45f295){const _0x49ff29=a374_0x52c79d;var _0x36e52f;this[_0x49ff29(0x1d5)][_0x49ff29(0x1e6)](_0x49ff29(0x1d3));const _0x23e766=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x45f295,'veevaService':this[_0x49ff29(0x20d)],'logger':this[_0x49ff29(0x1d5)]})[_0x49ff29(0x1a1)](),_0xdd2d3c=await this[_0x49ff29(0x1a6)][_0x49ff29(0x191)](_0x23e766,_0x49ff29(0x174));if(_0xdd2d3c[_0x49ff29(0x194)]>0x1)throw new Error(_0x49ff29(0x1e3));return(_0x36e52f=_0xdd2d3c[0x0])!==null&&_0x36e52f!==void 0x0?_0x36e52f:_0xdd2d3c[0x0]=new jszip_1['default'](),_0xdd2d3c[0x0][_0x49ff29(0x1a3)]({'type':_0x49ff29(0x17c)});}async['saveBackup'](_0x4743b6){const _0x30959e=a374_0x52c79d;this[_0x30959e(0x1d5)][_0x30959e(0x1e6)](_0x30959e(0x18a));const _0x1ef79c={'Body':_0x4743b6,'ContentType':'application/zip','ParentId':this[_0x30959e(0x1ed)],'Name':flosum_constants_1[_0x30959e(0x17d)][_0x30959e(0x1fa)]};await this[_0x30959e(0x1f3)][_0x30959e(0x195)](flosum_constants_1['FlosumConstants'][_0x30959e(0x192)]+_0x30959e(0x1ff),_0x1ef79c);}async[a374_0x52c79d(0x19c)](_0x267e5c){const _0x43f126=a374_0x52c79d;this[_0x43f126(0x1d5)][_0x43f126(0x1e6)](_0x43f126(0x185));const _0xd8521=await(0x0,fetch_attachments_1[_0x43f126(0x211)])(this[_0x43f126(0x1f3)],_0x267e5c[_0x43f126(0x1e4)](_0x3d5038=>_0x3d5038[_0x43f126(0x1d4)])),_0x16d537=await(0x0,fetch_attachments_1[_0x43f126(0x19c)])(_0xd8521,this[_0x43f126(0x1f3)]);if(_0x16d537[_0x43f126(0x194)]!==this[_0x43f126(0x1d9)][_0x43f126(0x194)])throw new Error(_0x43f126(0x196));return _0x16d537[_0x43f126(0x1e4)](_0x3f382e=>_0x3f382e[_0x43f126(0x1a5)][_0x43f126(0x181)]);}async['createZip'](_0x374ec1){const _0x3d2682=a374_0x52c79d;this[_0x3d2682(0x1d5)][_0x3d2682(0x1e6)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x2d8f31=await new zip_creator_deploy_1[(_0x3d2682(0x1a8))]({'attachmentBodies':_0x374ec1,'deploymentName':this[_0x3d2682(0x1bf)]})['execute'](),_0x5043c8=this[_0x3d2682(0x1d8)]+'/'+(0x0,shortid_1[_0x3d2682(0x1d0)])()+_0x3d2682(0x1ae);return await(0x0,promises_1[_0x3d2682(0x1ee)])(_0x5043c8,_0x2d8f31),_0x5043c8;}async[a374_0x52c79d(0x19e)](_0x4087aa){const _0x306c5b=a374_0x52c79d;this[_0x306c5b(0x1d5)][_0x306c5b(0x1e6)](_0x306c5b(0x20b));const _0x40abaf=await this[_0x306c5b(0x1b5)]['generate'](_0x4087aa),_0x26c1bf=this[_0x306c5b(0x1d8)]+_0x306c5b(0x198)+_0x4087aa[_0x306c5b(0x202)](_0x4087aa[_0x306c5b(0x1ac)]('/')+0x1);return await(0x0,promises_1[_0x306c5b(0x1ee)])(_0x26c1bf,_0x40abaf),await this[_0x306c5b(0x1b5)][_0x306c5b(0x1f0)](_0x26c1bf),_0x26c1bf;}async[a374_0x52c79d(0x1be)](_0x5a5c95,_0x3701b4){const _0x5ea89e=a374_0x52c79d;this[_0x5ea89e(0x1d5)][_0x5ea89e(0x1e6)]('Save\x20log');const _0xa55235={'Body':Buffer[_0x5ea89e(0x1e9)](_0x5a5c95)[_0x5ea89e(0x197)](_0x5ea89e(0x17c)),'ContentType':'text/plain','ParentId':this[_0x5ea89e(0x1ed)],'Name':_0x3701b4};await this['_connectionSalesforce'][_0x5ea89e(0x195)](flosum_constants_1[_0x5ea89e(0x17d)]['ENDPOINT_UPSERT_RECORD']+_0x5ea89e(0x1ff),_0xa55235);}['formFlosumDeploymentResults'](_0x125dbe,_0x316e8d){const _0x415491=a374_0x52c79d;this[_0x415491(0x1d5)][_0x415491(0x1e6)](_0x415491(0x1fc));const _0x3c2c26=_0x125dbe['reduce']((_0x471cbd,_0x4d2c73)=>_0x471cbd[_0x415491(0x1f8)]((_0x4d2c73[_0x415491(0x183)]+'.'+_0x4d2c73[_0x415491(0x1de)])['toLowerCase'](),_0x4d2c73),new Map());return _0x316e8d[_0x415491(0x1e4)](_0x21e874=>{const _0x375047=_0x415491;this[_0x375047(0x1d5)][_0x375047(0x1e6)](_0x21e874[_0x375047(0x208)]+'.'+_0x21e874[_0x375047(0x203)]+'\x20:\x20'+_0x21e874[_0x375047(0x210)]);const _0xeb58ac=(_0x21e874[_0x375047(0x208)]+'.'+_0x21e874['name'])[_0x375047(0x1aa)](),_0x1cc978=_0x3c2c26[_0x375047(0x20f)](_0xeb58ac);return{[constants_1[_0x375047(0x1b8)]+_0x375047(0x209)]:'Deployment\x20Result',[constants_1[_0x375047(0x1b8)]+_0x375047(0x1fb)]:_0x21e874[_0x375047(0x210)]===status_enums_1[_0x375047(0x1b9)][_0x375047(0x17b)]?_0x375047(0x1cf):_0x375047(0x1b2),[constants_1[_0x375047(0x1b8)]+'Result__c']:_0x21e874[_0x375047(0x1f7)],[constants_1[_0x375047(0x1b8)]+_0x375047(0x179)]:_0x21e874['name'],[constants_1[_0x375047(0x1b8)]+_0x375047(0x214)]:_0x21e874[_0x375047(0x208)],[constants_1['FLOSUM_NAMESPACE']+_0x375047(0x19d)]:_0x21e874['stepName'],[constants_1[_0x375047(0x1b8)]+'Org__c']:this['_organisationId'],[constants_1[_0x375047(0x1b8)]+_0x375047(0x1c2)]:this[_0x375047(0x1ed)],[constants_1[_0x375047(0x1b8)]+_0x375047(0x1f5)]:_0x1cc978[_0x375047(0x1d4)]};});}async['saveDeploymentResults'](_0x3a21f7){const _0x19f87b=a374_0x52c79d;this[_0x19f87b(0x1d5)][_0x19f87b(0x1e6)](_0x19f87b(0x200));const _0x1d7657=await this[_0x19f87b(0x1bc)][_0x19f87b(0x190)](constants_1['FLOSUM_NAMESPACE']+_0x19f87b(0x1ab),_0x3a21f7),_0xcf7e31=_0x1d7657[_0x19f87b(0x1b1)](_0xe41c52=>!_0xe41c52[_0x19f87b(0x1fe)])[_0x19f87b(0x1e4)](_0x18da5c=>_0x18da5c['errors'])[_0x19f87b(0x201)]();if(_0xcf7e31[_0x19f87b(0x194)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0xcf7e31);}async['finishDeployWithError'](_0x35e764){const _0x2d8e45=a374_0x52c79d;this[_0x2d8e45(0x1d5)][_0x2d8e45(0x20e)](_0x35e764),await this['_logger'][_0x2d8e45(0x1a9)](),await this[_0x2d8e45(0x1a0)](![],!![],'');}async['finishDeploy'](_0x53b3db,_0x31e563,_0x496e24){const _0x2f7eed=a374_0x52c79d,_0x525982='<a\x20href='+this[_0x2f7eed(0x17a)]+'/'+this['_metadataLogId']+_0x2f7eed(0x1fd)+_0x2f7eed(0x177)+'\x20</a>',_0x2dfb1b='<a\x20href='+this[_0x2f7eed(0x17a)]+'/'+this[_0x2f7eed(0x207)]+'\x20>'+this[_0x2f7eed(0x1d7)]+'</a>',_0x2e7c06=_0x525982+_0x2f7eed(0x173)+_0x2dfb1b+_0x2f7eed(0x1f6),_0x4ad318={[constants_1['FLOSUM_NAMESPACE']+_0x2f7eed(0x1bd)]:_0x2e7c06,[constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x199)]:new Date(),[constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x18e)]:this[_0x2f7eed(0x189)],[constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x18f)]:_0x2f7eed(0x1ec),[constants_1[_0x2f7eed(0x1b8)]+'Activity_Type__c']:_0x2f7eed(0x1ca),[constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x1da)]:this[_0x2f7eed(0x207)]},_0x431e17={[constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x1ba)]:!_0x53b3db,[constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x1ad)]:_0x53b3db,[constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x1fb)]:_0x31e563?status_enums_1[_0x2f7eed(0x1b7)][_0x2f7eed(0x1a7)]:status_enums_1[_0x2f7eed(0x1b7)]['COMPLETED'],[constants_1['FLOSUM_NAMESPACE']+_0x2f7eed(0x1d6)]:!![],[constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x204)]:_0x496e24};await this['_connectionSalesforce'][_0x2f7eed(0x1c7)](flosum_constants_1[_0x2f7eed(0x17d)][_0x2f7eed(0x192)]+'/'+constants_1[_0x2f7eed(0x1b8)]+'Metadata_Log__c/'+this[_0x2f7eed(0x1ed)],_0x431e17),await this['_connectionSalesforce']['post'](flosum_constants_1[_0x2f7eed(0x17d)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x2f7eed(0x1b8)]+_0x2f7eed(0x1cb),_0x4ad318),this[_0x2f7eed(0x1d5)][_0x2f7eed(0x1e6)](_0x2f7eed(0x17f)+(_0x53b3db?_0x2f7eed(0x1d1):_0x2f7eed(0x1eb))+'.'),await this[_0x2f7eed(0x1d5)][_0x2f7eed(0x1a9)]();}}function a374_0x3be6(){const _0x2392eb=['finishDeploy','retrieve','152GmLhVO','generateAsync','PackageImportService','values','_packageExportService','EXCEPTION','ZipCreatorDeploy','updateLog','toLowerCase','Deployment_Result__c','lastIndexOf','Succeed__c','.zip','__esModule','attachmentLogId','filter','Failure','defineProperty','packageId','_vpkService','108LXcurh','MetadataLogStatus','FLOSUM_NAMESPACE','PackageComponentStatus','Is_Error__c','execute','_salesforceService','Action__c','saveLog','_deploymentName','Logger','./package-import.service','Metadata_Log__c','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','__importDefault','./vpk.service','getFlosumComponents','patch','_systemLogger','../../../constants','Deployment','Log__c','isDeployed','5745850CFdZGk','PackageExportService','Success','default','successfully','bind','Create\x20Backup','componentHistoryId','_logger','Job_Completed__c','_organisationName','_tempFolder','_componentIdList','TargetId__c','saveBackup','SalesforceService','packageComponentList','componentName','timeZone','326763IMWWib','createZip','veeva-deploy','Cannot\x20Backup\x20more\x20than\x20200\x20components.','map','DeployService','log','116jdSXWJ','5nlqyVr','from','(((.+)+)+)+$','with\x20error','Branch','_metadataLogId','writeFile','formFlosumDeploymentResults','validate','_packageImportService','apply','_connectionSalesforce','Retrieving\x20components','Component_History__c','\x20has\x20been\x20created.','deploymentAction','set','metadataLogId','BACKUP_ZIP_NAME','Status__c','Form\x20Deployment\x20Results','\x20>\x20','success','/Attachment','Save\x20Deployment\x20Results','flat','slice','name','External_Deployment_Id__c','deploymentName','import','_organisationId','type','Type__c','finishDeployWithError','Create\x20vpk\x20package','branchId','_veevaService','logError','get','status','fetchAttachmentsDetailsByParentId','2638922aKPwlT','7736bntgrM','Component_Type__c','\x20of\x20branch\x20to\x20Organization\x20','Backup','shortid','1767076ItzWvM','Veeva\x20Deployment','_timeZone','Component_Name__c','_instanceUrl','DEPLOYED','base64','FlosumConstants','./veeva.service','Deploy\x20completed\x20','fs/promises','Body','Cannot\x20retrieve\x20all\x20components.','componentType','310842yxFhyB','Retrieving\x20attachments','VeevaService','catch','organisationName','_branchId','Save\x20Backup\x20to\x20Salesforce','error','search','../enums/status.enums','Branch__c','Activity_Item__c','insertMultipleRecords','export','ENDPOINT_UPSERT_RECORD','../constants/flosum.constants','length','post','Cannot\x20retrievers\x20all\x20attachments','toString','/vpk__','Date__c','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','_connectionVeeva','retrieveAttachments','Veeva_Step_Name__c','createVpk','1327758fijTBJ'];a374_0x3be6=function(){return _0x2392eb;};return a374_0x3be6();}exports[a374_0x52c79d(0x1e5)]=DeployService;