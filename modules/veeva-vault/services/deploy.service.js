const a402_0x20140d=a402_0x1cef;(function(_0x109f88,_0x5476bd){const _0x142e0f=a402_0x1cef,_0x5d9323=_0x109f88();while(!![]){try{const _0x5b14c8=-parseInt(_0x142e0f(0x205))/0x1*(-parseInt(_0x142e0f(0x197))/0x2)+-parseInt(_0x142e0f(0x1c2))/0x3+-parseInt(_0x142e0f(0x202))/0x4*(parseInt(_0x142e0f(0x1aa))/0x5)+-parseInt(_0x142e0f(0x192))/0x6*(parseInt(_0x142e0f(0x164))/0x7)+parseInt(_0x142e0f(0x1eb))/0x8*(-parseInt(_0x142e0f(0x1a0))/0x9)+-parseInt(_0x142e0f(0x1e6))/0xa+parseInt(_0x142e0f(0x169))/0xb;if(_0x5b14c8===_0x5476bd)break;else _0x5d9323['push'](_0x5d9323['shift']());}catch(_0x194553){_0x5d9323['push'](_0x5d9323['shift']());}}}(a402_0x37b7,0xb1372));const a402_0x4f7de0=(function(){let _0x4b88bf=!![];return function(_0x464e40,_0x3f5341){const _0x4146ab=_0x4b88bf?function(){const _0x3a79e0=a402_0x1cef;if(_0x3f5341){const _0x538fe3=_0x3f5341[_0x3a79e0(0x188)](_0x464e40,arguments);return _0x3f5341=null,_0x538fe3;}}:function(){};return _0x4b88bf=![],_0x4146ab;};}()),a402_0x4c0061=a402_0x4f7de0(this,function(){const _0x123508=a402_0x1cef;return a402_0x4c0061[_0x123508(0x204)]()[_0x123508(0x16c)](_0x123508(0x1a9))[_0x123508(0x204)]()['constructor'](a402_0x4c0061)['search'](_0x123508(0x1a9));});a402_0x4c0061();'use strict';var __importDefault=this&&this[a402_0x20140d(0x180)]||function(_0x136c94){const _0x413112=a402_0x20140d;return _0x136c94&&_0x136c94[_0x413112(0x1ca)]?_0x136c94:{'default':_0x136c94};};Object[a402_0x20140d(0x1a2)](exports,'__esModule',{'value':!![]}),exports[a402_0x20140d(0x1bb)]=void 0x0;const jszip_1=__importDefault(require(a402_0x20140d(0x1fc))),promises_1=require(a402_0x20140d(0x1ec)),constants_1=require(a402_0x20140d(0x1c5)),flosum_constants_1=require(a402_0x20140d(0x160)),veeva_service_1=require(a402_0x20140d(0x1a8)),salesforce_service_1=require(a402_0x20140d(0x186)),core_1=require(a402_0x20140d(0x1df)),status_enums_1=require(a402_0x20140d(0x177)),salesforce_dml_error_1=require(a402_0x20140d(0x171)),shortid_1=__importDefault(require(a402_0x20140d(0x1b8))),fetch_attachments_1=require(a402_0x20140d(0x1ea)),package_import_service_1=require(a402_0x20140d(0x1fd)),branch_component_history_flosum_component_retriever_1=require(a402_0x20140d(0x1d8)),flosum_component_veeva_component_retriever_1=require(a402_0x20140d(0x1f2)),package_export_service_1=require(a402_0x20140d(0x179)),vpk_service_1=require(a402_0x20140d(0x18c)),zip_creator_deploy_1=require(a402_0x20140d(0x1d5));class DeployService{constructor(_0x3ceed7,_0x27d59d,_0x391f4d,_0x443c2f,_0x56d53d,_0x1cff38){const _0x3a1eaa=a402_0x20140d;this[_0x3a1eaa(0x1cb)]=_0x27d59d,this[_0x3a1eaa(0x15f)]=_0x391f4d,this[_0x3a1eaa(0x1b2)]=_0x443c2f,this['_tempFolder']=_0x56d53d,this[_0x3a1eaa(0x1b1)]=_0x1cff38,this[_0x3a1eaa(0x1af)]=_0x3ceed7['branchId'],this[_0x3a1eaa(0x1e0)]=_0x3ceed7[_0x3a1eaa(0x1ac)],this[_0x3a1eaa(0x1cf)]=_0x3ceed7[_0x3a1eaa(0x1e7)],this[_0x3a1eaa(0x162)]=_0x3ceed7['organisationId'],this[_0x3a1eaa(0x1d7)]=_0x3ceed7[_0x3a1eaa(0x167)],this['_organisationName']=_0x3ceed7['organisationName'],this[_0x3a1eaa(0x1c6)]=_0x3ceed7[_0x3a1eaa(0x1f1)],this[_0x3a1eaa(0x16e)]=_0x3ceed7[_0x3a1eaa(0x1ed)],this[_0x3a1eaa(0x1c1)]=new core_1[(_0x3a1eaa(0x1b9))](_0x3a1eaa(0x19c)),this[_0x3a1eaa(0x1ef)]=new veeva_service_1[(_0x3a1eaa(0x1fe))]({'connection':this['_connectionVeeva'],'logger':this[_0x3a1eaa(0x1b2)]}),this[_0x3a1eaa(0x1f7)]=new salesforce_service_1['SalesforceService']({'connection':this['_connectionSalesforce']}),this[_0x3a1eaa(0x1c7)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x3a1eaa(0x1ef)],'connection':this[_0x3a1eaa(0x15f)],'logger':this[_0x3a1eaa(0x1b2)],'saveLog':this[_0x3a1eaa(0x1f3)]['bind'](this)}),this[_0x3a1eaa(0x170)]=new package_export_service_1[(_0x3a1eaa(0x18d))]({'veevaService':this['_veevaService'],'connection':this[_0x3a1eaa(0x15f)],'logger':this['_logger']}),this['_vpkService']=new vpk_service_1[(_0x3a1eaa(0x1ae))]({'connection':this['_connectionVeeva']});}async['execute'](){const _0x26015b=a402_0x20140d;try{const _0x43f792=await this['getFlosumComponents']();await this[_0x26015b(0x1b2)][_0x26015b(0x1e5)]();const _0x4ed94e=await this[_0x26015b(0x165)](_0x43f792);await this[_0x26015b(0x1b0)](_0x4ed94e);const _0x28f3dd=await this[_0x26015b(0x191)](_0x43f792),_0x263ef6=await this[_0x26015b(0x16a)](_0x28f3dd),_0x3f861c=await this[_0x26015b(0x203)](_0x263ef6);await this['_logger'][_0x26015b(0x1e5)]();const _0x2d9c05=await this[_0x26015b(0x1c7)][_0x26015b(0x190)](_0x3f861c);await this[_0x26015b(0x1b2)][_0x26015b(0x1e5)]();const _0x2362fd=this['formFlosumDeploymentResults'](_0x43f792,_0x2d9c05[_0x26015b(0x18a)]);await this['saveDeploymentResults'](_0x2362fd),await this[_0x26015b(0x178)](_0x2d9c05[_0x26015b(0x17b)],![],_0x2d9c05[_0x26015b(0x1f6)]);}catch(_0x364f2e){await this[_0x26015b(0x181)](_0x364f2e)[_0x26015b(0x18e)](_0x4e44bb=>this['_systemLogger'][_0x26015b(0x1f5)](_0x4e44bb));}}async[a402_0x20140d(0x1f8)](){const _0x147fea=a402_0x20140d,_0x3b6700=new Set(this[_0x147fea(0x1c6)]);this[_0x147fea(0x1b2)][_0x147fea(0x1ce)](_0x147fea(0x174));const _0xfcf057=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x147fea(0x1af)],'salesforceService':this[_0x147fea(0x1f7)]})['retrieve'](),_0x18f14a=_0xfcf057[_0x147fea(0x199)](_0x53d53d=>_0x3b6700[_0x147fea(0x18f)](_0x53d53d['id']));if(_0x18f14a[_0x147fea(0x1a3)]!==this[_0x147fea(0x1c6)][_0x147fea(0x1a3)])throw new Error(_0x147fea(0x1a6));return _0x18f14a;}async['createBackup'](_0x86fa22){const _0x52abc9=a402_0x20140d;var _0x1ce70f;this['_logger'][_0x52abc9(0x1ce)]('Create\x20Backup');const _0x1e22aa=await new flosum_component_veeva_component_retriever_1[(_0x52abc9(0x201))]({'value':_0x86fa22,'veevaService':this[_0x52abc9(0x1ef)],'logger':this['_logger']})[_0x52abc9(0x1c3)](),_0x442e64=await this[_0x52abc9(0x170)][_0x52abc9(0x1d3)](_0x1e22aa,_0x52abc9(0x1bc));if(_0x442e64[_0x52abc9(0x1a3)]>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x1ce70f=_0x442e64[0x0])!==null&&_0x1ce70f!==void 0x0?_0x1ce70f:_0x442e64[0x0]=new jszip_1[(_0x52abc9(0x1a1))](),_0x442e64[0x0]['generateAsync']({'type':_0x52abc9(0x182)});}async[a402_0x20140d(0x1b0)](_0xc17a78){const _0x873ad=a402_0x20140d;this[_0x873ad(0x1b2)][_0x873ad(0x1ce)](_0x873ad(0x1f9));const _0x4e38e6={'Body':_0xc17a78,'ContentType':_0x873ad(0x1ee),'ParentId':this[_0x873ad(0x1e0)],'Name':flosum_constants_1['FlosumConstants'][_0x873ad(0x1de)]};await this[_0x873ad(0x1cb)][_0x873ad(0x176)](flosum_constants_1[_0x873ad(0x1e4)]['ENDPOINT_UPSERT_RECORD']+_0x873ad(0x1f0),_0x4e38e6);}async[a402_0x20140d(0x191)](_0x57c402){const _0x6cca93=a402_0x20140d;this['_logger'][_0x6cca93(0x1ce)]('Retrieving\x20attachments');const _0xb333fc=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x6cca93(0x1cb)],_0x57c402[_0x6cca93(0x19b)](_0x4cabba=>_0x4cabba['componentHistoryId'])),_0x49e9e4=await(0x0,fetch_attachments_1[_0x6cca93(0x191)])(_0xb333fc,this[_0x6cca93(0x1cb)]);if(_0x49e9e4[_0x6cca93(0x1a3)]!==this[_0x6cca93(0x1c6)][_0x6cca93(0x1a3)])throw new Error(_0x6cca93(0x168));return _0x49e9e4[_0x6cca93(0x19b)](_0x164ded=>_0x164ded['values'][_0x6cca93(0x1b7)]);}async[a402_0x20140d(0x16a)](_0x87a8dc){const _0x16cbaf=a402_0x20140d;this[_0x16cbaf(0x1b2)][_0x16cbaf(0x1ce)](_0x16cbaf(0x198));const _0x3ce308=await new zip_creator_deploy_1[(_0x16cbaf(0x19a))]({'attachmentBodies':_0x87a8dc,'deploymentName':this[_0x16cbaf(0x16e)]})[_0x16cbaf(0x173)](),_0x5c2994=this[_0x16cbaf(0x193)]+'/'+(0x0,shortid_1[_0x16cbaf(0x1a1)])()+_0x16cbaf(0x1e8);return await(0x0,promises_1[_0x16cbaf(0x196)])(_0x5c2994,_0x3ce308),_0x5c2994;}async[a402_0x20140d(0x203)](_0x509b8f){const _0x1335d9=a402_0x20140d;this[_0x1335d9(0x1b2)][_0x1335d9(0x1ce)](_0x1335d9(0x1c0));const _0xc36727=await this[_0x1335d9(0x1db)][_0x1335d9(0x187)](_0x509b8f),_0x700fde=this[_0x1335d9(0x193)]+_0x1335d9(0x1d1)+_0x509b8f['slice'](_0x509b8f[_0x1335d9(0x194)]('/')+0x1);return await(0x0,promises_1[_0x1335d9(0x196)])(_0x700fde,_0xc36727),await this['_vpkService'][_0x1335d9(0x1dc)](_0x700fde),_0x700fde;}async[a402_0x20140d(0x1f3)](_0x5665db,_0x77396b){const _0x4a4f1b=a402_0x20140d;this[_0x4a4f1b(0x1b2)][_0x4a4f1b(0x1ce)](_0x4a4f1b(0x18b));const _0x299297={'Body':Buffer['from'](_0x5665db)[_0x4a4f1b(0x204)]('base64'),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x77396b};await this[_0x4a4f1b(0x1cb)]['post'](flosum_constants_1[_0x4a4f1b(0x1e4)]['ENDPOINT_UPSERT_RECORD']+_0x4a4f1b(0x1f0),_0x299297);}[a402_0x20140d(0x184)](_0x32b1f2,_0x2c7aa2){const _0x52c866=a402_0x20140d;this['_logger'][_0x52c866(0x1ce)](_0x52c866(0x1f4));const _0xd62067=_0x32b1f2[_0x52c866(0x1ff)]((_0x4873c6,_0x1cae02)=>_0x4873c6[_0x52c866(0x19e)]((_0x1cae02[_0x52c866(0x1e1)]+'.'+_0x1cae02[_0x52c866(0x195)])['toLowerCase'](),_0x1cae02),new Map());return _0x2c7aa2[_0x52c866(0x19b)](_0x18e9e2=>{const _0x119f87=_0x52c866;this[_0x119f87(0x1b2)][_0x119f87(0x1ce)](_0x18e9e2[_0x119f87(0x1e9)]+'.'+_0x18e9e2[_0x119f87(0x200)]+_0x119f87(0x1cc)+_0x18e9e2[_0x119f87(0x1bf)]);const _0x143200=(_0x18e9e2['type']+'.'+_0x18e9e2[_0x119f87(0x200)])[_0x119f87(0x1b5)](),_0x9bd84c=_0xd62067[_0x119f87(0x1b3)](_0x143200);return{[constants_1[_0x119f87(0x19f)]+_0x119f87(0x1e3)]:_0x119f87(0x1d9),[constants_1[_0x119f87(0x19f)]+_0x119f87(0x1bd)]:_0x18e9e2[_0x119f87(0x1bf)]===status_enums_1[_0x119f87(0x1da)]['DEPLOYED']?_0x119f87(0x166):'Failure',[constants_1[_0x119f87(0x19f)]+_0x119f87(0x1cd)]:_0x18e9e2[_0x119f87(0x1b4)],[constants_1[_0x119f87(0x19f)]+_0x119f87(0x17c)]:_0x18e9e2[_0x119f87(0x200)],[constants_1[_0x119f87(0x19f)]+_0x119f87(0x1d4)]:_0x18e9e2['type'],[constants_1[_0x119f87(0x19f)]+_0x119f87(0x1a7)]:_0x18e9e2[_0x119f87(0x1ad)],[constants_1[_0x119f87(0x19f)]+_0x119f87(0x17d)]:this['_organisationId'],[constants_1[_0x119f87(0x19f)]+'Metadata_Log__c']:this['_metadataLogId'],[constants_1[_0x119f87(0x19f)]+_0x119f87(0x16d)]:_0x9bd84c[_0x119f87(0x175)]};});}async[a402_0x20140d(0x19d)](_0x4b9be7){const _0x22456e=a402_0x20140d;this['_logger'][_0x22456e(0x1ce)](_0x22456e(0x1a4));const _0x2ae2ed=await this[_0x22456e(0x1f7)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x4b9be7),_0x2a1c28=_0x2ae2ed[_0x22456e(0x199)](_0x20b964=>!_0x20b964[_0x22456e(0x1be)])[_0x22456e(0x19b)](_0x5ad499=>_0x5ad499[_0x22456e(0x172)])[_0x22456e(0x1d6)]();if(_0x2a1c28['length'])throw new salesforce_dml_error_1[(_0x22456e(0x17a))](_0x2a1c28);}async[a402_0x20140d(0x181)](_0x429a1e){const _0x4cf2ac=a402_0x20140d;this[_0x4cf2ac(0x1b2)][_0x4cf2ac(0x1c4)](_0x429a1e),await this[_0x4cf2ac(0x1b2)][_0x4cf2ac(0x1e5)](),await this[_0x4cf2ac(0x178)](![],!![],'');}async[a402_0x20140d(0x178)](_0x3baa73,_0x4406e8,_0x3b8983){const _0x2b66a6=a402_0x20140d,_0x3bcfb1=_0x2b66a6(0x16f)+this[_0x2b66a6(0x1b1)]+'/'+this[_0x2b66a6(0x1e0)]+_0x2b66a6(0x1c8)+_0x2b66a6(0x185)+'\x20</a>',_0x2dcd82=_0x2b66a6(0x16f)+this['_instanceUrl']+'/'+this[_0x2b66a6(0x162)]+'\x20>'+this[_0x2b66a6(0x1a5)]+_0x2b66a6(0x1e2),_0x25cea0=_0x3bcfb1+_0x2b66a6(0x163)+_0x2dcd82+_0x2b66a6(0x183),_0x14aac5={[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x1d0)]:_0x25cea0,[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x1c9)]:new Date(),[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x1ab)]:this['_branchId'],[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x1fa)]:_0x2b66a6(0x17e),[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x1d2)]:'Deployment',[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:this[_0x2b66a6(0x162)]},_0x7016b6={[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x161)]:!_0x3baa73,[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x1b6)]:_0x3baa73,[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x1bd)]:_0x4406e8?status_enums_1[_0x2b66a6(0x17f)]['EXCEPTION']:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x2b66a6(0x19f)]+_0x2b66a6(0x1ba)]:!![],[constants_1['FLOSUM_NAMESPACE']+'External_Deployment_Id__c']:_0x3b8983};await this[_0x2b66a6(0x1cb)][_0x2b66a6(0x16b)](flosum_constants_1[_0x2b66a6(0x1e4)][_0x2b66a6(0x189)]+'/'+constants_1[_0x2b66a6(0x19f)]+'Metadata_Log__c/'+this[_0x2b66a6(0x1e0)],_0x7016b6),await this[_0x2b66a6(0x1cb)][_0x2b66a6(0x176)](flosum_constants_1[_0x2b66a6(0x1e4)][_0x2b66a6(0x189)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x2b66a6(0x1fb),_0x14aac5),this[_0x2b66a6(0x1b2)][_0x2b66a6(0x1ce)](_0x2b66a6(0x1dd)+(_0x3baa73?'successfully':'with\x20error')+'.'),await this[_0x2b66a6(0x1b2)][_0x2b66a6(0x1e5)]();}}exports[a402_0x20140d(0x1bb)]=DeployService;function a402_0x1cef(_0x2e43be,_0x456948){const _0x4a8dce=a402_0x37b7();return a402_0x1cef=function(_0x4c0061,_0x4f7de0){_0x4c0061=_0x4c0061-0x15f;let _0x37b7b5=_0x4a8dce[_0x4c0061];return _0x37b7b5;},a402_0x1cef(_0x2e43be,_0x456948);}function a402_0x37b7(){const _0xe685cc=['stepName','VpkService','_branchId','saveBackup','_instanceUrl','_logger','get','deploymentAction','toLowerCase','Succeed__c','Body','shortid','Logger','Job_Completed__c','DeployService','Backup','Status__c','success','status','Create\x20vpk\x20package','_systemLogger','1148745xPiDld','retrieve','logError','../../../constants','_componentIdList','_packageImportService','\x20>\x20','Date__c','__esModule','_connectionSalesforce','\x20:\x20','Result__c','log','_attachmentLogId','Action__c','/vpk__','Activity_Type__c','export','Component_Type__c','../classes/deploy/zip-creator.deploy','flat','_timeZone','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Deployment\x20Result','PackageComponentStatus','_vpkService','validate','Deploy\x20completed\x20','BACKUP_ZIP_NAME','../../../core','_metadataLogId','componentType','</a>','Type__c','FlosumConstants','updateLog','10466260gtUNql','attachmentLogId','.zip','type','../../shared/utils/fetch-attachments','56broqrP','fs/promises','deploymentName','application/zip','_veevaService','/Attachment','componentIdList','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','saveLog','Form\x20Deployment\x20Results','error','packageId','_salesforceService','getFlosumComponents','Save\x20Backup\x20to\x20Salesforce','Activity_Item__c','Log__c','jszip','./package-import.service','VeevaService','reduce','name','FlosumComponentVeevaComponentRetriever','4nXAuym','createVpk','toString','15393wqaPZu','_connectionVeeva','../constants/flosum.constants','Is_Error__c','_organisationId','\x20of\x20branch\x20to\x20Organization\x20','9609285PFwdBV','createBackup','Success','timeZone','Cannot\x20retrievers\x20all\x20attachments','46403687HQncPH','createZip','patch','search','Component_History__c','_deploymentName','<a\x20href=','_packageExportService','../classes/errors/salesforce-dml-error','errors','execute','Retrieving\x20components','componentHistoryId','post','../enums/status.enums','finishDeploy','./package-export.service','SalesforceDmlError','isDeployed','Component_Name__c','Org__c','Branch','MetadataLogStatus','__importDefault','finishDeployWithError','base64','\x20has\x20been\x20created.','formFlosumDeploymentResults','Veeva\x20Deployment','./salesforce.service','generate','apply','ENDPOINT_UPSERT_RECORD','packageComponentList','Save\x20log','./vpk.service','PackageExportService','catch','has','import','retrieveAttachments','6eXDCwz','_tempFolder','lastIndexOf','componentName','writeFile','92hQsgNs','Join\x20all\x20mdl\x20into\x20one\x20zip','filter','ZipCreatorDeploy','map','veeva-deploy','saveDeploymentResults','set','FLOSUM_NAMESPACE','1030203IqFLoc','default','defineProperty','length','Save\x20Deployment\x20Results','_organisationName','Cannot\x20retrieve\x20all\x20components.','Veeva_Step_Name__c','./veeva.service','(((.+)+)+)+$','2985780ShXvwS','Branch__c','metadataLogId'];a402_0x37b7=function(){return _0xe685cc;};return a402_0x37b7();}