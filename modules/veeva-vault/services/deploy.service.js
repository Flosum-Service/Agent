const a358_0x42ff90=a358_0x4a04;(function(_0x18b29b,_0x3d5833){const _0x49acee=a358_0x4a04,_0x114835=_0x18b29b();while(!![]){try{const _0x4dbb40=-parseInt(_0x49acee(0xdf))/0x1*(-parseInt(_0x49acee(0xdd))/0x2)+-parseInt(_0x49acee(0xe8))/0x3*(-parseInt(_0x49acee(0xa4))/0x4)+parseInt(_0x49acee(0x7f))/0x5+parseInt(_0x49acee(0xd7))/0x6+parseInt(_0x49acee(0x9a))/0x7*(parseInt(_0x49acee(0xcb))/0x8)+parseInt(_0x49acee(0xb4))/0x9*(parseInt(_0x49acee(0x92))/0xa)+-parseInt(_0x49acee(0xc9))/0xb;if(_0x4dbb40===_0x3d5833)break;else _0x114835['push'](_0x114835['shift']());}catch(_0x55dd57){_0x114835['push'](_0x114835['shift']());}}}(a358_0x215b,0x344a9));const a358_0x4971d0=(function(){let _0x41cb3e=!![];return function(_0x1a6ac0,_0x5b29ec){const _0x3bade9=_0x41cb3e?function(){const _0x3790fa=a358_0x4a04;if(_0x5b29ec){const _0x28d35c=_0x5b29ec[_0x3790fa(0x83)](_0x1a6ac0,arguments);return _0x5b29ec=null,_0x28d35c;}}:function(){};return _0x41cb3e=![],_0x3bade9;};}()),a358_0x2a76d3=a358_0x4971d0(this,function(){const _0x5824c6=a358_0x4a04;return a358_0x2a76d3[_0x5824c6(0xd5)]()['search'](_0x5824c6(0xad))[_0x5824c6(0xd5)]()[_0x5824c6(0xa9)](a358_0x2a76d3)[_0x5824c6(0xf5)](_0x5824c6(0xad));});a358_0x2a76d3();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x1864ec){const _0x185a59=a358_0x4a04;return _0x1864ec&&_0x1864ec[_0x185a59(0xae)]?_0x1864ec:{'default':_0x1864ec};};function a358_0x4a04(_0x1ef8a2,_0x399dd5){const _0x59bbf7=a358_0x215b();return a358_0x4a04=function(_0x2a76d3,_0x4971d0){_0x2a76d3=_0x2a76d3-0x64;let _0x215bfe=_0x59bbf7[_0x2a76d3];return _0x215bfe;},a358_0x4a04(_0x1ef8a2,_0x399dd5);}Object[a358_0x42ff90(0x88)](exports,a358_0x42ff90(0xae),{'value':!![]}),exports[a358_0x42ff90(0xb7)]=void 0x0;const jszip_1=__importDefault(require(a358_0x42ff90(0xb5))),promises_1=require(a358_0x42ff90(0x74)),constants_1=require(a358_0x42ff90(0x6f)),flosum_constants_1=require(a358_0x42ff90(0x66)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),core_1=require(a358_0x42ff90(0xf2)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a358_0x42ff90(0xbf)),shortid_1=__importDefault(require(a358_0x42ff90(0xde))),fetch_attachments_1=require(a358_0x42ff90(0xe6)),package_import_service_1=require(a358_0x42ff90(0xd4)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a358_0x42ff90(0xcc)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a358_0x42ff90(0x9f)),zip_creator_deploy_1=require(a358_0x42ff90(0xcf));class DeployService{constructor(_0x2bc916,_0x380692,_0x41eb44,_0x59d947,_0x5df01e,_0x4a61e4){const _0x6544b7=a358_0x42ff90;this[_0x6544b7(0xf0)]=_0x380692,this[_0x6544b7(0xca)]=_0x41eb44,this['_logger']=_0x59d947,this[_0x6544b7(0xa0)]=_0x5df01e,this[_0x6544b7(0x75)]=_0x4a61e4,this['_branchId']=_0x2bc916['branchId'],this['_metadataLogId']=_0x2bc916[_0x6544b7(0xc1)],this['_attachmentLogId']=_0x2bc916[_0x6544b7(0xe9)],this[_0x6544b7(0x8d)]=_0x2bc916['organisationId'],this[_0x6544b7(0x96)]=_0x2bc916['timeZone'],this['_organisationName']=_0x2bc916['organisationName'],this[_0x6544b7(0xda)]=_0x2bc916[_0x6544b7(0x99)],this[_0x6544b7(0x80)]=_0x2bc916['deploymentName'],this['_systemLogger']=new core_1[(_0x6544b7(0xba))](_0x6544b7(0xa6)),this['_veevaService']=new veeva_service_1[(_0x6544b7(0x98))]({'connection':this[_0x6544b7(0xca)],'logger':this[_0x6544b7(0x79)]}),this[_0x6544b7(0x6c)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x6544b7(0xf0)]}),this[_0x6544b7(0xeb)]=new package_import_service_1[(_0x6544b7(0x94))]({'veevaService':this[_0x6544b7(0xfc)],'connection':this[_0x6544b7(0xca)],'logger':this[_0x6544b7(0x79)],'saveLog':this[_0x6544b7(0xdb)]['bind'](this)}),this[_0x6544b7(0xb8)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x6544b7(0xfc)],'connection':this[_0x6544b7(0xca)],'logger':this['_logger']}),this['_vpkService']=new vpk_service_1[(_0x6544b7(0xab))]({'connection':this[_0x6544b7(0xca)]});}async[a358_0x42ff90(0x6a)](){const _0x364f65=a358_0x42ff90;try{const _0x2c9ba3=await this[_0x364f65(0xfe)]();await this['_logger'][_0x364f65(0xf3)]();const _0x59bacc=await this[_0x364f65(0x70)](_0x2c9ba3);await this[_0x364f65(0x84)](_0x59bacc);const _0x3511dc=await this[_0x364f65(0x76)](_0x2c9ba3),_0x1485c0=await this[_0x364f65(0xf7)](_0x3511dc),_0x2ec8e9=await this[_0x364f65(0xf9)](_0x1485c0);await this['_logger'][_0x364f65(0xf3)]();const _0x3e3fbf=await this[_0x364f65(0xeb)][_0x364f65(0x6b)](_0x2ec8e9);await this[_0x364f65(0x79)][_0x364f65(0xf3)]();const _0xdc38c6=this['formFlosumDeploymentResults'](_0x2c9ba3,_0x3e3fbf[_0x364f65(0x78)]);await this[_0x364f65(0xed)](_0xdc38c6),await this[_0x364f65(0xc6)](_0x3e3fbf[_0x364f65(0xfa)],![],_0x3e3fbf['packageId']);}catch(_0x68d071){await this['finishDeployWithError'](_0x68d071)[_0x364f65(0xc5)](_0x285ba5=>this[_0x364f65(0x7c)][_0x364f65(0x85)](_0x285ba5));}}async[a358_0x42ff90(0xfe)](){const _0x8d9993=a358_0x42ff90,_0x56d632=new Set(this[_0x8d9993(0xda)]);this[_0x8d9993(0x79)][_0x8d9993(0xc0)](_0x8d9993(0xe3));const _0x52b0eb=await new branch_component_history_flosum_component_retriever_1[(_0x8d9993(0xdc))]({'value':this[_0x8d9993(0x9b)],'salesforceService':this['_salesforceService']})[_0x8d9993(0xc3)](),_0x44c104=_0x52b0eb[_0x8d9993(0xce)](_0x11c16=>_0x56d632[_0x8d9993(0x7a)](_0x11c16['id']));if(_0x44c104[_0x8d9993(0x8f)]!==this[_0x8d9993(0xda)][_0x8d9993(0x8f)])throw new Error(_0x8d9993(0x8c));return _0x44c104;}async[a358_0x42ff90(0x70)](_0x41130a){const _0x115536=a358_0x42ff90;var _0xe2291c;this[_0x115536(0x79)][_0x115536(0xc0)](_0x115536(0x91));const _0x575eea=await new flosum_component_veeva_component_retriever_1[(_0x115536(0xe0))]({'value':_0x41130a,'veevaService':this['_veevaService'],'logger':this['_logger']})['retrieve'](),_0x2bc815=await this[_0x115536(0xb8)]['export'](_0x575eea,_0x115536(0x9e));if(_0x2bc815[_0x115536(0x8f)]>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0xe2291c=_0x2bc815[0x0])!==null&&_0xe2291c!==void 0x0?_0xe2291c:_0x2bc815[0x0]=new jszip_1[(_0x115536(0xb0))](),_0x2bc815[0x0][_0x115536(0xa1)]({'type':_0x115536(0xcd)});}async[a358_0x42ff90(0x84)](_0x1fd235){const _0x5ef8f7=a358_0x42ff90;this[_0x5ef8f7(0x79)]['log'](_0x5ef8f7(0xef));const _0x2185f8={'Body':_0x1fd235,'ContentType':'application/zip','ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x5ef8f7(0x65)][_0x5ef8f7(0x9d)]};await this[_0x5ef8f7(0xf0)][_0x5ef8f7(0xe5)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x2185f8);}async[a358_0x42ff90(0x76)](_0x147a6f){const _0x29bb6d=a358_0x42ff90;this[_0x29bb6d(0x79)][_0x29bb6d(0xc0)](_0x29bb6d(0x69));const _0x29525b=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x29bb6d(0xf0)],_0x147a6f[_0x29bb6d(0x77)](_0x3ce1ad=>_0x3ce1ad[_0x29bb6d(0xa3)])),_0x48366f=await(0x0,fetch_attachments_1[_0x29bb6d(0x76)])(_0x29525b,this[_0x29bb6d(0xf0)]);if(_0x48366f[_0x29bb6d(0x8f)]!==this[_0x29bb6d(0xda)][_0x29bb6d(0x8f)])throw new Error(_0x29bb6d(0xb3));return _0x48366f[_0x29bb6d(0x77)](_0xdf8236=>_0xdf8236[_0x29bb6d(0x8a)][_0x29bb6d(0xc8)]);}async[a358_0x42ff90(0xf7)](_0x4562c5){const _0xbae314=a358_0x42ff90;this[_0xbae314(0x79)]['log'](_0xbae314(0x90));const _0x1823d8=await new zip_creator_deploy_1[(_0xbae314(0x73))]({'attachmentBodies':_0x4562c5,'deploymentName':this['_deploymentName']})['execute'](),_0x224b66=this['_tempFolder']+'/'+(0x0,shortid_1[_0xbae314(0xb0)])()+'.zip';return await(0x0,promises_1['writeFile'])(_0x224b66,_0x1823d8),_0x224b66;}async[a358_0x42ff90(0xf9)](_0x59e699){const _0x289118=a358_0x42ff90;this['_logger'][_0x289118(0xc0)](_0x289118(0x95));const _0x409b15=await this[_0x289118(0xbd)]['generate'](_0x59e699),_0x559b18=this['_tempFolder']+_0x289118(0x89)+_0x59e699[_0x289118(0xc7)](_0x59e699[_0x289118(0xbc)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x559b18,_0x409b15),await this[_0x289118(0xbd)][_0x289118(0xea)](_0x559b18),_0x559b18;}async[a358_0x42ff90(0xdb)](_0x487299,_0x3c6e14){const _0x1ef1a5=a358_0x42ff90;this[_0x1ef1a5(0x79)]['log'](_0x1ef1a5(0xc4));const _0x4e097={'Body':Buffer['from'](_0x487299)['toString']('base64'),'ContentType':_0x1ef1a5(0x67),'ParentId':this[_0x1ef1a5(0xe7)],'Name':_0x3c6e14};await this['_connectionSalesforce'][_0x1ef1a5(0xe5)](flosum_constants_1[_0x1ef1a5(0x65)][_0x1ef1a5(0xb6)]+_0x1ef1a5(0xbb),_0x4e097);}['formFlosumDeploymentResults'](_0x3c4f3d,_0x117c66){const _0x5393c2=a358_0x42ff90;this['_logger']['log'](_0x5393c2(0xe1));const _0xd9643b=_0x3c4f3d[_0x5393c2(0xd3)]((_0x154618,_0x4e964f)=>_0x154618[_0x5393c2(0x93)]((_0x4e964f[_0x5393c2(0xf4)]+'.'+_0x4e964f[_0x5393c2(0xd8)])[_0x5393c2(0xaa)](),_0x4e964f),new Map());return _0x117c66['map'](_0x532947=>{const _0x27bffc=_0x5393c2;this[_0x27bffc(0x79)]['log'](_0x532947[_0x27bffc(0xa2)]+'.'+_0x532947[_0x27bffc(0x6d)]+_0x27bffc(0xf1)+_0x532947[_0x27bffc(0x82)]);const _0x3bba33=(_0x532947[_0x27bffc(0xa2)]+'.'+_0x532947[_0x27bffc(0x6d)])['toLowerCase'](),_0x10f89e=_0xd9643b[_0x27bffc(0x97)](_0x3bba33);return{[constants_1[_0x27bffc(0xc2)]+_0x27bffc(0xe2)]:_0x27bffc(0xa7),[constants_1[_0x27bffc(0xc2)]+_0x27bffc(0xbe)]:_0x532947['status']===status_enums_1[_0x27bffc(0x68)][_0x27bffc(0xd6)]?'Success':'Failure',[constants_1['FLOSUM_NAMESPACE']+_0x27bffc(0x87)]:_0x532947[_0x27bffc(0xd9)],[constants_1[_0x27bffc(0xc2)]+_0x27bffc(0xaf)]:_0x532947[_0x27bffc(0x6d)],[constants_1[_0x27bffc(0xc2)]+'Component_Type__c']:_0x532947['type'],[constants_1[_0x27bffc(0xc2)]+_0x27bffc(0x6e)]:_0x532947[_0x27bffc(0xfd)],[constants_1[_0x27bffc(0xc2)]+'Org__c']:this[_0x27bffc(0x8d)],[constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c']:this[_0x27bffc(0xe7)],[constants_1['FLOSUM_NAMESPACE']+'Component_History__c']:_0x10f89e[_0x27bffc(0xa3)]};});}async[a358_0x42ff90(0xed)](_0x147d71){const _0x435ee0=a358_0x42ff90;this[_0x435ee0(0x79)][_0x435ee0(0xc0)](_0x435ee0(0x7b));const _0x1431ba=await this['_salesforceService'][_0x435ee0(0x81)](constants_1[_0x435ee0(0xc2)]+_0x435ee0(0x9c),_0x147d71),_0x4e4fca=_0x1431ba[_0x435ee0(0xce)](_0x37ef53=>!_0x37ef53[_0x435ee0(0xac)])[_0x435ee0(0x77)](_0x3ca951=>_0x3ca951[_0x435ee0(0xfb)])['flat']();if(_0x4e4fca[_0x435ee0(0x8f)])throw new salesforce_dml_error_1[(_0x435ee0(0xb1))](_0x4e4fca);}async[a358_0x42ff90(0xf6)](_0x4a5ff7){const _0x4f9a86=a358_0x42ff90;this[_0x4f9a86(0x79)]['logError'](_0x4a5ff7),await this[_0x4f9a86(0x79)][_0x4f9a86(0xf3)](),await this[_0x4f9a86(0xc6)](![],!![],'');}async[a358_0x42ff90(0xc6)](_0x593275,_0x23c75f,_0x511142){const _0x408c54=a358_0x42ff90,_0x25a631=_0x408c54(0xee)+this['_instanceUrl']+'/'+this[_0x408c54(0xe7)]+_0x408c54(0xd1)+'Veeva\x20Deployment'+'\x20</a>',_0x19eee2='<a\x20href='+this[_0x408c54(0x75)]+'/'+this['_organisationId']+'\x20>'+this[_0x408c54(0xec)]+_0x408c54(0xa5),_0x36e65d=_0x25a631+_0x408c54(0x8b)+_0x19eee2+_0x408c54(0x72),_0x133a6a={[constants_1[_0x408c54(0xc2)]+_0x408c54(0xff)]:_0x36e65d,[constants_1[_0x408c54(0xc2)]+_0x408c54(0x86)]:new Date(),[constants_1[_0x408c54(0xc2)]+_0x408c54(0x7e)]:this['_branchId'],[constants_1[_0x408c54(0xc2)]+'Activity_Item__c']:_0x408c54(0xb2),[constants_1[_0x408c54(0xc2)]+_0x408c54(0xd2)]:_0x408c54(0x8e),[constants_1[_0x408c54(0xc2)]+'TargetId__c']:this[_0x408c54(0x8d)]},_0xab9fe9={[constants_1['FLOSUM_NAMESPACE']+_0x408c54(0xd0)]:!_0x593275,[constants_1[_0x408c54(0xc2)]+'Succeed__c']:_0x593275,[constants_1[_0x408c54(0xc2)]+_0x408c54(0xbe)]:_0x23c75f?status_enums_1['MetadataLogStatus'][_0x408c54(0x7d)]:status_enums_1['MetadataLogStatus'][_0x408c54(0xf8)],[constants_1[_0x408c54(0xc2)]+_0x408c54(0xe4)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x408c54(0xb9)]:_0x511142};await this[_0x408c54(0xf0)][_0x408c54(0xa8)](flosum_constants_1[_0x408c54(0x65)][_0x408c54(0xb6)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c/'+this[_0x408c54(0xe7)],_0xab9fe9),await this[_0x408c54(0xf0)]['post'](flosum_constants_1[_0x408c54(0x65)][_0x408c54(0xb6)]+'/'+constants_1[_0x408c54(0xc2)]+'Log__c',_0x133a6a),this[_0x408c54(0x79)][_0x408c54(0xc0)](_0x408c54(0x64)+(_0x593275?'successfully':_0x408c54(0x71))+'.'),await this[_0x408c54(0x79)]['updateLog']();}}exports[a358_0x42ff90(0xb7)]=DeployService;function a358_0x215b(){const _0x25bdcd=['retrieveAttachments','map','packageComponentList','_logger','has','Save\x20Deployment\x20Results','_systemLogger','EXCEPTION','Branch__c','959625QkjMcJ','_deploymentName','insertMultipleRecords','status','apply','saveBackup','error','Date__c','Result__c','defineProperty','/vpk__','values','\x20of\x20branch\x20to\x20Organization\x20','Cannot\x20retrieve\x20all\x20components.','_organisationId','Deployment','length','Join\x20all\x20mdl\x20into\x20one\x20zip','Create\x20Backup','1590sNdZPT','set','PackageImportService','Create\x20vpk\x20package','_timeZone','get','VeevaService','componentIdList','10493ClkWAf','_branchId','Deployment_Result__c','BACKUP_ZIP_NAME','Backup','./vpk.service','_tempFolder','generateAsync','type','componentHistoryId','61220hvLftN','</a>','veeva-deploy','Deployment\x20Result','patch','constructor','toLowerCase','VpkService','success','(((.+)+)+)+$','__esModule','Component_Name__c','default','SalesforceDmlError','Branch','Cannot\x20retrievers\x20all\x20attachments','13059EhWTRv','jszip','ENDPOINT_UPSERT_RECORD','DeployService','_packageExportService','External_Deployment_Id__c','Logger','/Attachment','lastIndexOf','_vpkService','Status__c','../classes/errors/salesforce-dml-error','log','metadataLogId','FLOSUM_NAMESPACE','retrieve','Save\x20log','catch','finishDeploy','slice','Body','7467042nOalcY','_connectionVeeva','112DAcJow','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','base64','filter','../classes/deploy/zip-creator.deploy','Is_Error__c','\x20>\x20','Activity_Type__c','reduce','./package-import.service','toString','DEPLOYED','2021682rBrYCu','componentName','deploymentAction','_componentIdList','saveLog','BranchComponentHistoryFlosumComponentRetriever','10610GgYshq','shortid','1ynLdKd','FlosumComponentVeevaComponentRetriever','Form\x20Deployment\x20Results','Type__c','Retrieving\x20components','Job_Completed__c','post','../../shared/utils/fetch-attachments','_metadataLogId','21fSMZjK','attachmentLogId','validate','_packageImportService','_organisationName','saveDeploymentResults','<a\x20href=','Save\x20Backup\x20to\x20Salesforce','_connectionSalesforce','\x20:\x20','../../../core','updateLog','componentType','search','finishDeployWithError','createZip','COMPLETED','createVpk','isDeployed','errors','_veevaService','stepName','getFlosumComponents','Action__c','Deploy\x20completed\x20','FlosumConstants','../constants/flosum.constants','text/plain','PackageComponentStatus','Retrieving\x20attachments','execute','import','_salesforceService','name','Veeva_Step_Name__c','../../../constants','createBackup','with\x20error','\x20has\x20been\x20created.','ZipCreatorDeploy','fs/promises','_instanceUrl'];a358_0x215b=function(){return _0x25bdcd;};return a358_0x215b();}