const a350_0x1e2874=a350_0x248e;(function(_0x483261,_0x1e8aae){const _0x30361c=a350_0x248e,_0x3afb5d=_0x483261();while(!![]){try{const _0x3505d6=parseInt(_0x30361c(0x1de))/0x1+parseInt(_0x30361c(0x14d))/0x2+-parseInt(_0x30361c(0x18d))/0x3+-parseInt(_0x30361c(0x1e3))/0x4*(-parseInt(_0x30361c(0x141))/0x5)+-parseInt(_0x30361c(0x15e))/0x6*(parseInt(_0x30361c(0x137))/0x7)+-parseInt(_0x30361c(0x135))/0x8+-parseInt(_0x30361c(0x152))/0x9*(-parseInt(_0x30361c(0x193))/0xa);if(_0x3505d6===_0x1e8aae)break;else _0x3afb5d['push'](_0x3afb5d['shift']());}catch(_0x59a2b9){_0x3afb5d['push'](_0x3afb5d['shift']());}}}(a350_0x43ec,0xc9150));const a350_0x420d86=(function(){let _0x1694f5=!![];return function(_0x553b2b,_0x5b2133){const _0x442c24=_0x1694f5?function(){const _0x2fd469=a350_0x248e;if(_0x5b2133){const _0x2bb351=_0x5b2133[_0x2fd469(0x190)](_0x553b2b,arguments);return _0x5b2133=null,_0x2bb351;}}:function(){};return _0x1694f5=![],_0x442c24;};}()),a350_0x3060e4=a350_0x420d86(this,function(){const _0x54ad34=a350_0x248e;return a350_0x3060e4[_0x54ad34(0x155)]()['search'](_0x54ad34(0x1c0))[_0x54ad34(0x155)]()[_0x54ad34(0x1a4)](a350_0x3060e4)[_0x54ad34(0x184)](_0x54ad34(0x1c0));});a350_0x3060e4();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3d5c33){const _0x5b481d=a350_0x248e;return _0x3d5c33&&_0x3d5c33[_0x5b481d(0x1d4)]?_0x3d5c33:{'default':_0x3d5c33};};Object[a350_0x1e2874(0x160)](exports,a350_0x1e2874(0x1d4),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a350_0x1e2874(0x1c7))),promises_1=require('fs/promises'),constants_1=require(a350_0x1e2874(0x14e)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a350_0x1e2874(0x1b0)),salesforce_service_1=require(a350_0x1e2874(0x14a)),core_1=require('../../../core'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a350_0x1e2874(0x1bd)),shortid_1=__importDefault(require(a350_0x1e2874(0x17f))),xml2js_1=require(a350_0x1e2874(0x133)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a350_0x1e2874(0x149)),branch_component_history_flosum_component_retriever_1=require(a350_0x1e2874(0x19e)),flosum_component_veeva_component_retriever_1=require(a350_0x1e2874(0x1e5)),package_export_service_1=require(a350_0x1e2874(0x1dc)),vpk_service_1=require(a350_0x1e2874(0x18b));function a350_0x248e(_0x4cf8b3,_0x10e1dc){const _0x1d3692=a350_0x43ec();return a350_0x248e=function(_0x3060e4,_0x420d86){_0x3060e4=_0x3060e4-0x132;let _0x43ec64=_0x1d3692[_0x3060e4];return _0x43ec64;},a350_0x248e(_0x4cf8b3,_0x10e1dc);}class DeployService{constructor(_0x1f1cd9,_0x44290c,_0x18a208,_0x555d8d,_0x31ce14,_0x2993b4){const _0x566c64=a350_0x1e2874;this[_0x566c64(0x1c8)]=_0x44290c,this[_0x566c64(0x187)]=_0x18a208,this[_0x566c64(0x136)]=_0x555d8d,this[_0x566c64(0x1a9)]=_0x31ce14,this[_0x566c64(0x16d)]=_0x2993b4,this[_0x566c64(0x18a)]=_0x1f1cd9['branchId'],this[_0x566c64(0x1ad)]=_0x1f1cd9[_0x566c64(0x1d5)],this[_0x566c64(0x1a1)]=_0x1f1cd9[_0x566c64(0x1c3)],this[_0x566c64(0x1a6)]=_0x1f1cd9[_0x566c64(0x177)],this[_0x566c64(0x182)]=_0x1f1cd9[_0x566c64(0x1a0)],this[_0x566c64(0x1b8)]=_0x1f1cd9[_0x566c64(0x171)],this[_0x566c64(0x1cf)]=_0x1f1cd9['componentIdList'],this[_0x566c64(0x153)]=_0x1f1cd9[_0x566c64(0x15b)],this[_0x566c64(0x166)]=new core_1[(_0x566c64(0x16b))](_0x566c64(0x13d)),this[_0x566c64(0x13b)]=new veeva_service_1['VeevaService']({'connection':this[_0x566c64(0x187)],'logger':this['_logger']}),this[_0x566c64(0x15c)]=new salesforce_service_1[(_0x566c64(0x139))]({'connection':this[_0x566c64(0x1c8)]}),this[_0x566c64(0x1cc)]=new package_import_service_1[(_0x566c64(0x186))]({'veevaService':this[_0x566c64(0x13b)],'connection':this[_0x566c64(0x187)],'logger':this[_0x566c64(0x136)],'saveLog':this[_0x566c64(0x14b)][_0x566c64(0x181)](this)}),this[_0x566c64(0x197)]=new package_export_service_1[(_0x566c64(0x179))]({'veevaService':this[_0x566c64(0x13b)],'connection':this[_0x566c64(0x187)],'logger':this[_0x566c64(0x136)]}),this[_0x566c64(0x15d)]=new vpk_service_1['VpkService']({'connection':this[_0x566c64(0x187)]});}async[a350_0x1e2874(0x1e4)](){const _0x5ba70f=a350_0x1e2874;try{const _0x20765d=await this['getFlosumComponents']();await this['_logger'][_0x5ba70f(0x1bc)](),await this[_0x5ba70f(0x1c6)](_0x20765d);const _0x46272f=await this[_0x5ba70f(0x1c2)](_0x20765d),_0x4aa32e=await this[_0x5ba70f(0x1d1)](_0x46272f),_0x60cd07=await this['createVpk'](_0x4aa32e);await this[_0x5ba70f(0x136)]['updateLog']();const _0x4848a5=await this['_packageImportService'][_0x5ba70f(0x168)](_0x60cd07);await this[_0x5ba70f(0x136)][_0x5ba70f(0x1bc)]();const _0xe21767=this[_0x5ba70f(0x1c9)](_0x20765d,_0x4848a5[_0x5ba70f(0x1d6)]);await this['saveDeploymentResults'](_0xe21767),await this['finishDeploy'](_0x4848a5[_0x5ba70f(0x191)],![],_0x4848a5[_0x5ba70f(0x159)]);}catch(_0x56613b){await this[_0x5ba70f(0x1b4)](_0x56613b)[_0x5ba70f(0x1cd)](_0x40fd7e=>this['_systemLogger'][_0x5ba70f(0x1ac)](_0x40fd7e));}}async[a350_0x1e2874(0x140)](){const _0x5cdcad=a350_0x1e2874,_0x53db0f=new Set(this[_0x5cdcad(0x1cf)]);this[_0x5cdcad(0x136)]['log'](_0x5cdcad(0x170));const _0x305080=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x5cdcad(0x18a)],'salesforceService':this[_0x5cdcad(0x15c)]})[_0x5cdcad(0x17b)](),_0x398bb9=_0x305080[_0x5cdcad(0x198)](_0x24be99=>_0x53db0f[_0x5cdcad(0x1be)](_0x24be99['id']));if(_0x398bb9[_0x5cdcad(0x1d9)]!==this[_0x5cdcad(0x1cf)][_0x5cdcad(0x1d9)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x398bb9;}async['createBackup'](_0x5b0375){const _0x477368=a350_0x1e2874;var _0x26510c;this[_0x477368(0x136)][_0x477368(0x178)](_0x477368(0x18e));const _0x5a762d=await new flosum_component_veeva_component_retriever_1[(_0x477368(0x138))]({'value':_0x5b0375,'veevaService':this[_0x477368(0x13b)],'logger':this[_0x477368(0x136)]})[_0x477368(0x17b)](),_0x581b14=await this[_0x477368(0x197)][_0x477368(0x1ce)](_0x5a762d,_0x477368(0x19a));if(_0x581b14[_0x477368(0x1d9)]>0x1)throw new Error(_0x477368(0x1d0));(_0x26510c=_0x581b14[0x0])!==null&&_0x26510c!==void 0x0?_0x26510c:_0x581b14[0x0]=new jszip_1[(_0x477368(0x16e))]();const _0x53007d=await _0x581b14[0x0][_0x477368(0x19c)]({'type':_0x477368(0x175)});this[_0x477368(0x136)][_0x477368(0x178)](_0x477368(0x199));const _0x4f4f2c={'Body':_0x53007d,'ContentType':_0x477368(0x19b),'ParentId':this[_0x477368(0x1ad)],'Name':flosum_constants_1['FlosumConstants']['BACKUP_ZIP_NAME']};await this[_0x477368(0x1c8)][_0x477368(0x1b7)](flosum_constants_1[_0x477368(0x174)][_0x477368(0x1cb)]+_0x477368(0x156),_0x4f4f2c),this[_0x477368(0x136)][_0x477368(0x178)]('Finish\x20Create\x20Backup');}async[a350_0x1e2874(0x1c2)](_0x4b777c){const _0x314c43=a350_0x1e2874;this[_0x314c43(0x136)][_0x314c43(0x178)](_0x314c43(0x180));const _0x13f0a5=await(0x0,fetch_attachments_1[_0x314c43(0x13c)])(this[_0x314c43(0x1c8)],_0x4b777c[_0x314c43(0x194)](_0x1e5c57=>_0x1e5c57['componentHistoryId'])),_0x31a3aa=await(0x0,fetch_attachments_1[_0x314c43(0x1c2)])(_0x13f0a5,this[_0x314c43(0x1c8)]);if(_0x31a3aa[_0x314c43(0x1d9)]!==this[_0x314c43(0x1cf)]['length'])throw new Error(_0x314c43(0x1c5));return _0x31a3aa[_0x314c43(0x194)](_0x4cf7a2=>_0x4cf7a2[_0x314c43(0x1b6)]['Body']);}async[a350_0x1e2874(0x1d1)](_0x1c900d){const _0x15921e=a350_0x1e2874;var _0x40c372;this[_0x15921e(0x136)][_0x15921e(0x178)](_0x15921e(0x167));const _0x527ede=new jszip_1[(_0x15921e(0x16e))]();for(const _0x3e5bd2 of _0x1c900d){const _0x5857be=new jszip_1[(_0x15921e(0x16e))]();await _0x5857be[_0x15921e(0x13a)](_0x3e5bd2,{'base64':!![]});for(const _0x24d741 in _0x5857be[_0x15921e(0x162)]){const _0x537798=await((_0x40c372=_0x5857be[_0x15921e(0x185)](_0x24d741))===null||_0x40c372===void 0x0?void 0x0:_0x40c372['async'](_0x15921e(0x172)));_0x537798&&_0x527ede[_0x15921e(0x185)](_0x24d741,_0x537798);}}const _0xbd2e7a=new xml2js_1[(_0x15921e(0x13f))]({'headless':!![]}),_0x29fc4d={'vaultpackage':{'$':{'xmlns':_0x15921e(0x18f)},'name':this[_0x15921e(0x153)],'source':{'vault':undefined,'author':'Flosum'},'packagetype':_0x15921e(0x18c),'summary':_0x15921e(0x13e),'description':_0x15921e(0x132)}};_0x527ede[_0x15921e(0x185)](_0x15921e(0x16f),_0xbd2e7a[_0x15921e(0x1a8)](_0x29fc4d));const _0x453ab7=this[_0x15921e(0x1a9)]+'/'+(0x0,shortid_1['default'])()+_0x15921e(0x1dd),_0x5b39a4=await _0x527ede[_0x15921e(0x19c)]({'type':_0x15921e(0x15a)});return await(0x0,promises_1[_0x15921e(0x189)])(_0x453ab7,_0x5b39a4),_0x453ab7;}async[a350_0x1e2874(0x164)](_0x4ba6d8){const _0x2277b9=a350_0x1e2874;this[_0x2277b9(0x136)][_0x2277b9(0x178)](_0x2277b9(0x1d3));const _0x5b89c0=await this[_0x2277b9(0x15d)][_0x2277b9(0x17a)](_0x4ba6d8),_0x156a66=this['_tempFolder']+_0x2277b9(0x1b2)+_0x4ba6d8['slice'](_0x4ba6d8['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x2277b9(0x189)])(_0x156a66,_0x5b89c0),await this['_vpkService'][_0x2277b9(0x19f)](_0x156a66),_0x156a66;}async['saveLog'](_0x134784,_0x501671){const _0xc6746=a350_0x1e2874;this[_0xc6746(0x136)][_0xc6746(0x178)](_0xc6746(0x158));const _0x36bf79={'Body':Buffer['from'](_0x134784)[_0xc6746(0x155)](_0xc6746(0x175)),'ContentType':'text/plain','ParentId':this[_0xc6746(0x1ad)],'Name':_0x501671};await this[_0xc6746(0x1c8)][_0xc6746(0x1b7)](flosum_constants_1[_0xc6746(0x174)][_0xc6746(0x1cb)]+_0xc6746(0x156),_0x36bf79);}['formFlosumDeploymentResults'](_0x113ef2,_0x1fd72e){const _0x65cdce=a350_0x1e2874;this[_0x65cdce(0x136)][_0x65cdce(0x178)](_0x65cdce(0x163));const _0x2cb73b=_0x113ef2[_0x65cdce(0x1e2)]((_0x56449b,_0x2049ee)=>_0x56449b[_0x65cdce(0x1a7)]((_0x2049ee[_0x65cdce(0x1b3)]+'.'+_0x2049ee[_0x65cdce(0x143)])[_0x65cdce(0x1d8)](),_0x2049ee),new Map());return _0x1fd72e[_0x65cdce(0x194)](_0x32a81e=>{const _0x5ee045=_0x65cdce;this['_logger'][_0x5ee045(0x178)](_0x32a81e[_0x5ee045(0x1c4)]+'.'+_0x32a81e[_0x5ee045(0x151)]+_0x5ee045(0x1bf)+_0x32a81e[_0x5ee045(0x1da)]);const _0xf2144b=(_0x32a81e[_0x5ee045(0x1c4)]+'.'+_0x32a81e[_0x5ee045(0x151)])[_0x5ee045(0x1d8)](),_0x5e01bf=_0x2cb73b[_0x5ee045(0x150)](_0xf2144b);return{[constants_1['FLOSUM_NAMESPACE']+_0x5ee045(0x1aa)]:_0x5ee045(0x188),[constants_1[_0x5ee045(0x1ca)]+_0x5ee045(0x165)]:_0x32a81e['status']===status_enums_1[_0x5ee045(0x1af)][_0x5ee045(0x1b1)]?_0x5ee045(0x196):'Failure',[constants_1[_0x5ee045(0x1ca)]+'Result__c']:_0x32a81e[_0x5ee045(0x146)],[constants_1[_0x5ee045(0x1ca)]+_0x5ee045(0x147)]:_0x32a81e[_0x5ee045(0x151)],[constants_1[_0x5ee045(0x1ca)]+_0x5ee045(0x154)]:_0x32a81e['type'],[constants_1[_0x5ee045(0x1ca)]+_0x5ee045(0x134)]:_0x32a81e[_0x5ee045(0x17d)],[constants_1[_0x5ee045(0x1ca)]+_0x5ee045(0x1b5)]:this[_0x5ee045(0x1a6)],[constants_1['FLOSUM_NAMESPACE']+_0x5ee045(0x148)]:this[_0x5ee045(0x1ad)],[constants_1['FLOSUM_NAMESPACE']+'Component_History__c']:_0x5e01bf[_0x5ee045(0x1ab)]};});}async[a350_0x1e2874(0x15f)](_0x2c826b){const _0x1d19a7=a350_0x1e2874;this[_0x1d19a7(0x136)][_0x1d19a7(0x178)](_0x1d19a7(0x17c));const _0x590bca=await this[_0x1d19a7(0x15c)]['insertMultipleRecords'](constants_1[_0x1d19a7(0x1ca)]+_0x1d19a7(0x1c1),_0x2c826b),_0x35071b=_0x590bca['filter'](_0x4a5fcf=>!_0x4a5fcf[_0x1d19a7(0x14f)])[_0x1d19a7(0x194)](_0x4590b2=>_0x4590b2[_0x1d19a7(0x144)])[_0x1d19a7(0x169)]();if(_0x35071b[_0x1d19a7(0x1d9)])throw new salesforce_dml_error_1[(_0x1d19a7(0x1a5))](_0x35071b);}async['finishDeployWithError'](_0x4d9f36){const _0x2f533e=a350_0x1e2874;this['_logger'][_0x2f533e(0x1db)](_0x4d9f36),await this['_logger'][_0x2f533e(0x1bc)](),await this[_0x2f533e(0x192)](![],!![],'');}async[a350_0x1e2874(0x192)](_0x3f9bd5,_0x2d127f,_0x3ba9b7){const _0x3447ee=a350_0x1e2874,_0x33f8d4=_0x3447ee(0x1df)+this[_0x3447ee(0x16d)]+'/'+this['_metadataLogId']+_0x3447ee(0x176)+_0x3447ee(0x157)+_0x3447ee(0x1d7),_0x2bd107=_0x3447ee(0x1df)+this[_0x3447ee(0x16d)]+'/'+this[_0x3447ee(0x1a6)]+'\x20>'+this['_organisationName']+_0x3447ee(0x1a2),_0x4b188a=_0x33f8d4+_0x3447ee(0x1ae)+_0x2bd107+_0x3447ee(0x142),_0x285a96={[constants_1['FLOSUM_NAMESPACE']+_0x3447ee(0x1ba)]:_0x4b188a,[constants_1['FLOSUM_NAMESPACE']+_0x3447ee(0x16a)]:new Date(),[constants_1[_0x3447ee(0x1ca)]+'Branch__c']:this['_branchId'],[constants_1[_0x3447ee(0x1ca)]+_0x3447ee(0x1d2)]:'Branch',[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0x3447ee(0x1b9),[constants_1[_0x3447ee(0x1ca)]+_0x3447ee(0x195)]:this['_organisationId']},_0x21f560={[constants_1[_0x3447ee(0x1ca)]+_0x3447ee(0x145)]:!_0x3f9bd5,[constants_1[_0x3447ee(0x1ca)]+_0x3447ee(0x183)]:_0x3f9bd5,[constants_1[_0x3447ee(0x1ca)]+'Status__c']:_0x2d127f?status_enums_1[_0x3447ee(0x173)][_0x3447ee(0x1e0)]:status_enums_1[_0x3447ee(0x173)][_0x3447ee(0x1a3)],[constants_1[_0x3447ee(0x1ca)]+_0x3447ee(0x1bb)]:!![],[constants_1[_0x3447ee(0x1ca)]+_0x3447ee(0x19d)]:_0x3ba9b7};await this[_0x3447ee(0x1c8)]['patch'](flosum_constants_1[_0x3447ee(0x174)][_0x3447ee(0x1cb)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x3447ee(0x14c)+this[_0x3447ee(0x1ad)],_0x21f560),await this[_0x3447ee(0x1c8)][_0x3447ee(0x1b7)](flosum_constants_1[_0x3447ee(0x174)][_0x3447ee(0x1cb)]+'/'+constants_1[_0x3447ee(0x1ca)]+_0x3447ee(0x17e),_0x285a96),this[_0x3447ee(0x136)][_0x3447ee(0x178)](_0x3447ee(0x1e1)+(_0x3f9bd5?_0x3447ee(0x16c):_0x3447ee(0x161))+'.'),await this[_0x3447ee(0x136)][_0x3447ee(0x1bc)]();}}exports['DeployService']=DeployService;function a350_0x43ec(){const _0x5ac29f=['default','vaultpackage.xml','Retrieving\x20components','organisationName','string','MetadataLogStatus','FlosumConstants','base64','\x20>\x20','organisationId','log','PackageExportService','generate','retrieve','Save\x20Deployment\x20Results','stepName','Log__c','shortid','Retrieving\x20attachments','bind','_timeZone','Succeed__c','search','file','PackageImportService','_connectionVeeva','Deployment\x20Result','writeFile','_branchId','./vpk.service','migration__v','2522556FFCYCt','Create\x20Backup','https://veevavault.com/','apply','isDeployed','finishDeploy','540900ZOnNvu','map','TargetId__c','Success','_packageExportService','filter','Save\x20Backup\x20to\x20Salesforce','Backup','application/zip','generateAsync','Async_Request_Id__c','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','validate','timeZone','_attachmentLogId','</a>','COMPLETED','constructor','SalesforceDmlError','_organisationId','set','buildObject','_tempFolder','Type__c','componentHistoryId','error','_metadataLogId','\x20of\x20branch\x20to\x20Organization\x20','PackageComponentStatus','./veeva.service','DEPLOYED','/vpk__','componentType','finishDeployWithError','Org__c','values','post','_organisationName','Deployment','Action__c','Job_Completed__c','updateLog','../classes/errors/salesforce-dml-error','has','\x20:\x20','(((.+)+)+)+$','Deployment_Result__c','retrieveAttachments','attachmentLogId','type','Cannot\x20retrievers\x20all\x20attachments','createBackup','jszip','_connectionSalesforce','formFlosumDeploymentResults','FLOSUM_NAMESPACE','ENDPOINT_UPSERT_RECORD','_packageImportService','catch','export','_componentIdList','Cannot\x20Backup\x20more\x20than\x20200\x20components.','joinAllAttachments','Activity_Item__c','Create\x20vpk\x20package','__esModule','metadataLogId','packageComponentList','\x20</a>','toLowerCase','length','status','logError','./package-export.service','.zip','948329RRuRSS','<a\x20href=','EXCEPTION','Deploy\x20completed\x20','reduce','506192cbXNIO','execute','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','null','xml2js','Veeva_Step_Name__c','11809408itqrcR','_logger','3503311zseNWy','FlosumComponentVeevaComponentRetriever','SalesforceService','loadAsync','_veevaService','fetchAttachmentsDetailsByParentId','veeva-deploy','Deploy','Builder','getFlosumComponents','35grzMcI','\x20has\x20been\x20created.','componentName','errors','Is_Error__c','deploymentAction','Component_Name__c','Metadata_Log__c','./package-import.service','./salesforce.service','saveLog','Metadata_Log__c/','3127688KTSRFZ','../../../constants','success','get','name','207aQrSvj','_deploymentName','Component_Type__c','toString','/Attachment','Veeva\x20Deployment','Save\x20log','packageId','nodebuffer','deploymentName','_salesforceService','_vpkService','18WkATVx','saveDeploymentResults','defineProperty','with\x20error','files','Form\x20Deployment\x20Results','createVpk','Status__c','_systemLogger','Join\x20all\x20mdl\x20into\x20one\x20zip','import','flat','Date__c','Logger','successfully','_instanceUrl'];a350_0x43ec=function(){return _0x5ac29f;};return a350_0x43ec();}