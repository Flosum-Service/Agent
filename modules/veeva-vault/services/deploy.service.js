const a358_0x172057=a358_0x442b;(function(_0x258549,_0x2680b3){const _0x45e9d1=a358_0x442b,_0x5e3bf5=_0x258549();while(!![]){try{const _0x1df726=-parseInt(_0x45e9d1(0x1c6))/0x1*(-parseInt(_0x45e9d1(0x209))/0x2)+parseInt(_0x45e9d1(0x1e4))/0x3+-parseInt(_0x45e9d1(0x221))/0x4*(-parseInt(_0x45e9d1(0x217))/0x5)+parseInt(_0x45e9d1(0x239))/0x6+parseInt(_0x45e9d1(0x1f7))/0x7*(parseInt(_0x45e9d1(0x22a))/0x8)+parseInt(_0x45e9d1(0x1a8))/0x9*(-parseInt(_0x45e9d1(0x223))/0xa)+-parseInt(_0x45e9d1(0x1aa))/0xb*(parseInt(_0x45e9d1(0x1dd))/0xc);if(_0x1df726===_0x2680b3)break;else _0x5e3bf5['push'](_0x5e3bf5['shift']());}catch(_0xd65475){_0x5e3bf5['push'](_0x5e3bf5['shift']());}}}(a358_0x43c9,0x4b86c));const a358_0x4dabc7=(function(){let _0xd9d6a6=!![];return function(_0x946459,_0x5cc1a7){const _0x363045=_0xd9d6a6?function(){const _0x7c8f7=a358_0x442b;if(_0x5cc1a7){const _0x196cd4=_0x5cc1a7[_0x7c8f7(0x224)](_0x946459,arguments);return _0x5cc1a7=null,_0x196cd4;}}:function(){};return _0xd9d6a6=![],_0x363045;};}()),a358_0x15eee9=a358_0x4dabc7(this,function(){const _0x16145c=a358_0x442b;return a358_0x15eee9[_0x16145c(0x1f8)]()[_0x16145c(0x1d4)](_0x16145c(0x1a3))[_0x16145c(0x1f8)]()['constructor'](a358_0x15eee9)[_0x16145c(0x1d4)]('(((.+)+)+)+$');});a358_0x15eee9();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x292a6f){return _0x292a6f&&_0x292a6f['__esModule']?_0x292a6f:{'default':_0x292a6f};};Object[a358_0x172057(0x1ba)](exports,'__esModule',{'value':!![]}),exports['DeployService']=void 0x0;function a358_0x442b(_0x18aa83,_0x3d00ed){const _0x139e27=a358_0x43c9();return a358_0x442b=function(_0x15eee9,_0x4dabc7){_0x15eee9=_0x15eee9-0x193;let _0x43c97a=_0x139e27[_0x15eee9];return _0x43c97a;},a358_0x442b(_0x18aa83,_0x3d00ed);}const jszip_1=__importDefault(require(a358_0x172057(0x1ee))),promises_1=require(a358_0x172057(0x1af)),constants_1=require('../../../constants'),flosum_constants_1=require(a358_0x172057(0x193)),veeva_service_1=require(a358_0x172057(0x1be)),salesforce_service_1=require(a358_0x172057(0x1bb)),core_1=require(a358_0x172057(0x1f1)),status_enums_1=require(a358_0x172057(0x1c7)),salesforce_dml_error_1=require(a358_0x172057(0x1eb)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require(a358_0x172057(0x19b)),package_import_service_1=require(a358_0x172057(0x225)),branch_component_history_flosum_component_retriever_1=require(a358_0x172057(0x1ae)),flosum_component_veeva_component_retriever_1=require(a358_0x172057(0x1bd)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a358_0x172057(0x230)),zip_creator_deploy_1=require(a358_0x172057(0x234));function a358_0x43c9(){const _0xd1a863=['Branch__c','BranchComponentHistoryFlosumComponentRetriever','isDeployed','TargetId__c','5HNznRv','with\x20error','execute','Cannot\x20retrieve\x20all\x20components.','Cannot\x20retrievers\x20all\x20attachments','Type__c','bind','ZipCreatorDeploy','ENDPOINT_UPSERT_RECORD','stepName','1198532oiedOp','PackageImportService','390pekthB','apply','./package-import.service','Cannot\x20Backup\x20more\x20than\x20200\x20components.','flat','/vpk__','Metadata_Log__c/','12456UzGYye','COMPLETED','formFlosumDeploymentResults','Form\x20Deployment\x20Results','Success','_tempFolder','./vpk.service','Action__c','updateLog','_veevaService','../classes/deploy/zip-creator.deploy','MetadataLogStatus','SalesforceService','success','_logger','2266602yYywAW','EXCEPTION','metadataLogId','finishDeploy','../constants/flosum.constants','Veeva_Step_Name__c','Save\x20Backup\x20to\x20Salesforce','saveDeploymentResults','_timeZone','attachmentLogId','from','_salesforceService','../../shared/utils/fetch-attachments','validate','_instanceUrl','_connectionVeeva','Backup','retrieveAttachments','organisationName','Succeed__c','(((.+)+)+)+$','componentName','_deploymentName','patch','DEPLOYED','99171btGOgN','lastIndexOf','10720193NktTIN','Activity_Item__c','errors','Save\x20log','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','fs/promises','Log__c','timeZone','PackageComponentStatus','toLowerCase','filter','saveBackup','retrieve','writeFile','_componentIdList','Status__c','defineProperty','./salesforce.service','Branch','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','./veeva.service','BACKUP_ZIP_NAME','Org__c','map','deploymentName','type','</a>','FlosumComponentVeevaComponentRetriever','37bJKhmq','../enums/status.enums','packageComponentList','get','Retrieving\x20attachments','_organisationName','Component_Type__c','Create\x20Backup','Retrieving\x20components','organisationId','text/plain','post','createBackup','_metadataLogId','search','Deploy\x20completed\x20','/Attachment','reduce','length','successfully','Deployment','Component_History__c','\x20of\x20branch\x20to\x20Organization\x20','12UVgKBi','PackageExportService','log','componentIdList','Deployment\x20Result','export','slice','1745292JGIGGl','FlosumConstants','Is_Error__c','_branchId','\x20has\x20been\x20created.','_connectionSalesforce','componentHistoryId','../classes/errors/salesforce-dml-error','\x20>\x20','componentType','jszip','packageId','status','../../../core','Async_Request_Id__c','generate','Join\x20all\x20mdl\x20into\x20one\x20zip','_packageImportService','.zip','1008qSCvEX','toString','Deployment_Result__c','<a\x20href=','Metadata_Log__c','_organisationId','Activity_Type__c','Logger','createVpk','has','saveLog','Date__c','\x20:\x20','finishDeployWithError','getFlosumComponents','Component_Name__c','VpkService','FLOSUM_NAMESPACE','12448ZmLzwv','Veeva\x20Deployment','\x20</a>','branchId','error','createZip','VeevaService','name','SalesforceDmlError','_systemLogger'];a358_0x43c9=function(){return _0xd1a863;};return a358_0x43c9();}class DeployService{constructor(_0x57a5ab,_0x2c7b38,_0x909203,_0x525461,_0xf0bce0,_0x11600c){const _0x154f4f=a358_0x172057;this[_0x154f4f(0x1e9)]=_0x2c7b38,this[_0x154f4f(0x19e)]=_0x909203,this[_0x154f4f(0x238)]=_0x525461,this[_0x154f4f(0x22f)]=_0xf0bce0,this[_0x154f4f(0x19d)]=_0x11600c,this['_branchId']=_0x57a5ab[_0x154f4f(0x20c)],this[_0x154f4f(0x1d3)]=_0x57a5ab[_0x154f4f(0x23b)],this['_attachmentLogId']=_0x57a5ab[_0x154f4f(0x198)],this['_organisationId']=_0x57a5ab[_0x154f4f(0x1cf)],this[_0x154f4f(0x197)]=_0x57a5ab[_0x154f4f(0x1b1)],this[_0x154f4f(0x1cb)]=_0x57a5ab[_0x154f4f(0x1a1)],this['_componentIdList']=_0x57a5ab[_0x154f4f(0x1e0)],this[_0x154f4f(0x1a5)]=_0x57a5ab[_0x154f4f(0x1c2)],this[_0x154f4f(0x212)]=new core_1[(_0x154f4f(0x1fe))]('veeva-deploy'),this['_veevaService']=new veeva_service_1[(_0x154f4f(0x20f))]({'connection':this[_0x154f4f(0x19e)],'logger':this['_logger']}),this[_0x154f4f(0x19a)]=new salesforce_service_1[(_0x154f4f(0x236))]({'connection':this[_0x154f4f(0x1e9)]}),this[_0x154f4f(0x1f5)]=new package_import_service_1[(_0x154f4f(0x222))]({'veevaService':this[_0x154f4f(0x233)],'connection':this[_0x154f4f(0x19e)],'logger':this[_0x154f4f(0x238)],'saveLog':this['saveLog'][_0x154f4f(0x21d)](this)}),this['_packageExportService']=new package_export_service_1[(_0x154f4f(0x1de))]({'veevaService':this[_0x154f4f(0x233)],'connection':this['_connectionVeeva'],'logger':this[_0x154f4f(0x238)]}),this['_vpkService']=new vpk_service_1[(_0x154f4f(0x207))]({'connection':this[_0x154f4f(0x19e)]});}async[a358_0x172057(0x219)](){const _0x4c6f00=a358_0x172057;try{const _0x35d880=await this['getFlosumComponents']();await this[_0x4c6f00(0x238)]['updateLog']();const _0x5baecb=await this['createBackup'](_0x35d880);await this[_0x4c6f00(0x1b5)](_0x5baecb);const _0x49c708=await this[_0x4c6f00(0x1a0)](_0x35d880),_0x46fad4=await this[_0x4c6f00(0x20e)](_0x49c708),_0x2876ce=await this['createVpk'](_0x46fad4);await this[_0x4c6f00(0x238)]['updateLog']();const _0x45ea07=await this['_packageImportService']['import'](_0x2876ce);await this['_logger'][_0x4c6f00(0x232)]();const _0x389e22=this[_0x4c6f00(0x22c)](_0x35d880,_0x45ea07[_0x4c6f00(0x1c8)]);await this[_0x4c6f00(0x196)](_0x389e22),await this[_0x4c6f00(0x23c)](_0x45ea07[_0x4c6f00(0x215)],![],_0x45ea07[_0x4c6f00(0x1ef)]);}catch(_0x4ef04f){await this[_0x4c6f00(0x204)](_0x4ef04f)['catch'](_0x3a906d=>this[_0x4c6f00(0x212)][_0x4c6f00(0x20d)](_0x3a906d));}}async[a358_0x172057(0x205)](){const _0x1e7702=a358_0x172057,_0x23c33a=new Set(this[_0x1e7702(0x1b8)]);this[_0x1e7702(0x238)]['log'](_0x1e7702(0x1ce));const _0x1dbe65=await new branch_component_history_flosum_component_retriever_1[(_0x1e7702(0x214))]({'value':this[_0x1e7702(0x1e7)],'salesforceService':this[_0x1e7702(0x19a)]})[_0x1e7702(0x1b6)](),_0x288fbc=_0x1dbe65[_0x1e7702(0x1b4)](_0x1b2ac9=>_0x23c33a[_0x1e7702(0x200)](_0x1b2ac9['id']));if(_0x288fbc['length']!==this['_componentIdList']['length'])throw new Error(_0x1e7702(0x21a));return _0x288fbc;}async[a358_0x172057(0x1d2)](_0x2b688d){const _0x396494=a358_0x172057;var _0x599d66;this[_0x396494(0x238)][_0x396494(0x1df)](_0x396494(0x1cd));const _0x547bbf=await new flosum_component_veeva_component_retriever_1[(_0x396494(0x1c5))]({'value':_0x2b688d,'veevaService':this[_0x396494(0x233)],'logger':this[_0x396494(0x238)]})[_0x396494(0x1b6)](),_0x1f629b=await this['_packageExportService'][_0x396494(0x1e2)](_0x547bbf,_0x396494(0x19f));if(_0x1f629b[_0x396494(0x1d8)]>0x1)throw new Error(_0x396494(0x226));return(_0x599d66=_0x1f629b[0x0])!==null&&_0x599d66!==void 0x0?_0x599d66:_0x1f629b[0x0]=new jszip_1['default'](),_0x1f629b[0x0]['generateAsync']({'type':'base64'});}async[a358_0x172057(0x1b5)](_0x3fab1f){const _0x23b8ae=a358_0x172057;this[_0x23b8ae(0x238)]['log'](_0x23b8ae(0x195));const _0x1f5a59={'Body':_0x3fab1f,'ContentType':'application/zip','ParentId':this[_0x23b8ae(0x1d3)],'Name':flosum_constants_1['FlosumConstants'][_0x23b8ae(0x1bf)]};await this[_0x23b8ae(0x1e9)][_0x23b8ae(0x1d1)](flosum_constants_1[_0x23b8ae(0x1e5)]['ENDPOINT_UPSERT_RECORD']+_0x23b8ae(0x1d6),_0x1f5a59);}async[a358_0x172057(0x1a0)](_0x1d7920){const _0x570ce6=a358_0x172057;this[_0x570ce6(0x238)][_0x570ce6(0x1df)](_0x570ce6(0x1ca));const _0x2e5411=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x570ce6(0x1e9)],_0x1d7920[_0x570ce6(0x1c1)](_0x3a3c0e=>_0x3a3c0e[_0x570ce6(0x1ea)])),_0x56a47f=await(0x0,fetch_attachments_1[_0x570ce6(0x1a0)])(_0x2e5411,this['_connectionSalesforce']);if(_0x56a47f['length']!==this[_0x570ce6(0x1b8)][_0x570ce6(0x1d8)])throw new Error(_0x570ce6(0x21b));return _0x56a47f[_0x570ce6(0x1c1)](_0x129011=>_0x129011['values']['Body']);}async[a358_0x172057(0x20e)](_0xc7fd5a){const _0x4cca30=a358_0x172057;this['_logger'][_0x4cca30(0x1df)](_0x4cca30(0x1f4));const _0x55b135=await new zip_creator_deploy_1[(_0x4cca30(0x21e))]({'attachmentBodies':_0xc7fd5a,'deploymentName':this['_deploymentName']})[_0x4cca30(0x219)](),_0x276db4=this[_0x4cca30(0x22f)]+'/'+(0x0,shortid_1['default'])()+_0x4cca30(0x1f6);return await(0x0,promises_1[_0x4cca30(0x1b7)])(_0x276db4,_0x55b135),_0x276db4;}async[a358_0x172057(0x1ff)](_0x589cf1){const _0x35ef43=a358_0x172057;this[_0x35ef43(0x238)]['log']('Create\x20vpk\x20package');const _0x3c96c5=await this['_vpkService'][_0x35ef43(0x1f3)](_0x589cf1),_0x567afa=this['_tempFolder']+_0x35ef43(0x228)+_0x589cf1[_0x35ef43(0x1e3)](_0x589cf1[_0x35ef43(0x1a9)]('/')+0x1);return await(0x0,promises_1[_0x35ef43(0x1b7)])(_0x567afa,_0x3c96c5),await this['_vpkService'][_0x35ef43(0x19c)](_0x567afa),_0x567afa;}async[a358_0x172057(0x201)](_0x1af7b8,_0xc5e4f1){const _0x43ae57=a358_0x172057;this['_logger'][_0x43ae57(0x1df)](_0x43ae57(0x1ad));const _0x260c4b={'Body':Buffer[_0x43ae57(0x199)](_0x1af7b8)['toString']('base64'),'ContentType':_0x43ae57(0x1d0),'ParentId':this[_0x43ae57(0x1d3)],'Name':_0xc5e4f1};await this[_0x43ae57(0x1e9)][_0x43ae57(0x1d1)](flosum_constants_1[_0x43ae57(0x1e5)][_0x43ae57(0x21f)]+_0x43ae57(0x1d6),_0x260c4b);}[a358_0x172057(0x22c)](_0x1ade1f,_0x424be9){const _0x17fdd9=a358_0x172057;this[_0x17fdd9(0x238)][_0x17fdd9(0x1df)](_0x17fdd9(0x22d));const _0xdb506b=_0x1ade1f[_0x17fdd9(0x1d7)]((_0x1e0ad1,_0x2afcdc)=>_0x1e0ad1['set']((_0x2afcdc[_0x17fdd9(0x1ed)]+'.'+_0x2afcdc[_0x17fdd9(0x1a4)])[_0x17fdd9(0x1b3)](),_0x2afcdc),new Map());return _0x424be9[_0x17fdd9(0x1c1)](_0x1880e=>{const _0x23dcf9=_0x17fdd9;this['_logger'][_0x23dcf9(0x1df)](_0x1880e['type']+'.'+_0x1880e['name']+_0x23dcf9(0x203)+_0x1880e[_0x23dcf9(0x1f0)]);const _0x4bbea1=(_0x1880e[_0x23dcf9(0x1c3)]+'.'+_0x1880e[_0x23dcf9(0x210)])[_0x23dcf9(0x1b3)](),_0x119ac6=_0xdb506b[_0x23dcf9(0x1c9)](_0x4bbea1);return{[constants_1[_0x23dcf9(0x208)]+_0x23dcf9(0x21c)]:_0x23dcf9(0x1e1),[constants_1['FLOSUM_NAMESPACE']+_0x23dcf9(0x1b9)]:_0x1880e['status']===status_enums_1[_0x23dcf9(0x1b2)][_0x23dcf9(0x1a7)]?_0x23dcf9(0x22e):'Failure',[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x1880e['deploymentAction'],[constants_1[_0x23dcf9(0x208)]+_0x23dcf9(0x206)]:_0x1880e[_0x23dcf9(0x210)],[constants_1['FLOSUM_NAMESPACE']+_0x23dcf9(0x1cc)]:_0x1880e[_0x23dcf9(0x1c3)],[constants_1[_0x23dcf9(0x208)]+_0x23dcf9(0x194)]:_0x1880e[_0x23dcf9(0x220)],[constants_1['FLOSUM_NAMESPACE']+_0x23dcf9(0x1c0)]:this[_0x23dcf9(0x1fc)],[constants_1[_0x23dcf9(0x208)]+_0x23dcf9(0x1fb)]:this[_0x23dcf9(0x1d3)],[constants_1['FLOSUM_NAMESPACE']+_0x23dcf9(0x1db)]:_0x119ac6['componentHistoryId']};});}async[a358_0x172057(0x196)](_0x2b195a){const _0x190ae0=a358_0x172057;this[_0x190ae0(0x238)][_0x190ae0(0x1df)]('Save\x20Deployment\x20Results');const _0x54a89b=await this[_0x190ae0(0x19a)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+_0x190ae0(0x1f9),_0x2b195a),_0x14bef9=_0x54a89b[_0x190ae0(0x1b4)](_0x440093=>!_0x440093[_0x190ae0(0x237)])[_0x190ae0(0x1c1)](_0x5849c7=>_0x5849c7[_0x190ae0(0x1ac)])[_0x190ae0(0x227)]();if(_0x14bef9[_0x190ae0(0x1d8)])throw new salesforce_dml_error_1[(_0x190ae0(0x211))](_0x14bef9);}async[a358_0x172057(0x204)](_0x4fd352){const _0xd9c46f=a358_0x172057;this[_0xd9c46f(0x238)]['logError'](_0x4fd352),await this[_0xd9c46f(0x238)][_0xd9c46f(0x232)](),await this[_0xd9c46f(0x23c)](![],!![],'');}async[a358_0x172057(0x23c)](_0x55e553,_0x1822d4,_0x31f7fd){const _0xe526b3=a358_0x172057,_0x4591a6=_0xe526b3(0x1fa)+this[_0xe526b3(0x19d)]+'/'+this['_metadataLogId']+_0xe526b3(0x1ec)+_0xe526b3(0x20a)+_0xe526b3(0x20b),_0x5bd09d=_0xe526b3(0x1fa)+this[_0xe526b3(0x19d)]+'/'+this[_0xe526b3(0x1fc)]+'\x20>'+this[_0xe526b3(0x1cb)]+_0xe526b3(0x1c4),_0x115a6a=_0x4591a6+_0xe526b3(0x1dc)+_0x5bd09d+_0xe526b3(0x1e8),_0xb8294d={[constants_1[_0xe526b3(0x208)]+_0xe526b3(0x231)]:_0x115a6a,[constants_1[_0xe526b3(0x208)]+_0xe526b3(0x202)]:new Date(),[constants_1[_0xe526b3(0x208)]+_0xe526b3(0x213)]:this[_0xe526b3(0x1e7)],[constants_1['FLOSUM_NAMESPACE']+_0xe526b3(0x1ab)]:_0xe526b3(0x1bc),[constants_1[_0xe526b3(0x208)]+_0xe526b3(0x1fd)]:_0xe526b3(0x1da),[constants_1[_0xe526b3(0x208)]+_0xe526b3(0x216)]:this[_0xe526b3(0x1fc)]},_0x150a48={[constants_1[_0xe526b3(0x208)]+_0xe526b3(0x1e6)]:!_0x55e553,[constants_1[_0xe526b3(0x208)]+_0xe526b3(0x1a2)]:_0x55e553,[constants_1['FLOSUM_NAMESPACE']+_0xe526b3(0x1b9)]:_0x1822d4?status_enums_1[_0xe526b3(0x235)][_0xe526b3(0x23a)]:status_enums_1[_0xe526b3(0x235)][_0xe526b3(0x22b)],[constants_1[_0xe526b3(0x208)]+'Job_Completed__c']:!![],[constants_1[_0xe526b3(0x208)]+_0xe526b3(0x1f2)]:_0x31f7fd};await this[_0xe526b3(0x1e9)][_0xe526b3(0x1a6)](flosum_constants_1[_0xe526b3(0x1e5)][_0xe526b3(0x21f)]+'/'+constants_1[_0xe526b3(0x208)]+_0xe526b3(0x229)+this[_0xe526b3(0x1d3)],_0x150a48),await this['_connectionSalesforce'][_0xe526b3(0x1d1)](flosum_constants_1[_0xe526b3(0x1e5)][_0xe526b3(0x21f)]+'/'+constants_1[_0xe526b3(0x208)]+_0xe526b3(0x1b0),_0xb8294d),this[_0xe526b3(0x238)]['log'](_0xe526b3(0x1d5)+(_0x55e553?_0xe526b3(0x1d9):_0xe526b3(0x218))+'.'),await this[_0xe526b3(0x238)]['updateLog']();}}exports['DeployService']=DeployService;