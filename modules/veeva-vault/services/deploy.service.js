const a389_0x89bcad=a389_0x4cd0;(function(_0x1d56c0,_0x10f8b1){const _0x41c016=a389_0x4cd0,_0x7a6ee1=_0x1d56c0();while(!![]){try{const _0x136030=-parseInt(_0x41c016(0xfa))/0x1+parseInt(_0x41c016(0x141))/0x2+-parseInt(_0x41c016(0x135))/0x3+parseInt(_0x41c016(0x19a))/0x4*(-parseInt(_0x41c016(0x15c))/0x5)+parseInt(_0x41c016(0x14a))/0x6*(-parseInt(_0x41c016(0x170))/0x7)+parseInt(_0x41c016(0x19f))/0x8+-parseInt(_0x41c016(0x157))/0x9*(-parseInt(_0x41c016(0x174))/0xa);if(_0x136030===_0x10f8b1)break;else _0x7a6ee1['push'](_0x7a6ee1['shift']());}catch(_0x5a725e){_0x7a6ee1['push'](_0x7a6ee1['shift']());}}}(a389_0x39cf,0x27aa7));const a389_0x59dfa6=(function(){let _0x32a13f=!![];return function(_0x12bfef,_0x1536d3){const _0x21433e=_0x32a13f?function(){const _0x58eb17=a389_0x4cd0;if(_0x1536d3){const _0x140349=_0x1536d3[_0x58eb17(0x113)](_0x12bfef,arguments);return _0x1536d3=null,_0x140349;}}:function(){};return _0x32a13f=![],_0x21433e;};}()),a389_0x116159=a389_0x59dfa6(this,function(){const _0x111ead=a389_0x4cd0;return a389_0x116159['toString']()[_0x111ead(0x162)](_0x111ead(0x107))[_0x111ead(0x140)]()[_0x111ead(0x175)](a389_0x116159)[_0x111ead(0x162)](_0x111ead(0x107));});a389_0x116159();'use strict';var __importDefault=this&&this[a389_0x89bcad(0x199)]||function(_0x380847){return _0x380847&&_0x380847['__esModule']?_0x380847:{'default':_0x380847};};Object[a389_0x89bcad(0x149)](exports,'__esModule',{'value':!![]}),exports[a389_0x89bcad(0x10b)]=void 0x0;const jszip_1=__importDefault(require(a389_0x89bcad(0xff))),promises_1=require(a389_0x89bcad(0x13b)),constants_1=require(a389_0x89bcad(0x191)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a389_0x89bcad(0x142)),salesforce_service_1=require('./salesforce.service'),core_1=require(a389_0x89bcad(0x17c)),status_enums_1=require(a389_0x89bcad(0x179)),salesforce_dml_error_1=require(a389_0x89bcad(0x10c)),shortid_1=__importDefault(require(a389_0x89bcad(0x177))),fetch_attachments_1=require(a389_0x89bcad(0x12b)),package_import_service_1=require(a389_0x89bcad(0x133)),branch_component_history_flosum_component_retriever_1=require(a389_0x89bcad(0x171)),flosum_component_veeva_component_retriever_1=require(a389_0x89bcad(0xf8)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a389_0x89bcad(0x13e)),zip_creator_deploy_1=require(a389_0x89bcad(0x16c));class DeployService{constructor(_0x319cab,_0x428a51,_0x19e30e,_0x4ce2a4,_0x182d4f,_0x15ff64){const _0x20fdda=a389_0x89bcad;this['_connectionSalesforce']=_0x428a51,this[_0x20fdda(0x173)]=_0x19e30e,this[_0x20fdda(0x158)]=_0x4ce2a4,this['_tempFolder']=_0x182d4f,this[_0x20fdda(0x115)]=_0x15ff64,this['_branchId']=_0x319cab[_0x20fdda(0x166)],this[_0x20fdda(0x124)]=_0x319cab[_0x20fdda(0x161)],this[_0x20fdda(0x160)]=_0x319cab[_0x20fdda(0x190)],this[_0x20fdda(0x17f)]=_0x319cab[_0x20fdda(0x136)],this[_0x20fdda(0x17b)]=_0x319cab[_0x20fdda(0x185)],this[_0x20fdda(0x104)]=_0x319cab['organisationName'],this[_0x20fdda(0x120)]=_0x319cab[_0x20fdda(0x11b)],this[_0x20fdda(0xfb)]=_0x319cab[_0x20fdda(0x196)],this[_0x20fdda(0x163)]=new core_1[(_0x20fdda(0x155))](_0x20fdda(0x11e)),this[_0x20fdda(0x101)]=new veeva_service_1['VeevaService']({'connection':this[_0x20fdda(0x173)],'logger':this[_0x20fdda(0x158)]}),this['_salesforceService']=new salesforce_service_1[(_0x20fdda(0x134))]({'connection':this[_0x20fdda(0x186)]}),this[_0x20fdda(0x192)]=new package_import_service_1[(_0x20fdda(0x1a2))]({'veevaService':this[_0x20fdda(0x101)],'connection':this['_connectionVeeva'],'logger':this[_0x20fdda(0x158)],'saveLog':this[_0x20fdda(0x11f)][_0x20fdda(0x11d)](this)}),this[_0x20fdda(0x138)]=new package_export_service_1[(_0x20fdda(0x169))]({'veevaService':this['_veevaService'],'connection':this[_0x20fdda(0x173)],'logger':this[_0x20fdda(0x158)]}),this[_0x20fdda(0x187)]=new vpk_service_1['VpkService']({'connection':this[_0x20fdda(0x173)]});}async[a389_0x89bcad(0x18f)](){const _0x2571fb=a389_0x89bcad;try{const _0x109324=await this[_0x2571fb(0x108)]();await this[_0x2571fb(0x158)]['updateLog']();const _0x4a18c5=await this[_0x2571fb(0xf9)](_0x109324);await this['saveBackup'](_0x4a18c5);const _0x155cc5=await this[_0x2571fb(0x17a)](_0x109324),_0x1083be=await this[_0x2571fb(0x111)](_0x155cc5),_0x3eab81=await this['createVpk'](_0x1083be);await this[_0x2571fb(0x158)][_0x2571fb(0x195)]();const _0x3df699=await this[_0x2571fb(0x192)][_0x2571fb(0x19d)](_0x3eab81);await this[_0x2571fb(0x158)][_0x2571fb(0x195)]();const _0x63ac6c=this[_0x2571fb(0x112)](_0x109324,_0x3df699[_0x2571fb(0x13d)]);await this[_0x2571fb(0x12d)](_0x63ac6c),await this['finishDeploy'](_0x3df699[_0x2571fb(0x178)],![],_0x3df699[_0x2571fb(0x119)]);}catch(_0x456624){await this[_0x2571fb(0x148)](_0x456624)[_0x2571fb(0x110)](_0x27a6b9=>this['_systemLogger'][_0x2571fb(0x189)](_0x27a6b9));}}async[a389_0x89bcad(0x108)](){const _0x23d937=a389_0x89bcad,_0x5d7ee4=new Set(this[_0x23d937(0x120)]);this[_0x23d937(0x158)][_0x23d937(0x152)]('Retrieving\x20components');const _0x1e56d5=await new branch_component_history_flosum_component_retriever_1[(_0x23d937(0x156))]({'value':this['_branchId'],'salesforceService':this['_salesforceService']})[_0x23d937(0xfc)](),_0x2dd483=_0x1e56d5[_0x23d937(0xfd)](_0x1b9f1d=>_0x5d7ee4[_0x23d937(0x197)](_0x1b9f1d['id']));if(_0x2dd483[_0x23d937(0x18a)]!==this['_componentIdList']['length'])throw new Error(_0x23d937(0x12c));return _0x2dd483;}async[a389_0x89bcad(0xf9)](_0x5d4457){const _0x1d19ab=a389_0x89bcad;var _0x15a2c5;this[_0x1d19ab(0x158)][_0x1d19ab(0x152)](_0x1d19ab(0x114));const _0x3ed47c=await new flosum_component_veeva_component_retriever_1[(_0x1d19ab(0x12a))]({'value':_0x5d4457,'veevaService':this[_0x1d19ab(0x101)],'logger':this[_0x1d19ab(0x158)]})[_0x1d19ab(0xfc)](),_0x16cd45=await this[_0x1d19ab(0x138)][_0x1d19ab(0x131)](_0x3ed47c,_0x1d19ab(0x176));if(_0x16cd45[_0x1d19ab(0x18a)]>0x1)throw new Error(_0x1d19ab(0x12e));return(_0x15a2c5=_0x16cd45[0x0])!==null&&_0x15a2c5!==void 0x0?_0x15a2c5:_0x16cd45[0x0]=new jszip_1[(_0x1d19ab(0xf7))](),_0x16cd45[0x0][_0x1d19ab(0x106)]({'type':_0x1d19ab(0x193)});}async[a389_0x89bcad(0x132)](_0x280eda){const _0x39bf33=a389_0x89bcad;this[_0x39bf33(0x158)][_0x39bf33(0x152)](_0x39bf33(0x105));const _0x3fcf7b={'Body':_0x280eda,'ContentType':_0x39bf33(0x18d),'ParentId':this[_0x39bf33(0x124)],'Name':flosum_constants_1[_0x39bf33(0x14c)]['BACKUP_ZIP_NAME']};await this['_connectionSalesforce'][_0x39bf33(0x10d)](flosum_constants_1[_0x39bf33(0x14c)]['ENDPOINT_UPSERT_RECORD']+_0x39bf33(0x194),_0x3fcf7b);}async[a389_0x89bcad(0x17a)](_0x28d68e){const _0x496d86=a389_0x89bcad;this[_0x496d86(0x158)]['log'](_0x496d86(0x19c));const _0x3b6250=await(0x0,fetch_attachments_1[_0x496d86(0x125)])(this[_0x496d86(0x186)],_0x28d68e['map'](_0x16824e=>_0x16824e[_0x496d86(0x145)])),_0x2ea8ed=await(0x0,fetch_attachments_1[_0x496d86(0x17a)])(_0x3b6250,this[_0x496d86(0x186)]);if(_0x2ea8ed[_0x496d86(0x18a)]!==this['_componentIdList'][_0x496d86(0x18a)])throw new Error(_0x496d86(0x100));return _0x2ea8ed['map'](_0x40e7ec=>_0x40e7ec['values'][_0x496d86(0x109)]);}async[a389_0x89bcad(0x111)](_0x38b8b3){const _0x3465fc=a389_0x89bcad;this['_logger']['log']('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x569377=await new zip_creator_deploy_1[(_0x3465fc(0x146))]({'attachmentBodies':_0x38b8b3,'deploymentName':this[_0x3465fc(0xfb)]})[_0x3465fc(0x18f)](),_0x4a8e07=this[_0x3465fc(0x11a)]+'/'+(0x0,shortid_1['default'])()+'.zip';return await(0x0,promises_1[_0x3465fc(0x15f)])(_0x4a8e07,_0x569377),_0x4a8e07;}async[a389_0x89bcad(0x118)](_0x4ac2d4){const _0x21536d=a389_0x89bcad;this[_0x21536d(0x158)][_0x21536d(0x152)](_0x21536d(0x14d));const _0x4c848b=await this[_0x21536d(0x187)]['generate'](_0x4ac2d4),_0x4e30b8=this[_0x21536d(0x11a)]+_0x21536d(0x10a)+_0x4ac2d4[_0x21536d(0x10e)](_0x4ac2d4[_0x21536d(0x143)]('/')+0x1);return await(0x0,promises_1[_0x21536d(0x15f)])(_0x4e30b8,_0x4c848b),await this[_0x21536d(0x187)][_0x21536d(0x126)](_0x4e30b8),_0x4e30b8;}async[a389_0x89bcad(0x11f)](_0x26df16,_0x38ccd9){const _0x58fce4=a389_0x89bcad;this[_0x58fce4(0x158)]['log'](_0x58fce4(0x15b));const _0x291f00={'Body':Buffer[_0x58fce4(0x184)](_0x26df16)['toString'](_0x58fce4(0x193)),'ContentType':_0x58fce4(0x16a),'ParentId':this['_metadataLogId'],'Name':_0x38ccd9};await this[_0x58fce4(0x186)]['post'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0x58fce4(0x194),_0x291f00);}[a389_0x89bcad(0x112)](_0x4417f0,_0x51b9bd){const _0x51e062=a389_0x89bcad;this[_0x51e062(0x158)][_0x51e062(0x152)](_0x51e062(0x13a));const _0x3bea53=_0x4417f0[_0x51e062(0x16e)]((_0x4995c7,_0x2dfd89)=>_0x4995c7[_0x51e062(0x154)]((_0x2dfd89[_0x51e062(0xfe)]+'.'+_0x2dfd89['componentName'])[_0x51e062(0x15d)](),_0x2dfd89),new Map());return _0x51b9bd['map'](_0x1e7775=>{const _0x5dfacd=_0x51e062;this[_0x5dfacd(0x158)][_0x5dfacd(0x152)](_0x1e7775['type']+'.'+_0x1e7775[_0x5dfacd(0x17e)]+_0x5dfacd(0x150)+_0x1e7775[_0x5dfacd(0x151)]);const _0x403c07=(_0x1e7775['type']+'.'+_0x1e7775[_0x5dfacd(0x17e)])['toLowerCase'](),_0x33a7b9=_0x3bea53['get'](_0x403c07);return{[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x116)]:_0x5dfacd(0x13f),[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x198)]:_0x1e7775['status']===status_enums_1[_0x5dfacd(0x130)][_0x5dfacd(0x153)]?'Success':_0x5dfacd(0x16d),[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x16f)]:_0x1e7775['deploymentAction'],[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x121)]:_0x1e7775[_0x5dfacd(0x17e)],[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x167)]:_0x1e7775[_0x5dfacd(0x159)],[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x127)]:_0x1e7775[_0x5dfacd(0x15e)],[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x19b)]:this[_0x5dfacd(0x17f)],[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x18e)]:this[_0x5dfacd(0x124)],[constants_1[_0x5dfacd(0x188)]+_0x5dfacd(0x122)]:_0x33a7b9['componentHistoryId']};});}async[a389_0x89bcad(0x12d)](_0x4cbfaa){const _0x38e3ff=a389_0x89bcad;this['_logger'][_0x38e3ff(0x152)](_0x38e3ff(0x19e));const _0x1d39de=await this[_0x38e3ff(0x15a)][_0x38e3ff(0x128)](constants_1[_0x38e3ff(0x188)]+_0x38e3ff(0x103),_0x4cbfaa),_0x32a57b=_0x1d39de['filter'](_0x5a3b02=>!_0x5a3b02[_0x38e3ff(0x1a1)])[_0x38e3ff(0x147)](_0x15e6c6=>_0x15e6c6[_0x38e3ff(0x18b)])[_0x38e3ff(0x16b)]();if(_0x32a57b[_0x38e3ff(0x18a)])throw new salesforce_dml_error_1[(_0x38e3ff(0x1a0))](_0x32a57b);}async[a389_0x89bcad(0x148)](_0x4c88e2){const _0x2b4c12=a389_0x89bcad;this[_0x2b4c12(0x158)][_0x2b4c12(0x10f)](_0x4c88e2),await this[_0x2b4c12(0x158)][_0x2b4c12(0x195)](),await this['finishDeploy'](![],!![],'');}async[a389_0x89bcad(0x139)](_0x109705,_0x5254c7,_0x1a3059){const _0x4b2c08=a389_0x89bcad,_0x3e0720=_0x4b2c08(0x11c)+this['_instanceUrl']+'/'+this[_0x4b2c08(0x124)]+_0x4b2c08(0x181)+'Veeva\x20Deployment'+_0x4b2c08(0x168),_0x54b6b0=_0x4b2c08(0x11c)+this[_0x4b2c08(0x115)]+'/'+this['_organisationId']+'\x20>'+this['_organisationName']+'</a>',_0x227a6a=_0x3e0720+_0x4b2c08(0x18c)+_0x54b6b0+_0x4b2c08(0x1a3),_0x288c4e={[constants_1['FLOSUM_NAMESPACE']+'Action__c']:_0x227a6a,[constants_1[_0x4b2c08(0x188)]+_0x4b2c08(0x172)]:new Date(),[constants_1[_0x4b2c08(0x188)]+_0x4b2c08(0x12f)]:this[_0x4b2c08(0x129)],[constants_1[_0x4b2c08(0x188)]+'Activity_Item__c']:_0x4b2c08(0x164),[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0x4b2c08(0x17d),[constants_1[_0x4b2c08(0x188)]+_0x4b2c08(0x13c)]:this[_0x4b2c08(0x17f)]},_0xead864={[constants_1[_0x4b2c08(0x188)]+_0x4b2c08(0x14f)]:!_0x109705,[constants_1[_0x4b2c08(0x188)]+_0x4b2c08(0x123)]:_0x109705,[constants_1[_0x4b2c08(0x188)]+_0x4b2c08(0x198)]:_0x5254c7?status_enums_1['MetadataLogStatus'][_0x4b2c08(0x14b)]:status_enums_1[_0x4b2c08(0x117)][_0x4b2c08(0x165)],[constants_1['FLOSUM_NAMESPACE']+_0x4b2c08(0x144)]:!![],[constants_1[_0x4b2c08(0x188)]+_0x4b2c08(0x137)]:_0x1a3059};await this['_connectionSalesforce'][_0x4b2c08(0x102)](flosum_constants_1[_0x4b2c08(0x14c)][_0x4b2c08(0x180)]+'/'+constants_1[_0x4b2c08(0x188)]+_0x4b2c08(0x14e)+this['_metadataLogId'],_0xead864),await this[_0x4b2c08(0x186)][_0x4b2c08(0x10d)](flosum_constants_1[_0x4b2c08(0x14c)][_0x4b2c08(0x180)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0x288c4e),this[_0x4b2c08(0x158)]['log']('Deploy\x20completed\x20'+(_0x109705?_0x4b2c08(0x182):_0x4b2c08(0x183))+'.'),await this[_0x4b2c08(0x158)][_0x4b2c08(0x195)]();}}function a389_0x4cd0(_0x7a52ca,_0x3a107d){const _0x3ccf58=a389_0x39cf();return a389_0x4cd0=function(_0x116159,_0x59dfa6){_0x116159=_0x116159-0xf7;let _0x39cf84=_0x3ccf58[_0x116159];return _0x39cf84;},a389_0x4cd0(_0x7a52ca,_0x3a107d);}function a389_0x39cf(){const _0x3f9e43=['ZipCreatorDeploy','map','finishDeployWithError','defineProperty','306seIaDm','EXCEPTION','FlosumConstants','Create\x20vpk\x20package','Metadata_Log__c/','Is_Error__c','\x20:\x20','status','log','DEPLOYED','set','Logger','BranchComponentHistoryFlosumComponentRetriever','45IxYQGZ','_logger','type','_salesforceService','Save\x20log','28295yqMHdh','toLowerCase','stepName','writeFile','_attachmentLogId','metadataLogId','search','_systemLogger','Branch','COMPLETED','branchId','Component_Type__c','\x20</a>','PackageExportService','text/plain','flat','../classes/deploy/zip-creator.deploy','Failure','reduce','Result__c','3115BpJZMs','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Date__c','_connectionVeeva','740870AxvclR','constructor','Backup','shortid','isDeployed','../enums/status.enums','retrieveAttachments','_timeZone','../../../core','Deployment','name','_organisationId','ENDPOINT_UPSERT_RECORD','\x20>\x20','successfully','with\x20error','from','timeZone','_connectionSalesforce','_vpkService','FLOSUM_NAMESPACE','error','length','errors','\x20of\x20branch\x20to\x20Organization\x20','application/zip','Metadata_Log__c','execute','attachmentLogId','../../../constants','_packageImportService','base64','/Attachment','updateLog','deploymentName','has','Status__c','__importDefault','204VaTqTK','Org__c','Retrieving\x20attachments','import','Save\x20Deployment\x20Results','1239048ZvQRgo','SalesforceDmlError','success','PackageImportService','\x20has\x20been\x20created.','default','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','createBackup','91590JBdLAL','_deploymentName','retrieve','filter','componentType','jszip','Cannot\x20retrievers\x20all\x20attachments','_veevaService','patch','Deployment_Result__c','_organisationName','Save\x20Backup\x20to\x20Salesforce','generateAsync','(((.+)+)+)+$','getFlosumComponents','Body','/vpk__','DeployService','../classes/errors/salesforce-dml-error','post','slice','logError','catch','createZip','formFlosumDeploymentResults','apply','Create\x20Backup','_instanceUrl','Type__c','MetadataLogStatus','createVpk','packageId','_tempFolder','componentIdList','<a\x20href=','bind','veeva-deploy','saveLog','_componentIdList','Component_Name__c','Component_History__c','Succeed__c','_metadataLogId','fetchAttachmentsDetailsByParentId','validate','Veeva_Step_Name__c','insertMultipleRecords','_branchId','FlosumComponentVeevaComponentRetriever','../../shared/utils/fetch-attachments','Cannot\x20retrieve\x20all\x20components.','saveDeploymentResults','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Branch__c','PackageComponentStatus','export','saveBackup','./package-import.service','SalesforceService','212598kopTHe','organisationId','External_Deployment_Id__c','_packageExportService','finishDeploy','Form\x20Deployment\x20Results','fs/promises','TargetId__c','packageComponentList','./vpk.service','Deployment\x20Result','toString','221830ZUUEgF','./veeva.service','lastIndexOf','Job_Completed__c','componentHistoryId'];a389_0x39cf=function(){return _0x3f9e43;};return a389_0x39cf();}exports[a389_0x89bcad(0x10b)]=DeployService;