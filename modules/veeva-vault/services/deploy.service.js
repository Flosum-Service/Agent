const a353_0x173670=a353_0x3357;(function(_0x1fa99b,_0xcc7383){const _0x4e16d8=a353_0x3357,_0x542a39=_0x1fa99b();while(!![]){try{const _0x363e5b=-parseInt(_0x4e16d8(0x141))/0x1+-parseInt(_0x4e16d8(0xc6))/0x2*(-parseInt(_0x4e16d8(0x108))/0x3)+-parseInt(_0x4e16d8(0x135))/0x4*(-parseInt(_0x4e16d8(0x12b))/0x5)+parseInt(_0x4e16d8(0xd7))/0x6*(-parseInt(_0x4e16d8(0x163))/0x7)+parseInt(_0x4e16d8(0x125))/0x8*(-parseInt(_0x4e16d8(0x164))/0x9)+-parseInt(_0x4e16d8(0xf0))/0xa*(-parseInt(_0x4e16d8(0x167))/0xb)+parseInt(_0x4e16d8(0xc7))/0xc;if(_0x363e5b===_0xcc7383)break;else _0x542a39['push'](_0x542a39['shift']());}catch(_0x33316d){_0x542a39['push'](_0x542a39['shift']());}}}(a353_0x5594,0x414e5));function a353_0x3357(_0x2a5d83,_0x37d711){const _0x1e08e7=a353_0x5594();return a353_0x3357=function(_0x3ba267,_0x310b4e){_0x3ba267=_0x3ba267-0xc5;let _0x55941d=_0x1e08e7[_0x3ba267];return _0x55941d;},a353_0x3357(_0x2a5d83,_0x37d711);}const a353_0x310b4e=(function(){let _0xe2fc9b=!![];return function(_0x308287,_0x146668){const _0x962e53=_0xe2fc9b?function(){const _0xccc8a0=a353_0x3357;if(_0x146668){const _0x220b6c=_0x146668[_0xccc8a0(0xdc)](_0x308287,arguments);return _0x146668=null,_0x220b6c;}}:function(){};return _0xe2fc9b=![],_0x962e53;};}()),a353_0x3ba267=a353_0x310b4e(this,function(){const _0x30e986=a353_0x3357;return a353_0x3ba267['toString']()[_0x30e986(0x11c)](_0x30e986(0xe6))['toString']()[_0x30e986(0xdd)](a353_0x3ba267)[_0x30e986(0x11c)](_0x30e986(0xe6));});a353_0x3ba267();'use strict';var __importDefault=this&&this[a353_0x173670(0xed)]||function(_0x2c2bf0){const _0x5ce1c5=a353_0x173670;return _0x2c2bf0&&_0x2c2bf0[_0x5ce1c5(0x114)]?_0x2c2bf0:{'default':_0x2c2bf0};};Object[a353_0x173670(0x103)](exports,a353_0x173670(0x114),{'value':!![]}),exports[a353_0x173670(0xe3)]=void 0x0;const jszip_1=__importDefault(require(a353_0x173670(0xd6))),promises_1=require(a353_0x173670(0x10f)),constants_1=require('../../../constants'),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a353_0x173670(0xf2)),salesforce_service_1=require(a353_0x173670(0xda)),core_1=require(a353_0x173670(0x113)),status_enums_1=require(a353_0x173670(0x15a)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a353_0x173670(0x105))),fetch_attachments_1=require(a353_0x173670(0xe5)),package_import_service_1=require(a353_0x173670(0xf1)),branch_component_history_flosum_component_retriever_1=require(a353_0x173670(0xfe)),flosum_component_veeva_component_retriever_1=require(a353_0x173670(0x112)),package_export_service_1=require(a353_0x173670(0x165)),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require(a353_0x173670(0x14a));function a353_0x5594(){const _0x4ea853=['componentName','Logger','_organisationId','_systemLogger','error','post','../classes/deploy/zip-creator.deploy','_tempFolder','</a>','_veevaService','formFlosumDeploymentResults','isDeployed','toString','Component_Type__c','_salesforceService','componentType','_packageExportService','VpkService','PackageImportService','Deploy\x20completed\x20','FLOSUM_NAMESPACE','default','../enums/status.enums','Cannot\x20retrievers\x20all\x20attachments','Retrieving\x20attachments','Component_Name__c','COMPLETED','Action__c','ENDPOINT_UPSERT_RECORD','errors','Deployment\x20Result','7hOxtoE','39789JlhIVN','./package-export.service','get','5104fCaAPE','Veeva\x20Deployment','success','2jbycmh','8111736zXwyPO','flat','timeZone','_packageImportService','metadataLogId','_attachmentLogId','_vpkService','SalesforceDmlError','_deploymentName','Metadata_Log__c/','FlosumConstants','filter','Activity_Type__c','organisationName','\x20</a>','jszip','2060934BsGvbs','/vpk__','_connectionVeeva','./salesforce.service','reduce','apply','constructor','componentIdList','/Attachment','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Date__c','Log__c','DeployService','ZipCreatorDeploy','../../shared/utils/fetch-attachments','(((.+)+)+)+$','retrieveAttachments','Metadata_Log__c','Backup','createBackup','BACKUP_ZIP_NAME','Save\x20log','__importDefault','status','EXCEPTION','3830BrrItR','./package-import.service','./veeva.service','slice','toLowerCase','Is_Error__c','createZip','packageId','_timeZone','Veeva_Step_Name__c','map','SalesforceService','saveLog','\x20>\x20','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','_componentIdList','_branchId','MetadataLogStatus','name','defineProperty','bind','shortid','Retrieving\x20components','_organisationName','1252038zOWEUH','import','_metadataLogId','VeevaService','generate','updateLog','base64','fs/promises','_connectionSalesforce','Join\x20all\x20mdl\x20into\x20one\x20zip','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','../../../core','__esModule','fetchAttachmentsDetailsByParentId','application/zip','<a\x20href=','Failure','saveDeploymentResults','Branch__c','createVpk','search','attachmentLogId','saveBackup','has','logError','log','execute','_instanceUrl','from','536DOsGOU','finishDeployWithError','Job_Completed__c','writeFile','insertMultipleRecords','getFlosumComponents','341945xjlntG','type','values','length','Success','_logger','successfully','.zip','Branch','Component_History__c','8MPUQjI','DEPLOYED','generateAsync','Create\x20Backup','lastIndexOf','Body','with\x20error','finishDeploy','BranchComponentHistoryFlosumComponentRetriever','\x20has\x20been\x20created.','Save\x20Deployment\x20Results','deploymentAction','500625JfyHoF','Form\x20Deployment\x20Results','set'];a353_0x5594=function(){return _0x4ea853;};return a353_0x5594();}class DeployService{constructor(_0x29ba06,_0x224a2b,_0x11a1c4,_0x222839,_0x33dc8b,_0x9bf7fd){const _0x179e94=a353_0x173670;this['_connectionSalesforce']=_0x224a2b,this[_0x179e94(0xd9)]=_0x11a1c4,this['_logger']=_0x222839,this['_tempFolder']=_0x33dc8b,this[_0x179e94(0x123)]=_0x9bf7fd,this['_branchId']=_0x29ba06['branchId'],this[_0x179e94(0x10a)]=_0x29ba06[_0x179e94(0xcb)],this[_0x179e94(0xcc)]=_0x29ba06[_0x179e94(0x11d)],this['_organisationId']=_0x29ba06['organisationId'],this[_0x179e94(0xf8)]=_0x29ba06[_0x179e94(0xc9)],this[_0x179e94(0x107)]=_0x29ba06[_0x179e94(0xd4)],this['_componentIdList']=_0x29ba06[_0x179e94(0xde)],this[_0x179e94(0xcf)]=_0x29ba06['deploymentName'],this['_systemLogger']=new core_1[(_0x179e94(0x145))]('veeva-deploy'),this[_0x179e94(0x14d)]=new veeva_service_1[(_0x179e94(0x10b))]({'connection':this[_0x179e94(0xd9)],'logger':this['_logger']}),this[_0x179e94(0x152)]=new salesforce_service_1[(_0x179e94(0xfb))]({'connection':this['_connectionSalesforce']}),this['_packageImportService']=new package_import_service_1[(_0x179e94(0x156))]({'veevaService':this[_0x179e94(0x14d)],'connection':this[_0x179e94(0xd9)],'logger':this[_0x179e94(0x130)],'saveLog':this['saveLog'][_0x179e94(0x104)](this)}),this[_0x179e94(0x154)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x179e94(0x14d)],'connection':this['_connectionVeeva'],'logger':this[_0x179e94(0x130)]}),this[_0x179e94(0xcd)]=new vpk_service_1[(_0x179e94(0x155))]({'connection':this[_0x179e94(0xd9)]});}async[a353_0x173670(0x122)](){const _0x54324f=a353_0x173670;try{const _0x125bcf=await this['getFlosumComponents']();await this[_0x54324f(0x130)][_0x54324f(0x10d)]();const _0x131939=await this[_0x54324f(0xea)](_0x125bcf);await this[_0x54324f(0x11e)](_0x131939);const _0x5378b2=await this[_0x54324f(0xe7)](_0x125bcf),_0x50f4e6=await this[_0x54324f(0xf6)](_0x5378b2),_0x5bfad4=await this[_0x54324f(0x11b)](_0x50f4e6);await this[_0x54324f(0x130)][_0x54324f(0x10d)]();const _0x72b726=await this[_0x54324f(0xca)][_0x54324f(0x109)](_0x5bfad4);await this[_0x54324f(0x130)][_0x54324f(0x10d)]();const _0x1fa66f=this[_0x54324f(0x14e)](_0x125bcf,_0x72b726['packageComponentList']);await this['saveDeploymentResults'](_0x1fa66f),await this[_0x54324f(0x13c)](_0x72b726[_0x54324f(0x14f)],![],_0x72b726[_0x54324f(0xf7)]);}catch(_0x395a14){await this[_0x54324f(0x126)](_0x395a14)['catch'](_0x3bf275=>this[_0x54324f(0x147)][_0x54324f(0x148)](_0x3bf275));}}async[a353_0x173670(0x12a)](){const _0x3e264d=a353_0x173670,_0x388a02=new Set(this[_0x3e264d(0xff)]);this['_logger']['log'](_0x3e264d(0x106));const _0x494747=await new branch_component_history_flosum_component_retriever_1[(_0x3e264d(0x13d))]({'value':this[_0x3e264d(0x100)],'salesforceService':this[_0x3e264d(0x152)]})['retrieve'](),_0x48a764=_0x494747[_0x3e264d(0xd2)](_0xb85c23=>_0x388a02[_0x3e264d(0x11f)](_0xb85c23['id']));if(_0x48a764['length']!==this[_0x3e264d(0xff)][_0x3e264d(0x12e)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x48a764;}async[a353_0x173670(0xea)](_0x181305){const _0x2ea12d=a353_0x173670;var _0xf83aa1;this[_0x2ea12d(0x130)][_0x2ea12d(0x121)](_0x2ea12d(0x138));const _0x54c916=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x181305,'veevaService':this[_0x2ea12d(0x14d)],'logger':this[_0x2ea12d(0x130)]})['retrieve'](),_0x354c08=await this[_0x2ea12d(0x154)]['export'](_0x54c916,_0x2ea12d(0xe9));if(_0x354c08['length']>0x1)throw new Error(_0x2ea12d(0xe0));return(_0xf83aa1=_0x354c08[0x0])!==null&&_0xf83aa1!==void 0x0?_0xf83aa1:_0x354c08[0x0]=new jszip_1[(_0x2ea12d(0x159))](),_0x354c08[0x0][_0x2ea12d(0x137)]({'type':_0x2ea12d(0x10e)});}async['saveBackup'](_0x2f7e88){const _0x4d566e=a353_0x173670;this['_logger']['log']('Save\x20Backup\x20to\x20Salesforce');const _0x21ea76={'Body':_0x2f7e88,'ContentType':_0x4d566e(0x116),'ParentId':this[_0x4d566e(0x10a)],'Name':flosum_constants_1[_0x4d566e(0xd1)][_0x4d566e(0xeb)]};await this[_0x4d566e(0x110)]['post'](flosum_constants_1[_0x4d566e(0xd1)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x21ea76);}async[a353_0x173670(0xe7)](_0x5d7113){const _0xa270a0=a353_0x173670;this[_0xa270a0(0x130)][_0xa270a0(0x121)](_0xa270a0(0x15c));const _0x2362a4=await(0x0,fetch_attachments_1[_0xa270a0(0x115)])(this['_connectionSalesforce'],_0x5d7113[_0xa270a0(0xfa)](_0x3c26c6=>_0x3c26c6['componentHistoryId'])),_0x80d1d9=await(0x0,fetch_attachments_1[_0xa270a0(0xe7)])(_0x2362a4,this['_connectionSalesforce']);if(_0x80d1d9[_0xa270a0(0x12e)]!==this['_componentIdList']['length'])throw new Error(_0xa270a0(0x15b));return _0x80d1d9[_0xa270a0(0xfa)](_0x53d86a=>_0x53d86a[_0xa270a0(0x12d)][_0xa270a0(0x13a)]);}async[a353_0x173670(0xf6)](_0x109b5b){const _0x4a55aa=a353_0x173670;this['_logger'][_0x4a55aa(0x121)](_0x4a55aa(0x111));const _0x515b36=await new zip_creator_deploy_1[(_0x4a55aa(0xe4))]({'attachmentBodies':_0x109b5b,'deploymentName':this['_deploymentName']})[_0x4a55aa(0x122)](),_0x3597d1=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0x4a55aa(0x132);return await(0x0,promises_1[_0x4a55aa(0x128)])(_0x3597d1,_0x515b36),_0x3597d1;}async[a353_0x173670(0x11b)](_0x5da2c5){const _0x2848be=a353_0x173670;this['_logger']['log']('Create\x20vpk\x20package');const _0x2750c6=await this[_0x2848be(0xcd)][_0x2848be(0x10c)](_0x5da2c5),_0x56ded7=this[_0x2848be(0x14b)]+_0x2848be(0xd8)+_0x5da2c5[_0x2848be(0xf3)](_0x5da2c5[_0x2848be(0x139)]('/')+0x1);return await(0x0,promises_1[_0x2848be(0x128)])(_0x56ded7,_0x2750c6),await this[_0x2848be(0xcd)]['validate'](_0x56ded7),_0x56ded7;}async[a353_0x173670(0xfc)](_0x2d3678,_0xbf3d7c){const _0x1bc9fb=a353_0x173670;this[_0x1bc9fb(0x130)][_0x1bc9fb(0x121)](_0x1bc9fb(0xec));const _0x4552a9={'Body':Buffer[_0x1bc9fb(0x124)](_0x2d3678)[_0x1bc9fb(0x150)](_0x1bc9fb(0x10e)),'ContentType':'text/plain','ParentId':this[_0x1bc9fb(0x10a)],'Name':_0xbf3d7c};await this['_connectionSalesforce']['post'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0x1bc9fb(0xdf),_0x4552a9);}['formFlosumDeploymentResults'](_0x1a2c4e,_0x227190){const _0x42d64e=a353_0x173670;this[_0x42d64e(0x130)]['log'](_0x42d64e(0x142));const _0x159604=_0x1a2c4e[_0x42d64e(0xdb)]((_0xfc0645,_0x2941d6)=>_0xfc0645[_0x42d64e(0x143)]((_0x2941d6[_0x42d64e(0x153)]+'.'+_0x2941d6[_0x42d64e(0x144)])[_0x42d64e(0xf4)](),_0x2941d6),new Map());return _0x227190['map'](_0x1f58d9=>{const _0x145f09=_0x42d64e;this['_logger']['log'](_0x1f58d9[_0x145f09(0x12c)]+'.'+_0x1f58d9['name']+'\x20:\x20'+_0x1f58d9[_0x145f09(0xee)]);const _0x21f0fe=(_0x1f58d9['type']+'.'+_0x1f58d9[_0x145f09(0x102)])[_0x145f09(0xf4)](),_0x9a0afa=_0x159604[_0x145f09(0x166)](_0x21f0fe);return{[constants_1[_0x145f09(0x158)]+'Type__c']:_0x145f09(0x162),[constants_1[_0x145f09(0x158)]+'Status__c']:_0x1f58d9[_0x145f09(0xee)]===status_enums_1['PackageComponentStatus'][_0x145f09(0x136)]?_0x145f09(0x12f):_0x145f09(0x118),[constants_1[_0x145f09(0x158)]+'Result__c']:_0x1f58d9[_0x145f09(0x140)],[constants_1[_0x145f09(0x158)]+_0x145f09(0x15d)]:_0x1f58d9[_0x145f09(0x102)],[constants_1['FLOSUM_NAMESPACE']+_0x145f09(0x151)]:_0x1f58d9[_0x145f09(0x12c)],[constants_1[_0x145f09(0x158)]+_0x145f09(0xf9)]:_0x1f58d9['stepName'],[constants_1['FLOSUM_NAMESPACE']+'Org__c']:this['_organisationId'],[constants_1[_0x145f09(0x158)]+_0x145f09(0xe8)]:this[_0x145f09(0x10a)],[constants_1[_0x145f09(0x158)]+_0x145f09(0x134)]:_0x9a0afa['componentHistoryId']};});}async[a353_0x173670(0x119)](_0x233143){const _0x189b93=a353_0x173670;this[_0x189b93(0x130)][_0x189b93(0x121)](_0x189b93(0x13f));const _0x53c5ac=await this['_salesforceService'][_0x189b93(0x129)](constants_1[_0x189b93(0x158)]+'Deployment_Result__c',_0x233143),_0x585256=_0x53c5ac['filter'](_0x56099f=>!_0x56099f[_0x189b93(0xc5)])['map'](_0x5651e6=>_0x5651e6[_0x189b93(0x161)])[_0x189b93(0xc8)]();if(_0x585256[_0x189b93(0x12e)])throw new salesforce_dml_error_1[(_0x189b93(0xce))](_0x585256);}async[a353_0x173670(0x126)](_0x26ac09){const _0x3fb22d=a353_0x173670;this[_0x3fb22d(0x130)][_0x3fb22d(0x120)](_0x26ac09),await this[_0x3fb22d(0x130)][_0x3fb22d(0x10d)](),await this[_0x3fb22d(0x13c)](![],!![],'');}async[a353_0x173670(0x13c)](_0x3a8ae2,_0x12a8b6,_0x5bab46){const _0x2d536c=a353_0x173670,_0x53a4ae='<a\x20href='+this[_0x2d536c(0x123)]+'/'+this['_metadataLogId']+_0x2d536c(0xfd)+_0x2d536c(0x168)+_0x2d536c(0xd5),_0x4fb6ff=_0x2d536c(0x117)+this[_0x2d536c(0x123)]+'/'+this[_0x2d536c(0x146)]+'\x20>'+this[_0x2d536c(0x107)]+_0x2d536c(0x14c),_0xe6b319=_0x53a4ae+'\x20of\x20branch\x20to\x20Organization\x20'+_0x4fb6ff+_0x2d536c(0x13e),_0x122cd3={[constants_1['FLOSUM_NAMESPACE']+_0x2d536c(0x15f)]:_0xe6b319,[constants_1[_0x2d536c(0x158)]+_0x2d536c(0xe1)]:new Date(),[constants_1[_0x2d536c(0x158)]+_0x2d536c(0x11a)]:this[_0x2d536c(0x100)],[constants_1[_0x2d536c(0x158)]+'Activity_Item__c']:_0x2d536c(0x133),[constants_1[_0x2d536c(0x158)]+_0x2d536c(0xd3)]:'Deployment',[constants_1[_0x2d536c(0x158)]+'TargetId__c']:this['_organisationId']},_0x35cb9b={[constants_1[_0x2d536c(0x158)]+_0x2d536c(0xf5)]:!_0x3a8ae2,[constants_1[_0x2d536c(0x158)]+'Succeed__c']:_0x3a8ae2,[constants_1[_0x2d536c(0x158)]+'Status__c']:_0x12a8b6?status_enums_1[_0x2d536c(0x101)][_0x2d536c(0xef)]:status_enums_1['MetadataLogStatus'][_0x2d536c(0x15e)],[constants_1['FLOSUM_NAMESPACE']+_0x2d536c(0x127)]:!![],[constants_1['FLOSUM_NAMESPACE']+'Async_Request_Id__c']:_0x5bab46};await this[_0x2d536c(0x110)]['patch'](flosum_constants_1['FlosumConstants'][_0x2d536c(0x160)]+'/'+constants_1[_0x2d536c(0x158)]+_0x2d536c(0xd0)+this['_metadataLogId'],_0x35cb9b),await this[_0x2d536c(0x110)][_0x2d536c(0x149)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x2d536c(0x158)]+_0x2d536c(0xe2),_0x122cd3),this[_0x2d536c(0x130)][_0x2d536c(0x121)](_0x2d536c(0x157)+(_0x3a8ae2?_0x2d536c(0x131):_0x2d536c(0x13b))+'.'),await this['_logger'][_0x2d536c(0x10d)]();}}exports['DeployService']=DeployService;