function a402_0x1321(_0x20b8ad,_0x41ad48){const _0x86bea=a402_0x4294();return a402_0x1321=function(_0x1662d3,_0x5d2654){_0x1662d3=_0x1662d3-0xc0;let _0x429494=_0x86bea[_0x1662d3];return _0x429494;},a402_0x1321(_0x20b8ad,_0x41ad48);}const a402_0x2c8f6a=a402_0x1321;(function(_0x15cecb,_0x4b5864){const _0x4fb68d=a402_0x1321,_0x3304fd=_0x15cecb();while(!![]){try{const _0xc00a9c=-parseInt(_0x4fb68d(0x12a))/0x1+parseInt(_0x4fb68d(0xd5))/0x2+-parseInt(_0x4fb68d(0x104))/0x3+parseInt(_0x4fb68d(0xdf))/0x4+parseInt(_0x4fb68d(0xda))/0x5*(parseInt(_0x4fb68d(0xe7))/0x6)+-parseInt(_0x4fb68d(0x114))/0x7*(parseInt(_0x4fb68d(0x117))/0x8)+parseInt(_0x4fb68d(0x14b))/0x9*(parseInt(_0x4fb68d(0x106))/0xa);if(_0xc00a9c===_0x4b5864)break;else _0x3304fd['push'](_0x3304fd['shift']());}catch(_0x138d26){_0x3304fd['push'](_0x3304fd['shift']());}}}(a402_0x4294,0xa2850));const a402_0x5d2654=(function(){let _0x283856=!![];return function(_0x819eec,_0x4bd56b){const _0x184694=_0x283856?function(){const _0x43afd3=a402_0x1321;if(_0x4bd56b){const _0x7304e=_0x4bd56b[_0x43afd3(0xde)](_0x819eec,arguments);return _0x4bd56b=null,_0x7304e;}}:function(){};return _0x283856=![],_0x184694;};}()),a402_0x1662d3=a402_0x5d2654(this,function(){const _0x4c9319=a402_0x1321;return a402_0x1662d3[_0x4c9319(0x125)]()['search'](_0x4c9319(0x101))[_0x4c9319(0x125)]()[_0x4c9319(0x120)](a402_0x1662d3)[_0x4c9319(0xd0)](_0x4c9319(0x101));});a402_0x1662d3();'use strict';var __importDefault=this&&this[a402_0x2c8f6a(0x14d)]||function(_0x5405d6){const _0x523df3=a402_0x2c8f6a;return _0x5405d6&&_0x5405d6[_0x523df3(0x147)]?_0x5405d6:{'default':_0x5405d6};};Object[a402_0x2c8f6a(0xc8)](exports,a402_0x2c8f6a(0x147),{'value':!![]}),exports[a402_0x2c8f6a(0xf5)]=void 0x0;function a402_0x4294(){const _0x4f5d61=['Create\x20vpk\x20package','Join\x20all\x20mdl\x20into\x20one\x20zip','apply','3468952WrNaFG','Retrieving\x20components','Veeva\x20Deployment','Status__c','Body','FlosumConstants','finishDeploy','SalesforceService','547098mlhsTs','deploymentAction','isDeployed','import','_deploymentName','get','set','componentIdList','createZip','BranchComponentHistoryFlosumComponentRetriever','error','length','componentHistoryId','FlosumComponentVeevaComponentRetriever','DeployService','validate','_tempFolder','VeevaService','Org__c','Branch','generateAsync','formFlosumDeploymentResults','./vpk.service','componentName','map','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','(((.+)+)+)+$','reduce','_logger','1695582NHZuat','retrieveAttachments','133270MsuzAW','Retrieving\x20attachments','_componentIdList','PackageExportService','EXCEPTION','PackageImportService','status','Deployment','Is_Error__c','FLOSUM_NAMESPACE','../classes/errors/salesforce-dml-error','Form\x20Deployment\x20Results','./package-import.service','Metadata_Log__c','6132469yFgnkP','Deployment\x20Result','componentType','8UCWFEo','saveBackup','type','execute','_connectionSalesforce','_packageExportService','application/zip','<a\x20href=','Action__c','constructor','Cannot\x20retrieve\x20all\x20components.','catch','_connectionVeeva','/Attachment','toString','SalesforceDmlError','_timeZone','/vpk__','Metadata_Log__c/','978672pFRWgX','Cannot\x20retrievers\x20all\x20attachments','_organisationId','attachmentLogId','writeFile','_salesforceService','DEPLOYED','BACKUP_ZIP_NAME','text/plain','Success','saveDeploymentResults','../../shared/utils/fetch-attachments','flat','Component_Type__c','toLowerCase','values','_veevaService','Logger','updateLog','PackageComponentStatus','from','veeva-deploy','name','stepName','patch','lastIndexOf','default','export','with\x20error','__esModule','../constants/flosum.constants','Job_Completed__c','timeZone','801KkLRHe','Component_History__c','__importDefault','log','ENDPOINT_UPSERT_RECORD','generate','fetchAttachmentsDetailsByParentId','deploymentName','success','_vpkService','finishDeployWithError','Date__c','slice','_packageImportService','organisationId','saveLog','getFlosumComponents','Activity_Type__c','_branchId','Backup','Veeva_Step_Name__c','jszip','MetadataLogStatus','_organisationName','logError','successfully','defineProperty','\x20>\x20','_metadataLogId','../enums/status.enums','createBackup','../../../core','createVpk','_instanceUrl','search','post','shortid','Save\x20Backup\x20to\x20Salesforce','_systemLogger','1517446WcTVVi','packageId','\x20:\x20','./salesforce.service','fs/promises','15yQZZOV','retrieve'];a402_0x4294=function(){return _0x4f5d61;};return a402_0x4294();}const jszip_1=__importDefault(require(a402_0x2c8f6a(0xc3))),promises_1=require(a402_0x2c8f6a(0xd9)),constants_1=require('../../../constants'),flosum_constants_1=require(a402_0x2c8f6a(0x148)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a402_0x2c8f6a(0xd8)),core_1=require(a402_0x2c8f6a(0xcd)),status_enums_1=require(a402_0x2c8f6a(0xcb)),salesforce_dml_error_1=require(a402_0x2c8f6a(0x110)),shortid_1=__importDefault(require(a402_0x2c8f6a(0xd2))),fetch_attachments_1=require(a402_0x2c8f6a(0x135)),package_import_service_1=require(a402_0x2c8f6a(0x112)),branch_component_history_flosum_component_retriever_1=require(a402_0x2c8f6a(0x100)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a402_0x2c8f6a(0xfd)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x116080,_0xd12a4e,_0x2d6798,_0xbea977,_0x3f35ee,_0x3db1cb){const _0x3ce9f9=a402_0x2c8f6a;this[_0x3ce9f9(0x11b)]=_0xd12a4e,this[_0x3ce9f9(0x123)]=_0x2d6798,this['_logger']=_0xbea977,this[_0x3ce9f9(0xf7)]=_0x3f35ee,this[_0x3ce9f9(0xcf)]=_0x3db1cb,this['_branchId']=_0x116080['branchId'],this[_0x3ce9f9(0xca)]=_0x116080['metadataLogId'],this['_attachmentLogId']=_0x116080[_0x3ce9f9(0x12d)],this['_organisationId']=_0x116080[_0x3ce9f9(0x159)],this[_0x3ce9f9(0x127)]=_0x116080[_0x3ce9f9(0x14a)],this[_0x3ce9f9(0xc5)]=_0x116080['organisationName'],this[_0x3ce9f9(0x108)]=_0x116080[_0x3ce9f9(0xee)],this[_0x3ce9f9(0xeb)]=_0x116080[_0x3ce9f9(0x152)],this[_0x3ce9f9(0xd4)]=new core_1[(_0x3ce9f9(0x13b))](_0x3ce9f9(0x13f)),this['_veevaService']=new veeva_service_1[(_0x3ce9f9(0xf8))]({'connection':this[_0x3ce9f9(0x123)],'logger':this[_0x3ce9f9(0x103)]}),this['_salesforceService']=new salesforce_service_1[(_0x3ce9f9(0xe6))]({'connection':this['_connectionSalesforce']}),this[_0x3ce9f9(0x158)]=new package_import_service_1[(_0x3ce9f9(0x10b))]({'veevaService':this[_0x3ce9f9(0x13a)],'connection':this[_0x3ce9f9(0x123)],'logger':this[_0x3ce9f9(0x103)],'saveLog':this[_0x3ce9f9(0x15a)]['bind'](this)}),this[_0x3ce9f9(0x11c)]=new package_export_service_1[(_0x3ce9f9(0x109))]({'veevaService':this[_0x3ce9f9(0x13a)],'connection':this[_0x3ce9f9(0x123)],'logger':this[_0x3ce9f9(0x103)]}),this[_0x3ce9f9(0x154)]=new vpk_service_1['VpkService']({'connection':this['_connectionVeeva']});}async[a402_0x2c8f6a(0x11a)](){const _0xf32523=a402_0x2c8f6a;try{const _0x460148=await this['getFlosumComponents']();await this['_logger']['updateLog']();const _0x1c2221=await this[_0xf32523(0xcc)](_0x460148);await this[_0xf32523(0x118)](_0x1c2221);const _0x30abf3=await this[_0xf32523(0x105)](_0x460148),_0x4ed3fc=await this[_0xf32523(0xef)](_0x30abf3),_0x48ee6f=await this['createVpk'](_0x4ed3fc);await this[_0xf32523(0x103)]['updateLog']();const _0x28d8a4=await this['_packageImportService'][_0xf32523(0xea)](_0x48ee6f);await this['_logger'][_0xf32523(0x13c)]();const _0x5ab395=this[_0xf32523(0xfc)](_0x460148,_0x28d8a4['packageComponentList']);await this[_0xf32523(0x134)](_0x5ab395),await this[_0xf32523(0xe5)](_0x28d8a4[_0xf32523(0xe9)],![],_0x28d8a4[_0xf32523(0xd6)]);}catch(_0x1170ea){await this[_0xf32523(0x155)](_0x1170ea)[_0xf32523(0x122)](_0x3b7162=>this['_systemLogger'][_0xf32523(0xf1)](_0x3b7162));}}async[a402_0x2c8f6a(0x15b)](){const _0x75f93d=a402_0x2c8f6a,_0x386365=new Set(this['_componentIdList']);this[_0x75f93d(0x103)][_0x75f93d(0x14e)](_0x75f93d(0xe0));const _0x4a8f47=await new branch_component_history_flosum_component_retriever_1[(_0x75f93d(0xf0))]({'value':this[_0x75f93d(0xc0)],'salesforceService':this[_0x75f93d(0x12f)]})[_0x75f93d(0xdb)](),_0x1446be=_0x4a8f47['filter'](_0x2ffccf=>_0x386365['has'](_0x2ffccf['id']));if(_0x1446be[_0x75f93d(0xf2)]!==this[_0x75f93d(0x108)][_0x75f93d(0xf2)])throw new Error(_0x75f93d(0x121));return _0x1446be;}async[a402_0x2c8f6a(0xcc)](_0x1e59b0){const _0x1fc64e=a402_0x2c8f6a;var _0x2852df;this[_0x1fc64e(0x103)][_0x1fc64e(0x14e)]('Create\x20Backup');const _0x38255f=await new flosum_component_veeva_component_retriever_1[(_0x1fc64e(0xf4))]({'value':_0x1e59b0,'veevaService':this[_0x1fc64e(0x13a)],'logger':this[_0x1fc64e(0x103)]})['retrieve'](),_0x1414fa=await this['_packageExportService'][_0x1fc64e(0x145)](_0x38255f,_0x1fc64e(0xc1));if(_0x1414fa[_0x1fc64e(0xf2)]>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x2852df=_0x1414fa[0x0])!==null&&_0x2852df!==void 0x0?_0x2852df:_0x1414fa[0x0]=new jszip_1[(_0x1fc64e(0x144))](),_0x1414fa[0x0][_0x1fc64e(0xfb)]({'type':'base64'});}async[a402_0x2c8f6a(0x118)](_0x16727a){const _0x29b30d=a402_0x2c8f6a;this[_0x29b30d(0x103)][_0x29b30d(0x14e)](_0x29b30d(0xd3));const _0x498513={'Body':_0x16727a,'ContentType':_0x29b30d(0x11d),'ParentId':this[_0x29b30d(0xca)],'Name':flosum_constants_1[_0x29b30d(0xe4)][_0x29b30d(0x131)]};await this[_0x29b30d(0x11b)][_0x29b30d(0xd1)](flosum_constants_1[_0x29b30d(0xe4)][_0x29b30d(0x14f)]+_0x29b30d(0x124),_0x498513);}async[a402_0x2c8f6a(0x105)](_0x410d01){const _0x187a08=a402_0x2c8f6a;this[_0x187a08(0x103)]['log'](_0x187a08(0x107));const _0x19ba49=await(0x0,fetch_attachments_1[_0x187a08(0x151)])(this[_0x187a08(0x11b)],_0x410d01['map'](_0x575bb0=>_0x575bb0[_0x187a08(0xf3)])),_0xfe8ff8=await(0x0,fetch_attachments_1[_0x187a08(0x105)])(_0x19ba49,this[_0x187a08(0x11b)]);if(_0xfe8ff8['length']!==this[_0x187a08(0x108)][_0x187a08(0xf2)])throw new Error(_0x187a08(0x12b));return _0xfe8ff8['map'](_0x2af2af=>_0x2af2af[_0x187a08(0x139)][_0x187a08(0xe3)]);}async[a402_0x2c8f6a(0xef)](_0x21ce4e){const _0x1fb1c2=a402_0x2c8f6a;this[_0x1fb1c2(0x103)][_0x1fb1c2(0x14e)](_0x1fb1c2(0xdd));const _0x5d261d=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x21ce4e,'deploymentName':this[_0x1fb1c2(0xeb)]})[_0x1fb1c2(0x11a)](),_0x1999bd=this['_tempFolder']+'/'+(0x0,shortid_1[_0x1fb1c2(0x144)])()+'.zip';return await(0x0,promises_1[_0x1fb1c2(0x12e)])(_0x1999bd,_0x5d261d),_0x1999bd;}async[a402_0x2c8f6a(0xce)](_0x307a75){const _0x4cdb63=a402_0x2c8f6a;this[_0x4cdb63(0x103)][_0x4cdb63(0x14e)](_0x4cdb63(0xdc));const _0x3e1609=await this[_0x4cdb63(0x154)][_0x4cdb63(0x150)](_0x307a75),_0x4c2b64=this[_0x4cdb63(0xf7)]+_0x4cdb63(0x128)+_0x307a75[_0x4cdb63(0x157)](_0x307a75[_0x4cdb63(0x143)]('/')+0x1);return await(0x0,promises_1[_0x4cdb63(0x12e)])(_0x4c2b64,_0x3e1609),await this[_0x4cdb63(0x154)][_0x4cdb63(0xf6)](_0x4c2b64),_0x4c2b64;}async[a402_0x2c8f6a(0x15a)](_0x47f66f,_0xabc1b6){const _0x778792=a402_0x2c8f6a;this[_0x778792(0x103)][_0x778792(0x14e)]('Save\x20log');const _0x46e014={'Body':Buffer[_0x778792(0x13e)](_0x47f66f)[_0x778792(0x125)]('base64'),'ContentType':_0x778792(0x132),'ParentId':this['_metadataLogId'],'Name':_0xabc1b6};await this[_0x778792(0x11b)][_0x778792(0xd1)](flosum_constants_1[_0x778792(0xe4)][_0x778792(0x14f)]+_0x778792(0x124),_0x46e014);}['formFlosumDeploymentResults'](_0x49fdd4,_0x34238a){const _0x1450bd=a402_0x2c8f6a;this[_0x1450bd(0x103)]['log'](_0x1450bd(0x111));const _0x155385=_0x49fdd4[_0x1450bd(0x102)]((_0x410ecb,_0x4ad19f)=>_0x410ecb[_0x1450bd(0xed)]((_0x4ad19f[_0x1450bd(0x116)]+'.'+_0x4ad19f[_0x1450bd(0xfe)])[_0x1450bd(0x138)](),_0x4ad19f),new Map());return _0x34238a[_0x1450bd(0xff)](_0x325975=>{const _0x2f4f24=_0x1450bd;this[_0x2f4f24(0x103)][_0x2f4f24(0x14e)](_0x325975[_0x2f4f24(0x119)]+'.'+_0x325975[_0x2f4f24(0x140)]+_0x2f4f24(0xd7)+_0x325975[_0x2f4f24(0x10c)]);const _0x5ba6b2=(_0x325975[_0x2f4f24(0x119)]+'.'+_0x325975[_0x2f4f24(0x140)])[_0x2f4f24(0x138)](),_0x32596f=_0x155385[_0x2f4f24(0xec)](_0x5ba6b2);return{[constants_1[_0x2f4f24(0x10f)]+'Type__c']:_0x2f4f24(0x115),[constants_1[_0x2f4f24(0x10f)]+_0x2f4f24(0xe2)]:_0x325975['status']===status_enums_1[_0x2f4f24(0x13d)][_0x2f4f24(0x130)]?_0x2f4f24(0x133):'Failure',[constants_1[_0x2f4f24(0x10f)]+'Result__c']:_0x325975[_0x2f4f24(0xe8)],[constants_1[_0x2f4f24(0x10f)]+'Component_Name__c']:_0x325975[_0x2f4f24(0x140)],[constants_1['FLOSUM_NAMESPACE']+_0x2f4f24(0x137)]:_0x325975[_0x2f4f24(0x119)],[constants_1[_0x2f4f24(0x10f)]+_0x2f4f24(0xc2)]:_0x325975[_0x2f4f24(0x141)],[constants_1[_0x2f4f24(0x10f)]+_0x2f4f24(0xf9)]:this[_0x2f4f24(0x12c)],[constants_1[_0x2f4f24(0x10f)]+_0x2f4f24(0x113)]:this[_0x2f4f24(0xca)],[constants_1[_0x2f4f24(0x10f)]+_0x2f4f24(0x14c)]:_0x32596f[_0x2f4f24(0xf3)]};});}async[a402_0x2c8f6a(0x134)](_0x43e942){const _0x3bbfd1=a402_0x2c8f6a;this['_logger'][_0x3bbfd1(0x14e)]('Save\x20Deployment\x20Results');const _0x1958d6=await this['_salesforceService']['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x43e942),_0x2f4e48=_0x1958d6['filter'](_0x435af1=>!_0x435af1[_0x3bbfd1(0x153)])[_0x3bbfd1(0xff)](_0xf8e56d=>_0xf8e56d['errors'])[_0x3bbfd1(0x136)]();if(_0x2f4e48[_0x3bbfd1(0xf2)])throw new salesforce_dml_error_1[(_0x3bbfd1(0x126))](_0x2f4e48);}async[a402_0x2c8f6a(0x155)](_0x5081c0){const _0x234e47=a402_0x2c8f6a;this[_0x234e47(0x103)][_0x234e47(0xc6)](_0x5081c0),await this[_0x234e47(0x103)][_0x234e47(0x13c)](),await this[_0x234e47(0xe5)](![],!![],'');}async[a402_0x2c8f6a(0xe5)](_0x33cfc0,_0x3f0538,_0x1f3195){const _0x409107=a402_0x2c8f6a,_0x427695=_0x409107(0x11e)+this[_0x409107(0xcf)]+'/'+this['_metadataLogId']+_0x409107(0xc9)+_0x409107(0xe1)+'\x20</a>',_0x9c5d95='<a\x20href='+this[_0x409107(0xcf)]+'/'+this['_organisationId']+'\x20>'+this[_0x409107(0xc5)]+'</a>',_0x9bd760=_0x427695+'\x20of\x20branch\x20to\x20Organization\x20'+_0x9c5d95+'\x20has\x20been\x20created.',_0x4cbf55={[constants_1['FLOSUM_NAMESPACE']+_0x409107(0x11f)]:_0x9bd760,[constants_1[_0x409107(0x10f)]+_0x409107(0x156)]:new Date(),[constants_1[_0x409107(0x10f)]+'Branch__c']:this[_0x409107(0xc0)],[constants_1[_0x409107(0x10f)]+'Activity_Item__c']:_0x409107(0xfa),[constants_1[_0x409107(0x10f)]+_0x409107(0x15c)]:_0x409107(0x10d),[constants_1[_0x409107(0x10f)]+'TargetId__c']:this[_0x409107(0x12c)]},_0x26e14c={[constants_1[_0x409107(0x10f)]+_0x409107(0x10e)]:!_0x33cfc0,[constants_1[_0x409107(0x10f)]+'Succeed__c']:_0x33cfc0,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x3f0538?status_enums_1[_0x409107(0xc4)][_0x409107(0x10a)]:status_enums_1[_0x409107(0xc4)]['COMPLETED'],[constants_1[_0x409107(0x10f)]+_0x409107(0x149)]:!![],[constants_1[_0x409107(0x10f)]+'External_Deployment_Id__c']:_0x1f3195};await this['_connectionSalesforce'][_0x409107(0x142)](flosum_constants_1[_0x409107(0xe4)][_0x409107(0x14f)]+'/'+constants_1[_0x409107(0x10f)]+_0x409107(0x129)+this[_0x409107(0xca)],_0x26e14c),await this[_0x409107(0x11b)][_0x409107(0xd1)](flosum_constants_1[_0x409107(0xe4)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x409107(0x10f)]+'Log__c',_0x4cbf55),this[_0x409107(0x103)]['log']('Deploy\x20completed\x20'+(_0x33cfc0?_0x409107(0xc7):_0x409107(0x146))+'.'),await this[_0x409107(0x103)][_0x409107(0x13c)]();}}exports[a402_0x2c8f6a(0xf5)]=DeployService;