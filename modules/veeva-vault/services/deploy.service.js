const a401_0x1568d3=a401_0x3773;(function(_0x1213a7,_0x287ef3){const _0x38dfe7=a401_0x3773,_0xa77ff=_0x1213a7();while(!![]){try{const _0x4c8b2f=-parseInt(_0x38dfe7(0x228))/0x1+parseInt(_0x38dfe7(0x1c2))/0x2*(-parseInt(_0x38dfe7(0x220))/0x3)+-parseInt(_0x38dfe7(0x205))/0x4+parseInt(_0x38dfe7(0x1ef))/0x5+-parseInt(_0x38dfe7(0x237))/0x6+parseInt(_0x38dfe7(0x1d0))/0x7+parseInt(_0x38dfe7(0x1c1))/0x8;if(_0x4c8b2f===_0x287ef3)break;else _0xa77ff['push'](_0xa77ff['shift']());}catch(_0x3a3250){_0xa77ff['push'](_0xa77ff['shift']());}}}(a401_0x31d5,0x782b2));const a401_0x449f58=(function(){let _0x1302ab=!![];return function(_0x2ffafe,_0xf17714){const _0x180f06=_0x1302ab?function(){if(_0xf17714){const _0x27e78d=_0xf17714['apply'](_0x2ffafe,arguments);return _0xf17714=null,_0x27e78d;}}:function(){};return _0x1302ab=![],_0x180f06;};}()),a401_0x82d494=a401_0x449f58(this,function(){const _0x54e488=a401_0x3773;return a401_0x82d494[_0x54e488(0x1ae)]()[_0x54e488(0x1b5)]('(((.+)+)+)+$')[_0x54e488(0x1ae)]()[_0x54e488(0x1a0)](a401_0x82d494)[_0x54e488(0x1b5)](_0x54e488(0x1f2));});a401_0x82d494();'use strict';function a401_0x3773(_0x9bab87,_0x158915){const _0x12d2cc=a401_0x31d5();return a401_0x3773=function(_0x82d494,_0x449f58){_0x82d494=_0x82d494-0x19f;let _0x31d5c6=_0x12d2cc[_0x82d494];return _0x31d5c6;},a401_0x3773(_0x9bab87,_0x158915);}function a401_0x31d5(){const _0x4cddfe=['slice','patch','Veeva_Step_Name__c','Activity_Item__c','packageId','componentName','Metadata_Log__c','\x20of\x20branch\x20to\x20Organization\x20','FlosumComponentVeevaComponentRetriever','./package-import.service','Cannot\x20Backup\x20more\x20than\x20200\x20components.','attachmentLogId','Org__c','componentHistoryId','_veevaService','validate','.zip','componentType','MetadataLogStatus','_timeZone','saveBackup','with\x20error','Backup','_metadataLogId','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','2530520qBtzjv','branchId','map','(((.+)+)+)+$','getFlosumComponents','VpkService','Save\x20Backup\x20to\x20Salesforce','reduce','from','saveLog','_organisationName','SalesforceService','status','_salesforceService','VeevaService','_organisationId','_logger','Succeed__c','Status__c','../enums/status.enums','_componentIdList','metadataLogId','1009480OSnNra','retrieve','Branch','Join\x20all\x20mdl\x20into\x20one\x20zip','Veeva\x20Deployment','Metadata_Log__c/','default','Create\x20vpk\x20package','../../../core','../../shared/utils/fetch-attachments','writeFile','SalesforceDmlError','packageComponentList','Form\x20Deployment\x20Results','/Attachment','Cannot\x20retrieve\x20all\x20components.','formFlosumDeploymentResults','../classes/errors/salesforce-dml-error','_deploymentName','_instanceUrl','_branchId','stepName','createVpk','error','Failure','_vpkService','errors','309Jflcod','_connectionVeeva','TargetId__c','toLowerCase','saveDeploymentResults','text/plain','_tempFolder','./package-export.service','329700VibDDl','deploymentName','Action__c','FLOSUM_NAMESPACE','./veeva.service','<a\x20href=','length','_packageExportService','updateLog','Create\x20Backup','\x20</a>','PackageExportService','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','DEPLOYED','Deployment\x20Result','972288gfyTrZ','filter','External_Deployment_Id__c','shortid','Body','constructor','./salesforce.service','Deployment','ZipCreatorDeploy','Log__c','ENDPOINT_UPSERT_RECORD','Is_Error__c','log','Job_Completed__c','type','logError','name','deploymentAction','execute','toString','_packageImportService','createZip','Component_Name__c','flat','catch','get','search','./vpk.service','_connectionSalesforce','Logger','set','PackageComponentStatus','BACKUP_ZIP_NAME','PackageImportService','componentIdList','\x20:\x20','/vpk__','_systemLogger','7670296vzgqWs','11602XKejQM','retrieveAttachments','veeva-deploy','../constants/flosum.constants','createBackup','finishDeploy','post','generate','__esModule','base64','organisationName','DeployService','Date__c','FlosumConstants','2582580YVXDZC','COMPLETED','_attachmentLogId','Save\x20Deployment\x20Results','Save\x20log','finishDeployWithError'];a401_0x31d5=function(){return _0x4cddfe;};return a401_0x31d5();}var __importDefault=this&&this['__importDefault']||function(_0x1ded8c){const _0x4141d6=a401_0x3773;return _0x1ded8c&&_0x1ded8c[_0x4141d6(0x1ca)]?_0x1ded8c:{'default':_0x1ded8c};};Object['defineProperty'](exports,a401_0x1568d3(0x1ca),{'value':!![]}),exports[a401_0x1568d3(0x1cd)]=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require('fs/promises'),constants_1=require('../../../constants'),flosum_constants_1=require(a401_0x1568d3(0x1c5)),veeva_service_1=require(a401_0x1568d3(0x22c)),salesforce_service_1=require(a401_0x1568d3(0x1a1)),core_1=require(a401_0x1568d3(0x20d)),status_enums_1=require(a401_0x1568d3(0x202)),salesforce_dml_error_1=require(a401_0x1568d3(0x216)),shortid_1=__importDefault(require(a401_0x1568d3(0x23a))),fetch_attachments_1=require(a401_0x1568d3(0x20e)),package_import_service_1=require(a401_0x1568d3(0x1df)),branch_component_history_flosum_component_retriever_1=require(a401_0x1568d3(0x234)),flosum_component_veeva_component_retriever_1=require(a401_0x1568d3(0x1ee)),package_export_service_1=require(a401_0x1568d3(0x227)),vpk_service_1=require(a401_0x1568d3(0x1b6)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x429af5,_0x3bfc74,_0x59b277,_0x4ba1a3,_0x13770c,_0x56dfca){const _0x29fa97=a401_0x1568d3;this['_connectionSalesforce']=_0x3bfc74,this[_0x29fa97(0x221)]=_0x59b277,this[_0x29fa97(0x1ff)]=_0x4ba1a3,this[_0x29fa97(0x226)]=_0x13770c,this['_instanceUrl']=_0x56dfca,this['_branchId']=_0x429af5[_0x29fa97(0x1f0)],this[_0x29fa97(0x1ed)]=_0x429af5[_0x29fa97(0x204)],this[_0x29fa97(0x1d2)]=_0x429af5[_0x29fa97(0x1e1)],this[_0x29fa97(0x1fe)]=_0x429af5['organisationId'],this[_0x29fa97(0x1e9)]=_0x429af5['timeZone'],this[_0x29fa97(0x1f9)]=_0x429af5[_0x29fa97(0x1cc)],this[_0x29fa97(0x203)]=_0x429af5[_0x29fa97(0x1bd)],this[_0x29fa97(0x217)]=_0x429af5[_0x29fa97(0x229)],this[_0x29fa97(0x1c0)]=new core_1[(_0x29fa97(0x1b8))](_0x29fa97(0x1c4)),this['_veevaService']=new veeva_service_1[(_0x29fa97(0x1fd))]({'connection':this[_0x29fa97(0x221)],'logger':this['_logger']}),this[_0x29fa97(0x1fc)]=new salesforce_service_1[(_0x29fa97(0x1fa))]({'connection':this['_connectionSalesforce']}),this[_0x29fa97(0x1af)]=new package_import_service_1[(_0x29fa97(0x1bc))]({'veevaService':this[_0x29fa97(0x1e4)],'connection':this[_0x29fa97(0x221)],'logger':this[_0x29fa97(0x1ff)],'saveLog':this[_0x29fa97(0x1f8)]['bind'](this)}),this[_0x29fa97(0x22f)]=new package_export_service_1[(_0x29fa97(0x233))]({'veevaService':this[_0x29fa97(0x1e4)],'connection':this[_0x29fa97(0x221)],'logger':this[_0x29fa97(0x1ff)]}),this['_vpkService']=new vpk_service_1[(_0x29fa97(0x1f4))]({'connection':this[_0x29fa97(0x221)]});}async[a401_0x1568d3(0x1ad)](){const _0x153097=a401_0x1568d3;try{const _0x3ce6f6=await this[_0x153097(0x1f3)]();await this[_0x153097(0x1ff)]['updateLog']();const _0x5df4f0=await this[_0x153097(0x1c6)](_0x3ce6f6);await this[_0x153097(0x1ea)](_0x5df4f0);const _0x90d62f=await this[_0x153097(0x1c3)](_0x3ce6f6),_0x493e3a=await this[_0x153097(0x1b0)](_0x90d62f),_0x28d550=await this[_0x153097(0x21b)](_0x493e3a);await this[_0x153097(0x1ff)][_0x153097(0x230)]();const _0x68df8b=await this[_0x153097(0x1af)]['import'](_0x28d550);await this[_0x153097(0x1ff)][_0x153097(0x230)]();const _0x3a4418=this['formFlosumDeploymentResults'](_0x3ce6f6,_0x68df8b[_0x153097(0x211)]);await this[_0x153097(0x224)](_0x3a4418),await this[_0x153097(0x1c7)](_0x68df8b['isDeployed'],![],_0x68df8b[_0x153097(0x1da)]);}catch(_0x36d49d){await this[_0x153097(0x1d5)](_0x36d49d)[_0x153097(0x1b3)](_0x51a9a0=>this['_systemLogger'][_0x153097(0x21c)](_0x51a9a0));}}async[a401_0x1568d3(0x1f3)](){const _0x19c8ab=a401_0x1568d3,_0x280ee8=new Set(this['_componentIdList']);this[_0x19c8ab(0x1ff)]['log']('Retrieving\x20components');const _0x103767=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x19c8ab(0x219)],'salesforceService':this[_0x19c8ab(0x1fc)]})[_0x19c8ab(0x206)](),_0x1197c6=_0x103767[_0x19c8ab(0x238)](_0x197c2a=>_0x280ee8['has'](_0x197c2a['id']));if(_0x1197c6[_0x19c8ab(0x22e)]!==this[_0x19c8ab(0x203)][_0x19c8ab(0x22e)])throw new Error(_0x19c8ab(0x214));return _0x1197c6;}async[a401_0x1568d3(0x1c6)](_0x337f31){const _0x1987f4=a401_0x1568d3;var _0x59f46e;this[_0x1987f4(0x1ff)][_0x1987f4(0x1a7)](_0x1987f4(0x231));const _0x488c40=await new flosum_component_veeva_component_retriever_1[(_0x1987f4(0x1de))]({'value':_0x337f31,'veevaService':this[_0x1987f4(0x1e4)],'logger':this[_0x1987f4(0x1ff)]})[_0x1987f4(0x206)](),_0x13821b=await this[_0x1987f4(0x22f)]['export'](_0x488c40,_0x1987f4(0x1ec));if(_0x13821b[_0x1987f4(0x22e)]>0x1)throw new Error(_0x1987f4(0x1e0));return(_0x59f46e=_0x13821b[0x0])!==null&&_0x59f46e!==void 0x0?_0x59f46e:_0x13821b[0x0]=new jszip_1[(_0x1987f4(0x20b))](),_0x13821b[0x0]['generateAsync']({'type':_0x1987f4(0x1cb)});}async[a401_0x1568d3(0x1ea)](_0x91716f){const _0x463ab9=a401_0x1568d3;this[_0x463ab9(0x1ff)][_0x463ab9(0x1a7)](_0x463ab9(0x1f5));const _0x55b324={'Body':_0x91716f,'ContentType':'application/zip','ParentId':this[_0x463ab9(0x1ed)],'Name':flosum_constants_1['FlosumConstants'][_0x463ab9(0x1bb)]};await this[_0x463ab9(0x1b7)][_0x463ab9(0x1c8)](flosum_constants_1['FlosumConstants'][_0x463ab9(0x1a5)]+_0x463ab9(0x213),_0x55b324);}async[a401_0x1568d3(0x1c3)](_0x3f6100){const _0x27f790=a401_0x1568d3;this['_logger']['log']('Retrieving\x20attachments');const _0xe17f67=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x27f790(0x1b7)],_0x3f6100[_0x27f790(0x1f1)](_0x4fb160=>_0x4fb160[_0x27f790(0x1e3)])),_0x1f5352=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0xe17f67,this[_0x27f790(0x1b7)]);if(_0x1f5352[_0x27f790(0x22e)]!==this[_0x27f790(0x203)]['length'])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x1f5352['map'](_0x425e09=>_0x425e09['values'][_0x27f790(0x19f)]);}async['createZip'](_0x29070f){const _0xfcfd77=a401_0x1568d3;this['_logger'][_0xfcfd77(0x1a7)](_0xfcfd77(0x208));const _0x1ac6e3=await new zip_creator_deploy_1[(_0xfcfd77(0x1a3))]({'attachmentBodies':_0x29070f,'deploymentName':this[_0xfcfd77(0x217)]})[_0xfcfd77(0x1ad)](),_0x3ca016=this[_0xfcfd77(0x226)]+'/'+(0x0,shortid_1[_0xfcfd77(0x20b)])()+_0xfcfd77(0x1e6);return await(0x0,promises_1[_0xfcfd77(0x20f)])(_0x3ca016,_0x1ac6e3),_0x3ca016;}async['createVpk'](_0x52e087){const _0x195449=a401_0x1568d3;this[_0x195449(0x1ff)]['log'](_0x195449(0x20c));const _0x4a5db3=await this[_0x195449(0x21e)][_0x195449(0x1c9)](_0x52e087),_0x2107fb=this[_0x195449(0x226)]+_0x195449(0x1bf)+_0x52e087[_0x195449(0x1d6)](_0x52e087['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x195449(0x20f)])(_0x2107fb,_0x4a5db3),await this['_vpkService'][_0x195449(0x1e5)](_0x2107fb),_0x2107fb;}async[a401_0x1568d3(0x1f8)](_0xe47b56,_0x418aee){const _0x39d589=a401_0x1568d3;this[_0x39d589(0x1ff)][_0x39d589(0x1a7)](_0x39d589(0x1d4));const _0xc58833={'Body':Buffer[_0x39d589(0x1f7)](_0xe47b56)['toString'](_0x39d589(0x1cb)),'ContentType':_0x39d589(0x225),'ParentId':this[_0x39d589(0x1ed)],'Name':_0x418aee};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x39d589(0x1cf)][_0x39d589(0x1a5)]+'/Attachment',_0xc58833);}[a401_0x1568d3(0x215)](_0x4590bf,_0x183083){const _0x43d93f=a401_0x1568d3;this[_0x43d93f(0x1ff)][_0x43d93f(0x1a7)](_0x43d93f(0x212));const _0xe6d20c=_0x4590bf[_0x43d93f(0x1f6)]((_0x3730d8,_0x4c40d5)=>_0x3730d8[_0x43d93f(0x1b9)]((_0x4c40d5[_0x43d93f(0x1e7)]+'.'+_0x4c40d5[_0x43d93f(0x1db)])['toLowerCase'](),_0x4c40d5),new Map());return _0x183083[_0x43d93f(0x1f1)](_0x3139ee=>{const _0x47fe6b=_0x43d93f;this['_logger'][_0x47fe6b(0x1a7)](_0x3139ee['type']+'.'+_0x3139ee['name']+_0x47fe6b(0x1be)+_0x3139ee['status']);const _0x48dce9=(_0x3139ee[_0x47fe6b(0x1a9)]+'.'+_0x3139ee['name'])[_0x47fe6b(0x223)](),_0x3c9f57=_0xe6d20c[_0x47fe6b(0x1b4)](_0x48dce9);return{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:_0x47fe6b(0x236),[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x3139ee[_0x47fe6b(0x1fb)]===status_enums_1[_0x47fe6b(0x1ba)][_0x47fe6b(0x235)]?'Success':_0x47fe6b(0x21d),[constants_1[_0x47fe6b(0x22b)]+'Result__c']:_0x3139ee[_0x47fe6b(0x1ac)],[constants_1['FLOSUM_NAMESPACE']+_0x47fe6b(0x1b1)]:_0x3139ee[_0x47fe6b(0x1ab)],[constants_1[_0x47fe6b(0x22b)]+'Component_Type__c']:_0x3139ee['type'],[constants_1[_0x47fe6b(0x22b)]+_0x47fe6b(0x1d8)]:_0x3139ee[_0x47fe6b(0x21a)],[constants_1[_0x47fe6b(0x22b)]+_0x47fe6b(0x1e2)]:this[_0x47fe6b(0x1fe)],[constants_1['FLOSUM_NAMESPACE']+_0x47fe6b(0x1dc)]:this[_0x47fe6b(0x1ed)],[constants_1[_0x47fe6b(0x22b)]+'Component_History__c']:_0x3c9f57[_0x47fe6b(0x1e3)]};});}async[a401_0x1568d3(0x224)](_0x5be140){const _0x4041d0=a401_0x1568d3;this[_0x4041d0(0x1ff)][_0x4041d0(0x1a7)](_0x4041d0(0x1d3));const _0x229647=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x4041d0(0x22b)]+'Deployment_Result__c',_0x5be140),_0x2f2245=_0x229647[_0x4041d0(0x238)](_0x2309db=>!_0x2309db['success'])[_0x4041d0(0x1f1)](_0x4b121c=>_0x4b121c[_0x4041d0(0x21f)])[_0x4041d0(0x1b2)]();if(_0x2f2245[_0x4041d0(0x22e)])throw new salesforce_dml_error_1[(_0x4041d0(0x210))](_0x2f2245);}async[a401_0x1568d3(0x1d5)](_0x25daf9){const _0x2e65db=a401_0x1568d3;this[_0x2e65db(0x1ff)][_0x2e65db(0x1aa)](_0x25daf9),await this['_logger']['updateLog'](),await this[_0x2e65db(0x1c7)](![],!![],'');}async[a401_0x1568d3(0x1c7)](_0x2edd09,_0x270df9,_0x5607d8){const _0x268581=a401_0x1568d3,_0x5cab3c=_0x268581(0x22d)+this[_0x268581(0x218)]+'/'+this[_0x268581(0x1ed)]+'\x20>\x20'+_0x268581(0x209)+_0x268581(0x232),_0x3de5aa='<a\x20href='+this['_instanceUrl']+'/'+this[_0x268581(0x1fe)]+'\x20>'+this[_0x268581(0x1f9)]+'</a>',_0x4d52df=_0x5cab3c+_0x268581(0x1dd)+_0x3de5aa+'\x20has\x20been\x20created.',_0x3afda9={[constants_1[_0x268581(0x22b)]+_0x268581(0x22a)]:_0x4d52df,[constants_1['FLOSUM_NAMESPACE']+_0x268581(0x1ce)]:new Date(),[constants_1[_0x268581(0x22b)]+'Branch__c']:this[_0x268581(0x219)],[constants_1[_0x268581(0x22b)]+_0x268581(0x1d9)]:_0x268581(0x207),[constants_1[_0x268581(0x22b)]+'Activity_Type__c']:_0x268581(0x1a2),[constants_1[_0x268581(0x22b)]+_0x268581(0x222)]:this[_0x268581(0x1fe)]},_0x26bd8e={[constants_1[_0x268581(0x22b)]+_0x268581(0x1a6)]:!_0x2edd09,[constants_1[_0x268581(0x22b)]+_0x268581(0x200)]:_0x2edd09,[constants_1[_0x268581(0x22b)]+_0x268581(0x201)]:_0x270df9?status_enums_1[_0x268581(0x1e8)]['EXCEPTION']:status_enums_1[_0x268581(0x1e8)][_0x268581(0x1d1)],[constants_1['FLOSUM_NAMESPACE']+_0x268581(0x1a8)]:!![],[constants_1[_0x268581(0x22b)]+_0x268581(0x239)]:_0x5607d8};await this[_0x268581(0x1b7)][_0x268581(0x1d7)](flosum_constants_1[_0x268581(0x1cf)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x268581(0x20a)+this[_0x268581(0x1ed)],_0x26bd8e),await this[_0x268581(0x1b7)]['post'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x268581(0x22b)]+_0x268581(0x1a4),_0x3afda9),this['_logger']['log']('Deploy\x20completed\x20'+(_0x2edd09?'successfully':_0x268581(0x1eb))+'.'),await this[_0x268581(0x1ff)][_0x268581(0x230)]();}}exports[a401_0x1568d3(0x1cd)]=DeployService;