const a373_0x329cc2=a373_0x3649;(function(_0x4f7b17,_0x38f493){const _0x20ef7d=a373_0x3649,_0x370fd0=_0x4f7b17();while(!![]){try{const _0x571285=parseInt(_0x20ef7d(0xf0))/0x1+parseInt(_0x20ef7d(0x152))/0x2+-parseInt(_0x20ef7d(0x164))/0x3*(-parseInt(_0x20ef7d(0x151))/0x4)+parseInt(_0x20ef7d(0x147))/0x5+-parseInt(_0x20ef7d(0x10f))/0x6+-parseInt(_0x20ef7d(0xe7))/0x7*(-parseInt(_0x20ef7d(0x146))/0x8)+-parseInt(_0x20ef7d(0xc9))/0x9;if(_0x571285===_0x38f493)break;else _0x370fd0['push'](_0x370fd0['shift']());}catch(_0x393f86){_0x370fd0['push'](_0x370fd0['shift']());}}}(a373_0x1da5,0x22387));const a373_0x41f8b2=(function(){let _0x3301c9=!![];return function(_0x31d853,_0x590f75){const _0xd377f3=_0x3301c9?function(){const _0x3b8823=a373_0x3649;if(_0x590f75){const _0x3377e3=_0x590f75[_0x3b8823(0x15f)](_0x31d853,arguments);return _0x590f75=null,_0x3377e3;}}:function(){};return _0x3301c9=![],_0xd377f3;};}()),a373_0x1a9761=a373_0x41f8b2(this,function(){const _0x119e51=a373_0x3649;return a373_0x1a9761[_0x119e51(0x131)]()[_0x119e51(0x100)](_0x119e51(0xfd))[_0x119e51(0x131)]()[_0x119e51(0x135)](a373_0x1a9761)[_0x119e51(0x100)]('(((.+)+)+)+$');});function a373_0x1da5(){const _0x151dcf=['log','DeployService','./salesforce.service','Activity_Type__c','356867ulIFYs','\x20:\x20','lastIndexOf','errors','saveLog','filter','\x20</a>','Branch','.zip','123287ZBBbXd','Type__c','deploymentName','External_Deployment_Id__c','MetadataLogStatus','getFlosumComponents','_metadataLogId','catch','packageId','length','_organisationName','Form\x20Deployment\x20Results','success','(((.+)+)+)+$','PackageComponentStatus','Result__c','search','organisationName','fs/promises','TargetId__c','import','execute','from','formFlosumDeploymentResults','isDeployed','Cannot\x20Backup\x20more\x20than\x20200\x20components.','PackageImportService','../../../core','EXCEPTION','VpkService','retrieve','624306OoRXVy','__importDefault','writeFile','updateLog','Deployment_Result__c','retrieveAttachments','_deploymentName','../constants/flosum.constants','Is_Error__c','_logger','componentHistoryId','jszip','../classes/deploy/zip-creator.deploy','ZipCreatorDeploy','stepName','_salesforceService','Branch__c','fetchAttachmentsDetailsByParentId','_branchId','Body','Metadata_Log__c/','application/zip','validate','Retrieving\x20components','has','ENDPOINT_UPSERT_RECORD','Retrieving\x20attachments','packageComponentList','./package-import.service','Cannot\x20retrievers\x20all\x20attachments','_vpkService','SalesforceService','FLOSUM_NAMESPACE','componentType','toString','createZip','Save\x20Deployment\x20Results','name','constructor','<a\x20href=','timeZone','_timeZone','./package-export.service','FlosumComponentVeevaComponentRetriever','Action__c','post','Deployment','Deployment\x20Result','_componentIdList','_tempFolder','base64','export','FlosumConstants','saveBackup','_instanceUrl','24cpqTbj','667830fEdrzN','reduce','type','generateAsync','with\x20error','Cannot\x20retrieve\x20all\x20components.','Veeva_Step_Name__c','map','Status__c','Save\x20Backup\x20to\x20Salesforce','365416KjXmMf','276280CVkoSZ','Join\x20all\x20mdl\x20into\x20one\x20zip','insertMultipleRecords','default','Success','deploymentAction','Component_History__c','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','_connectionSalesforce','finishDeploy','branchId','\x20has\x20been\x20created.','get','apply','Date__c','VeevaService','COMPLETED','componentName','3lgyKFT','shortid','componentIdList','Activity_Item__c','_connectionVeeva','Create\x20vpk\x20package','attachmentLogId','finishDeployWithError','flat','status','Create\x20Backup','toLowerCase','3555648sALHZy','saveDeploymentResults','Metadata_Log__c','error','Succeed__c','./veeva.service','slice','./vpk.service','Component_Name__c','_packageImportService','generate','_veevaService','set','DEPLOYED','createVpk','BranchComponentHistoryFlosumComponentRetriever','_attachmentLogId','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','successfully','createBackup','../enums/status.enums','Job_Completed__c','_organisationId','bind','__esModule','PackageExportService'];a373_0x1da5=function(){return _0x151dcf;};return a373_0x1da5();}a373_0x1a9761();'use strict';var __importDefault=this&&this[a373_0x329cc2(0x110)]||function(_0x5f4818){const _0x1586d0=a373_0x329cc2;return _0x5f4818&&_0x5f4818[_0x1586d0(0xe1)]?_0x5f4818:{'default':_0x5f4818};};Object['defineProperty'](exports,a373_0x329cc2(0xe1),{'value':!![]}),exports[a373_0x329cc2(0xe4)]=void 0x0;const jszip_1=__importDefault(require(a373_0x329cc2(0x11a))),promises_1=require(a373_0x329cc2(0x102)),constants_1=require('../../../constants'),flosum_constants_1=require(a373_0x329cc2(0x116)),veeva_service_1=require(a373_0x329cc2(0xce)),salesforce_service_1=require(a373_0x329cc2(0xe5)),core_1=require(a373_0x329cc2(0x10b)),status_enums_1=require(a373_0x329cc2(0xdd)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a373_0x329cc2(0x165))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a373_0x329cc2(0x12b)),branch_component_history_flosum_component_retriever_1=require(a373_0x329cc2(0xda)),flosum_component_veeva_component_retriever_1=require(a373_0x329cc2(0x159)),package_export_service_1=require(a373_0x329cc2(0x139)),vpk_service_1=require(a373_0x329cc2(0xd0)),zip_creator_deploy_1=require(a373_0x329cc2(0x11b));function a373_0x3649(_0x385ece,_0x1b7574){const _0x43ef93=a373_0x1da5();return a373_0x3649=function(_0x1a9761,_0x41f8b2){_0x1a9761=_0x1a9761-0xbf;let _0x1da51c=_0x43ef93[_0x1a9761];return _0x1da51c;},a373_0x3649(_0x385ece,_0x1b7574);}class DeployService{constructor(_0x28176f,_0x22606b,_0x83c2c5,_0x53e575,_0x14c090,_0x5c84ef){const _0xead5e6=a373_0x329cc2;this['_connectionSalesforce']=_0x22606b,this[_0xead5e6(0xc1)]=_0x83c2c5,this[_0xead5e6(0x118)]=_0x53e575,this['_tempFolder']=_0x14c090,this[_0xead5e6(0x145)]=_0x5c84ef,this[_0xead5e6(0x121)]=_0x28176f[_0xead5e6(0x15c)],this[_0xead5e6(0xf6)]=_0x28176f['metadataLogId'],this[_0xead5e6(0xd9)]=_0x28176f[_0xead5e6(0xc3)],this[_0xead5e6(0xdf)]=_0x28176f['organisationId'],this[_0xead5e6(0x138)]=_0x28176f[_0xead5e6(0x137)],this['_organisationName']=_0x28176f[_0xead5e6(0x101)],this[_0xead5e6(0x13f)]=_0x28176f[_0xead5e6(0xbf)],this[_0xead5e6(0x115)]=_0x28176f[_0xead5e6(0xf2)],this['_systemLogger']=new core_1['Logger']('veeva-deploy'),this[_0xead5e6(0xd4)]=new veeva_service_1[(_0xead5e6(0x161))]({'connection':this[_0xead5e6(0xc1)],'logger':this[_0xead5e6(0x118)]}),this[_0xead5e6(0x11e)]=new salesforce_service_1[(_0xead5e6(0x12e))]({'connection':this[_0xead5e6(0x15a)]}),this[_0xead5e6(0xd2)]=new package_import_service_1[(_0xead5e6(0x10a))]({'veevaService':this['_veevaService'],'connection':this['_connectionVeeva'],'logger':this[_0xead5e6(0x118)],'saveLog':this[_0xead5e6(0xeb)][_0xead5e6(0xe0)](this)}),this['_packageExportService']=new package_export_service_1[(_0xead5e6(0xe2))]({'veevaService':this[_0xead5e6(0xd4)],'connection':this['_connectionVeeva'],'logger':this[_0xead5e6(0x118)]}),this[_0xead5e6(0x12d)]=new vpk_service_1[(_0xead5e6(0x10d))]({'connection':this['_connectionVeeva']});}async['execute'](){const _0x16fdf1=a373_0x329cc2;try{const _0x2605ba=await this['getFlosumComponents']();await this['_logger'][_0x16fdf1(0x112)]();const _0x112fdc=await this[_0x16fdf1(0xdc)](_0x2605ba);await this['saveBackup'](_0x112fdc);const _0x80d77c=await this[_0x16fdf1(0x114)](_0x2605ba),_0x1cbcea=await this[_0x16fdf1(0x132)](_0x80d77c),_0x4388f6=await this[_0x16fdf1(0xd7)](_0x1cbcea);await this[_0x16fdf1(0x118)][_0x16fdf1(0x112)]();const _0x1dbe67=await this[_0x16fdf1(0xd2)][_0x16fdf1(0x104)](_0x4388f6);await this[_0x16fdf1(0x118)]['updateLog']();const _0x1cd3ef=this[_0x16fdf1(0x107)](_0x2605ba,_0x1dbe67[_0x16fdf1(0x12a)]);await this['saveDeploymentResults'](_0x1cd3ef),await this['finishDeploy'](_0x1dbe67[_0x16fdf1(0x108)],![],_0x1dbe67[_0x16fdf1(0xf8)]);}catch(_0xe759b9){await this[_0x16fdf1(0xc4)](_0xe759b9)[_0x16fdf1(0xf7)](_0x1fa007=>this['_systemLogger'][_0x16fdf1(0xcc)](_0x1fa007));}}async[a373_0x329cc2(0xf5)](){const _0x3e562c=a373_0x329cc2,_0x549d79=new Set(this[_0x3e562c(0x13f)]);this[_0x3e562c(0x118)][_0x3e562c(0xe3)](_0x3e562c(0x126));const _0x324426=await new branch_component_history_flosum_component_retriever_1[(_0x3e562c(0xd8))]({'value':this[_0x3e562c(0x121)],'salesforceService':this[_0x3e562c(0x11e)]})[_0x3e562c(0x10e)](),_0x2f6555=_0x324426[_0x3e562c(0xec)](_0x30820e=>_0x549d79[_0x3e562c(0x127)](_0x30820e['id']));if(_0x2f6555['length']!==this[_0x3e562c(0x13f)][_0x3e562c(0xf9)])throw new Error(_0x3e562c(0x14c));return _0x2f6555;}async['createBackup'](_0x91faee){const _0x320be2=a373_0x329cc2;var _0x20ab2d;this[_0x320be2(0x118)][_0x320be2(0xe3)](_0x320be2(0xc7));const _0x375f75=await new flosum_component_veeva_component_retriever_1[(_0x320be2(0x13a))]({'value':_0x91faee,'veevaService':this['_veevaService'],'logger':this['_logger']})[_0x320be2(0x10e)](),_0x35eb1d=await this['_packageExportService'][_0x320be2(0x142)](_0x375f75,'Backup');if(_0x35eb1d['length']>0x1)throw new Error(_0x320be2(0x109));return(_0x20ab2d=_0x35eb1d[0x0])!==null&&_0x20ab2d!==void 0x0?_0x20ab2d:_0x35eb1d[0x0]=new jszip_1[(_0x320be2(0x155))](),_0x35eb1d[0x0][_0x320be2(0x14a)]({'type':_0x320be2(0x141)});}async[a373_0x329cc2(0x144)](_0x2a1643){const _0xe8d977=a373_0x329cc2;this[_0xe8d977(0x118)][_0xe8d977(0xe3)](_0xe8d977(0x150));const _0x10c546={'Body':_0x2a1643,'ContentType':_0xe8d977(0x124),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0xe8d977(0x143)]['BACKUP_ZIP_NAME']};await this[_0xe8d977(0x15a)][_0xe8d977(0x13c)](flosum_constants_1[_0xe8d977(0x143)][_0xe8d977(0x128)]+'/Attachment',_0x10c546);}async[a373_0x329cc2(0x114)](_0x3b7e0b){const _0x1c41f2=a373_0x329cc2;this[_0x1c41f2(0x118)]['log'](_0x1c41f2(0x129));const _0x1dc557=await(0x0,fetch_attachments_1[_0x1c41f2(0x120)])(this['_connectionSalesforce'],_0x3b7e0b['map'](_0x4960ee=>_0x4960ee[_0x1c41f2(0x119)])),_0x7bb253=await(0x0,fetch_attachments_1[_0x1c41f2(0x114)])(_0x1dc557,this[_0x1c41f2(0x15a)]);if(_0x7bb253[_0x1c41f2(0xf9)]!==this[_0x1c41f2(0x13f)]['length'])throw new Error(_0x1c41f2(0x12c));return _0x7bb253['map'](_0x120f98=>_0x120f98['values'][_0x1c41f2(0x122)]);}async[a373_0x329cc2(0x132)](_0x5b86cd){const _0x282929=a373_0x329cc2;this['_logger'][_0x282929(0xe3)](_0x282929(0x153));const _0x1f0fd7=await new zip_creator_deploy_1[(_0x282929(0x11c))]({'attachmentBodies':_0x5b86cd,'deploymentName':this[_0x282929(0x115)]})[_0x282929(0x105)](),_0x357428=this[_0x282929(0x140)]+'/'+(0x0,shortid_1[_0x282929(0x155)])()+_0x282929(0xef);return await(0x0,promises_1[_0x282929(0x111)])(_0x357428,_0x1f0fd7),_0x357428;}async[a373_0x329cc2(0xd7)](_0x294641){const _0x44cb07=a373_0x329cc2;this['_logger'][_0x44cb07(0xe3)](_0x44cb07(0xc2));const _0x218c0b=await this['_vpkService'][_0x44cb07(0xd3)](_0x294641),_0x5cbb65=this['_tempFolder']+'/vpk__'+_0x294641[_0x44cb07(0xcf)](_0x294641[_0x44cb07(0xe9)]('/')+0x1);return await(0x0,promises_1[_0x44cb07(0x111)])(_0x5cbb65,_0x218c0b),await this[_0x44cb07(0x12d)][_0x44cb07(0x125)](_0x5cbb65),_0x5cbb65;}async[a373_0x329cc2(0xeb)](_0x2773a9,_0x5ea1d6){const _0x5f2e54=a373_0x329cc2;this[_0x5f2e54(0x118)][_0x5f2e54(0xe3)]('Save\x20log');const _0x468661={'Body':Buffer[_0x5f2e54(0x106)](_0x2773a9)['toString'](_0x5f2e54(0x141)),'ContentType':'text/plain','ParentId':this[_0x5f2e54(0xf6)],'Name':_0x5ea1d6};await this[_0x5f2e54(0x15a)][_0x5f2e54(0x13c)](flosum_constants_1[_0x5f2e54(0x143)][_0x5f2e54(0x128)]+'/Attachment',_0x468661);}[a373_0x329cc2(0x107)](_0x2a3786,_0x4a3a3c){const _0x49f6ea=a373_0x329cc2;this[_0x49f6ea(0x118)][_0x49f6ea(0xe3)](_0x49f6ea(0xfb));const _0x2e63fa=_0x2a3786[_0x49f6ea(0x148)]((_0x571020,_0x51bc9f)=>_0x571020[_0x49f6ea(0xd5)]((_0x51bc9f[_0x49f6ea(0x130)]+'.'+_0x51bc9f[_0x49f6ea(0x163)])[_0x49f6ea(0xc8)](),_0x51bc9f),new Map());return _0x4a3a3c[_0x49f6ea(0x14e)](_0x26b4d2=>{const _0x1c3749=_0x49f6ea;this['_logger'][_0x1c3749(0xe3)](_0x26b4d2['type']+'.'+_0x26b4d2[_0x1c3749(0x134)]+_0x1c3749(0xe8)+_0x26b4d2[_0x1c3749(0xc6)]);const _0x9bab01=(_0x26b4d2['type']+'.'+_0x26b4d2[_0x1c3749(0x134)])[_0x1c3749(0xc8)](),_0x3ce369=_0x2e63fa[_0x1c3749(0x15e)](_0x9bab01);return{[constants_1[_0x1c3749(0x12f)]+_0x1c3749(0xf1)]:_0x1c3749(0x13e),[constants_1[_0x1c3749(0x12f)]+_0x1c3749(0x14f)]:_0x26b4d2['status']===status_enums_1[_0x1c3749(0xfe)][_0x1c3749(0xd6)]?_0x1c3749(0x156):'Failure',[constants_1[_0x1c3749(0x12f)]+_0x1c3749(0xff)]:_0x26b4d2[_0x1c3749(0x157)],[constants_1[_0x1c3749(0x12f)]+_0x1c3749(0xd1)]:_0x26b4d2[_0x1c3749(0x134)],[constants_1[_0x1c3749(0x12f)]+'Component_Type__c']:_0x26b4d2[_0x1c3749(0x149)],[constants_1[_0x1c3749(0x12f)]+_0x1c3749(0x14d)]:_0x26b4d2[_0x1c3749(0x11d)],[constants_1[_0x1c3749(0x12f)]+'Org__c']:this[_0x1c3749(0xdf)],[constants_1['FLOSUM_NAMESPACE']+_0x1c3749(0xcb)]:this['_metadataLogId'],[constants_1[_0x1c3749(0x12f)]+_0x1c3749(0x158)]:_0x3ce369['componentHistoryId']};});}async[a373_0x329cc2(0xca)](_0x1d16ec){const _0x1c9a89=a373_0x329cc2;this['_logger']['log'](_0x1c9a89(0x133));const _0x259a2a=await this['_salesforceService'][_0x1c9a89(0x154)](constants_1[_0x1c9a89(0x12f)]+_0x1c9a89(0x113),_0x1d16ec),_0x57a1cb=_0x259a2a[_0x1c9a89(0xec)](_0x10855a=>!_0x10855a[_0x1c9a89(0xfc)])['map'](_0x5619fe=>_0x5619fe[_0x1c9a89(0xea)])[_0x1c9a89(0xc5)]();if(_0x57a1cb[_0x1c9a89(0xf9)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x57a1cb);}async[a373_0x329cc2(0xc4)](_0x464839){const _0x45c80a=a373_0x329cc2;this[_0x45c80a(0x118)]['logError'](_0x464839),await this[_0x45c80a(0x118)][_0x45c80a(0x112)](),await this[_0x45c80a(0x15b)](![],!![],'');}async[a373_0x329cc2(0x15b)](_0x45af29,_0xeac395,_0xa909e3){const _0x2853f9=a373_0x329cc2,_0x32dffb=_0x2853f9(0x136)+this[_0x2853f9(0x145)]+'/'+this[_0x2853f9(0xf6)]+'\x20>\x20'+'Veeva\x20Deployment'+_0x2853f9(0xed),_0x1289a6=_0x2853f9(0x136)+this[_0x2853f9(0x145)]+'/'+this[_0x2853f9(0xdf)]+'\x20>'+this[_0x2853f9(0xfa)]+'</a>',_0x6f5ad5=_0x32dffb+'\x20of\x20branch\x20to\x20Organization\x20'+_0x1289a6+_0x2853f9(0x15d),_0x45d34a={[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0x13b)]:_0x6f5ad5,[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0x160)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x2853f9(0x11f)]:this[_0x2853f9(0x121)],[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0xc0)]:_0x2853f9(0xee),[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0xe6)]:_0x2853f9(0x13d),[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0x103)]:this[_0x2853f9(0xdf)]},_0x519dc5={[constants_1['FLOSUM_NAMESPACE']+_0x2853f9(0x117)]:!_0x45af29,[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0xcd)]:_0x45af29,[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0x14f)]:_0xeac395?status_enums_1[_0x2853f9(0xf4)][_0x2853f9(0x10c)]:status_enums_1[_0x2853f9(0xf4)][_0x2853f9(0x162)],[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0xde)]:!![],[constants_1[_0x2853f9(0x12f)]+_0x2853f9(0xf3)]:_0xa909e3};await this[_0x2853f9(0x15a)]['patch'](flosum_constants_1[_0x2853f9(0x143)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x2853f9(0x123)+this['_metadataLogId'],_0x519dc5),await this[_0x2853f9(0x15a)][_0x2853f9(0x13c)](flosum_constants_1[_0x2853f9(0x143)][_0x2853f9(0x128)]+'/'+constants_1[_0x2853f9(0x12f)]+'Log__c',_0x45d34a),this[_0x2853f9(0x118)][_0x2853f9(0xe3)]('Deploy\x20completed\x20'+(_0x45af29?_0x2853f9(0xdb):_0x2853f9(0x14b))+'.'),await this['_logger']['updateLog']();}}exports['DeployService']=DeployService;