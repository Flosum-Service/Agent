const a401_0x2bf2bb=a401_0x3f4b;(function(_0x51dd5b,_0x398421){const _0x52719b=a401_0x3f4b,_0x35803c=_0x51dd5b();while(!![]){try{const _0xa9dfaa=parseInt(_0x52719b(0x214))/0x1*(parseInt(_0x52719b(0x206))/0x2)+parseInt(_0x52719b(0x1fe))/0x3+parseInt(_0x52719b(0x1e2))/0x4*(parseInt(_0x52719b(0x273))/0x5)+parseInt(_0x52719b(0x258))/0x6*(parseInt(_0x52719b(0x250))/0x7)+parseInt(_0x52719b(0x219))/0x8*(parseInt(_0x52719b(0x1fb))/0x9)+-parseInt(_0x52719b(0x1ed))/0xa*(-parseInt(_0x52719b(0x1e9))/0xb)+-parseInt(_0x52719b(0x1d8))/0xc;if(_0xa9dfaa===_0x398421)break;else _0x35803c['push'](_0x35803c['shift']());}catch(_0x81026c){_0x35803c['push'](_0x35803c['shift']());}}}(a401_0x3149,0x83939));const a401_0xd51003=(function(){let _0x393c71=!![];return function(_0x390a9e,_0x422844){const _0xeaf667=_0x393c71?function(){const _0x25bf72=a401_0x3f4b;if(_0x422844){const _0x1c9b98=_0x422844[_0x25bf72(0x25f)](_0x390a9e,arguments);return _0x422844=null,_0x1c9b98;}}:function(){};return _0x393c71=![],_0xeaf667;};}()),a401_0x23b766=a401_0xd51003(this,function(){const _0x4156e2=a401_0x3f4b;return a401_0x23b766['toString']()[_0x4156e2(0x26f)](_0x4156e2(0x25b))[_0x4156e2(0x248)]()[_0x4156e2(0x1fc)](a401_0x23b766)['search']('(((.+)+)+)+$');});function a401_0x3f4b(_0x2e2039,_0x4f8a61){const _0x455fdd=a401_0x3149();return a401_0x3f4b=function(_0x23b766,_0xd51003){_0x23b766=_0x23b766-0x1d1;let _0x314999=_0x455fdd[_0x23b766];return _0x314999;},a401_0x3f4b(_0x2e2039,_0x4f8a61);}a401_0x23b766();'use strict';var __importDefault=this&&this[a401_0x2bf2bb(0x257)]||function(_0x16b3c3){const _0x4ab8ee=a401_0x2bf2bb;return _0x16b3c3&&_0x16b3c3[_0x4ab8ee(0x27a)]?_0x16b3c3:{'default':_0x16b3c3};};Object[a401_0x2bf2bb(0x266)](exports,a401_0x2bf2bb(0x27a),{'value':!![]}),exports[a401_0x2bf2bb(0x204)]=void 0x0;const jszip_1=__importDefault(require(a401_0x2bf2bb(0x264))),promises_1=require(a401_0x2bf2bb(0x201)),constants_1=require(a401_0x2bf2bb(0x202)),flosum_constants_1=require(a401_0x2bf2bb(0x1e3)),veeva_service_1=require(a401_0x2bf2bb(0x218)),salesforce_service_1=require('./salesforce.service'),core_1=require(a401_0x2bf2bb(0x269)),status_enums_1=require(a401_0x2bf2bb(0x222)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require(a401_0x2bf2bb(0x253)),package_import_service_1=require(a401_0x2bf2bb(0x220)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a401_0x2bf2bb(0x209)),package_export_service_1=require(a401_0x2bf2bb(0x24a)),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require(a401_0x2bf2bb(0x24f));function a401_0x3149(){const _0x4f6b2f=['metadataLogId','DeployService','COMPLETED','27796rqYbcC','packageId','_organisationName','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Success','_salesforceService','BranchComponentHistoryFlosumComponentRetriever','.zip','type','success','FlosumConstants','Cannot\x20retrievers\x20all\x20attachments','<a\x20href=','Component_Name__c','4HPzLtQ','_connectionVeeva','\x20of\x20branch\x20to\x20Organization\x20','_logger','./veeva.service','492608hazpHt','branchId','flat','execute','Date__c','deploymentAction','updateLog','./package-import.service','status','../enums/status.enums','VeevaService','MetadataLogStatus','saveLog','_branchId','componentIdList','retrieve','fetchAttachmentsDetailsByParentId','Succeed__c','</a>','error','retrieveAttachments','_deploymentName','_packageImportService','import','\x20</a>','Backup','componentHistoryId','Activity_Type__c','Activity_Item__c','Log__c','saveDeploymentResults','_attachmentLogId','_instanceUrl','Is_Error__c','log','Org__c','ENDPOINT_UPSERT_RECORD','validate','length','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Veeva_Step_Name__c','componentType','values','Component_History__c','Cannot\x20retrieve\x20all\x20components.','\x20:\x20','_metadataLogId','toString','set','./package-export.service','EXCEPTION','_componentIdList','Create\x20vpk\x20package','getFlosumComponents','../classes/deploy/zip-creator.deploy','5582633FkifBz','createBackup','from','../../shared/utils/fetch-attachments','organisationId','_veevaService','Branch','__importDefault','6fvkkcK','insertMultipleRecords','/vpk__','(((.+)+)+)+$','Component_Type__c','createVpk','BACKUP_ZIP_NAME','apply','Deployment_Result__c','Retrieving\x20components','_packageExportService','base64','jszip','Metadata_Log__c/','defineProperty','map','Branch__c','../../../core','DEPLOYED','\x20>\x20','Save\x20Backup\x20to\x20Salesforce','finishDeployWithError','name','search','toLowerCase','veeva-deploy','_organisationId','5046740aawYip','formFlosumDeploymentResults','generateAsync','catch','Status__c','ZipCreatorDeploy','slice','__esModule','/Attachment','_tempFolder','componentName','PackageExportService','writeFile','export','with\x20error','42366384ZmVauS','reduce','FlosumComponentVeevaComponentRetriever','saveBackup','finishDeploy','bind','SalesforceService','generate','stepName','Retrieving\x20attachments','4ronvbo','../constants/flosum.constants','patch','attachmentLogId','Type__c','get','post','11bwOUie','FLOSUM_NAMESPACE','application/zip','_connectionSalesforce','4784810uuRCaC','_vpkService','Deployment','Join\x20all\x20mdl\x20into\x20one\x20zip','SalesforceDmlError','Veeva\x20Deployment','Deployment\x20Result','_systemLogger','_timeZone','VpkService','PackageImportService','default','Body','errors','99FliUYB','constructor','isDeployed','3153579DHUhJU','packageComponentList','lastIndexOf','fs/promises','../../../constants'];a401_0x3149=function(){return _0x4f6b2f;};return a401_0x3149();}class DeployService{constructor(_0x32fae3,_0x38e168,_0x3a14a2,_0xfb1358,_0x472926,_0x5cfb49){const _0x256cdb=a401_0x2bf2bb;this[_0x256cdb(0x1ec)]=_0x38e168,this[_0x256cdb(0x215)]=_0x3a14a2,this[_0x256cdb(0x217)]=_0xfb1358,this[_0x256cdb(0x1d2)]=_0x472926,this['_instanceUrl']=_0x5cfb49,this[_0x256cdb(0x226)]=_0x32fae3[_0x256cdb(0x21a)],this['_metadataLogId']=_0x32fae3[_0x256cdb(0x203)],this[_0x256cdb(0x238)]=_0x32fae3[_0x256cdb(0x1e5)],this[_0x256cdb(0x272)]=_0x32fae3[_0x256cdb(0x254)],this[_0x256cdb(0x1f5)]=_0x32fae3['timeZone'],this['_organisationName']=_0x32fae3['organisationName'],this[_0x256cdb(0x24c)]=_0x32fae3[_0x256cdb(0x227)],this[_0x256cdb(0x22e)]=_0x32fae3['deploymentName'],this[_0x256cdb(0x1f4)]=new core_1['Logger'](_0x256cdb(0x271)),this[_0x256cdb(0x255)]=new veeva_service_1[(_0x256cdb(0x223))]({'connection':this[_0x256cdb(0x215)],'logger':this[_0x256cdb(0x217)]}),this['_salesforceService']=new salesforce_service_1[(_0x256cdb(0x1de))]({'connection':this['_connectionSalesforce']}),this[_0x256cdb(0x22f)]=new package_import_service_1[(_0x256cdb(0x1f7))]({'veevaService':this[_0x256cdb(0x255)],'connection':this[_0x256cdb(0x215)],'logger':this[_0x256cdb(0x217)],'saveLog':this[_0x256cdb(0x225)][_0x256cdb(0x1dd)](this)}),this[_0x256cdb(0x262)]=new package_export_service_1[(_0x256cdb(0x1d4))]({'veevaService':this['_veevaService'],'connection':this[_0x256cdb(0x215)],'logger':this[_0x256cdb(0x217)]}),this[_0x256cdb(0x1ee)]=new vpk_service_1[(_0x256cdb(0x1f6))]({'connection':this[_0x256cdb(0x215)]});}async[a401_0x2bf2bb(0x21c)](){const _0x4caf4a=a401_0x2bf2bb;try{const _0x1cf6c9=await this[_0x4caf4a(0x24e)]();await this[_0x4caf4a(0x217)]['updateLog']();const _0x13c741=await this[_0x4caf4a(0x251)](_0x1cf6c9);await this[_0x4caf4a(0x1db)](_0x13c741);const _0x5f18fb=await this[_0x4caf4a(0x22d)](_0x1cf6c9),_0x21a7f9=await this['createZip'](_0x5f18fb),_0xde58a3=await this[_0x4caf4a(0x25d)](_0x21a7f9);await this[_0x4caf4a(0x217)][_0x4caf4a(0x21f)]();const _0x27c63=await this[_0x4caf4a(0x22f)][_0x4caf4a(0x230)](_0xde58a3);await this['_logger'][_0x4caf4a(0x21f)]();const _0x1f9be2=this['formFlosumDeploymentResults'](_0x1cf6c9,_0x27c63[_0x4caf4a(0x1ff)]);await this[_0x4caf4a(0x237)](_0x1f9be2),await this[_0x4caf4a(0x1dc)](_0x27c63[_0x4caf4a(0x1fd)],![],_0x27c63[_0x4caf4a(0x207)]);}catch(_0x46ad6c){await this[_0x4caf4a(0x26d)](_0x46ad6c)[_0x4caf4a(0x276)](_0x3620b8=>this['_systemLogger'][_0x4caf4a(0x22c)](_0x3620b8));}}async[a401_0x2bf2bb(0x24e)](){const _0x489599=a401_0x2bf2bb,_0x44ed75=new Set(this[_0x489599(0x24c)]);this['_logger'][_0x489599(0x23b)](_0x489599(0x261));const _0x44648e=await new branch_component_history_flosum_component_retriever_1[(_0x489599(0x20c))]({'value':this[_0x489599(0x226)],'salesforceService':this[_0x489599(0x20b)]})[_0x489599(0x228)](),_0x40915d=_0x44648e['filter'](_0x1e8672=>_0x44ed75['has'](_0x1e8672['id']));if(_0x40915d[_0x489599(0x23f)]!==this[_0x489599(0x24c)][_0x489599(0x23f)])throw new Error(_0x489599(0x245));return _0x40915d;}async[a401_0x2bf2bb(0x251)](_0x3ecb17){const _0x1c7031=a401_0x2bf2bb;var _0x4a399f;this[_0x1c7031(0x217)][_0x1c7031(0x23b)]('Create\x20Backup');const _0x192eb7=await new flosum_component_veeva_component_retriever_1[(_0x1c7031(0x1da))]({'value':_0x3ecb17,'veevaService':this[_0x1c7031(0x255)],'logger':this[_0x1c7031(0x217)]})[_0x1c7031(0x228)](),_0xc908aa=await this[_0x1c7031(0x262)][_0x1c7031(0x1d6)](_0x192eb7,_0x1c7031(0x232));if(_0xc908aa['length']>0x1)throw new Error(_0x1c7031(0x240));return(_0x4a399f=_0xc908aa[0x0])!==null&&_0x4a399f!==void 0x0?_0x4a399f:_0xc908aa[0x0]=new jszip_1[(_0x1c7031(0x1f8))](),_0xc908aa[0x0][_0x1c7031(0x275)]({'type':_0x1c7031(0x263)});}async[a401_0x2bf2bb(0x1db)](_0x25f468){const _0x2dcd3f=a401_0x2bf2bb;this[_0x2dcd3f(0x217)][_0x2dcd3f(0x23b)](_0x2dcd3f(0x26c));const _0x4cebfd={'Body':_0x25f468,'ContentType':_0x2dcd3f(0x1eb),'ParentId':this[_0x2dcd3f(0x247)],'Name':flosum_constants_1[_0x2dcd3f(0x210)][_0x2dcd3f(0x25e)]};await this[_0x2dcd3f(0x1ec)][_0x2dcd3f(0x1e8)](flosum_constants_1[_0x2dcd3f(0x210)]['ENDPOINT_UPSERT_RECORD']+_0x2dcd3f(0x1d1),_0x4cebfd);}async[a401_0x2bf2bb(0x22d)](_0x53697e){const _0x177ad3=a401_0x2bf2bb;this[_0x177ad3(0x217)]['log'](_0x177ad3(0x1e1));const _0x2335ed=await(0x0,fetch_attachments_1[_0x177ad3(0x229)])(this[_0x177ad3(0x1ec)],_0x53697e[_0x177ad3(0x267)](_0x12f2a2=>_0x12f2a2[_0x177ad3(0x233)])),_0x2842b8=await(0x0,fetch_attachments_1[_0x177ad3(0x22d)])(_0x2335ed,this[_0x177ad3(0x1ec)]);if(_0x2842b8[_0x177ad3(0x23f)]!==this['_componentIdList'][_0x177ad3(0x23f)])throw new Error(_0x177ad3(0x211));return _0x2842b8[_0x177ad3(0x267)](_0x41cc27=>_0x41cc27[_0x177ad3(0x243)][_0x177ad3(0x1f9)]);}async['createZip'](_0x4e74c1){const _0x5905bb=a401_0x2bf2bb;this[_0x5905bb(0x217)][_0x5905bb(0x23b)](_0x5905bb(0x1f0));const _0x18f8e1=await new zip_creator_deploy_1[(_0x5905bb(0x278))]({'attachmentBodies':_0x4e74c1,'deploymentName':this[_0x5905bb(0x22e)]})[_0x5905bb(0x21c)](),_0x29ccb5=this[_0x5905bb(0x1d2)]+'/'+(0x0,shortid_1['default'])()+_0x5905bb(0x20d);return await(0x0,promises_1[_0x5905bb(0x1d5)])(_0x29ccb5,_0x18f8e1),_0x29ccb5;}async['createVpk'](_0x4b3c17){const _0x52230c=a401_0x2bf2bb;this[_0x52230c(0x217)][_0x52230c(0x23b)](_0x52230c(0x24d));const _0x253c1c=await this[_0x52230c(0x1ee)][_0x52230c(0x1df)](_0x4b3c17),_0x4eef5a=this['_tempFolder']+_0x52230c(0x25a)+_0x4b3c17[_0x52230c(0x279)](_0x4b3c17[_0x52230c(0x200)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x4eef5a,_0x253c1c),await this[_0x52230c(0x1ee)][_0x52230c(0x23e)](_0x4eef5a),_0x4eef5a;}async[a401_0x2bf2bb(0x225)](_0x26d6a6,_0x492b37){const _0x229b32=a401_0x2bf2bb;this[_0x229b32(0x217)]['log']('Save\x20log');const _0xda022a={'Body':Buffer[_0x229b32(0x252)](_0x26d6a6)[_0x229b32(0x248)](_0x229b32(0x263)),'ContentType':'text/plain','ParentId':this[_0x229b32(0x247)],'Name':_0x492b37};await this[_0x229b32(0x1ec)][_0x229b32(0x1e8)](flosum_constants_1['FlosumConstants'][_0x229b32(0x23d)]+_0x229b32(0x1d1),_0xda022a);}[a401_0x2bf2bb(0x274)](_0x192e2f,_0x5cd99e){const _0x801480=a401_0x2bf2bb;this[_0x801480(0x217)][_0x801480(0x23b)]('Form\x20Deployment\x20Results');const _0x16ba6a=_0x192e2f[_0x801480(0x1d9)]((_0x365e85,_0x206d71)=>_0x365e85[_0x801480(0x249)]((_0x206d71[_0x801480(0x242)]+'.'+_0x206d71[_0x801480(0x1d3)])[_0x801480(0x270)](),_0x206d71),new Map());return _0x5cd99e[_0x801480(0x267)](_0x5691f5=>{const _0x768b5d=_0x801480;this[_0x768b5d(0x217)][_0x768b5d(0x23b)](_0x5691f5['type']+'.'+_0x5691f5['name']+_0x768b5d(0x246)+_0x5691f5[_0x768b5d(0x221)]);const _0x7e480e=(_0x5691f5[_0x768b5d(0x20e)]+'.'+_0x5691f5[_0x768b5d(0x26e)])[_0x768b5d(0x270)](),_0x5e395e=_0x16ba6a[_0x768b5d(0x1e7)](_0x7e480e);return{[constants_1[_0x768b5d(0x1ea)]+_0x768b5d(0x1e6)]:_0x768b5d(0x1f3),[constants_1[_0x768b5d(0x1ea)]+_0x768b5d(0x277)]:_0x5691f5[_0x768b5d(0x221)]===status_enums_1['PackageComponentStatus'][_0x768b5d(0x26a)]?_0x768b5d(0x20a):'Failure',[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x5691f5[_0x768b5d(0x21e)],[constants_1[_0x768b5d(0x1ea)]+_0x768b5d(0x213)]:_0x5691f5[_0x768b5d(0x26e)],[constants_1[_0x768b5d(0x1ea)]+_0x768b5d(0x25c)]:_0x5691f5['type'],[constants_1[_0x768b5d(0x1ea)]+_0x768b5d(0x241)]:_0x5691f5[_0x768b5d(0x1e0)],[constants_1[_0x768b5d(0x1ea)]+_0x768b5d(0x23c)]:this[_0x768b5d(0x272)],[constants_1[_0x768b5d(0x1ea)]+'Metadata_Log__c']:this[_0x768b5d(0x247)],[constants_1[_0x768b5d(0x1ea)]+_0x768b5d(0x244)]:_0x5e395e[_0x768b5d(0x233)]};});}async['saveDeploymentResults'](_0x18ce1c){const _0x3a25eb=a401_0x2bf2bb;this['_logger']['log']('Save\x20Deployment\x20Results');const _0x35636d=await this[_0x3a25eb(0x20b)][_0x3a25eb(0x259)](constants_1[_0x3a25eb(0x1ea)]+_0x3a25eb(0x260),_0x18ce1c),_0x2cbc6b=_0x35636d['filter'](_0x1e80ea=>!_0x1e80ea[_0x3a25eb(0x20f)])[_0x3a25eb(0x267)](_0x2c7928=>_0x2c7928[_0x3a25eb(0x1fa)])[_0x3a25eb(0x21b)]();if(_0x2cbc6b['length'])throw new salesforce_dml_error_1[(_0x3a25eb(0x1f1))](_0x2cbc6b);}async[a401_0x2bf2bb(0x26d)](_0x3006b9){const _0x512b7f=a401_0x2bf2bb;this[_0x512b7f(0x217)]['logError'](_0x3006b9),await this[_0x512b7f(0x217)][_0x512b7f(0x21f)](),await this[_0x512b7f(0x1dc)](![],!![],'');}async[a401_0x2bf2bb(0x1dc)](_0x48768c,_0x1c6e05,_0x37f129){const _0x50aa86=a401_0x2bf2bb,_0x2135b1=_0x50aa86(0x212)+this['_instanceUrl']+'/'+this[_0x50aa86(0x247)]+_0x50aa86(0x26b)+_0x50aa86(0x1f2)+_0x50aa86(0x231),_0x5bf595=_0x50aa86(0x212)+this[_0x50aa86(0x239)]+'/'+this[_0x50aa86(0x272)]+'\x20>'+this[_0x50aa86(0x208)]+_0x50aa86(0x22b),_0x402a20=_0x2135b1+_0x50aa86(0x216)+_0x5bf595+'\x20has\x20been\x20created.',_0x2155ee={[constants_1[_0x50aa86(0x1ea)]+'Action__c']:_0x402a20,[constants_1[_0x50aa86(0x1ea)]+_0x50aa86(0x21d)]:new Date(),[constants_1[_0x50aa86(0x1ea)]+_0x50aa86(0x268)]:this[_0x50aa86(0x226)],[constants_1[_0x50aa86(0x1ea)]+_0x50aa86(0x235)]:_0x50aa86(0x256),[constants_1[_0x50aa86(0x1ea)]+_0x50aa86(0x234)]:_0x50aa86(0x1ef),[constants_1[_0x50aa86(0x1ea)]+'TargetId__c']:this['_organisationId']},_0x163a81={[constants_1[_0x50aa86(0x1ea)]+_0x50aa86(0x23a)]:!_0x48768c,[constants_1['FLOSUM_NAMESPACE']+_0x50aa86(0x22a)]:_0x48768c,[constants_1['FLOSUM_NAMESPACE']+_0x50aa86(0x277)]:_0x1c6e05?status_enums_1['MetadataLogStatus'][_0x50aa86(0x24b)]:status_enums_1[_0x50aa86(0x224)][_0x50aa86(0x205)],[constants_1['FLOSUM_NAMESPACE']+'Job_Completed__c']:!![],[constants_1[_0x50aa86(0x1ea)]+'External_Deployment_Id__c']:_0x37f129};await this[_0x50aa86(0x1ec)][_0x50aa86(0x1e4)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x50aa86(0x1ea)]+_0x50aa86(0x265)+this[_0x50aa86(0x247)],_0x163a81),await this[_0x50aa86(0x1ec)]['post'](flosum_constants_1[_0x50aa86(0x210)][_0x50aa86(0x23d)]+'/'+constants_1[_0x50aa86(0x1ea)]+_0x50aa86(0x236),_0x2155ee),this['_logger']['log']('Deploy\x20completed\x20'+(_0x48768c?'successfully':_0x50aa86(0x1d7))+'.'),await this[_0x50aa86(0x217)][_0x50aa86(0x21f)]();}}exports[a401_0x2bf2bb(0x204)]=DeployService;