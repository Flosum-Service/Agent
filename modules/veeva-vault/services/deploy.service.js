const a374_0x558f15=a374_0x432d;function a374_0x432d(_0x80ee18,_0x408c02){const _0x547aea=a374_0x412f();return a374_0x432d=function(_0x4b2946,_0x3c4a73){_0x4b2946=_0x4b2946-0x8d;let _0x412f11=_0x547aea[_0x4b2946];return _0x412f11;},a374_0x432d(_0x80ee18,_0x408c02);}(function(_0x3ecce6,_0x5355d3){const _0xd79c81=a374_0x432d,_0x46e154=_0x3ecce6();while(!![]){try{const _0x252cea=-parseInt(_0xd79c81(0x118))/0x1*(parseInt(_0xd79c81(0x99))/0x2)+-parseInt(_0xd79c81(0x114))/0x3+parseInt(_0xd79c81(0xda))/0x4+-parseInt(_0xd79c81(0x9f))/0x5*(parseInt(_0xd79c81(0xff))/0x6)+parseInt(_0xd79c81(0x113))/0x7+-parseInt(_0xd79c81(0xf2))/0x8*(-parseInt(_0xd79c81(0x109))/0x9)+-parseInt(_0xd79c81(0x110))/0xa*(-parseInt(_0xd79c81(0xa0))/0xb);if(_0x252cea===_0x5355d3)break;else _0x46e154['push'](_0x46e154['shift']());}catch(_0x44dbf8){_0x46e154['push'](_0x46e154['shift']());}}}(a374_0x412f,0x67dcc));const a374_0x3c4a73=(function(){let _0xb2cd53=!![];return function(_0x6e6636,_0x11a2b4){const _0x1e99c2=_0xb2cd53?function(){const _0x54d423=a374_0x432d;if(_0x11a2b4){const _0x3d8337=_0x11a2b4[_0x54d423(0x9e)](_0x6e6636,arguments);return _0x11a2b4=null,_0x3d8337;}}:function(){};return _0xb2cd53=![],_0x1e99c2;};}()),a374_0x4b2946=a374_0x3c4a73(this,function(){const _0x56ae29=a374_0x432d;return a374_0x4b2946[_0x56ae29(0xfb)]()[_0x56ae29(0xaa)](_0x56ae29(0xa6))[_0x56ae29(0xfb)]()[_0x56ae29(0xc6)](a374_0x4b2946)[_0x56ae29(0xaa)](_0x56ae29(0xa6));});a374_0x4b2946();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2fef88){const _0x2142ee=a374_0x432d;return _0x2fef88&&_0x2fef88[_0x2142ee(0x11b)]?_0x2fef88:{'default':_0x2fef88};};Object[a374_0x558f15(0xfd)](exports,'__esModule',{'value':!![]}),exports['DeployService']=void 0x0;function a374_0x412f(){const _0x1601e2=['map','Save\x20log','_salesforceService','Cannot\x20retrieve\x20all\x20components.','formFlosumDeploymentResults','reduce','export','default','veeva-deploy','TargetId__c','Activity_Item__c','updateLog','Veeva_Step_Name__c','1355908wdfxDB','import','deploymentAction','../constants/flosum.constants','External_Deployment_Id__c','catch','jszip','_componentIdList','getFlosumComponents','Form\x20Deployment\x20Results','Create\x20Backup','./vpk.service','Failure','writeFile','success','Cannot\x20retrievers\x20all\x20attachments','bind','Log__c','_logger','attachmentLogId','_veevaService','Component_Type__c','Veeva\x20Deployment','Is_Error__c','1771280aYgWUE','FlosumComponentVeevaComponentRetriever','Status__c','organisationId','./salesforce.service','Type__c','Cannot\x20Backup\x20more\x20than\x20200\x20components.','createBackup','Retrieving\x20components','toString','DeployService','defineProperty','flat','81222hSKbXf','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','PackageExportService','name','error','../classes/deploy/zip-creator.deploy','_timeZone','../../../core','Deploy\x20completed\x20','from','9nnWkHX','stepName','log','Org__c','VpkService','_attachmentLogId','_organisationName','1370EDMGSB','saveLog','_connectionSalesforce','1393966BSCXWf','1734183BzMmcS','componentType','\x20:\x20','ENDPOINT_UPSERT_RECORD','14tjfzlk','Join\x20all\x20mdl\x20into\x20one\x20zip','.zip','__esModule','length','SalesforceService','text/plain','post','branchId','_systemLogger','VeevaService','../enums/status.enums','createZip','Retrieving\x20attachments','retrieve','Save\x20Deployment\x20Results','/Attachment','_tempFolder','./package-import.service','Deployment_Result__c','Date__c','retrieveAttachments','packageId','Result__c','_packageImportService','slice','finishDeployWithError','packageComponentList','logError','Metadata_Log__c','get','_packageExportService','set','MetadataLogStatus','organisationName','\x20of\x20branch\x20to\x20Organization\x20','64762qQLVWn','Save\x20Backup\x20to\x20Salesforce','base64','validate','</a>','apply','45YTwzLo','65769HuenWZ','_vpkService','filter','_deploymentName','application/zip','_instanceUrl','(((.+)+)+)+$','metadataLogId','BACKUP_ZIP_NAME','componentHistoryId','search','FLOSUM_NAMESPACE','Metadata_Log__c/','FlosumConstants','has','insertMultipleRecords','values','\x20has\x20been\x20created.','BranchComponentHistoryFlosumComponentRetriever','<a\x20href=','\x20>\x20','Succeed__c','with\x20error','finishDeploy','Branch__c','fetchAttachmentsDetailsByParentId','_metadataLogId','saveBackup','_branchId','Backup','execute','Branch','PackageComponentStatus','/vpk__','Component_History__c','shortid','_connectionVeeva','type','constructor','createVpk','_organisationId','Deployment','toLowerCase','Success','componentName'];a374_0x412f=function(){return _0x1601e2;};return a374_0x412f();}const jszip_1=__importDefault(require(a374_0x558f15(0xe0))),promises_1=require('fs/promises'),constants_1=require('../../../constants'),flosum_constants_1=require(a374_0x558f15(0xdd)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a374_0x558f15(0xf6)),core_1=require(a374_0x558f15(0x106)),status_enums_1=require(a374_0x558f15(0x123)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a374_0x558f15(0xc3))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a374_0x558f15(0x12a)),branch_component_history_flosum_component_retriever_1=require(a374_0x558f15(0x100)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a374_0x558f15(0xe5)),zip_creator_deploy_1=require(a374_0x558f15(0x104));class DeployService{constructor(_0x41db8a,_0x33019f,_0x4bddb5,_0x5a02f0,_0x51a539,_0x30ab2e){const _0x44ec15=a374_0x558f15;this['_connectionSalesforce']=_0x33019f,this['_connectionVeeva']=_0x4bddb5,this[_0x44ec15(0xec)]=_0x5a02f0,this[_0x44ec15(0x129)]=_0x51a539,this['_instanceUrl']=_0x30ab2e,this[_0x44ec15(0xbc)]=_0x41db8a[_0x44ec15(0x120)],this['_metadataLogId']=_0x41db8a[_0x44ec15(0xa7)],this[_0x44ec15(0x10e)]=_0x41db8a[_0x44ec15(0xed)],this[_0x44ec15(0xc8)]=_0x41db8a[_0x44ec15(0xf5)],this[_0x44ec15(0x105)]=_0x41db8a['timeZone'],this[_0x44ec15(0x10f)]=_0x41db8a[_0x44ec15(0x97)],this[_0x44ec15(0xe1)]=_0x41db8a['componentIdList'],this[_0x44ec15(0xa3)]=_0x41db8a['deploymentName'],this['_systemLogger']=new core_1['Logger'](_0x44ec15(0xd5)),this[_0x44ec15(0xee)]=new veeva_service_1[(_0x44ec15(0x122))]({'connection':this[_0x44ec15(0xc4)],'logger':this[_0x44ec15(0xec)]}),this['_salesforceService']=new salesforce_service_1[(_0x44ec15(0x11d))]({'connection':this['_connectionSalesforce']}),this[_0x44ec15(0x8d)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x44ec15(0xee)],'connection':this['_connectionVeeva'],'logger':this[_0x44ec15(0xec)],'saveLog':this[_0x44ec15(0x111)][_0x44ec15(0xea)](this)}),this['_packageExportService']=new package_export_service_1[(_0x44ec15(0x101))]({'veevaService':this[_0x44ec15(0xee)],'connection':this[_0x44ec15(0xc4)],'logger':this['_logger']}),this['_vpkService']=new vpk_service_1[(_0x44ec15(0x10d))]({'connection':this[_0x44ec15(0xc4)]});}async[a374_0x558f15(0xbe)](){const _0x57e191=a374_0x558f15;try{const _0x217482=await this[_0x57e191(0xe2)]();await this[_0x57e191(0xec)][_0x57e191(0xd8)]();const _0x30e2a0=await this[_0x57e191(0xf9)](_0x217482);await this[_0x57e191(0xbb)](_0x30e2a0);const _0x30bc8d=await this[_0x57e191(0x12d)](_0x217482),_0x5ebeec=await this[_0x57e191(0x124)](_0x30bc8d),_0x21673e=await this[_0x57e191(0xc7)](_0x5ebeec);await this[_0x57e191(0xec)]['updateLog']();const _0x3cae49=await this[_0x57e191(0x8d)][_0x57e191(0xdb)](_0x21673e);await this['_logger']['updateLog']();const _0xcb878b=this[_0x57e191(0xd1)](_0x217482,_0x3cae49[_0x57e191(0x90)]);await this['saveDeploymentResults'](_0xcb878b),await this[_0x57e191(0xb7)](_0x3cae49['isDeployed'],![],_0x3cae49[_0x57e191(0x12e)]);}catch(_0x259b02){await this['finishDeployWithError'](_0x259b02)[_0x57e191(0xdf)](_0x47de6b=>this[_0x57e191(0x121)][_0x57e191(0x103)](_0x47de6b));}}async[a374_0x558f15(0xe2)](){const _0xa66ff1=a374_0x558f15,_0x1476b6=new Set(this[_0xa66ff1(0xe1)]);this[_0xa66ff1(0xec)][_0xa66ff1(0x10b)](_0xa66ff1(0xfa));const _0x506f90=await new branch_component_history_flosum_component_retriever_1[(_0xa66ff1(0xb2))]({'value':this[_0xa66ff1(0xbc)],'salesforceService':this['_salesforceService']})['retrieve'](),_0x41c7ce=_0x506f90[_0xa66ff1(0xa2)](_0x282edc=>_0x1476b6[_0xa66ff1(0xae)](_0x282edc['id']));if(_0x41c7ce[_0xa66ff1(0x11c)]!==this[_0xa66ff1(0xe1)][_0xa66ff1(0x11c)])throw new Error(_0xa66ff1(0xd0));return _0x41c7ce;}async[a374_0x558f15(0xf9)](_0xe55166){const _0x2480f8=a374_0x558f15;var _0x2cb22f;this[_0x2480f8(0xec)][_0x2480f8(0x10b)](_0x2480f8(0xe4));const _0x15330a=await new flosum_component_veeva_component_retriever_1[(_0x2480f8(0xf3))]({'value':_0xe55166,'veevaService':this[_0x2480f8(0xee)],'logger':this[_0x2480f8(0xec)]})[_0x2480f8(0x126)](),_0x323eb6=await this[_0x2480f8(0x94)][_0x2480f8(0xd3)](_0x15330a,_0x2480f8(0xbd));if(_0x323eb6[_0x2480f8(0x11c)]>0x1)throw new Error(_0x2480f8(0xf8));return(_0x2cb22f=_0x323eb6[0x0])!==null&&_0x2cb22f!==void 0x0?_0x2cb22f:_0x323eb6[0x0]=new jszip_1['default'](),_0x323eb6[0x0]['generateAsync']({'type':_0x2480f8(0x9b)});}async[a374_0x558f15(0xbb)](_0x5a45ca){const _0x4da462=a374_0x558f15;this[_0x4da462(0xec)][_0x4da462(0x10b)](_0x4da462(0x9a));const _0x246cca={'Body':_0x5a45ca,'ContentType':_0x4da462(0xa4),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x4da462(0xad)][_0x4da462(0xa8)]};await this[_0x4da462(0x112)]['post'](flosum_constants_1[_0x4da462(0xad)][_0x4da462(0x117)]+_0x4da462(0x128),_0x246cca);}async[a374_0x558f15(0x12d)](_0x7058b){const _0x16e6dd=a374_0x558f15;this[_0x16e6dd(0xec)][_0x16e6dd(0x10b)](_0x16e6dd(0x125));const _0x52e4de=await(0x0,fetch_attachments_1[_0x16e6dd(0xb9)])(this[_0x16e6dd(0x112)],_0x7058b[_0x16e6dd(0xcd)](_0x54e6aa=>_0x54e6aa[_0x16e6dd(0xa9)])),_0x11148a=await(0x0,fetch_attachments_1[_0x16e6dd(0x12d)])(_0x52e4de,this[_0x16e6dd(0x112)]);if(_0x11148a[_0x16e6dd(0x11c)]!==this['_componentIdList'][_0x16e6dd(0x11c)])throw new Error(_0x16e6dd(0xe9));return _0x11148a[_0x16e6dd(0xcd)](_0x205892=>_0x205892[_0x16e6dd(0xb0)]['Body']);}async[a374_0x558f15(0x124)](_0x507e68){const _0x48f7dc=a374_0x558f15;this[_0x48f7dc(0xec)][_0x48f7dc(0x10b)](_0x48f7dc(0x119));const _0x558e14=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x507e68,'deploymentName':this['_deploymentName']})[_0x48f7dc(0xbe)](),_0x1cd426=this[_0x48f7dc(0x129)]+'/'+(0x0,shortid_1[_0x48f7dc(0xd4)])()+_0x48f7dc(0x11a);return await(0x0,promises_1[_0x48f7dc(0xe7)])(_0x1cd426,_0x558e14),_0x1cd426;}async[a374_0x558f15(0xc7)](_0x2ee506){const _0x400d90=a374_0x558f15;this[_0x400d90(0xec)][_0x400d90(0x10b)]('Create\x20vpk\x20package');const _0x2293cb=await this['_vpkService']['generate'](_0x2ee506),_0x3e23f0=this[_0x400d90(0x129)]+_0x400d90(0xc1)+_0x2ee506[_0x400d90(0x8e)](_0x2ee506['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x400d90(0xe7)])(_0x3e23f0,_0x2293cb),await this[_0x400d90(0xa1)][_0x400d90(0x9c)](_0x3e23f0),_0x3e23f0;}async[a374_0x558f15(0x111)](_0x30d2f0,_0x31604c){const _0x29ae4d=a374_0x558f15;this['_logger'][_0x29ae4d(0x10b)](_0x29ae4d(0xce));const _0x28d792={'Body':Buffer[_0x29ae4d(0x108)](_0x30d2f0)['toString']('base64'),'ContentType':_0x29ae4d(0x11e),'ParentId':this['_metadataLogId'],'Name':_0x31604c};await this['_connectionSalesforce'][_0x29ae4d(0x11f)](flosum_constants_1[_0x29ae4d(0xad)]['ENDPOINT_UPSERT_RECORD']+_0x29ae4d(0x128),_0x28d792);}[a374_0x558f15(0xd1)](_0x1ab123,_0xeda29){const _0x201f41=a374_0x558f15;this[_0x201f41(0xec)][_0x201f41(0x10b)](_0x201f41(0xe3));const _0x3bb659=_0x1ab123[_0x201f41(0xd2)]((_0x5acbe0,_0x2128f3)=>_0x5acbe0[_0x201f41(0x95)]((_0x2128f3[_0x201f41(0x115)]+'.'+_0x2128f3[_0x201f41(0xcc)])[_0x201f41(0xca)](),_0x2128f3),new Map());return _0xeda29['map'](_0x45e1f2=>{const _0x41e1fc=_0x201f41;this[_0x41e1fc(0xec)][_0x41e1fc(0x10b)](_0x45e1f2['type']+'.'+_0x45e1f2['name']+_0x41e1fc(0x116)+_0x45e1f2['status']);const _0x62bd1a=(_0x45e1f2[_0x41e1fc(0xc5)]+'.'+_0x45e1f2[_0x41e1fc(0x102)])[_0x41e1fc(0xca)](),_0x11af47=_0x3bb659[_0x41e1fc(0x93)](_0x62bd1a);return{[constants_1[_0x41e1fc(0xab)]+_0x41e1fc(0xf7)]:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+_0x41e1fc(0xf4)]:_0x45e1f2['status']===status_enums_1[_0x41e1fc(0xc0)]['DEPLOYED']?_0x41e1fc(0xcb):_0x41e1fc(0xe6),[constants_1['FLOSUM_NAMESPACE']+_0x41e1fc(0x12f)]:_0x45e1f2[_0x41e1fc(0xdc)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x45e1f2['name'],[constants_1[_0x41e1fc(0xab)]+_0x41e1fc(0xef)]:_0x45e1f2[_0x41e1fc(0xc5)],[constants_1['FLOSUM_NAMESPACE']+_0x41e1fc(0xd9)]:_0x45e1f2[_0x41e1fc(0x10a)],[constants_1['FLOSUM_NAMESPACE']+_0x41e1fc(0x10c)]:this['_organisationId'],[constants_1[_0x41e1fc(0xab)]+_0x41e1fc(0x92)]:this['_metadataLogId'],[constants_1[_0x41e1fc(0xab)]+_0x41e1fc(0xc2)]:_0x11af47[_0x41e1fc(0xa9)]};});}async['saveDeploymentResults'](_0x227cb4){const _0x51ab73=a374_0x558f15;this[_0x51ab73(0xec)][_0x51ab73(0x10b)](_0x51ab73(0x127));const _0x314997=await this[_0x51ab73(0xcf)][_0x51ab73(0xaf)](constants_1[_0x51ab73(0xab)]+_0x51ab73(0x12b),_0x227cb4),_0x4f0a1b=_0x314997[_0x51ab73(0xa2)](_0x55c777=>!_0x55c777[_0x51ab73(0xe8)])['map'](_0x33cbfa=>_0x33cbfa['errors'])[_0x51ab73(0xfe)]();if(_0x4f0a1b['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x4f0a1b);}async[a374_0x558f15(0x8f)](_0x18b51a){const _0xc7f3ea=a374_0x558f15;this[_0xc7f3ea(0xec)][_0xc7f3ea(0x91)](_0x18b51a),await this[_0xc7f3ea(0xec)]['updateLog'](),await this[_0xc7f3ea(0xb7)](![],!![],'');}async[a374_0x558f15(0xb7)](_0x1f33a1,_0x1896b3,_0x43afd8){const _0x5a7b7b=a374_0x558f15,_0x2cf7b8=_0x5a7b7b(0xb3)+this['_instanceUrl']+'/'+this[_0x5a7b7b(0xba)]+_0x5a7b7b(0xb4)+_0x5a7b7b(0xf0)+'\x20</a>',_0x265b22=_0x5a7b7b(0xb3)+this[_0x5a7b7b(0xa5)]+'/'+this[_0x5a7b7b(0xc8)]+'\x20>'+this[_0x5a7b7b(0x10f)]+_0x5a7b7b(0x9d),_0x222a91=_0x2cf7b8+_0x5a7b7b(0x98)+_0x265b22+_0x5a7b7b(0xb1),_0x94cf5a={[constants_1['FLOSUM_NAMESPACE']+'Action__c']:_0x222a91,[constants_1[_0x5a7b7b(0xab)]+_0x5a7b7b(0x12c)]:new Date(),[constants_1[_0x5a7b7b(0xab)]+_0x5a7b7b(0xb8)]:this[_0x5a7b7b(0xbc)],[constants_1['FLOSUM_NAMESPACE']+_0x5a7b7b(0xd7)]:_0x5a7b7b(0xbf),[constants_1[_0x5a7b7b(0xab)]+'Activity_Type__c']:_0x5a7b7b(0xc9),[constants_1['FLOSUM_NAMESPACE']+_0x5a7b7b(0xd6)]:this['_organisationId']},_0x3ed63d={[constants_1[_0x5a7b7b(0xab)]+_0x5a7b7b(0xf1)]:!_0x1f33a1,[constants_1[_0x5a7b7b(0xab)]+_0x5a7b7b(0xb5)]:_0x1f33a1,[constants_1[_0x5a7b7b(0xab)]+_0x5a7b7b(0xf4)]:_0x1896b3?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x5a7b7b(0x96)]['COMPLETED'],[constants_1[_0x5a7b7b(0xab)]+'Job_Completed__c']:!![],[constants_1[_0x5a7b7b(0xab)]+_0x5a7b7b(0xde)]:_0x43afd8};await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x5a7b7b(0xad)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x5a7b7b(0xab)]+_0x5a7b7b(0xac)+this['_metadataLogId'],_0x3ed63d),await this[_0x5a7b7b(0x112)][_0x5a7b7b(0x11f)](flosum_constants_1['FlosumConstants'][_0x5a7b7b(0x117)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x5a7b7b(0xeb),_0x94cf5a),this['_logger'][_0x5a7b7b(0x10b)](_0x5a7b7b(0x107)+(_0x1f33a1?'successfully':_0x5a7b7b(0xb6))+'.'),await this[_0x5a7b7b(0xec)][_0x5a7b7b(0xd8)]();}}exports[a374_0x558f15(0xfc)]=DeployService;