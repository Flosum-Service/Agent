const a334_0x1f7418=a334_0x5337;(function(_0x38dec3,_0x19fab1){const _0x51f0b5=a334_0x5337,_0x2e0e80=_0x38dec3();while(!![]){try{const _0x4026ab=parseInt(_0x51f0b5(0x209))/0x1+parseInt(_0x51f0b5(0x23a))/0x2*(-parseInt(_0x51f0b5(0x1e6))/0x3)+parseInt(_0x51f0b5(0x1ed))/0x4*(-parseInt(_0x51f0b5(0x1d3))/0x5)+parseInt(_0x51f0b5(0x1ba))/0x6*(-parseInt(_0x51f0b5(0x21a))/0x7)+parseInt(_0x51f0b5(0x21c))/0x8+parseInt(_0x51f0b5(0x23c))/0x9*(parseInt(_0x51f0b5(0x1f5))/0xa)+parseInt(_0x51f0b5(0x247))/0xb;if(_0x4026ab===_0x19fab1)break;else _0x2e0e80['push'](_0x2e0e80['shift']());}catch(_0x303b8e){_0x2e0e80['push'](_0x2e0e80['shift']());}}}(a334_0x54d6,0xe26b3));function a334_0x5337(_0x5c311a,_0xfef880){const _0x593921=a334_0x54d6();return a334_0x5337=function(_0x288f74,_0x591b94){_0x288f74=_0x288f74-0x19f;let _0x54d6f5=_0x593921[_0x288f74];return _0x54d6f5;},a334_0x5337(_0x5c311a,_0xfef880);}const a334_0x591b94=(function(){let _0x1bdcb1=!![];return function(_0x7ab42b,_0x325d3f){const _0xc06724=_0x1bdcb1?function(){const _0x4946f9=a334_0x5337;if(_0x325d3f){const _0x3bed80=_0x325d3f[_0x4946f9(0x21e)](_0x7ab42b,arguments);return _0x325d3f=null,_0x3bed80;}}:function(){};return _0x1bdcb1=![],_0xc06724;};}()),a334_0x288f74=a334_0x591b94(this,function(){const _0x57864f=a334_0x5337;return a334_0x288f74[_0x57864f(0x1c9)]()['search'](_0x57864f(0x1a8))[_0x57864f(0x1c9)]()['constructor'](a334_0x288f74)[_0x57864f(0x1c6)]('(((.+)+)+)+$');});a334_0x288f74();'use strict';var __importDefault=this&&this[a334_0x1f7418(0x234)]||function(_0x4e5209){const _0x3e2079=a334_0x1f7418;return _0x4e5209&&_0x4e5209[_0x3e2079(0x1a4)]?_0x4e5209:{'default':_0x4e5209};};Object[a334_0x1f7418(0x204)](exports,a334_0x1f7418(0x1a4),{'value':!![]}),exports[a334_0x1f7418(0x236)]=void 0x0;const jszip_1=__importDefault(require(a334_0x1f7418(0x1af))),promises_1=require('fs/promises'),constants_1=require(a334_0x1f7418(0x203)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a334_0x1f7418(0x1cf)),salesforce_service_1=require(a334_0x1f7418(0x23f)),core_1=require(a334_0x1f7418(0x1cc)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a334_0x1f7418(0x1c0)),shortid_1=__importDefault(require(a334_0x1f7418(0x1e4))),xml2js_1=require(a334_0x1f7418(0x1f2)),fetch_attachments_1=require(a334_0x1f7418(0x1d5)),package_import_service_1=require(a334_0x1f7418(0x1d6)),branch_component_history_flosum_component_retriever_1=require(a334_0x1f7418(0x22a)),flosum_component_veeva_component_retriever_1=require(a334_0x1f7418(0x206)),package_export_service_1=require(a334_0x1f7418(0x20d)),vpk_service_1=require(a334_0x1f7418(0x202));function a334_0x54d6(){const _0x16b909=['Type__c','deploymentAction','EXCEPTION','default','_branchId','https://veevavault.com/','Branch__c','reduce','slice','192kztFBG','\x20>\x20','SalesforceDmlError','_packageImportService','FLOSUM_NAMESPACE','Veeva_Step_Name__c','../classes/errors/salesforce-dml-error','Veeva\x20Deployment','_organisationId','Save\x20Deployment\x20Results','status','isDeployed','search','map','<a\x20href=','toString','Backup','Metadata_Log__c','../../../core','Save\x20Backup\x20to\x20Salesforce','success','./veeva.service','log','writeFile','Retrieving\x20components','5VvEuDf','\x20:\x20','../../shared/utils/fetch-attachments','./package-import.service','name','Job_Completed__c','Logger','/Attachment','Finish\x20Create\x20Backup','FlosumConstants','TargetId__c','saveDeploymentResults','Cannot\x20retrieve\x20all\x20components.','catch','veeva-deploy','_salesforceService','migration__v','shortid','Metadata_Log__c/','3893151tSRNCN','_tempFolder','BranchComponentHistoryFlosumComponentRetriever','Deployment\x20Result','Component_Name__c','retrieve','import','7364596QVBSYG','generateAsync','Flosum','base64','packageId','xml2js','get','_connectionSalesforce','290KrCDhM','logError','joinAllAttachments','\x20</a>','_vpkService','retrieveAttachments','VpkService','with\x20error','filter','organisationName','errors','PackageExportService','\x20has\x20been\x20created.','./vpk.service','../../../constants','defineProperty','packageComponentList','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','successfully','Failure','953808phfvBv','validate','\x20of\x20branch\x20to\x20Organization\x20','Success','./package-export.service','updateLog','Cannot\x20retrievers\x20all\x20attachments','getFlosumComponents','from','_organisationName','ENDPOINT_UPSERT_RECORD','length','Deploy\x20completed\x20','text/plain','organisationId','lastIndexOf','generate','297808MUsubT','application/zip','8606344AMTmah','Component_History__c','apply','post','componentHistoryId','Status__c','file','finishDeploy','createVpk','branchId','.zip','Component_Type__c','_packageExportService','_veevaService','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Deploy','Org__c','Builder','DEPLOYED','PackageImportService','Create\x20Backup','buildObject','Async_Request_Id__c','PackageComponentStatus','__importDefault','_deploymentName','DeployService','_componentIdList','type','FlosumComponentVeevaComponentRetriever','2CKWgpF','MetadataLogStatus','369693atArKu','_connectionVeeva','createBackup','./salesforce.service','toLowerCase','_metadataLogId','_systemLogger','Create\x20vpk\x20package','_logger','attachmentLogId','Date__c','24275361XLrPVx','Deployment_Result__c','finishDeployWithError','Succeed__c','</a>','Cannot\x20Backup\x20more\x20than\x20200\x20components.','_instanceUrl','__esModule','formFlosumDeploymentResults','vaultpackage.xml','export','(((.+)+)+)+$','Log__c','patch','deploymentName','Save\x20log','async','Action__c','jszip','Activity_Type__c'];a334_0x54d6=function(){return _0x16b909;};return a334_0x54d6();}class DeployService{constructor(_0x5cb081,_0x519449,_0x5c3442,_0x24191f,_0x4808fe,_0x1116a8){const _0x168ab9=a334_0x1f7418;this[_0x168ab9(0x1f4)]=_0x519449,this[_0x168ab9(0x23d)]=_0x5c3442,this['_logger']=_0x24191f,this[_0x168ab9(0x1e7)]=_0x4808fe,this['_instanceUrl']=_0x1116a8,this[_0x168ab9(0x1b5)]=_0x5cb081[_0x168ab9(0x225)],this['_metadataLogId']=_0x5cb081['metadataLogId'],this['_attachmentLogId']=_0x5cb081[_0x168ab9(0x245)],this[_0x168ab9(0x1c2)]=_0x5cb081[_0x168ab9(0x217)],this['_timeZone']=_0x5cb081['timeZone'],this[_0x168ab9(0x212)]=_0x5cb081[_0x168ab9(0x1fe)],this[_0x168ab9(0x237)]=_0x5cb081['componentIdList'],this[_0x168ab9(0x235)]=_0x5cb081[_0x168ab9(0x1ab)],this[_0x168ab9(0x242)]=new core_1[(_0x168ab9(0x1d9))](_0x168ab9(0x1e1)),this[_0x168ab9(0x229)]=new veeva_service_1['VeevaService']({'connection':this[_0x168ab9(0x23d)],'logger':this[_0x168ab9(0x244)]}),this[_0x168ab9(0x1e2)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x168ab9(0x1f4)]}),this[_0x168ab9(0x1bd)]=new package_import_service_1[(_0x168ab9(0x22f))]({'veevaService':this[_0x168ab9(0x229)],'connection':this[_0x168ab9(0x23d)],'logger':this[_0x168ab9(0x244)],'saveLog':this['saveLog']['bind'](this)}),this[_0x168ab9(0x228)]=new package_export_service_1[(_0x168ab9(0x200))]({'veevaService':this['_veevaService'],'connection':this['_connectionVeeva'],'logger':this[_0x168ab9(0x244)]}),this[_0x168ab9(0x1f9)]=new vpk_service_1[(_0x168ab9(0x1fb))]({'connection':this[_0x168ab9(0x23d)]});}async['execute'](){const _0x3c9526=a334_0x1f7418;try{const _0x4d7c82=await this['getFlosumComponents']();await this[_0x3c9526(0x244)]['updateLog'](),await this[_0x3c9526(0x23e)](_0x4d7c82);const _0xbf65f3=await this[_0x3c9526(0x1fa)](_0x4d7c82),_0x26c4c9=await this[_0x3c9526(0x1f7)](_0xbf65f3),_0x18bf9d=await this['createVpk'](_0x26c4c9);await this['_logger']['updateLog']();const _0x50ab79=await this[_0x3c9526(0x1bd)][_0x3c9526(0x1ec)](_0x18bf9d);await this[_0x3c9526(0x244)]['updateLog']();const _0x26e7eb=this[_0x3c9526(0x1a5)](_0x4d7c82,_0x50ab79[_0x3c9526(0x205)]);await this['saveDeploymentResults'](_0x26e7eb),await this[_0x3c9526(0x223)](_0x50ab79[_0x3c9526(0x1c5)],![],_0x50ab79[_0x3c9526(0x1f1)]);}catch(_0x3507ee){await this[_0x3c9526(0x19f)](_0x3507ee)[_0x3c9526(0x1e0)](_0x536fcb=>this[_0x3c9526(0x242)]['error'](_0x536fcb));}}async[a334_0x1f7418(0x210)](){const _0xfbdd47=a334_0x1f7418,_0x2d8540=new Set(this[_0xfbdd47(0x237)]);this[_0xfbdd47(0x244)][_0xfbdd47(0x1d0)](_0xfbdd47(0x1d2));const _0x3983b7=await new branch_component_history_flosum_component_retriever_1[(_0xfbdd47(0x1e8))]({'value':this[_0xfbdd47(0x1b5)],'salesforceService':this[_0xfbdd47(0x1e2)]})[_0xfbdd47(0x1eb)](),_0xd54206=_0x3983b7[_0xfbdd47(0x1fd)](_0x259cd5=>_0x2d8540['has'](_0x259cd5['id']));if(_0xd54206[_0xfbdd47(0x214)]!==this[_0xfbdd47(0x237)][_0xfbdd47(0x214)])throw new Error(_0xfbdd47(0x1df));return _0xd54206;}async[a334_0x1f7418(0x23e)](_0x130d47){const _0x2a93b6=a334_0x1f7418;var _0x26b612;this[_0x2a93b6(0x244)][_0x2a93b6(0x1d0)](_0x2a93b6(0x230));const _0x1ecfcc=await new flosum_component_veeva_component_retriever_1[(_0x2a93b6(0x239))]({'value':_0x130d47,'veevaService':this['_veevaService'],'logger':this['_logger']})[_0x2a93b6(0x1eb)](),_0x598a64=await this[_0x2a93b6(0x228)][_0x2a93b6(0x1a7)](_0x1ecfcc,_0x2a93b6(0x1ca));if(_0x598a64[_0x2a93b6(0x214)]>0x1)throw new Error(_0x2a93b6(0x1a2));(_0x26b612=_0x598a64[0x0])!==null&&_0x26b612!==void 0x0?_0x26b612:_0x598a64[0x0]=new jszip_1[(_0x2a93b6(0x1b4))]();const _0x23dcf3=await _0x598a64[0x0][_0x2a93b6(0x1ee)]({'type':_0x2a93b6(0x1f0)});this[_0x2a93b6(0x244)][_0x2a93b6(0x1d0)](_0x2a93b6(0x1cd));const _0x2337b6={'Body':_0x23dcf3,'ContentType':_0x2a93b6(0x21b),'ParentId':this[_0x2a93b6(0x241)],'Name':flosum_constants_1[_0x2a93b6(0x1dc)]['BACKUP_ZIP_NAME']};await this['_connectionSalesforce'][_0x2a93b6(0x21f)](flosum_constants_1[_0x2a93b6(0x1dc)]['ENDPOINT_UPSERT_RECORD']+_0x2a93b6(0x1da),_0x2337b6),this[_0x2a93b6(0x244)]['log'](_0x2a93b6(0x1db));}async[a334_0x1f7418(0x1fa)](_0x3df229){const _0x388ca5=a334_0x1f7418;this[_0x388ca5(0x244)][_0x388ca5(0x1d0)]('Retrieving\x20attachments');const _0xdf6a34=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x388ca5(0x1f4)],_0x3df229[_0x388ca5(0x1c7)](_0x47d9ea=>_0x47d9ea['componentHistoryId'])),_0x337d89=await(0x0,fetch_attachments_1[_0x388ca5(0x1fa)])(_0xdf6a34,this[_0x388ca5(0x1f4)]);if(_0x337d89[_0x388ca5(0x214)]!==this[_0x388ca5(0x237)][_0x388ca5(0x214)])throw new Error(_0x388ca5(0x20f));return _0x337d89[_0x388ca5(0x1c7)](_0x477631=>_0x477631['values']['Body']);}async[a334_0x1f7418(0x1f7)](_0x22e659){const _0x4df285=a334_0x1f7418;var _0x3074fe;this[_0x4df285(0x244)]['log']('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x4c2228=new jszip_1[(_0x4df285(0x1b4))]();for(const _0x268b07 of _0x22e659){const _0x19d83c=new jszip_1[(_0x4df285(0x1b4))]();await _0x19d83c['loadAsync'](_0x268b07,{'base64':!![]});for(const _0x1659a9 in _0x19d83c['files']){const _0x439119=await((_0x3074fe=_0x19d83c[_0x4df285(0x222)](_0x1659a9))===null||_0x3074fe===void 0x0?void 0x0:_0x3074fe[_0x4df285(0x1ad)]('string'));_0x439119&&_0x4c2228[_0x4df285(0x222)](_0x1659a9,_0x439119);}}const _0x34dcaf=new xml2js_1[(_0x4df285(0x22d))]({'headless':!![]}),_0x1b109d={'vaultpackage':{'$':{'xmlns':_0x4df285(0x1b6)},'name':this['_deploymentName'],'source':{'vault':undefined,'author':_0x4df285(0x1ef)},'packagetype':_0x4df285(0x1e3),'summary':_0x4df285(0x22b),'description':'null'}};_0x4c2228[_0x4df285(0x222)](_0x4df285(0x1a6),_0x34dcaf[_0x4df285(0x231)](_0x1b109d));const _0x5ca061=this[_0x4df285(0x1e7)]+'/'+(0x0,shortid_1[_0x4df285(0x1b4)])()+_0x4df285(0x226),_0x307175=await _0x4c2228[_0x4df285(0x1ee)]({'type':'nodebuffer'});return await(0x0,promises_1[_0x4df285(0x1d1)])(_0x5ca061,_0x307175),_0x5ca061;}async[a334_0x1f7418(0x224)](_0x43a117){const _0x1a9b95=a334_0x1f7418;this['_logger'][_0x1a9b95(0x1d0)](_0x1a9b95(0x243));const _0x322aa4=await this[_0x1a9b95(0x1f9)][_0x1a9b95(0x219)](_0x43a117),_0x58684f=this[_0x1a9b95(0x1e7)]+'/vpk__'+_0x43a117[_0x1a9b95(0x1b9)](_0x43a117[_0x1a9b95(0x218)]('/')+0x1);return await(0x0,promises_1[_0x1a9b95(0x1d1)])(_0x58684f,_0x322aa4),await this[_0x1a9b95(0x1f9)][_0x1a9b95(0x20a)](_0x58684f),_0x58684f;}async['saveLog'](_0x6f0f36,_0x4adec0){const _0x3e75b8=a334_0x1f7418;this[_0x3e75b8(0x244)][_0x3e75b8(0x1d0)](_0x3e75b8(0x1ac));const _0x1f40f1={'Body':Buffer[_0x3e75b8(0x211)](_0x6f0f36)[_0x3e75b8(0x1c9)](_0x3e75b8(0x1f0)),'ContentType':_0x3e75b8(0x216),'ParentId':this[_0x3e75b8(0x241)],'Name':_0x4adec0};await this['_connectionSalesforce'][_0x3e75b8(0x21f)](flosum_constants_1['FlosumConstants'][_0x3e75b8(0x213)]+_0x3e75b8(0x1da),_0x1f40f1);}[a334_0x1f7418(0x1a5)](_0x2bb359,_0x3665b1){const _0x389609=a334_0x1f7418;this[_0x389609(0x244)]['log']('Form\x20Deployment\x20Results');const _0x5804f4=_0x2bb359[_0x389609(0x1b8)]((_0x4893af,_0x7cb2ee)=>_0x4893af['set']((_0x7cb2ee['componentType']+'.'+_0x7cb2ee['componentName'])[_0x389609(0x240)](),_0x7cb2ee),new Map());return _0x3665b1['map'](_0x5c8960=>{const _0x55df99=_0x389609;this[_0x55df99(0x244)][_0x55df99(0x1d0)](_0x5c8960[_0x55df99(0x238)]+'.'+_0x5c8960[_0x55df99(0x1d7)]+_0x55df99(0x1d4)+_0x5c8960[_0x55df99(0x1c4)]);const _0x26d16f=(_0x5c8960[_0x55df99(0x238)]+'.'+_0x5c8960[_0x55df99(0x1d7)])[_0x55df99(0x240)](),_0x5e4cec=_0x5804f4[_0x55df99(0x1f3)](_0x26d16f);return{[constants_1['FLOSUM_NAMESPACE']+_0x55df99(0x1b1)]:_0x55df99(0x1e9),[constants_1[_0x55df99(0x1be)]+'Status__c']:_0x5c8960[_0x55df99(0x1c4)]===status_enums_1[_0x55df99(0x233)][_0x55df99(0x22e)]?_0x55df99(0x20c):_0x55df99(0x208),[constants_1[_0x55df99(0x1be)]+'Result__c']:_0x5c8960[_0x55df99(0x1b2)],[constants_1[_0x55df99(0x1be)]+_0x55df99(0x1ea)]:_0x5c8960[_0x55df99(0x1d7)],[constants_1[_0x55df99(0x1be)]+_0x55df99(0x227)]:_0x5c8960[_0x55df99(0x238)],[constants_1[_0x55df99(0x1be)]+_0x55df99(0x1bf)]:_0x5c8960['stepName'],[constants_1[_0x55df99(0x1be)]+_0x55df99(0x22c)]:this[_0x55df99(0x1c2)],[constants_1['FLOSUM_NAMESPACE']+_0x55df99(0x1cb)]:this[_0x55df99(0x241)],[constants_1[_0x55df99(0x1be)]+_0x55df99(0x21d)]:_0x5e4cec[_0x55df99(0x220)]};});}async[a334_0x1f7418(0x1de)](_0x4ecd58){const _0x19916c=a334_0x1f7418;this['_logger']['log'](_0x19916c(0x1c3));const _0xd09ee2=await this[_0x19916c(0x1e2)]['insertMultipleRecords'](constants_1[_0x19916c(0x1be)]+_0x19916c(0x248),_0x4ecd58),_0x622f0=_0xd09ee2[_0x19916c(0x1fd)](_0x2a4d87=>!_0x2a4d87[_0x19916c(0x1ce)])[_0x19916c(0x1c7)](_0x493bf4=>_0x493bf4[_0x19916c(0x1ff)])['flat']();if(_0x622f0[_0x19916c(0x214)])throw new salesforce_dml_error_1[(_0x19916c(0x1bc))](_0x622f0);}async['finishDeployWithError'](_0x118236){const _0x1dd62e=a334_0x1f7418;this[_0x1dd62e(0x244)][_0x1dd62e(0x1f6)](_0x118236),await this[_0x1dd62e(0x244)][_0x1dd62e(0x20e)](),await this['finishDeploy'](![],!![],'');}async[a334_0x1f7418(0x223)](_0x4e93db,_0x584805,_0x57b61d){const _0x3db2a2=a334_0x1f7418,_0x2434b3=_0x3db2a2(0x1c8)+this[_0x3db2a2(0x1a3)]+'/'+this['_metadataLogId']+_0x3db2a2(0x1bb)+_0x3db2a2(0x1c1)+_0x3db2a2(0x1f8),_0x436e45=_0x3db2a2(0x1c8)+this[_0x3db2a2(0x1a3)]+'/'+this[_0x3db2a2(0x1c2)]+'\x20>'+this[_0x3db2a2(0x212)]+_0x3db2a2(0x1a1),_0x257cc2=_0x2434b3+_0x3db2a2(0x20b)+_0x436e45+_0x3db2a2(0x201),_0x5122fe={[constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x1ae)]:_0x257cc2,[constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x246)]:new Date(),[constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x1b7)]:this[_0x3db2a2(0x1b5)],[constants_1[_0x3db2a2(0x1be)]+'Activity_Item__c']:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x3db2a2(0x1b0)]:'Deployment',[constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x1dd)]:this[_0x3db2a2(0x1c2)]},_0x43fecc={[constants_1[_0x3db2a2(0x1be)]+'Is_Error__c']:!_0x4e93db,[constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x1a0)]:_0x4e93db,[constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x221)]:_0x584805?status_enums_1[_0x3db2a2(0x23b)][_0x3db2a2(0x1b3)]:status_enums_1[_0x3db2a2(0x23b)]['COMPLETED'],[constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x1d8)]:!![],[constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x232)]:_0x57b61d};await this[_0x3db2a2(0x1f4)][_0x3db2a2(0x1aa)](flosum_constants_1['FlosumConstants'][_0x3db2a2(0x213)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x3db2a2(0x1e5)+this[_0x3db2a2(0x241)],_0x43fecc),await this[_0x3db2a2(0x1f4)][_0x3db2a2(0x21f)](flosum_constants_1[_0x3db2a2(0x1dc)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x3db2a2(0x1be)]+_0x3db2a2(0x1a9),_0x5122fe),this[_0x3db2a2(0x244)][_0x3db2a2(0x1d0)](_0x3db2a2(0x215)+(_0x4e93db?_0x3db2a2(0x207):_0x3db2a2(0x1fc))+'.'),await this[_0x3db2a2(0x244)][_0x3db2a2(0x20e)]();}}exports[a334_0x1f7418(0x236)]=DeployService;