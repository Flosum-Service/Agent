const a334_0x1e30e2=a334_0x5053;(function(_0x5a24b7,_0x3f9c1c){const _0x389fc2=a334_0x5053,_0x41a41f=_0x5a24b7();while(!![]){try{const _0x2e4ae2=parseInt(_0x389fc2(0xf2))/0x1+-parseInt(_0x389fc2(0xd5))/0x2*(parseInt(_0x389fc2(0x10b))/0x3)+-parseInt(_0x389fc2(0xcc))/0x4+parseInt(_0x389fc2(0xfb))/0x5*(-parseInt(_0x389fc2(0xed))/0x6)+parseInt(_0x389fc2(0xe5))/0x7*(parseInt(_0x389fc2(0xd6))/0x8)+-parseInt(_0x389fc2(0xa2))/0x9+-parseInt(_0x389fc2(0x8a))/0xa*(-parseInt(_0x389fc2(0x9e))/0xb);if(_0x2e4ae2===_0x3f9c1c)break;else _0x41a41f['push'](_0x41a41f['shift']());}catch(_0x5b47f7){_0x41a41f['push'](_0x41a41f['shift']());}}}(a334_0x13cc,0xdcc95));const a334_0x559b9e=(function(){let _0x2d0260=!![];return function(_0x4bf940,_0x2d8032){const _0x1fd0c6=_0x2d0260?function(){const _0xab808b=a334_0x5053;if(_0x2d8032){const _0x419b81=_0x2d8032[_0xab808b(0x114)](_0x4bf940,arguments);return _0x2d8032=null,_0x419b81;}}:function(){};return _0x2d0260=![],_0x1fd0c6;};}()),a334_0x3e58a4=a334_0x559b9e(this,function(){const _0x55890e=a334_0x5053;return a334_0x3e58a4['toString']()['search']('(((.+)+)+)+$')['toString']()[_0x55890e(0xf8)](a334_0x3e58a4)['search'](_0x55890e(0x105));});a334_0x3e58a4();function a334_0x5053(_0x3b0a0f,_0x34973f){const _0x247aee=a334_0x13cc();return a334_0x5053=function(_0x3e58a4,_0x559b9e){_0x3e58a4=_0x3e58a4-0x80;let _0x13cc84=_0x247aee[_0x3e58a4];return _0x13cc84;},a334_0x5053(_0x3b0a0f,_0x34973f);}'use strict';var __importDefault=this&&this[a334_0x1e30e2(0x109)]||function(_0x50ae7e){const _0x31f599=a334_0x1e30e2;return _0x50ae7e&&_0x50ae7e[_0x31f599(0xb5)]?_0x50ae7e:{'default':_0x50ae7e};};function a334_0x13cc(){const _0x2f57bd=['COMPLETED','_tempFolder','timeZone','componentHistoryId','nodebuffer','type','Activity_Type__c','Async_Request_Id__c','execute','\x20has\x20been\x20created.','Succeed__c','Result__c','Builder','_connectionVeeva','string','BranchComponentHistoryFlosumComponentRetriever','Component_Type__c','EXCEPTION','Veeva\x20Deployment','isDeployed','24918910FCszxs','migration__v','with\x20error','Save\x20Deployment\x20Results','slice','fs/promises','get','../../../constants','FlosumComponentVeevaComponentRetriever','componentIdList','updateLog','./vpk.service','null','Deployment_Result__c','Failure','insertMultipleRecords','Save\x20Backup\x20to\x20Salesforce','MetadataLogStatus','_veevaService','deploymentName','11TsydGz','Component_History__c','base64','fetchAttachmentsDetailsByParentId','15036426kvnPVQ','_connectionSalesforce','length','saveLog','/vpk__','Metadata_Log__c','createVpk','getFlosumComponents','_attachmentLogId','Metadata_Log__c/','Activity_Item__c','Deployment\x20Result','./package-import.service','_deploymentName','Cannot\x20retrievers\x20all\x20attachments','_packageExportService','success','Job_Completed__c','toLowerCase','__esModule','log','Branch__c','Retrieving\x20components','generate','Logger','_componentIdList','_salesforceService','_logger','./veeva.service','_packageImportService','Cannot\x20Backup\x20more\x20than\x20200\x20components.','_branchId','reduce','attachmentLogId','SalesforceService','buildObject','defineProperty','patch','createBackup','Success','set','name','4855812zkQLat','_metadataLogId','branchId','Action__c','organisationName','componentType','lastIndexOf','Deploy\x20completed\x20','loadAsync','352BdnNyY','688HxZgcg','map','ENDPOINT_UPSERT_RECORD','Org__c','vaultpackage.xml','../constants/flosum.constants','logError','Branch','application/zip','PackageImportService','\x20</a>','files','retrieveAttachments','has','../../../core','119371ELqawW','organisationId','_instanceUrl','finishDeploy','TargetId__c','https://veevavault.com/','\x20of\x20branch\x20to\x20Organization\x20','toString','2670czxFVG','componentName','stepName','/Attachment','DeployService','447128rFclfv','saveDeploymentResults','FlosumConstants','_vpkService','.zip','Date__c','constructor','file','joinAllAttachments','4705GtAKmg','jszip','BACKUP_ZIP_NAME','Component_Name__c','finishDeployWithError','_systemLogger','formFlosumDeploymentResults','Deployment','default','error','(((.+)+)+)+$','validate','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','deploymentAction','__importDefault','async','3372cPvDAC','_organisationName','post','values','Backup','filter','_organisationId','DEPLOYED','FLOSUM_NAMESPACE','apply','_timeZone','\x20:\x20','Finish\x20Create\x20Backup','xml2js'];a334_0x13cc=function(){return _0x2f57bd;};return a334_0x13cc();}Object[a334_0x1e30e2(0xc6)](exports,a334_0x1e30e2(0xb5),{'value':!![]}),exports[a334_0x1e30e2(0xf1)]=void 0x0;const jszip_1=__importDefault(require(a334_0x1e30e2(0xfc))),promises_1=require(a334_0x1e30e2(0x8f)),constants_1=require(a334_0x1e30e2(0x91)),flosum_constants_1=require(a334_0x1e30e2(0xdb)),veeva_service_1=require(a334_0x1e30e2(0xbe)),salesforce_service_1=require('./salesforce.service'),core_1=require(a334_0x1e30e2(0xe4)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require('shortid')),xml2js_1=require(a334_0x1e30e2(0x118)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a334_0x1e30e2(0xae)),branch_component_history_flosum_component_retriever_1=require(a334_0x1e30e2(0x107)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a334_0x1e30e2(0x95));class DeployService{constructor(_0xfe3f6c,_0x4b81c1,_0xf7b5c7,_0x2bfd13,_0x1105a0,_0x3f6fcd){const _0x2a041f=a334_0x1e30e2;this['_connectionSalesforce']=_0x4b81c1,this[_0x2a041f(0x83)]=_0xf7b5c7,this[_0x2a041f(0xbd)]=_0x2bfd13,this['_tempFolder']=_0x1105a0,this[_0x2a041f(0xe7)]=_0x3f6fcd,this['_branchId']=_0xfe3f6c[_0x2a041f(0xce)],this['_metadataLogId']=_0xfe3f6c['metadataLogId'],this[_0x2a041f(0xaa)]=_0xfe3f6c[_0x2a041f(0xc3)],this[_0x2a041f(0x111)]=_0xfe3f6c[_0x2a041f(0xe6)],this[_0x2a041f(0x115)]=_0xfe3f6c[_0x2a041f(0x11b)],this[_0x2a041f(0x10c)]=_0xfe3f6c[_0x2a041f(0xd0)],this['_componentIdList']=_0xfe3f6c[_0x2a041f(0x93)],this[_0x2a041f(0xaf)]=_0xfe3f6c[_0x2a041f(0x9d)],this[_0x2a041f(0x100)]=new core_1[(_0x2a041f(0xba))]('veeva-deploy'),this[_0x2a041f(0x9c)]=new veeva_service_1['VeevaService']({'connection':this['_connectionVeeva'],'logger':this['_logger']}),this[_0x2a041f(0xbc)]=new salesforce_service_1[(_0x2a041f(0xc4))]({'connection':this[_0x2a041f(0xa3)]}),this[_0x2a041f(0xbf)]=new package_import_service_1[(_0x2a041f(0xdf))]({'veevaService':this['_veevaService'],'connection':this['_connectionVeeva'],'logger':this[_0x2a041f(0xbd)],'saveLog':this[_0x2a041f(0xa5)]['bind'](this)}),this['_packageExportService']=new package_export_service_1['PackageExportService']({'veevaService':this[_0x2a041f(0x9c)],'connection':this[_0x2a041f(0x83)],'logger':this['_logger']}),this[_0x2a041f(0xf5)]=new vpk_service_1['VpkService']({'connection':this[_0x2a041f(0x83)]});}async[a334_0x1e30e2(0x121)](){const _0x4acd29=a334_0x1e30e2;try{const _0x3c21f5=await this[_0x4acd29(0xa9)]();await this[_0x4acd29(0xbd)][_0x4acd29(0x94)](),await this[_0x4acd29(0xc8)](_0x3c21f5);const _0x4e7fa5=await this[_0x4acd29(0xe2)](_0x3c21f5),_0xa028ed=await this[_0x4acd29(0xfa)](_0x4e7fa5),_0x21ef18=await this['createVpk'](_0xa028ed);await this[_0x4acd29(0xbd)][_0x4acd29(0x94)]();const _0x255866=await this[_0x4acd29(0xbf)]['import'](_0x21ef18);await this[_0x4acd29(0xbd)][_0x4acd29(0x94)]();const _0x3d05e7=this[_0x4acd29(0x101)](_0x3c21f5,_0x255866['packageComponentList']);await this[_0x4acd29(0xf3)](_0x3d05e7),await this[_0x4acd29(0xe8)](_0x255866[_0x4acd29(0x89)],![],_0x255866['packageId']);}catch(_0x5f25e2){await this[_0x4acd29(0xff)](_0x5f25e2)['catch'](_0xff2f84=>this['_systemLogger'][_0x4acd29(0x104)](_0xff2f84));}}async['getFlosumComponents'](){const _0x4f3995=a334_0x1e30e2,_0x53ff75=new Set(this['_componentIdList']);this['_logger'][_0x4f3995(0xb6)](_0x4f3995(0xb8));const _0x1e481b=await new branch_component_history_flosum_component_retriever_1[(_0x4f3995(0x85))]({'value':this['_branchId'],'salesforceService':this[_0x4f3995(0xbc)]})['retrieve'](),_0x58c567=_0x1e481b[_0x4f3995(0x110)](_0x3c2021=>_0x53ff75[_0x4f3995(0xe3)](_0x3c2021['id']));if(_0x58c567['length']!==this['_componentIdList'][_0x4f3995(0xa4)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x58c567;}async['createBackup'](_0x2cffaa){const _0x27fd87=a334_0x1e30e2;var _0x4d2c51;this['_logger'][_0x27fd87(0xb6)]('Create\x20Backup');const _0x5a5c8e=await new flosum_component_veeva_component_retriever_1[(_0x27fd87(0x92))]({'value':_0x2cffaa,'veevaService':this[_0x27fd87(0x9c)],'logger':this[_0x27fd87(0xbd)]})['retrieve'](),_0x38ef22=await this[_0x27fd87(0xb1)]['export'](_0x5a5c8e,_0x27fd87(0x10f));if(_0x38ef22[_0x27fd87(0xa4)]>0x1)throw new Error(_0x27fd87(0xc0));(_0x4d2c51=_0x38ef22[0x0])!==null&&_0x4d2c51!==void 0x0?_0x4d2c51:_0x38ef22[0x0]=new jszip_1[(_0x27fd87(0x103))]();const _0x248d8b=await _0x38ef22[0x0]['generateAsync']({'type':_0x27fd87(0xa0)});this[_0x27fd87(0xbd)]['log'](_0x27fd87(0x9a));const _0x1a7fea={'Body':_0x248d8b,'ContentType':_0x27fd87(0xde),'ParentId':this[_0x27fd87(0xcd)],'Name':flosum_constants_1[_0x27fd87(0xf4)][_0x27fd87(0xfd)]};await this[_0x27fd87(0xa3)]['post'](flosum_constants_1[_0x27fd87(0xf4)][_0x27fd87(0xd8)]+_0x27fd87(0xf0),_0x1a7fea),this[_0x27fd87(0xbd)]['log'](_0x27fd87(0x117));}async[a334_0x1e30e2(0xe2)](_0x1b4321){const _0x415562=a334_0x1e30e2;this[_0x415562(0xbd)][_0x415562(0xb6)]('Retrieving\x20attachments');const _0x2454ef=await(0x0,fetch_attachments_1[_0x415562(0xa1)])(this[_0x415562(0xa3)],_0x1b4321[_0x415562(0xd7)](_0x4e9ecd=>_0x4e9ecd['componentHistoryId'])),_0x3ad420=await(0x0,fetch_attachments_1[_0x415562(0xe2)])(_0x2454ef,this[_0x415562(0xa3)]);if(_0x3ad420['length']!==this[_0x415562(0xbb)][_0x415562(0xa4)])throw new Error(_0x415562(0xb0));return _0x3ad420[_0x415562(0xd7)](_0x2397dc=>_0x2397dc[_0x415562(0x10e)]['Body']);}async[a334_0x1e30e2(0xfa)](_0x1a0135){const _0x1c0860=a334_0x1e30e2;var _0x39eaeb;this[_0x1c0860(0xbd)][_0x1c0860(0xb6)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x452d59=new jszip_1['default']();for(const _0x576ec5 of _0x1a0135){const _0x2c519d=new jszip_1[(_0x1c0860(0x103))]();await _0x2c519d[_0x1c0860(0xd4)](_0x576ec5,{'base64':!![]});for(const _0x5ff0f in _0x2c519d[_0x1c0860(0xe1)]){const _0xa91cf8=await((_0x39eaeb=_0x2c519d[_0x1c0860(0xf9)](_0x5ff0f))===null||_0x39eaeb===void 0x0?void 0x0:_0x39eaeb[_0x1c0860(0x10a)](_0x1c0860(0x84)));_0xa91cf8&&_0x452d59[_0x1c0860(0xf9)](_0x5ff0f,_0xa91cf8);}}const _0x189613=new xml2js_1[(_0x1c0860(0x82))]({'headless':!![]}),_0x57743d={'vaultpackage':{'$':{'xmlns':_0x1c0860(0xea)},'name':this['_deploymentName'],'source':{'vault':undefined,'author':'Flosum'},'packagetype':_0x1c0860(0x8b),'summary':'Deploy','description':_0x1c0860(0x96)}};_0x452d59[_0x1c0860(0xf9)](_0x1c0860(0xda),_0x189613[_0x1c0860(0xc5)](_0x57743d));const _0x2a737b=this[_0x1c0860(0x11a)]+'/'+(0x0,shortid_1['default'])()+_0x1c0860(0xf6),_0xb60a90=await _0x452d59['generateAsync']({'type':_0x1c0860(0x11d)});return await(0x0,promises_1['writeFile'])(_0x2a737b,_0xb60a90),_0x2a737b;}async[a334_0x1e30e2(0xa8)](_0x3f8c75){const _0x5c94aa=a334_0x1e30e2;this[_0x5c94aa(0xbd)][_0x5c94aa(0xb6)]('Create\x20vpk\x20package');const _0x14c004=await this[_0x5c94aa(0xf5)][_0x5c94aa(0xb9)](_0x3f8c75),_0x2b626d=this[_0x5c94aa(0x11a)]+_0x5c94aa(0xa6)+_0x3f8c75[_0x5c94aa(0x8e)](_0x3f8c75[_0x5c94aa(0xd2)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x2b626d,_0x14c004),await this[_0x5c94aa(0xf5)][_0x5c94aa(0x106)](_0x2b626d),_0x2b626d;}async['saveLog'](_0x150c0f,_0xe9248c){const _0x276691=a334_0x1e30e2;this['_logger']['log']('Save\x20log');const _0xeada12={'Body':Buffer['from'](_0x150c0f)[_0x276691(0xec)]('base64'),'ContentType':'text/plain','ParentId':this[_0x276691(0xcd)],'Name':_0xe9248c};await this['_connectionSalesforce'][_0x276691(0x10d)](flosum_constants_1[_0x276691(0xf4)][_0x276691(0xd8)]+'/Attachment',_0xeada12);}['formFlosumDeploymentResults'](_0xc47d53,_0x4f9d1e){const _0x3de557=a334_0x1e30e2;this['_logger']['log']('Form\x20Deployment\x20Results');const _0x45ed2f=_0xc47d53[_0x3de557(0xc2)]((_0x355150,_0x40e024)=>_0x355150[_0x3de557(0xca)]((_0x40e024[_0x3de557(0xd1)]+'.'+_0x40e024[_0x3de557(0xee)])['toLowerCase'](),_0x40e024),new Map());return _0x4f9d1e[_0x3de557(0xd7)](_0x1e0a0b=>{const _0x19cba2=_0x3de557;this[_0x19cba2(0xbd)][_0x19cba2(0xb6)](_0x1e0a0b['type']+'.'+_0x1e0a0b[_0x19cba2(0xcb)]+_0x19cba2(0x116)+_0x1e0a0b['status']);const _0x418d94=(_0x1e0a0b[_0x19cba2(0x11e)]+'.'+_0x1e0a0b[_0x19cba2(0xcb)])[_0x19cba2(0xb4)](),_0x3b68d6=_0x45ed2f[_0x19cba2(0x90)](_0x418d94);return{[constants_1[_0x19cba2(0x113)]+'Type__c']:_0x19cba2(0xad),[constants_1[_0x19cba2(0x113)]+'Status__c']:_0x1e0a0b['status']===status_enums_1['PackageComponentStatus'][_0x19cba2(0x112)]?_0x19cba2(0xc9):_0x19cba2(0x98),[constants_1[_0x19cba2(0x113)]+_0x19cba2(0x81)]:_0x1e0a0b[_0x19cba2(0x108)],[constants_1['FLOSUM_NAMESPACE']+_0x19cba2(0xfe)]:_0x1e0a0b['name'],[constants_1[_0x19cba2(0x113)]+_0x19cba2(0x86)]:_0x1e0a0b[_0x19cba2(0x11e)],[constants_1[_0x19cba2(0x113)]+'Veeva_Step_Name__c']:_0x1e0a0b[_0x19cba2(0xef)],[constants_1[_0x19cba2(0x113)]+_0x19cba2(0xd9)]:this['_organisationId'],[constants_1[_0x19cba2(0x113)]+_0x19cba2(0xa7)]:this['_metadataLogId'],[constants_1[_0x19cba2(0x113)]+_0x19cba2(0x9f)]:_0x3b68d6[_0x19cba2(0x11c)]};});}async[a334_0x1e30e2(0xf3)](_0x5ada1e){const _0x2edc42=a334_0x1e30e2;this[_0x2edc42(0xbd)][_0x2edc42(0xb6)](_0x2edc42(0x8d));const _0x2d3677=await this[_0x2edc42(0xbc)][_0x2edc42(0x99)](constants_1[_0x2edc42(0x113)]+_0x2edc42(0x97),_0x5ada1e),_0x395f5c=_0x2d3677[_0x2edc42(0x110)](_0x465e62=>!_0x465e62[_0x2edc42(0xb2)])[_0x2edc42(0xd7)](_0x3de336=>_0x3de336['errors'])['flat']();if(_0x395f5c[_0x2edc42(0xa4)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x395f5c);}async[a334_0x1e30e2(0xff)](_0x505025){const _0x696ba0=a334_0x1e30e2;this[_0x696ba0(0xbd)][_0x696ba0(0xdc)](_0x505025),await this[_0x696ba0(0xbd)][_0x696ba0(0x94)](),await this[_0x696ba0(0xe8)](![],!![],'');}async[a334_0x1e30e2(0xe8)](_0x3e5398,_0x500217,_0xe86fd6){const _0x31ca11=a334_0x1e30e2,_0x3591c6='<a\x20href='+this[_0x31ca11(0xe7)]+'/'+this[_0x31ca11(0xcd)]+'\x20>\x20'+_0x31ca11(0x88)+_0x31ca11(0xe0),_0x2781fe='<a\x20href='+this['_instanceUrl']+'/'+this['_organisationId']+'\x20>'+this[_0x31ca11(0x10c)]+'</a>',_0x3c56dc=_0x3591c6+_0x31ca11(0xeb)+_0x2781fe+_0x31ca11(0x122),_0x39a3f9={[constants_1[_0x31ca11(0x113)]+_0x31ca11(0xcf)]:_0x3c56dc,[constants_1[_0x31ca11(0x113)]+_0x31ca11(0xf7)]:new Date(),[constants_1[_0x31ca11(0x113)]+_0x31ca11(0xb7)]:this[_0x31ca11(0xc1)],[constants_1['FLOSUM_NAMESPACE']+_0x31ca11(0xac)]:_0x31ca11(0xdd),[constants_1['FLOSUM_NAMESPACE']+_0x31ca11(0x11f)]:_0x31ca11(0x102),[constants_1[_0x31ca11(0x113)]+_0x31ca11(0xe9)]:this[_0x31ca11(0x111)]},_0x1c4ac1={[constants_1[_0x31ca11(0x113)]+'Is_Error__c']:!_0x3e5398,[constants_1[_0x31ca11(0x113)]+_0x31ca11(0x80)]:_0x3e5398,[constants_1[_0x31ca11(0x113)]+'Status__c']:_0x500217?status_enums_1['MetadataLogStatus'][_0x31ca11(0x87)]:status_enums_1[_0x31ca11(0x9b)][_0x31ca11(0x119)],[constants_1['FLOSUM_NAMESPACE']+_0x31ca11(0xb3)]:!![],[constants_1[_0x31ca11(0x113)]+_0x31ca11(0x120)]:_0xe86fd6};await this['_connectionSalesforce'][_0x31ca11(0xc7)](flosum_constants_1[_0x31ca11(0xf4)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x31ca11(0x113)]+_0x31ca11(0xab)+this[_0x31ca11(0xcd)],_0x1c4ac1),await this[_0x31ca11(0xa3)][_0x31ca11(0x10d)](flosum_constants_1[_0x31ca11(0xf4)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x31ca11(0x113)]+'Log__c',_0x39a3f9),this[_0x31ca11(0xbd)][_0x31ca11(0xb6)](_0x31ca11(0xd3)+(_0x3e5398?'successfully':_0x31ca11(0x8c))+'.'),await this[_0x31ca11(0xbd)][_0x31ca11(0x94)]();}}exports[a334_0x1e30e2(0xf1)]=DeployService;