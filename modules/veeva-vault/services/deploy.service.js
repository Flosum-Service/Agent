const a403_0x4c9a33=a403_0x2238;(function(_0x7f7cb4,_0x4439ff){const _0x538a09=a403_0x2238,_0x3e4718=_0x7f7cb4();while(!![]){try{const _0x468b64=-parseInt(_0x538a09(0xdc))/0x1*(parseInt(_0x538a09(0x145))/0x2)+parseInt(_0x538a09(0x13c))/0x3*(-parseInt(_0x538a09(0x103))/0x4)+parseInt(_0x538a09(0x105))/0x5+parseInt(_0x538a09(0x128))/0x6+parseInt(_0x538a09(0xc6))/0x7+parseInt(_0x538a09(0xf3))/0x8*(-parseInt(_0x538a09(0x126))/0x9)+-parseInt(_0x538a09(0xd5))/0xa*(-parseInt(_0x538a09(0xdb))/0xb);if(_0x468b64===_0x4439ff)break;else _0x3e4718['push'](_0x3e4718['shift']());}catch(_0x50f590){_0x3e4718['push'](_0x3e4718['shift']());}}}(a403_0x17db,0x8ffe7));function a403_0x2238(_0x194c0f,_0x9cb2bb){const _0x385aa2=a403_0x17db();return a403_0x2238=function(_0xc7c95e,_0x4d04f5){_0xc7c95e=_0xc7c95e-0xae;let _0x17db0b=_0x385aa2[_0xc7c95e];return _0x17db0b;},a403_0x2238(_0x194c0f,_0x9cb2bb);}const a403_0x4d04f5=(function(){let _0x12c1fe=!![];return function(_0x388167,_0x2aa189){const _0x518393=_0x12c1fe?function(){const _0x2b4b9c=a403_0x2238;if(_0x2aa189){const _0x488db4=_0x2aa189[_0x2b4b9c(0x10f)](_0x388167,arguments);return _0x2aa189=null,_0x488db4;}}:function(){};return _0x12c1fe=![],_0x518393;};}()),a403_0xc7c95e=a403_0x4d04f5(this,function(){const _0x51b10a=a403_0x2238;return a403_0xc7c95e[_0x51b10a(0xca)]()['search']('(((.+)+)+)+$')[_0x51b10a(0xca)]()[_0x51b10a(0x153)](a403_0xc7c95e)['search'](_0x51b10a(0x130));});a403_0xc7c95e();'use strict';function a403_0x17db(){const _0xb5e742=['_metadataLogId','Org__c','EXCEPTION','Save\x20log','(((.+)+)+)+$','map','./veeva.service','_timeZone','stepName','fetchAttachmentsDetailsByParentId','fs/promises','TargetId__c','success','saveLog','/vpk__','PackageImportService','47181rIFjms','Log__c','../constants/flosum.constants','import','defineProperty','post','componentHistoryId','_deploymentName','__esModule','1524932JBCqRH','Logger','organisationName','Deployment','saveBackup','packageId','PackageComponentStatus','set','isDeployed','get','Activity_Item__c','_componentIdList','_vpkService','\x20has\x20been\x20created.','constructor','getFlosumComponents','name','toLowerCase','FLOSUM_NAMESPACE','Result__c','deploymentAction','has','Veeva\x20Deployment','/Attachment','_connectionSalesforce','updateLog','_instanceUrl','saveDeploymentResults','Activity_Type__c','flat','_logger','__importDefault','../enums/status.enums','finishDeploy','slice','metadataLogId','Action__c','generateAsync','_connectionVeeva','Type__c','2343915YnMWUz','_tempFolder','Deployment_Result__c','validate','toString','attachmentLogId','bind','./salesforce.service','createVpk','execute','SalesforceDmlError','errors','../../../core','application/zip','finishDeployWithError','17570730nEMsOL','\x20</a>','formFlosumDeploymentResults','componentIdList','Success','Metadata_Log__c/','11DOatAP','1vpANkG','<a\x20href=','values','_organisationId','componentType','Create\x20Backup','Branch','DEPLOYED','Save\x20Backup\x20to\x20Salesforce','type','Backup','DeployService','veeva-deploy','BACKUP_ZIP_NAME','reduce','branchId','./package-export.service','_branchId','Deploy\x20completed\x20','ENDPOINT_UPSERT_RECORD','FlosumConstants','VeevaService','base64','96328qqGEGP','Status__c','Job_Completed__c','status','./package-import.service','Date__c','.zip','Metadata_Log__c','Succeed__c','./vpk.service','Create\x20vpk\x20package','catch','MetadataLogStatus','\x20of\x20branch\x20to\x20Organization\x20','../classes/errors/salesforce-dml-error','FlosumComponentVeevaComponentRetriever','288cgwDtv','\x20:\x20','2768655WeCvKd','_packageExportService','Cannot\x20retrievers\x20all\x20attachments','Failure','PackageExportService','Cannot\x20Backup\x20more\x20than\x20200\x20components.','_organisationName','Form\x20Deployment\x20Results','retrieveAttachments','createBackup','apply','with\x20error','error','default','COMPLETED','_salesforceService','Component_Name__c','Deployment\x20Result','Body','text/plain','VpkService','log','Component_Type__c','_veevaService','successfully','length','export','filter','writeFile','packageComponentList','organisationId','generate','timeZone','747niTLhn','Veeva_Step_Name__c','5030178XyETAi','../classes/deploy/zip-creator.deploy','Retrieving\x20attachments','_systemLogger'];a403_0x17db=function(){return _0xb5e742;};return a403_0x17db();}var __importDefault=this&&this[a403_0x4c9a33(0xbd)]||function(_0x268973){return _0x268973&&_0x268973['__esModule']?_0x268973:{'default':_0x268973};};Object[a403_0x4c9a33(0x140)](exports,a403_0x4c9a33(0x144),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a403_0x4c9a33(0x136)),constants_1=require('../../../constants'),flosum_constants_1=require(a403_0x4c9a33(0x13e)),veeva_service_1=require(a403_0x4c9a33(0x132)),salesforce_service_1=require(a403_0x4c9a33(0xcd)),core_1=require(a403_0x4c9a33(0xd2)),status_enums_1=require(a403_0x4c9a33(0xbe)),salesforce_dml_error_1=require(a403_0x4c9a33(0x101)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a403_0x4c9a33(0xf7)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a403_0x4c9a33(0xec)),vpk_service_1=require(a403_0x4c9a33(0xfc)),zip_creator_deploy_1=require(a403_0x4c9a33(0x129));class DeployService{constructor(_0x2582e0,_0x3f4161,_0x4a7b19,_0x55c0b0,_0x31efc6,_0x1f00c2){const _0x2b4a02=a403_0x4c9a33;this[_0x2b4a02(0xb6)]=_0x3f4161,this[_0x2b4a02(0xc4)]=_0x4a7b19,this[_0x2b4a02(0xbc)]=_0x55c0b0,this[_0x2b4a02(0xc7)]=_0x31efc6,this[_0x2b4a02(0xb8)]=_0x1f00c2,this[_0x2b4a02(0xed)]=_0x2582e0[_0x2b4a02(0xeb)],this['_metadataLogId']=_0x2582e0[_0x2b4a02(0xc1)],this['_attachmentLogId']=_0x2582e0[_0x2b4a02(0xcb)],this['_organisationId']=_0x2582e0[_0x2b4a02(0x123)],this[_0x2b4a02(0x133)]=_0x2582e0[_0x2b4a02(0x125)],this[_0x2b4a02(0x10b)]=_0x2582e0[_0x2b4a02(0x147)],this[_0x2b4a02(0x150)]=_0x2582e0[_0x2b4a02(0xd8)],this[_0x2b4a02(0x143)]=_0x2582e0['deploymentName'],this[_0x2b4a02(0x12b)]=new core_1[(_0x2b4a02(0x146))](_0x2b4a02(0xe8)),this[_0x2b4a02(0x11c)]=new veeva_service_1[(_0x2b4a02(0xf1))]({'connection':this[_0x2b4a02(0xc4)],'logger':this[_0x2b4a02(0xbc)]}),this[_0x2b4a02(0x114)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x2b4a02(0xb6)]}),this['_packageImportService']=new package_import_service_1[(_0x2b4a02(0x13b))]({'veevaService':this[_0x2b4a02(0x11c)],'connection':this[_0x2b4a02(0xc4)],'logger':this['_logger'],'saveLog':this[_0x2b4a02(0x139)][_0x2b4a02(0xcc)](this)}),this[_0x2b4a02(0x106)]=new package_export_service_1[(_0x2b4a02(0x109))]({'veevaService':this[_0x2b4a02(0x11c)],'connection':this['_connectionVeeva'],'logger':this[_0x2b4a02(0xbc)]}),this[_0x2b4a02(0x151)]=new vpk_service_1[(_0x2b4a02(0x119))]({'connection':this[_0x2b4a02(0xc4)]});}async[a403_0x4c9a33(0xcf)](){const _0x333b53=a403_0x4c9a33;try{const _0x31bf69=await this[_0x333b53(0x154)]();await this['_logger'][_0x333b53(0xb7)]();const _0x2402c6=await this['createBackup'](_0x31bf69);await this[_0x333b53(0x149)](_0x2402c6);const _0x6a9307=await this[_0x333b53(0x10d)](_0x31bf69),_0x3b85a5=await this['createZip'](_0x6a9307),_0x314129=await this[_0x333b53(0xce)](_0x3b85a5);await this[_0x333b53(0xbc)][_0x333b53(0xb7)]();const _0x300c2c=await this['_packageImportService'][_0x333b53(0x13f)](_0x314129);await this[_0x333b53(0xbc)][_0x333b53(0xb7)]();const _0x46026a=this[_0x333b53(0xd7)](_0x31bf69,_0x300c2c[_0x333b53(0x122)]);await this[_0x333b53(0xb9)](_0x46026a),await this[_0x333b53(0xbf)](_0x300c2c[_0x333b53(0x14d)],![],_0x300c2c[_0x333b53(0x14a)]);}catch(_0x37d6dd){await this[_0x333b53(0xd4)](_0x37d6dd)[_0x333b53(0xfe)](_0x1a6e98=>this['_systemLogger'][_0x333b53(0x111)](_0x1a6e98));}}async[a403_0x4c9a33(0x154)](){const _0x145888=a403_0x4c9a33,_0x440c6b=new Set(this[_0x145888(0x150)]);this[_0x145888(0xbc)]['log']('Retrieving\x20components');const _0x2dad40=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this['_branchId'],'salesforceService':this[_0x145888(0x114)]})['retrieve'](),_0x27a850=_0x2dad40[_0x145888(0x120)](_0x5bb6a5=>_0x440c6b[_0x145888(0xb3)](_0x5bb6a5['id']));if(_0x27a850[_0x145888(0x11e)]!==this[_0x145888(0x150)][_0x145888(0x11e)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x27a850;}async[a403_0x4c9a33(0x10e)](_0xc76202){const _0x37a150=a403_0x4c9a33;var _0xfffd5b;this[_0x37a150(0xbc)][_0x37a150(0x11a)](_0x37a150(0xe1));const _0x1e8be7=await new flosum_component_veeva_component_retriever_1[(_0x37a150(0x102))]({'value':_0xc76202,'veevaService':this[_0x37a150(0x11c)],'logger':this[_0x37a150(0xbc)]})['retrieve'](),_0x65f999=await this[_0x37a150(0x106)][_0x37a150(0x11f)](_0x1e8be7,_0x37a150(0xe6));if(_0x65f999[_0x37a150(0x11e)]>0x1)throw new Error(_0x37a150(0x10a));return(_0xfffd5b=_0x65f999[0x0])!==null&&_0xfffd5b!==void 0x0?_0xfffd5b:_0x65f999[0x0]=new jszip_1['default'](),_0x65f999[0x0][_0x37a150(0xc3)]({'type':'base64'});}async[a403_0x4c9a33(0x149)](_0x2758fc){const _0xbb25ae=a403_0x4c9a33;this[_0xbb25ae(0xbc)][_0xbb25ae(0x11a)](_0xbb25ae(0xe4));const _0x4e1fb8={'Body':_0x2758fc,'ContentType':_0xbb25ae(0xd3),'ParentId':this[_0xbb25ae(0x12c)],'Name':flosum_constants_1[_0xbb25ae(0xf0)][_0xbb25ae(0xe9)]};await this[_0xbb25ae(0xb6)][_0xbb25ae(0x141)](flosum_constants_1[_0xbb25ae(0xf0)]['ENDPOINT_UPSERT_RECORD']+_0xbb25ae(0xb5),_0x4e1fb8);}async[a403_0x4c9a33(0x10d)](_0x25f04b){const _0x362682=a403_0x4c9a33;this[_0x362682(0xbc)][_0x362682(0x11a)](_0x362682(0x12a));const _0xdabfc8=await(0x0,fetch_attachments_1[_0x362682(0x135)])(this[_0x362682(0xb6)],_0x25f04b['map'](_0x5c12df=>_0x5c12df[_0x362682(0x142)])),_0x548776=await(0x0,fetch_attachments_1[_0x362682(0x10d)])(_0xdabfc8,this[_0x362682(0xb6)]);if(_0x548776[_0x362682(0x11e)]!==this['_componentIdList'][_0x362682(0x11e)])throw new Error(_0x362682(0x107));return _0x548776['map'](_0x2f7c48=>_0x2f7c48[_0x362682(0xde)][_0x362682(0x117)]);}async['createZip'](_0x4c690a){const _0x236e5e=a403_0x4c9a33;this[_0x236e5e(0xbc)][_0x236e5e(0x11a)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x5035f9=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x4c690a,'deploymentName':this[_0x236e5e(0x143)]})[_0x236e5e(0xcf)](),_0x1b2859=this[_0x236e5e(0xc7)]+'/'+(0x0,shortid_1[_0x236e5e(0x112)])()+_0x236e5e(0xf9);return await(0x0,promises_1[_0x236e5e(0x121)])(_0x1b2859,_0x5035f9),_0x1b2859;}async[a403_0x4c9a33(0xce)](_0x155e66){const _0xfb05b2=a403_0x4c9a33;this['_logger'][_0xfb05b2(0x11a)](_0xfb05b2(0xfd));const _0x3fe568=await this['_vpkService'][_0xfb05b2(0x124)](_0x155e66),_0x5a964d=this[_0xfb05b2(0xc7)]+_0xfb05b2(0x13a)+_0x155e66[_0xfb05b2(0xc0)](_0x155e66['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0xfb05b2(0x121)])(_0x5a964d,_0x3fe568),await this[_0xfb05b2(0x151)][_0xfb05b2(0xc9)](_0x5a964d),_0x5a964d;}async['saveLog'](_0xcfa513,_0x38e633){const _0x97706f=a403_0x4c9a33;this[_0x97706f(0xbc)][_0x97706f(0x11a)](_0x97706f(0x12f));const _0x375125={'Body':Buffer['from'](_0xcfa513)[_0x97706f(0xca)](_0x97706f(0xf2)),'ContentType':_0x97706f(0x118),'ParentId':this[_0x97706f(0x12c)],'Name':_0x38e633};await this[_0x97706f(0xb6)][_0x97706f(0x141)](flosum_constants_1[_0x97706f(0xf0)][_0x97706f(0xef)]+_0x97706f(0xb5),_0x375125);}[a403_0x4c9a33(0xd7)](_0xbfe708,_0x273b71){const _0x52afc1=a403_0x4c9a33;this[_0x52afc1(0xbc)]['log'](_0x52afc1(0x10c));const _0x400c47=_0xbfe708[_0x52afc1(0xea)]((_0x45aa5a,_0x2c8fdf)=>_0x45aa5a[_0x52afc1(0x14c)]((_0x2c8fdf[_0x52afc1(0xe0)]+'.'+_0x2c8fdf['componentName'])[_0x52afc1(0xaf)](),_0x2c8fdf),new Map());return _0x273b71[_0x52afc1(0x131)](_0xa753d3=>{const _0x16320b=_0x52afc1;this[_0x16320b(0xbc)][_0x16320b(0x11a)](_0xa753d3[_0x16320b(0xe5)]+'.'+_0xa753d3[_0x16320b(0xae)]+_0x16320b(0x104)+_0xa753d3[_0x16320b(0xf6)]);const _0x324d1f=(_0xa753d3[_0x16320b(0xe5)]+'.'+_0xa753d3['name'])[_0x16320b(0xaf)](),_0x3ff21e=_0x400c47[_0x16320b(0x14e)](_0x324d1f);return{[constants_1[_0x16320b(0xb0)]+_0x16320b(0xc5)]:_0x16320b(0x116),[constants_1[_0x16320b(0xb0)]+_0x16320b(0xf4)]:_0xa753d3[_0x16320b(0xf6)]===status_enums_1[_0x16320b(0x14b)][_0x16320b(0xe3)]?_0x16320b(0xd9):_0x16320b(0x108),[constants_1[_0x16320b(0xb0)]+_0x16320b(0xb1)]:_0xa753d3[_0x16320b(0xb2)],[constants_1[_0x16320b(0xb0)]+_0x16320b(0x115)]:_0xa753d3[_0x16320b(0xae)],[constants_1[_0x16320b(0xb0)]+_0x16320b(0x11b)]:_0xa753d3['type'],[constants_1[_0x16320b(0xb0)]+_0x16320b(0x127)]:_0xa753d3[_0x16320b(0x134)],[constants_1[_0x16320b(0xb0)]+_0x16320b(0x12d)]:this[_0x16320b(0xdf)],[constants_1[_0x16320b(0xb0)]+_0x16320b(0xfa)]:this[_0x16320b(0x12c)],[constants_1['FLOSUM_NAMESPACE']+'Component_History__c']:_0x3ff21e[_0x16320b(0x142)]};});}async['saveDeploymentResults'](_0x2e9ab6){const _0x1f4ee7=a403_0x4c9a33;this[_0x1f4ee7(0xbc)][_0x1f4ee7(0x11a)]('Save\x20Deployment\x20Results');const _0x382543=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x1f4ee7(0xb0)]+_0x1f4ee7(0xc8),_0x2e9ab6),_0x39aaba=_0x382543[_0x1f4ee7(0x120)](_0x4558c5=>!_0x4558c5[_0x1f4ee7(0x138)])[_0x1f4ee7(0x131)](_0x46c7c5=>_0x46c7c5[_0x1f4ee7(0xd1)])[_0x1f4ee7(0xbb)]();if(_0x39aaba['length'])throw new salesforce_dml_error_1[(_0x1f4ee7(0xd0))](_0x39aaba);}async['finishDeployWithError'](_0x5ecd1d){const _0xc5fbfe=a403_0x4c9a33;this[_0xc5fbfe(0xbc)]['logError'](_0x5ecd1d),await this[_0xc5fbfe(0xbc)][_0xc5fbfe(0xb7)](),await this[_0xc5fbfe(0xbf)](![],!![],'');}async[a403_0x4c9a33(0xbf)](_0x22afd2,_0x3bac12,_0x5a8e36){const _0x1ae3fc=a403_0x4c9a33,_0x1d7e50=_0x1ae3fc(0xdd)+this[_0x1ae3fc(0xb8)]+'/'+this['_metadataLogId']+'\x20>\x20'+_0x1ae3fc(0xb4)+_0x1ae3fc(0xd6),_0x10c4c0=_0x1ae3fc(0xdd)+this[_0x1ae3fc(0xb8)]+'/'+this[_0x1ae3fc(0xdf)]+'\x20>'+this['_organisationName']+'</a>',_0x5e363e=_0x1d7e50+_0x1ae3fc(0x100)+_0x10c4c0+_0x1ae3fc(0x152),_0x325a82={[constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0xc2)]:_0x5e363e,[constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0xf8)]:new Date(),[constants_1[_0x1ae3fc(0xb0)]+'Branch__c']:this[_0x1ae3fc(0xed)],[constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0x14f)]:_0x1ae3fc(0xe2),[constants_1['FLOSUM_NAMESPACE']+_0x1ae3fc(0xba)]:_0x1ae3fc(0x148),[constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0x137)]:this[_0x1ae3fc(0xdf)]},_0x2e503c={[constants_1[_0x1ae3fc(0xb0)]+'Is_Error__c']:!_0x22afd2,[constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0xfb)]:_0x22afd2,[constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0xf4)]:_0x3bac12?status_enums_1[_0x1ae3fc(0xff)][_0x1ae3fc(0x12e)]:status_enums_1[_0x1ae3fc(0xff)][_0x1ae3fc(0x113)],[constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0xf5)]:!![],[constants_1[_0x1ae3fc(0xb0)]+'External_Deployment_Id__c']:_0x5a8e36};await this[_0x1ae3fc(0xb6)]['patch'](flosum_constants_1[_0x1ae3fc(0xf0)][_0x1ae3fc(0xef)]+'/'+constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0xda)+this[_0x1ae3fc(0x12c)],_0x2e503c),await this[_0x1ae3fc(0xb6)][_0x1ae3fc(0x141)](flosum_constants_1[_0x1ae3fc(0xf0)][_0x1ae3fc(0xef)]+'/'+constants_1[_0x1ae3fc(0xb0)]+_0x1ae3fc(0x13d),_0x325a82),this[_0x1ae3fc(0xbc)][_0x1ae3fc(0x11a)](_0x1ae3fc(0xee)+(_0x22afd2?_0x1ae3fc(0x11d):_0x1ae3fc(0x110))+'.'),await this[_0x1ae3fc(0xbc)][_0x1ae3fc(0xb7)]();}}exports[a403_0x4c9a33(0xe7)]=DeployService;