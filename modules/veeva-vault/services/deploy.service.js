const a357_0x5a3ca5=a357_0xf3eb;(function(_0x10b7f7,_0x4ab874){const _0x3539ee=a357_0xf3eb,_0xd7d159=_0x10b7f7();while(!![]){try{const _0x54a1ba=-parseInt(_0x3539ee(0x1a1))/0x1+parseInt(_0x3539ee(0x1b7))/0x2+-parseInt(_0x3539ee(0x19a))/0x3*(-parseInt(_0x3539ee(0x1be))/0x4)+-parseInt(_0x3539ee(0x17d))/0x5*(-parseInt(_0x3539ee(0x1f8))/0x6)+-parseInt(_0x3539ee(0x170))/0x7*(-parseInt(_0x3539ee(0x1f9))/0x8)+-parseInt(_0x3539ee(0x19b))/0x9*(parseInt(_0x3539ee(0x1d8))/0xa)+-parseInt(_0x3539ee(0x199))/0xb;if(_0x54a1ba===_0x4ab874)break;else _0xd7d159['push'](_0xd7d159['shift']());}catch(_0x1c2336){_0xd7d159['push'](_0xd7d159['shift']());}}}(a357_0x5202,0x60e91));const a357_0x2b80b9=(function(){let _0x4390ef=!![];return function(_0x2b22f8,_0x8a2dfa){const _0xeeab7c=_0x4390ef?function(){const _0x4be441=a357_0xf3eb;if(_0x8a2dfa){const _0x37404c=_0x8a2dfa[_0x4be441(0x1d5)](_0x2b22f8,arguments);return _0x8a2dfa=null,_0x37404c;}}:function(){};return _0x4390ef=![],_0xeeab7c;};}()),a357_0x3b7630=a357_0x2b80b9(this,function(){const _0x124c51=a357_0xf3eb;return a357_0x3b7630[_0x124c51(0x1a2)]()[_0x124c51(0x1e4)](_0x124c51(0x180))[_0x124c51(0x1a2)]()[_0x124c51(0x190)](a357_0x3b7630)[_0x124c51(0x1e4)](_0x124c51(0x180));});a357_0x3b7630();'use strict';var __importDefault=this&&this[a357_0x5a3ca5(0x1bd)]||function(_0x425060){return _0x425060&&_0x425060['__esModule']?_0x425060:{'default':_0x425060};};Object[a357_0x5a3ca5(0x188)](exports,'__esModule',{'value':!![]}),exports[a357_0x5a3ca5(0x1c4)]=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require('fs/promises'),constants_1=require(a357_0x5a3ca5(0x1cc)),flosum_constants_1=require(a357_0x5a3ca5(0x1f2)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),core_1=require(a357_0x5a3ca5(0x1ca)),status_enums_1=require(a357_0x5a3ca5(0x176)),salesforce_dml_error_1=require(a357_0x5a3ca5(0x1e3)),shortid_1=__importDefault(require(a357_0x5a3ca5(0x1c0))),fetch_attachments_1=require(a357_0x5a3ca5(0x187)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a357_0x5a3ca5(0x1b2)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a357_0x5a3ca5(0x1c5)),vpk_service_1=require(a357_0x5a3ca5(0x1f0)),zip_creator_deploy_1=require(a357_0x5a3ca5(0x1c6));class DeployService{constructor(_0x4bef94,_0x9a6ce8,_0x3ba14d,_0x56cb25,_0x33c734,_0x44b436){const _0x3d10e2=a357_0x5a3ca5;this[_0x3d10e2(0x182)]=_0x9a6ce8,this[_0x3d10e2(0x185)]=_0x3ba14d,this[_0x3d10e2(0x189)]=_0x56cb25,this[_0x3d10e2(0x196)]=_0x33c734,this['_instanceUrl']=_0x44b436,this['_branchId']=_0x4bef94[_0x3d10e2(0x1b8)],this[_0x3d10e2(0x1f6)]=_0x4bef94[_0x3d10e2(0x18b)],this[_0x3d10e2(0x174)]=_0x4bef94['attachmentLogId'],this['_organisationId']=_0x4bef94['organisationId'],this[_0x3d10e2(0x1d0)]=_0x4bef94[_0x3d10e2(0x1ce)],this['_organisationName']=_0x4bef94[_0x3d10e2(0x16e)],this[_0x3d10e2(0x1fa)]=_0x4bef94[_0x3d10e2(0x1cf)],this[_0x3d10e2(0x18a)]=_0x4bef94[_0x3d10e2(0x1f1)],this[_0x3d10e2(0x1a9)]=new core_1['Logger'](_0x3d10e2(0x17f)),this[_0x3d10e2(0x1e7)]=new veeva_service_1[(_0x3d10e2(0x17a))]({'connection':this['_connectionVeeva'],'logger':this['_logger']}),this[_0x3d10e2(0x1af)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x3d10e2(0x182)]}),this[_0x3d10e2(0x178)]=new package_import_service_1[(_0x3d10e2(0x1e6))]({'veevaService':this[_0x3d10e2(0x1e7)],'connection':this[_0x3d10e2(0x185)],'logger':this['_logger'],'saveLog':this['saveLog'][_0x3d10e2(0x1dd)](this)}),this[_0x3d10e2(0x16a)]=new package_export_service_1[(_0x3d10e2(0x1ed))]({'veevaService':this['_veevaService'],'connection':this[_0x3d10e2(0x185)],'logger':this[_0x3d10e2(0x189)]}),this[_0x3d10e2(0x1df)]=new vpk_service_1[(_0x3d10e2(0x1eb))]({'connection':this[_0x3d10e2(0x185)]});}async['execute'](){const _0x450c64=a357_0x5a3ca5;try{const _0xff8750=await this[_0x450c64(0x1d3)]();await this['_logger'][_0x450c64(0x19d)]();const _0x278771=await this[_0x450c64(0x1d1)](_0xff8750);await this[_0x450c64(0x1e8)](_0x278771);const _0x59f178=await this[_0x450c64(0x1dc)](_0xff8750),_0xedac03=await this['createZip'](_0x59f178),_0x5d55e4=await this['createVpk'](_0xedac03);await this[_0x450c64(0x189)]['updateLog']();const _0x576fca=await this[_0x450c64(0x178)][_0x450c64(0x1bb)](_0x5d55e4);await this[_0x450c64(0x189)]['updateLog']();const _0x115fb3=this[_0x450c64(0x165)](_0xff8750,_0x576fca[_0x450c64(0x1a3)]);await this['saveDeploymentResults'](_0x115fb3),await this[_0x450c64(0x177)](_0x576fca['isDeployed'],![],_0x576fca[_0x450c64(0x1da)]);}catch(_0xdd1b3){await this['finishDeployWithError'](_0xdd1b3)['catch'](_0x4bf681=>this[_0x450c64(0x1a9)][_0x450c64(0x1a5)](_0x4bf681));}}async['getFlosumComponents'](){const _0x3329d6=a357_0x5a3ca5,_0x5c56c8=new Set(this[_0x3329d6(0x1fa)]);this[_0x3329d6(0x189)][_0x3329d6(0x1f3)]('Retrieving\x20components');const _0xb50b0f=await new branch_component_history_flosum_component_retriever_1[(_0x3329d6(0x1d6))]({'value':this['_branchId'],'salesforceService':this[_0x3329d6(0x1af)]})[_0x3329d6(0x1ea)](),_0x25bdc1=_0xb50b0f[_0x3329d6(0x1ab)](_0x585034=>_0x5c56c8[_0x3329d6(0x1e9)](_0x585034['id']));if(_0x25bdc1[_0x3329d6(0x1b4)]!==this['_componentIdList']['length'])throw new Error(_0x3329d6(0x1c2));return _0x25bdc1;}async[a357_0x5a3ca5(0x1d1)](_0x10671b){const _0x304a80=a357_0x5a3ca5;var _0x360a47;this['_logger']['log']('Create\x20Backup');const _0x395779=await new flosum_component_veeva_component_retriever_1[(_0x304a80(0x1ee))]({'value':_0x10671b,'veevaService':this[_0x304a80(0x1e7)],'logger':this[_0x304a80(0x189)]})[_0x304a80(0x1ea)](),_0x49360d=await this['_packageExportService'][_0x304a80(0x18d)](_0x395779,_0x304a80(0x1e5));if(_0x49360d[_0x304a80(0x1b4)]>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x360a47=_0x49360d[0x0])!==null&&_0x360a47!==void 0x0?_0x360a47:_0x49360d[0x0]=new jszip_1[(_0x304a80(0x1cb))](),_0x49360d[0x0][_0x304a80(0x193)]({'type':_0x304a80(0x16f)});}async[a357_0x5a3ca5(0x1e8)](_0x322394){const _0x51d08d=a357_0x5a3ca5;this[_0x51d08d(0x189)][_0x51d08d(0x1f3)](_0x51d08d(0x1c7));const _0x5a81f9={'Body':_0x322394,'ContentType':_0x51d08d(0x1db),'ParentId':this[_0x51d08d(0x1f6)],'Name':flosum_constants_1[_0x51d08d(0x1a7)]['BACKUP_ZIP_NAME']};await this[_0x51d08d(0x182)]['post'](flosum_constants_1[_0x51d08d(0x1a7)][_0x51d08d(0x1d9)]+_0x51d08d(0x162),_0x5a81f9);}async[a357_0x5a3ca5(0x1dc)](_0x58aedf){const _0x29e214=a357_0x5a3ca5;this[_0x29e214(0x189)][_0x29e214(0x1f3)](_0x29e214(0x186));const _0x132ffb=await(0x0,fetch_attachments_1[_0x29e214(0x195)])(this['_connectionSalesforce'],_0x58aedf[_0x29e214(0x19e)](_0x2701c9=>_0x2701c9['componentHistoryId'])),_0x162fab=await(0x0,fetch_attachments_1[_0x29e214(0x1dc)])(_0x132ffb,this[_0x29e214(0x182)]);if(_0x162fab[_0x29e214(0x1b4)]!==this['_componentIdList'][_0x29e214(0x1b4)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x162fab[_0x29e214(0x19e)](_0x321292=>_0x321292[_0x29e214(0x18f)]['Body']);}async[a357_0x5a3ca5(0x1fb)](_0x4d643b){const _0x4de962=a357_0x5a3ca5;this[_0x4de962(0x189)]['log']('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x284f6e=await new zip_creator_deploy_1[(_0x4de962(0x1ef))]({'attachmentBodies':_0x4d643b,'deploymentName':this[_0x4de962(0x18a)]})[_0x4de962(0x1a6)](),_0x2349dd=this['_tempFolder']+'/'+(0x0,shortid_1[_0x4de962(0x1cb)])()+_0x4de962(0x16b);return await(0x0,promises_1[_0x4de962(0x19f)])(_0x2349dd,_0x284f6e),_0x2349dd;}async[a357_0x5a3ca5(0x175)](_0x58aa34){const _0x5e30f6=a357_0x5a3ca5;this[_0x5e30f6(0x189)]['log']('Create\x20vpk\x20package');const _0x3fcbd1=await this['_vpkService']['generate'](_0x58aa34),_0x5dbb0b=this['_tempFolder']+_0x5e30f6(0x1e1)+_0x58aa34[_0x5e30f6(0x1c9)](_0x58aa34[_0x5e30f6(0x169)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x5dbb0b,_0x3fcbd1),await this[_0x5e30f6(0x1df)][_0x5e30f6(0x191)](_0x5dbb0b),_0x5dbb0b;}async['saveLog'](_0x5491a1,_0x2e1b2d){const _0xfa3fae=a357_0x5a3ca5;this['_logger'][_0xfa3fae(0x1f3)](_0xfa3fae(0x1ad));const _0x3ef0b0={'Body':Buffer[_0xfa3fae(0x17e)](_0x5491a1)[_0xfa3fae(0x1a2)](_0xfa3fae(0x16f)),'ContentType':_0xfa3fae(0x1bf),'ParentId':this[_0xfa3fae(0x1f6)],'Name':_0x2e1b2d};await this[_0xfa3fae(0x182)][_0xfa3fae(0x1b6)](flosum_constants_1[_0xfa3fae(0x1a7)][_0xfa3fae(0x1d9)]+_0xfa3fae(0x162),_0x3ef0b0);}['formFlosumDeploymentResults'](_0x293d0a,_0x1a9777){const _0x9c4a9d=a357_0x5a3ca5;this[_0x9c4a9d(0x189)][_0x9c4a9d(0x1f3)]('Form\x20Deployment\x20Results');const _0x203a73=_0x293d0a[_0x9c4a9d(0x1f4)]((_0x54fc3a,_0x3962dd)=>_0x54fc3a['set']((_0x3962dd['componentType']+'.'+_0x3962dd[_0x9c4a9d(0x17b)])[_0x9c4a9d(0x1ec)](),_0x3962dd),new Map());return _0x1a9777[_0x9c4a9d(0x19e)](_0x47cf60=>{const _0x816781=_0x9c4a9d;this[_0x816781(0x189)]['log'](_0x47cf60['type']+'.'+_0x47cf60['name']+_0x816781(0x1b0)+_0x47cf60[_0x816781(0x197)]);const _0x3d374a=(_0x47cf60['type']+'.'+_0x47cf60[_0x816781(0x194)])[_0x816781(0x1ec)](),_0x10cdb4=_0x203a73[_0x816781(0x18e)](_0x3d374a);return{[constants_1[_0x816781(0x173)]+_0x816781(0x168)]:'Deployment\x20Result',[constants_1[_0x816781(0x173)]+'Status__c']:_0x47cf60[_0x816781(0x197)]===status_enums_1[_0x816781(0x1c1)][_0x816781(0x181)]?_0x816781(0x1ba):'Failure',[constants_1[_0x816781(0x173)]+_0x816781(0x1b1)]:_0x47cf60['deploymentAction'],[constants_1['FLOSUM_NAMESPACE']+_0x816781(0x17c)]:_0x47cf60[_0x816781(0x194)],[constants_1['FLOSUM_NAMESPACE']+_0x816781(0x1d2)]:_0x47cf60['type'],[constants_1['FLOSUM_NAMESPACE']+_0x816781(0x18c)]:_0x47cf60['stepName'],[constants_1[_0x816781(0x173)]+_0x816781(0x164)]:this[_0x816781(0x1a4)],[constants_1[_0x816781(0x173)]+'Metadata_Log__c']:this[_0x816781(0x1f6)],[constants_1[_0x816781(0x173)]+_0x816781(0x1a8)]:_0x10cdb4[_0x816781(0x1b9)]};});}async[a357_0x5a3ca5(0x183)](_0x59f742){const _0x4dd763=a357_0x5a3ca5;this[_0x4dd763(0x189)][_0x4dd763(0x1f3)](_0x4dd763(0x19c));const _0x34bcf2=await this[_0x4dd763(0x1af)][_0x4dd763(0x1c3)](constants_1[_0x4dd763(0x173)]+_0x4dd763(0x184),_0x59f742),_0x23c537=_0x34bcf2[_0x4dd763(0x1ab)](_0x163703=>!_0x163703['success'])[_0x4dd763(0x19e)](_0x39dced=>_0x39dced['errors'])[_0x4dd763(0x166)]();if(_0x23c537[_0x4dd763(0x1b4)])throw new salesforce_dml_error_1[(_0x4dd763(0x1f5))](_0x23c537);}async['finishDeployWithError'](_0x4624e3){const _0x5c8901=a357_0x5a3ca5;this[_0x5c8901(0x189)]['logError'](_0x4624e3),await this[_0x5c8901(0x189)][_0x5c8901(0x19d)](),await this[_0x5c8901(0x177)](![],!![],'');}async[a357_0x5a3ca5(0x177)](_0x176997,_0x4106ac,_0x56ecd0){const _0x4c05d9=a357_0x5a3ca5,_0x3df89d=_0x4c05d9(0x1ac)+this[_0x4c05d9(0x1e2)]+'/'+this[_0x4c05d9(0x1f6)]+_0x4c05d9(0x16d)+_0x4c05d9(0x1aa)+'\x20</a>',_0x38431d=_0x4c05d9(0x1ac)+this[_0x4c05d9(0x1e2)]+'/'+this[_0x4c05d9(0x1a4)]+'\x20>'+this[_0x4c05d9(0x172)]+'</a>',_0x445c18=_0x3df89d+_0x4c05d9(0x1a0)+_0x38431d+_0x4c05d9(0x1d4),_0x87cc81={[constants_1[_0x4c05d9(0x173)]+'Action__c']:_0x445c18,[constants_1['FLOSUM_NAMESPACE']+'Date__c']:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x4c05d9(0x1bc)]:this[_0x4c05d9(0x179)],[constants_1[_0x4c05d9(0x173)]+'Activity_Item__c']:_0x4c05d9(0x192),[constants_1[_0x4c05d9(0x173)]+_0x4c05d9(0x167)]:_0x4c05d9(0x163),[constants_1[_0x4c05d9(0x173)]+_0x4c05d9(0x1e0)]:this[_0x4c05d9(0x1a4)]},_0x1040f0={[constants_1[_0x4c05d9(0x173)]+_0x4c05d9(0x1f7)]:!_0x176997,[constants_1[_0x4c05d9(0x173)]+'Succeed__c']:_0x176997,[constants_1[_0x4c05d9(0x173)]+_0x4c05d9(0x1de)]:_0x4106ac?status_enums_1[_0x4c05d9(0x1cd)]['EXCEPTION']:status_enums_1[_0x4c05d9(0x1cd)][_0x4c05d9(0x171)],[constants_1[_0x4c05d9(0x173)]+_0x4c05d9(0x1d7)]:!![],[constants_1[_0x4c05d9(0x173)]+_0x4c05d9(0x198)]:_0x56ecd0};await this[_0x4c05d9(0x182)][_0x4c05d9(0x1ae)](flosum_constants_1[_0x4c05d9(0x1a7)][_0x4c05d9(0x1d9)]+'/'+constants_1[_0x4c05d9(0x173)]+_0x4c05d9(0x16c)+this['_metadataLogId'],_0x1040f0),await this['_connectionSalesforce'][_0x4c05d9(0x1b6)](flosum_constants_1[_0x4c05d9(0x1a7)][_0x4c05d9(0x1d9)]+'/'+constants_1[_0x4c05d9(0x173)]+_0x4c05d9(0x1b3),_0x87cc81),this['_logger'][_0x4c05d9(0x1f3)]('Deploy\x20completed\x20'+(_0x176997?_0x4c05d9(0x1c8):_0x4c05d9(0x1b5))+'.'),await this[_0x4c05d9(0x189)][_0x4c05d9(0x19d)]();}}function a357_0x5202(){const _0x3516da=['defineProperty','_logger','_deploymentName','metadataLogId','Veeva_Step_Name__c','export','get','values','constructor','validate','Branch','generateAsync','name','fetchAttachmentsDetailsByParentId','_tempFolder','status','External_Deployment_Id__c','10587775ywnDjg','21636uPNXKx','9yiYoCl','Save\x20Deployment\x20Results','updateLog','map','writeFile','\x20of\x20branch\x20to\x20Organization\x20','242892vuHvyL','toString','packageComponentList','_organisationId','error','execute','FlosumConstants','Component_History__c','_systemLogger','Veeva\x20Deployment','filter','<a\x20href=','Save\x20log','patch','_salesforceService','\x20:\x20','Result__c','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Log__c','length','with\x20error','post','498860YNxRXy','branchId','componentHistoryId','Success','import','Branch__c','__importDefault','8mjqeeI','text/plain','shortid','PackageComponentStatus','Cannot\x20retrieve\x20all\x20components.','insertMultipleRecords','DeployService','./package-export.service','../classes/deploy/zip-creator.deploy','Save\x20Backup\x20to\x20Salesforce','successfully','slice','../../../core','default','../../../constants','MetadataLogStatus','timeZone','componentIdList','_timeZone','createBackup','Component_Type__c','getFlosumComponents','\x20has\x20been\x20created.','apply','BranchComponentHistoryFlosumComponentRetriever','Job_Completed__c','490670BkEDYz','ENDPOINT_UPSERT_RECORD','packageId','application/zip','retrieveAttachments','bind','Status__c','_vpkService','TargetId__c','/vpk__','_instanceUrl','../classes/errors/salesforce-dml-error','search','Backup','PackageImportService','_veevaService','saveBackup','has','retrieve','VpkService','toLowerCase','PackageExportService','FlosumComponentVeevaComponentRetriever','ZipCreatorDeploy','./vpk.service','deploymentName','../constants/flosum.constants','log','reduce','SalesforceDmlError','_metadataLogId','Is_Error__c','970410mTHuoS','56gKMvxt','_componentIdList','createZip','/Attachment','Deployment','Org__c','formFlosumDeploymentResults','flat','Activity_Type__c','Type__c','lastIndexOf','_packageExportService','.zip','Metadata_Log__c/','\x20>\x20','organisationName','base64','740635ZqBIop','COMPLETED','_organisationName','FLOSUM_NAMESPACE','_attachmentLogId','createVpk','../enums/status.enums','finishDeploy','_packageImportService','_branchId','VeevaService','componentName','Component_Name__c','20tLqglc','from','veeva-deploy','(((.+)+)+)+$','DEPLOYED','_connectionSalesforce','saveDeploymentResults','Deployment_Result__c','_connectionVeeva','Retrieving\x20attachments','../../shared/utils/fetch-attachments'];a357_0x5202=function(){return _0x3516da;};return a357_0x5202();}function a357_0xf3eb(_0x21b643,_0x2a8423){const _0x3e98f0=a357_0x5202();return a357_0xf3eb=function(_0x3b7630,_0x2b80b9){_0x3b7630=_0x3b7630-0x162;let _0x520234=_0x3e98f0[_0x3b7630];return _0x520234;},a357_0xf3eb(_0x21b643,_0x2a8423);}exports['DeployService']=DeployService;