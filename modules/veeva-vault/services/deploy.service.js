const a334_0x3c7c24=a334_0x5c5f;function a334_0x13d6(){const _0x15e3a1=['../enums/status.enums','_componentIdList','./vpk.service','__esModule','formFlosumDeploymentResults','Builder','from','logError','630858tBrDpq','nodebuffer','finishDeployWithError','_metadataLogId','_salesforceService','deploymentName','values','slice','toString','_instanceUrl','Action__c','updateLog','name','flat','default','24rseoeO','get','</a>','Deploy\x20completed\x20','buildObject','Failure','5734760pSuDSN','Result__c','componentType','_systemLogger','application/zip','filter','createVpk','finishDeploy','async','_deploymentName','fs/promises','<a\x20href=','stepName','Branch__c','../../../core','constructor','DeployService','Branch','../classes/errors/salesforce-dml-error','getFlosumComponents','Success','status','catch','text/plain','SalesforceService','_branchId','\x20has\x20been\x20created.','toLowerCase','Save\x20log','.zip','length','patch','Date__c','xml2js','65085768SyTdgY','Log__c','post','Deploy','Metadata_Log__c/','/Attachment','_packageExportService','\x20>\x20','saveLog','file','organisationName','_logger','search','PackageExportService','branchId','error','PackageComponentStatus','vaultpackage.xml','../constants/flosum.constants','_attachmentLogId','with\x20error','(((.+)+)+)+$','MetadataLogStatus','Succeed__c','componentHistoryId','ENDPOINT_UPSERT_RECORD','_organisationId','veeva-deploy','Deployment\x20Result','log','_connectionVeeva','retrieveAttachments','Is_Error__c','generateAsync','Async_Request_Id__c','10709yjLVri','successfully','./package-export.service','Cannot\x20Backup\x20more\x20than\x20200\x20components.','componentName','Cannot\x20retrieve\x20all\x20components.','_veevaService','326qfWUKa','insertMultipleRecords','migration__v','Component_Name__c','_vpkService','\x20:\x20','errors','success','PackageImportService','base64','_timeZone','FLOSUM_NAMESPACE','_tempFolder','Retrieving\x20attachments','6172355CrhLQl','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','organisationId','Save\x20Backup\x20to\x20Salesforce','https://veevavault.com/','string','Cannot\x20retrievers\x20all\x20attachments','apply','Deployment_Result__c','retrieve','Metadata_Log__c','type','writeFile','__importDefault','Veeva_Step_Name__c','Veeva\x20Deployment','EXCEPTION','VeevaService','Status__c','lastIndexOf','9608370SHEBwT','timeZone','_connectionSalesforce','Org__c','Body','packageId','files','COMPLETED','../../shared/utils/fetch-attachments','./veeva.service','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','BACKUP_ZIP_NAME','Create\x20vpk\x20package','export','_packageImportService','packageComponentList','joinAllAttachments','map','FlosumConstants','attachmentLogId','Create\x20Backup','2013802XEsOWA','createBackup','Finish\x20Create\x20Backup','Flosum','\x20of\x20branch\x20to\x20Organization\x20','has','Component_Type__c','DEPLOYED','Logger','Component_History__c','saveDeploymentResults','Save\x20Deployment\x20Results','Activity_Item__c','_organisationName'];a334_0x13d6=function(){return _0x15e3a1;};return a334_0x13d6();}(function(_0x371ef0,_0x510d2f){const _0x5ed6f4=a334_0x5c5f,_0x17e9c5=_0x371ef0();while(!![]){try{const _0x62abf8=parseInt(_0x5ed6f4(0x14f))/0x1*(-parseInt(_0x5ed6f4(0x156))/0x2)+parseInt(_0x5ed6f4(0x1a3))/0x3*(-parseInt(_0x5ed6f4(0x1b2))/0x4)+-parseInt(_0x5ed6f4(0x164))/0x5+-parseInt(_0x5ed6f4(0x178))/0x6+parseInt(_0x5ed6f4(0x18d))/0x7+-parseInt(_0x5ed6f4(0x1b8))/0x8+parseInt(_0x5ed6f4(0x12c))/0x9;if(_0x62abf8===_0x510d2f)break;else _0x17e9c5['push'](_0x17e9c5['shift']());}catch(_0x2f7353){_0x17e9c5['push'](_0x17e9c5['shift']());}}}(a334_0x13d6,0xea3d4));const a334_0x346518=(function(){let _0x1f8246=!![];return function(_0x1e09fa,_0x5c6c22){const _0x1f232b=_0x1f8246?function(){const _0x50148b=a334_0x5c5f;if(_0x5c6c22){const _0x4b766b=_0x5c6c22[_0x50148b(0x16b)](_0x1e09fa,arguments);return _0x5c6c22=null,_0x4b766b;}}:function(){};return _0x1f8246=![],_0x1f232b;};}()),a334_0x2259f5=a334_0x346518(this,function(){const _0x1e96f3=a334_0x5c5f;return a334_0x2259f5[_0x1e96f3(0x1ab)]()[_0x1e96f3(0x138)](_0x1e96f3(0x141))['toString']()[_0x1e96f3(0x1c7)](a334_0x2259f5)[_0x1e96f3(0x138)](_0x1e96f3(0x141));});a334_0x2259f5();'use strict';var __importDefault=this&&this[a334_0x3c7c24(0x171)]||function(_0x5bd6bc){const _0x114f42=a334_0x3c7c24;return _0x5bd6bc&&_0x5bd6bc[_0x114f42(0x19e)]?_0x5bd6bc:{'default':_0x5bd6bc};};Object['defineProperty'](exports,a334_0x3c7c24(0x19e),{'value':!![]}),exports[a334_0x3c7c24(0x1c8)]=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a334_0x3c7c24(0x1c2)),constants_1=require('../../../constants'),flosum_constants_1=require(a334_0x3c7c24(0x13e)),veeva_service_1=require(a334_0x3c7c24(0x181)),salesforce_service_1=require('./salesforce.service'),core_1=require(a334_0x3c7c24(0x1c6)),status_enums_1=require(a334_0x3c7c24(0x19b)),salesforce_dml_error_1=require(a334_0x3c7c24(0x1ca)),shortid_1=__importDefault(require('shortid')),xml2js_1=require(a334_0x3c7c24(0x1d9)),fetch_attachments_1=require(a334_0x3c7c24(0x180)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a334_0x3c7c24(0x165)),flosum_component_veeva_component_retriever_1=require(a334_0x3c7c24(0x182)),package_export_service_1=require(a334_0x3c7c24(0x151)),vpk_service_1=require(a334_0x3c7c24(0x19d));function a334_0x5c5f(_0x5c36ca,_0x116226){const _0x72160b=a334_0x13d6();return a334_0x5c5f=function(_0x2259f5,_0x346518){_0x2259f5=_0x2259f5-0x12c;let _0x13d62d=_0x72160b[_0x2259f5];return _0x13d62d;},a334_0x5c5f(_0x5c36ca,_0x116226);}class DeployService{constructor(_0x4c6910,_0x15ca87,_0x4f7f97,_0x4f83e3,_0x510498,_0x592112){const _0x5f24d8=a334_0x3c7c24;this[_0x5f24d8(0x17a)]=_0x15ca87,this['_connectionVeeva']=_0x4f7f97,this['_logger']=_0x4f83e3,this[_0x5f24d8(0x162)]=_0x510498,this[_0x5f24d8(0x1ac)]=_0x592112,this['_branchId']=_0x4c6910[_0x5f24d8(0x13a)],this['_metadataLogId']=_0x4c6910['metadataLogId'],this[_0x5f24d8(0x13f)]=_0x4c6910[_0x5f24d8(0x18b)],this[_0x5f24d8(0x146)]=_0x4c6910[_0x5f24d8(0x166)],this[_0x5f24d8(0x160)]=_0x4c6910[_0x5f24d8(0x179)],this['_organisationName']=_0x4c6910[_0x5f24d8(0x136)],this[_0x5f24d8(0x19c)]=_0x4c6910['componentIdList'],this['_deploymentName']=_0x4c6910[_0x5f24d8(0x1a8)],this[_0x5f24d8(0x1bb)]=new core_1[(_0x5f24d8(0x195))](_0x5f24d8(0x147)),this[_0x5f24d8(0x155)]=new veeva_service_1[(_0x5f24d8(0x175))]({'connection':this[_0x5f24d8(0x14a)],'logger':this[_0x5f24d8(0x137)]}),this[_0x5f24d8(0x1a7)]=new salesforce_service_1[(_0x5f24d8(0x1d0))]({'connection':this[_0x5f24d8(0x17a)]}),this[_0x5f24d8(0x186)]=new package_import_service_1[(_0x5f24d8(0x15e))]({'veevaService':this[_0x5f24d8(0x155)],'connection':this[_0x5f24d8(0x14a)],'logger':this[_0x5f24d8(0x137)],'saveLog':this[_0x5f24d8(0x134)]['bind'](this)}),this[_0x5f24d8(0x132)]=new package_export_service_1[(_0x5f24d8(0x139))]({'veevaService':this['_veevaService'],'connection':this[_0x5f24d8(0x14a)],'logger':this[_0x5f24d8(0x137)]}),this[_0x5f24d8(0x15a)]=new vpk_service_1['VpkService']({'connection':this[_0x5f24d8(0x14a)]});}async['execute'](){const _0x36138e=a334_0x3c7c24;try{const _0x3bff9c=await this[_0x36138e(0x1cb)]();await this['_logger'][_0x36138e(0x1ae)](),await this[_0x36138e(0x18e)](_0x3bff9c);const _0x22ca35=await this[_0x36138e(0x14b)](_0x3bff9c),_0xede525=await this[_0x36138e(0x188)](_0x22ca35),_0x8d2dca=await this[_0x36138e(0x1be)](_0xede525);await this[_0x36138e(0x137)][_0x36138e(0x1ae)]();const _0x5f306b=await this[_0x36138e(0x186)]['import'](_0x8d2dca);await this[_0x36138e(0x137)]['updateLog']();const _0x5bbe1f=this['formFlosumDeploymentResults'](_0x3bff9c,_0x5f306b[_0x36138e(0x187)]);await this[_0x36138e(0x197)](_0x5bbe1f),await this['finishDeploy'](_0x5f306b['isDeployed'],![],_0x5f306b[_0x36138e(0x17d)]);}catch(_0x325b0a){await this[_0x36138e(0x1a5)](_0x325b0a)[_0x36138e(0x1ce)](_0x5b913a=>this['_systemLogger'][_0x36138e(0x13b)](_0x5b913a));}}async[a334_0x3c7c24(0x1cb)](){const _0x38b2c4=a334_0x3c7c24,_0x5e46ba=new Set(this['_componentIdList']);this[_0x38b2c4(0x137)][_0x38b2c4(0x149)]('Retrieving\x20components');const _0xfb5cd7=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x38b2c4(0x1d1)],'salesforceService':this[_0x38b2c4(0x1a7)]})[_0x38b2c4(0x16d)](),_0x2166d3=_0xfb5cd7[_0x38b2c4(0x1bd)](_0x19e514=>_0x5e46ba[_0x38b2c4(0x192)](_0x19e514['id']));if(_0x2166d3[_0x38b2c4(0x1d6)]!==this[_0x38b2c4(0x19c)]['length'])throw new Error(_0x38b2c4(0x154));return _0x2166d3;}async[a334_0x3c7c24(0x18e)](_0x2cc292){const _0x39ce39=a334_0x3c7c24;var _0x5258c7;this['_logger']['log'](_0x39ce39(0x18c));const _0x1e9dea=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x2cc292,'veevaService':this['_veevaService'],'logger':this[_0x39ce39(0x137)]})[_0x39ce39(0x16d)](),_0x580567=await this[_0x39ce39(0x132)][_0x39ce39(0x185)](_0x1e9dea,'Backup');if(_0x580567[_0x39ce39(0x1d6)]>0x1)throw new Error(_0x39ce39(0x152));(_0x5258c7=_0x580567[0x0])!==null&&_0x5258c7!==void 0x0?_0x5258c7:_0x580567[0x0]=new jszip_1[(_0x39ce39(0x1b1))]();const _0x3b9759=await _0x580567[0x0][_0x39ce39(0x14d)]({'type':_0x39ce39(0x15f)});this[_0x39ce39(0x137)][_0x39ce39(0x149)](_0x39ce39(0x167));const _0x2ab029={'Body':_0x3b9759,'ContentType':_0x39ce39(0x1bc),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x39ce39(0x18a)][_0x39ce39(0x183)]};await this[_0x39ce39(0x17a)][_0x39ce39(0x12e)](flosum_constants_1[_0x39ce39(0x18a)][_0x39ce39(0x145)]+_0x39ce39(0x131),_0x2ab029),this['_logger'][_0x39ce39(0x149)](_0x39ce39(0x18f));}async[a334_0x3c7c24(0x14b)](_0x56b463){const _0x911198=a334_0x3c7c24;this[_0x911198(0x137)][_0x911198(0x149)](_0x911198(0x163));const _0x2a8bf0=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x911198(0x17a)],_0x56b463[_0x911198(0x189)](_0x35d2fe=>_0x35d2fe[_0x911198(0x144)])),_0x52fa2c=await(0x0,fetch_attachments_1[_0x911198(0x14b)])(_0x2a8bf0,this[_0x911198(0x17a)]);if(_0x52fa2c[_0x911198(0x1d6)]!==this[_0x911198(0x19c)][_0x911198(0x1d6)])throw new Error(_0x911198(0x16a));return _0x52fa2c[_0x911198(0x189)](_0x2558f2=>_0x2558f2[_0x911198(0x1a9)][_0x911198(0x17c)]);}async[a334_0x3c7c24(0x188)](_0x17855e){const _0x445781=a334_0x3c7c24;var _0x59c06f;this[_0x445781(0x137)][_0x445781(0x149)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x4a729e=new jszip_1[(_0x445781(0x1b1))]();for(const _0x395b40 of _0x17855e){const _0x1d0b9d=new jszip_1[(_0x445781(0x1b1))]();await _0x1d0b9d['loadAsync'](_0x395b40,{'base64':!![]});for(const _0x4031c8 in _0x1d0b9d[_0x445781(0x17e)]){const _0x1a8b6d=await((_0x59c06f=_0x1d0b9d[_0x445781(0x135)](_0x4031c8))===null||_0x59c06f===void 0x0?void 0x0:_0x59c06f[_0x445781(0x1c0)](_0x445781(0x169)));_0x1a8b6d&&_0x4a729e[_0x445781(0x135)](_0x4031c8,_0x1a8b6d);}}const _0x565d6e=new xml2js_1[(_0x445781(0x1a0))]({'headless':!![]}),_0x10d1fe={'vaultpackage':{'$':{'xmlns':_0x445781(0x168)},'name':this[_0x445781(0x1c1)],'source':{'vault':undefined,'author':_0x445781(0x190)},'packagetype':_0x445781(0x158),'summary':_0x445781(0x12f),'description':'null'}};_0x4a729e[_0x445781(0x135)](_0x445781(0x13d),_0x565d6e[_0x445781(0x1b6)](_0x10d1fe));const _0x3cb7ba=this[_0x445781(0x162)]+'/'+(0x0,shortid_1[_0x445781(0x1b1)])()+_0x445781(0x1d5),_0x4f9b43=await _0x4a729e[_0x445781(0x14d)]({'type':_0x445781(0x1a4)});return await(0x0,promises_1[_0x445781(0x170)])(_0x3cb7ba,_0x4f9b43),_0x3cb7ba;}async[a334_0x3c7c24(0x1be)](_0x5dbddf){const _0x5c6888=a334_0x3c7c24;this[_0x5c6888(0x137)][_0x5c6888(0x149)](_0x5c6888(0x184));const _0x369a54=await this[_0x5c6888(0x15a)]['generate'](_0x5dbddf),_0x51a2bd=this[_0x5c6888(0x162)]+'/vpk__'+_0x5dbddf[_0x5c6888(0x1aa)](_0x5dbddf[_0x5c6888(0x177)]('/')+0x1);return await(0x0,promises_1[_0x5c6888(0x170)])(_0x51a2bd,_0x369a54),await this[_0x5c6888(0x15a)]['validate'](_0x51a2bd),_0x51a2bd;}async['saveLog'](_0x58fd47,_0x5cb30e){const _0xf4ca9a=a334_0x3c7c24;this['_logger'][_0xf4ca9a(0x149)](_0xf4ca9a(0x1d4));const _0x4bf9da={'Body':Buffer[_0xf4ca9a(0x1a1)](_0x58fd47)[_0xf4ca9a(0x1ab)](_0xf4ca9a(0x15f)),'ContentType':_0xf4ca9a(0x1cf),'ParentId':this[_0xf4ca9a(0x1a6)],'Name':_0x5cb30e};await this[_0xf4ca9a(0x17a)][_0xf4ca9a(0x12e)](flosum_constants_1['FlosumConstants'][_0xf4ca9a(0x145)]+_0xf4ca9a(0x131),_0x4bf9da);}[a334_0x3c7c24(0x19f)](_0x43e060,_0xc75425){const _0x25836e=a334_0x3c7c24;this[_0x25836e(0x137)]['log']('Form\x20Deployment\x20Results');const _0x52205a=_0x43e060['reduce']((_0x239dc9,_0x50fbfc)=>_0x239dc9['set']((_0x50fbfc[_0x25836e(0x1ba)]+'.'+_0x50fbfc[_0x25836e(0x153)])['toLowerCase'](),_0x50fbfc),new Map());return _0xc75425['map'](_0x699208=>{const _0x255970=_0x25836e;this[_0x255970(0x137)][_0x255970(0x149)](_0x699208[_0x255970(0x16f)]+'.'+_0x699208[_0x255970(0x1af)]+_0x255970(0x15b)+_0x699208[_0x255970(0x1cd)]);const _0x4286d1=(_0x699208['type']+'.'+_0x699208[_0x255970(0x1af)])[_0x255970(0x1d3)](),_0x1587e7=_0x52205a[_0x255970(0x1b3)](_0x4286d1);return{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:_0x255970(0x148),[constants_1[_0x255970(0x161)]+_0x255970(0x176)]:_0x699208['status']===status_enums_1[_0x255970(0x13c)][_0x255970(0x194)]?_0x255970(0x1cc):_0x255970(0x1b7),[constants_1[_0x255970(0x161)]+_0x255970(0x1b9)]:_0x699208['deploymentAction'],[constants_1[_0x255970(0x161)]+_0x255970(0x159)]:_0x699208[_0x255970(0x1af)],[constants_1[_0x255970(0x161)]+_0x255970(0x193)]:_0x699208[_0x255970(0x16f)],[constants_1[_0x255970(0x161)]+_0x255970(0x172)]:_0x699208[_0x255970(0x1c4)],[constants_1['FLOSUM_NAMESPACE']+_0x255970(0x17b)]:this[_0x255970(0x146)],[constants_1['FLOSUM_NAMESPACE']+_0x255970(0x16e)]:this['_metadataLogId'],[constants_1[_0x255970(0x161)]+_0x255970(0x196)]:_0x1587e7[_0x255970(0x144)]};});}async[a334_0x3c7c24(0x197)](_0x4de494){const _0x24244e=a334_0x3c7c24;this[_0x24244e(0x137)][_0x24244e(0x149)](_0x24244e(0x198));const _0x5dca67=await this['_salesforceService'][_0x24244e(0x157)](constants_1[_0x24244e(0x161)]+_0x24244e(0x16c),_0x4de494),_0x2d22d5=_0x5dca67[_0x24244e(0x1bd)](_0xe23731=>!_0xe23731[_0x24244e(0x15d)])[_0x24244e(0x189)](_0x21d25c=>_0x21d25c[_0x24244e(0x15c)])[_0x24244e(0x1b0)]();if(_0x2d22d5[_0x24244e(0x1d6)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x2d22d5);}async[a334_0x3c7c24(0x1a5)](_0x537d7d){const _0x38153f=a334_0x3c7c24;this['_logger'][_0x38153f(0x1a2)](_0x537d7d),await this[_0x38153f(0x137)][_0x38153f(0x1ae)](),await this[_0x38153f(0x1bf)](![],!![],'');}async[a334_0x3c7c24(0x1bf)](_0x1016b7,_0xcc8f2d,_0x4c7d5f){const _0x2cfb1c=a334_0x3c7c24,_0x40efd1='<a\x20href='+this[_0x2cfb1c(0x1ac)]+'/'+this['_metadataLogId']+_0x2cfb1c(0x133)+_0x2cfb1c(0x173)+'\x20</a>',_0x122fe9=_0x2cfb1c(0x1c3)+this[_0x2cfb1c(0x1ac)]+'/'+this['_organisationId']+'\x20>'+this[_0x2cfb1c(0x19a)]+_0x2cfb1c(0x1b4),_0x361553=_0x40efd1+_0x2cfb1c(0x191)+_0x122fe9+_0x2cfb1c(0x1d2),_0x2aba83={[constants_1[_0x2cfb1c(0x161)]+_0x2cfb1c(0x1ad)]:_0x361553,[constants_1['FLOSUM_NAMESPACE']+_0x2cfb1c(0x1d8)]:new Date(),[constants_1[_0x2cfb1c(0x161)]+_0x2cfb1c(0x1c5)]:this[_0x2cfb1c(0x1d1)],[constants_1['FLOSUM_NAMESPACE']+_0x2cfb1c(0x199)]:_0x2cfb1c(0x1c9),[constants_1[_0x2cfb1c(0x161)]+'Activity_Type__c']:'Deployment',[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:this['_organisationId']},_0xfe79fd={[constants_1[_0x2cfb1c(0x161)]+_0x2cfb1c(0x14c)]:!_0x1016b7,[constants_1['FLOSUM_NAMESPACE']+_0x2cfb1c(0x143)]:_0x1016b7,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0xcc8f2d?status_enums_1[_0x2cfb1c(0x142)][_0x2cfb1c(0x174)]:status_enums_1[_0x2cfb1c(0x142)][_0x2cfb1c(0x17f)],[constants_1[_0x2cfb1c(0x161)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x2cfb1c(0x14e)]:_0x4c7d5f};await this[_0x2cfb1c(0x17a)][_0x2cfb1c(0x1d7)](flosum_constants_1[_0x2cfb1c(0x18a)][_0x2cfb1c(0x145)]+'/'+constants_1[_0x2cfb1c(0x161)]+_0x2cfb1c(0x130)+this['_metadataLogId'],_0xfe79fd),await this[_0x2cfb1c(0x17a)][_0x2cfb1c(0x12e)](flosum_constants_1[_0x2cfb1c(0x18a)][_0x2cfb1c(0x145)]+'/'+constants_1[_0x2cfb1c(0x161)]+_0x2cfb1c(0x12d),_0x2aba83),this[_0x2cfb1c(0x137)][_0x2cfb1c(0x149)](_0x2cfb1c(0x1b5)+(_0x1016b7?_0x2cfb1c(0x150):_0x2cfb1c(0x140))+'.'),await this[_0x2cfb1c(0x137)]['updateLog']();}}exports['DeployService']=DeployService;