const a334_0x3a1b90=a334_0x201c;(function(_0x1ca31a,_0x276d6a){const _0x864532=a334_0x201c,_0x22507f=_0x1ca31a();while(!![]){try{const _0x5e8d36=-parseInt(_0x864532(0x1e4))/0x1*(-parseInt(_0x864532(0x1d6))/0x2)+parseInt(_0x864532(0x218))/0x3*(-parseInt(_0x864532(0x189))/0x4)+-parseInt(_0x864532(0x173))/0x5+-parseInt(_0x864532(0x1a8))/0x6+-parseInt(_0x864532(0x21f))/0x7+parseInt(_0x864532(0x1a4))/0x8*(-parseInt(_0x864532(0x1ff))/0x9)+-parseInt(_0x864532(0x180))/0xa*(-parseInt(_0x864532(0x1ab))/0xb);if(_0x5e8d36===_0x276d6a)break;else _0x22507f['push'](_0x22507f['shift']());}catch(_0x106086){_0x22507f['push'](_0x22507f['shift']());}}}(a334_0x2523,0xa56de));function a334_0x2523(){const _0x5d848c=['Is_Error__c','string','finishDeployWithError','finishDeploy','organisationId','_systemLogger','packageId','Veeva_Step_Name__c','_salesforceService','Retrieving\x20components','Cannot\x20retrieve\x20all\x20components.','</a>','FlosumComponentVeevaComponentRetriever','./veeva.service','./package-import.service','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Join\x20all\x20mdl\x20into\x20one\x20zip','_connectionVeeva','componentIdList','migration__v','has','_metadataLogId','Action__c','FlosumConstants','292916NhsHUr','map','Activity_Item__c','toString','branchId','execute','./package-export.service','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','<a\x20href=','_deploymentName','__importDefault','lastIndexOf','saveLog','length','6HPhTHG','_logger','values','componentName','Component_Type__c','Success','set','../../../core','Async_Request_Id__c','Save\x20Deployment\x20Results','type','text/plain','attachmentLogId','patch','ENDPOINT_UPSERT_RECORD','file','PackageExportService','COMPLETED','validate','SalesforceService','null','(((.+)+)+)+$','Component_Name__c','insertMultipleRecords','generateAsync','timeZone','Succeed__c','5900022ijiqzI','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','VpkService','Failure','async','metadataLogId','toLowerCase','application/zip','fetchAttachmentsDetailsByParentId','bind','errors','Activity_Type__c','filter','nodebuffer','retrieveAttachments','createVpk','PackageImportService','packageComponentList','Status__c','deploymentName','reduce','_componentIdList','Metadata_Log__c','_instanceUrl','name','9PcXzZE','saveDeploymentResults','xml2js','jszip','updateLog','TargetId__c','_organisationName','4791948sgAQlr','Flosum','_vpkService','error','Retrieving\x20attachments','fs/promises','createBackup','PackageComponentStatus','post','6483635HiSdhp','Save\x20log','Deployment_Result__c','../classes/errors/salesforce-dml-error','status','/vpk__','Save\x20Backup\x20to\x20Salesforce','vaultpackage.xml','_veevaService','_connectionSalesforce','getFlosumComponents','shortid','Deployment','10fEAtEC','./vpk.service','apply','BACKUP_ZIP_NAME','../constants/flosum.constants','search','Logger','formFlosumDeploymentResults','base64','874444LIimbW','deploymentAction','EXCEPTION','joinAllAttachments','BranchComponentHistoryFlosumComponentRetriever','DEPLOYED','default','slice','buildObject','Body','../../shared/utils/fetch-attachments','Deploy','.zip','Branch','VeevaService','successfully','https://veevavault.com/','with\x20error','_organisationId','Builder','\x20has\x20been\x20created.','__esModule','FLOSUM_NAMESPACE','Metadata_Log__c/','/Attachment','Create\x20vpk\x20package','Log__c','8WdPdFe','catch','Branch__c','writeFile','2625786LqnIkj','MetadataLogStatus','Veeva\x20Deployment','38820793sijxql','import','Deployment\x20Result','Backup','_packageExportService','DeployService','files','_packageImportService','Type__c','constructor','_tempFolder','componentHistoryId','get','Result__c','log','Deploy\x20completed\x20','success','_branchId','\x20</a>'];a334_0x2523=function(){return _0x5d848c;};return a334_0x2523();}const a334_0x512a1a=(function(){let _0x41eb55=!![];return function(_0x11c732,_0x2b5193){const _0x55cfe7=_0x41eb55?function(){const _0x3673ad=a334_0x201c;if(_0x2b5193){const _0x3566b9=_0x2b5193[_0x3673ad(0x182)](_0x11c732,arguments);return _0x2b5193=null,_0x3566b9;}}:function(){};return _0x41eb55=![],_0x55cfe7;};}()),a334_0x1c3fc9=a334_0x512a1a(this,function(){const _0x51664b=a334_0x201c;return a334_0x1c3fc9['toString']()[_0x51664b(0x185)](_0x51664b(0x1f9))[_0x51664b(0x1d9)]()[_0x51664b(0x1b4)](a334_0x1c3fc9)['search'](_0x51664b(0x1f9));});a334_0x1c3fc9();'use strict';var __importDefault=this&&this[a334_0x3a1b90(0x1e0)]||function(_0x1237e7){const _0x534e30=a334_0x3a1b90;return _0x1237e7&&_0x1237e7[_0x534e30(0x19e)]?_0x1237e7:{'default':_0x1237e7};};function a334_0x201c(_0x5d57b1,_0x51db0c){const _0x5ed58e=a334_0x2523();return a334_0x201c=function(_0x1c3fc9,_0x512a1a){_0x1c3fc9=_0x1c3fc9-0x173;let _0x2523ae=_0x5ed58e[_0x1c3fc9];return _0x2523ae;},a334_0x201c(_0x5d57b1,_0x51db0c);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a334_0x3a1b90(0x1b0)]=void 0x0;const jszip_1=__importDefault(require(a334_0x3a1b90(0x21b))),promises_1=require(a334_0x3a1b90(0x224)),constants_1=require('../../../constants'),flosum_constants_1=require(a334_0x3a1b90(0x184)),veeva_service_1=require(a334_0x3a1b90(0x1cb)),salesforce_service_1=require('./salesforce.service'),core_1=require(a334_0x3a1b90(0x1eb)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a334_0x3a1b90(0x176)),shortid_1=__importDefault(require(a334_0x3a1b90(0x17e))),xml2js_1=require(a334_0x3a1b90(0x21a)),fetch_attachments_1=require(a334_0x3a1b90(0x193)),package_import_service_1=require(a334_0x3a1b90(0x1cc)),branch_component_history_flosum_component_retriever_1=require(a334_0x3a1b90(0x200)),flosum_component_veeva_component_retriever_1=require(a334_0x3a1b90(0x1dd)),package_export_service_1=require(a334_0x3a1b90(0x1dc)),vpk_service_1=require(a334_0x3a1b90(0x181));class DeployService{constructor(_0x4b328e,_0x168112,_0x1601cd,_0x45ba83,_0x33c92f,_0xbbe989){const _0x2585c2=a334_0x3a1b90;this['_connectionSalesforce']=_0x168112,this['_connectionVeeva']=_0x1601cd,this['_logger']=_0x45ba83,this[_0x2585c2(0x1b5)]=_0x33c92f,this[_0x2585c2(0x216)]=_0xbbe989,this[_0x2585c2(0x1bc)]=_0x4b328e[_0x2585c2(0x1da)],this[_0x2585c2(0x1d3)]=_0x4b328e[_0x2585c2(0x204)],this['_attachmentLogId']=_0x4b328e[_0x2585c2(0x1f0)],this['_organisationId']=_0x4b328e[_0x2585c2(0x1c2)],this['_timeZone']=_0x4b328e[_0x2585c2(0x1fd)],this['_organisationName']=_0x4b328e['organisationName'],this[_0x2585c2(0x214)]=_0x4b328e[_0x2585c2(0x1d0)],this[_0x2585c2(0x1df)]=_0x4b328e[_0x2585c2(0x212)],this[_0x2585c2(0x1c3)]=new core_1[(_0x2585c2(0x186))]('veeva-deploy'),this[_0x2585c2(0x17b)]=new veeva_service_1[(_0x2585c2(0x197))]({'connection':this[_0x2585c2(0x1cf)],'logger':this[_0x2585c2(0x1e5)]}),this[_0x2585c2(0x1c6)]=new salesforce_service_1[(_0x2585c2(0x1f7))]({'connection':this[_0x2585c2(0x17c)]}),this['_packageImportService']=new package_import_service_1[(_0x2585c2(0x20f))]({'veevaService':this['_veevaService'],'connection':this[_0x2585c2(0x1cf)],'logger':this[_0x2585c2(0x1e5)],'saveLog':this[_0x2585c2(0x1e2)][_0x2585c2(0x208)](this)}),this['_packageExportService']=new package_export_service_1[(_0x2585c2(0x1f4))]({'veevaService':this[_0x2585c2(0x17b)],'connection':this[_0x2585c2(0x1cf)],'logger':this[_0x2585c2(0x1e5)]}),this[_0x2585c2(0x221)]=new vpk_service_1[(_0x2585c2(0x201))]({'connection':this['_connectionVeeva']});}async[a334_0x3a1b90(0x1db)](){const _0xaf3296=a334_0x3a1b90;try{const _0x2a264b=await this[_0xaf3296(0x17d)]();await this['_logger']['updateLog'](),await this[_0xaf3296(0x225)](_0x2a264b);const _0x454d2c=await this[_0xaf3296(0x20d)](_0x2a264b),_0x50a470=await this[_0xaf3296(0x18c)](_0x454d2c),_0x25e1e0=await this[_0xaf3296(0x20e)](_0x50a470);await this[_0xaf3296(0x1e5)][_0xaf3296(0x21c)]();const _0x43979e=await this[_0xaf3296(0x1b2)][_0xaf3296(0x1ac)](_0x25e1e0);await this[_0xaf3296(0x1e5)][_0xaf3296(0x21c)]();const _0x5c0919=this[_0xaf3296(0x187)](_0x2a264b,_0x43979e[_0xaf3296(0x210)]);await this['saveDeploymentResults'](_0x5c0919),await this['finishDeploy'](_0x43979e['isDeployed'],![],_0x43979e[_0xaf3296(0x1c4)]);}catch(_0x4362eb){await this['finishDeployWithError'](_0x4362eb)[_0xaf3296(0x1a5)](_0x506e6c=>this['_systemLogger'][_0xaf3296(0x222)](_0x506e6c));}}async[a334_0x3a1b90(0x17d)](){const _0x5638eb=a334_0x3a1b90,_0x4029ad=new Set(this['_componentIdList']);this[_0x5638eb(0x1e5)][_0x5638eb(0x1b9)](_0x5638eb(0x1c7));const _0x524ff3=await new branch_component_history_flosum_component_retriever_1[(_0x5638eb(0x18d))]({'value':this[_0x5638eb(0x1bc)],'salesforceService':this[_0x5638eb(0x1c6)]})['retrieve'](),_0x3a2a19=_0x524ff3[_0x5638eb(0x20b)](_0x15d58b=>_0x4029ad[_0x5638eb(0x1d2)](_0x15d58b['id']));if(_0x3a2a19[_0x5638eb(0x1e3)]!==this[_0x5638eb(0x214)][_0x5638eb(0x1e3)])throw new Error(_0x5638eb(0x1c8));return _0x3a2a19;}async[a334_0x3a1b90(0x225)](_0x504645){const _0x33d767=a334_0x3a1b90;var _0x13c9be;this[_0x33d767(0x1e5)][_0x33d767(0x1b9)]('Create\x20Backup');const _0x3c242d=await new flosum_component_veeva_component_retriever_1[(_0x33d767(0x1ca))]({'value':_0x504645,'veevaService':this[_0x33d767(0x17b)],'logger':this[_0x33d767(0x1e5)]})['retrieve'](),_0x2c1363=await this[_0x33d767(0x1af)]['export'](_0x3c242d,_0x33d767(0x1ae));if(_0x2c1363['length']>0x1)throw new Error(_0x33d767(0x1cd));(_0x13c9be=_0x2c1363[0x0])!==null&&_0x13c9be!==void 0x0?_0x13c9be:_0x2c1363[0x0]=new jszip_1['default']();const _0x45d3ba=await _0x2c1363[0x0]['generateAsync']({'type':_0x33d767(0x188)});this[_0x33d767(0x1e5)][_0x33d767(0x1b9)](_0x33d767(0x179));const _0x2c76df={'Body':_0x45d3ba,'ContentType':_0x33d767(0x206),'ParentId':this[_0x33d767(0x1d3)],'Name':flosum_constants_1['FlosumConstants'][_0x33d767(0x183)]};await this[_0x33d767(0x17c)][_0x33d767(0x227)](flosum_constants_1[_0x33d767(0x1d5)][_0x33d767(0x1f2)]+_0x33d767(0x1a1),_0x2c76df),this[_0x33d767(0x1e5)][_0x33d767(0x1b9)]('Finish\x20Create\x20Backup');}async[a334_0x3a1b90(0x20d)](_0x176683){const _0x191bfd=a334_0x3a1b90;this[_0x191bfd(0x1e5)][_0x191bfd(0x1b9)](_0x191bfd(0x223));const _0x1675b3=await(0x0,fetch_attachments_1[_0x191bfd(0x207)])(this['_connectionSalesforce'],_0x176683[_0x191bfd(0x1d7)](_0x36ef89=>_0x36ef89['componentHistoryId'])),_0x4cc435=await(0x0,fetch_attachments_1[_0x191bfd(0x20d)])(_0x1675b3,this[_0x191bfd(0x17c)]);if(_0x4cc435[_0x191bfd(0x1e3)]!==this[_0x191bfd(0x214)][_0x191bfd(0x1e3)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x4cc435[_0x191bfd(0x1d7)](_0x435079=>_0x435079[_0x191bfd(0x1e6)][_0x191bfd(0x192)]);}async[a334_0x3a1b90(0x18c)](_0x245305){const _0x17b0ee=a334_0x3a1b90;var _0x5d581f;this[_0x17b0ee(0x1e5)][_0x17b0ee(0x1b9)](_0x17b0ee(0x1ce));const _0x367448=new jszip_1[(_0x17b0ee(0x18f))]();for(const _0x2e09cd of _0x245305){const _0x62245d=new jszip_1[(_0x17b0ee(0x18f))]();await _0x62245d['loadAsync'](_0x2e09cd,{'base64':!![]});for(const _0x3de9e4 in _0x62245d[_0x17b0ee(0x1b1)]){const _0x48a913=await((_0x5d581f=_0x62245d[_0x17b0ee(0x1f3)](_0x3de9e4))===null||_0x5d581f===void 0x0?void 0x0:_0x5d581f[_0x17b0ee(0x203)](_0x17b0ee(0x1bf)));_0x48a913&&_0x367448[_0x17b0ee(0x1f3)](_0x3de9e4,_0x48a913);}}const _0x5de72a=new xml2js_1[(_0x17b0ee(0x19c))]({'headless':!![]}),_0xb7bd2d={'vaultpackage':{'$':{'xmlns':_0x17b0ee(0x199)},'name':this[_0x17b0ee(0x1df)],'source':{'vault':undefined,'author':_0x17b0ee(0x220)},'packagetype':_0x17b0ee(0x1d1),'summary':_0x17b0ee(0x194),'description':_0x17b0ee(0x1f8)}};_0x367448[_0x17b0ee(0x1f3)](_0x17b0ee(0x17a),_0x5de72a[_0x17b0ee(0x191)](_0xb7bd2d));const _0x306046=this[_0x17b0ee(0x1b5)]+'/'+(0x0,shortid_1[_0x17b0ee(0x18f)])()+_0x17b0ee(0x195),_0x183186=await _0x367448[_0x17b0ee(0x1fc)]({'type':_0x17b0ee(0x20c)});return await(0x0,promises_1[_0x17b0ee(0x1a7)])(_0x306046,_0x183186),_0x306046;}async[a334_0x3a1b90(0x20e)](_0x3c1d5e){const _0x19b7a1=a334_0x3a1b90;this['_logger']['log'](_0x19b7a1(0x1a2));const _0x1e3349=await this[_0x19b7a1(0x221)]['generate'](_0x3c1d5e),_0x5115ec=this[_0x19b7a1(0x1b5)]+_0x19b7a1(0x178)+_0x3c1d5e[_0x19b7a1(0x190)](_0x3c1d5e[_0x19b7a1(0x1e1)]('/')+0x1);return await(0x0,promises_1[_0x19b7a1(0x1a7)])(_0x5115ec,_0x1e3349),await this[_0x19b7a1(0x221)][_0x19b7a1(0x1f6)](_0x5115ec),_0x5115ec;}async[a334_0x3a1b90(0x1e2)](_0x1e64ec,_0x3edb70){const _0x13b134=a334_0x3a1b90;this[_0x13b134(0x1e5)][_0x13b134(0x1b9)](_0x13b134(0x174));const _0x31647f={'Body':Buffer['from'](_0x1e64ec)[_0x13b134(0x1d9)](_0x13b134(0x188)),'ContentType':_0x13b134(0x1ef),'ParentId':this[_0x13b134(0x1d3)],'Name':_0x3edb70};await this['_connectionSalesforce'][_0x13b134(0x227)](flosum_constants_1[_0x13b134(0x1d5)][_0x13b134(0x1f2)]+_0x13b134(0x1a1),_0x31647f);}['formFlosumDeploymentResults'](_0x1969d5,_0x20b341){const _0x3a9e58=a334_0x3a1b90;this[_0x3a9e58(0x1e5)][_0x3a9e58(0x1b9)]('Form\x20Deployment\x20Results');const _0x464dc3=_0x1969d5[_0x3a9e58(0x213)]((_0x2a5651,_0x33d6b8)=>_0x2a5651[_0x3a9e58(0x1ea)]((_0x33d6b8['componentType']+'.'+_0x33d6b8[_0x3a9e58(0x1e7)])['toLowerCase'](),_0x33d6b8),new Map());return _0x20b341[_0x3a9e58(0x1d7)](_0xa942a9=>{const _0x31c5c2=_0x3a9e58;this['_logger'][_0x31c5c2(0x1b9)](_0xa942a9[_0x31c5c2(0x1ee)]+'.'+_0xa942a9['name']+'\x20:\x20'+_0xa942a9[_0x31c5c2(0x177)]);const _0xf77304=(_0xa942a9[_0x31c5c2(0x1ee)]+'.'+_0xa942a9[_0x31c5c2(0x217)])[_0x31c5c2(0x205)](),_0x917af9=_0x464dc3[_0x31c5c2(0x1b7)](_0xf77304);return{[constants_1[_0x31c5c2(0x19f)]+_0x31c5c2(0x1b3)]:_0x31c5c2(0x1ad),[constants_1[_0x31c5c2(0x19f)]+_0x31c5c2(0x211)]:_0xa942a9['status']===status_enums_1[_0x31c5c2(0x226)][_0x31c5c2(0x18e)]?_0x31c5c2(0x1e9):_0x31c5c2(0x202),[constants_1[_0x31c5c2(0x19f)]+_0x31c5c2(0x1b8)]:_0xa942a9[_0x31c5c2(0x18a)],[constants_1[_0x31c5c2(0x19f)]+_0x31c5c2(0x1fa)]:_0xa942a9['name'],[constants_1[_0x31c5c2(0x19f)]+_0x31c5c2(0x1e8)]:_0xa942a9[_0x31c5c2(0x1ee)],[constants_1[_0x31c5c2(0x19f)]+_0x31c5c2(0x1c5)]:_0xa942a9['stepName'],[constants_1[_0x31c5c2(0x19f)]+'Org__c']:this[_0x31c5c2(0x19b)],[constants_1[_0x31c5c2(0x19f)]+_0x31c5c2(0x215)]:this[_0x31c5c2(0x1d3)],[constants_1[_0x31c5c2(0x19f)]+'Component_History__c']:_0x917af9[_0x31c5c2(0x1b6)]};});}async[a334_0x3a1b90(0x219)](_0x469b02){const _0x22b43b=a334_0x3a1b90;this[_0x22b43b(0x1e5)]['log'](_0x22b43b(0x1ed));const _0x4201ef=await this[_0x22b43b(0x1c6)][_0x22b43b(0x1fb)](constants_1[_0x22b43b(0x19f)]+_0x22b43b(0x175),_0x469b02),_0x18539b=_0x4201ef[_0x22b43b(0x20b)](_0x548227=>!_0x548227[_0x22b43b(0x1bb)])[_0x22b43b(0x1d7)](_0x1a2b3f=>_0x1a2b3f[_0x22b43b(0x209)])['flat']();if(_0x18539b['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x18539b);}async[a334_0x3a1b90(0x1c0)](_0x34574e){const _0x54f5a5=a334_0x3a1b90;this['_logger']['logError'](_0x34574e),await this[_0x54f5a5(0x1e5)]['updateLog'](),await this['finishDeploy'](![],!![],'');}async[a334_0x3a1b90(0x1c1)](_0x41845d,_0x4ead6d,_0x208b63){const _0x1b552a=a334_0x3a1b90,_0x3fe4fd=_0x1b552a(0x1de)+this['_instanceUrl']+'/'+this[_0x1b552a(0x1d3)]+'\x20>\x20'+_0x1b552a(0x1aa)+_0x1b552a(0x1bd),_0x57019f=_0x1b552a(0x1de)+this['_instanceUrl']+'/'+this['_organisationId']+'\x20>'+this[_0x1b552a(0x21e)]+_0x1b552a(0x1c9),_0xf8f152=_0x3fe4fd+'\x20of\x20branch\x20to\x20Organization\x20'+_0x57019f+_0x1b552a(0x19d),_0xc30bc6={[constants_1['FLOSUM_NAMESPACE']+_0x1b552a(0x1d4)]:_0xf8f152,[constants_1[_0x1b552a(0x19f)]+'Date__c']:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x1b552a(0x1a6)]:this[_0x1b552a(0x1bc)],[constants_1[_0x1b552a(0x19f)]+_0x1b552a(0x1d8)]:_0x1b552a(0x196),[constants_1[_0x1b552a(0x19f)]+_0x1b552a(0x20a)]:_0x1b552a(0x17f),[constants_1['FLOSUM_NAMESPACE']+_0x1b552a(0x21d)]:this[_0x1b552a(0x19b)]},_0x2efca0={[constants_1[_0x1b552a(0x19f)]+_0x1b552a(0x1be)]:!_0x41845d,[constants_1['FLOSUM_NAMESPACE']+_0x1b552a(0x1fe)]:_0x41845d,[constants_1[_0x1b552a(0x19f)]+'Status__c']:_0x4ead6d?status_enums_1[_0x1b552a(0x1a9)][_0x1b552a(0x18b)]:status_enums_1[_0x1b552a(0x1a9)][_0x1b552a(0x1f5)],[constants_1[_0x1b552a(0x19f)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x1b552a(0x1ec)]:_0x208b63};await this['_connectionSalesforce'][_0x1b552a(0x1f1)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x1b552a(0x19f)]+_0x1b552a(0x1a0)+this[_0x1b552a(0x1d3)],_0x2efca0),await this[_0x1b552a(0x17c)][_0x1b552a(0x227)](flosum_constants_1['FlosumConstants'][_0x1b552a(0x1f2)]+'/'+constants_1[_0x1b552a(0x19f)]+_0x1b552a(0x1a3),_0xc30bc6),this[_0x1b552a(0x1e5)][_0x1b552a(0x1b9)](_0x1b552a(0x1ba)+(_0x41845d?_0x1b552a(0x198):_0x1b552a(0x19a))+'.'),await this[_0x1b552a(0x1e5)][_0x1b552a(0x21c)]();}}exports[a334_0x3a1b90(0x1b0)]=DeployService;