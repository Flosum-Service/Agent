const a358_0x37d09a=a358_0x3c5f;(function(_0x583ec0,_0x352b06){const _0x2d85e7=a358_0x3c5f,_0x3cb962=_0x583ec0();while(!![]){try{const _0x49990f=parseInt(_0x2d85e7(0x1eb))/0x1+-parseInt(_0x2d85e7(0x1a7))/0x2+parseInt(_0x2d85e7(0x1b4))/0x3+parseInt(_0x2d85e7(0x1e1))/0x4*(parseInt(_0x2d85e7(0x1a0))/0x5)+-parseInt(_0x2d85e7(0x190))/0x6*(parseInt(_0x2d85e7(0x1cd))/0x7)+-parseInt(_0x2d85e7(0x1cb))/0x8*(parseInt(_0x2d85e7(0x1a6))/0x9)+parseInt(_0x2d85e7(0x209))/0xa*(parseInt(_0x2d85e7(0x19a))/0xb);if(_0x49990f===_0x352b06)break;else _0x3cb962['push'](_0x3cb962['shift']());}catch(_0x5371be){_0x3cb962['push'](_0x3cb962['shift']());}}}(a358_0x315a,0x28cf5));const a358_0x2f3e89=(function(){let _0x32c7d2=!![];return function(_0x14dd29,_0x1e3ea8){const _0x4d119d=_0x32c7d2?function(){const _0x2565bd=a358_0x3c5f;if(_0x1e3ea8){const _0x24a405=_0x1e3ea8[_0x2565bd(0x1b2)](_0x14dd29,arguments);return _0x1e3ea8=null,_0x24a405;}}:function(){};return _0x32c7d2=![],_0x4d119d;};}()),a358_0x32d55a=a358_0x2f3e89(this,function(){const _0x528345=a358_0x3c5f;return a358_0x32d55a[_0x528345(0x198)]()[_0x528345(0x1d8)](_0x528345(0x216))['toString']()['constructor'](a358_0x32d55a)[_0x528345(0x1d8)](_0x528345(0x216));});a358_0x32d55a();'use strict';function a358_0x315a(){const _0x1ddcd8=['successfully','Result__c','Date__c','success','__importDefault','_tempFolder','Failure','Backup','833718eytUDi','post','DEPLOYED','VeevaService','FlosumComponentVeevaComponentRetriever','Activity_Type__c','finishDeployWithError','./package-import.service','toString','with\x20error','14861gIYQUY','External_Deployment_Id__c','Component_Name__c','./vpk.service','_organisationId','saveLog','869895TLoxqL','finishDeploy','</a>','has','_connectionSalesforce','retrieve','1035LrKhmD','642382zkoKhd','packageComponentList','Action__c','\x20:\x20','SalesforceDmlError','organisationId','log','_vpkService','_packageExportService','_veevaService','./veeva.service','apply','status','316737XcSJGd','./salesforce.service','logError','../enums/status.enums','createVpk','set','<a\x20href=','retrieveAttachments','../../../core','_salesforceService','Deployment_Result__c','./package-export.service','branchId','_systemLogger','_branchId','FLOSUM_NAMESPACE','Save\x20log','DeployService','saveDeploymentResults','veeva-deploy','componentHistoryId','Logger','_timeZone','22480jQnxTY','default','7TWCQfR','formFlosumDeploymentResults','reduce','metadataLogId','Join\x20all\x20mdl\x20into\x20one\x20zip','toLowerCase','fetchAttachmentsDetailsByParentId','stepName','componentType','packageId','../classes/deploy/zip-creator.deploy','search','Org__c','BACKUP_ZIP_NAME','filter','validate','Is_Error__c','Veeva\x20Deployment','insertMultipleRecords','Retrieving\x20attachments','4SCLAyq','Form\x20Deployment\x20Results','../constants/flosum.constants','PackageExportService','get','text/plain','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','FlosumConstants','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Log__c','199394vXfhFe','Body','createZip','Metadata_Log__c/','getFlosumComponents','Deploy\x20completed\x20','updateLog','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Deployment','_metadataLogId','generate','Type__c','_instanceUrl','_connectionVeeva','Metadata_Log__c','Branch','catch','Branch__c','execute','_packageImportService','Status__c','Create\x20vpk\x20package','Job_Completed__c','.zip','values','componentIdList','type','saveBackup','name','_logger','3490fomqRM','Cannot\x20retrieve\x20all\x20components.','\x20>\x20','deploymentName','_componentIdList','VpkService','Retrieving\x20components','application/zip','__esModule','/vpk__','errors','deploymentAction','BranchComponentHistoryFlosumComponentRetriever','(((.+)+)+)+$','_deploymentName','length','PackageImportService','Activity_Item__c','_organisationName','writeFile','map','COMPLETED','base64'];a358_0x315a=function(){return _0x1ddcd8;};return a358_0x315a();}var __importDefault=this&&this[a358_0x37d09a(0x18c)]||function(_0x5299d){const _0x707d32=a358_0x37d09a;return _0x5299d&&_0x5299d[_0x707d32(0x211)]?_0x5299d:{'default':_0x5299d};};Object['defineProperty'](exports,a358_0x37d09a(0x211),{'value':!![]}),exports[a358_0x37d09a(0x1c5)]=void 0x0;function a358_0x3c5f(_0x985d0f,_0x3d9ff4){const _0x4dd3cc=a358_0x315a();return a358_0x3c5f=function(_0x32d55a,_0x2f3e89){_0x32d55a=_0x32d55a-0x189;let _0x315acf=_0x4dd3cc[_0x32d55a];return _0x315acf;},a358_0x3c5f(_0x985d0f,_0x3d9ff4);}const jszip_1=__importDefault(require('jszip')),promises_1=require('fs/promises'),constants_1=require('../../../constants'),flosum_constants_1=require(a358_0x37d09a(0x1e3)),veeva_service_1=require(a358_0x37d09a(0x1b1)),salesforce_service_1=require(a358_0x37d09a(0x1b5)),core_1=require(a358_0x37d09a(0x1bc)),status_enums_1=require(a358_0x37d09a(0x1b7)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a358_0x37d09a(0x197)),branch_component_history_flosum_component_retriever_1=require(a358_0x37d09a(0x1f2)),flosum_component_veeva_component_retriever_1=require(a358_0x37d09a(0x1e7)),package_export_service_1=require(a358_0x37d09a(0x1bf)),vpk_service_1=require(a358_0x37d09a(0x19d)),zip_creator_deploy_1=require(a358_0x37d09a(0x1d7));class DeployService{constructor(_0x4552a2,_0x186aea,_0x25561e,_0x7af7b4,_0x332fed,_0x1d5e2f){const _0x47228e=a358_0x37d09a;this[_0x47228e(0x1a4)]=_0x186aea,this[_0x47228e(0x1f8)]=_0x25561e,this[_0x47228e(0x208)]=_0x7af7b4,this[_0x47228e(0x18d)]=_0x332fed,this[_0x47228e(0x1f7)]=_0x1d5e2f,this['_branchId']=_0x4552a2[_0x47228e(0x1c0)],this['_metadataLogId']=_0x4552a2[_0x47228e(0x1d0)],this['_attachmentLogId']=_0x4552a2['attachmentLogId'],this[_0x47228e(0x19e)]=_0x4552a2[_0x47228e(0x1ac)],this[_0x47228e(0x1ca)]=_0x4552a2['timeZone'],this[_0x47228e(0x21b)]=_0x4552a2['organisationName'],this[_0x47228e(0x20d)]=_0x4552a2[_0x47228e(0x204)],this[_0x47228e(0x217)]=_0x4552a2[_0x47228e(0x20c)],this['_systemLogger']=new core_1[(_0x47228e(0x1c9))](_0x47228e(0x1c7)),this[_0x47228e(0x1b0)]=new veeva_service_1[(_0x47228e(0x193))]({'connection':this[_0x47228e(0x1f8)],'logger':this['_logger']}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':this[_0x47228e(0x1a4)]}),this[_0x47228e(0x1fe)]=new package_import_service_1[(_0x47228e(0x219))]({'veevaService':this['_veevaService'],'connection':this[_0x47228e(0x1f8)],'logger':this[_0x47228e(0x208)],'saveLog':this[_0x47228e(0x19f)]['bind'](this)}),this[_0x47228e(0x1af)]=new package_export_service_1[(_0x47228e(0x1e4))]({'veevaService':this[_0x47228e(0x1b0)],'connection':this[_0x47228e(0x1f8)],'logger':this[_0x47228e(0x208)]}),this[_0x47228e(0x1ae)]=new vpk_service_1[(_0x47228e(0x20e))]({'connection':this[_0x47228e(0x1f8)]});}async[a358_0x37d09a(0x1fd)](){const _0x13557e=a358_0x37d09a;try{const _0x491625=await this[_0x13557e(0x1ef)]();await this[_0x13557e(0x208)]['updateLog']();const _0x47c44e=await this['createBackup'](_0x491625);await this[_0x13557e(0x206)](_0x47c44e);const _0x11fe56=await this['retrieveAttachments'](_0x491625),_0x43cb8d=await this[_0x13557e(0x1ed)](_0x11fe56),_0x42cb53=await this[_0x13557e(0x1b8)](_0x43cb8d);await this[_0x13557e(0x208)][_0x13557e(0x1f1)]();const _0x15122e=await this[_0x13557e(0x1fe)]['import'](_0x42cb53);await this[_0x13557e(0x208)][_0x13557e(0x1f1)]();const _0x56704a=this[_0x13557e(0x1ce)](_0x491625,_0x15122e[_0x13557e(0x1a8)]);await this['saveDeploymentResults'](_0x56704a),await this[_0x13557e(0x1a1)](_0x15122e['isDeployed'],![],_0x15122e[_0x13557e(0x1d6)]);}catch(_0x4e4f8d){await this[_0x13557e(0x196)](_0x4e4f8d)[_0x13557e(0x1fb)](_0x2ab3c0=>this[_0x13557e(0x1c1)]['error'](_0x2ab3c0));}}async['getFlosumComponents'](){const _0x4a4727=a358_0x37d09a,_0x10ca0c=new Set(this[_0x4a4727(0x20d)]);this['_logger'][_0x4a4727(0x1ad)](_0x4a4727(0x20f));const _0x41452c=await new branch_component_history_flosum_component_retriever_1[(_0x4a4727(0x215))]({'value':this[_0x4a4727(0x1c2)],'salesforceService':this['_salesforceService']})[_0x4a4727(0x1a5)](),_0x14cf02=_0x41452c[_0x4a4727(0x1db)](_0x1ffcf5=>_0x10ca0c[_0x4a4727(0x1a3)](_0x1ffcf5['id']));if(_0x14cf02[_0x4a4727(0x218)]!==this['_componentIdList'][_0x4a4727(0x218)])throw new Error(_0x4a4727(0x20a));return _0x14cf02;}async['createBackup'](_0xa5a249){const _0x21e16a=a358_0x37d09a;var _0x9508b0;this[_0x21e16a(0x208)][_0x21e16a(0x1ad)]('Create\x20Backup');const _0x5d54cb=await new flosum_component_veeva_component_retriever_1[(_0x21e16a(0x194))]({'value':_0xa5a249,'veevaService':this[_0x21e16a(0x1b0)],'logger':this['_logger']})[_0x21e16a(0x1a5)](),_0x3a1a02=await this[_0x21e16a(0x1af)]['export'](_0x5d54cb,_0x21e16a(0x18f));if(_0x3a1a02['length']>0x1)throw new Error(_0x21e16a(0x1e9));return(_0x9508b0=_0x3a1a02[0x0])!==null&&_0x9508b0!==void 0x0?_0x9508b0:_0x3a1a02[0x0]=new jszip_1[(_0x21e16a(0x1cc))](),_0x3a1a02[0x0]['generateAsync']({'type':_0x21e16a(0x21f)});}async[a358_0x37d09a(0x206)](_0x524f6f){const _0x151108=a358_0x37d09a;this[_0x151108(0x208)]['log']('Save\x20Backup\x20to\x20Salesforce');const _0x56232c={'Body':_0x524f6f,'ContentType':_0x151108(0x210),'ParentId':this[_0x151108(0x1f4)],'Name':flosum_constants_1[_0x151108(0x1e8)][_0x151108(0x1da)]};await this[_0x151108(0x1a4)]['post'](flosum_constants_1[_0x151108(0x1e8)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x56232c);}async[a358_0x37d09a(0x1bb)](_0x4b37c4){const _0x2cbddd=a358_0x37d09a;this[_0x2cbddd(0x208)]['log'](_0x2cbddd(0x1e0));const _0x3d5510=await(0x0,fetch_attachments_1[_0x2cbddd(0x1d3)])(this[_0x2cbddd(0x1a4)],_0x4b37c4[_0x2cbddd(0x21d)](_0x16e855=>_0x16e855[_0x2cbddd(0x1c8)])),_0x596ea4=await(0x0,fetch_attachments_1[_0x2cbddd(0x1bb)])(_0x3d5510,this['_connectionSalesforce']);if(_0x596ea4[_0x2cbddd(0x218)]!==this[_0x2cbddd(0x20d)][_0x2cbddd(0x218)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x596ea4['map'](_0x2881e3=>_0x2881e3[_0x2cbddd(0x203)][_0x2cbddd(0x1ec)]);}async['createZip'](_0x3fedbb){const _0x1e2b6d=a358_0x37d09a;this['_logger'][_0x1e2b6d(0x1ad)](_0x1e2b6d(0x1d1));const _0x335320=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x3fedbb,'deploymentName':this['_deploymentName']})[_0x1e2b6d(0x1fd)](),_0x67462a=this[_0x1e2b6d(0x18d)]+'/'+(0x0,shortid_1[_0x1e2b6d(0x1cc)])()+_0x1e2b6d(0x202);return await(0x0,promises_1[_0x1e2b6d(0x21c)])(_0x67462a,_0x335320),_0x67462a;}async[a358_0x37d09a(0x1b8)](_0xf03561){const _0x108fca=a358_0x37d09a;this[_0x108fca(0x208)]['log'](_0x108fca(0x200));const _0x1e13b7=await this[_0x108fca(0x1ae)][_0x108fca(0x1f5)](_0xf03561),_0x2e0840=this[_0x108fca(0x18d)]+_0x108fca(0x212)+_0xf03561['slice'](_0xf03561['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x2e0840,_0x1e13b7),await this[_0x108fca(0x1ae)][_0x108fca(0x1dc)](_0x2e0840),_0x2e0840;}async[a358_0x37d09a(0x19f)](_0x501702,_0x463477){const _0x44a2eb=a358_0x37d09a;this[_0x44a2eb(0x208)][_0x44a2eb(0x1ad)](_0x44a2eb(0x1c4));const _0x19ba53={'Body':Buffer['from'](_0x501702)[_0x44a2eb(0x198)](_0x44a2eb(0x21f)),'ContentType':_0x44a2eb(0x1e6),'ParentId':this[_0x44a2eb(0x1f4)],'Name':_0x463477};await this['_connectionSalesforce'][_0x44a2eb(0x191)](flosum_constants_1[_0x44a2eb(0x1e8)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x19ba53);}['formFlosumDeploymentResults'](_0x5c0052,_0x2b392f){const _0x460583=a358_0x37d09a;this[_0x460583(0x208)][_0x460583(0x1ad)](_0x460583(0x1e2));const _0x461296=_0x5c0052[_0x460583(0x1cf)]((_0x4ae387,_0x46fd9e)=>_0x4ae387[_0x460583(0x1b9)]((_0x46fd9e[_0x460583(0x1d5)]+'.'+_0x46fd9e['componentName'])[_0x460583(0x1d2)](),_0x46fd9e),new Map());return _0x2b392f['map'](_0x5bcf8b=>{const _0x330ae2=_0x460583;this[_0x330ae2(0x208)][_0x330ae2(0x1ad)](_0x5bcf8b[_0x330ae2(0x205)]+'.'+_0x5bcf8b[_0x330ae2(0x207)]+_0x330ae2(0x1aa)+_0x5bcf8b['status']);const _0xe4e6e5=(_0x5bcf8b[_0x330ae2(0x205)]+'.'+_0x5bcf8b[_0x330ae2(0x207)])[_0x330ae2(0x1d2)](),_0x52128a=_0x461296[_0x330ae2(0x1e5)](_0xe4e6e5);return{[constants_1[_0x330ae2(0x1c3)]+_0x330ae2(0x1f6)]:'Deployment\x20Result',[constants_1[_0x330ae2(0x1c3)]+_0x330ae2(0x1ff)]:_0x5bcf8b[_0x330ae2(0x1b3)]===status_enums_1['PackageComponentStatus'][_0x330ae2(0x192)]?'Success':_0x330ae2(0x18e),[constants_1['FLOSUM_NAMESPACE']+_0x330ae2(0x189)]:_0x5bcf8b[_0x330ae2(0x214)],[constants_1[_0x330ae2(0x1c3)]+_0x330ae2(0x19c)]:_0x5bcf8b['name'],[constants_1[_0x330ae2(0x1c3)]+'Component_Type__c']:_0x5bcf8b[_0x330ae2(0x205)],[constants_1[_0x330ae2(0x1c3)]+'Veeva_Step_Name__c']:_0x5bcf8b[_0x330ae2(0x1d4)],[constants_1[_0x330ae2(0x1c3)]+_0x330ae2(0x1d9)]:this[_0x330ae2(0x19e)],[constants_1[_0x330ae2(0x1c3)]+_0x330ae2(0x1f9)]:this['_metadataLogId'],[constants_1[_0x330ae2(0x1c3)]+'Component_History__c']:_0x52128a[_0x330ae2(0x1c8)]};});}async[a358_0x37d09a(0x1c6)](_0x4afbf7){const _0x452f8d=a358_0x37d09a;this[_0x452f8d(0x208)][_0x452f8d(0x1ad)]('Save\x20Deployment\x20Results');const _0x9a5d67=await this[_0x452f8d(0x1bd)][_0x452f8d(0x1df)](constants_1[_0x452f8d(0x1c3)]+_0x452f8d(0x1be),_0x4afbf7),_0x4a05bf=_0x9a5d67[_0x452f8d(0x1db)](_0x2ae1ce=>!_0x2ae1ce[_0x452f8d(0x18b)])[_0x452f8d(0x21d)](_0x379043=>_0x379043[_0x452f8d(0x213)])['flat']();if(_0x4a05bf[_0x452f8d(0x218)])throw new salesforce_dml_error_1[(_0x452f8d(0x1ab))](_0x4a05bf);}async[a358_0x37d09a(0x196)](_0x59726f){const _0x4360d9=a358_0x37d09a;this[_0x4360d9(0x208)][_0x4360d9(0x1b6)](_0x59726f),await this['_logger'][_0x4360d9(0x1f1)](),await this[_0x4360d9(0x1a1)](![],!![],'');}async[a358_0x37d09a(0x1a1)](_0x100b20,_0x31b217,_0x183fc1){const _0x23b558=a358_0x37d09a,_0x337996='<a\x20href='+this[_0x23b558(0x1f7)]+'/'+this[_0x23b558(0x1f4)]+_0x23b558(0x20b)+_0x23b558(0x1de)+'\x20</a>',_0x2d0539=_0x23b558(0x1ba)+this[_0x23b558(0x1f7)]+'/'+this[_0x23b558(0x19e)]+'\x20>'+this[_0x23b558(0x21b)]+_0x23b558(0x1a2),_0x24aafd=_0x337996+'\x20of\x20branch\x20to\x20Organization\x20'+_0x2d0539+'\x20has\x20been\x20created.',_0x4aca3d={[constants_1[_0x23b558(0x1c3)]+_0x23b558(0x1a9)]:_0x24aafd,[constants_1[_0x23b558(0x1c3)]+_0x23b558(0x18a)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x23b558(0x1fc)]:this['_branchId'],[constants_1[_0x23b558(0x1c3)]+_0x23b558(0x21a)]:_0x23b558(0x1fa),[constants_1[_0x23b558(0x1c3)]+_0x23b558(0x195)]:_0x23b558(0x1f3),[constants_1[_0x23b558(0x1c3)]+'TargetId__c']:this['_organisationId']},_0x1aa0ba={[constants_1[_0x23b558(0x1c3)]+_0x23b558(0x1dd)]:!_0x100b20,[constants_1[_0x23b558(0x1c3)]+'Succeed__c']:_0x100b20,[constants_1[_0x23b558(0x1c3)]+_0x23b558(0x1ff)]:_0x31b217?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1['MetadataLogStatus'][_0x23b558(0x21e)],[constants_1[_0x23b558(0x1c3)]+_0x23b558(0x201)]:!![],[constants_1[_0x23b558(0x1c3)]+_0x23b558(0x19b)]:_0x183fc1};await this[_0x23b558(0x1a4)]['patch'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x23b558(0x1ee)+this[_0x23b558(0x1f4)],_0x1aa0ba),await this[_0x23b558(0x1a4)][_0x23b558(0x191)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x23b558(0x1c3)]+_0x23b558(0x1ea),_0x4aca3d),this[_0x23b558(0x208)][_0x23b558(0x1ad)](_0x23b558(0x1f0)+(_0x100b20?_0x23b558(0x220):_0x23b558(0x199))+'.'),await this['_logger'][_0x23b558(0x1f1)]();}}exports['DeployService']=DeployService;