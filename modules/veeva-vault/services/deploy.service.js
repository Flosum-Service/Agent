const a401_0x40da90=a401_0x2fe7;(function(_0x34aa85,_0x15f8a1){const _0x461782=a401_0x2fe7,_0x8bf4e4=_0x34aa85();while(!![]){try{const _0x1f7288=-parseInt(_0x461782(0x120))/0x1+-parseInt(_0x461782(0x104))/0x2+parseInt(_0x461782(0xec))/0x3+parseInt(_0x461782(0x12c))/0x4*(-parseInt(_0x461782(0x14b))/0x5)+parseInt(_0x461782(0x14d))/0x6*(parseInt(_0x461782(0x15c))/0x7)+parseInt(_0x461782(0xd5))/0x8+-parseInt(_0x461782(0x101))/0x9*(-parseInt(_0x461782(0xc4))/0xa);if(_0x1f7288===_0x15f8a1)break;else _0x8bf4e4['push'](_0x8bf4e4['shift']());}catch(_0x2d2156){_0x8bf4e4['push'](_0x8bf4e4['shift']());}}}(a401_0x49aa,0x9d1f8));function a401_0x2fe7(_0x502863,_0x89f210){const _0x475c82=a401_0x49aa();return a401_0x2fe7=function(_0x523bbd,_0x2a0bfc){_0x523bbd=_0x523bbd-0xc2;let _0x49aa83=_0x475c82[_0x523bbd];return _0x49aa83;},a401_0x2fe7(_0x502863,_0x89f210);}const a401_0x2a0bfc=(function(){let _0xeeb5e3=!![];return function(_0x51f968,_0x287538){const _0x33c512=_0xeeb5e3?function(){const _0x20de7d=a401_0x2fe7;if(_0x287538){const _0x4125d3=_0x287538[_0x20de7d(0xc6)](_0x51f968,arguments);return _0x287538=null,_0x4125d3;}}:function(){};return _0xeeb5e3=![],_0x33c512;};}()),a401_0x523bbd=a401_0x2a0bfc(this,function(){const _0x6b55b=a401_0x2fe7;return a401_0x523bbd[_0x6b55b(0x153)]()['search']('(((.+)+)+)+$')[_0x6b55b(0x153)]()[_0x6b55b(0xd9)](a401_0x523bbd)[_0x6b55b(0x151)](_0x6b55b(0xdd));});a401_0x523bbd();'use strict';var __importDefault=this&&this[a401_0x40da90(0x11e)]||function(_0x48672e){const _0x20e44a=a401_0x40da90;return _0x48672e&&_0x48672e[_0x20e44a(0x125)]?_0x48672e:{'default':_0x48672e};};Object['defineProperty'](exports,a401_0x40da90(0x125),{'value':!![]}),exports['DeployService']=void 0x0;function a401_0x49aa(){const _0x5b1856=['FlosumConstants','<a\x20href=','post','_vpkService','COMPLETED','_tempFolder','success','deploymentAction','79915DRjoRm','Branch__c','516NdDEau','ZipCreatorDeploy','toLowerCase','FLOSUM_NAMESPACE','search','_branchId','toString','base64','catch','PackageImportService','../classes/errors/salesforce-dml-error','isDeployed','text/plain','_componentIdList','./salesforce.service','10801MUJEEi','_deploymentName','Activity_Type__c','get','Veeva\x20Deployment','formFlosumDeploymentResults','finishDeployWithError','status','_connectionVeeva','Success','1030nqhJKG','stepName','apply','.zip','updateLog','getFlosumComponents','\x20>\x20','writeFile','VeevaService','length','with\x20error','generateAsync','deploymentName','errors','map','successfully','logError','552368krfiLU','log','FlosumComponentVeevaComponentRetriever','\x20:\x20','constructor','filter','slice','createVpk','(((.+)+)+)+$','PackageExportService','_metadataLogId','/vpk__','Branch','Retrieving\x20components','saveDeploymentResults','Cannot\x20retrievers\x20all\x20attachments','EXCEPTION','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Body','organisationId','BranchComponentHistoryFlosumComponentRetriever','Is_Error__c','_organisationId','1516716iWvQoV','../../../constants','Logger','_connectionSalesforce','type','veeva-deploy','Metadata_Log__c/','finishDeploy','Join\x20all\x20mdl\x20into\x20one\x20zip','patch','Action__c','createZip','saveBackup','import','_organisationName','Component_Type__c','_systemLogger','_salesforceService','branchId','validate','\x20has\x20been\x20created.','221157zIlwNq','Deployment','flat','1684152lgTNwB','application/zip','set','has','error','Succeed__c','componentType','../../../core','Retrieving\x20attachments','Save\x20log','packageComponentList','componentName','_instanceUrl','shortid','Component_Name__c','Job_Completed__c','Result__c','generate','Save\x20Deployment\x20Results','_timeZone','organisationName','Veeva_Step_Name__c','bind','export','Status__c','fetchAttachmentsDetailsByParentId','__importDefault','DeployService','1161312zCBtoc','packageId','from','DEPLOYED','TargetId__c','__esModule','Save\x20Backup\x20to\x20Salesforce','Cannot\x20retrieve\x20all\x20components.','ENDPOINT_UPSERT_RECORD','lastIndexOf','./package-import.service','execute','148nuVBJF','MetadataLogStatus','./veeva.service','retrieve','_logger','Log__c','PackageComponentStatus','../../shared/utils/fetch-attachments','\x20</a>','External_Deployment_Id__c','attachmentLogId','fs/promises','componentHistoryId','saveLog','jszip','_attachmentLogId','_veevaService','Component_History__c','../classes/deploy/zip-creator.deploy','createBackup','_packageExportService','insertMultipleRecords','Create\x20Backup'];a401_0x49aa=function(){return _0x5b1856;};return a401_0x49aa();}const jszip_1=__importDefault(require(a401_0x40da90(0x13a))),promises_1=require(a401_0x40da90(0x137)),constants_1=require(a401_0x40da90(0xed)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a401_0x40da90(0x12e)),salesforce_service_1=require(a401_0x40da90(0x15b)),core_1=require(a401_0x40da90(0x10b)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a401_0x40da90(0x157)),shortid_1=__importDefault(require(a401_0x40da90(0x111))),fetch_attachments_1=require(a401_0x40da90(0x133)),package_import_service_1=require(a401_0x40da90(0x12a)),branch_component_history_flosum_component_retriever_1=require(a401_0x40da90(0xe6)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require('./package-export.service'),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require(a401_0x40da90(0x13e));class DeployService{constructor(_0x1eddd1,_0xe0c3ac,_0x257285,_0x2b1b90,_0x58b86a,_0x295964){const _0x267d06=a401_0x40da90;this['_connectionSalesforce']=_0xe0c3ac,this[_0x267d06(0xc2)]=_0x257285,this[_0x267d06(0x130)]=_0x2b1b90,this[_0x267d06(0x148)]=_0x58b86a,this[_0x267d06(0x110)]=_0x295964,this[_0x267d06(0x152)]=_0x1eddd1[_0x267d06(0xfe)],this[_0x267d06(0xdf)]=_0x1eddd1['metadataLogId'],this[_0x267d06(0x13b)]=_0x1eddd1[_0x267d06(0x136)],this[_0x267d06(0xeb)]=_0x1eddd1[_0x267d06(0xe8)],this[_0x267d06(0x117)]=_0x1eddd1['timeZone'],this[_0x267d06(0xfa)]=_0x1eddd1[_0x267d06(0x118)],this[_0x267d06(0x15a)]=_0x1eddd1['componentIdList'],this[_0x267d06(0x15d)]=_0x1eddd1[_0x267d06(0xd0)],this['_systemLogger']=new core_1[(_0x267d06(0xee))](_0x267d06(0xf1)),this[_0x267d06(0x13c)]=new veeva_service_1[(_0x267d06(0xcc))]({'connection':this['_connectionVeeva'],'logger':this[_0x267d06(0x130)]}),this[_0x267d06(0xfd)]=new salesforce_service_1['SalesforceService']({'connection':this['_connectionSalesforce']}),this['_packageImportService']=new package_import_service_1[(_0x267d06(0x156))]({'veevaService':this[_0x267d06(0x13c)],'connection':this[_0x267d06(0xc2)],'logger':this[_0x267d06(0x130)],'saveLog':this[_0x267d06(0x139)][_0x267d06(0x11a)](this)}),this[_0x267d06(0x140)]=new package_export_service_1[(_0x267d06(0xde))]({'veevaService':this[_0x267d06(0x13c)],'connection':this['_connectionVeeva'],'logger':this[_0x267d06(0x130)]}),this[_0x267d06(0x146)]=new vpk_service_1['VpkService']({'connection':this[_0x267d06(0xc2)]});}async[a401_0x40da90(0x12b)](){const _0x3d4e6f=a401_0x40da90;try{const _0x34bb50=await this[_0x3d4e6f(0xc9)]();await this['_logger'][_0x3d4e6f(0xc8)]();const _0x440d62=await this[_0x3d4e6f(0x13f)](_0x34bb50);await this[_0x3d4e6f(0xf8)](_0x440d62);const _0x1b6ce4=await this['retrieveAttachments'](_0x34bb50),_0x3aad10=await this[_0x3d4e6f(0xf7)](_0x1b6ce4),_0xe45e87=await this[_0x3d4e6f(0xdc)](_0x3aad10);await this[_0x3d4e6f(0x130)][_0x3d4e6f(0xc8)]();const _0x47f5d2=await this['_packageImportService'][_0x3d4e6f(0xf9)](_0xe45e87);await this[_0x3d4e6f(0x130)]['updateLog']();const _0x1b1144=this[_0x3d4e6f(0x161)](_0x34bb50,_0x47f5d2[_0x3d4e6f(0x10e)]);await this[_0x3d4e6f(0xe3)](_0x1b1144),await this[_0x3d4e6f(0xf3)](_0x47f5d2[_0x3d4e6f(0x158)],![],_0x47f5d2[_0x3d4e6f(0x121)]);}catch(_0xad78a6){await this[_0x3d4e6f(0x162)](_0xad78a6)[_0x3d4e6f(0x155)](_0x168e52=>this[_0x3d4e6f(0xfc)][_0x3d4e6f(0x108)](_0x168e52));}}async[a401_0x40da90(0xc9)](){const _0x2d5ae7=a401_0x40da90,_0x478e00=new Set(this[_0x2d5ae7(0x15a)]);this[_0x2d5ae7(0x130)][_0x2d5ae7(0xd6)](_0x2d5ae7(0xe2));const _0x2f20b3=await new branch_component_history_flosum_component_retriever_1[(_0x2d5ae7(0xe9))]({'value':this[_0x2d5ae7(0x152)],'salesforceService':this['_salesforceService']})[_0x2d5ae7(0x12f)](),_0x341392=_0x2f20b3['filter'](_0x512a0a=>_0x478e00[_0x2d5ae7(0x107)](_0x512a0a['id']));if(_0x341392['length']!==this[_0x2d5ae7(0x15a)][_0x2d5ae7(0xcd)])throw new Error(_0x2d5ae7(0x127));return _0x341392;}async[a401_0x40da90(0x13f)](_0x40650e){const _0x55e13b=a401_0x40da90;var _0x27bc49;this[_0x55e13b(0x130)][_0x55e13b(0xd6)](_0x55e13b(0x142));const _0xf8fb8e=await new flosum_component_veeva_component_retriever_1[(_0x55e13b(0xd7))]({'value':_0x40650e,'veevaService':this[_0x55e13b(0x13c)],'logger':this[_0x55e13b(0x130)]})[_0x55e13b(0x12f)](),_0x43336c=await this[_0x55e13b(0x140)][_0x55e13b(0x11b)](_0xf8fb8e,'Backup');if(_0x43336c[_0x55e13b(0xcd)]>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x27bc49=_0x43336c[0x0])!==null&&_0x27bc49!==void 0x0?_0x27bc49:_0x43336c[0x0]=new jszip_1['default'](),_0x43336c[0x0][_0x55e13b(0xcf)]({'type':'base64'});}async[a401_0x40da90(0xf8)](_0xb3b631){const _0x47d443=a401_0x40da90;this[_0x47d443(0x130)]['log'](_0x47d443(0x126));const _0x9283a2={'Body':_0xb3b631,'ContentType':_0x47d443(0x105),'ParentId':this[_0x47d443(0xdf)],'Name':flosum_constants_1[_0x47d443(0x143)]['BACKUP_ZIP_NAME']};await this['_connectionSalesforce'][_0x47d443(0x145)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x9283a2);}async['retrieveAttachments'](_0x1b1961){const _0xd85c07=a401_0x40da90;this[_0xd85c07(0x130)][_0xd85c07(0xd6)](_0xd85c07(0x10c));const _0x465da0=await(0x0,fetch_attachments_1[_0xd85c07(0x11d)])(this[_0xd85c07(0xef)],_0x1b1961['map'](_0x431997=>_0x431997[_0xd85c07(0x138)])),_0x2bc9bd=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x465da0,this['_connectionSalesforce']);if(_0x2bc9bd[_0xd85c07(0xcd)]!==this[_0xd85c07(0x15a)][_0xd85c07(0xcd)])throw new Error(_0xd85c07(0xe4));return _0x2bc9bd[_0xd85c07(0xd2)](_0x44bd7c=>_0x44bd7c['values'][_0xd85c07(0xe7)]);}async[a401_0x40da90(0xf7)](_0x3f3f6e){const _0x28296b=a401_0x40da90;this[_0x28296b(0x130)][_0x28296b(0xd6)](_0x28296b(0xf4));const _0x4c0322=await new zip_creator_deploy_1[(_0x28296b(0x14e))]({'attachmentBodies':_0x3f3f6e,'deploymentName':this['_deploymentName']})[_0x28296b(0x12b)](),_0x235abf=this[_0x28296b(0x148)]+'/'+(0x0,shortid_1['default'])()+_0x28296b(0xc7);return await(0x0,promises_1['writeFile'])(_0x235abf,_0x4c0322),_0x235abf;}async[a401_0x40da90(0xdc)](_0x2c0eae){const _0xcd59c4=a401_0x40da90;this[_0xcd59c4(0x130)][_0xcd59c4(0xd6)]('Create\x20vpk\x20package');const _0x3d4cff=await this['_vpkService'][_0xcd59c4(0x115)](_0x2c0eae),_0x3934e6=this[_0xcd59c4(0x148)]+_0xcd59c4(0xe0)+_0x2c0eae[_0xcd59c4(0xdb)](_0x2c0eae[_0xcd59c4(0x129)]('/')+0x1);return await(0x0,promises_1[_0xcd59c4(0xcb)])(_0x3934e6,_0x3d4cff),await this[_0xcd59c4(0x146)][_0xcd59c4(0xff)](_0x3934e6),_0x3934e6;}async[a401_0x40da90(0x139)](_0x153c14,_0x53cad6){const _0x34c906=a401_0x40da90;this['_logger']['log'](_0x34c906(0x10d));const _0x29d6a6={'Body':Buffer[_0x34c906(0x122)](_0x153c14)[_0x34c906(0x153)](_0x34c906(0x154)),'ContentType':_0x34c906(0x159),'ParentId':this['_metadataLogId'],'Name':_0x53cad6};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x34c906(0x143)][_0x34c906(0x128)]+'/Attachment',_0x29d6a6);}[a401_0x40da90(0x161)](_0x33e59e,_0x23def6){const _0x5698cb=a401_0x40da90;this[_0x5698cb(0x130)][_0x5698cb(0xd6)]('Form\x20Deployment\x20Results');const _0x1f3c83=_0x33e59e['reduce']((_0x11b377,_0x1875a2)=>_0x11b377[_0x5698cb(0x106)]((_0x1875a2[_0x5698cb(0x10a)]+'.'+_0x1875a2[_0x5698cb(0x10f)])['toLowerCase'](),_0x1875a2),new Map());return _0x23def6['map'](_0x1426ea=>{const _0x1b39a5=_0x5698cb;this['_logger'][_0x1b39a5(0xd6)](_0x1426ea['type']+'.'+_0x1426ea['name']+_0x1b39a5(0xd8)+_0x1426ea[_0x1b39a5(0x163)]);const _0x39ca93=(_0x1426ea[_0x1b39a5(0xf0)]+'.'+_0x1426ea['name'])[_0x1b39a5(0x14f)](),_0x5c6d6a=_0x1f3c83[_0x1b39a5(0x15f)](_0x39ca93);return{[constants_1[_0x1b39a5(0x150)]+'Type__c']:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+_0x1b39a5(0x11c)]:_0x1426ea[_0x1b39a5(0x163)]===status_enums_1[_0x1b39a5(0x132)][_0x1b39a5(0x123)]?_0x1b39a5(0xc3):'Failure',[constants_1[_0x1b39a5(0x150)]+_0x1b39a5(0x114)]:_0x1426ea[_0x1b39a5(0x14a)],[constants_1[_0x1b39a5(0x150)]+_0x1b39a5(0x112)]:_0x1426ea['name'],[constants_1[_0x1b39a5(0x150)]+_0x1b39a5(0xfb)]:_0x1426ea[_0x1b39a5(0xf0)],[constants_1[_0x1b39a5(0x150)]+_0x1b39a5(0x119)]:_0x1426ea[_0x1b39a5(0xc5)],[constants_1[_0x1b39a5(0x150)]+'Org__c']:this[_0x1b39a5(0xeb)],[constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c']:this[_0x1b39a5(0xdf)],[constants_1[_0x1b39a5(0x150)]+_0x1b39a5(0x13d)]:_0x5c6d6a['componentHistoryId']};});}async[a401_0x40da90(0xe3)](_0x2c42c4){const _0x103421=a401_0x40da90;this['_logger'][_0x103421(0xd6)](_0x103421(0x116));const _0x298a74=await this[_0x103421(0xfd)][_0x103421(0x141)](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x2c42c4),_0x301af5=_0x298a74[_0x103421(0xda)](_0x1564e2=>!_0x1564e2[_0x103421(0x149)])[_0x103421(0xd2)](_0x2f2718=>_0x2f2718[_0x103421(0xd1)])[_0x103421(0x103)]();if(_0x301af5[_0x103421(0xcd)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x301af5);}async['finishDeployWithError'](_0x56674c){const _0x2cd40d=a401_0x40da90;this[_0x2cd40d(0x130)][_0x2cd40d(0xd4)](_0x56674c),await this['_logger'][_0x2cd40d(0xc8)](),await this[_0x2cd40d(0xf3)](![],!![],'');}async[a401_0x40da90(0xf3)](_0x31c1c2,_0x21ee43,_0x1c8f6f){const _0x5f4c93=a401_0x40da90,_0x20613e=_0x5f4c93(0x144)+this[_0x5f4c93(0x110)]+'/'+this[_0x5f4c93(0xdf)]+_0x5f4c93(0xca)+_0x5f4c93(0x160)+_0x5f4c93(0x134),_0x2cb092=_0x5f4c93(0x144)+this[_0x5f4c93(0x110)]+'/'+this[_0x5f4c93(0xeb)]+'\x20>'+this[_0x5f4c93(0xfa)]+'</a>',_0x493046=_0x20613e+'\x20of\x20branch\x20to\x20Organization\x20'+_0x2cb092+_0x5f4c93(0x100),_0x54a604={[constants_1[_0x5f4c93(0x150)]+_0x5f4c93(0xf6)]:_0x493046,[constants_1[_0x5f4c93(0x150)]+'Date__c']:new Date(),[constants_1[_0x5f4c93(0x150)]+_0x5f4c93(0x14c)]:this[_0x5f4c93(0x152)],[constants_1['FLOSUM_NAMESPACE']+'Activity_Item__c']:_0x5f4c93(0xe1),[constants_1[_0x5f4c93(0x150)]+_0x5f4c93(0x15e)]:_0x5f4c93(0x102),[constants_1[_0x5f4c93(0x150)]+_0x5f4c93(0x124)]:this[_0x5f4c93(0xeb)]},_0xab8e1={[constants_1['FLOSUM_NAMESPACE']+_0x5f4c93(0xea)]:!_0x31c1c2,[constants_1[_0x5f4c93(0x150)]+_0x5f4c93(0x109)]:_0x31c1c2,[constants_1[_0x5f4c93(0x150)]+'Status__c']:_0x21ee43?status_enums_1[_0x5f4c93(0x12d)][_0x5f4c93(0xe5)]:status_enums_1[_0x5f4c93(0x12d)][_0x5f4c93(0x147)],[constants_1['FLOSUM_NAMESPACE']+_0x5f4c93(0x113)]:!![],[constants_1[_0x5f4c93(0x150)]+_0x5f4c93(0x135)]:_0x1c8f6f};await this['_connectionSalesforce'][_0x5f4c93(0xf5)](flosum_constants_1[_0x5f4c93(0x143)][_0x5f4c93(0x128)]+'/'+constants_1[_0x5f4c93(0x150)]+_0x5f4c93(0xf2)+this[_0x5f4c93(0xdf)],_0xab8e1),await this['_connectionSalesforce'][_0x5f4c93(0x145)](flosum_constants_1[_0x5f4c93(0x143)][_0x5f4c93(0x128)]+'/'+constants_1[_0x5f4c93(0x150)]+_0x5f4c93(0x131),_0x54a604),this['_logger'][_0x5f4c93(0xd6)]('Deploy\x20completed\x20'+(_0x31c1c2?_0x5f4c93(0xd3):_0x5f4c93(0xce))+'.'),await this[_0x5f4c93(0x130)][_0x5f4c93(0xc8)]();}}exports[a401_0x40da90(0x11f)]=DeployService;