const a334_0x2b671f=a334_0x4266;(function(_0x14e39f,_0x2b7b4f){const _0x6bb054=a334_0x4266,_0x2ae541=_0x14e39f();while(!![]){try{const _0x4af5c9=parseInt(_0x6bb054(0x230))/0x1*(parseInt(_0x6bb054(0x254))/0x2)+parseInt(_0x6bb054(0x1e0))/0x3*(parseInt(_0x6bb054(0x1cb))/0x4)+-parseInt(_0x6bb054(0x217))/0x5*(-parseInt(_0x6bb054(0x1c2))/0x6)+-parseInt(_0x6bb054(0x1f4))/0x7+-parseInt(_0x6bb054(0x1d6))/0x8*(parseInt(_0x6bb054(0x21d))/0x9)+-parseInt(_0x6bb054(0x21f))/0xa+-parseInt(_0x6bb054(0x1d7))/0xb;if(_0x4af5c9===_0x2b7b4f)break;else _0x2ae541['push'](_0x2ae541['shift']());}catch(_0x1782b8){_0x2ae541['push'](_0x2ae541['shift']());}}}(a334_0x4f24,0xea963));const a334_0x3ee77b=(function(){let _0x9ee718=!![];return function(_0x1302d5,_0x3bb633){const _0x24ada7=_0x9ee718?function(){const _0x1a7075=a334_0x4266;if(_0x3bb633){const _0x373028=_0x3bb633[_0x1a7075(0x238)](_0x1302d5,arguments);return _0x3bb633=null,_0x373028;}}:function(){};return _0x9ee718=![],_0x24ada7;};}()),a334_0x16161b=a334_0x3ee77b(this,function(){const _0x53aff5=a334_0x4266;return a334_0x16161b[_0x53aff5(0x20f)]()[_0x53aff5(0x219)](_0x53aff5(0x262))[_0x53aff5(0x20f)]()[_0x53aff5(0x25b)](a334_0x16161b)['search']('(((.+)+)+)+$');});a334_0x16161b();'use strict';var __importDefault=this&&this[a334_0x2b671f(0x24c)]||function(_0x3d8532){const _0x5ad2a1=a334_0x2b671f;return _0x3d8532&&_0x3d8532[_0x5ad2a1(0x220)]?_0x3d8532:{'default':_0x3d8532};};function a334_0x4f24(){const _0x51626e=['../enums/status.enums','updateLog','finishDeployWithError','1989018ERCaKq','Log__c','Save\x20Deployment\x20Results','lastIndexOf','<a\x20href=','has','createBackup','constructor','_branchId','ENDPOINT_UPSERT_RECORD','Deployment\x20Result','_tempFolder','Activity_Type__c','timeZone','(((.+)+)+)+$','successfully','Component_History__c','_logger','Branch__c','values','log','buildObject','packageId','attachmentLogId','Success','../../../constants','12CnXKVf','defineProperty','Deployment_Result__c','post','FlosumConstants','Component_Name__c','_instanceUrl','_timeZone','stepName','348IUzXJA','success','.zip','Deployment','Metadata_Log__c/','componentHistoryId','Logger','retrieve','joinAllAttachments','\x20:\x20','Flosum','72FwKlzw','12972410jQtnlk','Cannot\x20Backup\x20more\x20than\x20200\x20components.','BranchComponentHistoryFlosumComponentRetriever','Builder','_packageImportService','./vpk.service','generate','PackageImportService','DeployService','28563wCDCtV','Join\x20all\x20mdl\x20into\x20one\x20zip','length','PackageComponentStatus','EXCEPTION','Save\x20log','_veevaService','componentType','text/plain','MetadataLogStatus','../classes/errors/salesforce-dml-error','Retrieving\x20components','_packageExportService','toLowerCase','createVpk','Org__c','patch','Branch','_organisationName','file','710143YpEkIF','branchId','\x20of\x20branch\x20to\x20Organization\x20','VpkService','_metadataLogId','./package-import.service','packageComponentList','_organisationId','async','organisationName','componentName','./veeva.service','retrieveAttachments','\x20</a>','_vpkService','Type__c','map','SalesforceDmlError','_attachmentLogId','generateAsync','execute','files','error','Activity_Item__c','/Attachment','Is_Error__c','SalesforceService','toString','Action__c','status','Succeed__c','saveLog','organisationId','loadAsync','veeva-deploy','2349510zRhvDb','https://veevavault.com/','search','BACKUP_ZIP_NAME','Form\x20Deployment\x20Results','Result__c','125037YHQXya','_salesforceService','3959770hyaTTm','__esModule','../../shared/utils/fetch-attachments','componentIdList','_connectionSalesforce','writeFile','type','errors','VeevaService','Deploy\x20completed\x20','default','fetchAttachmentsDetailsByParentId','_connectionVeeva','Async_Request_Id__c','flat','Job_Completed__c','jszip','1vZaywa','_systemLogger','reduce','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','saveDeploymentResults','filter','_componentIdList','validate','apply','Deploy','Create\x20Backup','vaultpackage.xml','base64','Cannot\x20retrieve\x20all\x20components.','getFlosumComponents','_deploymentName','Status__c','string','application/zip','finishDeploy','migration__v','name','COMPLETED','FLOSUM_NAMESPACE','logError','./salesforce.service','Component_Type__c','xml2js','__importDefault','FlosumComponentVeevaComponentRetriever','deploymentName','../../../core','with\x20error'];a334_0x4f24=function(){return _0x51626e;};return a334_0x4f24();}Object[a334_0x2b671f(0x1c3)](exports,a334_0x2b671f(0x220),{'value':!![]}),exports[a334_0x2b671f(0x1df)]=void 0x0;const jszip_1=__importDefault(require(a334_0x2b671f(0x22f))),promises_1=require('fs/promises'),constants_1=require(a334_0x2b671f(0x1c1)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a334_0x2b671f(0x1ff)),salesforce_service_1=require(a334_0x2b671f(0x249)),core_1=require(a334_0x2b671f(0x24f)),status_enums_1=require(a334_0x2b671f(0x251)),salesforce_dml_error_1=require(a334_0x2b671f(0x1ea)),shortid_1=__importDefault(require('shortid')),xml2js_1=require(a334_0x2b671f(0x24b)),fetch_attachments_1=require(a334_0x2b671f(0x221)),package_import_service_1=require(a334_0x2b671f(0x1f9)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a334_0x2b671f(0x233)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a334_0x2b671f(0x1dc));function a334_0x4266(_0x1d790b,_0x5b3e2c){const _0xc95c8e=a334_0x4f24();return a334_0x4266=function(_0x16161b,_0x3ee77b){_0x16161b=_0x16161b-0x1bd;let _0x4f243e=_0xc95c8e[_0x16161b];return _0x4f243e;},a334_0x4266(_0x1d790b,_0x5b3e2c);}class DeployService{constructor(_0x1b06d9,_0x10ba61,_0x4edcff,_0x23418f,_0x65d1de,_0x4420d2){const _0x40d2e6=a334_0x2b671f;this[_0x40d2e6(0x223)]=_0x10ba61,this[_0x40d2e6(0x22b)]=_0x4edcff,this[_0x40d2e6(0x265)]=_0x23418f,this[_0x40d2e6(0x25f)]=_0x65d1de,this[_0x40d2e6(0x1c8)]=_0x4420d2,this[_0x40d2e6(0x25c)]=_0x1b06d9[_0x40d2e6(0x1f5)],this[_0x40d2e6(0x1f8)]=_0x1b06d9['metadataLogId'],this[_0x40d2e6(0x206)]=_0x1b06d9[_0x40d2e6(0x1bf)],this[_0x40d2e6(0x1fb)]=_0x1b06d9[_0x40d2e6(0x214)],this[_0x40d2e6(0x1c9)]=_0x1b06d9[_0x40d2e6(0x261)],this['_organisationName']=_0x1b06d9[_0x40d2e6(0x1fd)],this[_0x40d2e6(0x236)]=_0x1b06d9[_0x40d2e6(0x222)],this[_0x40d2e6(0x23f)]=_0x1b06d9[_0x40d2e6(0x24e)],this['_systemLogger']=new core_1[(_0x40d2e6(0x1d1))](_0x40d2e6(0x216)),this[_0x40d2e6(0x1e6)]=new veeva_service_1[(_0x40d2e6(0x227))]({'connection':this[_0x40d2e6(0x22b)],'logger':this[_0x40d2e6(0x265)]}),this[_0x40d2e6(0x21e)]=new salesforce_service_1[(_0x40d2e6(0x20e))]({'connection':this['_connectionSalesforce']}),this[_0x40d2e6(0x1db)]=new package_import_service_1[(_0x40d2e6(0x1de))]({'veevaService':this['_veevaService'],'connection':this[_0x40d2e6(0x22b)],'logger':this[_0x40d2e6(0x265)],'saveLog':this[_0x40d2e6(0x213)]['bind'](this)}),this[_0x40d2e6(0x1ec)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x40d2e6(0x1e6)],'connection':this[_0x40d2e6(0x22b)],'logger':this[_0x40d2e6(0x265)]}),this[_0x40d2e6(0x202)]=new vpk_service_1[(_0x40d2e6(0x1f7))]({'connection':this[_0x40d2e6(0x22b)]});}async[a334_0x2b671f(0x208)](){const _0x1e32cd=a334_0x2b671f;try{const _0x3fc3d9=await this[_0x1e32cd(0x23e)]();await this['_logger']['updateLog'](),await this[_0x1e32cd(0x25a)](_0x3fc3d9);const _0x534be0=await this[_0x1e32cd(0x200)](_0x3fc3d9),_0x38ff4c=await this[_0x1e32cd(0x1d3)](_0x534be0),_0x1afe0e=await this['createVpk'](_0x38ff4c);await this[_0x1e32cd(0x265)]['updateLog']();const _0x186ce1=await this[_0x1e32cd(0x1db)]['import'](_0x1afe0e);await this[_0x1e32cd(0x265)][_0x1e32cd(0x252)]();const _0x4eae69=this['formFlosumDeploymentResults'](_0x3fc3d9,_0x186ce1[_0x1e32cd(0x1fa)]);await this['saveDeploymentResults'](_0x4eae69),await this[_0x1e32cd(0x243)](_0x186ce1['isDeployed'],![],_0x186ce1[_0x1e32cd(0x1be)]);}catch(_0x50df13){await this['finishDeployWithError'](_0x50df13)['catch'](_0x181b5c=>this[_0x1e32cd(0x231)][_0x1e32cd(0x20a)](_0x181b5c));}}async[a334_0x2b671f(0x23e)](){const _0x230959=a334_0x2b671f,_0x49a613=new Set(this[_0x230959(0x236)]);this[_0x230959(0x265)][_0x230959(0x268)](_0x230959(0x1eb));const _0x1eef4c=await new branch_component_history_flosum_component_retriever_1[(_0x230959(0x1d9))]({'value':this['_branchId'],'salesforceService':this['_salesforceService']})['retrieve'](),_0x451fc3=_0x1eef4c[_0x230959(0x235)](_0x519241=>_0x49a613[_0x230959(0x259)](_0x519241['id']));if(_0x451fc3[_0x230959(0x1e2)]!==this['_componentIdList'][_0x230959(0x1e2)])throw new Error(_0x230959(0x23d));return _0x451fc3;}async[a334_0x2b671f(0x25a)](_0xb3171c){const _0x1ee160=a334_0x2b671f;var _0x10d6ff;this['_logger'][_0x1ee160(0x268)](_0x1ee160(0x23a));const _0x5415b0=await new flosum_component_veeva_component_retriever_1[(_0x1ee160(0x24d))]({'value':_0xb3171c,'veevaService':this[_0x1ee160(0x1e6)],'logger':this['_logger']})[_0x1ee160(0x1d2)](),_0x24a0cc=await this['_packageExportService']['export'](_0x5415b0,'Backup');if(_0x24a0cc[_0x1ee160(0x1e2)]>0x1)throw new Error(_0x1ee160(0x1d8));(_0x10d6ff=_0x24a0cc[0x0])!==null&&_0x10d6ff!==void 0x0?_0x10d6ff:_0x24a0cc[0x0]=new jszip_1[(_0x1ee160(0x229))]();const _0x3ce180=await _0x24a0cc[0x0]['generateAsync']({'type':_0x1ee160(0x23c)});this[_0x1ee160(0x265)][_0x1ee160(0x268)]('Save\x20Backup\x20to\x20Salesforce');const _0x5ee2ce={'Body':_0x3ce180,'ContentType':_0x1ee160(0x242),'ParentId':this[_0x1ee160(0x1f8)],'Name':flosum_constants_1[_0x1ee160(0x1c6)][_0x1ee160(0x21a)]};await this[_0x1ee160(0x223)][_0x1ee160(0x1c5)](flosum_constants_1[_0x1ee160(0x1c6)][_0x1ee160(0x25d)]+_0x1ee160(0x20c),_0x5ee2ce),this[_0x1ee160(0x265)]['log']('Finish\x20Create\x20Backup');}async['retrieveAttachments'](_0x13bbad){const _0x53b221=a334_0x2b671f;this[_0x53b221(0x265)]['log']('Retrieving\x20attachments');const _0x204f94=await(0x0,fetch_attachments_1[_0x53b221(0x22a)])(this[_0x53b221(0x223)],_0x13bbad[_0x53b221(0x204)](_0x564983=>_0x564983[_0x53b221(0x1d0)])),_0x34bf34=await(0x0,fetch_attachments_1[_0x53b221(0x200)])(_0x204f94,this[_0x53b221(0x223)]);if(_0x34bf34[_0x53b221(0x1e2)]!==this['_componentIdList'][_0x53b221(0x1e2)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x34bf34[_0x53b221(0x204)](_0x30f303=>_0x30f303[_0x53b221(0x267)]['Body']);}async[a334_0x2b671f(0x1d3)](_0x4dedf3){const _0x2e9e41=a334_0x2b671f;var _0x3270f4;this[_0x2e9e41(0x265)]['log'](_0x2e9e41(0x1e1));const _0x11394b=new jszip_1['default']();for(const _0x257e5a of _0x4dedf3){const _0x2eb206=new jszip_1[(_0x2e9e41(0x229))]();await _0x2eb206[_0x2e9e41(0x215)](_0x257e5a,{'base64':!![]});for(const _0x3cbe06 in _0x2eb206[_0x2e9e41(0x209)]){const _0x17d05b=await((_0x3270f4=_0x2eb206[_0x2e9e41(0x1f3)](_0x3cbe06))===null||_0x3270f4===void 0x0?void 0x0:_0x3270f4[_0x2e9e41(0x1fc)](_0x2e9e41(0x241)));_0x17d05b&&_0x11394b[_0x2e9e41(0x1f3)](_0x3cbe06,_0x17d05b);}}const _0x29c729=new xml2js_1[(_0x2e9e41(0x1da))]({'headless':!![]}),_0x3f4c10={'vaultpackage':{'$':{'xmlns':_0x2e9e41(0x218)},'name':this[_0x2e9e41(0x23f)],'source':{'vault':undefined,'author':_0x2e9e41(0x1d5)},'packagetype':_0x2e9e41(0x244),'summary':_0x2e9e41(0x239),'description':'null'}};_0x11394b[_0x2e9e41(0x1f3)](_0x2e9e41(0x23b),_0x29c729[_0x2e9e41(0x1bd)](_0x3f4c10));const _0x4f33ee=this[_0x2e9e41(0x25f)]+'/'+(0x0,shortid_1[_0x2e9e41(0x229)])()+_0x2e9e41(0x1cd),_0x3b43f1=await _0x11394b[_0x2e9e41(0x207)]({'type':'nodebuffer'});return await(0x0,promises_1[_0x2e9e41(0x224)])(_0x4f33ee,_0x3b43f1),_0x4f33ee;}async[a334_0x2b671f(0x1ee)](_0x357537){const _0x269eb8=a334_0x2b671f;this[_0x269eb8(0x265)][_0x269eb8(0x268)]('Create\x20vpk\x20package');const _0x28077b=await this[_0x269eb8(0x202)][_0x269eb8(0x1dd)](_0x357537),_0x389e0c=this[_0x269eb8(0x25f)]+'/vpk__'+_0x357537['slice'](_0x357537[_0x269eb8(0x257)]('/')+0x1);return await(0x0,promises_1[_0x269eb8(0x224)])(_0x389e0c,_0x28077b),await this[_0x269eb8(0x202)][_0x269eb8(0x237)](_0x389e0c),_0x389e0c;}async['saveLog'](_0x2ca80b,_0x4fad71){const _0x5c517a=a334_0x2b671f;this[_0x5c517a(0x265)][_0x5c517a(0x268)](_0x5c517a(0x1e5));const _0x414ac9={'Body':Buffer['from'](_0x2ca80b)[_0x5c517a(0x20f)](_0x5c517a(0x23c)),'ContentType':_0x5c517a(0x1e8),'ParentId':this[_0x5c517a(0x1f8)],'Name':_0x4fad71};await this[_0x5c517a(0x223)][_0x5c517a(0x1c5)](flosum_constants_1['FlosumConstants'][_0x5c517a(0x25d)]+_0x5c517a(0x20c),_0x414ac9);}['formFlosumDeploymentResults'](_0x4bf381,_0x739099){const _0x4d0b28=a334_0x2b671f;this[_0x4d0b28(0x265)]['log'](_0x4d0b28(0x21b));const _0x5dd259=_0x4bf381[_0x4d0b28(0x232)]((_0x1f119f,_0x26414e)=>_0x1f119f['set']((_0x26414e[_0x4d0b28(0x1e7)]+'.'+_0x26414e[_0x4d0b28(0x1fe)])[_0x4d0b28(0x1ed)](),_0x26414e),new Map());return _0x739099[_0x4d0b28(0x204)](_0x5a78c0=>{const _0x21fd13=_0x4d0b28;this[_0x21fd13(0x265)][_0x21fd13(0x268)](_0x5a78c0['type']+'.'+_0x5a78c0['name']+_0x21fd13(0x1d4)+_0x5a78c0[_0x21fd13(0x211)]);const _0x10b6d4=(_0x5a78c0[_0x21fd13(0x225)]+'.'+_0x5a78c0[_0x21fd13(0x245)])[_0x21fd13(0x1ed)](),_0x2db2b2=_0x5dd259['get'](_0x10b6d4);return{[constants_1[_0x21fd13(0x247)]+_0x21fd13(0x203)]:_0x21fd13(0x25e),[constants_1[_0x21fd13(0x247)]+_0x21fd13(0x240)]:_0x5a78c0['status']===status_enums_1[_0x21fd13(0x1e3)]['DEPLOYED']?_0x21fd13(0x1c0):'Failure',[constants_1['FLOSUM_NAMESPACE']+_0x21fd13(0x21c)]:_0x5a78c0['deploymentAction'],[constants_1[_0x21fd13(0x247)]+_0x21fd13(0x1c7)]:_0x5a78c0[_0x21fd13(0x245)],[constants_1[_0x21fd13(0x247)]+_0x21fd13(0x24a)]:_0x5a78c0[_0x21fd13(0x225)],[constants_1[_0x21fd13(0x247)]+'Veeva_Step_Name__c']:_0x5a78c0[_0x21fd13(0x1ca)],[constants_1[_0x21fd13(0x247)]+_0x21fd13(0x1ef)]:this[_0x21fd13(0x1fb)],[constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c']:this[_0x21fd13(0x1f8)],[constants_1[_0x21fd13(0x247)]+_0x21fd13(0x264)]:_0x2db2b2[_0x21fd13(0x1d0)]};});}async[a334_0x2b671f(0x234)](_0x43e506){const _0x3518cb=a334_0x2b671f;this[_0x3518cb(0x265)][_0x3518cb(0x268)](_0x3518cb(0x256));const _0x26e46f=await this[_0x3518cb(0x21e)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+_0x3518cb(0x1c4),_0x43e506),_0x19c098=_0x26e46f[_0x3518cb(0x235)](_0x3edab1=>!_0x3edab1[_0x3518cb(0x1cc)])[_0x3518cb(0x204)](_0x19bbf0=>_0x19bbf0[_0x3518cb(0x226)])[_0x3518cb(0x22d)]();if(_0x19c098[_0x3518cb(0x1e2)])throw new salesforce_dml_error_1[(_0x3518cb(0x205))](_0x19c098);}async[a334_0x2b671f(0x253)](_0x43970e){const _0x7848b9=a334_0x2b671f;this[_0x7848b9(0x265)][_0x7848b9(0x248)](_0x43970e),await this['_logger'][_0x7848b9(0x252)](),await this[_0x7848b9(0x243)](![],!![],'');}async[a334_0x2b671f(0x243)](_0x5ac2ad,_0x370748,_0x22ff7b){const _0x2be466=a334_0x2b671f,_0x2c255d='<a\x20href='+this['_instanceUrl']+'/'+this[_0x2be466(0x1f8)]+'\x20>\x20'+'Veeva\x20Deployment'+_0x2be466(0x201),_0x1fa88f=_0x2be466(0x258)+this[_0x2be466(0x1c8)]+'/'+this[_0x2be466(0x1fb)]+'\x20>'+this[_0x2be466(0x1f2)]+'</a>',_0x4ec1b6=_0x2c255d+_0x2be466(0x1f6)+_0x1fa88f+'\x20has\x20been\x20created.',_0xf8da99={[constants_1[_0x2be466(0x247)]+_0x2be466(0x210)]:_0x4ec1b6,[constants_1['FLOSUM_NAMESPACE']+'Date__c']:new Date(),[constants_1[_0x2be466(0x247)]+_0x2be466(0x266)]:this[_0x2be466(0x25c)],[constants_1['FLOSUM_NAMESPACE']+_0x2be466(0x20b)]:_0x2be466(0x1f1),[constants_1['FLOSUM_NAMESPACE']+_0x2be466(0x260)]:_0x2be466(0x1ce),[constants_1[_0x2be466(0x247)]+'TargetId__c']:this['_organisationId']},_0x79791f={[constants_1[_0x2be466(0x247)]+_0x2be466(0x20d)]:!_0x5ac2ad,[constants_1[_0x2be466(0x247)]+_0x2be466(0x212)]:_0x5ac2ad,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x370748?status_enums_1[_0x2be466(0x1e9)][_0x2be466(0x1e4)]:status_enums_1['MetadataLogStatus'][_0x2be466(0x246)],[constants_1[_0x2be466(0x247)]+_0x2be466(0x22e)]:!![],[constants_1[_0x2be466(0x247)]+_0x2be466(0x22c)]:_0x22ff7b};await this['_connectionSalesforce'][_0x2be466(0x1f0)](flosum_constants_1[_0x2be466(0x1c6)][_0x2be466(0x25d)]+'/'+constants_1[_0x2be466(0x247)]+_0x2be466(0x1cf)+this[_0x2be466(0x1f8)],_0x79791f),await this[_0x2be466(0x223)]['post'](flosum_constants_1[_0x2be466(0x1c6)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x2be466(0x247)]+_0x2be466(0x255),_0xf8da99),this[_0x2be466(0x265)][_0x2be466(0x268)](_0x2be466(0x228)+(_0x5ac2ad?_0x2be466(0x263):_0x2be466(0x250))+'.'),await this['_logger']['updateLog']();}}exports[a334_0x2b671f(0x1df)]=DeployService;