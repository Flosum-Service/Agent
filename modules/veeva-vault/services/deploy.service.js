function a357_0x2b36(){const _0xe2c69a=['_timeZone','BranchComponentHistoryFlosumComponentRetriever','DEPLOYED','_packageImportService','\x20:\x20','_attachmentLogId','_organisationId','(((.+)+)+)+$','Component_History__c','Job_Completed__c','_tempFolder','_systemLogger','_logger','_branchId','execute','1642842utYOml','./package-import.service','Deployment\x20Result','_componentIdList','Branch__c','success','PackageExportService','componentHistoryId','saveDeploymentResults','map','Retrieving\x20attachments','../classes/errors/salesforce-dml-error','metadataLogId','toString','1310lldpCq','getFlosumComponents','createVpk','_organisationName','Body','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Save\x20Deployment\x20Results','saveBackup','export','logError','../../../core','Create\x20Backup','__esModule','MetadataLogStatus','defineProperty','componentType','fetchAttachmentsDetailsByParentId','Succeed__c','toLowerCase','35OKIlwu','componentName','Action__c','base64','_deploymentName','constructor','jszip','219PNmdyk','retrieveAttachments','get','Success','Join\x20all\x20mdl\x20into\x20one\x20zip','generate','writeFile','values','saveLog','_connectionSalesforce','Async_Request_Id__c','./salesforce.service','./package-export.service','updateLog','deploymentName','Branch','deploymentAction','Logger','../../shared/utils/fetch-attachments','stepName','EXCEPTION','FLOSUM_NAMESPACE','1633285xCKhlZ','with\x20error','Type__c','<a\x20href=','log','COMPLETED','Metadata_Log__c/','set','108jhWlqR','successfully','organisationId','lastIndexOf','veeva-deploy','patch','Retrieving\x20components','apply','finishDeployWithError','formFlosumDeploymentResults','ZipCreatorDeploy','../../../constants','retrieve','1056627ZFAIfs','post','errors','packageComponentList','createZip','_instanceUrl','Result__c','search','501656bgXvVj','length','Cannot\x20retrieve\x20all\x20components.','error','Status__c','from','./veeva.service','_packageExportService','organisationName','../classes/deploy/zip-creator.deploy','/Attachment','Create\x20vpk\x20package','Cannot\x20retrievers\x20all\x20attachments','type','Backup','Save\x20log','PackageImportService','\x20>\x20','Activity_Item__c','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','_veevaService','ENDPOINT_UPSERT_RECORD','createBackup','DeployService','Activity_Type__c','packageId','../constants/flosum.constants','isDeployed','branchId','/vpk__','Veeva\x20Deployment','name','2644lDcWiD','fs/promises','Is_Error__c','status','FlosumComponentVeevaComponentRetriever','_vpkService','Deployment_Result__c','\x20of\x20branch\x20to\x20Organization\x20','_connectionVeeva','import','catch','Org__c','generateAsync','default','35253CMPVmw','12zGxbSL','insertMultipleRecords','__importDefault','../enums/status.enums','_metadataLogId','\x20</a>','FlosumConstants','86492UoFljA','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','filter','finishDeploy','Log__c','Metadata_Log__c','slice'];a357_0x2b36=function(){return _0xe2c69a;};return a357_0x2b36();}const a357_0x3de773=a357_0x5a3e;(function(_0x1c6bd4,_0x4e2e1e){const _0x1ddfb6=a357_0x5a3e,_0x37cb9e=_0x1c6bd4();while(!![]){try{const _0x1bbcff=-parseInt(_0x1ddfb6(0x1b1))/0x1*(parseInt(_0x1ddfb6(0x204))/0x2)+parseInt(_0x1ddfb6(0x16c))/0x3*(-parseInt(_0x1ddfb6(0x173))/0x4)+parseInt(_0x1ddfb6(0x1c7))/0x5+-parseInt(_0x1ddfb6(0x189))/0x6+parseInt(_0x1ddfb6(0x1aa))/0x7*(parseInt(_0x1ddfb6(0x1e4))/0x8)+parseInt(_0x1ddfb6(0x16b))/0x9*(-parseInt(_0x1ddfb6(0x197))/0xa)+-parseInt(_0x1ddfb6(0x1dc))/0xb*(-parseInt(_0x1ddfb6(0x1cf))/0xc);if(_0x1bbcff===_0x4e2e1e)break;else _0x37cb9e['push'](_0x37cb9e['shift']());}catch(_0x300aa7){_0x37cb9e['push'](_0x37cb9e['shift']());}}}(a357_0x2b36,0x53701));const a357_0x8e2a87=(function(){let _0x4ca2ce=!![];return function(_0x509f29,_0x3889ef){const _0x4bbb12=_0x4ca2ce?function(){const _0xf23776=a357_0x5a3e;if(_0x3889ef){const _0x4dde7a=_0x3889ef[_0xf23776(0x1d6)](_0x509f29,arguments);return _0x3889ef=null,_0x4dde7a;}}:function(){};return _0x4ca2ce=![],_0x4bbb12;};}()),a357_0x1046be=a357_0x8e2a87(this,function(){const _0x334a98=a357_0x5a3e;return a357_0x1046be[_0x334a98(0x196)]()[_0x334a98(0x1e3)](_0x334a98(0x181))[_0x334a98(0x196)]()[_0x334a98(0x1af)](a357_0x1046be)[_0x334a98(0x1e3)]('(((.+)+)+)+$');});a357_0x1046be();'use strict';var __importDefault=this&&this[a357_0x3de773(0x16e)]||function(_0x45f327){const _0x45f1ab=a357_0x3de773;return _0x45f327&&_0x45f327[_0x45f1ab(0x1a3)]?_0x45f327:{'default':_0x45f327};};Object[a357_0x3de773(0x1a5)](exports,a357_0x3de773(0x1a3),{'value':!![]}),exports['DeployService']=void 0x0;function a357_0x5a3e(_0x195724,_0x278e2c){const _0x575ed8=a357_0x2b36();return a357_0x5a3e=function(_0x1046be,_0x8e2a87){_0x1046be=_0x1046be-0x165;let _0x2b36e8=_0x575ed8[_0x1046be];return _0x2b36e8;},a357_0x5a3e(_0x195724,_0x278e2c);}const jszip_1=__importDefault(require(a357_0x3de773(0x1b0))),promises_1=require(a357_0x3de773(0x205)),constants_1=require(a357_0x3de773(0x1da)),flosum_constants_1=require(a357_0x3de773(0x1fe)),veeva_service_1=require(a357_0x3de773(0x1ea)),salesforce_service_1=require(a357_0x3de773(0x1bc)),core_1=require(a357_0x3de773(0x1a1)),status_enums_1=require(a357_0x3de773(0x16f)),salesforce_dml_error_1=require(a357_0x3de773(0x194)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require(a357_0x3de773(0x1c3)),package_import_service_1=require(a357_0x3de773(0x18a)),branch_component_history_flosum_component_retriever_1=require(a357_0x3de773(0x1f7)),flosum_component_veeva_component_retriever_1=require(a357_0x3de773(0x174)),package_export_service_1=require(a357_0x3de773(0x1bd)),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require(a357_0x3de773(0x1ed));class DeployService{constructor(_0x14fbcb,_0x29be4d,_0x1a06c4,_0x40f349,_0x9ae42b,_0x417515){const _0x26201d=a357_0x3de773;this[_0x26201d(0x1ba)]=_0x29be4d,this['_connectionVeeva']=_0x1a06c4,this['_logger']=_0x40f349,this['_tempFolder']=_0x9ae42b,this['_instanceUrl']=_0x417515,this[_0x26201d(0x187)]=_0x14fbcb[_0x26201d(0x200)],this['_metadataLogId']=_0x14fbcb[_0x26201d(0x195)],this[_0x26201d(0x17f)]=_0x14fbcb['attachmentLogId'],this['_organisationId']=_0x14fbcb[_0x26201d(0x1d1)],this[_0x26201d(0x17a)]=_0x14fbcb['timeZone'],this[_0x26201d(0x19a)]=_0x14fbcb[_0x26201d(0x1ec)],this[_0x26201d(0x18c)]=_0x14fbcb['componentIdList'],this[_0x26201d(0x1ae)]=_0x14fbcb[_0x26201d(0x1bf)],this[_0x26201d(0x185)]=new core_1[(_0x26201d(0x1c2))](_0x26201d(0x1d3)),this[_0x26201d(0x1f8)]=new veeva_service_1['VeevaService']({'connection':this[_0x26201d(0x165)],'logger':this[_0x26201d(0x186)]}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':this['_connectionSalesforce']}),this[_0x26201d(0x17d)]=new package_import_service_1[(_0x26201d(0x1f4))]({'veevaService':this[_0x26201d(0x1f8)],'connection':this[_0x26201d(0x165)],'logger':this[_0x26201d(0x186)],'saveLog':this[_0x26201d(0x1b9)]['bind'](this)}),this[_0x26201d(0x1eb)]=new package_export_service_1[(_0x26201d(0x18f))]({'veevaService':this[_0x26201d(0x1f8)],'connection':this[_0x26201d(0x165)],'logger':this[_0x26201d(0x186)]}),this[_0x26201d(0x209)]=new vpk_service_1['VpkService']({'connection':this[_0x26201d(0x165)]});}async[a357_0x3de773(0x188)](){const _0x4b5566=a357_0x3de773;try{const _0x993097=await this[_0x4b5566(0x198)]();await this['_logger'][_0x4b5566(0x1be)]();const _0x4afcc4=await this[_0x4b5566(0x1fa)](_0x993097);await this[_0x4b5566(0x19e)](_0x4afcc4);const _0x2c5f28=await this[_0x4b5566(0x1b2)](_0x993097),_0x3f0456=await this[_0x4b5566(0x1e0)](_0x2c5f28),_0x2a1c15=await this['createVpk'](_0x3f0456);await this[_0x4b5566(0x186)]['updateLog']();const _0x1f5169=await this[_0x4b5566(0x17d)][_0x4b5566(0x166)](_0x2a1c15);await this['_logger'][_0x4b5566(0x1be)]();const _0x6852d8=this[_0x4b5566(0x1d8)](_0x993097,_0x1f5169[_0x4b5566(0x1df)]);await this[_0x4b5566(0x191)](_0x6852d8),await this[_0x4b5566(0x176)](_0x1f5169[_0x4b5566(0x1ff)],![],_0x1f5169[_0x4b5566(0x1fd)]);}catch(_0x29789c){await this[_0x4b5566(0x1d7)](_0x29789c)[_0x4b5566(0x167)](_0x1fa024=>this[_0x4b5566(0x185)][_0x4b5566(0x1e7)](_0x1fa024));}}async[a357_0x3de773(0x198)](){const _0x32d56e=a357_0x3de773,_0x69983=new Set(this['_componentIdList']);this[_0x32d56e(0x186)][_0x32d56e(0x1cb)](_0x32d56e(0x1d5));const _0x1d9b7b=await new branch_component_history_flosum_component_retriever_1[(_0x32d56e(0x17b))]({'value':this[_0x32d56e(0x187)],'salesforceService':this['_salesforceService']})[_0x32d56e(0x1db)](),_0x450d41=_0x1d9b7b[_0x32d56e(0x175)](_0x4104d5=>_0x69983['has'](_0x4104d5['id']));if(_0x450d41[_0x32d56e(0x1e5)]!==this[_0x32d56e(0x18c)][_0x32d56e(0x1e5)])throw new Error(_0x32d56e(0x1e6));return _0x450d41;}async['createBackup'](_0x332210){const _0x2137f6=a357_0x3de773;var _0x575f91;this[_0x2137f6(0x186)][_0x2137f6(0x1cb)](_0x2137f6(0x1a2));const _0xd08662=await new flosum_component_veeva_component_retriever_1[(_0x2137f6(0x208))]({'value':_0x332210,'veevaService':this['_veevaService'],'logger':this[_0x2137f6(0x186)]})[_0x2137f6(0x1db)](),_0x215950=await this[_0x2137f6(0x1eb)][_0x2137f6(0x19f)](_0xd08662,_0x2137f6(0x1f2));if(_0x215950[_0x2137f6(0x1e5)]>0x1)throw new Error(_0x2137f6(0x19c));return(_0x575f91=_0x215950[0x0])!==null&&_0x575f91!==void 0x0?_0x575f91:_0x215950[0x0]=new jszip_1['default'](),_0x215950[0x0][_0x2137f6(0x169)]({'type':'base64'});}async[a357_0x3de773(0x19e)](_0x33a37c){const _0x5153c0=a357_0x3de773;this[_0x5153c0(0x186)][_0x5153c0(0x1cb)]('Save\x20Backup\x20to\x20Salesforce');const _0x46ebf5={'Body':_0x33a37c,'ContentType':'application/zip','ParentId':this[_0x5153c0(0x170)],'Name':flosum_constants_1[_0x5153c0(0x172)]['BACKUP_ZIP_NAME']};await this[_0x5153c0(0x1ba)][_0x5153c0(0x1dd)](flosum_constants_1['FlosumConstants'][_0x5153c0(0x1f9)]+_0x5153c0(0x1ee),_0x46ebf5);}async['retrieveAttachments'](_0x363dcc){const _0x55a902=a357_0x3de773;this[_0x55a902(0x186)]['log'](_0x55a902(0x193));const _0x3c2e42=await(0x0,fetch_attachments_1[_0x55a902(0x1a7)])(this['_connectionSalesforce'],_0x363dcc[_0x55a902(0x192)](_0x3c02d6=>_0x3c02d6['componentHistoryId'])),_0x18521a=await(0x0,fetch_attachments_1[_0x55a902(0x1b2)])(_0x3c2e42,this[_0x55a902(0x1ba)]);if(_0x18521a[_0x55a902(0x1e5)]!==this[_0x55a902(0x18c)][_0x55a902(0x1e5)])throw new Error(_0x55a902(0x1f0));return _0x18521a['map'](_0x2882fe=>_0x2882fe[_0x55a902(0x1b8)][_0x55a902(0x19b)]);}async[a357_0x3de773(0x1e0)](_0x59e2a6){const _0x40c77c=a357_0x3de773;this['_logger'][_0x40c77c(0x1cb)](_0x40c77c(0x1b5));const _0x4b6292=await new zip_creator_deploy_1[(_0x40c77c(0x1d9))]({'attachmentBodies':_0x59e2a6,'deploymentName':this[_0x40c77c(0x1ae)]})[_0x40c77c(0x188)](),_0x529da6=this[_0x40c77c(0x184)]+'/'+(0x0,shortid_1[_0x40c77c(0x16a)])()+'.zip';return await(0x0,promises_1['writeFile'])(_0x529da6,_0x4b6292),_0x529da6;}async[a357_0x3de773(0x199)](_0x849e0a){const _0x3e1f01=a357_0x3de773;this[_0x3e1f01(0x186)][_0x3e1f01(0x1cb)](_0x3e1f01(0x1ef));const _0x2f5d22=await this['_vpkService'][_0x3e1f01(0x1b6)](_0x849e0a),_0x34e445=this[_0x3e1f01(0x184)]+_0x3e1f01(0x201)+_0x849e0a[_0x3e1f01(0x179)](_0x849e0a[_0x3e1f01(0x1d2)]('/')+0x1);return await(0x0,promises_1[_0x3e1f01(0x1b7)])(_0x34e445,_0x2f5d22),await this['_vpkService']['validate'](_0x34e445),_0x34e445;}async[a357_0x3de773(0x1b9)](_0x3fc3b2,_0x511629){const _0x186e9c=a357_0x3de773;this[_0x186e9c(0x186)][_0x186e9c(0x1cb)](_0x186e9c(0x1f3));const _0xa88301={'Body':Buffer[_0x186e9c(0x1e9)](_0x3fc3b2)['toString'](_0x186e9c(0x1ad)),'ContentType':'text/plain','ParentId':this[_0x186e9c(0x170)],'Name':_0x511629};await this['_connectionSalesforce'][_0x186e9c(0x1dd)](flosum_constants_1[_0x186e9c(0x172)][_0x186e9c(0x1f9)]+_0x186e9c(0x1ee),_0xa88301);}[a357_0x3de773(0x1d8)](_0x38f185,_0x295a5f){const _0x15abe9=a357_0x3de773;this[_0x15abe9(0x186)][_0x15abe9(0x1cb)]('Form\x20Deployment\x20Results');const _0x378ef7=_0x38f185['reduce']((_0x464782,_0x1c66e4)=>_0x464782[_0x15abe9(0x1ce)]((_0x1c66e4[_0x15abe9(0x1a6)]+'.'+_0x1c66e4[_0x15abe9(0x1ab)])[_0x15abe9(0x1a9)](),_0x1c66e4),new Map());return _0x295a5f['map'](_0x5b5be8=>{const _0x3b4d03=_0x15abe9;this[_0x3b4d03(0x186)]['log'](_0x5b5be8[_0x3b4d03(0x1f1)]+'.'+_0x5b5be8[_0x3b4d03(0x203)]+_0x3b4d03(0x17e)+_0x5b5be8[_0x3b4d03(0x207)]);const _0x517441=(_0x5b5be8[_0x3b4d03(0x1f1)]+'.'+_0x5b5be8[_0x3b4d03(0x203)])['toLowerCase'](),_0x47301d=_0x378ef7[_0x3b4d03(0x1b3)](_0x517441);return{[constants_1[_0x3b4d03(0x1c6)]+_0x3b4d03(0x1c9)]:_0x3b4d03(0x18b),[constants_1[_0x3b4d03(0x1c6)]+_0x3b4d03(0x1e8)]:_0x5b5be8[_0x3b4d03(0x207)]===status_enums_1['PackageComponentStatus'][_0x3b4d03(0x17c)]?_0x3b4d03(0x1b4):'Failure',[constants_1[_0x3b4d03(0x1c6)]+_0x3b4d03(0x1e2)]:_0x5b5be8[_0x3b4d03(0x1c1)],[constants_1[_0x3b4d03(0x1c6)]+'Component_Name__c']:_0x5b5be8[_0x3b4d03(0x203)],[constants_1[_0x3b4d03(0x1c6)]+'Component_Type__c']:_0x5b5be8[_0x3b4d03(0x1f1)],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Step_Name__c']:_0x5b5be8[_0x3b4d03(0x1c4)],[constants_1[_0x3b4d03(0x1c6)]+_0x3b4d03(0x168)]:this[_0x3b4d03(0x180)],[constants_1[_0x3b4d03(0x1c6)]+_0x3b4d03(0x178)]:this[_0x3b4d03(0x170)],[constants_1[_0x3b4d03(0x1c6)]+_0x3b4d03(0x182)]:_0x47301d[_0x3b4d03(0x190)]};});}async['saveDeploymentResults'](_0x57af64){const _0x1fa482=a357_0x3de773;this['_logger'][_0x1fa482(0x1cb)](_0x1fa482(0x19d));const _0x46181f=await this['_salesforceService'][_0x1fa482(0x16d)](constants_1[_0x1fa482(0x1c6)]+_0x1fa482(0x20a),_0x57af64),_0x2c1025=_0x46181f['filter'](_0x274722=>!_0x274722[_0x1fa482(0x18e)])[_0x1fa482(0x192)](_0x162e57=>_0x162e57[_0x1fa482(0x1de)])['flat']();if(_0x2c1025['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x2c1025);}async[a357_0x3de773(0x1d7)](_0x3d5f47){const _0x105f0a=a357_0x3de773;this[_0x105f0a(0x186)][_0x105f0a(0x1a0)](_0x3d5f47),await this['_logger'][_0x105f0a(0x1be)](),await this[_0x105f0a(0x176)](![],!![],'');}async['finishDeploy'](_0x28b7fd,_0x17c65e,_0x44543a){const _0x54c71e=a357_0x3de773,_0x5d61e9=_0x54c71e(0x1ca)+this[_0x54c71e(0x1e1)]+'/'+this[_0x54c71e(0x170)]+_0x54c71e(0x1f5)+_0x54c71e(0x202)+_0x54c71e(0x171),_0x2d36f6=_0x54c71e(0x1ca)+this[_0x54c71e(0x1e1)]+'/'+this[_0x54c71e(0x180)]+'\x20>'+this[_0x54c71e(0x19a)]+'</a>',_0x224d93=_0x5d61e9+_0x54c71e(0x20b)+_0x2d36f6+'\x20has\x20been\x20created.',_0x45ad61={[constants_1['FLOSUM_NAMESPACE']+_0x54c71e(0x1ac)]:_0x224d93,[constants_1[_0x54c71e(0x1c6)]+'Date__c']:new Date(),[constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x18d)]:this[_0x54c71e(0x187)],[constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x1f6)]:_0x54c71e(0x1c0),[constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x1fc)]:'Deployment',[constants_1[_0x54c71e(0x1c6)]+'TargetId__c']:this[_0x54c71e(0x180)]},_0x4b4def={[constants_1['FLOSUM_NAMESPACE']+_0x54c71e(0x206)]:!_0x28b7fd,[constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x1a8)]:_0x28b7fd,[constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x1e8)]:_0x17c65e?status_enums_1[_0x54c71e(0x1a4)][_0x54c71e(0x1c5)]:status_enums_1[_0x54c71e(0x1a4)][_0x54c71e(0x1cc)],[constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x183)]:!![],[constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x1bb)]:_0x44543a};await this[_0x54c71e(0x1ba)][_0x54c71e(0x1d4)](flosum_constants_1['FlosumConstants'][_0x54c71e(0x1f9)]+'/'+constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x1cd)+this[_0x54c71e(0x170)],_0x4b4def),await this[_0x54c71e(0x1ba)][_0x54c71e(0x1dd)](flosum_constants_1['FlosumConstants'][_0x54c71e(0x1f9)]+'/'+constants_1[_0x54c71e(0x1c6)]+_0x54c71e(0x177),_0x45ad61),this[_0x54c71e(0x186)][_0x54c71e(0x1cb)]('Deploy\x20completed\x20'+(_0x28b7fd?_0x54c71e(0x1d0):_0x54c71e(0x1c8))+'.'),await this[_0x54c71e(0x186)][_0x54c71e(0x1be)]();}}exports[a357_0x3de773(0x1fb)]=DeployService;