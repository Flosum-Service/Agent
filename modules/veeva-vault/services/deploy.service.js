const a358_0x35865e=a358_0x57a2;function a358_0x5b4a(){const _0x208fac=['PackageComponentStatus','finishDeploy','catch','ENDPOINT_UPSERT_RECORD','toLowerCase','Component_History__c','3154976BnKKEj','default','veeva-deploy','VeevaService','PackageExportService','organisationId','execute','_deploymentName','<a\x20href=','flat','SalesforceService','metadataLogId','DEPLOYED','FlosumComponentVeevaComponentRetriever','successfully','8213176ZIdSnp','retrieve','_vpkService','Failure','Deployment_Result__c','./veeva.service','1382385fyaYIZ','TargetId__c','_connectionVeeva','_connectionSalesforce','log','Deploy\x20completed\x20','slice','Create\x20vpk\x20package','489770IbiraV','.zip','bind','Body','_salesforceService','import','writeFile','post','(((.+)+)+)+$','createBackup','set','componentHistoryId','Veeva\x20Deployment','search','_logger','Branch__c','saveBackup','Cannot\x20retrieve\x20all\x20components.','\x20>\x20','__esModule','_timeZone','Component_Name__c','VpkService','207430ncUcYg','export','SalesforceDmlError','Org__c','../constants/flosum.constants','FlosumConstants','6293441ZUIjvx','Deployment\x20Result','Logger','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','generate','saveLog','Status__c','388040SnoLOd','stepName','fetchAttachmentsDetailsByParentId','packageComponentList','</a>','Type__c','Cannot\x20Backup\x20more\x20than\x20200\x20components.','_attachmentLogId','_metadataLogId','logError','finishDeployWithError','Backup','componentType','FLOSUM_NAMESPACE','Retrieving\x20components','/vpk__','formFlosumDeploymentResults','filter','deploymentAction','./vpk.service','Activity_Item__c','patch','with\x20error','COMPLETED','_packageImportService','\x20:\x20','defineProperty','_systemLogger','type','shortid','BACKUP_ZIP_NAME','getFlosumComponents','Date__c','2124OnwjFz','errors','Join\x20all\x20mdl\x20into\x20one\x20zip','_veevaService','has','Metadata_Log__c','name','map','Retrieving\x20attachments','branchId','Save\x20Backup\x20to\x20Salesforce','2AysunK','_packageExportService','Success','54qOtpgQ','../../../core','./package-export.service','_organisationName','Deployment','Action__c','\x20of\x20branch\x20to\x20Organization\x20','text/plain','_branchId','Veeva_Step_Name__c','_organisationId','Form\x20Deployment\x20Results','Activity_Type__c','updateLog','organisationName','createZip','Is_Error__c','values','_componentIdList','External_Deployment_Id__c','ZipCreatorDeploy','_instanceUrl','toString','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Save\x20Deployment\x20Results','error','MetadataLogStatus','Component_Type__c','reduce','Cannot\x20retrievers\x20all\x20attachments','jszip','DeployService','saveDeploymentResults','../classes/errors/salesforce-dml-error','length','Log__c','status','attachmentLogId','base64','constructor','_tempFolder','retrieveAttachments','success','componentName'];a358_0x5b4a=function(){return _0x208fac;};return a358_0x5b4a();}(function(_0x2a1d40,_0x5174ad){const _0x4ae097=a358_0x57a2,_0xee075d=_0x2a1d40();while(!![]){try{const _0x52254e=-parseInt(_0x4ae097(0x22a))/0x1+parseInt(_0x4ae097(0x1d8))/0x2*(-parseInt(_0x4ae097(0x222))/0x3)+-parseInt(_0x4ae097(0x20d))/0x4+-parseInt(_0x4ae097(0x24e))/0x5*(parseInt(_0x4ae097(0x1db))/0x6)+-parseInt(_0x4ae097(0x247))/0x7+-parseInt(_0x4ae097(0x21c))/0x8+parseInt(_0x4ae097(0x1cd))/0x9*(parseInt(_0x4ae097(0x241))/0xa);if(_0x52254e===_0x5174ad)break;else _0xee075d['push'](_0xee075d['shift']());}catch(_0x596913){_0xee075d['push'](_0xee075d['shift']());}}}(a358_0x5b4a,0x81d91));const a358_0x25052f=(function(){let _0x3bf7fc=!![];return function(_0xd261,_0xb28848){const _0x59043e=_0x3bf7fc?function(){if(_0xb28848){const _0x2c1329=_0xb28848['apply'](_0xd261,arguments);return _0xb28848=null,_0x2c1329;}}:function(){};return _0x3bf7fc=![],_0x59043e;};}()),a358_0x1ed4c7=a358_0x25052f(this,function(){const _0x51c21f=a358_0x57a2;return a358_0x1ed4c7[_0x51c21f(0x1f1)]()[_0x51c21f(0x237)](_0x51c21f(0x232))[_0x51c21f(0x1f1)]()[_0x51c21f(0x202)](a358_0x1ed4c7)[_0x51c21f(0x237)](_0x51c21f(0x232));});a358_0x1ed4c7();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x5e3b41){return _0x5e3b41&&_0x5e3b41['__esModule']?_0x5e3b41:{'default':_0x5e3b41};};Object[a358_0x35865e(0x268)](exports,a358_0x35865e(0x23d),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a358_0x35865e(0x1f9))),promises_1=require('fs/promises'),constants_1=require('../../../constants'),flosum_constants_1=require(a358_0x35865e(0x245)),veeva_service_1=require(a358_0x35865e(0x221)),salesforce_service_1=require('./salesforce.service'),core_1=require(a358_0x35865e(0x1dc)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a358_0x35865e(0x1fc)),shortid_1=__importDefault(require(a358_0x35865e(0x26b))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a358_0x35865e(0x24a)),flosum_component_veeva_component_retriever_1=require(a358_0x35865e(0x1f2)),package_export_service_1=require(a358_0x35865e(0x1dd)),vpk_service_1=require(a358_0x35865e(0x261)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');function a358_0x57a2(_0x5663a9,_0x2edfb4){const _0x1d677b=a358_0x5b4a();return a358_0x57a2=function(_0x1ed4c7,_0x25052f){_0x1ed4c7=_0x1ed4c7-0x1cc;let _0x5b4af9=_0x1d677b[_0x1ed4c7];return _0x5b4af9;},a358_0x57a2(_0x5663a9,_0x2edfb4);}class DeployService{constructor(_0x3cf84e,_0x1c62ce,_0x155d4b,_0x80fe90,_0x53b7d6,_0x17d335){const _0x191ebe=a358_0x35865e;this['_connectionSalesforce']=_0x1c62ce,this[_0x191ebe(0x224)]=_0x155d4b,this[_0x191ebe(0x238)]=_0x80fe90,this['_tempFolder']=_0x53b7d6,this[_0x191ebe(0x1f0)]=_0x17d335,this[_0x191ebe(0x1e3)]=_0x3cf84e[_0x191ebe(0x1d6)],this[_0x191ebe(0x256)]=_0x3cf84e[_0x191ebe(0x218)],this[_0x191ebe(0x255)]=_0x3cf84e[_0x191ebe(0x200)],this[_0x191ebe(0x1e5)]=_0x3cf84e[_0x191ebe(0x212)],this[_0x191ebe(0x23e)]=_0x3cf84e['timeZone'],this[_0x191ebe(0x1de)]=_0x3cf84e[_0x191ebe(0x1e9)],this['_componentIdList']=_0x3cf84e['componentIdList'],this['_deploymentName']=_0x3cf84e['deploymentName'],this[_0x191ebe(0x269)]=new core_1[(_0x191ebe(0x249))](_0x191ebe(0x20f)),this[_0x191ebe(0x1d0)]=new veeva_service_1[(_0x191ebe(0x210))]({'connection':this['_connectionVeeva'],'logger':this[_0x191ebe(0x238)]}),this[_0x191ebe(0x22e)]=new salesforce_service_1[(_0x191ebe(0x217))]({'connection':this[_0x191ebe(0x225)]}),this[_0x191ebe(0x266)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x191ebe(0x1d0)],'connection':this[_0x191ebe(0x224)],'logger':this[_0x191ebe(0x238)],'saveLog':this['saveLog'][_0x191ebe(0x22c)](this)}),this['_packageExportService']=new package_export_service_1[(_0x191ebe(0x211))]({'veevaService':this[_0x191ebe(0x1d0)],'connection':this[_0x191ebe(0x224)],'logger':this[_0x191ebe(0x238)]}),this[_0x191ebe(0x21e)]=new vpk_service_1[(_0x191ebe(0x240))]({'connection':this['_connectionVeeva']});}async[a358_0x35865e(0x213)](){const _0x101e43=a358_0x35865e;try{const _0x496d04=await this[_0x101e43(0x26d)]();await this[_0x101e43(0x238)]['updateLog']();const _0x2e258d=await this['createBackup'](_0x496d04);await this[_0x101e43(0x23a)](_0x2e258d);const _0x28d949=await this[_0x101e43(0x204)](_0x496d04),_0x44945b=await this[_0x101e43(0x1ea)](_0x28d949),_0x1c8236=await this['createVpk'](_0x44945b);await this[_0x101e43(0x238)][_0x101e43(0x1e8)]();const _0x369a05=await this['_packageImportService'][_0x101e43(0x22f)](_0x1c8236);await this[_0x101e43(0x238)][_0x101e43(0x1e8)]();const _0x29cb47=this[_0x101e43(0x25e)](_0x496d04,_0x369a05[_0x101e43(0x251)]);await this[_0x101e43(0x1fb)](_0x29cb47),await this[_0x101e43(0x208)](_0x369a05['isDeployed'],![],_0x369a05['packageId']);}catch(_0x30eda6){await this[_0x101e43(0x258)](_0x30eda6)[_0x101e43(0x209)](_0x3ce605=>this[_0x101e43(0x269)][_0x101e43(0x1f4)](_0x3ce605));}}async[a358_0x35865e(0x26d)](){const _0x192464=a358_0x35865e,_0x410e14=new Set(this['_componentIdList']);this[_0x192464(0x238)][_0x192464(0x226)](_0x192464(0x25c));const _0x2dce9c=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x192464(0x1e3)],'salesforceService':this[_0x192464(0x22e)]})[_0x192464(0x21d)](),_0x5adb6b=_0x2dce9c[_0x192464(0x25f)](_0x7a6c6a=>_0x410e14[_0x192464(0x1d1)](_0x7a6c6a['id']));if(_0x5adb6b[_0x192464(0x1fd)]!==this[_0x192464(0x1ed)][_0x192464(0x1fd)])throw new Error(_0x192464(0x23b));return _0x5adb6b;}async[a358_0x35865e(0x233)](_0x38e3fa){const _0x305f7c=a358_0x35865e;var _0x3409d;this['_logger'][_0x305f7c(0x226)]('Create\x20Backup');const _0x1471bc=await new flosum_component_veeva_component_retriever_1[(_0x305f7c(0x21a))]({'value':_0x38e3fa,'veevaService':this[_0x305f7c(0x1d0)],'logger':this['_logger']})[_0x305f7c(0x21d)](),_0x941da=await this[_0x305f7c(0x1d9)][_0x305f7c(0x242)](_0x1471bc,_0x305f7c(0x259));if(_0x941da[_0x305f7c(0x1fd)]>0x1)throw new Error(_0x305f7c(0x254));return(_0x3409d=_0x941da[0x0])!==null&&_0x3409d!==void 0x0?_0x3409d:_0x941da[0x0]=new jszip_1[(_0x305f7c(0x20e))](),_0x941da[0x0]['generateAsync']({'type':_0x305f7c(0x201)});}async['saveBackup'](_0x539536){const _0xe1c839=a358_0x35865e;this[_0xe1c839(0x238)]['log'](_0xe1c839(0x1d7));const _0x434b3a={'Body':_0x539536,'ContentType':'application/zip','ParentId':this[_0xe1c839(0x256)],'Name':flosum_constants_1[_0xe1c839(0x246)][_0xe1c839(0x26c)]};await this[_0xe1c839(0x225)][_0xe1c839(0x231)](flosum_constants_1[_0xe1c839(0x246)][_0xe1c839(0x20a)]+'/Attachment',_0x434b3a);}async[a358_0x35865e(0x204)](_0x256e9e){const _0x4f791e=a358_0x35865e;this[_0x4f791e(0x238)][_0x4f791e(0x226)](_0x4f791e(0x1d5));const _0x2e5277=await(0x0,fetch_attachments_1[_0x4f791e(0x250)])(this[_0x4f791e(0x225)],_0x256e9e[_0x4f791e(0x1d4)](_0x55355b=>_0x55355b['componentHistoryId'])),_0x5d2dfd=await(0x0,fetch_attachments_1[_0x4f791e(0x204)])(_0x2e5277,this[_0x4f791e(0x225)]);if(_0x5d2dfd[_0x4f791e(0x1fd)]!==this[_0x4f791e(0x1ed)][_0x4f791e(0x1fd)])throw new Error(_0x4f791e(0x1f8));return _0x5d2dfd[_0x4f791e(0x1d4)](_0x2bb1f9=>_0x2bb1f9[_0x4f791e(0x1ec)][_0x4f791e(0x22d)]);}async['createZip'](_0x3baf79){const _0x57c530=a358_0x35865e;this['_logger'][_0x57c530(0x226)](_0x57c530(0x1cf));const _0x263808=await new zip_creator_deploy_1[(_0x57c530(0x1ef))]({'attachmentBodies':_0x3baf79,'deploymentName':this[_0x57c530(0x214)]})[_0x57c530(0x213)](),_0x276a12=this['_tempFolder']+'/'+(0x0,shortid_1[_0x57c530(0x20e)])()+_0x57c530(0x22b);return await(0x0,promises_1['writeFile'])(_0x276a12,_0x263808),_0x276a12;}async['createVpk'](_0x523d9f){const _0x8d90c=a358_0x35865e;this[_0x8d90c(0x238)][_0x8d90c(0x226)](_0x8d90c(0x229));const _0x30e911=await this[_0x8d90c(0x21e)][_0x8d90c(0x24b)](_0x523d9f),_0xa62aaa=this[_0x8d90c(0x203)]+_0x8d90c(0x25d)+_0x523d9f[_0x8d90c(0x228)](_0x523d9f['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x8d90c(0x230)])(_0xa62aaa,_0x30e911),await this[_0x8d90c(0x21e)]['validate'](_0xa62aaa),_0xa62aaa;}async[a358_0x35865e(0x24c)](_0x53bc33,_0x58b57d){const _0x215d33=a358_0x35865e;this[_0x215d33(0x238)]['log']('Save\x20log');const _0x54b37c={'Body':Buffer['from'](_0x53bc33)[_0x215d33(0x1f1)](_0x215d33(0x201)),'ContentType':_0x215d33(0x1e2),'ParentId':this[_0x215d33(0x256)],'Name':_0x58b57d};await this['_connectionSalesforce'][_0x215d33(0x231)](flosum_constants_1[_0x215d33(0x246)][_0x215d33(0x20a)]+'/Attachment',_0x54b37c);}['formFlosumDeploymentResults'](_0x4addb9,_0x2c0bbf){const _0x4779d1=a358_0x35865e;this['_logger'][_0x4779d1(0x226)](_0x4779d1(0x1e6));const _0x2c06d6=_0x4addb9[_0x4779d1(0x1f7)]((_0x55bde3,_0x1af496)=>_0x55bde3[_0x4779d1(0x234)]((_0x1af496[_0x4779d1(0x25a)]+'.'+_0x1af496[_0x4779d1(0x206)])[_0x4779d1(0x20b)](),_0x1af496),new Map());return _0x2c0bbf['map'](_0x456c92=>{const _0x3cef3d=_0x4779d1;this['_logger'][_0x3cef3d(0x226)](_0x456c92[_0x3cef3d(0x26a)]+'.'+_0x456c92['name']+_0x3cef3d(0x267)+_0x456c92['status']);const _0x212356=(_0x456c92[_0x3cef3d(0x26a)]+'.'+_0x456c92[_0x3cef3d(0x1d3)])[_0x3cef3d(0x20b)](),_0x2d5699=_0x2c06d6['get'](_0x212356);return{[constants_1[_0x3cef3d(0x25b)]+_0x3cef3d(0x253)]:_0x3cef3d(0x248),[constants_1['FLOSUM_NAMESPACE']+_0x3cef3d(0x24d)]:_0x456c92[_0x3cef3d(0x1ff)]===status_enums_1[_0x3cef3d(0x207)][_0x3cef3d(0x219)]?_0x3cef3d(0x1da):_0x3cef3d(0x21f),[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x456c92[_0x3cef3d(0x260)],[constants_1[_0x3cef3d(0x25b)]+_0x3cef3d(0x23f)]:_0x456c92[_0x3cef3d(0x1d3)],[constants_1[_0x3cef3d(0x25b)]+_0x3cef3d(0x1f6)]:_0x456c92[_0x3cef3d(0x26a)],[constants_1[_0x3cef3d(0x25b)]+_0x3cef3d(0x1e4)]:_0x456c92[_0x3cef3d(0x24f)],[constants_1[_0x3cef3d(0x25b)]+_0x3cef3d(0x244)]:this['_organisationId'],[constants_1[_0x3cef3d(0x25b)]+_0x3cef3d(0x1d2)]:this[_0x3cef3d(0x256)],[constants_1['FLOSUM_NAMESPACE']+_0x3cef3d(0x20c)]:_0x2d5699[_0x3cef3d(0x235)]};});}async[a358_0x35865e(0x1fb)](_0x17dd9d){const _0xfa8b6d=a358_0x35865e;this[_0xfa8b6d(0x238)]['log'](_0xfa8b6d(0x1f3));const _0x34fc03=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0xfa8b6d(0x25b)]+_0xfa8b6d(0x220),_0x17dd9d),_0x1d2620=_0x34fc03[_0xfa8b6d(0x25f)](_0x4073e4=>!_0x4073e4[_0xfa8b6d(0x205)])['map'](_0x3b599b=>_0x3b599b[_0xfa8b6d(0x1ce)])[_0xfa8b6d(0x216)]();if(_0x1d2620[_0xfa8b6d(0x1fd)])throw new salesforce_dml_error_1[(_0xfa8b6d(0x243))](_0x1d2620);}async['finishDeployWithError'](_0x135f64){const _0x181902=a358_0x35865e;this[_0x181902(0x238)][_0x181902(0x257)](_0x135f64),await this['_logger'][_0x181902(0x1e8)](),await this[_0x181902(0x208)](![],!![],'');}async[a358_0x35865e(0x208)](_0x2c8ed8,_0x2da5ba,_0x59e1b1){const _0x300cd6=a358_0x35865e,_0x1cfc70=_0x300cd6(0x215)+this[_0x300cd6(0x1f0)]+'/'+this[_0x300cd6(0x256)]+_0x300cd6(0x23c)+_0x300cd6(0x236)+'\x20</a>',_0x31d249='<a\x20href='+this[_0x300cd6(0x1f0)]+'/'+this[_0x300cd6(0x1e5)]+'\x20>'+this[_0x300cd6(0x1de)]+_0x300cd6(0x252),_0x3d65d7=_0x1cfc70+_0x300cd6(0x1e1)+_0x31d249+'\x20has\x20been\x20created.',_0x3c1256={[constants_1[_0x300cd6(0x25b)]+_0x300cd6(0x1e0)]:_0x3d65d7,[constants_1['FLOSUM_NAMESPACE']+_0x300cd6(0x1cc)]:new Date(),[constants_1[_0x300cd6(0x25b)]+_0x300cd6(0x239)]:this[_0x300cd6(0x1e3)],[constants_1[_0x300cd6(0x25b)]+_0x300cd6(0x262)]:'Branch',[constants_1[_0x300cd6(0x25b)]+_0x300cd6(0x1e7)]:_0x300cd6(0x1df),[constants_1[_0x300cd6(0x25b)]+_0x300cd6(0x223)]:this[_0x300cd6(0x1e5)]},_0x25f6bf={[constants_1['FLOSUM_NAMESPACE']+_0x300cd6(0x1eb)]:!_0x2c8ed8,[constants_1[_0x300cd6(0x25b)]+'Succeed__c']:_0x2c8ed8,[constants_1[_0x300cd6(0x25b)]+_0x300cd6(0x24d)]:_0x2da5ba?status_enums_1[_0x300cd6(0x1f5)]['EXCEPTION']:status_enums_1[_0x300cd6(0x1f5)][_0x300cd6(0x265)],[constants_1[_0x300cd6(0x25b)]+'Job_Completed__c']:!![],[constants_1[_0x300cd6(0x25b)]+_0x300cd6(0x1ee)]:_0x59e1b1};await this[_0x300cd6(0x225)][_0x300cd6(0x263)](flosum_constants_1[_0x300cd6(0x246)][_0x300cd6(0x20a)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c/'+this['_metadataLogId'],_0x25f6bf),await this[_0x300cd6(0x225)][_0x300cd6(0x231)](flosum_constants_1[_0x300cd6(0x246)][_0x300cd6(0x20a)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x300cd6(0x1fe),_0x3c1256),this[_0x300cd6(0x238)]['log'](_0x300cd6(0x227)+(_0x2c8ed8?_0x300cd6(0x21b):_0x300cd6(0x264))+'.'),await this[_0x300cd6(0x238)]['updateLog']();}}exports[a358_0x35865e(0x1fa)]=DeployService;