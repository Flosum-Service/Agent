const a390_0xa5a663=a390_0x5292;(function(_0x472ebc,_0x156508){const _0x4a95e5=a390_0x5292,_0x22e27d=_0x472ebc();while(!![]){try{const _0x1e618b=-parseInt(_0x4a95e5(0x185))/0x1+parseInt(_0x4a95e5(0x175))/0x2*(parseInt(_0x4a95e5(0x1b4))/0x3)+-parseInt(_0x4a95e5(0x173))/0x4*(parseInt(_0x4a95e5(0x1c6))/0x5)+parseInt(_0x4a95e5(0x1cf))/0x6+-parseInt(_0x4a95e5(0x1cb))/0x7+-parseInt(_0x4a95e5(0x193))/0x8*(-parseInt(_0x4a95e5(0x17e))/0x9)+-parseInt(_0x4a95e5(0x191))/0xa;if(_0x1e618b===_0x156508)break;else _0x22e27d['push'](_0x22e27d['shift']());}catch(_0x5b2de0){_0x22e27d['push'](_0x22e27d['shift']());}}}(a390_0x4ae9,0x214ec));const a390_0x410768=(function(){let _0x3ac2c4=!![];return function(_0x2e6f4b,_0x108539){const _0x3090f3=_0x3ac2c4?function(){const _0x73aa6e=a390_0x5292;if(_0x108539){const _0x58278e=_0x108539[_0x73aa6e(0x205)](_0x2e6f4b,arguments);return _0x108539=null,_0x58278e;}}:function(){};return _0x3ac2c4=![],_0x3090f3;};}()),a390_0x4ae327=a390_0x410768(this,function(){const _0x35bb38=a390_0x5292;return a390_0x4ae327[_0x35bb38(0x19b)]()[_0x35bb38(0x19f)](_0x35bb38(0x203))['toString']()['constructor'](a390_0x4ae327)[_0x35bb38(0x19f)](_0x35bb38(0x203));});function a390_0x4ae9(){const _0x4fa5a3=['./vpk.service','text/plain','packageComponentList','updateLog','VpkService','(((.+)+)+)+$','Branch__c','apply','length','PackageImportService','finishDeploy','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Logger','from','Create\x20Backup','Failure','createBackup','../../../core','712HxDqYt','<a\x20href=','2akfSfX','_salesforceService','PackageComponentStatus','\x20has\x20been\x20created.','filter','TargetId__c','Form\x20Deployment\x20Results','../constants/flosum.constants','saveBackup','20934ToXAFL','ZipCreatorDeploy','log','timeZone','with\x20error','/Attachment','_branchId','209510bfnCJl','export','application/zip','_packageImportService','Body','External_Deployment_Id__c','retrieve','../classes/errors/salesforce-dml-error','jszip','defineProperty','createVpk','COMPLETED','802570QwnDxC','Veeva\x20Deployment','808oHfbru','Date__c','createZip','getFlosumComponents','EXCEPTION','\x20>\x20','organisationId','BACKUP_ZIP_NAME','toString','\x20of\x20branch\x20to\x20Organization\x20','attachmentLogId','ENDPOINT_UPSERT_RECORD','search','finishDeployWithError','errors','type','componentType','_systemLogger','flat','Save\x20log','BranchComponentHistoryFlosumComponentRetriever','Save\x20Backup\x20to\x20Salesforce','_timeZone','FlosumConstants','_connectionSalesforce','Result__c','_componentIdList','__importDefault','_metadataLogId','saveDeploymentResults','Component_Name__c','Activity_Type__c','Join\x20all\x20mdl\x20into\x20one\x20zip','678549ZPMJkI','Success','\x20:\x20','_attachmentLogId','_connectionVeeva','__esModule','Is_Error__c','../../shared/utils/fetch-attachments','saveLog','Deploy\x20completed\x20','componentHistoryId','/vpk__','patch','.zip','../enums/status.enums','name','_veevaService','componentName','1685EHGKHA','isDeployed','set','deploymentName','formFlosumDeploymentResults','220955bJsGHj','_packageExportService','_vpkService','reduce','339822SEiRBx','_organisationId','Retrieving\x20components','Org__c','Deployment\x20Result','success','./salesforce.service','import','</a>','status','writeFile','_instanceUrl','./package-import.service','fs/promises','DEPLOYED','execute','Status__c','Component_History__c','has','_deploymentName','./package-export.service','deploymentAction','FLOSUM_NAMESPACE','_tempFolder','Deployment','_logger','Log__c','Cannot\x20Backup\x20more\x20than\x20200\x20components.','FlosumComponentVeevaComponentRetriever','./veeva.service','post','Activity_Item__c','generateAsync','DeployService','shortid','Job_Completed__c','catch','Retrieving\x20attachments','toLowerCase','VeevaService','organisationName','map','Veeva_Step_Name__c','Deployment_Result__c','retrieveAttachments','branchId','logError'];a390_0x4ae9=function(){return _0x4fa5a3;};return a390_0x4ae9();}a390_0x4ae327();'use strict';var __importDefault=this&&this[a390_0xa5a663(0x1ae)]||function(_0x50e5a1){const _0x503f8f=a390_0xa5a663;return _0x50e5a1&&_0x50e5a1[_0x503f8f(0x1b9)]?_0x50e5a1:{'default':_0x50e5a1};};Object[a390_0xa5a663(0x18e)](exports,'__esModule',{'value':!![]}),exports[a390_0xa5a663(0x1f0)]=void 0x0;const jszip_1=__importDefault(require(a390_0xa5a663(0x18d))),promises_1=require(a390_0xa5a663(0x1dc)),constants_1=require('../../../constants'),flosum_constants_1=require(a390_0xa5a663(0x17c)),veeva_service_1=require(a390_0xa5a663(0x1ec)),salesforce_service_1=require(a390_0xa5a663(0x1d5)),core_1=require(a390_0xa5a663(0x172)),status_enums_1=require(a390_0xa5a663(0x1c2)),salesforce_dml_error_1=require(a390_0xa5a663(0x18c)),shortid_1=__importDefault(require(a390_0xa5a663(0x1f1))),fetch_attachments_1=require(a390_0xa5a663(0x1bb)),package_import_service_1=require(a390_0xa5a663(0x1db)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a390_0xa5a663(0x209)),package_export_service_1=require(a390_0xa5a663(0x1e3)),vpk_service_1=require(a390_0xa5a663(0x1fe)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');function a390_0x5292(_0x5ac18b,_0x1fd621){const _0x4acdaf=a390_0x4ae9();return a390_0x5292=function(_0x4ae327,_0x410768){_0x4ae327=_0x4ae327-0x16d;let _0x4ae9cd=_0x4acdaf[_0x4ae327];return _0x4ae9cd;},a390_0x5292(_0x5ac18b,_0x1fd621);}class DeployService{constructor(_0x4bb3d3,_0x24429e,_0x183e35,_0x54cd3a,_0x2b2d7b,_0x5d49fb){const _0x1a17c2=a390_0xa5a663;this[_0x1a17c2(0x1ab)]=_0x24429e,this['_connectionVeeva']=_0x183e35,this[_0x1a17c2(0x1e8)]=_0x54cd3a,this[_0x1a17c2(0x1e6)]=_0x2b2d7b,this[_0x1a17c2(0x1da)]=_0x5d49fb,this['_branchId']=_0x4bb3d3[_0x1a17c2(0x1fc)],this[_0x1a17c2(0x1af)]=_0x4bb3d3['metadataLogId'],this[_0x1a17c2(0x1b7)]=_0x4bb3d3[_0x1a17c2(0x19d)],this[_0x1a17c2(0x1d0)]=_0x4bb3d3[_0x1a17c2(0x199)],this[_0x1a17c2(0x1a9)]=_0x4bb3d3[_0x1a17c2(0x181)],this['_organisationName']=_0x4bb3d3[_0x1a17c2(0x1f7)],this[_0x1a17c2(0x1ad)]=_0x4bb3d3['componentIdList'],this[_0x1a17c2(0x1e2)]=_0x4bb3d3[_0x1a17c2(0x1c9)],this[_0x1a17c2(0x1a4)]=new core_1[(_0x1a17c2(0x16d))]('veeva-deploy'),this[_0x1a17c2(0x1c4)]=new veeva_service_1[(_0x1a17c2(0x1f6))]({'connection':this[_0x1a17c2(0x1b8)],'logger':this[_0x1a17c2(0x1e8)]}),this[_0x1a17c2(0x176)]=new salesforce_service_1['SalesforceService']({'connection':this['_connectionSalesforce']}),this[_0x1a17c2(0x188)]=new package_import_service_1[(_0x1a17c2(0x207))]({'veevaService':this[_0x1a17c2(0x1c4)],'connection':this[_0x1a17c2(0x1b8)],'logger':this['_logger'],'saveLog':this[_0x1a17c2(0x1bc)]['bind'](this)}),this[_0x1a17c2(0x1cc)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x1a17c2(0x1c4)],'connection':this[_0x1a17c2(0x1b8)],'logger':this['_logger']}),this[_0x1a17c2(0x1cd)]=new vpk_service_1[(_0x1a17c2(0x202))]({'connection':this[_0x1a17c2(0x1b8)]});}async[a390_0xa5a663(0x1de)](){const _0x6d8c96=a390_0xa5a663;try{const _0x48b8f8=await this[_0x6d8c96(0x196)]();await this[_0x6d8c96(0x1e8)]['updateLog']();const _0x388619=await this['createBackup'](_0x48b8f8);await this[_0x6d8c96(0x17d)](_0x388619);const _0x1dd04d=await this[_0x6d8c96(0x1fb)](_0x48b8f8),_0x4ef96b=await this[_0x6d8c96(0x195)](_0x1dd04d),_0x81d83c=await this['createVpk'](_0x4ef96b);await this[_0x6d8c96(0x1e8)]['updateLog']();const _0x20a4b5=await this[_0x6d8c96(0x188)][_0x6d8c96(0x1d6)](_0x81d83c);await this['_logger']['updateLog']();const _0x1e3281=this[_0x6d8c96(0x1ca)](_0x48b8f8,_0x20a4b5[_0x6d8c96(0x200)]);await this[_0x6d8c96(0x1b0)](_0x1e3281),await this[_0x6d8c96(0x208)](_0x20a4b5[_0x6d8c96(0x1c7)],![],_0x20a4b5['packageId']);}catch(_0x1225f6){await this[_0x6d8c96(0x1a0)](_0x1225f6)[_0x6d8c96(0x1f3)](_0x520251=>this['_systemLogger']['error'](_0x520251));}}async['getFlosumComponents'](){const _0x3e83d3=a390_0xa5a663,_0x872058=new Set(this[_0x3e83d3(0x1ad)]);this[_0x3e83d3(0x1e8)][_0x3e83d3(0x180)](_0x3e83d3(0x1d1));const _0x179142=await new branch_component_history_flosum_component_retriever_1[(_0x3e83d3(0x1a7))]({'value':this['_branchId'],'salesforceService':this[_0x3e83d3(0x176)]})[_0x3e83d3(0x18b)](),_0x436c0d=_0x179142[_0x3e83d3(0x179)](_0x47b664=>_0x872058[_0x3e83d3(0x1e1)](_0x47b664['id']));if(_0x436c0d['length']!==this[_0x3e83d3(0x1ad)]['length'])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x436c0d;}async[a390_0xa5a663(0x171)](_0x474b76){const _0x192ae1=a390_0xa5a663;var _0x165fa4;this['_logger']['log'](_0x192ae1(0x16f));const _0x5aa3b4=await new flosum_component_veeva_component_retriever_1[(_0x192ae1(0x1eb))]({'value':_0x474b76,'veevaService':this['_veevaService'],'logger':this[_0x192ae1(0x1e8)]})[_0x192ae1(0x18b)](),_0x586b14=await this['_packageExportService'][_0x192ae1(0x186)](_0x5aa3b4,'Backup');if(_0x586b14[_0x192ae1(0x206)]>0x1)throw new Error(_0x192ae1(0x1ea));return(_0x165fa4=_0x586b14[0x0])!==null&&_0x165fa4!==void 0x0?_0x165fa4:_0x586b14[0x0]=new jszip_1['default'](),_0x586b14[0x0][_0x192ae1(0x1ef)]({'type':'base64'});}async[a390_0xa5a663(0x17d)](_0x21e92f){const _0x4d73b4=a390_0xa5a663;this[_0x4d73b4(0x1e8)][_0x4d73b4(0x180)](_0x4d73b4(0x1a8));const _0x431ab4={'Body':_0x21e92f,'ContentType':_0x4d73b4(0x187),'ParentId':this[_0x4d73b4(0x1af)],'Name':flosum_constants_1[_0x4d73b4(0x1aa)][_0x4d73b4(0x19a)]};await this[_0x4d73b4(0x1ab)][_0x4d73b4(0x1ed)](flosum_constants_1[_0x4d73b4(0x1aa)]['ENDPOINT_UPSERT_RECORD']+_0x4d73b4(0x183),_0x431ab4);}async[a390_0xa5a663(0x1fb)](_0x526803){const _0x15523a=a390_0xa5a663;this['_logger'][_0x15523a(0x180)](_0x15523a(0x1f4));const _0x307d7c=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this['_connectionSalesforce'],_0x526803[_0x15523a(0x1f8)](_0xf23684=>_0xf23684[_0x15523a(0x1be)])),_0x35969e=await(0x0,fetch_attachments_1[_0x15523a(0x1fb)])(_0x307d7c,this['_connectionSalesforce']);if(_0x35969e['length']!==this[_0x15523a(0x1ad)][_0x15523a(0x206)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x35969e[_0x15523a(0x1f8)](_0x1622cd=>_0x1622cd['values'][_0x15523a(0x189)]);}async[a390_0xa5a663(0x195)](_0x3251ba){const _0xbdba55=a390_0xa5a663;this['_logger']['log'](_0xbdba55(0x1b3));const _0x159802=await new zip_creator_deploy_1[(_0xbdba55(0x17f))]({'attachmentBodies':_0x3251ba,'deploymentName':this['_deploymentName']})[_0xbdba55(0x1de)](),_0x58ff9c=this[_0xbdba55(0x1e6)]+'/'+(0x0,shortid_1['default'])()+_0xbdba55(0x1c1);return await(0x0,promises_1[_0xbdba55(0x1d9)])(_0x58ff9c,_0x159802),_0x58ff9c;}async[a390_0xa5a663(0x18f)](_0x1bc24e){const _0x42412c=a390_0xa5a663;this[_0x42412c(0x1e8)]['log']('Create\x20vpk\x20package');const _0x3a299f=await this[_0x42412c(0x1cd)]['generate'](_0x1bc24e),_0xdf0cb=this[_0x42412c(0x1e6)]+_0x42412c(0x1bf)+_0x1bc24e['slice'](_0x1bc24e['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x42412c(0x1d9)])(_0xdf0cb,_0x3a299f),await this[_0x42412c(0x1cd)]['validate'](_0xdf0cb),_0xdf0cb;}async[a390_0xa5a663(0x1bc)](_0x58b0ef,_0x9d493d){const _0x1cbcb7=a390_0xa5a663;this[_0x1cbcb7(0x1e8)][_0x1cbcb7(0x180)](_0x1cbcb7(0x1a6));const _0x57b972={'Body':Buffer[_0x1cbcb7(0x16e)](_0x58b0ef)[_0x1cbcb7(0x19b)]('base64'),'ContentType':_0x1cbcb7(0x1ff),'ParentId':this[_0x1cbcb7(0x1af)],'Name':_0x9d493d};await this[_0x1cbcb7(0x1ab)]['post'](flosum_constants_1[_0x1cbcb7(0x1aa)][_0x1cbcb7(0x19e)]+_0x1cbcb7(0x183),_0x57b972);}[a390_0xa5a663(0x1ca)](_0x577f43,_0xd32d6a){const _0x250489=a390_0xa5a663;this['_logger']['log'](_0x250489(0x17b));const _0x1171bc=_0x577f43[_0x250489(0x1ce)]((_0x24c962,_0x57b6a6)=>_0x24c962[_0x250489(0x1c8)]((_0x57b6a6[_0x250489(0x1a3)]+'.'+_0x57b6a6[_0x250489(0x1c5)])['toLowerCase'](),_0x57b6a6),new Map());return _0xd32d6a[_0x250489(0x1f8)](_0x3d6872=>{const _0x4935e3=_0x250489;this[_0x4935e3(0x1e8)][_0x4935e3(0x180)](_0x3d6872[_0x4935e3(0x1a2)]+'.'+_0x3d6872[_0x4935e3(0x1c3)]+_0x4935e3(0x1b6)+_0x3d6872[_0x4935e3(0x1d8)]);const _0xd52258=(_0x3d6872[_0x4935e3(0x1a2)]+'.'+_0x3d6872[_0x4935e3(0x1c3)])[_0x4935e3(0x1f5)](),_0x1ad2c5=_0x1171bc['get'](_0xd52258);return{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:_0x4935e3(0x1d3),[constants_1[_0x4935e3(0x1e5)]+_0x4935e3(0x1df)]:_0x3d6872[_0x4935e3(0x1d8)]===status_enums_1[_0x4935e3(0x177)][_0x4935e3(0x1dd)]?_0x4935e3(0x1b5):_0x4935e3(0x170),[constants_1['FLOSUM_NAMESPACE']+_0x4935e3(0x1ac)]:_0x3d6872[_0x4935e3(0x1e4)],[constants_1['FLOSUM_NAMESPACE']+_0x4935e3(0x1b1)]:_0x3d6872[_0x4935e3(0x1c3)],[constants_1[_0x4935e3(0x1e5)]+'Component_Type__c']:_0x3d6872[_0x4935e3(0x1a2)],[constants_1['FLOSUM_NAMESPACE']+_0x4935e3(0x1f9)]:_0x3d6872['stepName'],[constants_1['FLOSUM_NAMESPACE']+_0x4935e3(0x1d2)]:this[_0x4935e3(0x1d0)],[constants_1[_0x4935e3(0x1e5)]+'Metadata_Log__c']:this[_0x4935e3(0x1af)],[constants_1[_0x4935e3(0x1e5)]+_0x4935e3(0x1e0)]:_0x1ad2c5[_0x4935e3(0x1be)]};});}async[a390_0xa5a663(0x1b0)](_0x301686){const _0x1cc4ab=a390_0xa5a663;this[_0x1cc4ab(0x1e8)][_0x1cc4ab(0x180)]('Save\x20Deployment\x20Results');const _0x2a2db0=await this[_0x1cc4ab(0x176)]['insertMultipleRecords'](constants_1[_0x1cc4ab(0x1e5)]+_0x1cc4ab(0x1fa),_0x301686),_0x5a85b7=_0x2a2db0[_0x1cc4ab(0x179)](_0x33d01e=>!_0x33d01e[_0x1cc4ab(0x1d4)])[_0x1cc4ab(0x1f8)](_0x4bdf56=>_0x4bdf56[_0x1cc4ab(0x1a1)])[_0x1cc4ab(0x1a5)]();if(_0x5a85b7[_0x1cc4ab(0x206)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x5a85b7);}async[a390_0xa5a663(0x1a0)](_0x151412){const _0xd89ae3=a390_0xa5a663;this[_0xd89ae3(0x1e8)][_0xd89ae3(0x1fd)](_0x151412),await this[_0xd89ae3(0x1e8)][_0xd89ae3(0x201)](),await this['finishDeploy'](![],!![],'');}async[a390_0xa5a663(0x208)](_0x31e50e,_0x126bfe,_0x41fa43){const _0x13950c=a390_0xa5a663,_0x30b89d=_0x13950c(0x174)+this[_0x13950c(0x1da)]+'/'+this[_0x13950c(0x1af)]+_0x13950c(0x198)+_0x13950c(0x192)+'\x20</a>',_0x39f24f=_0x13950c(0x174)+this['_instanceUrl']+'/'+this[_0x13950c(0x1d0)]+'\x20>'+this['_organisationName']+_0x13950c(0x1d7),_0x181987=_0x30b89d+_0x13950c(0x19c)+_0x39f24f+_0x13950c(0x178),_0x4d787b={[constants_1[_0x13950c(0x1e5)]+'Action__c']:_0x181987,[constants_1[_0x13950c(0x1e5)]+_0x13950c(0x194)]:new Date(),[constants_1[_0x13950c(0x1e5)]+_0x13950c(0x204)]:this[_0x13950c(0x184)],[constants_1[_0x13950c(0x1e5)]+_0x13950c(0x1ee)]:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x13950c(0x1b2)]:_0x13950c(0x1e7),[constants_1[_0x13950c(0x1e5)]+_0x13950c(0x17a)]:this[_0x13950c(0x1d0)]},_0x2e4acf={[constants_1[_0x13950c(0x1e5)]+_0x13950c(0x1ba)]:!_0x31e50e,[constants_1[_0x13950c(0x1e5)]+'Succeed__c']:_0x31e50e,[constants_1['FLOSUM_NAMESPACE']+_0x13950c(0x1df)]:_0x126bfe?status_enums_1['MetadataLogStatus'][_0x13950c(0x197)]:status_enums_1['MetadataLogStatus'][_0x13950c(0x190)],[constants_1[_0x13950c(0x1e5)]+_0x13950c(0x1f2)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x13950c(0x18a)]:_0x41fa43};await this['_connectionSalesforce'][_0x13950c(0x1c0)](flosum_constants_1[_0x13950c(0x1aa)][_0x13950c(0x19e)]+'/'+constants_1[_0x13950c(0x1e5)]+'Metadata_Log__c/'+this['_metadataLogId'],_0x2e4acf),await this[_0x13950c(0x1ab)][_0x13950c(0x1ed)](flosum_constants_1['FlosumConstants'][_0x13950c(0x19e)]+'/'+constants_1[_0x13950c(0x1e5)]+_0x13950c(0x1e9),_0x4d787b),this[_0x13950c(0x1e8)][_0x13950c(0x180)](_0x13950c(0x1bd)+(_0x31e50e?'successfully':_0x13950c(0x182))+'.'),await this['_logger']['updateLog']();}}exports['DeployService']=DeployService;