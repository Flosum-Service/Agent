const a389_0x1c165d=a389_0xa52a;function a389_0xa52a(_0x4d31c2,_0x1c27b0){const _0x2794da=a389_0x3ba2();return a389_0xa52a=function(_0x4d2522,_0x4e6e8e){_0x4d2522=_0x4d2522-0xbc;let _0x3ba2dc=_0x2794da[_0x4d2522];return _0x3ba2dc;},a389_0xa52a(_0x4d31c2,_0x1c27b0);}(function(_0x17a22d,_0x2327dc){const _0x526fe1=a389_0xa52a,_0x5c54bb=_0x17a22d();while(!![]){try{const _0x154165=-parseInt(_0x526fe1(0xdd))/0x1+parseInt(_0x526fe1(0x13c))/0x2+-parseInt(_0x526fe1(0x11b))/0x3*(-parseInt(_0x526fe1(0x13e))/0x4)+parseInt(_0x526fe1(0x145))/0x5+parseInt(_0x526fe1(0xbc))/0x6*(parseInt(_0x526fe1(0x151))/0x7)+parseInt(_0x526fe1(0x15a))/0x8+-parseInt(_0x526fe1(0xe2))/0x9;if(_0x154165===_0x2327dc)break;else _0x5c54bb['push'](_0x5c54bb['shift']());}catch(_0x56203f){_0x5c54bb['push'](_0x5c54bb['shift']());}}}(a389_0x3ba2,0x1eb8b));const a389_0x4e6e8e=(function(){let _0x47ed1c=!![];return function(_0x18d98e,_0x25db6f){const _0x3f72ce=_0x47ed1c?function(){const _0x51d793=a389_0xa52a;if(_0x25db6f){const _0x3ccefa=_0x25db6f[_0x51d793(0xd9)](_0x18d98e,arguments);return _0x25db6f=null,_0x3ccefa;}}:function(){};return _0x47ed1c=![],_0x3f72ce;};}()),a389_0x4d2522=a389_0x4e6e8e(this,function(){const _0x285aa0=a389_0xa52a;return a389_0x4d2522[_0x285aa0(0xd5)]()[_0x285aa0(0x10e)](_0x285aa0(0xde))[_0x285aa0(0xd5)]()[_0x285aa0(0x156)](a389_0x4d2522)[_0x285aa0(0x10e)]('(((.+)+)+)+$');});a389_0x4d2522();'use strict';var __importDefault=this&&this[a389_0x1c165d(0x11f)]||function(_0x3aa442){const _0x462bb5=a389_0x1c165d;return _0x3aa442&&_0x3aa442[_0x462bb5(0xf0)]?_0x3aa442:{'default':_0x3aa442};};Object['defineProperty'](exports,a389_0x1c165d(0xf0),{'value':!![]}),exports[a389_0x1c165d(0x11a)]=void 0x0;const jszip_1=__importDefault(require(a389_0x1c165d(0x12f))),promises_1=require(a389_0x1c165d(0x122)),constants_1=require(a389_0x1c165d(0x132)),flosum_constants_1=require(a389_0x1c165d(0x128)),veeva_service_1=require(a389_0x1c165d(0xd3)),salesforce_service_1=require('./salesforce.service'),core_1=require(a389_0x1c165d(0x129)),status_enums_1=require(a389_0x1c165d(0x118)),salesforce_dml_error_1=require(a389_0x1c165d(0x147)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require(a389_0x1c165d(0xf1)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a389_0x1c165d(0x149)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a389_0x1c165d(0x120)),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x3b7a9f,_0x8c29bd,_0xcc8f9,_0x118677,_0x371cda,_0x351832){const _0x2754ab=a389_0x1c165d;this[_0x2754ab(0xc6)]=_0x8c29bd,this[_0x2754ab(0x112)]=_0xcc8f9,this[_0x2754ab(0x12b)]=_0x118677,this['_tempFolder']=_0x371cda,this['_instanceUrl']=_0x351832,this['_branchId']=_0x3b7a9f[_0x2754ab(0xcb)],this[_0x2754ab(0x113)]=_0x3b7a9f[_0x2754ab(0x141)],this['_attachmentLogId']=_0x3b7a9f['attachmentLogId'],this['_organisationId']=_0x3b7a9f[_0x2754ab(0x14e)],this[_0x2754ab(0x130)]=_0x3b7a9f[_0x2754ab(0x125)],this['_organisationName']=_0x3b7a9f[_0x2754ab(0xd0)],this[_0x2754ab(0xc4)]=_0x3b7a9f[_0x2754ab(0x138)],this[_0x2754ab(0xc8)]=_0x3b7a9f['deploymentName'],this[_0x2754ab(0xe7)]=new core_1[(_0x2754ab(0x108))](_0x2754ab(0x105)),this[_0x2754ab(0x150)]=new veeva_service_1['VeevaService']({'connection':this[_0x2754ab(0x112)],'logger':this[_0x2754ab(0x12b)]}),this[_0x2754ab(0x13d)]=new salesforce_service_1[(_0x2754ab(0xff))]({'connection':this['_connectionSalesforce']}),this[_0x2754ab(0xd1)]=new package_import_service_1[(_0x2754ab(0xca))]({'veevaService':this[_0x2754ab(0x150)],'connection':this['_connectionVeeva'],'logger':this['_logger'],'saveLog':this[_0x2754ab(0x13a)]['bind'](this)}),this[_0x2754ab(0xf5)]=new package_export_service_1[(_0x2754ab(0xec))]({'veevaService':this[_0x2754ab(0x150)],'connection':this['_connectionVeeva'],'logger':this[_0x2754ab(0x12b)]}),this[_0x2754ab(0xe0)]=new vpk_service_1['VpkService']({'connection':this[_0x2754ab(0x112)]});}async[a389_0x1c165d(0x124)](){const _0x52a739=a389_0x1c165d;try{const _0x292757=await this[_0x52a739(0x10f)]();await this[_0x52a739(0x12b)]['updateLog']();const _0x137505=await this[_0x52a739(0x137)](_0x292757);await this['saveBackup'](_0x137505);const _0x2b1712=await this[_0x52a739(0x110)](_0x292757),_0x5d70bc=await this[_0x52a739(0x10d)](_0x2b1712),_0x170c08=await this[_0x52a739(0xcd)](_0x5d70bc);await this['_logger'][_0x52a739(0x148)]();const _0x162294=await this[_0x52a739(0xd1)][_0x52a739(0x135)](_0x170c08);await this['_logger'][_0x52a739(0x148)]();const _0x5a3ac6=this[_0x52a739(0xeb)](_0x292757,_0x162294[_0x52a739(0x136)]);await this[_0x52a739(0xf7)](_0x5a3ac6),await this['finishDeploy'](_0x162294[_0x52a739(0x12a)],![],_0x162294[_0x52a739(0x10b)]);}catch(_0x56c674){await this[_0x52a739(0x158)](_0x56c674)[_0x52a739(0x153)](_0x2c67b0=>this['_systemLogger']['error'](_0x2c67b0));}}async[a389_0x1c165d(0x10f)](){const _0x408239=a389_0x1c165d,_0x2ff95d=new Set(this[_0x408239(0xc4)]);this['_logger'][_0x408239(0x14b)]('Retrieving\x20components');const _0x211b89=await new branch_component_history_flosum_component_retriever_1[(_0x408239(0xc1))]({'value':this[_0x408239(0xee)],'salesforceService':this[_0x408239(0x13d)]})[_0x408239(0x134)](),_0x45a0b2=_0x211b89[_0x408239(0x115)](_0x3fd14e=>_0x2ff95d[_0x408239(0x139)](_0x3fd14e['id']));if(_0x45a0b2[_0x408239(0xc9)]!==this[_0x408239(0xc4)][_0x408239(0xc9)])throw new Error(_0x408239(0x11e));return _0x45a0b2;}async[a389_0x1c165d(0x137)](_0x4d2da5){const _0x24990b=a389_0x1c165d;var _0x43d8ec;this[_0x24990b(0x12b)][_0x24990b(0x14b)](_0x24990b(0x14f));const _0x3cff93=await new flosum_component_veeva_component_retriever_1[(_0x24990b(0x10c))]({'value':_0x4d2da5,'veevaService':this[_0x24990b(0x150)],'logger':this[_0x24990b(0x12b)]})['retrieve'](),_0x18cd40=await this[_0x24990b(0xf5)][_0x24990b(0x14a)](_0x3cff93,'Backup');if(_0x18cd40[_0x24990b(0xc9)]>0x1)throw new Error(_0x24990b(0xce));return(_0x43d8ec=_0x18cd40[0x0])!==null&&_0x43d8ec!==void 0x0?_0x43d8ec:_0x18cd40[0x0]=new jszip_1['default'](),_0x18cd40[0x0][_0x24990b(0xf8)]({'type':_0x24990b(0x106)});}async[a389_0x1c165d(0x131)](_0x216b60){const _0x25befb=a389_0x1c165d;this[_0x25befb(0x12b)][_0x25befb(0x14b)]('Save\x20Backup\x20to\x20Salesforce');const _0x4bf54a={'Body':_0x216b60,'ContentType':_0x25befb(0xd2),'ParentId':this[_0x25befb(0x113)],'Name':flosum_constants_1['FlosumConstants'][_0x25befb(0x12c)]};await this[_0x25befb(0xc6)][_0x25befb(0x157)](flosum_constants_1[_0x25befb(0xfe)][_0x25befb(0x123)]+_0x25befb(0xd4),_0x4bf54a);}async[a389_0x1c165d(0x110)](_0x11a5e5){const _0x88b8a5=a389_0x1c165d;this['_logger']['log'](_0x88b8a5(0xc5));const _0x335f56=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x88b8a5(0xc6)],_0x11a5e5['map'](_0x57ad0f=>_0x57ad0f['componentHistoryId'])),_0x5e65ff=await(0x0,fetch_attachments_1[_0x88b8a5(0x110)])(_0x335f56,this[_0x88b8a5(0xc6)]);if(_0x5e65ff[_0x88b8a5(0xc9)]!==this[_0x88b8a5(0xc4)][_0x88b8a5(0xc9)])throw new Error(_0x88b8a5(0xd7));return _0x5e65ff[_0x88b8a5(0xe6)](_0x3e0ded=>_0x3e0ded['values'][_0x88b8a5(0xc2)]);}async[a389_0x1c165d(0x10d)](_0x251854){const _0x272ecf=a389_0x1c165d;this['_logger'][_0x272ecf(0x14b)](_0x272ecf(0x119));const _0x5ca402=await new zip_creator_deploy_1[(_0x272ecf(0xea))]({'attachmentBodies':_0x251854,'deploymentName':this['_deploymentName']})[_0x272ecf(0x124)](),_0x5f5d3d=this[_0x272ecf(0xd8)]+'/'+(0x0,shortid_1[_0x272ecf(0xfc)])()+_0x272ecf(0x140);return await(0x0,promises_1[_0x272ecf(0xe3)])(_0x5f5d3d,_0x5ca402),_0x5f5d3d;}async['createVpk'](_0xb6da66){const _0x1ea8ff=a389_0x1c165d;this[_0x1ea8ff(0x12b)][_0x1ea8ff(0x14b)](_0x1ea8ff(0x126));const _0x1076bd=await this[_0x1ea8ff(0xe0)][_0x1ea8ff(0xe4)](_0xb6da66),_0x1ad1b1=this[_0x1ea8ff(0xd8)]+_0x1ea8ff(0xdc)+_0xb6da66[_0x1ea8ff(0xe9)](_0xb6da66[_0x1ea8ff(0x103)]('/')+0x1);return await(0x0,promises_1[_0x1ea8ff(0xe3)])(_0x1ad1b1,_0x1076bd),await this[_0x1ea8ff(0xe0)]['validate'](_0x1ad1b1),_0x1ad1b1;}async['saveLog'](_0x20fefa,_0x1a8bf1){const _0x5a5085=a389_0x1c165d;this[_0x5a5085(0x12b)][_0x5a5085(0x14b)](_0x5a5085(0x114));const _0xbbdebc={'Body':Buffer[_0x5a5085(0x14c)](_0x20fefa)[_0x5a5085(0xd5)](_0x5a5085(0x106)),'ContentType':'text/plain','ParentId':this[_0x5a5085(0x113)],'Name':_0x1a8bf1};await this[_0x5a5085(0xc6)][_0x5a5085(0x157)](flosum_constants_1[_0x5a5085(0xfe)][_0x5a5085(0x123)]+_0x5a5085(0xd4),_0xbbdebc);}['formFlosumDeploymentResults'](_0x4f1788,_0x1eee84){const _0x399b6d=a389_0x1c165d;this[_0x399b6d(0x12b)][_0x399b6d(0x14b)]('Form\x20Deployment\x20Results');const _0x11fd85=_0x4f1788[_0x399b6d(0xf2)]((_0xf28e57,_0x3dae46)=>_0xf28e57[_0x399b6d(0xed)]((_0x3dae46[_0x399b6d(0x127)]+'.'+_0x3dae46[_0x399b6d(0x13f)])[_0x399b6d(0x152)](),_0x3dae46),new Map());return _0x1eee84[_0x399b6d(0xe6)](_0xb11246=>{const _0x2698fc=_0x399b6d;this[_0x2698fc(0x12b)]['log'](_0xb11246['type']+'.'+_0xb11246[_0x2698fc(0xc7)]+_0x2698fc(0x144)+_0xb11246['status']);const _0x3507c8=(_0xb11246[_0x2698fc(0x102)]+'.'+_0xb11246[_0x2698fc(0xc7)])[_0x2698fc(0x152)](),_0x25a529=_0x11fd85[_0x2698fc(0x11c)](_0x3507c8);return{[constants_1['FLOSUM_NAMESPACE']+_0x2698fc(0x12d)]:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0xb11246[_0x2698fc(0x116)]===status_enums_1[_0x2698fc(0xf9)][_0x2698fc(0x15b)]?_0x2698fc(0xe1):'Failure',[constants_1[_0x2698fc(0xe5)]+_0x2698fc(0x146)]:_0xb11246['deploymentAction'],[constants_1[_0x2698fc(0xe5)]+_0x2698fc(0x142)]:_0xb11246[_0x2698fc(0xc7)],[constants_1[_0x2698fc(0xe5)]+_0x2698fc(0x100)]:_0xb11246['type'],[constants_1[_0x2698fc(0xe5)]+_0x2698fc(0x14d)]:_0xb11246[_0x2698fc(0xf3)],[constants_1['FLOSUM_NAMESPACE']+'Org__c']:this[_0x2698fc(0xbf)],[constants_1[_0x2698fc(0xe5)]+_0x2698fc(0xf6)]:this[_0x2698fc(0x113)],[constants_1['FLOSUM_NAMESPACE']+_0x2698fc(0x10a)]:_0x25a529['componentHistoryId']};});}async[a389_0x1c165d(0xf7)](_0x5da8b7){const _0x5ad0cd=a389_0x1c165d;this[_0x5ad0cd(0x12b)]['log']('Save\x20Deployment\x20Results');const _0x13474f=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x5ad0cd(0xe5)]+'Deployment_Result__c',_0x5da8b7),_0x5430df=_0x13474f[_0x5ad0cd(0x115)](_0x2fcc4d=>!_0x2fcc4d[_0x5ad0cd(0x11d)])[_0x5ad0cd(0xe6)](_0x232788=>_0x232788[_0x5ad0cd(0xbe)])[_0x5ad0cd(0xe8)]();if(_0x5430df[_0x5ad0cd(0xc9)])throw new salesforce_dml_error_1[(_0x5ad0cd(0x109))](_0x5430df);}async[a389_0x1c165d(0x158)](_0x2f986b){const _0x25e06b=a389_0x1c165d;this[_0x25e06b(0x12b)][_0x25e06b(0x133)](_0x2f986b),await this[_0x25e06b(0x12b)][_0x25e06b(0x148)](),await this[_0x25e06b(0xdb)](![],!![],'');}async[a389_0x1c165d(0xdb)](_0x36c080,_0x36d403,_0x3f4dd5){const _0x4afcd1=a389_0x1c165d,_0x58c986=_0x4afcd1(0xbd)+this['_instanceUrl']+'/'+this[_0x4afcd1(0x113)]+_0x4afcd1(0x107)+_0x4afcd1(0xc3)+_0x4afcd1(0xfa),_0x11fc6a=_0x4afcd1(0xbd)+this['_instanceUrl']+'/'+this['_organisationId']+'\x20>'+this[_0x4afcd1(0x111)]+_0x4afcd1(0x12e),_0x11c6ac=_0x58c986+'\x20of\x20branch\x20to\x20Organization\x20'+_0x11fc6a+_0x4afcd1(0xfd),_0x103416={[constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0x13b)]:_0x11c6ac,[constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0x155)]:new Date(),[constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0xcf)]:this[_0x4afcd1(0xee)],[constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0x159)]:_0x4afcd1(0x101),[constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0xf4)]:_0x4afcd1(0xdf),[constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0x143)]:this[_0x4afcd1(0xbf)]},_0x4fcf0c={[constants_1[_0x4afcd1(0xe5)]+'Is_Error__c']:!_0x36c080,[constants_1[_0x4afcd1(0xe5)]+'Succeed__c']:_0x36c080,[constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0x121)]:_0x36d403?status_enums_1[_0x4afcd1(0x104)]['EXCEPTION']:status_enums_1[_0x4afcd1(0x104)][_0x4afcd1(0xc0)],[constants_1['FLOSUM_NAMESPACE']+_0x4afcd1(0x117)]:!![],[constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0xcc)]:_0x3f4dd5};await this[_0x4afcd1(0xc6)][_0x4afcd1(0xfb)](flosum_constants_1[_0x4afcd1(0xfe)][_0x4afcd1(0x123)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x4afcd1(0xef)+this[_0x4afcd1(0x113)],_0x4fcf0c),await this[_0x4afcd1(0xc6)][_0x4afcd1(0x157)](flosum_constants_1[_0x4afcd1(0xfe)][_0x4afcd1(0x123)]+'/'+constants_1[_0x4afcd1(0xe5)]+_0x4afcd1(0x154),_0x103416),this['_logger']['log'](_0x4afcd1(0xd6)+(_0x36c080?'successfully':_0x4afcd1(0xda))+'.'),await this[_0x4afcd1(0x12b)][_0x4afcd1(0x148)]();}}exports['DeployService']=DeployService;function a389_0x3ba2(){const _0x4733cc=['</a>','jszip','_timeZone','saveBackup','../../../constants','logError','retrieve','import','packageComponentList','createBackup','componentIdList','has','saveLog','Action__c','279488LyrduK','_salesforceService','128948uSkmPk','componentName','.zip','metadataLogId','Component_Name__c','TargetId__c','\x20:\x20','638650agnoVv','Result__c','../classes/errors/salesforce-dml-error','updateLog','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','export','log','from','Veeva_Step_Name__c','organisationId','Create\x20Backup','_veevaService','14RZyikv','toLowerCase','catch','Log__c','Date__c','constructor','post','finishDeployWithError','Activity_Item__c','1292040YxoJul','DEPLOYED','741486mketgb','<a\x20href=','errors','_organisationId','COMPLETED','BranchComponentHistoryFlosumComponentRetriever','Body','Veeva\x20Deployment','_componentIdList','Retrieving\x20attachments','_connectionSalesforce','name','_deploymentName','length','PackageImportService','branchId','External_Deployment_Id__c','createVpk','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Branch__c','organisationName','_packageImportService','application/zip','./veeva.service','/Attachment','toString','Deploy\x20completed\x20','Cannot\x20retrievers\x20all\x20attachments','_tempFolder','apply','with\x20error','finishDeploy','/vpk__','239919LEzOeg','(((.+)+)+)+$','Deployment','_vpkService','Success','3373749TUuIlL','writeFile','generate','FLOSUM_NAMESPACE','map','_systemLogger','flat','slice','ZipCreatorDeploy','formFlosumDeploymentResults','PackageExportService','set','_branchId','Metadata_Log__c/','__esModule','../../shared/utils/fetch-attachments','reduce','stepName','Activity_Type__c','_packageExportService','Metadata_Log__c','saveDeploymentResults','generateAsync','PackageComponentStatus','\x20</a>','patch','default','\x20has\x20been\x20created.','FlosumConstants','SalesforceService','Component_Type__c','Branch','type','lastIndexOf','MetadataLogStatus','veeva-deploy','base64','\x20>\x20','Logger','SalesforceDmlError','Component_History__c','packageId','FlosumComponentVeevaComponentRetriever','createZip','search','getFlosumComponents','retrieveAttachments','_organisationName','_connectionVeeva','_metadataLogId','Save\x20log','filter','status','Job_Completed__c','../enums/status.enums','Join\x20all\x20mdl\x20into\x20one\x20zip','DeployService','6OYiBxo','get','success','Cannot\x20retrieve\x20all\x20components.','__importDefault','./package-export.service','Status__c','fs/promises','ENDPOINT_UPSERT_RECORD','execute','timeZone','Create\x20vpk\x20package','componentType','../constants/flosum.constants','../../../core','isDeployed','_logger','BACKUP_ZIP_NAME','Type__c'];a389_0x3ba2=function(){return _0x4733cc;};return a389_0x3ba2();}