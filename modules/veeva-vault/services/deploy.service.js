const a401_0x2f30d6=a401_0x45f2;(function(_0x35a3ce,_0x354120){const _0x12dd5b=a401_0x45f2,_0x352cb8=_0x35a3ce();while(!![]){try{const _0x514de2=-parseInt(_0x12dd5b(0x1b7))/0x1*(-parseInt(_0x12dd5b(0x235))/0x2)+parseInt(_0x12dd5b(0x1b2))/0x3+parseInt(_0x12dd5b(0x1ea))/0x4*(-parseInt(_0x12dd5b(0x20e))/0x5)+parseInt(_0x12dd5b(0x20f))/0x6+-parseInt(_0x12dd5b(0x1ff))/0x7*(-parseInt(_0x12dd5b(0x1ec))/0x8)+parseInt(_0x12dd5b(0x1f8))/0x9+-parseInt(_0x12dd5b(0x1cc))/0xa;if(_0x514de2===_0x354120)break;else _0x352cb8['push'](_0x352cb8['shift']());}catch(_0x5bd6c2){_0x352cb8['push'](_0x352cb8['shift']());}}}(a401_0x50ab,0x27527));const a401_0x40c6ec=(function(){let _0x411fe5=!![];return function(_0xd4d46e,_0x50c4eb){const _0x296111=_0x411fe5?function(){const _0x5904b1=a401_0x45f2;if(_0x50c4eb){const _0x53719d=_0x50c4eb[_0x5904b1(0x207)](_0xd4d46e,arguments);return _0x50c4eb=null,_0x53719d;}}:function(){};return _0x411fe5=![],_0x296111;};}()),a401_0x8921bc=a401_0x40c6ec(this,function(){const _0x294867=a401_0x45f2;return a401_0x8921bc[_0x294867(0x211)]()[_0x294867(0x1d8)](_0x294867(0x1cd))[_0x294867(0x211)]()['constructor'](a401_0x8921bc)[_0x294867(0x1d8)](_0x294867(0x1cd));});function a401_0x45f2(_0xe4da5,_0x527438){const _0x1ebacf=a401_0x50ab();return a401_0x45f2=function(_0x8921bc,_0x40c6ec){_0x8921bc=_0x8921bc-0x1ab;let _0x50abe6=_0x1ebacf[_0x8921bc];return _0x50abe6;},a401_0x45f2(_0xe4da5,_0x527438);}a401_0x8921bc();'use strict';var __importDefault=this&&this[a401_0x2f30d6(0x22d)]||function(_0x241667){return _0x241667&&_0x241667['__esModule']?_0x241667:{'default':_0x241667};};Object[a401_0x2f30d6(0x248)](exports,a401_0x2f30d6(0x231),{'value':!![]}),exports[a401_0x2f30d6(0x1ac)]=void 0x0;const jszip_1=__importDefault(require(a401_0x2f30d6(0x237))),promises_1=require(a401_0x2f30d6(0x1ed)),constants_1=require(a401_0x2f30d6(0x21a)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a401_0x2f30d6(0x20b)),salesforce_service_1=require(a401_0x2f30d6(0x22f)),core_1=require(a401_0x2f30d6(0x24e)),status_enums_1=require(a401_0x2f30d6(0x244)),salesforce_dml_error_1=require(a401_0x2f30d6(0x1e9)),shortid_1=__importDefault(require(a401_0x2f30d6(0x226))),fetch_attachments_1=require(a401_0x2f30d6(0x1b1)),package_import_service_1=require(a401_0x2f30d6(0x249)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a401_0x2f30d6(0x1e8)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a401_0x2f30d6(0x1bc)),zip_creator_deploy_1=require(a401_0x2f30d6(0x1ba));function a401_0x50ab(){const _0x117a76=['status','_organisationId','Cannot\x20Backup\x20more\x20than\x20200\x20components.','name','finishDeploy','reduce','saveLog','COMPLETED','isDeployed','timeZone','../enums/status.enums','TargetId__c','\x20:\x20','formFlosumDeploymentResults','defineProperty','./package-import.service','Join\x20all\x20mdl\x20into\x20one\x20zip','PackageImportService','execute','writeFile','../../../core','componentType','map','DeployService','PackageComponentStatus','Failure','post','Logger','../../shared/utils/fetch-attachments','114027pBmtJY','Deployment','<a\x20href=','Branch__c','Metadata_Log__c/','46247vCnFcO','Success','componentName','../classes/deploy/zip-creator.deploy','Activity_Item__c','./vpk.service','ENDPOINT_UPSERT_RECORD','generate','patch','type','_packageExportService','base64','Veeva\x20Deployment','Retrieving\x20components','createBackup','Save\x20log','filter','SalesforceDmlError','_deploymentName','_packageImportService','saveDeploymentResults','1600800oYKOBL','(((.+)+)+)+$','Body','Deploy\x20completed\x20','\x20of\x20branch\x20to\x20Organization\x20','\x20</a>','Type__c','Is_Error__c','Create\x20Backup','Component_Type__c','Deployment_Result__c','_metadataLogId','search','branchId','Succeed__c','fetchAttachmentsDetailsByParentId','retrieveAttachments','_tempFolder','slice','Status__c','deploymentName','packageComponentList','Create\x20vpk\x20package','has','metadataLogId','success','organisationName','_componentIdList','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','../classes/errors/salesforce-dml-error','8SZNGhJ','logError','87104SjPFuk','fs/promises','Form\x20Deployment\x20Results','_branchId','Org__c','_connectionSalesforce','FlosumComponentVeevaComponentRetriever','Activity_Type__c','createZip','packageId','finishDeployWithError','_organisationName','776349JijXuh','BACKUP_ZIP_NAME','/Attachment','import','MetadataLogStatus','updateLog','deploymentAction','7UAfaUM','length','Log__c','_veevaService','_salesforceService','_timeZone','export','lastIndexOf','apply','generateAsync','_attachmentLogId','_connectionVeeva','./veeva.service','log','saveBackup','578855oMRbIh','840270EBTuwG','organisationId','toString','retrieve','insertMultipleRecords','createVpk','_logger','VpkService','Date__c','attachmentLogId','SalesforceService','../../../constants','Save\x20Deployment\x20Results','Cannot\x20retrieve\x20all\x20components.','getFlosumComponents','toLowerCase','VeevaService','Action__c','successfully','External_Deployment_Id__c','veeva-deploy','with\x20error','_vpkService','shortid','_systemLogger','Component_Name__c','\x20>\x20','catch','DEPLOYED','FLOSUM_NAMESPACE','__importDefault','bind','./salesforce.service','\x20has\x20been\x20created.','__esModule','Cannot\x20retrievers\x20all\x20attachments','errors','FlosumConstants','12byuEvV','default','jszip','text/plain','Backup'];a401_0x50ab=function(){return _0x117a76;};return a401_0x50ab();}class DeployService{constructor(_0x47b60c,_0x2ab51c,_0x361b97,_0x3a0a59,_0x211747,_0x11e7fe){const _0x164389=a401_0x2f30d6;this[_0x164389(0x1f1)]=_0x2ab51c,this[_0x164389(0x20a)]=_0x361b97,this['_logger']=_0x3a0a59,this[_0x164389(0x1dd)]=_0x211747,this['_instanceUrl']=_0x11e7fe,this[_0x164389(0x1ef)]=_0x47b60c[_0x164389(0x1d9)],this[_0x164389(0x1d7)]=_0x47b60c[_0x164389(0x1e4)],this[_0x164389(0x209)]=_0x47b60c[_0x164389(0x218)],this[_0x164389(0x23b)]=_0x47b60c[_0x164389(0x210)],this[_0x164389(0x204)]=_0x47b60c[_0x164389(0x243)],this[_0x164389(0x1f7)]=_0x47b60c[_0x164389(0x1e6)],this[_0x164389(0x1e7)]=_0x47b60c['componentIdList'],this['_deploymentName']=_0x47b60c[_0x164389(0x1e0)],this[_0x164389(0x227)]=new core_1[(_0x164389(0x1b0))](_0x164389(0x223)),this[_0x164389(0x202)]=new veeva_service_1[(_0x164389(0x21f))]({'connection':this['_connectionVeeva'],'logger':this['_logger']}),this[_0x164389(0x203)]=new salesforce_service_1[(_0x164389(0x219))]({'connection':this[_0x164389(0x1f1)]}),this['_packageImportService']=new package_import_service_1[(_0x164389(0x24b))]({'veevaService':this[_0x164389(0x202)],'connection':this[_0x164389(0x20a)],'logger':this['_logger'],'saveLog':this[_0x164389(0x240)][_0x164389(0x22e)](this)}),this[_0x164389(0x1c1)]=new package_export_service_1['PackageExportService']({'veevaService':this['_veevaService'],'connection':this[_0x164389(0x20a)],'logger':this['_logger']}),this[_0x164389(0x225)]=new vpk_service_1[(_0x164389(0x216))]({'connection':this['_connectionVeeva']});}async[a401_0x2f30d6(0x24c)](){const _0x2e7b64=a401_0x2f30d6;try{const _0x547d78=await this['getFlosumComponents']();await this[_0x2e7b64(0x215)][_0x2e7b64(0x1fd)]();const _0x1d9501=await this[_0x2e7b64(0x1c5)](_0x547d78);await this[_0x2e7b64(0x20d)](_0x1d9501);const _0x3ed4b5=await this[_0x2e7b64(0x1dc)](_0x547d78),_0x1f0d9e=await this[_0x2e7b64(0x1f4)](_0x3ed4b5),_0x5a8c2b=await this[_0x2e7b64(0x214)](_0x1f0d9e);await this[_0x2e7b64(0x215)][_0x2e7b64(0x1fd)]();const _0x51c58f=await this[_0x2e7b64(0x1ca)][_0x2e7b64(0x1fb)](_0x5a8c2b);await this['_logger'][_0x2e7b64(0x1fd)]();const _0x8491=this[_0x2e7b64(0x247)](_0x547d78,_0x51c58f[_0x2e7b64(0x1e1)]);await this[_0x2e7b64(0x1cb)](_0x8491),await this[_0x2e7b64(0x23e)](_0x51c58f[_0x2e7b64(0x242)],![],_0x51c58f[_0x2e7b64(0x1f5)]);}catch(_0x2b115f){await this[_0x2e7b64(0x1f6)](_0x2b115f)[_0x2e7b64(0x22a)](_0x4bf268=>this[_0x2e7b64(0x227)]['error'](_0x4bf268));}}async[a401_0x2f30d6(0x21d)](){const _0x1ced36=a401_0x2f30d6,_0x3afbc7=new Set(this[_0x1ced36(0x1e7)]);this[_0x1ced36(0x215)][_0x1ced36(0x20c)](_0x1ced36(0x1c4));const _0x3bdf29=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this['_branchId'],'salesforceService':this[_0x1ced36(0x203)]})['retrieve'](),_0x4c130f=_0x3bdf29[_0x1ced36(0x1c7)](_0x4917eb=>_0x3afbc7[_0x1ced36(0x1e3)](_0x4917eb['id']));if(_0x4c130f[_0x1ced36(0x200)]!==this[_0x1ced36(0x1e7)][_0x1ced36(0x200)])throw new Error(_0x1ced36(0x21c));return _0x4c130f;}async[a401_0x2f30d6(0x1c5)](_0x574592){const _0x5193c3=a401_0x2f30d6;var _0x13b2b0;this[_0x5193c3(0x215)]['log'](_0x5193c3(0x1d4));const _0xfb9074=await new flosum_component_veeva_component_retriever_1[(_0x5193c3(0x1f2))]({'value':_0x574592,'veevaService':this[_0x5193c3(0x202)],'logger':this[_0x5193c3(0x215)]})[_0x5193c3(0x212)](),_0x33af8f=await this[_0x5193c3(0x1c1)][_0x5193c3(0x205)](_0xfb9074,_0x5193c3(0x239));if(_0x33af8f[_0x5193c3(0x200)]>0x1)throw new Error(_0x5193c3(0x23c));return(_0x13b2b0=_0x33af8f[0x0])!==null&&_0x13b2b0!==void 0x0?_0x13b2b0:_0x33af8f[0x0]=new jszip_1[(_0x5193c3(0x236))](),_0x33af8f[0x0][_0x5193c3(0x208)]({'type':'base64'});}async[a401_0x2f30d6(0x20d)](_0x1338fb){const _0x533234=a401_0x2f30d6;this['_logger']['log']('Save\x20Backup\x20to\x20Salesforce');const _0x3a2d89={'Body':_0x1338fb,'ContentType':'application/zip','ParentId':this['_metadataLogId'],'Name':flosum_constants_1['FlosumConstants'][_0x533234(0x1f9)]};await this[_0x533234(0x1f1)][_0x533234(0x1af)](flosum_constants_1[_0x533234(0x234)][_0x533234(0x1bd)]+_0x533234(0x1fa),_0x3a2d89);}async['retrieveAttachments'](_0x120ad0){const _0xcc390d=a401_0x2f30d6;this['_logger']['log']('Retrieving\x20attachments');const _0x549530=await(0x0,fetch_attachments_1[_0xcc390d(0x1db)])(this[_0xcc390d(0x1f1)],_0x120ad0[_0xcc390d(0x1ab)](_0x208a1e=>_0x208a1e['componentHistoryId'])),_0x7f292c=await(0x0,fetch_attachments_1[_0xcc390d(0x1dc)])(_0x549530,this[_0xcc390d(0x1f1)]);if(_0x7f292c[_0xcc390d(0x200)]!==this[_0xcc390d(0x1e7)][_0xcc390d(0x200)])throw new Error(_0xcc390d(0x232));return _0x7f292c[_0xcc390d(0x1ab)](_0x53e559=>_0x53e559['values'][_0xcc390d(0x1ce)]);}async[a401_0x2f30d6(0x1f4)](_0x5e12d2){const _0x3f0189=a401_0x2f30d6;this['_logger'][_0x3f0189(0x20c)](_0x3f0189(0x24a));const _0x26e04e=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x5e12d2,'deploymentName':this[_0x3f0189(0x1c9)]})[_0x3f0189(0x24c)](),_0x2a893c=this['_tempFolder']+'/'+(0x0,shortid_1[_0x3f0189(0x236)])()+'.zip';return await(0x0,promises_1[_0x3f0189(0x24d)])(_0x2a893c,_0x26e04e),_0x2a893c;}async[a401_0x2f30d6(0x214)](_0x1d4461){const _0x1392b2=a401_0x2f30d6;this[_0x1392b2(0x215)]['log'](_0x1392b2(0x1e2));const _0x2fc742=await this[_0x1392b2(0x225)][_0x1392b2(0x1be)](_0x1d4461),_0x44a143=this[_0x1392b2(0x1dd)]+'/vpk__'+_0x1d4461[_0x1392b2(0x1de)](_0x1d4461[_0x1392b2(0x206)]('/')+0x1);return await(0x0,promises_1[_0x1392b2(0x24d)])(_0x44a143,_0x2fc742),await this[_0x1392b2(0x225)]['validate'](_0x44a143),_0x44a143;}async['saveLog'](_0x1d66b9,_0x58ec7e){const _0x217db6=a401_0x2f30d6;this['_logger'][_0x217db6(0x20c)](_0x217db6(0x1c6));const _0x45dc87={'Body':Buffer['from'](_0x1d66b9)[_0x217db6(0x211)](_0x217db6(0x1c2)),'ContentType':_0x217db6(0x238),'ParentId':this['_metadataLogId'],'Name':_0x58ec7e};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x217db6(0x234)][_0x217db6(0x1bd)]+_0x217db6(0x1fa),_0x45dc87);}[a401_0x2f30d6(0x247)](_0x514068,_0x4995ab){const _0x5b99fb=a401_0x2f30d6;this[_0x5b99fb(0x215)][_0x5b99fb(0x20c)](_0x5b99fb(0x1ee));const _0x3bc93a=_0x514068[_0x5b99fb(0x23f)]((_0x15253d,_0x4651d9)=>_0x15253d['set']((_0x4651d9[_0x5b99fb(0x24f)]+'.'+_0x4651d9[_0x5b99fb(0x1b9)])[_0x5b99fb(0x21e)](),_0x4651d9),new Map());return _0x4995ab[_0x5b99fb(0x1ab)](_0x5a409f=>{const _0x36bad7=_0x5b99fb;this['_logger']['log'](_0x5a409f[_0x36bad7(0x1c0)]+'.'+_0x5a409f['name']+_0x36bad7(0x246)+_0x5a409f[_0x36bad7(0x23a)]);const _0x109715=(_0x5a409f[_0x36bad7(0x1c0)]+'.'+_0x5a409f[_0x36bad7(0x23d)])[_0x36bad7(0x21e)](),_0x509c3c=_0x3bc93a['get'](_0x109715);return{[constants_1[_0x36bad7(0x22c)]+_0x36bad7(0x1d2)]:'Deployment\x20Result',[constants_1[_0x36bad7(0x22c)]+_0x36bad7(0x1df)]:_0x5a409f[_0x36bad7(0x23a)]===status_enums_1[_0x36bad7(0x1ad)][_0x36bad7(0x22b)]?_0x36bad7(0x1b8):_0x36bad7(0x1ae),[constants_1[_0x36bad7(0x22c)]+'Result__c']:_0x5a409f[_0x36bad7(0x1fe)],[constants_1['FLOSUM_NAMESPACE']+_0x36bad7(0x228)]:_0x5a409f['name'],[constants_1['FLOSUM_NAMESPACE']+_0x36bad7(0x1d5)]:_0x5a409f['type'],[constants_1[_0x36bad7(0x22c)]+'Veeva_Step_Name__c']:_0x5a409f['stepName'],[constants_1['FLOSUM_NAMESPACE']+_0x36bad7(0x1f0)]:this[_0x36bad7(0x23b)],[constants_1[_0x36bad7(0x22c)]+'Metadata_Log__c']:this[_0x36bad7(0x1d7)],[constants_1[_0x36bad7(0x22c)]+'Component_History__c']:_0x509c3c['componentHistoryId']};});}async[a401_0x2f30d6(0x1cb)](_0x168616){const _0x4bc89a=a401_0x2f30d6;this[_0x4bc89a(0x215)][_0x4bc89a(0x20c)](_0x4bc89a(0x21b));const _0xe03e20=await this[_0x4bc89a(0x203)][_0x4bc89a(0x213)](constants_1['FLOSUM_NAMESPACE']+_0x4bc89a(0x1d6),_0x168616),_0x18542e=_0xe03e20['filter'](_0xac61be=>!_0xac61be[_0x4bc89a(0x1e5)])['map'](_0x32ab3e=>_0x32ab3e[_0x4bc89a(0x233)])['flat']();if(_0x18542e[_0x4bc89a(0x200)])throw new salesforce_dml_error_1[(_0x4bc89a(0x1c8))](_0x18542e);}async[a401_0x2f30d6(0x1f6)](_0x3d4747){const _0x564453=a401_0x2f30d6;this['_logger'][_0x564453(0x1eb)](_0x3d4747),await this[_0x564453(0x215)][_0x564453(0x1fd)](),await this[_0x564453(0x23e)](![],!![],'');}async[a401_0x2f30d6(0x23e)](_0x5b7ffe,_0x56bb5c,_0x5352d8){const _0x5f07c2=a401_0x2f30d6,_0x5f3c7e='<a\x20href='+this['_instanceUrl']+'/'+this[_0x5f07c2(0x1d7)]+_0x5f07c2(0x229)+_0x5f07c2(0x1c3)+_0x5f07c2(0x1d1),_0x2511d9=_0x5f07c2(0x1b4)+this['_instanceUrl']+'/'+this[_0x5f07c2(0x23b)]+'\x20>'+this[_0x5f07c2(0x1f7)]+'</a>',_0x5c9606=_0x5f3c7e+_0x5f07c2(0x1d0)+_0x2511d9+_0x5f07c2(0x230),_0x1ed035={[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x220)]:_0x5c9606,[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x217)]:new Date(),[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x1b5)]:this[_0x5f07c2(0x1ef)],[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x1bb)]:'Branch',[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x1f3)]:_0x5f07c2(0x1b3),[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x245)]:this[_0x5f07c2(0x23b)]},_0x11a21={[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x1d3)]:!_0x5b7ffe,[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x1da)]:_0x5b7ffe,[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x1df)]:_0x56bb5c?status_enums_1[_0x5f07c2(0x1fc)]['EXCEPTION']:status_enums_1[_0x5f07c2(0x1fc)][_0x5f07c2(0x241)],[constants_1[_0x5f07c2(0x22c)]+'Job_Completed__c']:!![],[constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x222)]:_0x5352d8};await this[_0x5f07c2(0x1f1)][_0x5f07c2(0x1bf)](flosum_constants_1[_0x5f07c2(0x234)][_0x5f07c2(0x1bd)]+'/'+constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x1b6)+this['_metadataLogId'],_0x11a21),await this[_0x5f07c2(0x1f1)][_0x5f07c2(0x1af)](flosum_constants_1['FlosumConstants'][_0x5f07c2(0x1bd)]+'/'+constants_1[_0x5f07c2(0x22c)]+_0x5f07c2(0x201),_0x1ed035),this[_0x5f07c2(0x215)][_0x5f07c2(0x20c)](_0x5f07c2(0x1cf)+(_0x5b7ffe?_0x5f07c2(0x221):_0x5f07c2(0x224))+'.'),await this[_0x5f07c2(0x215)][_0x5f07c2(0x1fd)]();}}exports['DeployService']=DeployService;