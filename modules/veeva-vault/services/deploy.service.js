const a401_0x339d8a=a401_0x4fd7;(function(_0x43c9a8,_0x157a70){const _0x572349=a401_0x4fd7,_0x4b5dad=_0x43c9a8();while(!![]){try{const _0x232ea2=-parseInt(_0x572349(0x200))/0x1+parseInt(_0x572349(0x241))/0x2+-parseInt(_0x572349(0x202))/0x3*(-parseInt(_0x572349(0x265))/0x4)+-parseInt(_0x572349(0x212))/0x5+-parseInt(_0x572349(0x243))/0x6*(parseInt(_0x572349(0x21e))/0x7)+-parseInt(_0x572349(0x24c))/0x8+parseInt(_0x572349(0x23a))/0x9*(parseInt(_0x572349(0x24e))/0xa);if(_0x232ea2===_0x157a70)break;else _0x4b5dad['push'](_0x4b5dad['shift']());}catch(_0x21c709){_0x4b5dad['push'](_0x4b5dad['shift']());}}}(a401_0x19b6,0xb7246));const a401_0x42a52c=(function(){let _0x16e369=!![];return function(_0x66bdf9,_0x335241){const _0xec96de=_0x16e369?function(){const _0x2afd1b=a401_0x4fd7;if(_0x335241){const _0x3bbfc7=_0x335241[_0x2afd1b(0x210)](_0x66bdf9,arguments);return _0x335241=null,_0x3bbfc7;}}:function(){};return _0x16e369=![],_0xec96de;};}()),a401_0x18f136=a401_0x42a52c(this,function(){const _0x47d365=a401_0x4fd7;return a401_0x18f136[_0x47d365(0x250)]()[_0x47d365(0x25b)]('(((.+)+)+)+$')['toString']()[_0x47d365(0x223)](a401_0x18f136)['search'](_0x47d365(0x1fc));});a401_0x18f136();'use strict';var __importDefault=this&&this[a401_0x339d8a(0x27b)]||function(_0x4e146a){return _0x4e146a&&_0x4e146a['__esModule']?_0x4e146a:{'default':_0x4e146a};};function a401_0x19b6(){const _0x418fee=['saveDeploymentResults','error','_vpkService','search','log','_connectionVeeva','Save\x20log','with\x20error','FlosumConstants','_systemLogger','text/plain','../../../core','Cannot\x20retrievers\x20all\x20attachments','76IxZTPU','../../../constants','shortid','Branch__c','toLowerCase','map','Metadata_Log__c/','BACKUP_ZIP_NAME','packageId','./vpk.service','<a\x20href=','Veeva\x20Deployment','Action__c','finishDeploy','veeva-deploy','Component_Name__c','Result__c','_deploymentName','_packageImportService','__esModule','import','Deployment_Result__c','__importDefault','PackageExportService','organisationName','filter','_organisationId','/vpk__','.zip','retrieveAttachments','organisationId','from','Logger','_timeZone','../classes/deploy/zip-creator.deploy','success','createZip','bind','DEPLOYED','_logger','saveBackup','\x20has\x20been\x20created.','\x20>\x20','stepName','post','DeployService','Activity_Type__c','patch','FLOSUM_NAMESPACE','Body','flat','createVpk','_packageExportService','isDeployed','_attachmentLogId','(((.+)+)+)+$','name','packageComponentList','componentHistoryId','405854fclmwp','formFlosumDeploymentResults','74031IAlSml','./salesforce.service','getFlosumComponents','fs/promises','_organisationName','slice','Veeva_Step_Name__c','_salesforceService','./package-export.service','writeFile','Succeed__c','Create\x20Backup','base64','type','apply','../classes/errors/salesforce-dml-error','5672470YKaUvU','External_Deployment_Id__c','SalesforceService','retrieve','_tempFolder','ENDPOINT_UPSERT_RECORD','export','componentName','FlosumComponentVeevaComponentRetriever','../enums/status.enums','</a>','_veevaService','10253117uaUKuS','_metadataLogId','VeevaService','Backup','metadataLogId','constructor','logError','Save\x20Backup\x20to\x20Salesforce','Deployment','./veeva.service','lastIndexOf','values','componentIdList','\x20:\x20','createBackup','PackageImportService','has','./package-import.service','Join\x20all\x20mdl\x20into\x20one\x20zip','set','updateLog','Component_Type__c','MetadataLogStatus','generate','errors','_instanceUrl','\x20</a>','deploymentName','50283aQDrgc','Create\x20vpk\x20package','attachmentLogId','componentType','insertMultipleRecords','../constants/flosum.constants','saveLog','1461104hZOnzc','Status__c','6Fxptuv','_componentIdList','length','Save\x20Deployment\x20Results','TargetId__c','_connectionSalesforce','Activity_Item__c','timeZone','validate','9812680eiANiT','deploymentAction','6770kfmlLU','finishDeployWithError','toString','Form\x20Deployment\x20Results','Branch','\x20of\x20branch\x20to\x20Organization\x20','_branchId','execute','Component_History__c','Retrieving\x20components'];a401_0x19b6=function(){return _0x418fee;};return a401_0x19b6();}Object['defineProperty'](exports,a401_0x339d8a(0x278),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a401_0x339d8a(0x205)),constants_1=require(a401_0x339d8a(0x266)),flosum_constants_1=require(a401_0x339d8a(0x23f)),veeva_service_1=require(a401_0x339d8a(0x227)),salesforce_service_1=require(a401_0x339d8a(0x203)),core_1=require(a401_0x339d8a(0x263)),status_enums_1=require(a401_0x339d8a(0x21b)),salesforce_dml_error_1=require(a401_0x339d8a(0x211)),shortid_1=__importDefault(require(a401_0x339d8a(0x267))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a401_0x339d8a(0x22f)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a401_0x339d8a(0x20a)),vpk_service_1=require(a401_0x339d8a(0x26e)),zip_creator_deploy_1=require(a401_0x339d8a(0x287));function a401_0x4fd7(_0x504802,_0x1125b9){const _0x20536e=a401_0x19b6();return a401_0x4fd7=function(_0x18f136,_0x42a52c){_0x18f136=_0x18f136-0x1f3;let _0x19b648=_0x20536e[_0x18f136];return _0x19b648;},a401_0x4fd7(_0x504802,_0x1125b9);}class DeployService{constructor(_0x17b420,_0x164f65,_0x33ad5b,_0x3fcea7,_0x2a45e5,_0x1b2d10){const _0x3fd085=a401_0x339d8a;this[_0x3fd085(0x248)]=_0x164f65,this[_0x3fd085(0x25d)]=_0x33ad5b,this[_0x3fd085(0x28c)]=_0x3fcea7,this[_0x3fd085(0x216)]=_0x2a45e5,this[_0x3fd085(0x237)]=_0x1b2d10,this['_branchId']=_0x17b420['branchId'],this[_0x3fd085(0x21f)]=_0x17b420[_0x3fd085(0x222)],this[_0x3fd085(0x1fb)]=_0x17b420[_0x3fd085(0x23c)],this[_0x3fd085(0x27f)]=_0x17b420[_0x3fd085(0x283)],this[_0x3fd085(0x286)]=_0x17b420[_0x3fd085(0x24a)],this[_0x3fd085(0x206)]=_0x17b420[_0x3fd085(0x27d)],this[_0x3fd085(0x244)]=_0x17b420[_0x3fd085(0x22a)],this[_0x3fd085(0x276)]=_0x17b420[_0x3fd085(0x239)],this[_0x3fd085(0x261)]=new core_1[(_0x3fd085(0x285))](_0x3fd085(0x273)),this[_0x3fd085(0x21d)]=new veeva_service_1[(_0x3fd085(0x220))]({'connection':this[_0x3fd085(0x25d)],'logger':this['_logger']}),this[_0x3fd085(0x209)]=new salesforce_service_1[(_0x3fd085(0x214))]({'connection':this[_0x3fd085(0x248)]}),this[_0x3fd085(0x277)]=new package_import_service_1[(_0x3fd085(0x22d))]({'veevaService':this[_0x3fd085(0x21d)],'connection':this[_0x3fd085(0x25d)],'logger':this['_logger'],'saveLog':this['saveLog'][_0x3fd085(0x28a)](this)}),this[_0x3fd085(0x1f9)]=new package_export_service_1[(_0x3fd085(0x27c))]({'veevaService':this[_0x3fd085(0x21d)],'connection':this[_0x3fd085(0x25d)],'logger':this[_0x3fd085(0x28c)]}),this[_0x3fd085(0x25a)]=new vpk_service_1['VpkService']({'connection':this[_0x3fd085(0x25d)]});}async[a401_0x339d8a(0x255)](){const _0x4f236c=a401_0x339d8a;try{const _0x551dbe=await this['getFlosumComponents']();await this[_0x4f236c(0x28c)]['updateLog']();const _0x2e96fe=await this[_0x4f236c(0x22c)](_0x551dbe);await this[_0x4f236c(0x28d)](_0x2e96fe);const _0x5c7f08=await this[_0x4f236c(0x282)](_0x551dbe),_0x3d4d29=await this[_0x4f236c(0x289)](_0x5c7f08),_0x2e0e6b=await this[_0x4f236c(0x1f8)](_0x3d4d29);await this[_0x4f236c(0x28c)][_0x4f236c(0x232)]();const _0x2a5bc2=await this[_0x4f236c(0x277)][_0x4f236c(0x279)](_0x2e0e6b);await this[_0x4f236c(0x28c)][_0x4f236c(0x232)]();const _0x10ed9e=this[_0x4f236c(0x201)](_0x551dbe,_0x2a5bc2[_0x4f236c(0x1fe)]);await this['saveDeploymentResults'](_0x10ed9e),await this[_0x4f236c(0x272)](_0x2a5bc2[_0x4f236c(0x1fa)],![],_0x2a5bc2[_0x4f236c(0x26d)]);}catch(_0x576fcd){await this[_0x4f236c(0x24f)](_0x576fcd)['catch'](_0x68d776=>this[_0x4f236c(0x261)][_0x4f236c(0x259)](_0x68d776));}}async[a401_0x339d8a(0x204)](){const _0x4d1d52=a401_0x339d8a,_0x4396b9=new Set(this['_componentIdList']);this[_0x4d1d52(0x28c)][_0x4d1d52(0x25c)](_0x4d1d52(0x257));const _0x6e9852=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x4d1d52(0x254)],'salesforceService':this['_salesforceService']})[_0x4d1d52(0x215)](),_0x704593=_0x6e9852[_0x4d1d52(0x27e)](_0x272ca9=>_0x4396b9[_0x4d1d52(0x22e)](_0x272ca9['id']));if(_0x704593[_0x4d1d52(0x245)]!==this['_componentIdList'][_0x4d1d52(0x245)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x704593;}async[a401_0x339d8a(0x22c)](_0xf253d4){const _0x1190fe=a401_0x339d8a;var _0x7b3fe1;this['_logger']['log'](_0x1190fe(0x20d));const _0x52bc9d=await new flosum_component_veeva_component_retriever_1[(_0x1190fe(0x21a))]({'value':_0xf253d4,'veevaService':this['_veevaService'],'logger':this[_0x1190fe(0x28c)]})[_0x1190fe(0x215)](),_0x294083=await this[_0x1190fe(0x1f9)][_0x1190fe(0x218)](_0x52bc9d,_0x1190fe(0x221));if(_0x294083[_0x1190fe(0x245)]>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x7b3fe1=_0x294083[0x0])!==null&&_0x7b3fe1!==void 0x0?_0x7b3fe1:_0x294083[0x0]=new jszip_1['default'](),_0x294083[0x0]['generateAsync']({'type':_0x1190fe(0x20e)});}async[a401_0x339d8a(0x28d)](_0x36547d){const _0x291f76=a401_0x339d8a;this[_0x291f76(0x28c)][_0x291f76(0x25c)](_0x291f76(0x225));const _0x552415={'Body':_0x36547d,'ContentType':'application/zip','ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x291f76(0x260)][_0x291f76(0x26c)]};await this[_0x291f76(0x248)][_0x291f76(0x291)](flosum_constants_1[_0x291f76(0x260)][_0x291f76(0x217)]+'/Attachment',_0x552415);}async[a401_0x339d8a(0x282)](_0x4013ab){const _0x4ff3a7=a401_0x339d8a;this[_0x4ff3a7(0x28c)]['log']('Retrieving\x20attachments');const _0xd8e7b4=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x4ff3a7(0x248)],_0x4013ab[_0x4ff3a7(0x26a)](_0x48df50=>_0x48df50['componentHistoryId'])),_0x5e6bd8=await(0x0,fetch_attachments_1[_0x4ff3a7(0x282)])(_0xd8e7b4,this[_0x4ff3a7(0x248)]);if(_0x5e6bd8['length']!==this[_0x4ff3a7(0x244)][_0x4ff3a7(0x245)])throw new Error(_0x4ff3a7(0x264));return _0x5e6bd8['map'](_0x23f8e4=>_0x23f8e4[_0x4ff3a7(0x229)][_0x4ff3a7(0x1f6)]);}async[a401_0x339d8a(0x289)](_0xfbe3e0){const _0x541616=a401_0x339d8a;this[_0x541616(0x28c)][_0x541616(0x25c)](_0x541616(0x230));const _0x78af88=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0xfbe3e0,'deploymentName':this[_0x541616(0x276)]})[_0x541616(0x255)](),_0x1c66e6=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0x541616(0x281);return await(0x0,promises_1[_0x541616(0x20b)])(_0x1c66e6,_0x78af88),_0x1c66e6;}async[a401_0x339d8a(0x1f8)](_0x2c82eb){const _0xc660e4=a401_0x339d8a;this[_0xc660e4(0x28c)]['log'](_0xc660e4(0x23b));const _0x4f521d=await this[_0xc660e4(0x25a)][_0xc660e4(0x235)](_0x2c82eb),_0xa9d641=this[_0xc660e4(0x216)]+_0xc660e4(0x280)+_0x2c82eb[_0xc660e4(0x207)](_0x2c82eb[_0xc660e4(0x228)]('/')+0x1);return await(0x0,promises_1[_0xc660e4(0x20b)])(_0xa9d641,_0x4f521d),await this[_0xc660e4(0x25a)][_0xc660e4(0x24b)](_0xa9d641),_0xa9d641;}async[a401_0x339d8a(0x240)](_0x1eaa5a,_0x37f76b){const _0x41fc68=a401_0x339d8a;this['_logger']['log'](_0x41fc68(0x25e));const _0x1cefc8={'Body':Buffer[_0x41fc68(0x284)](_0x1eaa5a)['toString'](_0x41fc68(0x20e)),'ContentType':_0x41fc68(0x262),'ParentId':this['_metadataLogId'],'Name':_0x37f76b};await this[_0x41fc68(0x248)]['post'](flosum_constants_1['FlosumConstants'][_0x41fc68(0x217)]+'/Attachment',_0x1cefc8);}[a401_0x339d8a(0x201)](_0x360e7e,_0x425a93){const _0x225aa3=a401_0x339d8a;this[_0x225aa3(0x28c)][_0x225aa3(0x25c)](_0x225aa3(0x251));const _0x2426d5=_0x360e7e['reduce']((_0x1f3dc6,_0x3c6c50)=>_0x1f3dc6[_0x225aa3(0x231)]((_0x3c6c50[_0x225aa3(0x23d)]+'.'+_0x3c6c50[_0x225aa3(0x219)])[_0x225aa3(0x269)](),_0x3c6c50),new Map());return _0x425a93[_0x225aa3(0x26a)](_0x11f999=>{const _0x42861a=_0x225aa3;this[_0x42861a(0x28c)][_0x42861a(0x25c)](_0x11f999[_0x42861a(0x20f)]+'.'+_0x11f999[_0x42861a(0x1fd)]+_0x42861a(0x22b)+_0x11f999['status']);const _0x4e181b=(_0x11f999['type']+'.'+_0x11f999[_0x42861a(0x1fd)])[_0x42861a(0x269)](),_0xa5331d=_0x2426d5['get'](_0x4e181b);return{[constants_1[_0x42861a(0x1f5)]+'Type__c']:'Deployment\x20Result',[constants_1[_0x42861a(0x1f5)]+'Status__c']:_0x11f999['status']===status_enums_1['PackageComponentStatus'][_0x42861a(0x28b)]?'Success':'Failure',[constants_1['FLOSUM_NAMESPACE']+_0x42861a(0x275)]:_0x11f999[_0x42861a(0x24d)],[constants_1[_0x42861a(0x1f5)]+_0x42861a(0x274)]:_0x11f999[_0x42861a(0x1fd)],[constants_1[_0x42861a(0x1f5)]+_0x42861a(0x233)]:_0x11f999[_0x42861a(0x20f)],[constants_1[_0x42861a(0x1f5)]+_0x42861a(0x208)]:_0x11f999[_0x42861a(0x290)],[constants_1['FLOSUM_NAMESPACE']+'Org__c']:this[_0x42861a(0x27f)],[constants_1[_0x42861a(0x1f5)]+'Metadata_Log__c']:this[_0x42861a(0x21f)],[constants_1[_0x42861a(0x1f5)]+_0x42861a(0x256)]:_0xa5331d[_0x42861a(0x1ff)]};});}async[a401_0x339d8a(0x258)](_0x149b97){const _0x3331fc=a401_0x339d8a;this[_0x3331fc(0x28c)][_0x3331fc(0x25c)](_0x3331fc(0x246));const _0x2b3537=await this[_0x3331fc(0x209)][_0x3331fc(0x23e)](constants_1[_0x3331fc(0x1f5)]+_0x3331fc(0x27a),_0x149b97),_0x46b508=_0x2b3537[_0x3331fc(0x27e)](_0x480eaf=>!_0x480eaf[_0x3331fc(0x288)])[_0x3331fc(0x26a)](_0x1bb82a=>_0x1bb82a[_0x3331fc(0x236)])[_0x3331fc(0x1f7)]();if(_0x46b508[_0x3331fc(0x245)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x46b508);}async[a401_0x339d8a(0x24f)](_0x3ae83d){const _0xf2e3b1=a401_0x339d8a;this[_0xf2e3b1(0x28c)][_0xf2e3b1(0x224)](_0x3ae83d),await this[_0xf2e3b1(0x28c)][_0xf2e3b1(0x232)](),await this[_0xf2e3b1(0x272)](![],!![],'');}async['finishDeploy'](_0x499993,_0x4292dc,_0x160b43){const _0x8cc343=a401_0x339d8a,_0x484730='<a\x20href='+this['_instanceUrl']+'/'+this['_metadataLogId']+_0x8cc343(0x28f)+_0x8cc343(0x270)+_0x8cc343(0x238),_0x27a2a3=_0x8cc343(0x26f)+this[_0x8cc343(0x237)]+'/'+this['_organisationId']+'\x20>'+this[_0x8cc343(0x206)]+_0x8cc343(0x21c),_0x2088e8=_0x484730+_0x8cc343(0x253)+_0x27a2a3+_0x8cc343(0x28e),_0x1e400b={[constants_1[_0x8cc343(0x1f5)]+_0x8cc343(0x271)]:_0x2088e8,[constants_1[_0x8cc343(0x1f5)]+'Date__c']:new Date(),[constants_1[_0x8cc343(0x1f5)]+_0x8cc343(0x268)]:this[_0x8cc343(0x254)],[constants_1[_0x8cc343(0x1f5)]+_0x8cc343(0x249)]:_0x8cc343(0x252),[constants_1[_0x8cc343(0x1f5)]+_0x8cc343(0x1f3)]:_0x8cc343(0x226),[constants_1[_0x8cc343(0x1f5)]+_0x8cc343(0x247)]:this['_organisationId']},_0x3a900a={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x499993,[constants_1[_0x8cc343(0x1f5)]+_0x8cc343(0x20c)]:_0x499993,[constants_1['FLOSUM_NAMESPACE']+_0x8cc343(0x242)]:_0x4292dc?status_enums_1[_0x8cc343(0x234)]['EXCEPTION']:status_enums_1[_0x8cc343(0x234)]['COMPLETED'],[constants_1[_0x8cc343(0x1f5)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x8cc343(0x213)]:_0x160b43};await this[_0x8cc343(0x248)][_0x8cc343(0x1f4)](flosum_constants_1[_0x8cc343(0x260)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x8cc343(0x26b)+this[_0x8cc343(0x21f)],_0x3a900a),await this[_0x8cc343(0x248)]['post'](flosum_constants_1[_0x8cc343(0x260)][_0x8cc343(0x217)]+'/'+constants_1[_0x8cc343(0x1f5)]+'Log__c',_0x1e400b),this[_0x8cc343(0x28c)][_0x8cc343(0x25c)]('Deploy\x20completed\x20'+(_0x499993?'successfully':_0x8cc343(0x25f))+'.'),await this['_logger'][_0x8cc343(0x232)]();}}exports[a401_0x339d8a(0x292)]=DeployService;