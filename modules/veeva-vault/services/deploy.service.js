function a358_0x3d9d(){const _0x353823=['updateLog','retrieve','catch','6168726NdEiYf','../constants/flosum.constants','log','writeFile','Join\x20all\x20mdl\x20into\x20one\x20zip','from','default','/Attachment','base64','Deployment_Result__c','generate','toString','../enums/status.enums','timeZone','Activity_Item__c','Activity_Type__c','validate','map','FLOSUM_NAMESPACE','name','getFlosumComponents','saveBackup','Date__c','Create\x20Backup','./vpk.service','insertMultipleRecords','\x20of\x20branch\x20to\x20Organization\x20','168567hIhwhJ','./package-export.service','Backup','1913822gnDxlm','type','apply','Job_Completed__c','saveDeploymentResults','__esModule','../classes/deploy/zip-creator.deploy','\x20:\x20','339648FokZmq','stepName','_deploymentName','/vpk__','_attachmentLogId','_salesforceService','Result__c','3005ogmjbf','jszip','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Body','error','isDeployed','COMPLETED','_componentIdList','7hiKFKt','Success','_branchId','createVpk','patch','success','_tempFolder','finishDeploy','post','_connectionSalesforce','</a>','BranchComponentHistoryFlosumComponentRetriever','execute','\x20</a>','createBackup','3419471epjiqN','branchId','FlosumConstants','Save\x20Deployment\x20Results','slice','packageComponentList','successfully','bind','set','Org__c','__importDefault','SalesforceDmlError','organisationName','Failure','get','VpkService','Branch','deploymentName','_instanceUrl','BACKUP_ZIP_NAME','application/zip','filter','_systemLogger','_vpkService','70DucWww','metadataLogId','../classes/errors/salesforce-dml-error','2316NAsdPT','Cannot\x20retrievers\x20all\x20attachments','length','saveLog','1564808fixNCz','_packageExportService','PackageComponentStatus','_packageImportService','_veevaService','./package-import.service','_organisationName','Retrieving\x20attachments','Veeva\x20Deployment','Veeva_Step_Name__c','_connectionVeeva','componentHistoryId','../../shared/utils/fetch-attachments','flat','TargetId__c','PackageExportService','_organisationId','.zip','Component_Type__c','componentType','componentName','\x20>\x20','Action__c','../../../core','Component_Name__c','createZip','export','\x20has\x20been\x20created.','252CoKrkn','<a\x20href=','generateAsync','retrieveAttachments','toLowerCase','Status__c','../../../constants','search','packageId','SalesforceService','Log__c','import','Metadata_Log__c','shortid','DEPLOYED','ZipCreatorDeploy','_logger','fetchAttachmentsDetailsByParentId','_timeZone','organisationId','ENDPOINT_UPSERT_RECORD','attachmentLogId','formFlosumDeploymentResults','EXCEPTION','Component_History__c','MetadataLogStatus','Save\x20log','_metadataLogId','reduce','errors'];a358_0x3d9d=function(){return _0x353823;};return a358_0x3d9d();}function a358_0x3370(_0x24784c,_0x569578){const _0x26382e=a358_0x3d9d();return a358_0x3370=function(_0x34c881,_0x440f71){_0x34c881=_0x34c881-0x65;let _0x3d9dea=_0x26382e[_0x34c881];return _0x3d9dea;},a358_0x3370(_0x24784c,_0x569578);}const a358_0xaf0af6=a358_0x3370;(function(_0x5737b1,_0x30752c){const _0x55561e=a358_0x3370,_0x2772f6=_0x5737b1();while(!![]){try{const _0x2038db=parseInt(_0x55561e(0xdc))/0x1+parseInt(_0x55561e(0x97))/0x2+-parseInt(_0x55561e(0x94))/0x3+-parseInt(_0x55561e(0xd8))/0x4*(-parseInt(_0x55561e(0xa6))/0x5)+-parseInt(_0x55561e(0x79))/0x6*(parseInt(_0x55561e(0xae))/0x7)+parseInt(_0x55561e(0x9f))/0x8*(parseInt(_0x55561e(0xf8))/0x9)+-parseInt(_0x55561e(0xd5))/0xa*(parseInt(_0x55561e(0xbd))/0xb);if(_0x2038db===_0x30752c)break;else _0x2772f6['push'](_0x2772f6['shift']());}catch(_0x15a3f){_0x2772f6['push'](_0x2772f6['shift']());}}}(a358_0x3d9d,0xc2db1));const a358_0x440f71=(function(){let _0x2ef2aa=!![];return function(_0x1ad899,_0x3278e9){const _0x4fe6f9=_0x2ef2aa?function(){const _0x517082=a358_0x3370;if(_0x3278e9){const _0x557b55=_0x3278e9[_0x517082(0x99)](_0x1ad899,arguments);return _0x3278e9=null,_0x557b55;}}:function(){};return _0x2ef2aa=![],_0x4fe6f9;};}()),a358_0x34c881=a358_0x440f71(this,function(){const _0x38625e=a358_0x3370;return a358_0x34c881[_0x38625e(0x84)]()['search']('(((.+)+)+)+$')[_0x38625e(0x84)]()['constructor'](a358_0x34c881)[_0x38625e(0xff)]('(((.+)+)+)+$');});a358_0x34c881();'use strict';var __importDefault=this&&this[a358_0xaf0af6(0xc7)]||function(_0x8b051f){const _0x13063a=a358_0xaf0af6;return _0x8b051f&&_0x8b051f[_0x13063a(0x9c)]?_0x8b051f:{'default':_0x8b051f};};Object['defineProperty'](exports,a358_0xaf0af6(0x9c),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a358_0xaf0af6(0xa7))),promises_1=require('fs/promises'),constants_1=require(a358_0xaf0af6(0xfe)),flosum_constants_1=require(a358_0xaf0af6(0x7a)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),core_1=require(a358_0xaf0af6(0xf3)),status_enums_1=require(a358_0xaf0af6(0x85)),salesforce_dml_error_1=require(a358_0xaf0af6(0xd7)),shortid_1=__importDefault(require(a358_0xaf0af6(0x65))),fetch_attachments_1=require(a358_0xaf0af6(0xe8)),package_import_service_1=require(a358_0xaf0af6(0xe1)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a358_0xaf0af6(0xa8)),package_export_service_1=require(a358_0xaf0af6(0x95)),vpk_service_1=require(a358_0xaf0af6(0x91)),zip_creator_deploy_1=require(a358_0xaf0af6(0x9d));class DeployService{constructor(_0x29edc0,_0xe8f685,_0x57ff71,_0x46922b,_0x4575c6,_0x39d05a){const _0x200929=a358_0xaf0af6;this['_connectionSalesforce']=_0xe8f685,this[_0x200929(0xe6)]=_0x57ff71,this[_0x200929(0x68)]=_0x46922b,this[_0x200929(0xb4)]=_0x4575c6,this[_0x200929(0xcf)]=_0x39d05a,this[_0x200929(0xb0)]=_0x29edc0[_0x200929(0xbe)],this['_metadataLogId']=_0x29edc0[_0x200929(0xd6)],this[_0x200929(0xa3)]=_0x29edc0[_0x200929(0x6d)],this[_0x200929(0xec)]=_0x29edc0[_0x200929(0x6b)],this[_0x200929(0x6a)]=_0x29edc0[_0x200929(0x86)],this[_0x200929(0xe2)]=_0x29edc0[_0x200929(0xc9)],this[_0x200929(0xad)]=_0x29edc0['componentIdList'],this[_0x200929(0xa1)]=_0x29edc0[_0x200929(0xce)],this[_0x200929(0xd3)]=new core_1['Logger']('veeva-deploy'),this[_0x200929(0xe0)]=new veeva_service_1['VeevaService']({'connection':this[_0x200929(0xe6)],'logger':this['_logger']}),this[_0x200929(0xa4)]=new salesforce_service_1[(_0x200929(0x101))]({'connection':this[_0x200929(0xb7)]}),this['_packageImportService']=new package_import_service_1['PackageImportService']({'veevaService':this['_veevaService'],'connection':this[_0x200929(0xe6)],'logger':this[_0x200929(0x68)],'saveLog':this[_0x200929(0xdb)][_0x200929(0xc4)](this)}),this[_0x200929(0xdd)]=new package_export_service_1[(_0x200929(0xeb))]({'veevaService':this[_0x200929(0xe0)],'connection':this['_connectionVeeva'],'logger':this[_0x200929(0x68)]}),this[_0x200929(0xd4)]=new vpk_service_1[(_0x200929(0xcc))]({'connection':this[_0x200929(0xe6)]});}async['execute'](){const _0x2acbb1=a358_0xaf0af6;try{const _0x304ae5=await this[_0x2acbb1(0x8d)]();await this[_0x2acbb1(0x68)][_0x2acbb1(0x76)]();const _0x10cf5f=await this[_0x2acbb1(0xbc)](_0x304ae5);await this[_0x2acbb1(0x8e)](_0x10cf5f);const _0x288112=await this['retrieveAttachments'](_0x304ae5),_0x3ccbac=await this[_0x2acbb1(0xf5)](_0x288112),_0x1179bb=await this['createVpk'](_0x3ccbac);await this[_0x2acbb1(0x68)]['updateLog']();const _0x177005=await this[_0x2acbb1(0xdf)][_0x2acbb1(0x103)](_0x1179bb);await this[_0x2acbb1(0x68)][_0x2acbb1(0x76)]();const _0x243524=this[_0x2acbb1(0x6e)](_0x304ae5,_0x177005[_0x2acbb1(0xc2)]);await this[_0x2acbb1(0x9b)](_0x243524),await this[_0x2acbb1(0xb5)](_0x177005[_0x2acbb1(0xab)],![],_0x177005[_0x2acbb1(0x100)]);}catch(_0x3fa257){await this['finishDeployWithError'](_0x3fa257)[_0x2acbb1(0x78)](_0x57c5b0=>this[_0x2acbb1(0xd3)][_0x2acbb1(0xaa)](_0x57c5b0));}}async[a358_0xaf0af6(0x8d)](){const _0x500bf6=a358_0xaf0af6,_0x52abca=new Set(this['_componentIdList']);this[_0x500bf6(0x68)][_0x500bf6(0x7b)]('Retrieving\x20components');const _0x3cb1fc=await new branch_component_history_flosum_component_retriever_1[(_0x500bf6(0xb9))]({'value':this[_0x500bf6(0xb0)],'salesforceService':this[_0x500bf6(0xa4)]})[_0x500bf6(0x77)](),_0x3984b9=_0x3cb1fc[_0x500bf6(0xd2)](_0x4c9728=>_0x52abca['has'](_0x4c9728['id']));if(_0x3984b9[_0x500bf6(0xda)]!==this['_componentIdList'][_0x500bf6(0xda)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x3984b9;}async['createBackup'](_0x93a6a1){const _0x4cf912=a358_0xaf0af6;var _0x1528aa;this[_0x4cf912(0x68)][_0x4cf912(0x7b)](_0x4cf912(0x90));const _0x490235=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x93a6a1,'veevaService':this[_0x4cf912(0xe0)],'logger':this[_0x4cf912(0x68)]})['retrieve'](),_0x25d762=await this[_0x4cf912(0xdd)][_0x4cf912(0xf6)](_0x490235,_0x4cf912(0x96));if(_0x25d762['length']>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x1528aa=_0x25d762[0x0])!==null&&_0x1528aa!==void 0x0?_0x1528aa:_0x25d762[0x0]=new jszip_1[(_0x4cf912(0x7f))](),_0x25d762[0x0][_0x4cf912(0xfa)]({'type':_0x4cf912(0x81)});}async['saveBackup'](_0x2c3f34){const _0x3f2ee6=a358_0xaf0af6;this[_0x3f2ee6(0x68)][_0x3f2ee6(0x7b)]('Save\x20Backup\x20to\x20Salesforce');const _0x1bb533={'Body':_0x2c3f34,'ContentType':_0x3f2ee6(0xd1),'ParentId':this[_0x3f2ee6(0x73)],'Name':flosum_constants_1[_0x3f2ee6(0xbf)][_0x3f2ee6(0xd0)]};await this[_0x3f2ee6(0xb7)][_0x3f2ee6(0xb6)](flosum_constants_1[_0x3f2ee6(0xbf)][_0x3f2ee6(0x6c)]+_0x3f2ee6(0x80),_0x1bb533);}async['retrieveAttachments'](_0x4c984e){const _0x2595e0=a358_0xaf0af6;this[_0x2595e0(0x68)][_0x2595e0(0x7b)](_0x2595e0(0xe3));const _0xae9adb=await(0x0,fetch_attachments_1[_0x2595e0(0x69)])(this[_0x2595e0(0xb7)],_0x4c984e[_0x2595e0(0x8a)](_0x37165e=>_0x37165e[_0x2595e0(0xe7)])),_0x1d2b83=await(0x0,fetch_attachments_1[_0x2595e0(0xfb)])(_0xae9adb,this['_connectionSalesforce']);if(_0x1d2b83['length']!==this['_componentIdList']['length'])throw new Error(_0x2595e0(0xd9));return _0x1d2b83['map'](_0x54a675=>_0x54a675['values'][_0x2595e0(0xa9)]);}async[a358_0xaf0af6(0xf5)](_0x113a35){const _0x24a9be=a358_0xaf0af6;this[_0x24a9be(0x68)][_0x24a9be(0x7b)](_0x24a9be(0x7d));const _0x4fe419=await new zip_creator_deploy_1[(_0x24a9be(0x67))]({'attachmentBodies':_0x113a35,'deploymentName':this[_0x24a9be(0xa1)]})[_0x24a9be(0xba)](),_0x21b815=this[_0x24a9be(0xb4)]+'/'+(0x0,shortid_1[_0x24a9be(0x7f)])()+_0x24a9be(0xed);return await(0x0,promises_1['writeFile'])(_0x21b815,_0x4fe419),_0x21b815;}async[a358_0xaf0af6(0xb1)](_0x45c1cd){const _0x3e99c3=a358_0xaf0af6;this['_logger'][_0x3e99c3(0x7b)]('Create\x20vpk\x20package');const _0x1d78a8=await this[_0x3e99c3(0xd4)][_0x3e99c3(0x83)](_0x45c1cd),_0x4f8e7f=this['_tempFolder']+_0x3e99c3(0xa2)+_0x45c1cd[_0x3e99c3(0xc1)](_0x45c1cd['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x3e99c3(0x7c)])(_0x4f8e7f,_0x1d78a8),await this[_0x3e99c3(0xd4)][_0x3e99c3(0x89)](_0x4f8e7f),_0x4f8e7f;}async[a358_0xaf0af6(0xdb)](_0x58b8a2,_0x160ee5){const _0xfe2717=a358_0xaf0af6;this['_logger'][_0xfe2717(0x7b)](_0xfe2717(0x72));const _0xf5ce58={'Body':Buffer[_0xfe2717(0x7e)](_0x58b8a2)[_0xfe2717(0x84)](_0xfe2717(0x81)),'ContentType':'text/plain','ParentId':this[_0xfe2717(0x73)],'Name':_0x160ee5};await this['_connectionSalesforce'][_0xfe2717(0xb6)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0xfe2717(0x80),_0xf5ce58);}[a358_0xaf0af6(0x6e)](_0x25ebf6,_0x4daa27){const _0xada643=a358_0xaf0af6;this['_logger'][_0xada643(0x7b)]('Form\x20Deployment\x20Results');const _0x16721f=_0x25ebf6[_0xada643(0x74)]((_0x5e3716,_0x208479)=>_0x5e3716[_0xada643(0xc5)]((_0x208479[_0xada643(0xef)]+'.'+_0x208479[_0xada643(0xf0)])[_0xada643(0xfc)](),_0x208479),new Map());return _0x4daa27[_0xada643(0x8a)](_0x530a17=>{const _0x3d123f=_0xada643;this[_0x3d123f(0x68)][_0x3d123f(0x7b)](_0x530a17[_0x3d123f(0x98)]+'.'+_0x530a17[_0x3d123f(0x8c)]+_0x3d123f(0x9e)+_0x530a17['status']);const _0x5ba7d4=(_0x530a17['type']+'.'+_0x530a17['name'])[_0x3d123f(0xfc)](),_0x4f437a=_0x16721f[_0x3d123f(0xcb)](_0x5ba7d4);return{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:'Deployment\x20Result',[constants_1[_0x3d123f(0x8b)]+_0x3d123f(0xfd)]:_0x530a17['status']===status_enums_1[_0x3d123f(0xde)][_0x3d123f(0x66)]?_0x3d123f(0xaf):_0x3d123f(0xca),[constants_1['FLOSUM_NAMESPACE']+_0x3d123f(0xa5)]:_0x530a17['deploymentAction'],[constants_1[_0x3d123f(0x8b)]+_0x3d123f(0xf4)]:_0x530a17['name'],[constants_1[_0x3d123f(0x8b)]+_0x3d123f(0xee)]:_0x530a17[_0x3d123f(0x98)],[constants_1[_0x3d123f(0x8b)]+_0x3d123f(0xe5)]:_0x530a17[_0x3d123f(0xa0)],[constants_1[_0x3d123f(0x8b)]+_0x3d123f(0xc6)]:this[_0x3d123f(0xec)],[constants_1[_0x3d123f(0x8b)]+_0x3d123f(0x104)]:this['_metadataLogId'],[constants_1[_0x3d123f(0x8b)]+_0x3d123f(0x70)]:_0x4f437a[_0x3d123f(0xe7)]};});}async[a358_0xaf0af6(0x9b)](_0x3d07ff){const _0x298038=a358_0xaf0af6;this[_0x298038(0x68)]['log'](_0x298038(0xc0));const _0x57b8df=await this[_0x298038(0xa4)][_0x298038(0x92)](constants_1[_0x298038(0x8b)]+_0x298038(0x82),_0x3d07ff),_0x6235da=_0x57b8df[_0x298038(0xd2)](_0x28ac73=>!_0x28ac73[_0x298038(0xb3)])[_0x298038(0x8a)](_0x367504=>_0x367504[_0x298038(0x75)])[_0x298038(0xe9)]();if(_0x6235da[_0x298038(0xda)])throw new salesforce_dml_error_1[(_0x298038(0xc8))](_0x6235da);}async['finishDeployWithError'](_0x482c23){const _0x210b27=a358_0xaf0af6;this[_0x210b27(0x68)]['logError'](_0x482c23),await this[_0x210b27(0x68)][_0x210b27(0x76)](),await this[_0x210b27(0xb5)](![],!![],'');}async['finishDeploy'](_0x591396,_0x217d0c,_0xaae871){const _0x569c6d=a358_0xaf0af6,_0x20cfbc=_0x569c6d(0xf9)+this[_0x569c6d(0xcf)]+'/'+this['_metadataLogId']+_0x569c6d(0xf1)+_0x569c6d(0xe4)+_0x569c6d(0xbb),_0x2b1a61=_0x569c6d(0xf9)+this[_0x569c6d(0xcf)]+'/'+this['_organisationId']+'\x20>'+this['_organisationName']+_0x569c6d(0xb8),_0x30272a=_0x20cfbc+_0x569c6d(0x93)+_0x2b1a61+_0x569c6d(0xf7),_0x115e91={[constants_1[_0x569c6d(0x8b)]+_0x569c6d(0xf2)]:_0x30272a,[constants_1[_0x569c6d(0x8b)]+_0x569c6d(0x8f)]:new Date(),[constants_1[_0x569c6d(0x8b)]+'Branch__c']:this[_0x569c6d(0xb0)],[constants_1['FLOSUM_NAMESPACE']+_0x569c6d(0x87)]:_0x569c6d(0xcd),[constants_1[_0x569c6d(0x8b)]+_0x569c6d(0x88)]:'Deployment',[constants_1[_0x569c6d(0x8b)]+_0x569c6d(0xea)]:this[_0x569c6d(0xec)]},_0x1311dc={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x591396,[constants_1[_0x569c6d(0x8b)]+'Succeed__c']:_0x591396,[constants_1[_0x569c6d(0x8b)]+'Status__c']:_0x217d0c?status_enums_1[_0x569c6d(0x71)][_0x569c6d(0x6f)]:status_enums_1[_0x569c6d(0x71)][_0x569c6d(0xac)],[constants_1[_0x569c6d(0x8b)]+_0x569c6d(0x9a)]:!![],[constants_1[_0x569c6d(0x8b)]+'External_Deployment_Id__c']:_0xaae871};await this[_0x569c6d(0xb7)][_0x569c6d(0xb2)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x569c6d(0x8b)]+'Metadata_Log__c/'+this[_0x569c6d(0x73)],_0x1311dc),await this['_connectionSalesforce'][_0x569c6d(0xb6)](flosum_constants_1['FlosumConstants'][_0x569c6d(0x6c)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x569c6d(0x102),_0x115e91),this[_0x569c6d(0x68)][_0x569c6d(0x7b)]('Deploy\x20completed\x20'+(_0x591396?_0x569c6d(0xc3):'with\x20error')+'.'),await this[_0x569c6d(0x68)]['updateLog']();}}exports['DeployService']=DeployService;