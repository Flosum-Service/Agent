const a401_0x2e791d=a401_0x1c5f;function a401_0xf78b(){const _0x2164e2=['metadataLogId','_branchId','BranchComponentHistoryFlosumComponentRetriever','Save\x20Deployment\x20Results','createVpk','map','Retrieving\x20attachments','Log__c','post','Body','text/plain','Component_History__c','102706nhvJYl','_salesforceService','Cannot\x20retrieve\x20all\x20components.','get','fs/promises','saveDeploymentResults','SalesforceDmlError','Succeed__c','590448CjBWwi','toString','../classes/deploy/zip-creator.deploy','7jDXfDX','log','\x20>\x20','default','Component_Type__c','successfully','values','lastIndexOf','validate','External_Deployment_Id__c','base64','filter','_veevaService','_metadataLogId','bind','generate','ENDPOINT_UPSERT_RECORD','success','\x20:\x20','componentIdList','./package-import.service','writeFile','finishDeployWithError','getFlosumComponents','Org__c','length','DeployService','Save\x20Backup\x20to\x20Salesforce','createBackup','Retrieving\x20components','SalesforceService','./salesforce.service','logError','_connectionVeeva','.zip','_componentIdList','\x20of\x20branch\x20to\x20Organization\x20','Action__c','FlosumConstants','(((.+)+)+)+$','execute','Form\x20Deployment\x20Results','has','packageId','componentType','_organisationId','Save\x20log','stepName','VeevaService','status','createZip','from','217800lRajZE','_connectionSalesforce','formFlosumDeploymentResults','_tempFolder','../enums/status.enums','timeZone','MetadataLogStatus','_instanceUrl','branchId','componentHistoryId','error','Failure','Create\x20vpk\x20package','search','VpkService','Deployment\x20Result','<a\x20href=','retrieveAttachments','saveLog','EXCEPTION','_systemLogger','reduce','Branch__c','set','Activity_Item__c','\x20has\x20been\x20created.','type','/Attachment','../../../constants','_attachmentLogId','apply','4PuVjOe','Type__c','name','Metadata_Log__c','1455640QmpqXx','insertMultipleRecords','finishDeploy','deploymentAction','685727rxEuwT','packageComponentList','with\x20error','./package-export.service','Veeva\x20Deployment','./vpk.service','../constants/flosum.constants','_packageImportService','slice','_packageExportService','_deploymentName','7331280ItZoLK','PackageComponentStatus','../classes/errors/salesforce-dml-error','../../shared/utils/fetch-attachments','constructor','organisationName','/vpk__','Veeva_Step_Name__c','Activity_Type__c','</a>','Date__c','PackageExportService','deploymentName','updateLog','patch','saveBackup','import','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','export','_timeZone','retrieve','9xOJVKX','jszip','Success','generateAsync','_vpkService','705095PQMXmW','toLowerCase','catch','FLOSUM_NAMESPACE','Status__c','_logger','isDeployed','Job_Completed__c','_organisationName','Deployment','componentName','Logger','./veeva.service','Join\x20all\x20mdl\x20into\x20one\x20zip','PackageImportService'];a401_0xf78b=function(){return _0x2164e2;};return a401_0xf78b();}(function(_0x890525,_0x3c6458){const _0x2267d5=a401_0x1c5f,_0x237afd=_0x890525();while(!![]){try{const _0x22f896=-parseInt(_0x2267d5(0xe4))/0x1*(parseInt(_0x2267d5(0xd9))/0x2)+-parseInt(_0x2267d5(0xe1))/0x3+-parseInt(_0x2267d5(0x91))/0x4*(parseInt(_0x2267d5(0xbe))/0x5)+parseInt(_0x2267d5(0x118))/0x6+parseInt(_0x2267d5(0x99))/0x7+-parseInt(_0x2267d5(0x95))/0x8*(-parseInt(_0x2267d5(0xb9))/0x9)+parseInt(_0x2267d5(0xa4))/0xa;if(_0x22f896===_0x3c6458)break;else _0x237afd['push'](_0x237afd['shift']());}catch(_0x55b568){_0x237afd['push'](_0x237afd['shift']());}}}(a401_0xf78b,0x55f26));function a401_0x1c5f(_0x536453,_0xc8f19f){const _0x59788f=a401_0xf78b();return a401_0x1c5f=function(_0x5f0d24,_0xc8eb8b){_0x5f0d24=_0x5f0d24-0x73;let _0xf78b55=_0x59788f[_0x5f0d24];return _0xf78b55;},a401_0x1c5f(_0x536453,_0xc8f19f);}const a401_0xc8eb8b=(function(){let _0x231ea0=!![];return function(_0x363ba9,_0x53dc5f){const _0x5ca246=_0x231ea0?function(){const _0x4df8b5=a401_0x1c5f;if(_0x53dc5f){const _0x1b1ea9=_0x53dc5f[_0x4df8b5(0x90)](_0x363ba9,arguments);return _0x53dc5f=null,_0x1b1ea9;}}:function(){};return _0x231ea0=![],_0x5ca246;};}()),a401_0x5f0d24=a401_0xc8eb8b(this,function(){const _0x379ef7=a401_0x1c5f;return a401_0x5f0d24[_0x379ef7(0xe2)]()[_0x379ef7(0x7f)](_0x379ef7(0x10b))[_0x379ef7(0xe2)]()[_0x379ef7(0xa8)](a401_0x5f0d24)[_0x379ef7(0x7f)](_0x379ef7(0x10b));});a401_0x5f0d24();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x502110){return _0x502110&&_0x502110['__esModule']?_0x502110:{'default':_0x502110};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a401_0x2e791d(0xfe)]=void 0x0;const jszip_1=__importDefault(require(a401_0x2e791d(0xba))),promises_1=require(a401_0x2e791d(0xdd)),constants_1=require(a401_0x2e791d(0x8e)),flosum_constants_1=require(a401_0x2e791d(0x9f)),veeva_service_1=require(a401_0x2e791d(0xca)),salesforce_service_1=require(a401_0x2e791d(0x103)),core_1=require('../../../core'),status_enums_1=require(a401_0x2e791d(0x76)),salesforce_dml_error_1=require(a401_0x2e791d(0xa6)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require(a401_0x2e791d(0xa7)),package_import_service_1=require(a401_0x2e791d(0xf8)),branch_component_history_flosum_component_retriever_1=require(a401_0x2e791d(0xb5)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a401_0x2e791d(0x9c)),vpk_service_1=require(a401_0x2e791d(0x9e)),zip_creator_deploy_1=require(a401_0x2e791d(0xe3));class DeployService{constructor(_0x51fea4,_0x9b79cb,_0x2b2120,_0x54a061,_0x5ba0aa,_0xd49944){const _0xc163e3=a401_0x2e791d;this[_0xc163e3(0x73)]=_0x9b79cb,this[_0xc163e3(0x105)]=_0x2b2120,this[_0xc163e3(0xc3)]=_0x54a061,this[_0xc163e3(0x75)]=_0x5ba0aa,this[_0xc163e3(0x79)]=_0xd49944,this[_0xc163e3(0xce)]=_0x51fea4[_0xc163e3(0x7a)],this['_metadataLogId']=_0x51fea4[_0xc163e3(0xcd)],this[_0xc163e3(0x8f)]=_0x51fea4['attachmentLogId'],this[_0xc163e3(0x111)]=_0x51fea4['organisationId'],this[_0xc163e3(0xb7)]=_0x51fea4[_0xc163e3(0x77)],this[_0xc163e3(0xc6)]=_0x51fea4[_0xc163e3(0xa9)],this['_componentIdList']=_0x51fea4[_0xc163e3(0xf7)],this[_0xc163e3(0xa3)]=_0x51fea4[_0xc163e3(0xb0)],this[_0xc163e3(0x86)]=new core_1[(_0xc163e3(0xc9))]('veeva-deploy'),this[_0xc163e3(0xf0)]=new veeva_service_1[(_0xc163e3(0x114))]({'connection':this[_0xc163e3(0x105)],'logger':this[_0xc163e3(0xc3)]}),this[_0xc163e3(0xda)]=new salesforce_service_1[(_0xc163e3(0x102))]({'connection':this[_0xc163e3(0x73)]}),this[_0xc163e3(0xa0)]=new package_import_service_1[(_0xc163e3(0xcc))]({'veevaService':this[_0xc163e3(0xf0)],'connection':this[_0xc163e3(0x105)],'logger':this[_0xc163e3(0xc3)],'saveLog':this[_0xc163e3(0x84)][_0xc163e3(0xf2)](this)}),this['_packageExportService']=new package_export_service_1[(_0xc163e3(0xaf))]({'veevaService':this[_0xc163e3(0xf0)],'connection':this['_connectionVeeva'],'logger':this[_0xc163e3(0xc3)]}),this[_0xc163e3(0xbd)]=new vpk_service_1[(_0xc163e3(0x80))]({'connection':this['_connectionVeeva']});}async['execute'](){const _0x441158=a401_0x2e791d;try{const _0x1bac48=await this['getFlosumComponents']();await this['_logger'][_0x441158(0xb1)]();const _0x2b3f17=await this[_0x441158(0x100)](_0x1bac48);await this[_0x441158(0xb3)](_0x2b3f17);const _0xa2f113=await this[_0x441158(0x83)](_0x1bac48),_0x397410=await this[_0x441158(0x116)](_0xa2f113),_0x29831e=await this[_0x441158(0xd1)](_0x397410);await this[_0x441158(0xc3)][_0x441158(0xb1)]();const _0x5459c0=await this[_0x441158(0xa0)][_0x441158(0xb4)](_0x29831e);await this['_logger'][_0x441158(0xb1)]();const _0x4ccbbe=this[_0x441158(0x74)](_0x1bac48,_0x5459c0[_0x441158(0x9a)]);await this[_0x441158(0xde)](_0x4ccbbe),await this['finishDeploy'](_0x5459c0[_0x441158(0xc4)],![],_0x5459c0[_0x441158(0x10f)]);}catch(_0x36ad6b){await this['finishDeployWithError'](_0x36ad6b)[_0x441158(0xc0)](_0x40fea5=>this['_systemLogger'][_0x441158(0x7c)](_0x40fea5));}}async[a401_0x2e791d(0xfb)](){const _0x116c0f=a401_0x2e791d,_0xeb9ce3=new Set(this[_0x116c0f(0x107)]);this[_0x116c0f(0xc3)][_0x116c0f(0xe5)](_0x116c0f(0x101));const _0x3aec1a=await new branch_component_history_flosum_component_retriever_1[(_0x116c0f(0xcf))]({'value':this['_branchId'],'salesforceService':this['_salesforceService']})['retrieve'](),_0x54e9f0=_0x3aec1a[_0x116c0f(0xef)](_0x4ff0d2=>_0xeb9ce3[_0x116c0f(0x10e)](_0x4ff0d2['id']));if(_0x54e9f0[_0x116c0f(0xfd)]!==this[_0x116c0f(0x107)][_0x116c0f(0xfd)])throw new Error(_0x116c0f(0xdb));return _0x54e9f0;}async[a401_0x2e791d(0x100)](_0x30c0dc){const _0x5bb6ef=a401_0x2e791d;var _0x51955e;this['_logger'][_0x5bb6ef(0xe5)]('Create\x20Backup');const _0x1ba302=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x30c0dc,'veevaService':this['_veevaService'],'logger':this[_0x5bb6ef(0xc3)]})[_0x5bb6ef(0xb8)](),_0x616c98=await this[_0x5bb6ef(0xa2)][_0x5bb6ef(0xb6)](_0x1ba302,'Backup');if(_0x616c98[_0x5bb6ef(0xfd)]>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x51955e=_0x616c98[0x0])!==null&&_0x51955e!==void 0x0?_0x51955e:_0x616c98[0x0]=new jszip_1[(_0x5bb6ef(0xe7))](),_0x616c98[0x0][_0x5bb6ef(0xbc)]({'type':_0x5bb6ef(0xee)});}async[a401_0x2e791d(0xb3)](_0x51e82a){const _0x53dd3c=a401_0x2e791d;this['_logger']['log'](_0x53dd3c(0xff));const _0x5b3930={'Body':_0x51e82a,'ContentType':'application/zip','ParentId':this[_0x53dd3c(0xf1)],'Name':flosum_constants_1[_0x53dd3c(0x10a)]['BACKUP_ZIP_NAME']};await this[_0x53dd3c(0x73)][_0x53dd3c(0xd5)](flosum_constants_1[_0x53dd3c(0x10a)][_0x53dd3c(0xf4)]+'/Attachment',_0x5b3930);}async['retrieveAttachments'](_0x1ac734){const _0x458680=a401_0x2e791d;this[_0x458680(0xc3)]['log'](_0x458680(0xd3));const _0x30e005=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this['_connectionSalesforce'],_0x1ac734[_0x458680(0xd2)](_0x374281=>_0x374281[_0x458680(0x7b)])),_0x231798=await(0x0,fetch_attachments_1[_0x458680(0x83)])(_0x30e005,this[_0x458680(0x73)]);if(_0x231798[_0x458680(0xfd)]!==this[_0x458680(0x107)][_0x458680(0xfd)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x231798['map'](_0xbd6d0e=>_0xbd6d0e[_0x458680(0xea)][_0x458680(0xd6)]);}async[a401_0x2e791d(0x116)](_0x300ce2){const _0x12d241=a401_0x2e791d;this[_0x12d241(0xc3)][_0x12d241(0xe5)](_0x12d241(0xcb));const _0x554510=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x300ce2,'deploymentName':this[_0x12d241(0xa3)]})[_0x12d241(0x10c)](),_0x34d1e0=this['_tempFolder']+'/'+(0x0,shortid_1[_0x12d241(0xe7)])()+_0x12d241(0x106);return await(0x0,promises_1[_0x12d241(0xf9)])(_0x34d1e0,_0x554510),_0x34d1e0;}async[a401_0x2e791d(0xd1)](_0x530a32){const _0x17a8e5=a401_0x2e791d;this[_0x17a8e5(0xc3)][_0x17a8e5(0xe5)](_0x17a8e5(0x7e));const _0xc046b6=await this['_vpkService'][_0x17a8e5(0xf3)](_0x530a32),_0x2d942d=this[_0x17a8e5(0x75)]+_0x17a8e5(0xaa)+_0x530a32[_0x17a8e5(0xa1)](_0x530a32[_0x17a8e5(0xeb)]('/')+0x1);return await(0x0,promises_1[_0x17a8e5(0xf9)])(_0x2d942d,_0xc046b6),await this[_0x17a8e5(0xbd)][_0x17a8e5(0xec)](_0x2d942d),_0x2d942d;}async[a401_0x2e791d(0x84)](_0xad53f5,_0x55d41b){const _0x7403f6=a401_0x2e791d;this[_0x7403f6(0xc3)][_0x7403f6(0xe5)](_0x7403f6(0x112));const _0x5587a4={'Body':Buffer[_0x7403f6(0x117)](_0xad53f5)[_0x7403f6(0xe2)]('base64'),'ContentType':_0x7403f6(0xd7),'ParentId':this[_0x7403f6(0xf1)],'Name':_0x55d41b};await this[_0x7403f6(0x73)][_0x7403f6(0xd5)](flosum_constants_1[_0x7403f6(0x10a)]['ENDPOINT_UPSERT_RECORD']+_0x7403f6(0x8d),_0x5587a4);}[a401_0x2e791d(0x74)](_0x453da2,_0x979822){const _0x5066c7=a401_0x2e791d;this['_logger'][_0x5066c7(0xe5)](_0x5066c7(0x10d));const _0x41cc4b=_0x453da2[_0x5066c7(0x87)]((_0x537386,_0x5c3f07)=>_0x537386[_0x5066c7(0x89)]((_0x5c3f07[_0x5066c7(0x110)]+'.'+_0x5c3f07[_0x5066c7(0xc8)])[_0x5066c7(0xbf)](),_0x5c3f07),new Map());return _0x979822[_0x5066c7(0xd2)](_0x368e8e=>{const _0x5adf8f=_0x5066c7;this[_0x5adf8f(0xc3)]['log'](_0x368e8e[_0x5adf8f(0x8c)]+'.'+_0x368e8e[_0x5adf8f(0x93)]+_0x5adf8f(0xf6)+_0x368e8e[_0x5adf8f(0x115)]);const _0x5c2fd9=(_0x368e8e[_0x5adf8f(0x8c)]+'.'+_0x368e8e[_0x5adf8f(0x93)])['toLowerCase'](),_0x210d0d=_0x41cc4b[_0x5adf8f(0xdc)](_0x5c2fd9);return{[constants_1[_0x5adf8f(0xc1)]+_0x5adf8f(0x92)]:_0x5adf8f(0x81),[constants_1[_0x5adf8f(0xc1)]+_0x5adf8f(0xc2)]:_0x368e8e[_0x5adf8f(0x115)]===status_enums_1[_0x5adf8f(0xa5)]['DEPLOYED']?_0x5adf8f(0xbb):_0x5adf8f(0x7d),[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x368e8e[_0x5adf8f(0x98)],[constants_1[_0x5adf8f(0xc1)]+'Component_Name__c']:_0x368e8e['name'],[constants_1[_0x5adf8f(0xc1)]+_0x5adf8f(0xe8)]:_0x368e8e['type'],[constants_1[_0x5adf8f(0xc1)]+_0x5adf8f(0xab)]:_0x368e8e[_0x5adf8f(0x113)],[constants_1[_0x5adf8f(0xc1)]+_0x5adf8f(0xfc)]:this['_organisationId'],[constants_1[_0x5adf8f(0xc1)]+_0x5adf8f(0x94)]:this[_0x5adf8f(0xf1)],[constants_1[_0x5adf8f(0xc1)]+_0x5adf8f(0xd8)]:_0x210d0d['componentHistoryId']};});}async[a401_0x2e791d(0xde)](_0x52cd00){const _0x2e3146=a401_0x2e791d;this[_0x2e3146(0xc3)][_0x2e3146(0xe5)](_0x2e3146(0xd0));const _0x3edc90=await this[_0x2e3146(0xda)][_0x2e3146(0x96)](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x52cd00),_0x17073b=_0x3edc90[_0x2e3146(0xef)](_0x561274=>!_0x561274[_0x2e3146(0xf5)])[_0x2e3146(0xd2)](_0x3e6db4=>_0x3e6db4['errors'])['flat']();if(_0x17073b['length'])throw new salesforce_dml_error_1[(_0x2e3146(0xdf))](_0x17073b);}async[a401_0x2e791d(0xfa)](_0x28681d){const _0x19bffc=a401_0x2e791d;this[_0x19bffc(0xc3)][_0x19bffc(0x104)](_0x28681d),await this['_logger'][_0x19bffc(0xb1)](),await this[_0x19bffc(0x97)](![],!![],'');}async[a401_0x2e791d(0x97)](_0x5b718c,_0x3d73c1,_0x42002e){const _0x128bed=a401_0x2e791d,_0x672679=_0x128bed(0x82)+this['_instanceUrl']+'/'+this[_0x128bed(0xf1)]+_0x128bed(0xe6)+_0x128bed(0x9d)+'\x20</a>',_0x12c484='<a\x20href='+this['_instanceUrl']+'/'+this['_organisationId']+'\x20>'+this[_0x128bed(0xc6)]+_0x128bed(0xad),_0x153b3b=_0x672679+_0x128bed(0x108)+_0x12c484+_0x128bed(0x8b),_0xdbb3af={[constants_1['FLOSUM_NAMESPACE']+_0x128bed(0x109)]:_0x153b3b,[constants_1[_0x128bed(0xc1)]+_0x128bed(0xae)]:new Date(),[constants_1[_0x128bed(0xc1)]+_0x128bed(0x88)]:this[_0x128bed(0xce)],[constants_1[_0x128bed(0xc1)]+_0x128bed(0x8a)]:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x128bed(0xac)]:_0x128bed(0xc7),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:this['_organisationId']},_0x19c2c4={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x5b718c,[constants_1[_0x128bed(0xc1)]+_0x128bed(0xe0)]:_0x5b718c,[constants_1[_0x128bed(0xc1)]+'Status__c']:_0x3d73c1?status_enums_1[_0x128bed(0x78)][_0x128bed(0x85)]:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x128bed(0xc1)]+_0x128bed(0xc5)]:!![],[constants_1[_0x128bed(0xc1)]+_0x128bed(0xed)]:_0x42002e};await this[_0x128bed(0x73)][_0x128bed(0xb2)](flosum_constants_1['FlosumConstants'][_0x128bed(0xf4)]+'/'+constants_1[_0x128bed(0xc1)]+'Metadata_Log__c/'+this[_0x128bed(0xf1)],_0x19c2c4),await this[_0x128bed(0x73)]['post'](flosum_constants_1[_0x128bed(0x10a)][_0x128bed(0xf4)]+'/'+constants_1[_0x128bed(0xc1)]+_0x128bed(0xd4),_0xdbb3af),this['_logger'][_0x128bed(0xe5)]('Deploy\x20completed\x20'+(_0x5b718c?_0x128bed(0xe9):_0x128bed(0x9b))+'.'),await this['_logger'][_0x128bed(0xb1)]();}}exports['DeployService']=DeployService;