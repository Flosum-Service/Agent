const a357_0x293026=a357_0x5dbf;(function(_0x29b22c,_0x5ea157){const _0x3d7ee1=a357_0x5dbf,_0x3b9081=_0x29b22c();while(!![]){try{const _0x155790=parseInt(_0x3d7ee1(0xff))/0x1+-parseInt(_0x3d7ee1(0xf4))/0x2+parseInt(_0x3d7ee1(0xd1))/0x3*(parseInt(_0x3d7ee1(0xe6))/0x4)+parseInt(_0x3d7ee1(0x112))/0x5*(parseInt(_0x3d7ee1(0xea))/0x6)+parseInt(_0x3d7ee1(0x109))/0x7+-parseInt(_0x3d7ee1(0xbe))/0x8*(parseInt(_0x3d7ee1(0x113))/0x9)+-parseInt(_0x3d7ee1(0xf7))/0xa;if(_0x155790===_0x5ea157)break;else _0x3b9081['push'](_0x3b9081['shift']());}catch(_0x2be8c1){_0x3b9081['push'](_0x3b9081['shift']());}}}(a357_0x241b,0x56e46));const a357_0x38b8a9=(function(){let _0x36ed98=!![];return function(_0x50c8ce,_0x5ea09d){const _0x4d4e94=_0x36ed98?function(){const _0x446163=a357_0x5dbf;if(_0x5ea09d){const _0x12f1fe=_0x5ea09d[_0x446163(0xe0)](_0x50c8ce,arguments);return _0x5ea09d=null,_0x12f1fe;}}:function(){};return _0x36ed98=![],_0x4d4e94;};}()),a357_0x249bea=a357_0x38b8a9(this,function(){const _0x41445d=a357_0x5dbf;return a357_0x249bea[_0x41445d(0x119)]()[_0x41445d(0x12e)](_0x41445d(0x140))[_0x41445d(0x119)]()[_0x41445d(0x11d)](a357_0x249bea)[_0x41445d(0x12e)](_0x41445d(0x140));});a357_0x249bea();'use strict';var __importDefault=this&&this[a357_0x293026(0x143)]||function(_0x5dc2b1){return _0x5dc2b1&&_0x5dc2b1['__esModule']?_0x5dc2b1:{'default':_0x5dc2b1};};function a357_0x5dbf(_0x2ef70e,_0x41f536){const _0x1f7409=a357_0x241b();return a357_0x5dbf=function(_0x249bea,_0x38b8a9){_0x249bea=_0x249bea-0xb7;let _0x241b7b=_0x1f7409[_0x249bea];return _0x241b7b;},a357_0x5dbf(_0x2ef70e,_0x41f536);}Object['defineProperty'](exports,a357_0x293026(0xbc),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a357_0x293026(0x102))),promises_1=require(a357_0x293026(0xbd)),constants_1=require(a357_0x293026(0xeb)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a357_0x293026(0x128)),salesforce_service_1=require(a357_0x293026(0xc3)),core_1=require(a357_0x293026(0x156)),status_enums_1=require(a357_0x293026(0xe4)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require(a357_0x293026(0x11b)),package_import_service_1=require(a357_0x293026(0x12b)),branch_component_history_flosum_component_retriever_1=require(a357_0x293026(0x15a)),flosum_component_veeva_component_retriever_1=require(a357_0x293026(0x127)),package_export_service_1=require(a357_0x293026(0x10b)),vpk_service_1=require(a357_0x293026(0x149)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x4972af,_0x11084d,_0x80c7a6,_0x2196bb,_0xadf22d,_0x3a87fe){const _0x4d681d=a357_0x293026;this[_0x4d681d(0x110)]=_0x11084d,this[_0x4d681d(0xb7)]=_0x80c7a6,this[_0x4d681d(0x100)]=_0x2196bb,this['_tempFolder']=_0xadf22d,this[_0x4d681d(0xdc)]=_0x3a87fe,this['_branchId']=_0x4972af[_0x4d681d(0xec)],this['_metadataLogId']=_0x4972af['metadataLogId'],this[_0x4d681d(0x125)]=_0x4972af[_0x4d681d(0xf2)],this[_0x4d681d(0xfa)]=_0x4972af[_0x4d681d(0xd0)],this[_0x4d681d(0x14e)]=_0x4972af[_0x4d681d(0xe1)],this['_organisationName']=_0x4972af[_0x4d681d(0x151)],this[_0x4d681d(0xf8)]=_0x4972af['componentIdList'],this[_0x4d681d(0xc7)]=_0x4972af[_0x4d681d(0xf9)],this[_0x4d681d(0x138)]=new core_1['Logger'](_0x4d681d(0xd9)),this['_veevaService']=new veeva_service_1['VeevaService']({'connection':this[_0x4d681d(0xb7)],'logger':this[_0x4d681d(0x100)]}),this[_0x4d681d(0x154)]=new salesforce_service_1[(_0x4d681d(0x14a))]({'connection':this[_0x4d681d(0x110)]}),this[_0x4d681d(0x10a)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x4d681d(0x144)],'connection':this[_0x4d681d(0xb7)],'logger':this[_0x4d681d(0x100)],'saveLog':this[_0x4d681d(0xd4)]['bind'](this)}),this[_0x4d681d(0xc9)]=new package_export_service_1[(_0x4d681d(0xc1))]({'veevaService':this['_veevaService'],'connection':this[_0x4d681d(0xb7)],'logger':this['_logger']}),this[_0x4d681d(0xe9)]=new vpk_service_1[(_0x4d681d(0xb9))]({'connection':this[_0x4d681d(0xb7)]});}async['execute'](){const _0x48ffaf=a357_0x293026;try{const _0x32055b=await this[_0x48ffaf(0x111)]();await this['_logger'][_0x48ffaf(0x13c)]();const _0x3f2e3a=await this[_0x48ffaf(0xe3)](_0x32055b);await this['saveBackup'](_0x3f2e3a);const _0x1b3151=await this['retrieveAttachments'](_0x32055b),_0x120976=await this['createZip'](_0x1b3151),_0x472205=await this[_0x48ffaf(0x117)](_0x120976);await this['_logger'][_0x48ffaf(0x13c)]();const _0x42f778=await this[_0x48ffaf(0x10a)][_0x48ffaf(0xf6)](_0x472205);await this[_0x48ffaf(0x100)][_0x48ffaf(0x13c)]();const _0x4158ec=this[_0x48ffaf(0x108)](_0x32055b,_0x42f778[_0x48ffaf(0xfb)]);await this['saveDeploymentResults'](_0x4158ec),await this['finishDeploy'](_0x42f778[_0x48ffaf(0x122)],![],_0x42f778[_0x48ffaf(0x130)]);}catch(_0x15cbc0){await this[_0x48ffaf(0x11f)](_0x15cbc0)[_0x48ffaf(0xf5)](_0x3e9175=>this[_0x48ffaf(0x138)]['error'](_0x3e9175));}}async[a357_0x293026(0x111)](){const _0x1afddc=a357_0x293026,_0x438b2c=new Set(this[_0x1afddc(0xf8)]);this[_0x1afddc(0x100)][_0x1afddc(0xd3)]('Retrieving\x20components');const _0x58e813=await new branch_component_history_flosum_component_retriever_1[(_0x1afddc(0x153))]({'value':this[_0x1afddc(0xdb)],'salesforceService':this[_0x1afddc(0x154)]})[_0x1afddc(0x11e)](),_0x1e4e73=_0x58e813['filter'](_0x118d4b=>_0x438b2c[_0x1afddc(0x145)](_0x118d4b['id']));if(_0x1e4e73['length']!==this[_0x1afddc(0xf8)]['length'])throw new Error(_0x1afddc(0xbb));return _0x1e4e73;}async['createBackup'](_0x37726a){const _0x840da1=a357_0x293026;var _0x44fe58;this[_0x840da1(0x100)][_0x840da1(0xd3)](_0x840da1(0x148));const _0x5819d8=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x37726a,'veevaService':this['_veevaService'],'logger':this[_0x840da1(0x100)]})[_0x840da1(0x11e)](),_0x2cfd3b=await this[_0x840da1(0xc9)][_0x840da1(0xc5)](_0x5819d8,'Backup');if(_0x2cfd3b['length']>0x1)throw new Error(_0x840da1(0x136));return(_0x44fe58=_0x2cfd3b[0x0])!==null&&_0x44fe58!==void 0x0?_0x44fe58:_0x2cfd3b[0x0]=new jszip_1[(_0x840da1(0x116))](),_0x2cfd3b[0x0][_0x840da1(0x118)]({'type':'base64'});}async[a357_0x293026(0xfd)](_0x584dfd){const _0x31695d=a357_0x293026;this[_0x31695d(0x100)]['log']('Save\x20Backup\x20to\x20Salesforce');const _0x34d6fa={'Body':_0x584dfd,'ContentType':_0x31695d(0x104),'ParentId':this[_0x31695d(0xb8)],'Name':flosum_constants_1[_0x31695d(0xda)][_0x31695d(0x11c)]};await this[_0x31695d(0x110)][_0x31695d(0x12f)](flosum_constants_1[_0x31695d(0xda)]['ENDPOINT_UPSERT_RECORD']+_0x31695d(0xce),_0x34d6fa);}async[a357_0x293026(0x101)](_0x2b1e25){const _0x2c17c4=a357_0x293026;this[_0x2c17c4(0x100)]['log']('Retrieving\x20attachments');const _0x241837=await(0x0,fetch_attachments_1[_0x2c17c4(0xcf)])(this['_connectionSalesforce'],_0x2b1e25['map'](_0xb737de=>_0xb737de[_0x2c17c4(0x139)])),_0x20edce=await(0x0,fetch_attachments_1[_0x2c17c4(0x101)])(_0x241837,this[_0x2c17c4(0x110)]);if(_0x20edce[_0x2c17c4(0xd5)]!==this[_0x2c17c4(0xf8)]['length'])throw new Error(_0x2c17c4(0x12d));return _0x20edce[_0x2c17c4(0xdd)](_0x166eeb=>_0x166eeb[_0x2c17c4(0xd2)][_0x2c17c4(0x159)]);}async['createZip'](_0x42a2fb){const _0x543c9c=a357_0x293026;this['_logger'][_0x543c9c(0xd3)](_0x543c9c(0xdf));const _0x22805d=await new zip_creator_deploy_1[(_0x543c9c(0xcd))]({'attachmentBodies':_0x42a2fb,'deploymentName':this[_0x543c9c(0xc7)]})[_0x543c9c(0x158)](),_0x3d2ff1=this[_0x543c9c(0x131)]+'/'+(0x0,shortid_1['default'])()+'.zip';return await(0x0,promises_1['writeFile'])(_0x3d2ff1,_0x22805d),_0x3d2ff1;}async[a357_0x293026(0x117)](_0x4f2651){const _0x2c4114=a357_0x293026;this[_0x2c4114(0x100)][_0x2c4114(0xd3)]('Create\x20vpk\x20package');const _0x3e9538=await this[_0x2c4114(0xe9)][_0x2c4114(0xc2)](_0x4f2651),_0x3751ec=this[_0x2c4114(0x131)]+_0x2c4114(0xd7)+_0x4f2651[_0x2c4114(0x10d)](_0x4f2651['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x2c4114(0x103)])(_0x3751ec,_0x3e9538),await this[_0x2c4114(0xe9)][_0x2c4114(0x11a)](_0x3751ec),_0x3751ec;}async[a357_0x293026(0xd4)](_0x5a78ad,_0x37218b){const _0x29987f=a357_0x293026;this[_0x29987f(0x100)][_0x29987f(0xd3)](_0x29987f(0x152));const _0xa29a59={'Body':Buffer[_0x29987f(0x141)](_0x5a78ad)[_0x29987f(0x119)](_0x29987f(0xef)),'ContentType':_0x29987f(0x133),'ParentId':this[_0x29987f(0xb8)],'Name':_0x37218b};await this[_0x29987f(0x110)][_0x29987f(0x12f)](flosum_constants_1[_0x29987f(0xda)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0xa29a59);}[a357_0x293026(0x108)](_0x1fe394,_0x3c2208){const _0x23a915=a357_0x293026;this[_0x23a915(0x100)][_0x23a915(0xd3)](_0x23a915(0xc8));const _0xc01dab=_0x1fe394[_0x23a915(0xbf)]((_0x53f5e6,_0x4c8573)=>_0x53f5e6[_0x23a915(0x115)]((_0x4c8573[_0x23a915(0x123)]+'.'+_0x4c8573[_0x23a915(0x13b)])[_0x23a915(0x137)](),_0x4c8573),new Map());return _0x3c2208['map'](_0x2ce348=>{const _0x2e04f2=_0x23a915;this['_logger']['log'](_0x2ce348['type']+'.'+_0x2ce348[_0x2e04f2(0xd6)]+_0x2e04f2(0x13d)+_0x2ce348[_0x2e04f2(0x107)]);const _0x1334b7=(_0x2ce348[_0x2e04f2(0x129)]+'.'+_0x2ce348['name'])[_0x2e04f2(0x137)](),_0x4bcecd=_0xc01dab[_0x2e04f2(0x157)](_0x1334b7);return{[constants_1[_0x2e04f2(0xf1)]+'Type__c']:_0x2e04f2(0xe2),[constants_1[_0x2e04f2(0xf1)]+'Status__c']:_0x2ce348['status']===status_enums_1[_0x2e04f2(0xf0)][_0x2e04f2(0xed)]?'Success':_0x2e04f2(0x105),[constants_1[_0x2e04f2(0xf1)]+_0x2e04f2(0xc4)]:_0x2ce348[_0x2e04f2(0xcc)],[constants_1[_0x2e04f2(0xf1)]+'Component_Name__c']:_0x2ce348[_0x2e04f2(0xd6)],[constants_1['FLOSUM_NAMESPACE']+_0x2e04f2(0xe7)]:_0x2ce348[_0x2e04f2(0x129)],[constants_1[_0x2e04f2(0xf1)]+'Veeva_Step_Name__c']:_0x2ce348[_0x2e04f2(0x147)],[constants_1[_0x2e04f2(0xf1)]+_0x2e04f2(0x10f)]:this[_0x2e04f2(0xfa)],[constants_1['FLOSUM_NAMESPACE']+_0x2e04f2(0x114)]:this['_metadataLogId'],[constants_1[_0x2e04f2(0xf1)]+'Component_History__c']:_0x4bcecd[_0x2e04f2(0x139)]};});}async[a357_0x293026(0x135)](_0x3e4fbe){const _0x5f52d1=a357_0x293026;this['_logger']['log'](_0x5f52d1(0x142));const _0x51625e=await this['_salesforceService'][_0x5f52d1(0xfe)](constants_1['FLOSUM_NAMESPACE']+_0x5f52d1(0x14f),_0x3e4fbe),_0x2248fc=_0x51625e[_0x5f52d1(0x14d)](_0x345150=>!_0x345150[_0x5f52d1(0x13f)])[_0x5f52d1(0xdd)](_0x218e6a=>_0x218e6a['errors'])[_0x5f52d1(0xe8)]();if(_0x2248fc[_0x5f52d1(0xd5)])throw new salesforce_dml_error_1[(_0x5f52d1(0x13e))](_0x2248fc);}async[a357_0x293026(0x11f)](_0x93d6e6){const _0x1f84f5=a357_0x293026;this['_logger'][_0x1f84f5(0x12a)](_0x93d6e6),await this[_0x1f84f5(0x100)]['updateLog'](),await this['finishDeploy'](![],!![],'');}async[a357_0x293026(0x106)](_0x393726,_0x2a8a88,_0x16dd32){const _0x6de177=a357_0x293026,_0x448855=_0x6de177(0x10e)+this[_0x6de177(0xdc)]+'/'+this['_metadataLogId']+_0x6de177(0xc6)+_0x6de177(0x10c)+_0x6de177(0xca),_0x490f15=_0x6de177(0x10e)+this[_0x6de177(0xdc)]+'/'+this[_0x6de177(0xfa)]+'\x20>'+this['_organisationName']+_0x6de177(0xfc),_0x2a595a=_0x448855+_0x6de177(0xf3)+_0x490f15+_0x6de177(0xc0),_0x27f9a2={[constants_1[_0x6de177(0xf1)]+_0x6de177(0xde)]:_0x2a595a,[constants_1[_0x6de177(0xf1)]+_0x6de177(0xee)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x6de177(0x126)]:this['_branchId'],[constants_1[_0x6de177(0xf1)]+_0x6de177(0xd8)]:_0x6de177(0x14b),[constants_1[_0x6de177(0xf1)]+_0x6de177(0xba)]:_0x6de177(0x134),[constants_1['FLOSUM_NAMESPACE']+_0x6de177(0xcb)]:this[_0x6de177(0xfa)]},_0x3a31d3={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x393726,[constants_1[_0x6de177(0xf1)]+_0x6de177(0x120)]:_0x393726,[constants_1['FLOSUM_NAMESPACE']+_0x6de177(0x132)]:_0x2a8a88?status_enums_1[_0x6de177(0x13a)][_0x6de177(0xe5)]:status_enums_1[_0x6de177(0x13a)][_0x6de177(0x146)],[constants_1['FLOSUM_NAMESPACE']+_0x6de177(0x121)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x6de177(0x12c)]:_0x16dd32};await this[_0x6de177(0x110)][_0x6de177(0x150)](flosum_constants_1[_0x6de177(0xda)][_0x6de177(0x155)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x6de177(0x124)+this[_0x6de177(0xb8)],_0x3a31d3),await this[_0x6de177(0x110)]['post'](flosum_constants_1[_0x6de177(0xda)][_0x6de177(0x155)]+'/'+constants_1[_0x6de177(0xf1)]+'Log__c',_0x27f9a2),this['_logger'][_0x6de177(0xd3)](_0x6de177(0x14c)+(_0x393726?_0x6de177(0x15b):'with\x20error')+'.'),await this[_0x6de177(0x100)]['updateLog']();}}exports['DeployService']=DeployService;function a357_0x241b(){const _0x2bb959=['organisationId','9xBXBDO','values','log','saveLog','length','name','/vpk__','Activity_Item__c','veeva-deploy','FlosumConstants','_branchId','_instanceUrl','map','Action__c','Join\x20all\x20mdl\x20into\x20one\x20zip','apply','timeZone','Deployment\x20Result','createBackup','../enums/status.enums','EXCEPTION','362940ccmzfv','Component_Type__c','flat','_vpkService','2423484aKyykH','../../../constants','branchId','DEPLOYED','Date__c','base64','PackageComponentStatus','FLOSUM_NAMESPACE','attachmentLogId','\x20of\x20branch\x20to\x20Organization\x20','449220OISghv','catch','import','7004480nzKFRl','_componentIdList','deploymentName','_organisationId','packageComponentList','</a>','saveBackup','insertMultipleRecords','340013pZJeCX','_logger','retrieveAttachments','jszip','writeFile','application/zip','Failure','finishDeploy','status','formFlosumDeploymentResults','4544351EvDxjD','_packageImportService','./package-export.service','Veeva\x20Deployment','slice','<a\x20href=','Org__c','_connectionSalesforce','getFlosumComponents','5tDNbVk','27LNUuOT','Metadata_Log__c','set','default','createVpk','generateAsync','toString','validate','../../shared/utils/fetch-attachments','BACKUP_ZIP_NAME','constructor','retrieve','finishDeployWithError','Succeed__c','Job_Completed__c','isDeployed','componentType','Metadata_Log__c/','_attachmentLogId','Branch__c','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','./veeva.service','type','logError','./package-import.service','Async_Request_Id__c','Cannot\x20retrievers\x20all\x20attachments','search','post','packageId','_tempFolder','Status__c','text/plain','Deployment','saveDeploymentResults','Cannot\x20Backup\x20more\x20than\x20200\x20components.','toLowerCase','_systemLogger','componentHistoryId','MetadataLogStatus','componentName','updateLog','\x20:\x20','SalesforceDmlError','success','(((.+)+)+)+$','from','Save\x20Deployment\x20Results','__importDefault','_veevaService','has','COMPLETED','stepName','Create\x20Backup','./vpk.service','SalesforceService','Branch','Deploy\x20completed\x20','filter','_timeZone','Deployment_Result__c','patch','organisationName','Save\x20log','BranchComponentHistoryFlosumComponentRetriever','_salesforceService','ENDPOINT_UPSERT_RECORD','../../../core','get','execute','Body','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','successfully','_connectionVeeva','_metadataLogId','VpkService','Activity_Type__c','Cannot\x20retrieve\x20all\x20components.','__esModule','fs/promises','1024952HYYAvU','reduce','\x20has\x20been\x20created.','PackageExportService','generate','./salesforce.service','Result__c','export','\x20>\x20','_deploymentName','Form\x20Deployment\x20Results','_packageExportService','\x20</a>','TargetId__c','deploymentAction','ZipCreatorDeploy','/Attachment','fetchAttachmentsDetailsByParentId'];a357_0x241b=function(){return _0x2bb959;};return a357_0x241b();}