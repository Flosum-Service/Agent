const a401_0x560fcc=a401_0x1cb4;function a401_0x1cb4(_0x396af5,_0x2636ea){const _0x10355d=a401_0x4f26();return a401_0x1cb4=function(_0x39aae3,_0x3d1aa5){_0x39aae3=_0x39aae3-0x1cb;let _0x4f2646=_0x10355d[_0x39aae3];return _0x4f2646;},a401_0x1cb4(_0x396af5,_0x2636ea);}(function(_0x27f97c,_0x5e7831){const _0x159a26=a401_0x1cb4,_0x55321c=_0x27f97c();while(!![]){try{const _0x3b0d4a=parseInt(_0x159a26(0x20a))/0x1+parseInt(_0x159a26(0x220))/0x2*(-parseInt(_0x159a26(0x1de))/0x3)+-parseInt(_0x159a26(0x232))/0x4*(parseInt(_0x159a26(0x1dc))/0x5)+-parseInt(_0x159a26(0x1e5))/0x6*(-parseInt(_0x159a26(0x235))/0x7)+parseInt(_0x159a26(0x230))/0x8+-parseInt(_0x159a26(0x1ef))/0x9+parseInt(_0x159a26(0x26e))/0xa;if(_0x3b0d4a===_0x5e7831)break;else _0x55321c['push'](_0x55321c['shift']());}catch(_0x29daed){_0x55321c['push'](_0x55321c['shift']());}}}(a401_0x4f26,0xa063a));function a401_0x4f26(){const _0x2cee15=['_componentIdList','.zip','DeployService','flat','/vpk__','20396390kRAAGq','shortid','_branchId','createVpk','../classes/deploy/zip-creator.deploy','_vpkService','ZipCreatorDeploy','saveLog','_organisationId','MetadataLogStatus','reduce','log','getFlosumComponents','Is_Error__c','PackageImportService','import','_tempFolder','_salesforceService','21820lQlFnf','_logger','3XugIWb','_attachmentLogId','branchId','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Save\x20log','status','Deploy\x20completed\x20','114woyBHS','metadataLogId','Type__c','PackageComponentStatus','_metadataLogId','__importDefault','length','jszip','toString','text/plain','6125427JEhYdy','</a>','Success','Cannot\x20Backup\x20more\x20than\x20200\x20components.','<a\x20href=','_connectionVeeva','errors','name','componentName','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Action__c','\x20has\x20been\x20created.','VpkService','FlosumConstants','catch','BranchComponentHistoryFlosumComponentRetriever','./veeva.service','lastIndexOf','Retrieving\x20components','has','Component_Name__c','success','execute','post','Activity_Type__c','Date__c','packageComponentList','165611kitXyV','DEPLOYED','organisationName','Form\x20Deployment\x20Results','retrieveAttachments','./package-import.service','saveBackup','BACKUP_ZIP_NAME','EXCEPTION','_instanceUrl','componentHistoryId','PackageExportService','../enums/status.enums','Failure','Metadata_Log__c/','timeZone','./salesforce.service','Activity_Item__c','toLowerCase','patch','Logger','FLOSUM_NAMESPACE','2604796JVGRBs','packageId','formFlosumDeploymentResults','ENDPOINT_UPSERT_RECORD','finishDeploy','__esModule','fetchAttachmentsDetailsByParentId','Veeva_Step_Name__c','Body','Metadata_Log__c','Create\x20vpk\x20package','search','apply','bind','\x20>\x20','generateAsync','971936JHVncE','saveDeploymentResults','24ipjuzG','deploymentAction','VeevaService','125041SttWlv','constructor','_packageImportService','Branch','../../../constants','Cannot\x20retrievers\x20all\x20attachments','type','attachmentLogId','deploymentName','base64','Org__c','_veevaService','Save\x20Deployment\x20Results','Create\x20Backup','_packageExportService','\x20:\x20','_deploymentName','filter','logError','../../../core','./vpk.service','slice','Job_Completed__c','Deployment','writeFile','updateLog','export','\x20of\x20branch\x20to\x20Organization\x20','COMPLETED','map','_systemLogger','isDeployed','Save\x20Backup\x20to\x20Salesforce','Deployment_Result__c','organisationId','/Attachment','\x20</a>','retrieve','default','createZip','veeva-deploy','generate','Retrieving\x20attachments','Component_Type__c','(((.+)+)+)+$','Component_History__c','./package-export.service','_connectionSalesforce','createBackup','External_Deployment_Id__c','_organisationName','Branch__c'];a401_0x4f26=function(){return _0x2cee15;};return a401_0x4f26();}const a401_0x3d1aa5=(function(){let _0x384fc3=!![];return function(_0x843be0,_0x5ec674){const _0x308a5b=_0x384fc3?function(){const _0x4ccc7e=a401_0x1cb4;if(_0x5ec674){const _0x29436a=_0x5ec674[_0x4ccc7e(0x22c)](_0x843be0,arguments);return _0x5ec674=null,_0x29436a;}}:function(){};return _0x384fc3=![],_0x308a5b;};}()),a401_0x39aae3=a401_0x3d1aa5(this,function(){const _0x4ddd4d=a401_0x1cb4;return a401_0x39aae3[_0x4ddd4d(0x1ed)]()[_0x4ddd4d(0x22b)](_0x4ddd4d(0x261))[_0x4ddd4d(0x1ed)]()[_0x4ddd4d(0x236)](a401_0x39aae3)[_0x4ddd4d(0x22b)](_0x4ddd4d(0x261));});a401_0x39aae3();'use strict';var __importDefault=this&&this[a401_0x560fcc(0x1ea)]||function(_0x420d5a){const _0x502e0f=a401_0x560fcc;return _0x420d5a&&_0x420d5a[_0x502e0f(0x225)]?_0x420d5a:{'default':_0x420d5a};};Object['defineProperty'](exports,a401_0x560fcc(0x225),{'value':!![]}),exports[a401_0x560fcc(0x26b)]=void 0x0;const jszip_1=__importDefault(require(a401_0x560fcc(0x1ec))),promises_1=require('fs/promises'),constants_1=require(a401_0x560fcc(0x239)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a401_0x560fcc(0x1ff)),salesforce_service_1=require(a401_0x560fcc(0x21a)),core_1=require(a401_0x560fcc(0x248)),status_enums_1=require(a401_0x560fcc(0x216)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a401_0x560fcc(0x1cb))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a401_0x560fcc(0x20f)),branch_component_history_flosum_component_retriever_1=require(a401_0x560fcc(0x1f8)),flosum_component_veeva_component_retriever_1=require(a401_0x560fcc(0x1e1)),package_export_service_1=require(a401_0x560fcc(0x263)),vpk_service_1=require(a401_0x560fcc(0x249)),zip_creator_deploy_1=require(a401_0x560fcc(0x1ce));class DeployService{constructor(_0x2547d8,_0x5ec8cd,_0x5bbbf8,_0x568734,_0x45cd28,_0x2ef38f){const _0x41c9e0=a401_0x560fcc;this['_connectionSalesforce']=_0x5ec8cd,this[_0x41c9e0(0x1f4)]=_0x5bbbf8,this[_0x41c9e0(0x1dd)]=_0x568734,this['_tempFolder']=_0x45cd28,this[_0x41c9e0(0x213)]=_0x2ef38f,this[_0x41c9e0(0x1cc)]=_0x2547d8[_0x41c9e0(0x1e0)],this[_0x41c9e0(0x1e9)]=_0x2547d8[_0x41c9e0(0x1e6)],this[_0x41c9e0(0x1df)]=_0x2547d8[_0x41c9e0(0x23c)],this[_0x41c9e0(0x1d2)]=_0x2547d8[_0x41c9e0(0x257)],this['_timeZone']=_0x2547d8[_0x41c9e0(0x219)],this[_0x41c9e0(0x267)]=_0x2547d8[_0x41c9e0(0x20c)],this[_0x41c9e0(0x269)]=_0x2547d8['componentIdList'],this['_deploymentName']=_0x2547d8[_0x41c9e0(0x23d)],this['_systemLogger']=new core_1[(_0x41c9e0(0x21e))](_0x41c9e0(0x25d)),this[_0x41c9e0(0x240)]=new veeva_service_1[(_0x41c9e0(0x234))]({'connection':this[_0x41c9e0(0x1f4)],'logger':this['_logger']}),this[_0x41c9e0(0x1db)]=new salesforce_service_1['SalesforceService']({'connection':this['_connectionSalesforce']}),this[_0x41c9e0(0x237)]=new package_import_service_1[(_0x41c9e0(0x1d8))]({'veevaService':this[_0x41c9e0(0x240)],'connection':this['_connectionVeeva'],'logger':this[_0x41c9e0(0x1dd)],'saveLog':this[_0x41c9e0(0x1d1)][_0x41c9e0(0x22d)](this)}),this['_packageExportService']=new package_export_service_1[(_0x41c9e0(0x215))]({'veevaService':this[_0x41c9e0(0x240)],'connection':this[_0x41c9e0(0x1f4)],'logger':this['_logger']}),this[_0x41c9e0(0x1cf)]=new vpk_service_1[(_0x41c9e0(0x1fb))]({'connection':this[_0x41c9e0(0x1f4)]});}async[a401_0x560fcc(0x205)](){const _0x738612=a401_0x560fcc;try{const _0x442c1c=await this[_0x738612(0x1d6)]();await this[_0x738612(0x1dd)][_0x738612(0x24e)]();const _0x3efc35=await this[_0x738612(0x265)](_0x442c1c);await this['saveBackup'](_0x3efc35);const _0x70bb6a=await this[_0x738612(0x20e)](_0x442c1c),_0x258081=await this['createZip'](_0x70bb6a),_0xaaab7b=await this[_0x738612(0x1cd)](_0x258081);await this['_logger']['updateLog']();const _0xc027ef=await this['_packageImportService'][_0x738612(0x1d9)](_0xaaab7b);await this[_0x738612(0x1dd)][_0x738612(0x24e)]();const _0x247091=this[_0x738612(0x222)](_0x442c1c,_0xc027ef[_0x738612(0x209)]);await this[_0x738612(0x231)](_0x247091),await this['finishDeploy'](_0xc027ef[_0x738612(0x254)],![],_0xc027ef[_0x738612(0x221)]);}catch(_0x2d1378){await this['finishDeployWithError'](_0x2d1378)[_0x738612(0x1fd)](_0x160edb=>this[_0x738612(0x253)]['error'](_0x160edb));}}async[a401_0x560fcc(0x1d6)](){const _0x86d1f3=a401_0x560fcc,_0x2798d6=new Set(this[_0x86d1f3(0x269)]);this[_0x86d1f3(0x1dd)][_0x86d1f3(0x1d5)](_0x86d1f3(0x201));const _0x2fa19f=await new branch_component_history_flosum_component_retriever_1[(_0x86d1f3(0x1fe))]({'value':this[_0x86d1f3(0x1cc)],'salesforceService':this[_0x86d1f3(0x1db)]})['retrieve'](),_0x19b52b=_0x2fa19f[_0x86d1f3(0x246)](_0x39cd7f=>_0x2798d6[_0x86d1f3(0x202)](_0x39cd7f['id']));if(_0x19b52b[_0x86d1f3(0x1eb)]!==this[_0x86d1f3(0x269)][_0x86d1f3(0x1eb)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x19b52b;}async[a401_0x560fcc(0x265)](_0x1964cc){const _0x5e9f10=a401_0x560fcc;var _0x4493b8;this[_0x5e9f10(0x1dd)]['log'](_0x5e9f10(0x242));const _0x3d6c11=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x1964cc,'veevaService':this[_0x5e9f10(0x240)],'logger':this[_0x5e9f10(0x1dd)]})[_0x5e9f10(0x25a)](),_0x1d2721=await this[_0x5e9f10(0x243)][_0x5e9f10(0x24f)](_0x3d6c11,'Backup');if(_0x1d2721['length']>0x1)throw new Error(_0x5e9f10(0x1f2));return(_0x4493b8=_0x1d2721[0x0])!==null&&_0x4493b8!==void 0x0?_0x4493b8:_0x1d2721[0x0]=new jszip_1[(_0x5e9f10(0x25b))](),_0x1d2721[0x0][_0x5e9f10(0x22f)]({'type':_0x5e9f10(0x23e)});}async[a401_0x560fcc(0x210)](_0x3e40d3){const _0x4dce26=a401_0x560fcc;this['_logger']['log'](_0x4dce26(0x255));const _0x4380b0={'Body':_0x3e40d3,'ContentType':'application/zip','ParentId':this[_0x4dce26(0x1e9)],'Name':flosum_constants_1[_0x4dce26(0x1fc)][_0x4dce26(0x211)]};await this['_connectionSalesforce'][_0x4dce26(0x206)](flosum_constants_1[_0x4dce26(0x1fc)][_0x4dce26(0x223)]+_0x4dce26(0x258),_0x4380b0);}async[a401_0x560fcc(0x20e)](_0x1d141c){const _0x43b3c6=a401_0x560fcc;this['_logger'][_0x43b3c6(0x1d5)](_0x43b3c6(0x25f));const _0x970b3a=await(0x0,fetch_attachments_1[_0x43b3c6(0x226)])(this['_connectionSalesforce'],_0x1d141c[_0x43b3c6(0x252)](_0x2af105=>_0x2af105['componentHistoryId'])),_0x496768=await(0x0,fetch_attachments_1[_0x43b3c6(0x20e)])(_0x970b3a,this[_0x43b3c6(0x264)]);if(_0x496768[_0x43b3c6(0x1eb)]!==this[_0x43b3c6(0x269)][_0x43b3c6(0x1eb)])throw new Error(_0x43b3c6(0x23a));return _0x496768[_0x43b3c6(0x252)](_0x425816=>_0x425816['values'][_0x43b3c6(0x228)]);}async[a401_0x560fcc(0x25c)](_0x58107a){const _0x54f82a=a401_0x560fcc;this[_0x54f82a(0x1dd)]['log']('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x3ef4b3=await new zip_creator_deploy_1[(_0x54f82a(0x1d0))]({'attachmentBodies':_0x58107a,'deploymentName':this[_0x54f82a(0x245)]})[_0x54f82a(0x205)](),_0x73857=this[_0x54f82a(0x1da)]+'/'+(0x0,shortid_1['default'])()+_0x54f82a(0x26a);return await(0x0,promises_1[_0x54f82a(0x24d)])(_0x73857,_0x3ef4b3),_0x73857;}async[a401_0x560fcc(0x1cd)](_0x3d06bb){const _0xd36a5c=a401_0x560fcc;this[_0xd36a5c(0x1dd)]['log'](_0xd36a5c(0x22a));const _0x45cfae=await this[_0xd36a5c(0x1cf)][_0xd36a5c(0x25e)](_0x3d06bb),_0x301471=this[_0xd36a5c(0x1da)]+_0xd36a5c(0x26d)+_0x3d06bb[_0xd36a5c(0x24a)](_0x3d06bb[_0xd36a5c(0x200)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x301471,_0x45cfae),await this[_0xd36a5c(0x1cf)]['validate'](_0x301471),_0x301471;}async['saveLog'](_0x2bec82,_0x35d772){const _0x41dc24=a401_0x560fcc;this[_0x41dc24(0x1dd)][_0x41dc24(0x1d5)](_0x41dc24(0x1e2));const _0x36410f={'Body':Buffer['from'](_0x2bec82)[_0x41dc24(0x1ed)](_0x41dc24(0x23e)),'ContentType':_0x41dc24(0x1ee),'ParentId':this[_0x41dc24(0x1e9)],'Name':_0x35d772};await this[_0x41dc24(0x264)][_0x41dc24(0x206)](flosum_constants_1[_0x41dc24(0x1fc)][_0x41dc24(0x223)]+_0x41dc24(0x258),_0x36410f);}[a401_0x560fcc(0x222)](_0x13c92a,_0xd7ffd3){const _0x23b81c=a401_0x560fcc;this[_0x23b81c(0x1dd)][_0x23b81c(0x1d5)](_0x23b81c(0x20d));const _0x3f80ea=_0x13c92a[_0x23b81c(0x1d4)]((_0x2212d2,_0x4149a5)=>_0x2212d2['set']((_0x4149a5['componentType']+'.'+_0x4149a5[_0x23b81c(0x1f7)])[_0x23b81c(0x21c)](),_0x4149a5),new Map());return _0xd7ffd3['map'](_0x3e0006=>{const _0x7e6773=_0x23b81c;this[_0x7e6773(0x1dd)][_0x7e6773(0x1d5)](_0x3e0006['type']+'.'+_0x3e0006['name']+_0x7e6773(0x244)+_0x3e0006[_0x7e6773(0x1e3)]);const _0x221dbf=(_0x3e0006[_0x7e6773(0x23b)]+'.'+_0x3e0006[_0x7e6773(0x1f6)])[_0x7e6773(0x21c)](),_0x921717=_0x3f80ea['get'](_0x221dbf);return{[constants_1[_0x7e6773(0x21f)]+_0x7e6773(0x1e7)]:'Deployment\x20Result',[constants_1[_0x7e6773(0x21f)]+'Status__c']:_0x3e0006[_0x7e6773(0x1e3)]===status_enums_1[_0x7e6773(0x1e8)][_0x7e6773(0x20b)]?_0x7e6773(0x1f1):_0x7e6773(0x217),[constants_1[_0x7e6773(0x21f)]+'Result__c']:_0x3e0006[_0x7e6773(0x233)],[constants_1[_0x7e6773(0x21f)]+_0x7e6773(0x203)]:_0x3e0006[_0x7e6773(0x1f6)],[constants_1[_0x7e6773(0x21f)]+_0x7e6773(0x260)]:_0x3e0006[_0x7e6773(0x23b)],[constants_1[_0x7e6773(0x21f)]+_0x7e6773(0x227)]:_0x3e0006['stepName'],[constants_1[_0x7e6773(0x21f)]+_0x7e6773(0x23f)]:this[_0x7e6773(0x1d2)],[constants_1[_0x7e6773(0x21f)]+_0x7e6773(0x229)]:this[_0x7e6773(0x1e9)],[constants_1['FLOSUM_NAMESPACE']+_0x7e6773(0x262)]:_0x921717[_0x7e6773(0x214)]};});}async[a401_0x560fcc(0x231)](_0x52a089){const _0x2edcfb=a401_0x560fcc;this[_0x2edcfb(0x1dd)][_0x2edcfb(0x1d5)](_0x2edcfb(0x241));const _0x13b2fd=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x2edcfb(0x21f)]+_0x2edcfb(0x256),_0x52a089),_0x58d66b=_0x13b2fd[_0x2edcfb(0x246)](_0x672112=>!_0x672112[_0x2edcfb(0x204)])['map'](_0x5cd2cd=>_0x5cd2cd[_0x2edcfb(0x1f5)])[_0x2edcfb(0x26c)]();if(_0x58d66b['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x58d66b);}async['finishDeployWithError'](_0x269240){const _0x5860e6=a401_0x560fcc;this[_0x5860e6(0x1dd)][_0x5860e6(0x247)](_0x269240),await this[_0x5860e6(0x1dd)][_0x5860e6(0x24e)](),await this[_0x5860e6(0x224)](![],!![],'');}async['finishDeploy'](_0xe2fc1a,_0x3ce8ec,_0x384745){const _0x2cf016=a401_0x560fcc,_0x24b98b='<a\x20href='+this[_0x2cf016(0x213)]+'/'+this['_metadataLogId']+_0x2cf016(0x22e)+'Veeva\x20Deployment'+_0x2cf016(0x259),_0x992164=_0x2cf016(0x1f3)+this[_0x2cf016(0x213)]+'/'+this[_0x2cf016(0x1d2)]+'\x20>'+this[_0x2cf016(0x267)]+_0x2cf016(0x1f0),_0x25b635=_0x24b98b+_0x2cf016(0x250)+_0x992164+_0x2cf016(0x1fa),_0x4e79e3={[constants_1[_0x2cf016(0x21f)]+_0x2cf016(0x1f9)]:_0x25b635,[constants_1[_0x2cf016(0x21f)]+_0x2cf016(0x208)]:new Date(),[constants_1[_0x2cf016(0x21f)]+_0x2cf016(0x268)]:this['_branchId'],[constants_1['FLOSUM_NAMESPACE']+_0x2cf016(0x21b)]:_0x2cf016(0x238),[constants_1[_0x2cf016(0x21f)]+_0x2cf016(0x207)]:_0x2cf016(0x24c),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:this[_0x2cf016(0x1d2)]},_0x4a79ca={[constants_1[_0x2cf016(0x21f)]+_0x2cf016(0x1d7)]:!_0xe2fc1a,[constants_1['FLOSUM_NAMESPACE']+'Succeed__c']:_0xe2fc1a,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x3ce8ec?status_enums_1[_0x2cf016(0x1d3)][_0x2cf016(0x212)]:status_enums_1[_0x2cf016(0x1d3)][_0x2cf016(0x251)],[constants_1[_0x2cf016(0x21f)]+_0x2cf016(0x24b)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x2cf016(0x266)]:_0x384745};await this[_0x2cf016(0x264)][_0x2cf016(0x21d)](flosum_constants_1['FlosumConstants'][_0x2cf016(0x223)]+'/'+constants_1[_0x2cf016(0x21f)]+_0x2cf016(0x218)+this[_0x2cf016(0x1e9)],_0x4a79ca),await this[_0x2cf016(0x264)]['post'](flosum_constants_1[_0x2cf016(0x1fc)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0x4e79e3),this['_logger']['log'](_0x2cf016(0x1e4)+(_0xe2fc1a?'successfully':'with\x20error')+'.'),await this[_0x2cf016(0x1dd)][_0x2cf016(0x24e)]();}}exports[a401_0x560fcc(0x26b)]=DeployService;