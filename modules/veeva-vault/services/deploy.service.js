const a358_0x2185a9=a358_0x56a1;(function(_0x12c161,_0xff2558){const _0x5aa667=a358_0x56a1,_0x1542b3=_0x12c161();while(!![]){try{const _0x23559f=-parseInt(_0x5aa667(0x1f6))/0x1+-parseInt(_0x5aa667(0x23e))/0x2*(-parseInt(_0x5aa667(0x22f))/0x3)+parseInt(_0x5aa667(0x1f3))/0x4*(-parseInt(_0x5aa667(0x23b))/0x5)+parseInt(_0x5aa667(0x282))/0x6*(-parseInt(_0x5aa667(0x250))/0x7)+-parseInt(_0x5aa667(0x26e))/0x8+parseInt(_0x5aa667(0x256))/0x9*(-parseInt(_0x5aa667(0x254))/0xa)+parseInt(_0x5aa667(0x26f))/0xb*(parseInt(_0x5aa667(0x231))/0xc);if(_0x23559f===_0xff2558)break;else _0x1542b3['push'](_0x1542b3['shift']());}catch(_0x59ecb4){_0x1542b3['push'](_0x1542b3['shift']());}}}(a358_0x4ec6,0x9b5e0));const a358_0x4eb75a=(function(){let _0x2e14aa=!![];return function(_0x2a25af,_0x32714f){const _0x3d518e=_0x2e14aa?function(){const _0x19cda2=a358_0x56a1;if(_0x32714f){const _0x364ca3=_0x32714f[_0x19cda2(0x25b)](_0x2a25af,arguments);return _0x32714f=null,_0x364ca3;}}:function(){};return _0x2e14aa=![],_0x3d518e;};}()),a358_0x5df92f=a358_0x4eb75a(this,function(){const _0x29ae1e=a358_0x56a1;return a358_0x5df92f[_0x29ae1e(0x26c)]()[_0x29ae1e(0x228)](_0x29ae1e(0x239))[_0x29ae1e(0x26c)]()[_0x29ae1e(0x20d)](a358_0x5df92f)[_0x29ae1e(0x228)](_0x29ae1e(0x239));});a358_0x5df92f();'use strict';var __importDefault=this&&this[a358_0x2185a9(0x265)]||function(_0x29cb06){const _0x2ce2df=a358_0x2185a9;return _0x29cb06&&_0x29cb06[_0x2ce2df(0x26d)]?_0x29cb06:{'default':_0x29cb06};};function a358_0x56a1(_0x12e92c,_0x4c92f8){const _0x11af29=a358_0x4ec6();return a358_0x56a1=function(_0x5df92f,_0x4eb75a){_0x5df92f=_0x5df92f-0x1eb;let _0x4ec692=_0x11af29[_0x5df92f];return _0x4ec692;},a358_0x56a1(_0x12e92c,_0x4c92f8);}Object[a358_0x2185a9(0x272)](exports,a358_0x2185a9(0x26d),{'value':!![]}),exports['DeployService']=void 0x0;function a358_0x4ec6(){const _0x5f1686=['SalesforceService','/vpk__','Logger','../enums/status.enums','generate','(((.+)+)+)+$','error','175mnJKSL','VpkService','../../../constants','9668KMfxEh','length','default','saveDeploymentResults','packageId','filter','./veeva.service','_veevaService','success','Save\x20Backup\x20to\x20Salesforce','values','Cannot\x20Backup\x20more\x20than\x20200\x20components.','retrieve','./package-export.service','Cannot\x20retrievers\x20all\x20attachments','updateLog','generateAsync','Activity_Type__c','266jConSg','MetadataLogStatus','FlosumConstants','Branch','96850NvdWXk','attachmentLogId','153GCbRxu','shortid','Date__c','veeva-deploy','FLOSUM_NAMESPACE','apply','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','post','Status__c','fs/promises','<a\x20href=','_salesforceService','_packageImportService','stepName','../constants/flosum.constants','__importDefault','_logger','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','\x20</a>','Succeed__c','branchId','finishDeploy','toString','__esModule','2668536qJklGi','24243571SXmoaL','_vpkService','DEPLOYED','defineProperty','Failure','logError','Deployment','packageComponentList','Branch__c','_metadataLogId','./vpk.service','</a>','\x20:\x20','_branchId','ZipCreatorDeploy','finishDeployWithError','componentHistoryId','componentName','Action__c','150918RZlRpe','isDeployed','fetchAttachmentsDetailsByParentId','SalesforceDmlError','Component_History__c','../../shared/utils/fetch-attachments','deploymentName','TargetId__c','log','metadataLogId','DeployService','writeFile','./salesforce.service','Org__c','Save\x20Deployment\x20Results','componentType','set','Form\x20Deployment\x20Results','COMPLETED','Component_Name__c','_deploymentName','PackageExportService','Metadata_Log__c/','lastIndexOf','application/zip','getFlosumComponents','../../../core','138036WxKYBD','BACKUP_ZIP_NAME','jszip','75564OIJxmo','Retrieving\x20attachments','_timeZone','Deployment_Result__c','formFlosumDeploymentResults','BranchComponentHistoryFlosumComponentRetriever','saveBackup','Component_Type__c','PackageComponentStatus','_attachmentLogId','_packageExportService','_organisationId','/Attachment','createVpk','map','from','PackageImportService','.zip','retrieveAttachments','_componentIdList','bind','_instanceUrl','_connectionSalesforce','constructor','Join\x20all\x20mdl\x20into\x20one\x20zip','saveLog','Deployment\x20Result','export','has','Create\x20Backup','slice','Log__c','Job_Completed__c','Backup','with\x20error','ENDPOINT_UPSERT_RECORD','deploymentAction','toLowerCase','_connectionVeeva','_organisationName','../classes/deploy/zip-creator.deploy','name','patch','execute','../classes/errors/salesforce-dml-error','VeevaService','status','createZip','Deploy\x20completed\x20','Veeva_Step_Name__c','search','Save\x20log','Retrieving\x20components','createBackup','Activity_Item__c','flat','Body','726pbPtlH','_tempFolder','12ZZYBMo','insertMultipleRecords','type'];a358_0x4ec6=function(){return _0x5f1686;};return a358_0x4ec6();}const jszip_1=__importDefault(require(a358_0x2185a9(0x1f5))),promises_1=require(a358_0x2185a9(0x25f)),constants_1=require(a358_0x2185a9(0x23d)),flosum_constants_1=require(a358_0x2185a9(0x264)),veeva_service_1=require(a358_0x2185a9(0x244)),salesforce_service_1=require(a358_0x2185a9(0x28e)),core_1=require(a358_0x2185a9(0x1f2)),status_enums_1=require(a358_0x2185a9(0x237)),salesforce_dml_error_1=require(a358_0x2185a9(0x222)),shortid_1=__importDefault(require(a358_0x2185a9(0x257))),fetch_attachments_1=require(a358_0x2185a9(0x287)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a358_0x2185a9(0x267)),flosum_component_veeva_component_retriever_1=require(a358_0x2185a9(0x25c)),package_export_service_1=require(a358_0x2185a9(0x24b)),vpk_service_1=require(a358_0x2185a9(0x279)),zip_creator_deploy_1=require(a358_0x2185a9(0x21e));class DeployService{constructor(_0x180c3c,_0x51cabe,_0x3b6884,_0x16c9c4,_0xc21987,_0x38c2f9){const _0x4455b4=a358_0x2185a9;this[_0x4455b4(0x20c)]=_0x51cabe,this[_0x4455b4(0x21c)]=_0x3b6884,this[_0x4455b4(0x266)]=_0x16c9c4,this[_0x4455b4(0x230)]=_0xc21987,this[_0x4455b4(0x20b)]=_0x38c2f9,this[_0x4455b4(0x27c)]=_0x180c3c[_0x4455b4(0x26a)],this[_0x4455b4(0x278)]=_0x180c3c[_0x4455b4(0x28b)],this[_0x4455b4(0x1ff)]=_0x180c3c[_0x4455b4(0x255)],this[_0x4455b4(0x201)]=_0x180c3c['organisationId'],this[_0x4455b4(0x1f8)]=_0x180c3c['timeZone'],this[_0x4455b4(0x21d)]=_0x180c3c['organisationName'],this['_componentIdList']=_0x180c3c['componentIdList'],this[_0x4455b4(0x1ec)]=_0x180c3c[_0x4455b4(0x288)],this['_systemLogger']=new core_1[(_0x4455b4(0x236))](_0x4455b4(0x259)),this[_0x4455b4(0x245)]=new veeva_service_1[(_0x4455b4(0x223))]({'connection':this['_connectionVeeva'],'logger':this['_logger']}),this['_salesforceService']=new salesforce_service_1[(_0x4455b4(0x234))]({'connection':this[_0x4455b4(0x20c)]}),this[_0x4455b4(0x262)]=new package_import_service_1[(_0x4455b4(0x206))]({'veevaService':this['_veevaService'],'connection':this[_0x4455b4(0x21c)],'logger':this['_logger'],'saveLog':this[_0x4455b4(0x20f)][_0x4455b4(0x20a)](this)}),this[_0x4455b4(0x200)]=new package_export_service_1[(_0x4455b4(0x1ed))]({'veevaService':this[_0x4455b4(0x245)],'connection':this[_0x4455b4(0x21c)],'logger':this['_logger']}),this[_0x4455b4(0x270)]=new vpk_service_1[(_0x4455b4(0x23c))]({'connection':this[_0x4455b4(0x21c)]});}async['execute'](){const _0x4b13b0=a358_0x2185a9;try{const _0x3eb00b=await this[_0x4b13b0(0x1f1)]();await this[_0x4b13b0(0x266)][_0x4b13b0(0x24d)]();const _0x1c65e9=await this[_0x4b13b0(0x22b)](_0x3eb00b);await this[_0x4b13b0(0x1fc)](_0x1c65e9);const _0x30ae69=await this[_0x4b13b0(0x208)](_0x3eb00b),_0x50d46a=await this[_0x4b13b0(0x225)](_0x30ae69),_0x4b3b7b=await this[_0x4b13b0(0x203)](_0x50d46a);await this[_0x4b13b0(0x266)][_0x4b13b0(0x24d)]();const _0x15a062=await this[_0x4b13b0(0x262)]['import'](_0x4b3b7b);await this['_logger'][_0x4b13b0(0x24d)]();const _0xcfee7d=this[_0x4b13b0(0x1fa)](_0x3eb00b,_0x15a062[_0x4b13b0(0x276)]);await this[_0x4b13b0(0x241)](_0xcfee7d),await this[_0x4b13b0(0x26b)](_0x15a062[_0x4b13b0(0x283)],![],_0x15a062[_0x4b13b0(0x242)]);}catch(_0x2af34a){await this['finishDeployWithError'](_0x2af34a)['catch'](_0x29a521=>this['_systemLogger'][_0x4b13b0(0x23a)](_0x29a521));}}async[a358_0x2185a9(0x1f1)](){const _0x1af78f=a358_0x2185a9,_0x1cb348=new Set(this[_0x1af78f(0x209)]);this[_0x1af78f(0x266)]['log'](_0x1af78f(0x22a));const _0x300552=await new branch_component_history_flosum_component_retriever_1[(_0x1af78f(0x1fb))]({'value':this[_0x1af78f(0x27c)],'salesforceService':this['_salesforceService']})[_0x1af78f(0x24a)](),_0x3befc7=_0x300552['filter'](_0x5e7c43=>_0x1cb348[_0x1af78f(0x212)](_0x5e7c43['id']));if(_0x3befc7[_0x1af78f(0x23f)]!==this[_0x1af78f(0x209)][_0x1af78f(0x23f)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x3befc7;}async[a358_0x2185a9(0x22b)](_0x11b3b5){const _0x338bfc=a358_0x2185a9;var _0x3948ba;this[_0x338bfc(0x266)][_0x338bfc(0x28a)](_0x338bfc(0x213));const _0x12d164=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x11b3b5,'veevaService':this['_veevaService'],'logger':this['_logger']})[_0x338bfc(0x24a)](),_0x720d1f=await this[_0x338bfc(0x200)][_0x338bfc(0x211)](_0x12d164,_0x338bfc(0x217));if(_0x720d1f['length']>0x1)throw new Error(_0x338bfc(0x249));return(_0x3948ba=_0x720d1f[0x0])!==null&&_0x3948ba!==void 0x0?_0x3948ba:_0x720d1f[0x0]=new jszip_1[(_0x338bfc(0x240))](),_0x720d1f[0x0][_0x338bfc(0x24e)]({'type':'base64'});}async['saveBackup'](_0x52e75a){const _0x339b21=a358_0x2185a9;this[_0x339b21(0x266)]['log'](_0x339b21(0x247));const _0xef202b={'Body':_0x52e75a,'ContentType':_0x339b21(0x1f0),'ParentId':this[_0x339b21(0x278)],'Name':flosum_constants_1[_0x339b21(0x252)][_0x339b21(0x1f4)]};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x339b21(0x252)]['ENDPOINT_UPSERT_RECORD']+_0x339b21(0x202),_0xef202b);}async[a358_0x2185a9(0x208)](_0x41ee5a){const _0x537609=a358_0x2185a9;this[_0x537609(0x266)][_0x537609(0x28a)](_0x537609(0x1f7));const _0x350964=await(0x0,fetch_attachments_1[_0x537609(0x284)])(this[_0x537609(0x20c)],_0x41ee5a['map'](_0x2f4c62=>_0x2f4c62[_0x537609(0x27f)])),_0x390530=await(0x0,fetch_attachments_1[_0x537609(0x208)])(_0x350964,this[_0x537609(0x20c)]);if(_0x390530[_0x537609(0x23f)]!==this[_0x537609(0x209)][_0x537609(0x23f)])throw new Error(_0x537609(0x24c));return _0x390530[_0x537609(0x204)](_0x329aca=>_0x329aca[_0x537609(0x248)][_0x537609(0x22e)]);}async[a358_0x2185a9(0x225)](_0x160f9c){const _0x2daf6a=a358_0x2185a9;this[_0x2daf6a(0x266)]['log'](_0x2daf6a(0x20e));const _0x8b7065=await new zip_creator_deploy_1[(_0x2daf6a(0x27d))]({'attachmentBodies':_0x160f9c,'deploymentName':this[_0x2daf6a(0x1ec)]})[_0x2daf6a(0x221)](),_0x4b11a8=this[_0x2daf6a(0x230)]+'/'+(0x0,shortid_1['default'])()+_0x2daf6a(0x207);return await(0x0,promises_1[_0x2daf6a(0x28d)])(_0x4b11a8,_0x8b7065),_0x4b11a8;}async[a358_0x2185a9(0x203)](_0x52863d){const _0x4e2089=a358_0x2185a9;this[_0x4e2089(0x266)][_0x4e2089(0x28a)]('Create\x20vpk\x20package');const _0x1d8cf=await this[_0x4e2089(0x270)][_0x4e2089(0x238)](_0x52863d),_0x20dadf=this[_0x4e2089(0x230)]+_0x4e2089(0x235)+_0x52863d[_0x4e2089(0x214)](_0x52863d[_0x4e2089(0x1ef)]('/')+0x1);return await(0x0,promises_1[_0x4e2089(0x28d)])(_0x20dadf,_0x1d8cf),await this[_0x4e2089(0x270)]['validate'](_0x20dadf),_0x20dadf;}async[a358_0x2185a9(0x20f)](_0x2675f4,_0x598a7d){const _0xa4fd0=a358_0x2185a9;this[_0xa4fd0(0x266)][_0xa4fd0(0x28a)](_0xa4fd0(0x229));const _0x196b41={'Body':Buffer[_0xa4fd0(0x205)](_0x2675f4)[_0xa4fd0(0x26c)]('base64'),'ContentType':'text/plain','ParentId':this[_0xa4fd0(0x278)],'Name':_0x598a7d};await this[_0xa4fd0(0x20c)]['post'](flosum_constants_1[_0xa4fd0(0x252)][_0xa4fd0(0x219)]+_0xa4fd0(0x202),_0x196b41);}[a358_0x2185a9(0x1fa)](_0x3f2dc8,_0x5ddfd6){const _0x163aa0=a358_0x2185a9;this['_logger'][_0x163aa0(0x28a)](_0x163aa0(0x293));const _0x24faa5=_0x3f2dc8['reduce']((_0x1d79b9,_0x422303)=>_0x1d79b9[_0x163aa0(0x292)]((_0x422303[_0x163aa0(0x291)]+'.'+_0x422303[_0x163aa0(0x280)])[_0x163aa0(0x21b)](),_0x422303),new Map());return _0x5ddfd6['map'](_0x3c7576=>{const _0x1efcb6=_0x163aa0;this[_0x1efcb6(0x266)][_0x1efcb6(0x28a)](_0x3c7576[_0x1efcb6(0x233)]+'.'+_0x3c7576['name']+_0x1efcb6(0x27b)+_0x3c7576[_0x1efcb6(0x224)]);const _0x3eac33=(_0x3c7576['type']+'.'+_0x3c7576[_0x1efcb6(0x21f)])[_0x1efcb6(0x21b)](),_0x7e1857=_0x24faa5['get'](_0x3eac33);return{[constants_1[_0x1efcb6(0x25a)]+'Type__c']:_0x1efcb6(0x210),[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x3c7576['status']===status_enums_1[_0x1efcb6(0x1fe)][_0x1efcb6(0x271)]?'Success':_0x1efcb6(0x273),[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x3c7576[_0x1efcb6(0x21a)],[constants_1['FLOSUM_NAMESPACE']+_0x1efcb6(0x1eb)]:_0x3c7576[_0x1efcb6(0x21f)],[constants_1[_0x1efcb6(0x25a)]+_0x1efcb6(0x1fd)]:_0x3c7576[_0x1efcb6(0x233)],[constants_1[_0x1efcb6(0x25a)]+_0x1efcb6(0x227)]:_0x3c7576[_0x1efcb6(0x263)],[constants_1[_0x1efcb6(0x25a)]+_0x1efcb6(0x28f)]:this[_0x1efcb6(0x201)],[constants_1[_0x1efcb6(0x25a)]+'Metadata_Log__c']:this[_0x1efcb6(0x278)],[constants_1[_0x1efcb6(0x25a)]+_0x1efcb6(0x286)]:_0x7e1857[_0x1efcb6(0x27f)]};});}async[a358_0x2185a9(0x241)](_0x175f20){const _0x4581b2=a358_0x2185a9;this[_0x4581b2(0x266)]['log'](_0x4581b2(0x290));const _0x249c32=await this[_0x4581b2(0x261)][_0x4581b2(0x232)](constants_1['FLOSUM_NAMESPACE']+_0x4581b2(0x1f9),_0x175f20),_0x825764=_0x249c32[_0x4581b2(0x243)](_0x44a772=>!_0x44a772[_0x4581b2(0x246)])['map'](_0x2adf37=>_0x2adf37['errors'])[_0x4581b2(0x22d)]();if(_0x825764[_0x4581b2(0x23f)])throw new salesforce_dml_error_1[(_0x4581b2(0x285))](_0x825764);}async[a358_0x2185a9(0x27e)](_0x2d4a83){const _0x3216b2=a358_0x2185a9;this[_0x3216b2(0x266)][_0x3216b2(0x274)](_0x2d4a83),await this[_0x3216b2(0x266)][_0x3216b2(0x24d)](),await this[_0x3216b2(0x26b)](![],!![],'');}async[a358_0x2185a9(0x26b)](_0x1d8487,_0x5857af,_0x19adb5){const _0x244e99=a358_0x2185a9,_0x27ca8c=_0x244e99(0x260)+this[_0x244e99(0x20b)]+'/'+this['_metadataLogId']+'\x20>\x20'+'Veeva\x20Deployment'+_0x244e99(0x268),_0x54a1a3='<a\x20href='+this[_0x244e99(0x20b)]+'/'+this[_0x244e99(0x201)]+'\x20>'+this[_0x244e99(0x21d)]+_0x244e99(0x27a),_0x2e9b35=_0x27ca8c+'\x20of\x20branch\x20to\x20Organization\x20'+_0x54a1a3+'\x20has\x20been\x20created.',_0x34e8da={[constants_1['FLOSUM_NAMESPACE']+_0x244e99(0x281)]:_0x2e9b35,[constants_1[_0x244e99(0x25a)]+_0x244e99(0x258)]:new Date(),[constants_1[_0x244e99(0x25a)]+_0x244e99(0x277)]:this[_0x244e99(0x27c)],[constants_1['FLOSUM_NAMESPACE']+_0x244e99(0x22c)]:_0x244e99(0x253),[constants_1['FLOSUM_NAMESPACE']+_0x244e99(0x24f)]:_0x244e99(0x275),[constants_1[_0x244e99(0x25a)]+_0x244e99(0x289)]:this['_organisationId']},_0x1eb2e5={[constants_1[_0x244e99(0x25a)]+'Is_Error__c']:!_0x1d8487,[constants_1[_0x244e99(0x25a)]+_0x244e99(0x269)]:_0x1d8487,[constants_1[_0x244e99(0x25a)]+_0x244e99(0x25e)]:_0x5857af?status_enums_1[_0x244e99(0x251)]['EXCEPTION']:status_enums_1[_0x244e99(0x251)][_0x244e99(0x294)],[constants_1[_0x244e99(0x25a)]+_0x244e99(0x216)]:!![],[constants_1[_0x244e99(0x25a)]+'External_Deployment_Id__c']:_0x19adb5};await this['_connectionSalesforce'][_0x244e99(0x220)](flosum_constants_1['FlosumConstants'][_0x244e99(0x219)]+'/'+constants_1[_0x244e99(0x25a)]+_0x244e99(0x1ee)+this['_metadataLogId'],_0x1eb2e5),await this[_0x244e99(0x20c)][_0x244e99(0x25d)](flosum_constants_1[_0x244e99(0x252)][_0x244e99(0x219)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x244e99(0x215),_0x34e8da),this[_0x244e99(0x266)][_0x244e99(0x28a)](_0x244e99(0x226)+(_0x1d8487?'successfully':_0x244e99(0x218))+'.'),await this[_0x244e99(0x266)][_0x244e99(0x24d)]();}}exports[a358_0x2185a9(0x28c)]=DeployService;