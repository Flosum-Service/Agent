const a358_0x399b7d=a358_0x10fd;function a358_0x5664(){const _0x44b3df=['Save\x20log','packageComponentList','Branch','constructor','__importDefault','default','Backup','generate','retrieveAttachments','Save\x20Deployment\x20Results','MetadataLogStatus','bind','Status__c','_packageExportService','_connectionSalesforce','Form\x20Deployment\x20Results','Cannot\x20Backup\x20more\x20than\x20200\x20components.','(((.+)+)+)+$','ZipCreatorDeploy','length','DEPLOYED','PackageImportService','Metadata_Log__c/','export','componentName','_organisationId','text/plain','toString','_organisationName','post','VeevaService','</a>','finishDeployWithError','6522740tCLHPZ','flat','../classes/errors/salesforce-dml-error','saveBackup','name','PackageExportService','map','shortid','slice','326412nirUAw','/vpk__','Cannot\x20retrieve\x20all\x20components.','values','_veevaService','Retrieving\x20attachments','Deploy\x20completed\x20','Component_Name__c','_metadataLogId','BranchComponentHistoryFlosumComponentRetriever','from','Action__c','status','COMPLETED','FlosumConstants','__esModule','retrieve','createZip','saveDeploymentResults','packageId','success','search','./package-export.service','deploymentAction','External_Deployment_Id__c','_tempFolder','import','../../../core','insertMultipleRecords','with\x20error','base64','Is_Error__c','./salesforce.service','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','fetchAttachmentsDetailsByParentId','Deployment\x20Result','Date__c','createVpk','16vbXYhl','Component_Type__c','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','componentIdList','catch','generateAsync','./veeva.service','defineProperty','6880464saIpti','.zip','set','BACKUP_ZIP_NAME','Deployment','FLOSUM_NAMESPACE','_instanceUrl','finishDeploy','141312SLAIdT','Succeed__c','_timeZone','3DKOKGJ','<a\x20href=','391384FTKABm','SalesforceService','toLowerCase','EXCEPTION','PackageComponentStatus','Save\x20Backup\x20to\x20Salesforce','\x20has\x20been\x20created.','metadataLogId','componentType','filter','../../shared/utils/fetch-attachments','_attachmentLogId','_vpkService','Body','apply','_componentIdList','../enums/status.enums','saveLog','_connectionVeeva','../constants/flosum.constants','Branch__c','execute','150XtXagv','formFlosumDeploymentResults','log','_branchId','197738JTPrTp','Type__c','veeva-deploy','_packageImportService','stepName','Retrieving\x20components','patch','SalesforceDmlError','Component_History__c','updateLog','../classes/deploy/zip-creator.deploy','_systemLogger','errors','validate','\x20</a>','DeployService','jszip','Org__c','reduce','_salesforceService','writeFile','lastIndexOf','Log__c','successfully','_logger','_deploymentName','attachmentLogId','ENDPOINT_UPSERT_RECORD','Create\x20Backup','createBackup','/Attachment','459zYgIGB','deploymentName','Activity_Item__c','type','2374229mAdTLD'];a358_0x5664=function(){return _0x44b3df;};return a358_0x5664();}(function(_0x5caf15,_0x41b000){const _0x4ad536=a358_0x10fd,_0x4d3347=_0x5caf15();while(!![]){try{const _0x129bc9=parseInt(_0x4ad536(0x18a))/0x1*(parseInt(_0x4ad536(0x1a6))/0x2)+-parseInt(_0x4ad536(0x1f4))/0x3*(-parseInt(_0x4ad536(0x21a))/0x4)+-parseInt(_0x4ad536(0x1eb))/0x5+-parseInt(_0x4ad536(0x222))/0x6+parseInt(_0x4ad536(0x18c))/0x7+parseInt(_0x4ad536(0x187))/0x8*(-parseInt(_0x4ad536(0x1c5))/0x9)+-parseInt(_0x4ad536(0x1a2))/0xa*(-parseInt(_0x4ad536(0x1c9))/0xb);if(_0x129bc9===_0x41b000)break;else _0x4d3347['push'](_0x4d3347['shift']());}catch(_0x4461fc){_0x4d3347['push'](_0x4d3347['shift']());}}}(a358_0x5664,0xa458c));const a358_0x1bc168=(function(){let _0x372cbb=!![];return function(_0x5f06f4,_0x571d77){const _0x531604=_0x372cbb?function(){const _0x1107f9=a358_0x10fd;if(_0x571d77){const _0x44ec0c=_0x571d77[_0x1107f9(0x19a)](_0x5f06f4,arguments);return _0x571d77=null,_0x44ec0c;}}:function(){};return _0x372cbb=![],_0x531604;};}()),a358_0x26a056=a358_0x1bc168(this,function(){const _0x5821f3=a358_0x10fd;return a358_0x26a056[_0x5821f3(0x1e5)]()[_0x5821f3(0x209)]('(((.+)+)+)+$')[_0x5821f3(0x1e5)]()[_0x5821f3(0x1cd)](a358_0x26a056)[_0x5821f3(0x209)](_0x5821f3(0x1db));});a358_0x26a056();'use strict';var __importDefault=this&&this[a358_0x399b7d(0x1ce)]||function(_0x26b9fd){const _0x48df75=a358_0x399b7d;return _0x26b9fd&&_0x26b9fd[_0x48df75(0x203)]?_0x26b9fd:{'default':_0x26b9fd};};Object[a358_0x399b7d(0x221)](exports,a358_0x399b7d(0x203),{'value':!![]}),exports[a358_0x399b7d(0x1b5)]=void 0x0;const jszip_1=__importDefault(require(a358_0x399b7d(0x1b6))),promises_1=require('fs/promises'),constants_1=require('../../../constants'),flosum_constants_1=require(a358_0x399b7d(0x19f)),veeva_service_1=require(a358_0x399b7d(0x220)),salesforce_service_1=require(a358_0x399b7d(0x214)),core_1=require(a358_0x399b7d(0x20f)),status_enums_1=require(a358_0x399b7d(0x19c)),salesforce_dml_error_1=require(a358_0x399b7d(0x1ed)),shortid_1=__importDefault(require(a358_0x399b7d(0x1f2))),fetch_attachments_1=require(a358_0x399b7d(0x196)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a358_0x399b7d(0x21c)),flosum_component_veeva_component_retriever_1=require(a358_0x399b7d(0x215)),package_export_service_1=require(a358_0x399b7d(0x20a)),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require(a358_0x399b7d(0x1b0));function a358_0x10fd(_0x5016a1,_0x46d247){const _0x2feadf=a358_0x5664();return a358_0x10fd=function(_0x26a056,_0x1bc168){_0x26a056=_0x26a056-0x186;let _0x5664f7=_0x2feadf[_0x26a056];return _0x5664f7;},a358_0x10fd(_0x5016a1,_0x46d247);}class DeployService{constructor(_0x1c43f5,_0x1cbc79,_0x16453e,_0x2a1572,_0x71ab,_0x52c1b9){const _0x21bc46=a358_0x399b7d;this[_0x21bc46(0x1d8)]=_0x1cbc79,this[_0x21bc46(0x19e)]=_0x16453e,this['_logger']=_0x2a1572,this[_0x21bc46(0x20d)]=_0x71ab,this[_0x21bc46(0x228)]=_0x52c1b9,this[_0x21bc46(0x1a5)]=_0x1c43f5['branchId'],this[_0x21bc46(0x1fc)]=_0x1c43f5[_0x21bc46(0x193)],this[_0x21bc46(0x197)]=_0x1c43f5[_0x21bc46(0x1c0)],this[_0x21bc46(0x1e3)]=_0x1c43f5['organisationId'],this[_0x21bc46(0x189)]=_0x1c43f5['timeZone'],this[_0x21bc46(0x1e6)]=_0x1c43f5['organisationName'],this[_0x21bc46(0x19b)]=_0x1c43f5[_0x21bc46(0x21d)],this[_0x21bc46(0x1bf)]=_0x1c43f5[_0x21bc46(0x1c6)],this['_systemLogger']=new core_1['Logger'](_0x21bc46(0x1a8)),this[_0x21bc46(0x1f8)]=new veeva_service_1[(_0x21bc46(0x1e8))]({'connection':this['_connectionVeeva'],'logger':this[_0x21bc46(0x1be)]}),this[_0x21bc46(0x1b9)]=new salesforce_service_1[(_0x21bc46(0x18d))]({'connection':this[_0x21bc46(0x1d8)]}),this[_0x21bc46(0x1a9)]=new package_import_service_1[(_0x21bc46(0x1df))]({'veevaService':this[_0x21bc46(0x1f8)],'connection':this[_0x21bc46(0x19e)],'logger':this['_logger'],'saveLog':this['saveLog'][_0x21bc46(0x1d5)](this)}),this[_0x21bc46(0x1d7)]=new package_export_service_1[(_0x21bc46(0x1f0))]({'veevaService':this['_veevaService'],'connection':this[_0x21bc46(0x19e)],'logger':this[_0x21bc46(0x1be)]}),this['_vpkService']=new vpk_service_1['VpkService']({'connection':this[_0x21bc46(0x19e)]});}async['execute'](){const _0x2c024e=a358_0x399b7d;try{const _0xb6ad30=await this['getFlosumComponents']();await this['_logger'][_0x2c024e(0x1af)]();const _0x5661a4=await this[_0x2c024e(0x1c3)](_0xb6ad30);await this[_0x2c024e(0x1ee)](_0x5661a4);const _0x241400=await this[_0x2c024e(0x1d2)](_0xb6ad30),_0x34a0e6=await this[_0x2c024e(0x205)](_0x241400),_0x1dcc8d=await this['createVpk'](_0x34a0e6);await this['_logger'][_0x2c024e(0x1af)]();const _0x4b7e47=await this[_0x2c024e(0x1a9)][_0x2c024e(0x20e)](_0x1dcc8d);await this[_0x2c024e(0x1be)][_0x2c024e(0x1af)]();const _0x2dc8fe=this['formFlosumDeploymentResults'](_0xb6ad30,_0x4b7e47[_0x2c024e(0x1cb)]);await this[_0x2c024e(0x206)](_0x2dc8fe),await this[_0x2c024e(0x186)](_0x4b7e47['isDeployed'],![],_0x4b7e47[_0x2c024e(0x207)]);}catch(_0x568613){await this[_0x2c024e(0x1ea)](_0x568613)[_0x2c024e(0x21e)](_0x5b037f=>this[_0x2c024e(0x1b1)]['error'](_0x5b037f));}}async['getFlosumComponents'](){const _0x2e9118=a358_0x399b7d,_0x2eac5e=new Set(this['_componentIdList']);this[_0x2e9118(0x1be)][_0x2e9118(0x1a4)](_0x2e9118(0x1ab));const _0x38c8e4=await new branch_component_history_flosum_component_retriever_1[(_0x2e9118(0x1fd))]({'value':this['_branchId'],'salesforceService':this[_0x2e9118(0x1b9)]})[_0x2e9118(0x204)](),_0x49195b=_0x38c8e4[_0x2e9118(0x195)](_0x13adc7=>_0x2eac5e['has'](_0x13adc7['id']));if(_0x49195b['length']!==this[_0x2e9118(0x19b)][_0x2e9118(0x1dd)])throw new Error(_0x2e9118(0x1f6));return _0x49195b;}async['createBackup'](_0x3273d1){const _0x3260bd=a358_0x399b7d;var _0x783280;this['_logger'][_0x3260bd(0x1a4)](_0x3260bd(0x1c2));const _0x4c6ee2=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x3273d1,'veevaService':this['_veevaService'],'logger':this['_logger']})[_0x3260bd(0x204)](),_0x2d5bc5=await this[_0x3260bd(0x1d7)][_0x3260bd(0x1e1)](_0x4c6ee2,_0x3260bd(0x1d0));if(_0x2d5bc5[_0x3260bd(0x1dd)]>0x1)throw new Error(_0x3260bd(0x1da));return(_0x783280=_0x2d5bc5[0x0])!==null&&_0x783280!==void 0x0?_0x783280:_0x2d5bc5[0x0]=new jszip_1['default'](),_0x2d5bc5[0x0][_0x3260bd(0x21f)]({'type':_0x3260bd(0x212)});}async['saveBackup'](_0x351031){const _0x339ed0=a358_0x399b7d;this['_logger']['log'](_0x339ed0(0x191));const _0x538bff={'Body':_0x351031,'ContentType':'application/zip','ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x339ed0(0x202)][_0x339ed0(0x225)]};await this['_connectionSalesforce'][_0x339ed0(0x1e7)](flosum_constants_1[_0x339ed0(0x202)][_0x339ed0(0x1c1)]+_0x339ed0(0x1c4),_0x538bff);}async[a358_0x399b7d(0x1d2)](_0x2cf1f5){const _0x267c8d=a358_0x399b7d;this[_0x267c8d(0x1be)]['log'](_0x267c8d(0x1f9));const _0x33a609=await(0x0,fetch_attachments_1[_0x267c8d(0x216)])(this[_0x267c8d(0x1d8)],_0x2cf1f5['map'](_0x40a349=>_0x40a349['componentHistoryId'])),_0x228d21=await(0x0,fetch_attachments_1[_0x267c8d(0x1d2)])(_0x33a609,this['_connectionSalesforce']);if(_0x228d21[_0x267c8d(0x1dd)]!==this[_0x267c8d(0x19b)][_0x267c8d(0x1dd)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x228d21[_0x267c8d(0x1f1)](_0x9440ec=>_0x9440ec[_0x267c8d(0x1f7)][_0x267c8d(0x199)]);}async[a358_0x399b7d(0x205)](_0x3b4d48){const _0xfbd161=a358_0x399b7d;this[_0xfbd161(0x1be)]['log']('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x576de7=await new zip_creator_deploy_1[(_0xfbd161(0x1dc))]({'attachmentBodies':_0x3b4d48,'deploymentName':this[_0xfbd161(0x1bf)]})[_0xfbd161(0x1a1)](),_0x3b1ffb=this['_tempFolder']+'/'+(0x0,shortid_1[_0xfbd161(0x1cf)])()+_0xfbd161(0x223);return await(0x0,promises_1[_0xfbd161(0x1ba)])(_0x3b1ffb,_0x576de7),_0x3b1ffb;}async[a358_0x399b7d(0x219)](_0x276319){const _0x1e15be=a358_0x399b7d;this[_0x1e15be(0x1be)]['log']('Create\x20vpk\x20package');const _0x55ad07=await this['_vpkService'][_0x1e15be(0x1d1)](_0x276319),_0x203faa=this[_0x1e15be(0x20d)]+_0x1e15be(0x1f5)+_0x276319[_0x1e15be(0x1f3)](_0x276319[_0x1e15be(0x1bb)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x203faa,_0x55ad07),await this[_0x1e15be(0x198)][_0x1e15be(0x1b3)](_0x203faa),_0x203faa;}async[a358_0x399b7d(0x19d)](_0xd70593,_0x26e1ea){const _0x3408df=a358_0x399b7d;this[_0x3408df(0x1be)]['log'](_0x3408df(0x1ca));const _0xa2dec8={'Body':Buffer[_0x3408df(0x1fe)](_0xd70593)['toString'](_0x3408df(0x212)),'ContentType':_0x3408df(0x1e4),'ParentId':this[_0x3408df(0x1fc)],'Name':_0x26e1ea};await this['_connectionSalesforce'][_0x3408df(0x1e7)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0x3408df(0x1c4),_0xa2dec8);}[a358_0x399b7d(0x1a3)](_0x28ef98,_0x3397da){const _0x5b53b1=a358_0x399b7d;this['_logger'][_0x5b53b1(0x1a4)](_0x5b53b1(0x1d9));const _0x36b666=_0x28ef98[_0x5b53b1(0x1b8)]((_0x4a157a,_0xaed899)=>_0x4a157a[_0x5b53b1(0x224)]((_0xaed899[_0x5b53b1(0x194)]+'.'+_0xaed899[_0x5b53b1(0x1e2)])[_0x5b53b1(0x18e)](),_0xaed899),new Map());return _0x3397da['map'](_0x44ab35=>{const _0x363e1a=_0x5b53b1;this[_0x363e1a(0x1be)]['log'](_0x44ab35['type']+'.'+_0x44ab35['name']+'\x20:\x20'+_0x44ab35[_0x363e1a(0x200)]);const _0x44964a=(_0x44ab35[_0x363e1a(0x1c8)]+'.'+_0x44ab35['name'])['toLowerCase'](),_0xa43373=_0x36b666['get'](_0x44964a);return{[constants_1['FLOSUM_NAMESPACE']+_0x363e1a(0x1a7)]:_0x363e1a(0x217),[constants_1[_0x363e1a(0x227)]+_0x363e1a(0x1d6)]:_0x44ab35[_0x363e1a(0x200)]===status_enums_1[_0x363e1a(0x190)][_0x363e1a(0x1de)]?'Success':'Failure',[constants_1[_0x363e1a(0x227)]+'Result__c']:_0x44ab35[_0x363e1a(0x20b)],[constants_1[_0x363e1a(0x227)]+_0x363e1a(0x1fb)]:_0x44ab35[_0x363e1a(0x1ef)],[constants_1[_0x363e1a(0x227)]+_0x363e1a(0x21b)]:_0x44ab35[_0x363e1a(0x1c8)],[constants_1[_0x363e1a(0x227)]+'Veeva_Step_Name__c']:_0x44ab35[_0x363e1a(0x1aa)],[constants_1[_0x363e1a(0x227)]+_0x363e1a(0x1b7)]:this[_0x363e1a(0x1e3)],[constants_1[_0x363e1a(0x227)]+'Metadata_Log__c']:this[_0x363e1a(0x1fc)],[constants_1[_0x363e1a(0x227)]+_0x363e1a(0x1ae)]:_0xa43373['componentHistoryId']};});}async[a358_0x399b7d(0x206)](_0x69d87c){const _0x3f2179=a358_0x399b7d;this[_0x3f2179(0x1be)]['log'](_0x3f2179(0x1d3));const _0x3b1be5=await this[_0x3f2179(0x1b9)][_0x3f2179(0x210)](constants_1[_0x3f2179(0x227)]+'Deployment_Result__c',_0x69d87c),_0x1e810f=_0x3b1be5[_0x3f2179(0x195)](_0x33defc=>!_0x33defc[_0x3f2179(0x208)])[_0x3f2179(0x1f1)](_0xc4f5d8=>_0xc4f5d8[_0x3f2179(0x1b2)])[_0x3f2179(0x1ec)]();if(_0x1e810f['length'])throw new salesforce_dml_error_1[(_0x3f2179(0x1ad))](_0x1e810f);}async[a358_0x399b7d(0x1ea)](_0x104ad7){const _0x22e456=a358_0x399b7d;this[_0x22e456(0x1be)]['logError'](_0x104ad7),await this[_0x22e456(0x1be)][_0x22e456(0x1af)](),await this['finishDeploy'](![],!![],'');}async['finishDeploy'](_0x593f92,_0x22b5a4,_0x2bb0b9){const _0x584198=a358_0x399b7d,_0xe5941b=_0x584198(0x18b)+this[_0x584198(0x228)]+'/'+this['_metadataLogId']+'\x20>\x20'+'Veeva\x20Deployment'+_0x584198(0x1b4),_0x4f7d0c=_0x584198(0x18b)+this[_0x584198(0x228)]+'/'+this['_organisationId']+'\x20>'+this[_0x584198(0x1e6)]+_0x584198(0x1e9),_0x2c8088=_0xe5941b+'\x20of\x20branch\x20to\x20Organization\x20'+_0x4f7d0c+_0x584198(0x192),_0xdcf958={[constants_1[_0x584198(0x227)]+_0x584198(0x1ff)]:_0x2c8088,[constants_1['FLOSUM_NAMESPACE']+_0x584198(0x218)]:new Date(),[constants_1[_0x584198(0x227)]+_0x584198(0x1a0)]:this[_0x584198(0x1a5)],[constants_1[_0x584198(0x227)]+_0x584198(0x1c7)]:_0x584198(0x1cc),[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0x584198(0x226),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:this[_0x584198(0x1e3)]},_0x185303={[constants_1[_0x584198(0x227)]+_0x584198(0x213)]:!_0x593f92,[constants_1[_0x584198(0x227)]+_0x584198(0x188)]:_0x593f92,[constants_1['FLOSUM_NAMESPACE']+_0x584198(0x1d6)]:_0x22b5a4?status_enums_1[_0x584198(0x1d4)][_0x584198(0x18f)]:status_enums_1[_0x584198(0x1d4)][_0x584198(0x201)],[constants_1[_0x584198(0x227)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x584198(0x20c)]:_0x2bb0b9};await this[_0x584198(0x1d8)][_0x584198(0x1ac)](flosum_constants_1['FlosumConstants'][_0x584198(0x1c1)]+'/'+constants_1[_0x584198(0x227)]+_0x584198(0x1e0)+this[_0x584198(0x1fc)],_0x185303),await this[_0x584198(0x1d8)][_0x584198(0x1e7)](flosum_constants_1[_0x584198(0x202)][_0x584198(0x1c1)]+'/'+constants_1[_0x584198(0x227)]+_0x584198(0x1bc),_0xdcf958),this[_0x584198(0x1be)][_0x584198(0x1a4)](_0x584198(0x1fa)+(_0x593f92?_0x584198(0x1bd):_0x584198(0x211))+'.'),await this[_0x584198(0x1be)][_0x584198(0x1af)]();}}exports[a358_0x399b7d(0x1b5)]=DeployService;