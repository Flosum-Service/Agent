const a358_0x3b3041=a358_0x3221;(function(_0x2b93df,_0x8ea83b){const _0x4eca80=a358_0x3221,_0x2d7155=_0x2b93df();while(!![]){try{const _0x1cd21a=parseInt(_0x4eca80(0x14c))/0x1*(parseInt(_0x4eca80(0x162))/0x2)+parseInt(_0x4eca80(0x11c))/0x3+parseInt(_0x4eca80(0x17d))/0x4+parseInt(_0x4eca80(0x157))/0x5*(-parseInt(_0x4eca80(0x17b))/0x6)+-parseInt(_0x4eca80(0x122))/0x7*(parseInt(_0x4eca80(0x11a))/0x8)+-parseInt(_0x4eca80(0x169))/0x9*(-parseInt(_0x4eca80(0xf8))/0xa)+parseInt(_0x4eca80(0x15f))/0xb*(parseInt(_0x4eca80(0x178))/0xc);if(_0x1cd21a===_0x8ea83b)break;else _0x2d7155['push'](_0x2d7155['shift']());}catch(_0x536f66){_0x2d7155['push'](_0x2d7155['shift']());}}}(a358_0x1443,0xaf621));const a358_0x9bb895=(function(){let _0x5a0683=!![];return function(_0x572b79,_0x38bec1){const _0x46f4be=_0x5a0683?function(){const _0xa852aa=a358_0x3221;if(_0x38bec1){const _0x148642=_0x38bec1[_0xa852aa(0x108)](_0x572b79,arguments);return _0x38bec1=null,_0x148642;}}:function(){};return _0x5a0683=![],_0x46f4be;};}()),a358_0x4291b4=a358_0x9bb895(this,function(){const _0x10b464=a358_0x3221;return a358_0x4291b4[_0x10b464(0x164)]()[_0x10b464(0x163)]('(((.+)+)+)+$')[_0x10b464(0x164)]()[_0x10b464(0x16f)](a358_0x4291b4)[_0x10b464(0x163)](_0x10b464(0xfe));});a358_0x4291b4();function a358_0x1443(){const _0x49e550=['_organisationId','__importDefault','branchId','retrieve','set','constructor','saveBackup','lastIndexOf','./package-import.service','Success','Branch__c','retrieveAttachments','formFlosumDeploymentResults','name','14046444xspBjc','PackageExportService','MetadataLogStatus','12072WOFLgC','./salesforce.service','2409728ZcCZoe','Deployment\x20Result','../../../core','Body','jszip','componentName','_logger','_veevaService','DEPLOYED','error','_connectionVeeva','Form\x20Deployment\x20Results','_branchId','logError','EXCEPTION','../enums/status.enums','ENDPOINT_UPSERT_RECORD','Save\x20log','TargetId__c','generateAsync','Save\x20Backup\x20to\x20Salesforce','PackageImportService','fs/promises','slice','Veeva\x20Deployment','saveDeploymentResults','success','653830sNrRQa','_attachmentLogId','organisationName','Is_Error__c','Create\x20Backup','filter','(((.+)+)+)+$','has','isDeployed','../classes/errors/salesforce-dml-error','_timeZone','Log__c','patch','FLOSUM_NAMESPACE','componentHistoryId','../classes/deploy/zip-creator.deploy','apply','_systemLogger','with\x20error','Status__c','validate','Branch','Join\x20all\x20mdl\x20into\x20one\x20zip','post','/vpk__','writeFile','finishDeploy','generate','status','base64','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Deployment_Result__c','componentType','PackageComponentStatus','10900248wRZLKo','_instanceUrl','1332036mbWQuW','Cannot\x20retrievers\x20all\x20attachments','DeployService','type','Deploy\x20completed\x20','getFlosumComponents','7rkEddq','Failure','defineProperty','flat','map','import','createZip','\x20:\x20','./vpk.service','bind','_tempFolder','toLowerCase','Component_Name__c','log','get','export','successfully','errors','Metadata_Log__c','_salesforceService','Deployment','Cannot\x20Backup\x20more\x20than\x20200\x20components.','updateLog','createBackup','FlosumConstants','finishDeployWithError','deploymentName','_organisationName','Retrieving\x20attachments','ZipCreatorDeploy','packageComponentList','Save\x20Deployment\x20Results','Date__c','Component_History__c','_packageExportService','FlosumComponentVeevaComponentRetriever','stepName','Create\x20vpk\x20package','Org__c','veeva-deploy','_connectionSalesforce','Succeed__c','4Ioelqb','./package-export.service','_packageImportService','_vpkService','catch','saveLog','Cannot\x20retrieve\x20all\x20components.','length','../../../constants','<a\x20href=','\x20>\x20','2785pRiFWD','Activity_Item__c','fetchAttachmentsDetailsByParentId','text/plain','_deploymentName','__esModule','default','.zip','11eeuhyO','_componentIdList','COMPLETED','67312heVPJJ','search','toString','\x20of\x20branch\x20to\x20Organization\x20','_metadataLogId','componentIdList','Activity_Type__c','117QGlioP'];a358_0x1443=function(){return _0x49e550;};return a358_0x1443();}'use strict';var __importDefault=this&&this[a358_0x3b3041(0x16b)]||function(_0x16b3c9){const _0x3e9ee1=a358_0x3b3041;return _0x16b3c9&&_0x16b3c9[_0x3e9ee1(0x15c)]?_0x16b3c9:{'default':_0x16b3c9};};Object[a358_0x3b3041(0x124)](exports,'__esModule',{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a358_0x3b3041(0x181))),promises_1=require(a358_0x3b3041(0xf3)),constants_1=require(a358_0x3b3041(0x154)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a358_0x3b3041(0x17c)),core_1=require(a358_0x3b3041(0x17f)),status_enums_1=require(a358_0x3b3041(0xec)),salesforce_dml_error_1=require(a358_0x3b3041(0x101)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a358_0x3b3041(0x172)),branch_component_history_flosum_component_retriever_1=require(a358_0x3b3041(0x116)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a358_0x3b3041(0x14d)),vpk_service_1=require(a358_0x3b3041(0x12a)),zip_creator_deploy_1=require(a358_0x3b3041(0x107));function a358_0x3221(_0x2d07ef,_0x5cb2fc){const _0x31ab78=a358_0x1443();return a358_0x3221=function(_0x4291b4,_0x9bb895){_0x4291b4=_0x4291b4-0xeb;let _0x1443ad=_0x31ab78[_0x4291b4];return _0x1443ad;},a358_0x3221(_0x2d07ef,_0x5cb2fc);}class DeployService{constructor(_0x11adcb,_0xd2dff4,_0x4c6c2a,_0x20736c,_0x8f7754,_0x2a1df2){const _0x34b4b1=a358_0x3b3041;this['_connectionSalesforce']=_0xd2dff4,this[_0x34b4b1(0x187)]=_0x4c6c2a,this[_0x34b4b1(0x183)]=_0x20736c,this[_0x34b4b1(0x12c)]=_0x8f7754,this[_0x34b4b1(0x11b)]=_0x2a1df2,this['_branchId']=_0x11adcb[_0x34b4b1(0x16c)],this[_0x34b4b1(0x166)]=_0x11adcb['metadataLogId'],this[_0x34b4b1(0xf9)]=_0x11adcb['attachmentLogId'],this[_0x34b4b1(0x16a)]=_0x11adcb['organisationId'],this[_0x34b4b1(0x102)]=_0x11adcb['timeZone'],this[_0x34b4b1(0x13d)]=_0x11adcb[_0x34b4b1(0xfa)],this[_0x34b4b1(0x160)]=_0x11adcb[_0x34b4b1(0x167)],this[_0x34b4b1(0x15b)]=_0x11adcb[_0x34b4b1(0x13c)],this[_0x34b4b1(0x109)]=new core_1['Logger'](_0x34b4b1(0x149)),this[_0x34b4b1(0x184)]=new veeva_service_1['VeevaService']({'connection':this[_0x34b4b1(0x187)],'logger':this[_0x34b4b1(0x183)]}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':this[_0x34b4b1(0x14a)]}),this['_packageImportService']=new package_import_service_1[(_0x34b4b1(0xf2))]({'veevaService':this[_0x34b4b1(0x184)],'connection':this[_0x34b4b1(0x187)],'logger':this[_0x34b4b1(0x183)],'saveLog':this[_0x34b4b1(0x151)][_0x34b4b1(0x12b)](this)}),this[_0x34b4b1(0x144)]=new package_export_service_1[(_0x34b4b1(0x179))]({'veevaService':this['_veevaService'],'connection':this['_connectionVeeva'],'logger':this['_logger']}),this[_0x34b4b1(0x14f)]=new vpk_service_1['VpkService']({'connection':this[_0x34b4b1(0x187)]});}async['execute'](){const _0x53c596=a358_0x3b3041;try{const _0x180d8c=await this[_0x53c596(0x121)]();await this['_logger']['updateLog']();const _0x724514=await this[_0x53c596(0x139)](_0x180d8c);await this[_0x53c596(0x170)](_0x724514);const _0x5f2df3=await this[_0x53c596(0x175)](_0x180d8c),_0x2bd02e=await this['createZip'](_0x5f2df3),_0xd373ab=await this['createVpk'](_0x2bd02e);await this[_0x53c596(0x183)][_0x53c596(0x138)]();const _0xbc80fd=await this[_0x53c596(0x14e)][_0x53c596(0x127)](_0xd373ab);await this[_0x53c596(0x183)][_0x53c596(0x138)]();const _0x4d78e3=this[_0x53c596(0x176)](_0x180d8c,_0xbc80fd[_0x53c596(0x140)]);await this[_0x53c596(0xf6)](_0x4d78e3),await this[_0x53c596(0x112)](_0xbc80fd[_0x53c596(0x100)],![],_0xbc80fd['packageId']);}catch(_0x40cc34){await this[_0x53c596(0x13b)](_0x40cc34)[_0x53c596(0x150)](_0x15b5d8=>this[_0x53c596(0x109)][_0x53c596(0x186)](_0x15b5d8));}}async[a358_0x3b3041(0x121)](){const _0x1b5786=a358_0x3b3041,_0x186d13=new Set(this[_0x1b5786(0x160)]);this[_0x1b5786(0x183)][_0x1b5786(0x12f)]('Retrieving\x20components');const _0x30d4ac=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x1b5786(0x189)],'salesforceService':this[_0x1b5786(0x135)]})[_0x1b5786(0x16d)](),_0x3763cf=_0x30d4ac[_0x1b5786(0xfd)](_0x3e30be=>_0x186d13[_0x1b5786(0xff)](_0x3e30be['id']));if(_0x3763cf['length']!==this[_0x1b5786(0x160)]['length'])throw new Error(_0x1b5786(0x152));return _0x3763cf;}async['createBackup'](_0x3b640d){const _0x58010f=a358_0x3b3041;var _0x137009;this[_0x58010f(0x183)][_0x58010f(0x12f)](_0x58010f(0xfc));const _0x419de3=await new flosum_component_veeva_component_retriever_1[(_0x58010f(0x145))]({'value':_0x3b640d,'veevaService':this[_0x58010f(0x184)],'logger':this['_logger']})[_0x58010f(0x16d)](),_0x4e676d=await this[_0x58010f(0x144)][_0x58010f(0x131)](_0x419de3,'Backup');if(_0x4e676d[_0x58010f(0x153)]>0x1)throw new Error(_0x58010f(0x137));return(_0x137009=_0x4e676d[0x0])!==null&&_0x137009!==void 0x0?_0x137009:_0x4e676d[0x0]=new jszip_1[(_0x58010f(0x15d))](),_0x4e676d[0x0][_0x58010f(0xf0)]({'type':_0x58010f(0x115)});}async[a358_0x3b3041(0x170)](_0x1bbfff){const _0x16d0ce=a358_0x3b3041;this['_logger']['log'](_0x16d0ce(0xf1));const _0x3d8cd5={'Body':_0x1bbfff,'ContentType':'application/zip','ParentId':this[_0x16d0ce(0x166)],'Name':flosum_constants_1['FlosumConstants']['BACKUP_ZIP_NAME']};await this[_0x16d0ce(0x14a)][_0x16d0ce(0x10f)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x3d8cd5);}async[a358_0x3b3041(0x175)](_0x627581){const _0x55c9e0=a358_0x3b3041;this[_0x55c9e0(0x183)]['log'](_0x55c9e0(0x13e));const _0x2796f3=await(0x0,fetch_attachments_1[_0x55c9e0(0x159)])(this[_0x55c9e0(0x14a)],_0x627581[_0x55c9e0(0x126)](_0xf4384f=>_0xf4384f[_0x55c9e0(0x106)])),_0x3c855f=await(0x0,fetch_attachments_1[_0x55c9e0(0x175)])(_0x2796f3,this['_connectionSalesforce']);if(_0x3c855f[_0x55c9e0(0x153)]!==this[_0x55c9e0(0x160)]['length'])throw new Error(_0x55c9e0(0x11d));return _0x3c855f[_0x55c9e0(0x126)](_0x4aec2a=>_0x4aec2a['values'][_0x55c9e0(0x180)]);}async[a358_0x3b3041(0x128)](_0x2fb0f1){const _0x2192ab=a358_0x3b3041;this[_0x2192ab(0x183)][_0x2192ab(0x12f)](_0x2192ab(0x10e));const _0x26798e=await new zip_creator_deploy_1[(_0x2192ab(0x13f))]({'attachmentBodies':_0x2fb0f1,'deploymentName':this['_deploymentName']})['execute'](),_0x86c17b=this[_0x2192ab(0x12c)]+'/'+(0x0,shortid_1['default'])()+_0x2192ab(0x15e);return await(0x0,promises_1[_0x2192ab(0x111)])(_0x86c17b,_0x26798e),_0x86c17b;}async['createVpk'](_0x128eb3){const _0x71a969=a358_0x3b3041;this['_logger'][_0x71a969(0x12f)](_0x71a969(0x147));const _0x399e58=await this[_0x71a969(0x14f)][_0x71a969(0x113)](_0x128eb3),_0x39f7c8=this[_0x71a969(0x12c)]+_0x71a969(0x110)+_0x128eb3[_0x71a969(0xf4)](_0x128eb3[_0x71a969(0x171)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x39f7c8,_0x399e58),await this[_0x71a969(0x14f)][_0x71a969(0x10c)](_0x39f7c8),_0x39f7c8;}async[a358_0x3b3041(0x151)](_0x42e786,_0x2c3a0d){const _0x4c5014=a358_0x3b3041;this[_0x4c5014(0x183)][_0x4c5014(0x12f)](_0x4c5014(0xee));const _0x4e6242={'Body':Buffer['from'](_0x42e786)[_0x4c5014(0x164)](_0x4c5014(0x115)),'ContentType':_0x4c5014(0x15a),'ParentId':this[_0x4c5014(0x166)],'Name':_0x2c3a0d};await this['_connectionSalesforce'][_0x4c5014(0x10f)](flosum_constants_1[_0x4c5014(0x13a)][_0x4c5014(0xed)]+'/Attachment',_0x4e6242);}['formFlosumDeploymentResults'](_0x59c14b,_0x4a3b39){const _0xa93a8b=a358_0x3b3041;this[_0xa93a8b(0x183)][_0xa93a8b(0x12f)](_0xa93a8b(0x188));const _0x5ddc0f=_0x59c14b['reduce']((_0x2c4db0,_0x5d32f6)=>_0x2c4db0[_0xa93a8b(0x16e)]((_0x5d32f6[_0xa93a8b(0x118)]+'.'+_0x5d32f6[_0xa93a8b(0x182)])[_0xa93a8b(0x12d)](),_0x5d32f6),new Map());return _0x4a3b39[_0xa93a8b(0x126)](_0x2bb1ce=>{const _0x17238d=_0xa93a8b;this[_0x17238d(0x183)][_0x17238d(0x12f)](_0x2bb1ce[_0x17238d(0x11f)]+'.'+_0x2bb1ce[_0x17238d(0x177)]+_0x17238d(0x129)+_0x2bb1ce[_0x17238d(0x114)]);const _0x949639=(_0x2bb1ce['type']+'.'+_0x2bb1ce['name'])[_0x17238d(0x12d)](),_0x13e8cd=_0x5ddc0f[_0x17238d(0x130)](_0x949639);return{[constants_1[_0x17238d(0x105)]+'Type__c']:_0x17238d(0x17e),[constants_1[_0x17238d(0x105)]+'Status__c']:_0x2bb1ce[_0x17238d(0x114)]===status_enums_1[_0x17238d(0x119)][_0x17238d(0x185)]?_0x17238d(0x173):_0x17238d(0x123),[constants_1[_0x17238d(0x105)]+'Result__c']:_0x2bb1ce['deploymentAction'],[constants_1[_0x17238d(0x105)]+_0x17238d(0x12e)]:_0x2bb1ce[_0x17238d(0x177)],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x2bb1ce[_0x17238d(0x11f)],[constants_1[_0x17238d(0x105)]+'Veeva_Step_Name__c']:_0x2bb1ce[_0x17238d(0x146)],[constants_1['FLOSUM_NAMESPACE']+_0x17238d(0x148)]:this[_0x17238d(0x16a)],[constants_1['FLOSUM_NAMESPACE']+_0x17238d(0x134)]:this[_0x17238d(0x166)],[constants_1[_0x17238d(0x105)]+_0x17238d(0x143)]:_0x13e8cd['componentHistoryId']};});}async[a358_0x3b3041(0xf6)](_0x1da918){const _0x4ad3f6=a358_0x3b3041;this[_0x4ad3f6(0x183)][_0x4ad3f6(0x12f)](_0x4ad3f6(0x141));const _0x12751d=await this[_0x4ad3f6(0x135)]['insertMultipleRecords'](constants_1[_0x4ad3f6(0x105)]+_0x4ad3f6(0x117),_0x1da918),_0x3dd0b5=_0x12751d[_0x4ad3f6(0xfd)](_0x3ce2b3=>!_0x3ce2b3[_0x4ad3f6(0xf7)])['map'](_0x4a88e7=>_0x4a88e7[_0x4ad3f6(0x133)])[_0x4ad3f6(0x125)]();if(_0x3dd0b5[_0x4ad3f6(0x153)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x3dd0b5);}async[a358_0x3b3041(0x13b)](_0x285f0d){const _0x96074a=a358_0x3b3041;this[_0x96074a(0x183)][_0x96074a(0x18a)](_0x285f0d),await this[_0x96074a(0x183)][_0x96074a(0x138)](),await this[_0x96074a(0x112)](![],!![],'');}async[a358_0x3b3041(0x112)](_0x2c1e8c,_0x22a498,_0x5c3154){const _0x1bd95a=a358_0x3b3041,_0x552709=_0x1bd95a(0x155)+this['_instanceUrl']+'/'+this[_0x1bd95a(0x166)]+_0x1bd95a(0x156)+_0x1bd95a(0xf5)+'\x20</a>',_0x24d3ea='<a\x20href='+this[_0x1bd95a(0x11b)]+'/'+this['_organisationId']+'\x20>'+this[_0x1bd95a(0x13d)]+'</a>',_0x709189=_0x552709+_0x1bd95a(0x165)+_0x24d3ea+'\x20has\x20been\x20created.',_0x109264={[constants_1[_0x1bd95a(0x105)]+'Action__c']:_0x709189,[constants_1[_0x1bd95a(0x105)]+_0x1bd95a(0x142)]:new Date(),[constants_1[_0x1bd95a(0x105)]+_0x1bd95a(0x174)]:this[_0x1bd95a(0x189)],[constants_1[_0x1bd95a(0x105)]+_0x1bd95a(0x158)]:_0x1bd95a(0x10d),[constants_1[_0x1bd95a(0x105)]+_0x1bd95a(0x168)]:_0x1bd95a(0x136),[constants_1[_0x1bd95a(0x105)]+_0x1bd95a(0xef)]:this[_0x1bd95a(0x16a)]},_0x4b162d={[constants_1[_0x1bd95a(0x105)]+_0x1bd95a(0xfb)]:!_0x2c1e8c,[constants_1['FLOSUM_NAMESPACE']+_0x1bd95a(0x14b)]:_0x2c1e8c,[constants_1[_0x1bd95a(0x105)]+_0x1bd95a(0x10b)]:_0x22a498?status_enums_1['MetadataLogStatus'][_0x1bd95a(0xeb)]:status_enums_1[_0x1bd95a(0x17a)][_0x1bd95a(0x161)],[constants_1['FLOSUM_NAMESPACE']+'Job_Completed__c']:!![],[constants_1[_0x1bd95a(0x105)]+'Async_Request_Id__c']:_0x5c3154};await this[_0x1bd95a(0x14a)][_0x1bd95a(0x104)](flosum_constants_1[_0x1bd95a(0x13a)][_0x1bd95a(0xed)]+'/'+constants_1[_0x1bd95a(0x105)]+'Metadata_Log__c/'+this[_0x1bd95a(0x166)],_0x4b162d),await this['_connectionSalesforce']['post'](flosum_constants_1[_0x1bd95a(0x13a)][_0x1bd95a(0xed)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x1bd95a(0x103),_0x109264),this[_0x1bd95a(0x183)][_0x1bd95a(0x12f)](_0x1bd95a(0x120)+(_0x2c1e8c?_0x1bd95a(0x132):_0x1bd95a(0x10a))+'.'),await this[_0x1bd95a(0x183)][_0x1bd95a(0x138)]();}}exports[a358_0x3b3041(0x11e)]=DeployService;