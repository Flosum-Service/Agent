const a334_0x5899c3=a334_0x2710;(function(_0x5b5d7b,_0x5273f8){const _0x1b7e3e=a334_0x2710,_0xb04f76=_0x5b5d7b();while(!![]){try{const _0x3e58b2=parseInt(_0x1b7e3e(0xab))/0x1+-parseInt(_0x1b7e3e(0xd2))/0x2+-parseInt(_0x1b7e3e(0xc4))/0x3*(-parseInt(_0x1b7e3e(0x11e))/0x4)+parseInt(_0x1b7e3e(0x85))/0x5+parseInt(_0x1b7e3e(0xf9))/0x6*(-parseInt(_0x1b7e3e(0x101))/0x7)+-parseInt(_0x1b7e3e(0xbd))/0x8*(-parseInt(_0x1b7e3e(0xcd))/0x9)+parseInt(_0x1b7e3e(0xee))/0xa*(-parseInt(_0x1b7e3e(0x8f))/0xb);if(_0x3e58b2===_0x5273f8)break;else _0xb04f76['push'](_0xb04f76['shift']());}catch(_0xf20a34){_0xb04f76['push'](_0xb04f76['shift']());}}}(a334_0x4576,0xa718a));const a334_0x3b50b9=(function(){let _0x46139f=!![];return function(_0xe68daf,_0xe438a7){const _0x33741d=_0x46139f?function(){const _0x1021e9=a334_0x2710;if(_0xe438a7){const _0x469a7e=_0xe438a7[_0x1021e9(0xf1)](_0xe68daf,arguments);return _0xe438a7=null,_0x469a7e;}}:function(){};return _0x46139f=![],_0x33741d;};}()),a334_0x3036e1=a334_0x3b50b9(this,function(){const _0x1c5697=a334_0x2710;return a334_0x3036e1[_0x1c5697(0x7d)]()[_0x1c5697(0x86)](_0x1c5697(0x8d))[_0x1c5697(0x7d)]()[_0x1c5697(0x11b)](a334_0x3036e1)[_0x1c5697(0x86)](_0x1c5697(0x8d));});a334_0x3036e1();'use strict';var __importDefault=this&&this[a334_0x5899c3(0xe1)]||function(_0x5efd6d){const _0x7085f=a334_0x5899c3;return _0x5efd6d&&_0x5efd6d[_0x7085f(0xdd)]?_0x5efd6d:{'default':_0x5efd6d};};Object[a334_0x5899c3(0xd4)](exports,a334_0x5899c3(0xdd),{'value':!![]}),exports[a334_0x5899c3(0x95)]=void 0x0;function a334_0x4576(){const _0x429da1=['async','Finish\x20Create\x20Backup','patch','_deploymentName','SalesforceService','</a>','metadataLogId','FlosumComponentVeevaComponentRetriever','error','post','length','537616yojiyZ','DEPLOYED','_packageImportService','Builder','timeZone','xml2js','Type__c','195297nsrlfQ','Create\x20vpk\x20package','saveDeploymentResults','Body','FLOSUM_NAMESPACE','../../../core','Logger','MetadataLogStatus','Flosum','144vMPnjW','componentIdList','Component_History__c','Deployment\x20Result','fs/promises','2409462QooCDS','filter','defineProperty','set','retrieveAttachments','_connectionVeeva','COMPLETED','Save\x20log','https://veevavault.com/','Result__c','null','__esModule','_branchId','writeFile','\x20:\x20','__importDefault','base64','generateAsync','bind','../../shared/utils/fetch-attachments','\x20has\x20been\x20created.','finishDeploy','createVpk','./package-export.service','insertMultipleRecords','./veeva.service','EXCEPTION','/vpk__','128210RFpGnj','Retrieving\x20attachments','\x20of\x20branch\x20to\x20Organization\x20','apply','fetchAttachmentsDetailsByParentId','log','updateLog','values','Join\x20all\x20mdl\x20into\x20one\x20zip','flat','logError','1854PxMMQY','organisationId','organisationName','Job_Completed__c','Metadata_Log__c','toLowerCase','execute','branchId','8673PADepB','packageId','_metadataLogId','formFlosumDeploymentResults','isDeployed','createBackup','\x20>\x20','Cannot\x20retrievers\x20all\x20attachments','_systemLogger','attachmentLogId','export','Metadata_Log__c/','Activity_Type__c','deploymentAction','Status__c','./vpk.service','Component_Name__c','Deploy','PackageComponentStatus','Cannot\x20Backup\x20more\x20than\x20200\x20components.','_componentIdList','successfully','retrieve','_vpkService','saveLog','nodebuffer','constructor','Component_Type__c','joinAllAttachments','64AEGXXG','success','../enums/status.enums','FlosumConstants','../classes/errors/salesforce-dml-error','Activity_Item__c','with\x20error','migration__v','.zip','from','jszip','status','buildObject','Branch__c','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','import','_packageExportService','PackageImportService','toString','Backup','BACKUP_ZIP_NAME','type','getFlosumComponents','errors','name','_connectionSalesforce','5116080vlhNdK','search','./package-import.service','TargetId__c','/Attachment','_salesforceService','reduce','_instanceUrl','(((.+)+)+)+$','deploymentName','1045rpckzj','_tempFolder','BranchComponentHistoryFlosumComponentRetriever','_organisationId','VeevaService','./salesforce.service','DeployService','Veeva\x20Deployment','_logger','Action__c','Veeva_Step_Name__c','componentHistoryId','ENDPOINT_UPSERT_RECORD','\x20</a>','default','componentName','VpkService','Success','Form\x20Deployment\x20Results','Log__c','map','<a\x20href=','validate','Cannot\x20retrieve\x20all\x20components.','_organisationName','_veevaService','text/plain','finishDeployWithError','349971NauZve','file','application/zip','Deployment_Result__c','files','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Is_Error__c'];a334_0x4576=function(){return _0x429da1;};return a334_0x4576();}const jszip_1=__importDefault(require(a334_0x5899c3(0x128))),promises_1=require(a334_0x5899c3(0xd1)),constants_1=require('../../../constants'),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a334_0x5899c3(0xeb)),salesforce_service_1=require(a334_0x5899c3(0x94)),core_1=require(a334_0x5899c3(0xc9)),status_enums_1=require(a334_0x5899c3(0x120)),salesforce_dml_error_1=require(a334_0x5899c3(0x122)),shortid_1=__importDefault(require('shortid')),xml2js_1=require(a334_0x5899c3(0xc2)),fetch_attachments_1=require(a334_0x5899c3(0xe5)),package_import_service_1=require(a334_0x5899c3(0x87)),branch_component_history_flosum_component_retriever_1=require(a334_0x5899c3(0x12c)),flosum_component_veeva_component_retriever_1=require(a334_0x5899c3(0xb0)),package_export_service_1=require(a334_0x5899c3(0xe9)),vpk_service_1=require(a334_0x5899c3(0x110));class DeployService{constructor(_0x46ba5b,_0x2b4206,_0x3579bb,_0x539dde,_0xaaabd2,_0x47e0f9){const _0x1ea023=a334_0x5899c3;this[_0x1ea023(0x84)]=_0x2b4206,this['_connectionVeeva']=_0x3579bb,this[_0x1ea023(0x97)]=_0x539dde,this[_0x1ea023(0x90)]=_0xaaabd2,this['_instanceUrl']=_0x47e0f9,this['_branchId']=_0x46ba5b[_0x1ea023(0x100)],this['_metadataLogId']=_0x46ba5b[_0x1ea023(0xb8)],this['_attachmentLogId']=_0x46ba5b[_0x1ea023(0x10a)],this[_0x1ea023(0x92)]=_0x46ba5b[_0x1ea023(0xfa)],this['_timeZone']=_0x46ba5b[_0x1ea023(0xc1)],this['_organisationName']=_0x46ba5b[_0x1ea023(0xfb)],this['_componentIdList']=_0x46ba5b[_0x1ea023(0xce)],this[_0x1ea023(0xb5)]=_0x46ba5b[_0x1ea023(0x8e)],this[_0x1ea023(0x109)]=new core_1[(_0x1ea023(0xca))]('veeva-deploy'),this[_0x1ea023(0xa8)]=new veeva_service_1[(_0x1ea023(0x93))]({'connection':this[_0x1ea023(0xd7)],'logger':this['_logger']}),this['_salesforceService']=new salesforce_service_1[(_0x1ea023(0xb6))]({'connection':this['_connectionSalesforce']}),this[_0x1ea023(0xbf)]=new package_import_service_1[(_0x1ea023(0x7c))]({'veevaService':this[_0x1ea023(0xa8)],'connection':this['_connectionVeeva'],'logger':this[_0x1ea023(0x97)],'saveLog':this[_0x1ea023(0x119)][_0x1ea023(0xe4)](this)}),this[_0x1ea023(0x7b)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x1ea023(0xa8)],'connection':this[_0x1ea023(0xd7)],'logger':this['_logger']}),this[_0x1ea023(0x118)]=new vpk_service_1[(_0x1ea023(0x9f))]({'connection':this[_0x1ea023(0xd7)]});}async[a334_0x5899c3(0xff)](){const _0x55c25c=a334_0x5899c3;try{const _0x473a49=await this[_0x55c25c(0x81)]();await this[_0x55c25c(0x97)][_0x55c25c(0xf4)](),await this[_0x55c25c(0x106)](_0x473a49);const _0x105655=await this[_0x55c25c(0xd6)](_0x473a49),_0x3e2a5f=await this[_0x55c25c(0x11d)](_0x105655),_0xe0aeae=await this[_0x55c25c(0xe8)](_0x3e2a5f);await this[_0x55c25c(0x97)][_0x55c25c(0xf4)]();const _0x4feb42=await this[_0x55c25c(0xbf)][_0x55c25c(0x7a)](_0xe0aeae);await this[_0x55c25c(0x97)][_0x55c25c(0xf4)]();const _0x270139=this[_0x55c25c(0x104)](_0x473a49,_0x4feb42['packageComponentList']);await this[_0x55c25c(0xc6)](_0x270139),await this[_0x55c25c(0xe7)](_0x4feb42[_0x55c25c(0x105)],![],_0x4feb42[_0x55c25c(0x102)]);}catch(_0x268802){await this[_0x55c25c(0xaa)](_0x268802)['catch'](_0x3c7373=>this['_systemLogger'][_0x55c25c(0xba)](_0x3c7373));}}async[a334_0x5899c3(0x81)](){const _0x2d523a=a334_0x5899c3,_0x4b3992=new Set(this[_0x2d523a(0x115)]);this['_logger']['log']('Retrieving\x20components');const _0x2fd8f1=await new branch_component_history_flosum_component_retriever_1[(_0x2d523a(0x91))]({'value':this[_0x2d523a(0xde)],'salesforceService':this[_0x2d523a(0x8a)]})[_0x2d523a(0x117)](),_0x18dcd5=_0x2fd8f1[_0x2d523a(0xd3)](_0x2731ca=>_0x4b3992['has'](_0x2731ca['id']));if(_0x18dcd5['length']!==this[_0x2d523a(0x115)][_0x2d523a(0xbc)])throw new Error(_0x2d523a(0xa6));return _0x18dcd5;}async[a334_0x5899c3(0x106)](_0x400d5a){const _0xf81cef=a334_0x5899c3;var _0x400f12;this[_0xf81cef(0x97)][_0xf81cef(0xf3)]('Create\x20Backup');const _0x2afe81=await new flosum_component_veeva_component_retriever_1[(_0xf81cef(0xb9))]({'value':_0x400d5a,'veevaService':this['_veevaService'],'logger':this[_0xf81cef(0x97)]})['retrieve'](),_0x54afef=await this[_0xf81cef(0x7b)][_0xf81cef(0x10b)](_0x2afe81,_0xf81cef(0x7e));if(_0x54afef[_0xf81cef(0xbc)]>0x1)throw new Error(_0xf81cef(0x114));(_0x400f12=_0x54afef[0x0])!==null&&_0x400f12!==void 0x0?_0x400f12:_0x54afef[0x0]=new jszip_1[(_0xf81cef(0x9d))]();const _0x46652f=await _0x54afef[0x0][_0xf81cef(0xe3)]({'type':_0xf81cef(0xe2)});this[_0xf81cef(0x97)]['log']('Save\x20Backup\x20to\x20Salesforce');const _0x64fc6e={'Body':_0x46652f,'ContentType':_0xf81cef(0xad),'ParentId':this[_0xf81cef(0x103)],'Name':flosum_constants_1[_0xf81cef(0x121)][_0xf81cef(0x7f)]};await this[_0xf81cef(0x84)][_0xf81cef(0xbb)](flosum_constants_1[_0xf81cef(0x121)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x64fc6e),this[_0xf81cef(0x97)]['log'](_0xf81cef(0xb3));}async[a334_0x5899c3(0xd6)](_0x44803d){const _0x267caf=a334_0x5899c3;this[_0x267caf(0x97)][_0x267caf(0xf3)](_0x267caf(0xef));const _0x2076c8=await(0x0,fetch_attachments_1[_0x267caf(0xf2)])(this['_connectionSalesforce'],_0x44803d[_0x267caf(0xa3)](_0x516de2=>_0x516de2[_0x267caf(0x9a)])),_0x2d15be=await(0x0,fetch_attachments_1[_0x267caf(0xd6)])(_0x2076c8,this[_0x267caf(0x84)]);if(_0x2d15be[_0x267caf(0xbc)]!==this[_0x267caf(0x115)]['length'])throw new Error(_0x267caf(0x108));return _0x2d15be['map'](_0x58f432=>_0x58f432[_0x267caf(0xf5)][_0x267caf(0xc7)]);}async[a334_0x5899c3(0x11d)](_0x2cd832){const _0x33e88a=a334_0x5899c3;var _0x3182a2;this[_0x33e88a(0x97)][_0x33e88a(0xf3)](_0x33e88a(0xf6));const _0x5ed4bc=new jszip_1['default']();for(const _0x5de96f of _0x2cd832){const _0x2daedf=new jszip_1[(_0x33e88a(0x9d))]();await _0x2daedf['loadAsync'](_0x5de96f,{'base64':!![]});for(const _0x126769 in _0x2daedf[_0x33e88a(0xaf)]){const _0x4ed57a=await((_0x3182a2=_0x2daedf[_0x33e88a(0xac)](_0x126769))===null||_0x3182a2===void 0x0?void 0x0:_0x3182a2[_0x33e88a(0xb2)]('string'));_0x4ed57a&&_0x5ed4bc[_0x33e88a(0xac)](_0x126769,_0x4ed57a);}}const _0x2b7d0a=new xml2js_1[(_0x33e88a(0xc0))]({'headless':!![]}),_0x1430dc={'vaultpackage':{'$':{'xmlns':_0x33e88a(0xda)},'name':this[_0x33e88a(0xb5)],'source':{'vault':undefined,'author':_0x33e88a(0xcc)},'packagetype':_0x33e88a(0x125),'summary':_0x33e88a(0x112),'description':_0x33e88a(0xdc)}};_0x5ed4bc[_0x33e88a(0xac)]('vaultpackage.xml',_0x2b7d0a[_0x33e88a(0x12a)](_0x1430dc));const _0xea237c=this[_0x33e88a(0x90)]+'/'+(0x0,shortid_1[_0x33e88a(0x9d)])()+_0x33e88a(0x126),_0x5ebc33=await _0x5ed4bc[_0x33e88a(0xe3)]({'type':_0x33e88a(0x11a)});return await(0x0,promises_1[_0x33e88a(0xdf)])(_0xea237c,_0x5ebc33),_0xea237c;}async[a334_0x5899c3(0xe8)](_0x2e9fd1){const _0x1dd96c=a334_0x5899c3;this['_logger']['log'](_0x1dd96c(0xc5));const _0xc4763=await this[_0x1dd96c(0x118)]['generate'](_0x2e9fd1),_0x213ffc=this[_0x1dd96c(0x90)]+_0x1dd96c(0xed)+_0x2e9fd1['slice'](_0x2e9fd1['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x1dd96c(0xdf)])(_0x213ffc,_0xc4763),await this[_0x1dd96c(0x118)][_0x1dd96c(0xa5)](_0x213ffc),_0x213ffc;}async['saveLog'](_0x55e5c7,_0x5a4530){const _0x1ad9d0=a334_0x5899c3;this[_0x1ad9d0(0x97)][_0x1ad9d0(0xf3)](_0x1ad9d0(0xd9));const _0x10c79f={'Body':Buffer[_0x1ad9d0(0x127)](_0x55e5c7)['toString']('base64'),'ContentType':_0x1ad9d0(0xa9),'ParentId':this[_0x1ad9d0(0x103)],'Name':_0x5a4530};await this['_connectionSalesforce'][_0x1ad9d0(0xbb)](flosum_constants_1[_0x1ad9d0(0x121)][_0x1ad9d0(0x9b)]+_0x1ad9d0(0x89),_0x10c79f);}[a334_0x5899c3(0x104)](_0x5a6276,_0x373d98){const _0x4b1d53=a334_0x5899c3;this[_0x4b1d53(0x97)][_0x4b1d53(0xf3)](_0x4b1d53(0xa1));const _0x10de1f=_0x5a6276[_0x4b1d53(0x8b)]((_0xbdfcc2,_0x541695)=>_0xbdfcc2[_0x4b1d53(0xd5)]((_0x541695['componentType']+'.'+_0x541695[_0x4b1d53(0x9e)])[_0x4b1d53(0xfe)](),_0x541695),new Map());return _0x373d98[_0x4b1d53(0xa3)](_0x55c5b9=>{const _0x43ad10=_0x4b1d53;this[_0x43ad10(0x97)]['log'](_0x55c5b9['type']+'.'+_0x55c5b9[_0x43ad10(0x83)]+_0x43ad10(0xe0)+_0x55c5b9[_0x43ad10(0x129)]);const _0x3b0606=(_0x55c5b9[_0x43ad10(0x80)]+'.'+_0x55c5b9['name'])[_0x43ad10(0xfe)](),_0x53bde0=_0x10de1f['get'](_0x3b0606);return{[constants_1['FLOSUM_NAMESPACE']+_0x43ad10(0xc3)]:_0x43ad10(0xd0),[constants_1[_0x43ad10(0xc8)]+_0x43ad10(0x10f)]:_0x55c5b9[_0x43ad10(0x129)]===status_enums_1[_0x43ad10(0x113)][_0x43ad10(0xbe)]?_0x43ad10(0xa0):'Failure',[constants_1['FLOSUM_NAMESPACE']+_0x43ad10(0xdb)]:_0x55c5b9[_0x43ad10(0x10e)],[constants_1[_0x43ad10(0xc8)]+_0x43ad10(0x111)]:_0x55c5b9['name'],[constants_1[_0x43ad10(0xc8)]+_0x43ad10(0x11c)]:_0x55c5b9[_0x43ad10(0x80)],[constants_1[_0x43ad10(0xc8)]+_0x43ad10(0x99)]:_0x55c5b9['stepName'],[constants_1[_0x43ad10(0xc8)]+'Org__c']:this['_organisationId'],[constants_1[_0x43ad10(0xc8)]+_0x43ad10(0xfd)]:this['_metadataLogId'],[constants_1[_0x43ad10(0xc8)]+_0x43ad10(0xcf)]:_0x53bde0['componentHistoryId']};});}async[a334_0x5899c3(0xc6)](_0x946949){const _0x4f47ff=a334_0x5899c3;this[_0x4f47ff(0x97)][_0x4f47ff(0xf3)]('Save\x20Deployment\x20Results');const _0x286890=await this[_0x4f47ff(0x8a)][_0x4f47ff(0xea)](constants_1['FLOSUM_NAMESPACE']+_0x4f47ff(0xae),_0x946949),_0x4b5387=_0x286890[_0x4f47ff(0xd3)](_0x20185b=>!_0x20185b[_0x4f47ff(0x11f)])[_0x4f47ff(0xa3)](_0x8a87ab=>_0x8a87ab[_0x4f47ff(0x82)])[_0x4f47ff(0xf7)]();if(_0x4b5387[_0x4f47ff(0xbc)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x4b5387);}async[a334_0x5899c3(0xaa)](_0x235e94){const _0x41c851=a334_0x5899c3;this[_0x41c851(0x97)][_0x41c851(0xf8)](_0x235e94),await this[_0x41c851(0x97)][_0x41c851(0xf4)](),await this[_0x41c851(0xe7)](![],!![],'');}async[a334_0x5899c3(0xe7)](_0x7ee138,_0x3c3eb0,_0x2c2de1){const _0x6ce00c=a334_0x5899c3,_0x1bafa1=_0x6ce00c(0xa4)+this[_0x6ce00c(0x8c)]+'/'+this[_0x6ce00c(0x103)]+_0x6ce00c(0x107)+_0x6ce00c(0x96)+_0x6ce00c(0x9c),_0x3ac85f=_0x6ce00c(0xa4)+this[_0x6ce00c(0x8c)]+'/'+this[_0x6ce00c(0x92)]+'\x20>'+this[_0x6ce00c(0xa7)]+_0x6ce00c(0xb7),_0x278996=_0x1bafa1+_0x6ce00c(0xf0)+_0x3ac85f+_0x6ce00c(0xe6),_0x374c30={[constants_1['FLOSUM_NAMESPACE']+_0x6ce00c(0x98)]:_0x278996,[constants_1[_0x6ce00c(0xc8)]+'Date__c']:new Date(),[constants_1[_0x6ce00c(0xc8)]+_0x6ce00c(0x12b)]:this[_0x6ce00c(0xde)],[constants_1[_0x6ce00c(0xc8)]+_0x6ce00c(0x123)]:'Branch',[constants_1[_0x6ce00c(0xc8)]+_0x6ce00c(0x10d)]:'Deployment',[constants_1['FLOSUM_NAMESPACE']+_0x6ce00c(0x88)]:this[_0x6ce00c(0x92)]},_0x3b9a78={[constants_1[_0x6ce00c(0xc8)]+_0x6ce00c(0xb1)]:!_0x7ee138,[constants_1[_0x6ce00c(0xc8)]+'Succeed__c']:_0x7ee138,[constants_1[_0x6ce00c(0xc8)]+'Status__c']:_0x3c3eb0?status_enums_1[_0x6ce00c(0xcb)][_0x6ce00c(0xec)]:status_enums_1['MetadataLogStatus'][_0x6ce00c(0xd8)],[constants_1[_0x6ce00c(0xc8)]+_0x6ce00c(0xfc)]:!![],[constants_1[_0x6ce00c(0xc8)]+'Async_Request_Id__c']:_0x2c2de1};await this[_0x6ce00c(0x84)][_0x6ce00c(0xb4)](flosum_constants_1['FlosumConstants'][_0x6ce00c(0x9b)]+'/'+constants_1[_0x6ce00c(0xc8)]+_0x6ce00c(0x10c)+this[_0x6ce00c(0x103)],_0x3b9a78),await this[_0x6ce00c(0x84)][_0x6ce00c(0xbb)](flosum_constants_1[_0x6ce00c(0x121)][_0x6ce00c(0x9b)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x6ce00c(0xa2),_0x374c30),this[_0x6ce00c(0x97)]['log']('Deploy\x20completed\x20'+(_0x7ee138?_0x6ce00c(0x116):_0x6ce00c(0x124))+'.'),await this[_0x6ce00c(0x97)]['updateLog']();}}function a334_0x2710(_0x1560fc,_0x39b3b8){const _0x5ea51c=a334_0x4576();return a334_0x2710=function(_0x3036e1,_0x3b50b9){_0x3036e1=_0x3036e1-0x7a;let _0x4576a0=_0x5ea51c[_0x3036e1];return _0x4576a0;},a334_0x2710(_0x1560fc,_0x39b3b8);}exports[a334_0x5899c3(0x95)]=DeployService;