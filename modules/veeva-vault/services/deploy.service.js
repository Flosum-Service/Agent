const a402_0x106047=a402_0x123c;function a402_0x123c(_0x456be0,_0x387719){const _0x57cda4=a402_0x1cfb();return a402_0x123c=function(_0x4b18e6,_0x55c432){_0x4b18e6=_0x4b18e6-0xbe;let _0x1cfb39=_0x57cda4[_0x4b18e6];return _0x1cfb39;},a402_0x123c(_0x456be0,_0x387719);}(function(_0x2708e0,_0x37d697){const _0x443833=a402_0x123c,_0x3c1899=_0x2708e0();while(!![]){try{const _0x142947=parseInt(_0x443833(0x159))/0x1*(parseInt(_0x443833(0x107))/0x2)+parseInt(_0x443833(0xc9))/0x3+-parseInt(_0x443833(0xbe))/0x4*(-parseInt(_0x443833(0xce))/0x5)+parseInt(_0x443833(0x147))/0x6*(parseInt(_0x443833(0xe2))/0x7)+-parseInt(_0x443833(0xe3))/0x8*(parseInt(_0x443833(0xed))/0x9)+parseInt(_0x443833(0xe6))/0xa+parseInt(_0x443833(0xf4))/0xb*(-parseInt(_0x443833(0x134))/0xc);if(_0x142947===_0x37d697)break;else _0x3c1899['push'](_0x3c1899['shift']());}catch(_0x43304e){_0x3c1899['push'](_0x3c1899['shift']());}}}(a402_0x1cfb,0x63319));const a402_0x55c432=(function(){let _0x4638fd=!![];return function(_0xc11a2e,_0x918625){const _0x2d45ab=_0x4638fd?function(){const _0x3a2771=a402_0x123c;if(_0x918625){const _0x336181=_0x918625[_0x3a2771(0xd2)](_0xc11a2e,arguments);return _0x918625=null,_0x336181;}}:function(){};return _0x4638fd=![],_0x2d45ab;};}()),a402_0x4b18e6=a402_0x55c432(this,function(){const _0x39663a=a402_0x123c;return a402_0x4b18e6[_0x39663a(0x11c)]()[_0x39663a(0x146)](_0x39663a(0x126))[_0x39663a(0x11c)]()[_0x39663a(0x12b)](a402_0x4b18e6)[_0x39663a(0x146)]('(((.+)+)+)+$');});a402_0x4b18e6();function a402_0x1cfb(){const _0x165a2f=['Activity_Type__c','successfully','values','BACKUP_ZIP_NAME','Deployment_Result__c','Component_Type__c','Date__c','saveBackup','\x20has\x20been\x20created.','62Koktkz','componentIdList','_packageImportService','Success','./vpk.service','Org__c','DeployService','from','45992sZKEwb','SalesforceDmlError','fs/promises','Body','saveDeploymentResults','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Deployment','componentHistoryId','reduce','length','Backup','705378bYWItS','retrieve','Result__c','isDeployed','componentName','235aXsrDv','logError','__esModule','finishDeployWithError','apply','\x20of\x20branch\x20to\x20Organization\x20','map','log','MetadataLogStatus','catch','./veeva.service','base64','</a>','FlosumConstants','_organisationId','post','Deployment\x20Result','jszip','status','_salesforceService','42JtRjOl','152joeoei','slice','External_Deployment_Id__c','7563620mzgOen','lastIndexOf','fetchAttachmentsDetailsByParentId','createZip','errors','generateAsync','PackageImportService','253053pjZSkC','default','has','__importDefault','createVpk','filter','Job_Completed__c','310673mjqofK','FLOSUM_NAMESPACE','saveLog','ENDPOINT_UPSERT_RECORD','name','insertMultipleRecords','\x20</a>','execute','../classes/deploy/zip-creator.deploy','Metadata_Log__c/','Log__c','timeZone','_connectionSalesforce','Is_Error__c','import','get','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','DEPLOYED','shortid','18940alUTuY','application/zip','Save\x20Deployment\x20Results','EXCEPTION','validate','veeva-deploy','Status__c','COMPLETED','Cannot\x20retrieve\x20all\x20components.','/Attachment','updateLog','deploymentName','flat','metadataLogId','export','./salesforce.service','set','createBackup','_componentIdList','attachmentLogId','deploymentAction','toString','_metadataLogId','organisationName','retrieveAttachments','toLowerCase','_connectionVeeva','_veevaService','success','packageComponentList','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','(((.+)+)+)+$','Retrieving\x20attachments','./package-import.service','Deploy\x20completed\x20','\x20:\x20','constructor','with\x20error','../classes/errors/salesforce-dml-error','_branchId','Veeva\x20Deployment','branchId','text/plain','VeevaService','error','720mQnbvy','_logger','Type__c','getFlosumComponents','finishDeploy','Save\x20Backup\x20to\x20Salesforce','_instanceUrl','_systemLogger','writeFile','PackageComponentStatus','../../../constants','Metadata_Log__c','<a\x20href=','_deploymentName','type','SalesforceService','packageId','_tempFolder','search','516066oeerfx','_packageExportService','defineProperty','_vpkService','Succeed__c','Branch__c','_organisationName','TargetId__c','generate'];a402_0x1cfb=function(){return _0x165a2f;};return a402_0x1cfb();}'use strict';var __importDefault=this&&this[a402_0x106047(0xf0)]||function(_0x4dfe8b){return _0x4dfe8b&&_0x4dfe8b['__esModule']?_0x4dfe8b:{'default':_0x4dfe8b};};Object[a402_0x106047(0x149)](exports,a402_0x106047(0xd0),{'value':!![]}),exports[a402_0x106047(0x15f)]=void 0x0;const jszip_1=__importDefault(require(a402_0x106047(0xdf))),promises_1=require(a402_0x106047(0xc0)),constants_1=require(a402_0x106047(0x13e)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a402_0x106047(0xd8)),salesforce_service_1=require(a402_0x106047(0x116)),core_1=require('../../../core'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a402_0x106047(0x12d)),shortid_1=__importDefault(require(a402_0x106047(0x106))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a402_0x106047(0x128)),branch_component_history_flosum_component_retriever_1=require(a402_0x106047(0x104)),flosum_component_veeva_component_retriever_1=require(a402_0x106047(0x125)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a402_0x106047(0x15d)),zip_creator_deploy_1=require(a402_0x106047(0xfc));class DeployService{constructor(_0x396f94,_0x12ce50,_0xaf6a,_0x61bd55,_0x3fa1c4,_0x3d43f8){const _0x1feced=a402_0x106047;this[_0x1feced(0x100)]=_0x12ce50,this[_0x1feced(0x121)]=_0xaf6a,this[_0x1feced(0x135)]=_0x61bd55,this[_0x1feced(0x145)]=_0x3fa1c4,this[_0x1feced(0x13a)]=_0x3d43f8,this[_0x1feced(0x12e)]=_0x396f94[_0x1feced(0x130)],this[_0x1feced(0x11d)]=_0x396f94[_0x1feced(0x114)],this['_attachmentLogId']=_0x396f94[_0x1feced(0x11a)],this['_organisationId']=_0x396f94['organisationId'],this['_timeZone']=_0x396f94[_0x1feced(0xff)],this[_0x1feced(0x14d)]=_0x396f94[_0x1feced(0x11e)],this[_0x1feced(0x119)]=_0x396f94[_0x1feced(0x15a)],this[_0x1feced(0x141)]=_0x396f94[_0x1feced(0x112)],this[_0x1feced(0x13b)]=new core_1['Logger'](_0x1feced(0x10c)),this[_0x1feced(0x122)]=new veeva_service_1[(_0x1feced(0x132))]({'connection':this[_0x1feced(0x121)],'logger':this['_logger']}),this[_0x1feced(0xe1)]=new salesforce_service_1[(_0x1feced(0x143))]({'connection':this['_connectionSalesforce']}),this['_packageImportService']=new package_import_service_1[(_0x1feced(0xec))]({'veevaService':this['_veevaService'],'connection':this[_0x1feced(0x121)],'logger':this[_0x1feced(0x135)],'saveLog':this[_0x1feced(0xf6)]['bind'](this)}),this['_packageExportService']=new package_export_service_1['PackageExportService']({'veevaService':this[_0x1feced(0x122)],'connection':this['_connectionVeeva'],'logger':this[_0x1feced(0x135)]}),this[_0x1feced(0x14a)]=new vpk_service_1['VpkService']({'connection':this[_0x1feced(0x121)]});}async['execute'](){const _0x47a16e=a402_0x106047;try{const _0x496ac6=await this[_0x47a16e(0x137)]();await this[_0x47a16e(0x135)]['updateLog']();const _0x3b8c5f=await this[_0x47a16e(0x118)](_0x496ac6);await this[_0x47a16e(0x157)](_0x3b8c5f);const _0x1d111c=await this[_0x47a16e(0x11f)](_0x496ac6),_0x571c37=await this['createZip'](_0x1d111c),_0x36e297=await this[_0x47a16e(0xf1)](_0x571c37);await this[_0x47a16e(0x135)][_0x47a16e(0x111)]();const _0x28c72f=await this[_0x47a16e(0x15b)][_0x47a16e(0x102)](_0x36e297);await this[_0x47a16e(0x135)]['updateLog']();const _0x5b19a2=this['formFlosumDeploymentResults'](_0x496ac6,_0x28c72f[_0x47a16e(0x124)]);await this['saveDeploymentResults'](_0x5b19a2),await this[_0x47a16e(0x138)](_0x28c72f[_0x47a16e(0xcc)],![],_0x28c72f[_0x47a16e(0x144)]);}catch(_0xf76b87){await this[_0x47a16e(0xd1)](_0xf76b87)[_0x47a16e(0xd7)](_0x27e3bd=>this[_0x47a16e(0x13b)][_0x47a16e(0x133)](_0x27e3bd));}}async[a402_0x106047(0x137)](){const _0x312e5a=a402_0x106047,_0xacfd90=new Set(this[_0x312e5a(0x119)]);this[_0x312e5a(0x135)][_0x312e5a(0xd5)]('Retrieving\x20components');const _0x5cfe20=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this['_branchId'],'salesforceService':this[_0x312e5a(0xe1)]})[_0x312e5a(0xca)](),_0x29401d=_0x5cfe20[_0x312e5a(0xf2)](_0xee6e04=>_0xacfd90[_0x312e5a(0xef)](_0xee6e04['id']));if(_0x29401d[_0x312e5a(0xc7)]!==this['_componentIdList'][_0x312e5a(0xc7)])throw new Error(_0x312e5a(0x10f));return _0x29401d;}async['createBackup'](_0x373b2e){const _0xb6c9fc=a402_0x106047;var _0x31f38c;this[_0xb6c9fc(0x135)][_0xb6c9fc(0xd5)]('Create\x20Backup');const _0x52cea3=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x373b2e,'veevaService':this[_0xb6c9fc(0x122)],'logger':this[_0xb6c9fc(0x135)]})[_0xb6c9fc(0xca)](),_0x2df1ce=await this[_0xb6c9fc(0x148)][_0xb6c9fc(0x115)](_0x52cea3,_0xb6c9fc(0xc8));if(_0x2df1ce['length']>0x1)throw new Error(_0xb6c9fc(0xc3));return(_0x31f38c=_0x2df1ce[0x0])!==null&&_0x31f38c!==void 0x0?_0x31f38c:_0x2df1ce[0x0]=new jszip_1[(_0xb6c9fc(0xee))](),_0x2df1ce[0x0][_0xb6c9fc(0xeb)]({'type':_0xb6c9fc(0xd9)});}async['saveBackup'](_0x179d2d){const _0x5b53e7=a402_0x106047;this['_logger']['log'](_0x5b53e7(0x139));const _0x209deb={'Body':_0x179d2d,'ContentType':_0x5b53e7(0x108),'ParentId':this[_0x5b53e7(0x11d)],'Name':flosum_constants_1['FlosumConstants'][_0x5b53e7(0x153)]};await this[_0x5b53e7(0x100)][_0x5b53e7(0xdd)](flosum_constants_1[_0x5b53e7(0xdb)][_0x5b53e7(0xf7)]+_0x5b53e7(0x110),_0x209deb);}async['retrieveAttachments'](_0x567d2d){const _0x1d3d6a=a402_0x106047;this[_0x1d3d6a(0x135)]['log'](_0x1d3d6a(0x127));const _0x465efc=await(0x0,fetch_attachments_1[_0x1d3d6a(0xe8)])(this[_0x1d3d6a(0x100)],_0x567d2d[_0x1d3d6a(0xd4)](_0xd0c9fe=>_0xd0c9fe[_0x1d3d6a(0xc5)])),_0x5be7b4=await(0x0,fetch_attachments_1[_0x1d3d6a(0x11f)])(_0x465efc,this['_connectionSalesforce']);if(_0x5be7b4[_0x1d3d6a(0xc7)]!==this[_0x1d3d6a(0x119)]['length'])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x5be7b4[_0x1d3d6a(0xd4)](_0x21acfa=>_0x21acfa[_0x1d3d6a(0x152)][_0x1d3d6a(0xc1)]);}async[a402_0x106047(0xe9)](_0x3c8d69){const _0x10cdc6=a402_0x106047;this[_0x10cdc6(0x135)][_0x10cdc6(0xd5)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x1cb68c=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x3c8d69,'deploymentName':this[_0x10cdc6(0x141)]})[_0x10cdc6(0xfb)](),_0x1a718a=this['_tempFolder']+'/'+(0x0,shortid_1[_0x10cdc6(0xee)])()+'.zip';return await(0x0,promises_1[_0x10cdc6(0x13c)])(_0x1a718a,_0x1cb68c),_0x1a718a;}async[a402_0x106047(0xf1)](_0x591e24){const _0x5dc271=a402_0x106047;this[_0x5dc271(0x135)][_0x5dc271(0xd5)]('Create\x20vpk\x20package');const _0x33bd96=await this[_0x5dc271(0x14a)][_0x5dc271(0x14f)](_0x591e24),_0x375296=this['_tempFolder']+'/vpk__'+_0x591e24[_0x5dc271(0xe4)](_0x591e24[_0x5dc271(0xe7)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x375296,_0x33bd96),await this[_0x5dc271(0x14a)][_0x5dc271(0x10b)](_0x375296),_0x375296;}async['saveLog'](_0x2b2796,_0x5776c2){const _0x5eae37=a402_0x106047;this[_0x5eae37(0x135)][_0x5eae37(0xd5)]('Save\x20log');const _0x241e62={'Body':Buffer[_0x5eae37(0x160)](_0x2b2796)[_0x5eae37(0x11c)](_0x5eae37(0xd9)),'ContentType':_0x5eae37(0x131),'ParentId':this[_0x5eae37(0x11d)],'Name':_0x5776c2};await this[_0x5eae37(0x100)][_0x5eae37(0xdd)](flosum_constants_1[_0x5eae37(0xdb)][_0x5eae37(0xf7)]+'/Attachment',_0x241e62);}['formFlosumDeploymentResults'](_0x5ca67a,_0x1509ca){const _0x3bb90f=a402_0x106047;this['_logger']['log']('Form\x20Deployment\x20Results');const _0x1ceb99=_0x5ca67a[_0x3bb90f(0xc6)]((_0x35d3f2,_0x24c449)=>_0x35d3f2[_0x3bb90f(0x117)]((_0x24c449['componentType']+'.'+_0x24c449[_0x3bb90f(0xcd)])[_0x3bb90f(0x120)](),_0x24c449),new Map());return _0x1509ca['map'](_0x11d55f=>{const _0xec1577=_0x3bb90f;this[_0xec1577(0x135)][_0xec1577(0xd5)](_0x11d55f[_0xec1577(0x142)]+'.'+_0x11d55f[_0xec1577(0xf8)]+_0xec1577(0x12a)+_0x11d55f['status']);const _0x2b51c8=(_0x11d55f[_0xec1577(0x142)]+'.'+_0x11d55f[_0xec1577(0xf8)])['toLowerCase'](),_0xedbebb=_0x1ceb99[_0xec1577(0x103)](_0x2b51c8);return{[constants_1[_0xec1577(0xf5)]+_0xec1577(0x136)]:_0xec1577(0xde),[constants_1[_0xec1577(0xf5)]+'Status__c']:_0x11d55f[_0xec1577(0xe0)]===status_enums_1[_0xec1577(0x13d)][_0xec1577(0x105)]?_0xec1577(0x15c):'Failure',[constants_1[_0xec1577(0xf5)]+_0xec1577(0xcb)]:_0x11d55f[_0xec1577(0x11b)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x11d55f['name'],[constants_1[_0xec1577(0xf5)]+_0xec1577(0x155)]:_0x11d55f[_0xec1577(0x142)],[constants_1[_0xec1577(0xf5)]+'Veeva_Step_Name__c']:_0x11d55f['stepName'],[constants_1['FLOSUM_NAMESPACE']+_0xec1577(0x15e)]:this[_0xec1577(0xdc)],[constants_1[_0xec1577(0xf5)]+_0xec1577(0x13f)]:this[_0xec1577(0x11d)],[constants_1['FLOSUM_NAMESPACE']+'Component_History__c']:_0xedbebb['componentHistoryId']};});}async[a402_0x106047(0xc2)](_0x235e10){const _0x284276=a402_0x106047;this[_0x284276(0x135)]['log'](_0x284276(0x109));const _0x3c369a=await this[_0x284276(0xe1)][_0x284276(0xf9)](constants_1['FLOSUM_NAMESPACE']+_0x284276(0x154),_0x235e10),_0x4ca449=_0x3c369a[_0x284276(0xf2)](_0x1574c6=>!_0x1574c6[_0x284276(0x123)])[_0x284276(0xd4)](_0x471f37=>_0x471f37[_0x284276(0xea)])[_0x284276(0x113)]();if(_0x4ca449[_0x284276(0xc7)])throw new salesforce_dml_error_1[(_0x284276(0xbf))](_0x4ca449);}async[a402_0x106047(0xd1)](_0x2a43be){const _0x113c47=a402_0x106047;this[_0x113c47(0x135)][_0x113c47(0xcf)](_0x2a43be),await this[_0x113c47(0x135)][_0x113c47(0x111)](),await this['finishDeploy'](![],!![],'');}async[a402_0x106047(0x138)](_0x147e45,_0x432a35,_0x211993){const _0x3b7942=a402_0x106047,_0x293677=_0x3b7942(0x140)+this['_instanceUrl']+'/'+this[_0x3b7942(0x11d)]+'\x20>\x20'+_0x3b7942(0x12f)+_0x3b7942(0xfa),_0x373a69=_0x3b7942(0x140)+this[_0x3b7942(0x13a)]+'/'+this['_organisationId']+'\x20>'+this[_0x3b7942(0x14d)]+_0x3b7942(0xda),_0x25548e=_0x293677+_0x3b7942(0xd3)+_0x373a69+_0x3b7942(0x158),_0xaa9ec2={[constants_1[_0x3b7942(0xf5)]+'Action__c']:_0x25548e,[constants_1[_0x3b7942(0xf5)]+_0x3b7942(0x156)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x3b7942(0x14c)]:this[_0x3b7942(0x12e)],[constants_1[_0x3b7942(0xf5)]+'Activity_Item__c']:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x3b7942(0x150)]:_0x3b7942(0xc4),[constants_1[_0x3b7942(0xf5)]+_0x3b7942(0x14e)]:this[_0x3b7942(0xdc)]},_0x5dcf98={[constants_1[_0x3b7942(0xf5)]+_0x3b7942(0x101)]:!_0x147e45,[constants_1[_0x3b7942(0xf5)]+_0x3b7942(0x14b)]:_0x147e45,[constants_1[_0x3b7942(0xf5)]+_0x3b7942(0x10d)]:_0x432a35?status_enums_1['MetadataLogStatus'][_0x3b7942(0x10a)]:status_enums_1[_0x3b7942(0xd6)][_0x3b7942(0x10e)],[constants_1[_0x3b7942(0xf5)]+_0x3b7942(0xf3)]:!![],[constants_1[_0x3b7942(0xf5)]+_0x3b7942(0xe5)]:_0x211993};await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x3b7942(0xdb)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x3b7942(0xf5)]+_0x3b7942(0xfd)+this[_0x3b7942(0x11d)],_0x5dcf98),await this[_0x3b7942(0x100)][_0x3b7942(0xdd)](flosum_constants_1[_0x3b7942(0xdb)][_0x3b7942(0xf7)]+'/'+constants_1[_0x3b7942(0xf5)]+_0x3b7942(0xfe),_0xaa9ec2),this[_0x3b7942(0x135)][_0x3b7942(0xd5)](_0x3b7942(0x129)+(_0x147e45?_0x3b7942(0x151):_0x3b7942(0x12c))+'.'),await this[_0x3b7942(0x135)][_0x3b7942(0x111)]();}}exports[a402_0x106047(0x15f)]=DeployService;