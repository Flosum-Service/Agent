const a357_0x3c5666=a357_0x50d0;(function(_0x51f16b,_0x47504a){const _0x46c634=a357_0x50d0,_0x4ed8bf=_0x51f16b();while(!![]){try{const _0x38a4f2=parseInt(_0x46c634(0xb3))/0x1+-parseInt(_0x46c634(0xe5))/0x2+parseInt(_0x46c634(0xf4))/0x3+-parseInt(_0x46c634(0x124))/0x4+parseInt(_0x46c634(0x122))/0x5*(-parseInt(_0x46c634(0xa9))/0x6)+parseInt(_0x46c634(0xc3))/0x7*(parseInt(_0x46c634(0xd5))/0x8)+parseInt(_0x46c634(0x119))/0x9;if(_0x38a4f2===_0x47504a)break;else _0x4ed8bf['push'](_0x4ed8bf['shift']());}catch(_0x4cc13b){_0x4ed8bf['push'](_0x4ed8bf['shift']());}}}(a357_0x3882,0x92f73));const a357_0x920532=(function(){let _0x2fd33b=!![];return function(_0x557af3,_0x141b07){const _0x3c601e=_0x2fd33b?function(){if(_0x141b07){const _0xeb8edb=_0x141b07['apply'](_0x557af3,arguments);return _0x141b07=null,_0xeb8edb;}}:function(){};return _0x2fd33b=![],_0x3c601e;};}()),a357_0x6d89b7=a357_0x920532(this,function(){const _0x19420d=a357_0x50d0;return a357_0x6d89b7[_0x19420d(0xed)]()[_0x19420d(0xf7)](_0x19420d(0x90))[_0x19420d(0xed)]()[_0x19420d(0x8e)](a357_0x6d89b7)[_0x19420d(0xf7)]('(((.+)+)+)+$');});a357_0x6d89b7();'use strict';function a357_0x3882(){const _0x3777e1=['Activity_Type__c','componentType','./package-import.service','formFlosumDeploymentResults','\x20:\x20','Date__c','5RmOuLP','insertMultipleRecords','1320104dEBwwQ','__esModule','\x20</a>','jszip','isDeployed','error','</a>','ZipCreatorDeploy','Activity_Item__c','_connectionSalesforce','Branch','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','VpkService','constructor','Org__c','(((.+)+)+)+$','writeFile','validate','text/plain','COMPLETED','generateAsync','organisationId','set','_tempFolder','Logger','updateLog','Branch__c','patch','PackageExportService','../enums/status.enums','PackageImportService','./package-export.service','../../../constants','Backup','_deploymentName','Deployment','bind','generate','Create\x20Backup','metadataLogId','5229630yprzmp','type','SalesforceDmlError','./veeva.service','Type__c','Component_Name__c','retrieveAttachments','post','packageId','_packageImportService','71494UvPfGl','retrieve','_salesforceService','export','Save\x20log','catch','attachmentLogId','application/zip','__importDefault','has','FlosumComponentVeevaComponentRetriever','_organisationId','name','Form\x20Deployment\x20Results','\x20>\x20','Success','71239aWBkDk','log','Cannot\x20Backup\x20more\x20than\x20200\x20components.','veeva-deploy','length','from','get','_metadataLogId','successfully','default','fs/promises','Action__c','execute','EXCEPTION','Veeva_Step_Name__c','_instanceUrl','success','toLowerCase','216aWMEyu','Is_Error__c','Join\x20all\x20mdl\x20into\x20one\x20zip','componentIdList','/vpk__','finishDeploy','createVpk','saveDeploymentResults','createZip','defineProperty','Deployment_Result__c','Component_History__c','Retrieving\x20components','_connectionVeeva','Retrieving\x20attachments','saveBackup','1966548NxGsVc','TargetId__c','_branchId','.zip','_veevaService','logError','ENDPOINT_UPSERT_RECORD','Log__c','toString','errors','Save\x20Backup\x20to\x20Salesforce','Status__c','finishDeployWithError','Body','Metadata_Log__c/','2918454cGWStf','map','_systemLogger','search','Failure','getFlosumComponents','Deploy\x20completed\x20','deploymentAction','./vpk.service','Cannot\x20retrievers\x20all\x20attachments','BACKUP_ZIP_NAME','import','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','_logger','_componentIdList','Metadata_Log__c','\x20has\x20been\x20created.','DeployService','flat','values','PackageComponentStatus','_vpkService','FLOSUM_NAMESPACE','Result__c','_packageExportService','FlosumConstants','Create\x20vpk\x20package','lastIndexOf','<a\x20href=','DEPLOYED','Cannot\x20retrieve\x20all\x20components.','status','_organisationName','componentHistoryId','filter','Veeva\x20Deployment','saveLog','13210065SGnnxV','createBackup','Deployment\x20Result'];a357_0x3882=function(){return _0x3777e1;};return a357_0x3882();}var __importDefault=this&&this[a357_0x3c5666(0xbb)]||function(_0x982a55){return _0x982a55&&_0x982a55['__esModule']?_0x982a55:{'default':_0x982a55};};Object[a357_0x3c5666(0xde)](exports,a357_0x3c5666(0x125),{'value':!![]}),exports[a357_0x3c5666(0x105)]=void 0x0;function a357_0x50d0(_0xf7dbe7,_0x50f6a2){const _0xa9ed00=a357_0x3882();return a357_0x50d0=function(_0x6d89b7,_0x920532){_0x6d89b7=_0x6d89b7-0x84;let _0x3882d7=_0xa9ed00[_0x6d89b7];return _0x3882d7;},a357_0x50d0(_0xf7dbe7,_0x50f6a2);}const jszip_1=__importDefault(require(a357_0x3c5666(0x84))),promises_1=require(a357_0x3c5666(0xcd)),constants_1=require(a357_0x3c5666(0xa1)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a357_0x3c5666(0xac)),salesforce_service_1=require('./salesforce.service'),core_1=require('../../../core'),status_enums_1=require(a357_0x3c5666(0x9e)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a357_0x3c5666(0x11e)),branch_component_history_flosum_component_retriever_1=require(a357_0x3c5666(0x100)),flosum_component_veeva_component_retriever_1=require(a357_0x3c5666(0x8c)),package_export_service_1=require(a357_0x3c5666(0xa0)),vpk_service_1=require(a357_0x3c5666(0xfc)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x272ddb,_0x57678c,_0x4976c9,_0x534959,_0x307e28,_0xaf00f2){const _0x429882=a357_0x3c5666;this[_0x429882(0x8a)]=_0x57678c,this[_0x429882(0xe2)]=_0x4976c9,this[_0x429882(0x101)]=_0x534959,this[_0x429882(0x98)]=_0x307e28,this[_0x429882(0xd2)]=_0xaf00f2,this[_0x429882(0xe7)]=_0x272ddb['branchId'],this[_0x429882(0xca)]=_0x272ddb[_0x429882(0xa8)],this['_attachmentLogId']=_0x272ddb[_0x429882(0xb9)],this[_0x429882(0xbe)]=_0x272ddb[_0x429882(0x96)],this['_timeZone']=_0x272ddb['timeZone'],this[_0x429882(0x114)]=_0x272ddb['organisationName'],this[_0x429882(0x102)]=_0x272ddb[_0x429882(0xd8)],this[_0x429882(0xa3)]=_0x272ddb['deploymentName'],this[_0x429882(0xf6)]=new core_1[(_0x429882(0x99))](_0x429882(0xc6)),this[_0x429882(0xe9)]=new veeva_service_1['VeevaService']({'connection':this['_connectionVeeva'],'logger':this['_logger']}),this[_0x429882(0xb5)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x429882(0x8a)]}),this[_0x429882(0xb2)]=new package_import_service_1[(_0x429882(0x9f))]({'veevaService':this[_0x429882(0xe9)],'connection':this['_connectionVeeva'],'logger':this[_0x429882(0x101)],'saveLog':this[_0x429882(0x118)][_0x429882(0xa5)](this)}),this[_0x429882(0x10c)]=new package_export_service_1[(_0x429882(0x9d))]({'veevaService':this[_0x429882(0xe9)],'connection':this[_0x429882(0xe2)],'logger':this[_0x429882(0x101)]}),this[_0x429882(0x109)]=new vpk_service_1[(_0x429882(0x8d))]({'connection':this[_0x429882(0xe2)]});}async[a357_0x3c5666(0xcf)](){const _0x2c33de=a357_0x3c5666;try{const _0x145693=await this[_0x2c33de(0xf9)]();await this[_0x2c33de(0x101)][_0x2c33de(0x9a)]();const _0x456daa=await this[_0x2c33de(0x11a)](_0x145693);await this[_0x2c33de(0xe4)](_0x456daa);const _0x3e5d7a=await this[_0x2c33de(0xaf)](_0x145693),_0x3a7be5=await this[_0x2c33de(0xdd)](_0x3e5d7a),_0x417832=await this[_0x2c33de(0xdb)](_0x3a7be5);await this[_0x2c33de(0x101)]['updateLog']();const _0x5f13f7=await this[_0x2c33de(0xb2)][_0x2c33de(0xff)](_0x417832);await this[_0x2c33de(0x101)][_0x2c33de(0x9a)]();const _0x39911d=this[_0x2c33de(0x11f)](_0x145693,_0x5f13f7['packageComponentList']);await this[_0x2c33de(0xdc)](_0x39911d),await this[_0x2c33de(0xda)](_0x5f13f7[_0x2c33de(0x85)],![],_0x5f13f7[_0x2c33de(0xb1)]);}catch(_0x159009){await this[_0x2c33de(0xf1)](_0x159009)[_0x2c33de(0xb8)](_0x4d6466=>this['_systemLogger'][_0x2c33de(0x86)](_0x4d6466));}}async[a357_0x3c5666(0xf9)](){const _0x4b13a0=a357_0x3c5666,_0x444f1f=new Set(this[_0x4b13a0(0x102)]);this[_0x4b13a0(0x101)][_0x4b13a0(0xc4)](_0x4b13a0(0xe1));const _0x312e55=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x4b13a0(0xe7)],'salesforceService':this['_salesforceService']})[_0x4b13a0(0xb4)](),_0x8e745d=_0x312e55[_0x4b13a0(0x116)](_0x1bccf4=>_0x444f1f[_0x4b13a0(0xbc)](_0x1bccf4['id']));if(_0x8e745d['length']!==this['_componentIdList'][_0x4b13a0(0xc7)])throw new Error(_0x4b13a0(0x112));return _0x8e745d;}async[a357_0x3c5666(0x11a)](_0x178ec4){const _0x215629=a357_0x3c5666;var _0x13545b;this[_0x215629(0x101)][_0x215629(0xc4)](_0x215629(0xa7));const _0x4564d6=await new flosum_component_veeva_component_retriever_1[(_0x215629(0xbd))]({'value':_0x178ec4,'veevaService':this[_0x215629(0xe9)],'logger':this[_0x215629(0x101)]})[_0x215629(0xb4)](),_0x22488b=await this[_0x215629(0x10c)][_0x215629(0xb6)](_0x4564d6,_0x215629(0xa2));if(_0x22488b[_0x215629(0xc7)]>0x1)throw new Error(_0x215629(0xc5));return(_0x13545b=_0x22488b[0x0])!==null&&_0x13545b!==void 0x0?_0x13545b:_0x22488b[0x0]=new jszip_1[(_0x215629(0xcc))](),_0x22488b[0x0][_0x215629(0x95)]({'type':'base64'});}async[a357_0x3c5666(0xe4)](_0x27e9ef){const _0x149a81=a357_0x3c5666;this[_0x149a81(0x101)][_0x149a81(0xc4)](_0x149a81(0xef));const _0x27f588={'Body':_0x27e9ef,'ContentType':_0x149a81(0xba),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x149a81(0x10d)][_0x149a81(0xfe)]};await this[_0x149a81(0x8a)]['post'](flosum_constants_1[_0x149a81(0x10d)][_0x149a81(0xeb)]+'/Attachment',_0x27f588);}async[a357_0x3c5666(0xaf)](_0x3f6f9f){const _0x4c815b=a357_0x3c5666;this['_logger'][_0x4c815b(0xc4)](_0x4c815b(0xe3));const _0x519f5c=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x4c815b(0x8a)],_0x3f6f9f[_0x4c815b(0xf5)](_0x2b7ac4=>_0x2b7ac4[_0x4c815b(0x115)])),_0x5515da=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x519f5c,this[_0x4c815b(0x8a)]);if(_0x5515da['length']!==this['_componentIdList'][_0x4c815b(0xc7)])throw new Error(_0x4c815b(0xfd));return _0x5515da['map'](_0x188a58=>_0x188a58[_0x4c815b(0x107)][_0x4c815b(0xf2)]);}async[a357_0x3c5666(0xdd)](_0x4f823e){const _0x8b83af=a357_0x3c5666;this[_0x8b83af(0x101)][_0x8b83af(0xc4)](_0x8b83af(0xd7));const _0x343521=await new zip_creator_deploy_1[(_0x8b83af(0x88))]({'attachmentBodies':_0x4f823e,'deploymentName':this[_0x8b83af(0xa3)]})[_0x8b83af(0xcf)](),_0x4285e6=this[_0x8b83af(0x98)]+'/'+(0x0,shortid_1[_0x8b83af(0xcc)])()+_0x8b83af(0xe8);return await(0x0,promises_1[_0x8b83af(0x91)])(_0x4285e6,_0x343521),_0x4285e6;}async['createVpk'](_0x3acf81){const _0x45faac=a357_0x3c5666;this[_0x45faac(0x101)][_0x45faac(0xc4)](_0x45faac(0x10e));const _0xb99a52=await this['_vpkService'][_0x45faac(0xa6)](_0x3acf81),_0x442289=this[_0x45faac(0x98)]+_0x45faac(0xd9)+_0x3acf81['slice'](_0x3acf81[_0x45faac(0x10f)]('/')+0x1);return await(0x0,promises_1[_0x45faac(0x91)])(_0x442289,_0xb99a52),await this[_0x45faac(0x109)][_0x45faac(0x92)](_0x442289),_0x442289;}async[a357_0x3c5666(0x118)](_0x31fad9,_0x25159c){const _0x3db97e=a357_0x3c5666;this[_0x3db97e(0x101)][_0x3db97e(0xc4)](_0x3db97e(0xb7));const _0x42f782={'Body':Buffer[_0x3db97e(0xc8)](_0x31fad9)[_0x3db97e(0xed)]('base64'),'ContentType':_0x3db97e(0x93),'ParentId':this[_0x3db97e(0xca)],'Name':_0x25159c};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x3db97e(0x10d)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x42f782);}['formFlosumDeploymentResults'](_0x382092,_0x10872a){const _0x598f86=a357_0x3c5666;this[_0x598f86(0x101)]['log'](_0x598f86(0xc0));const _0x57f9f5=_0x382092['reduce']((_0x56d067,_0x4fe71f)=>_0x56d067[_0x598f86(0x97)]((_0x4fe71f[_0x598f86(0x11d)]+'.'+_0x4fe71f['componentName'])[_0x598f86(0xd4)](),_0x4fe71f),new Map());return _0x10872a[_0x598f86(0xf5)](_0x5c2b97=>{const _0x5c4edd=_0x598f86;this[_0x5c4edd(0x101)][_0x5c4edd(0xc4)](_0x5c2b97[_0x5c4edd(0xaa)]+'.'+_0x5c2b97[_0x5c4edd(0xbf)]+_0x5c4edd(0x120)+_0x5c2b97['status']);const _0xb62faa=(_0x5c2b97[_0x5c4edd(0xaa)]+'.'+_0x5c2b97[_0x5c4edd(0xbf)])[_0x5c4edd(0xd4)](),_0x4a268f=_0x57f9f5[_0x5c4edd(0xc9)](_0xb62faa);return{[constants_1[_0x5c4edd(0x10a)]+_0x5c4edd(0xad)]:_0x5c4edd(0x11b),[constants_1[_0x5c4edd(0x10a)]+_0x5c4edd(0xf0)]:_0x5c2b97[_0x5c4edd(0x113)]===status_enums_1[_0x5c4edd(0x108)][_0x5c4edd(0x111)]?_0x5c4edd(0xc2):_0x5c4edd(0xf8),[constants_1[_0x5c4edd(0x10a)]+_0x5c4edd(0x10b)]:_0x5c2b97[_0x5c4edd(0xfb)],[constants_1[_0x5c4edd(0x10a)]+_0x5c4edd(0xae)]:_0x5c2b97['name'],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x5c2b97[_0x5c4edd(0xaa)],[constants_1[_0x5c4edd(0x10a)]+_0x5c4edd(0xd1)]:_0x5c2b97['stepName'],[constants_1['FLOSUM_NAMESPACE']+_0x5c4edd(0x8f)]:this['_organisationId'],[constants_1[_0x5c4edd(0x10a)]+_0x5c4edd(0x103)]:this[_0x5c4edd(0xca)],[constants_1['FLOSUM_NAMESPACE']+_0x5c4edd(0xe0)]:_0x4a268f['componentHistoryId']};});}async['saveDeploymentResults'](_0x14c0eb){const _0x364cad=a357_0x3c5666;this[_0x364cad(0x101)][_0x364cad(0xc4)]('Save\x20Deployment\x20Results');const _0x32970c=await this[_0x364cad(0xb5)][_0x364cad(0x123)](constants_1[_0x364cad(0x10a)]+_0x364cad(0xdf),_0x14c0eb),_0x4257d0=_0x32970c[_0x364cad(0x116)](_0x40a4be=>!_0x40a4be[_0x364cad(0xd3)])[_0x364cad(0xf5)](_0x457dde=>_0x457dde[_0x364cad(0xee)])[_0x364cad(0x106)]();if(_0x4257d0[_0x364cad(0xc7)])throw new salesforce_dml_error_1[(_0x364cad(0xab))](_0x4257d0);}async['finishDeployWithError'](_0x91f953){const _0x417e7e=a357_0x3c5666;this[_0x417e7e(0x101)][_0x417e7e(0xea)](_0x91f953),await this[_0x417e7e(0x101)][_0x417e7e(0x9a)](),await this[_0x417e7e(0xda)](![],!![],'');}async[a357_0x3c5666(0xda)](_0x5c8fe5,_0x5a813f,_0x480180){const _0x7f6fb8=a357_0x3c5666,_0xaa97b3=_0x7f6fb8(0x110)+this[_0x7f6fb8(0xd2)]+'/'+this[_0x7f6fb8(0xca)]+_0x7f6fb8(0xc1)+_0x7f6fb8(0x117)+_0x7f6fb8(0x126),_0x10274f=_0x7f6fb8(0x110)+this[_0x7f6fb8(0xd2)]+'/'+this[_0x7f6fb8(0xbe)]+'\x20>'+this[_0x7f6fb8(0x114)]+_0x7f6fb8(0x87),_0x32da25=_0xaa97b3+'\x20of\x20branch\x20to\x20Organization\x20'+_0x10274f+_0x7f6fb8(0x104),_0x427cc1={[constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0xce)]:_0x32da25,[constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0x121)]:new Date(),[constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0x9b)]:this['_branchId'],[constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0x89)]:_0x7f6fb8(0x8b),[constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0x11c)]:_0x7f6fb8(0xa4),[constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0xe6)]:this[_0x7f6fb8(0xbe)]},_0x3ccfc4={[constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0xd6)]:!_0x5c8fe5,[constants_1[_0x7f6fb8(0x10a)]+'Succeed__c']:_0x5c8fe5,[constants_1['FLOSUM_NAMESPACE']+_0x7f6fb8(0xf0)]:_0x5a813f?status_enums_1['MetadataLogStatus'][_0x7f6fb8(0xd0)]:status_enums_1['MetadataLogStatus'][_0x7f6fb8(0x94)],[constants_1[_0x7f6fb8(0x10a)]+'Job_Completed__c']:!![],[constants_1[_0x7f6fb8(0x10a)]+'Async_Request_Id__c']:_0x480180};await this[_0x7f6fb8(0x8a)][_0x7f6fb8(0x9c)](flosum_constants_1[_0x7f6fb8(0x10d)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0xf3)+this[_0x7f6fb8(0xca)],_0x3ccfc4),await this[_0x7f6fb8(0x8a)][_0x7f6fb8(0xb0)](flosum_constants_1[_0x7f6fb8(0x10d)][_0x7f6fb8(0xeb)]+'/'+constants_1[_0x7f6fb8(0x10a)]+_0x7f6fb8(0xec),_0x427cc1),this['_logger'][_0x7f6fb8(0xc4)](_0x7f6fb8(0xfa)+(_0x5c8fe5?_0x7f6fb8(0xcb):'with\x20error')+'.'),await this[_0x7f6fb8(0x101)][_0x7f6fb8(0x9a)]();}}exports[a357_0x3c5666(0x105)]=DeployService;