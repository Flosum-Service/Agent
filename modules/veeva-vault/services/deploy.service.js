const a389_0x571e61=a389_0x449a;(function(_0x1ca2c9,_0x2318cb){const _0x2f9736=a389_0x449a,_0x2961b8=_0x1ca2c9();while(!![]){try{const _0x2c9b58=parseInt(_0x2f9736(0x201))/0x1+-parseInt(_0x2f9736(0x173))/0x2+parseInt(_0x2f9736(0x1df))/0x3+-parseInt(_0x2f9736(0x1fc))/0x4*(-parseInt(_0x2f9736(0x185))/0x5)+parseInt(_0x2f9736(0x1d7))/0x6+-parseInt(_0x2f9736(0x1e4))/0x7+parseInt(_0x2f9736(0x194))/0x8;if(_0x2c9b58===_0x2318cb)break;else _0x2961b8['push'](_0x2961b8['shift']());}catch(_0x1a5399){_0x2961b8['push'](_0x2961b8['shift']());}}}(a389_0x56e1,0xd36c9));const a389_0x53a90b=(function(){let _0x212b46=!![];return function(_0x3c9a20,_0x3ab73f){const _0x5da129=_0x212b46?function(){const _0x105b02=a389_0x449a;if(_0x3ab73f){const _0x42ca18=_0x3ab73f[_0x105b02(0x1d9)](_0x3c9a20,arguments);return _0x3ab73f=null,_0x42ca18;}}:function(){};return _0x212b46=![],_0x5da129;};}()),a389_0x12ca9b=a389_0x53a90b(this,function(){const _0x7cf1ef=a389_0x449a;return a389_0x12ca9b[_0x7cf1ef(0x1ec)]()['search']('(((.+)+)+)+$')['toString']()[_0x7cf1ef(0x1d6)](a389_0x12ca9b)[_0x7cf1ef(0x1da)](_0x7cf1ef(0x1b4));});a389_0x12ca9b();'use strict';function a389_0x449a(_0x1914b5,_0x50b8bc){const _0x1801df=a389_0x56e1();return a389_0x449a=function(_0x12ca9b,_0x53a90b){_0x12ca9b=_0x12ca9b-0x171;let _0x56e151=_0x1801df[_0x12ca9b];return _0x56e151;},a389_0x449a(_0x1914b5,_0x50b8bc);}var __importDefault=this&&this['__importDefault']||function(_0x39c80c){const _0xfa9e99=a389_0x449a;return _0x39c80c&&_0x39c80c[_0xfa9e99(0x1aa)]?_0x39c80c:{'default':_0x39c80c};};function a389_0x56e1(){const _0x23d7ae=['flat','Cannot\x20Backup\x20more\x20than\x20200\x20components.','1823446TIXZcC','Retrieving\x20attachments','./vpk.service','values','map','/vpk__','\x20</a>','default','getFlosumComponents','isDeployed','PackageImportService','Save\x20Backup\x20to\x20Salesforce','text/plain','Activity_Type__c','jszip','writeFile','with\x20error','application/zip','1025345rjzagT','validate','createBackup','bind','../constants/flosum.constants','error','catch','organisationId','createZip','_systemLogger','updateLog','Save\x20Deployment\x20Results','reduce','Deployment_Result__c','fetchAttachmentsDetailsByParentId','11093288ZktxvV','Metadata_Log__c/','Date__c','Deployment\x20Result','execute','Is_Error__c','_vpkService','VeevaService','Form\x20Deployment\x20Results','_connectionSalesforce','Logger','_componentIdList','DEPLOYED','retrieveAttachments','organisationName','Action__c','../enums/status.enums','\x20has\x20been\x20created.','status','External_Deployment_Id__c','_attachmentLogId','set','__esModule','saveLog','MetadataLogStatus','_branchId','componentType','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','ZipCreatorDeploy','_tempFolder','_salesforceService','Cannot\x20retrieve\x20all\x20components.','(((.+)+)+)+$','FlosumConstants','_instanceUrl','_deploymentName','generateAsync','_organisationId','FlosumComponentVeevaComponentRetriever','EXCEPTION','success','ENDPOINT_UPSERT_RECORD','Branch','type','Deployment','name','Component_Name__c','packageComponentList','VpkService','Metadata_Log__c','toLowerCase','_packageImportService','_organisationName','finishDeploy','generate','Succeed__c','formFlosumDeploymentResults','createVpk','finishDeployWithError','Result__c','SalesforceDmlError','_metadataLogId','FLOSUM_NAMESPACE','export','Save\x20log','Deploy\x20completed\x20','constructor','998442Uvuklg','branchId','apply','search','Activity_Item__c','base64','<a\x20href=','componentHistoryId','2994126PvnnPd','./package-export.service','componentIdList','\x20of\x20branch\x20to\x20Organization\x20','../../shared/utils/fetch-attachments','8712256DuISzd','_connectionVeeva','slice','Create\x20vpk\x20package','errors','filter','/Attachment','../classes/errors/salesforce-dml-error','toString','deploymentName','stepName','../../../core','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Branch__c','Type__c','Join\x20all\x20mdl\x20into\x20one\x20zip','Component_History__c','saveBackup','length','log','Component_Type__c','_logger','</a>','timeZone','8jXJzie','Log__c','componentName','metadataLogId','\x20>\x20','61076BcZnSa','PackageExportService','successfully','../../../constants','_veevaService','_packageExportService','Status__c','post','lastIndexOf','packageId','Success','shortid'];a389_0x56e1=function(){return _0x23d7ae;};return a389_0x56e1();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a389_0x571e61(0x181))),promises_1=require('fs/promises'),constants_1=require(a389_0x571e61(0x204)),flosum_constants_1=require(a389_0x571e61(0x189)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),core_1=require(a389_0x571e61(0x1ef)),status_enums_1=require(a389_0x571e61(0x1a4)),salesforce_dml_error_1=require(a389_0x571e61(0x1eb)),shortid_1=__importDefault(require(a389_0x571e61(0x20c))),fetch_attachments_1=require(a389_0x571e61(0x1e3)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a389_0x571e61(0x1af)),flosum_component_veeva_component_retriever_1=require(a389_0x571e61(0x1f0)),package_export_service_1=require(a389_0x571e61(0x1e0)),vpk_service_1=require(a389_0x571e61(0x175)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x4dae1f,_0x1bd8e4,_0x2a70a7,_0x111ff6,_0x4751ba,_0x42931c){const _0x587bae=a389_0x571e61;this[_0x587bae(0x19d)]=_0x1bd8e4,this[_0x587bae(0x1e5)]=_0x2a70a7,this[_0x587bae(0x1f9)]=_0x111ff6,this['_tempFolder']=_0x4751ba,this[_0x587bae(0x1b6)]=_0x42931c,this[_0x587bae(0x1ad)]=_0x4dae1f[_0x587bae(0x1d8)],this[_0x587bae(0x1d1)]=_0x4dae1f[_0x587bae(0x1ff)],this[_0x587bae(0x1a8)]=_0x4dae1f['attachmentLogId'],this[_0x587bae(0x1b9)]=_0x4dae1f[_0x587bae(0x18c)],this['_timeZone']=_0x4dae1f[_0x587bae(0x1fb)],this[_0x587bae(0x1c8)]=_0x4dae1f[_0x587bae(0x1a2)],this[_0x587bae(0x19f)]=_0x4dae1f[_0x587bae(0x1e1)],this[_0x587bae(0x1b7)]=_0x4dae1f[_0x587bae(0x1ed)],this[_0x587bae(0x18e)]=new core_1[(_0x587bae(0x19e))]('veeva-deploy'),this['_veevaService']=new veeva_service_1[(_0x587bae(0x19b))]({'connection':this[_0x587bae(0x1e5)],'logger':this['_logger']}),this[_0x587bae(0x1b2)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x587bae(0x19d)]}),this['_packageImportService']=new package_import_service_1[(_0x587bae(0x17d))]({'veevaService':this[_0x587bae(0x205)],'connection':this['_connectionVeeva'],'logger':this[_0x587bae(0x1f9)],'saveLog':this[_0x587bae(0x1ab)][_0x587bae(0x188)](this)}),this[_0x587bae(0x206)]=new package_export_service_1[(_0x587bae(0x202))]({'veevaService':this[_0x587bae(0x205)],'connection':this[_0x587bae(0x1e5)],'logger':this[_0x587bae(0x1f9)]}),this[_0x587bae(0x19a)]=new vpk_service_1[(_0x587bae(0x1c4))]({'connection':this['_connectionVeeva']});}async[a389_0x571e61(0x198)](){const _0x572563=a389_0x571e61;try{const _0x169ca2=await this[_0x572563(0x17b)]();await this[_0x572563(0x1f9)][_0x572563(0x18f)]();const _0x44a6e1=await this['createBackup'](_0x169ca2);await this['saveBackup'](_0x44a6e1);const _0x4653dd=await this[_0x572563(0x1a1)](_0x169ca2),_0x3fc49a=await this[_0x572563(0x18d)](_0x4653dd),_0x25233b=await this['createVpk'](_0x3fc49a);await this['_logger'][_0x572563(0x18f)]();const _0x1e88df=await this[_0x572563(0x1c7)]['import'](_0x25233b);await this[_0x572563(0x1f9)][_0x572563(0x18f)]();const _0x1ea9fc=this[_0x572563(0x1cc)](_0x169ca2,_0x1e88df[_0x572563(0x1c3)]);await this['saveDeploymentResults'](_0x1ea9fc),await this[_0x572563(0x1c9)](_0x1e88df[_0x572563(0x17c)],![],_0x1e88df[_0x572563(0x20a)]);}catch(_0x59a0b5){await this[_0x572563(0x1ce)](_0x59a0b5)[_0x572563(0x18b)](_0x69094b=>this[_0x572563(0x18e)][_0x572563(0x18a)](_0x69094b));}}async['getFlosumComponents'](){const _0x49c52f=a389_0x571e61,_0x23ce8d=new Set(this[_0x49c52f(0x19f)]);this[_0x49c52f(0x1f9)][_0x49c52f(0x1f7)]('Retrieving\x20components');const _0x167dc8=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this['_branchId'],'salesforceService':this[_0x49c52f(0x1b2)]})['retrieve'](),_0x4ab203=_0x167dc8[_0x49c52f(0x1e9)](_0x2ca313=>_0x23ce8d['has'](_0x2ca313['id']));if(_0x4ab203['length']!==this['_componentIdList'][_0x49c52f(0x1f6)])throw new Error(_0x49c52f(0x1b3));return _0x4ab203;}async[a389_0x571e61(0x187)](_0xd6670c){const _0x22fc8c=a389_0x571e61;var _0x186dcf;this[_0x22fc8c(0x1f9)][_0x22fc8c(0x1f7)]('Create\x20Backup');const _0x52a8b8=await new flosum_component_veeva_component_retriever_1[(_0x22fc8c(0x1ba))]({'value':_0xd6670c,'veevaService':this[_0x22fc8c(0x205)],'logger':this[_0x22fc8c(0x1f9)]})['retrieve'](),_0x11e5df=await this[_0x22fc8c(0x206)][_0x22fc8c(0x1d3)](_0x52a8b8,'Backup');if(_0x11e5df[_0x22fc8c(0x1f6)]>0x1)throw new Error(_0x22fc8c(0x172));return(_0x186dcf=_0x11e5df[0x0])!==null&&_0x186dcf!==void 0x0?_0x186dcf:_0x11e5df[0x0]=new jszip_1[(_0x22fc8c(0x17a))](),_0x11e5df[0x0][_0x22fc8c(0x1b8)]({'type':_0x22fc8c(0x1dc)});}async[a389_0x571e61(0x1f5)](_0x15f3da){const _0x25c16e=a389_0x571e61;this[_0x25c16e(0x1f9)][_0x25c16e(0x1f7)](_0x25c16e(0x17e));const _0x397047={'Body':_0x15f3da,'ContentType':_0x25c16e(0x184),'ParentId':this[_0x25c16e(0x1d1)],'Name':flosum_constants_1[_0x25c16e(0x1b5)]['BACKUP_ZIP_NAME']};await this[_0x25c16e(0x19d)][_0x25c16e(0x208)](flosum_constants_1[_0x25c16e(0x1b5)][_0x25c16e(0x1bd)]+'/Attachment',_0x397047);}async['retrieveAttachments'](_0x2c1db0){const _0xa50009=a389_0x571e61;this[_0xa50009(0x1f9)][_0xa50009(0x1f7)](_0xa50009(0x174));const _0x2e7415=await(0x0,fetch_attachments_1[_0xa50009(0x193)])(this['_connectionSalesforce'],_0x2c1db0[_0xa50009(0x177)](_0x5b6f96=>_0x5b6f96['componentHistoryId'])),_0x5d7c1b=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x2e7415,this[_0xa50009(0x19d)]);if(_0x5d7c1b[_0xa50009(0x1f6)]!==this[_0xa50009(0x19f)]['length'])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x5d7c1b['map'](_0x1531d1=>_0x1531d1[_0xa50009(0x176)]['Body']);}async[a389_0x571e61(0x18d)](_0x3d8319){const _0x4808c1=a389_0x571e61;this[_0x4808c1(0x1f9)][_0x4808c1(0x1f7)](_0x4808c1(0x1f3));const _0x1b6714=await new zip_creator_deploy_1[(_0x4808c1(0x1b0))]({'attachmentBodies':_0x3d8319,'deploymentName':this[_0x4808c1(0x1b7)]})[_0x4808c1(0x198)](),_0x4bf263=this[_0x4808c1(0x1b1)]+'/'+(0x0,shortid_1[_0x4808c1(0x17a)])()+'.zip';return await(0x0,promises_1[_0x4808c1(0x182)])(_0x4bf263,_0x1b6714),_0x4bf263;}async[a389_0x571e61(0x1cd)](_0x1d6908){const _0x7385df=a389_0x571e61;this[_0x7385df(0x1f9)][_0x7385df(0x1f7)](_0x7385df(0x1e7));const _0x59164c=await this['_vpkService'][_0x7385df(0x1ca)](_0x1d6908),_0x54dd12=this['_tempFolder']+_0x7385df(0x178)+_0x1d6908[_0x7385df(0x1e6)](_0x1d6908[_0x7385df(0x209)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x54dd12,_0x59164c),await this[_0x7385df(0x19a)][_0x7385df(0x186)](_0x54dd12),_0x54dd12;}async[a389_0x571e61(0x1ab)](_0x5fc970,_0x488991){const _0x555c1e=a389_0x571e61;this[_0x555c1e(0x1f9)]['log'](_0x555c1e(0x1d4));const _0x209ee2={'Body':Buffer['from'](_0x5fc970)[_0x555c1e(0x1ec)]('base64'),'ContentType':_0x555c1e(0x17f),'ParentId':this['_metadataLogId'],'Name':_0x488991};await this['_connectionSalesforce'][_0x555c1e(0x208)](flosum_constants_1['FlosumConstants'][_0x555c1e(0x1bd)]+_0x555c1e(0x1ea),_0x209ee2);}['formFlosumDeploymentResults'](_0x13140e,_0x4a6242){const _0x35e757=a389_0x571e61;this[_0x35e757(0x1f9)]['log'](_0x35e757(0x19c));const _0x5ad7f4=_0x13140e[_0x35e757(0x191)]((_0x44bcf3,_0x6fd76a)=>_0x44bcf3[_0x35e757(0x1a9)]((_0x6fd76a[_0x35e757(0x1ae)]+'.'+_0x6fd76a[_0x35e757(0x1fe)])[_0x35e757(0x1c6)](),_0x6fd76a),new Map());return _0x4a6242[_0x35e757(0x177)](_0x40faa9=>{const _0x1e9a81=_0x35e757;this['_logger'][_0x1e9a81(0x1f7)](_0x40faa9[_0x1e9a81(0x1bf)]+'.'+_0x40faa9['name']+'\x20:\x20'+_0x40faa9['status']);const _0x912d43=(_0x40faa9['type']+'.'+_0x40faa9['name'])[_0x1e9a81(0x1c6)](),_0x38bed2=_0x5ad7f4['get'](_0x912d43);return{[constants_1[_0x1e9a81(0x1d2)]+_0x1e9a81(0x1f2)]:_0x1e9a81(0x197),[constants_1[_0x1e9a81(0x1d2)]+_0x1e9a81(0x207)]:_0x40faa9[_0x1e9a81(0x1a6)]===status_enums_1['PackageComponentStatus'][_0x1e9a81(0x1a0)]?_0x1e9a81(0x20b):'Failure',[constants_1[_0x1e9a81(0x1d2)]+_0x1e9a81(0x1cf)]:_0x40faa9['deploymentAction'],[constants_1['FLOSUM_NAMESPACE']+_0x1e9a81(0x1c2)]:_0x40faa9[_0x1e9a81(0x1c1)],[constants_1['FLOSUM_NAMESPACE']+_0x1e9a81(0x1f8)]:_0x40faa9['type'],[constants_1[_0x1e9a81(0x1d2)]+'Veeva_Step_Name__c']:_0x40faa9[_0x1e9a81(0x1ee)],[constants_1[_0x1e9a81(0x1d2)]+'Org__c']:this[_0x1e9a81(0x1b9)],[constants_1[_0x1e9a81(0x1d2)]+_0x1e9a81(0x1c5)]:this[_0x1e9a81(0x1d1)],[constants_1[_0x1e9a81(0x1d2)]+_0x1e9a81(0x1f4)]:_0x38bed2[_0x1e9a81(0x1de)]};});}async['saveDeploymentResults'](_0x373355){const _0x2dba96=a389_0x571e61;this[_0x2dba96(0x1f9)]['log'](_0x2dba96(0x190));const _0x515edc=await this[_0x2dba96(0x1b2)]['insertMultipleRecords'](constants_1[_0x2dba96(0x1d2)]+_0x2dba96(0x192),_0x373355),_0x1b1496=_0x515edc[_0x2dba96(0x1e9)](_0x2f0769=>!_0x2f0769[_0x2dba96(0x1bc)])[_0x2dba96(0x177)](_0x41a6ae=>_0x41a6ae[_0x2dba96(0x1e8)])[_0x2dba96(0x171)]();if(_0x1b1496[_0x2dba96(0x1f6)])throw new salesforce_dml_error_1[(_0x2dba96(0x1d0))](_0x1b1496);}async[a389_0x571e61(0x1ce)](_0x48fa7e){const _0x514c9c=a389_0x571e61;this[_0x514c9c(0x1f9)]['logError'](_0x48fa7e),await this[_0x514c9c(0x1f9)][_0x514c9c(0x18f)](),await this[_0x514c9c(0x1c9)](![],!![],'');}async[a389_0x571e61(0x1c9)](_0x409bf2,_0x2a26bf,_0x667427){const _0x45fffc=a389_0x571e61,_0x2ff857=_0x45fffc(0x1dd)+this[_0x45fffc(0x1b6)]+'/'+this[_0x45fffc(0x1d1)]+_0x45fffc(0x200)+'Veeva\x20Deployment'+_0x45fffc(0x179),_0x2abaa4=_0x45fffc(0x1dd)+this[_0x45fffc(0x1b6)]+'/'+this[_0x45fffc(0x1b9)]+'\x20>'+this[_0x45fffc(0x1c8)]+_0x45fffc(0x1fa),_0x5771c8=_0x2ff857+_0x45fffc(0x1e2)+_0x2abaa4+_0x45fffc(0x1a5),_0x535ba9={[constants_1['FLOSUM_NAMESPACE']+_0x45fffc(0x1a3)]:_0x5771c8,[constants_1[_0x45fffc(0x1d2)]+_0x45fffc(0x196)]:new Date(),[constants_1[_0x45fffc(0x1d2)]+_0x45fffc(0x1f1)]:this['_branchId'],[constants_1[_0x45fffc(0x1d2)]+_0x45fffc(0x1db)]:_0x45fffc(0x1be),[constants_1['FLOSUM_NAMESPACE']+_0x45fffc(0x180)]:_0x45fffc(0x1c0),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:this[_0x45fffc(0x1b9)]},_0x5dbfce={[constants_1['FLOSUM_NAMESPACE']+_0x45fffc(0x199)]:!_0x409bf2,[constants_1[_0x45fffc(0x1d2)]+_0x45fffc(0x1cb)]:_0x409bf2,[constants_1[_0x45fffc(0x1d2)]+_0x45fffc(0x207)]:_0x2a26bf?status_enums_1[_0x45fffc(0x1ac)][_0x45fffc(0x1bb)]:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x45fffc(0x1d2)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x45fffc(0x1a7)]:_0x667427};await this[_0x45fffc(0x19d)]['patch'](flosum_constants_1[_0x45fffc(0x1b5)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x45fffc(0x1d2)]+_0x45fffc(0x195)+this['_metadataLogId'],_0x5dbfce),await this[_0x45fffc(0x19d)][_0x45fffc(0x208)](flosum_constants_1['FlosumConstants'][_0x45fffc(0x1bd)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x45fffc(0x1fd),_0x535ba9),this[_0x45fffc(0x1f9)][_0x45fffc(0x1f7)](_0x45fffc(0x1d5)+(_0x409bf2?_0x45fffc(0x203):_0x45fffc(0x183))+'.'),await this[_0x45fffc(0x1f9)][_0x45fffc(0x18f)]();}}exports['DeployService']=DeployService;