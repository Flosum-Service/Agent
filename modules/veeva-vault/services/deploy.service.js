const a358_0x598373=a358_0x209a;(function(_0x60f224,_0x1d29f3){const _0x128a3e=a358_0x209a,_0x234d06=_0x60f224();while(!![]){try{const _0x3b79cc=parseInt(_0x128a3e(0xcc))/0x1+parseInt(_0x128a3e(0x130))/0x2+-parseInt(_0x128a3e(0xd0))/0x3+parseInt(_0x128a3e(0x136))/0x4*(parseInt(_0x128a3e(0x104))/0x5)+parseInt(_0x128a3e(0xaf))/0x6*(parseInt(_0x128a3e(0xdf))/0x7)+parseInt(_0x128a3e(0x14d))/0x8*(parseInt(_0x128a3e(0x129))/0x9)+-parseInt(_0x128a3e(0xe7))/0xa*(parseInt(_0x128a3e(0x126))/0xb);if(_0x3b79cc===_0x1d29f3)break;else _0x234d06['push'](_0x234d06['shift']());}catch(_0x411d3a){_0x234d06['push'](_0x234d06['shift']());}}}(a358_0x3a2e,0xd7086));const a358_0x299c61=(function(){let _0x525d81=!![];return function(_0x4cb5cc,_0x1a6512){const _0x3a511e=_0x525d81?function(){if(_0x1a6512){const _0x21ee13=_0x1a6512['apply'](_0x4cb5cc,arguments);return _0x1a6512=null,_0x21ee13;}}:function(){};return _0x525d81=![],_0x3a511e;};}()),a358_0x45d8c=a358_0x299c61(this,function(){const _0x2b4949=a358_0x209a;return a358_0x45d8c[_0x2b4949(0x13b)]()[_0x2b4949(0xef)](_0x2b4949(0x10d))['toString']()[_0x2b4949(0x111)](a358_0x45d8c)[_0x2b4949(0xef)](_0x2b4949(0x10d));});a358_0x45d8c();'use strict';var __importDefault=this&&this[a358_0x598373(0x150)]||function(_0x449b73){return _0x449b73&&_0x449b73['__esModule']?_0x449b73:{'default':_0x449b73};};Object[a358_0x598373(0xff)](exports,a358_0x598373(0x107),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a358_0x598373(0x11b)),constants_1=require(a358_0x598373(0x123)),flosum_constants_1=require(a358_0x598373(0x137)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),core_1=require(a358_0x598373(0xc2)),status_enums_1=require(a358_0x598373(0x138)),salesforce_dml_error_1=require(a358_0x598373(0xe2)),shortid_1=__importDefault(require(a358_0x598373(0x14e))),fetch_attachments_1=require(a358_0x598373(0xeb)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a358_0x598373(0xb9)),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x4b4c33,_0xc4a445,_0x5187ce,_0x1feadc,_0x1019a9,_0x373e4d){const _0x2f3a08=a358_0x598373;this[_0x2f3a08(0xc4)]=_0xc4a445,this['_connectionVeeva']=_0x5187ce,this[_0x2f3a08(0xf2)]=_0x1feadc,this[_0x2f3a08(0xfa)]=_0x1019a9,this['_instanceUrl']=_0x373e4d,this[_0x2f3a08(0x120)]=_0x4b4c33['branchId'],this[_0x2f3a08(0x12f)]=_0x4b4c33['metadataLogId'],this[_0x2f3a08(0x112)]=_0x4b4c33[_0x2f3a08(0x10e)],this['_organisationId']=_0x4b4c33[_0x2f3a08(0xed)],this[_0x2f3a08(0xdb)]=_0x4b4c33[_0x2f3a08(0xf7)],this[_0x2f3a08(0xd4)]=_0x4b4c33[_0x2f3a08(0xdc)],this[_0x2f3a08(0x12d)]=_0x4b4c33[_0x2f3a08(0x10b)],this[_0x2f3a08(0x13f)]=_0x4b4c33[_0x2f3a08(0x14c)],this['_systemLogger']=new core_1[(_0x2f3a08(0xc9))](_0x2f3a08(0x117)),this[_0x2f3a08(0xbe)]=new veeva_service_1['VeevaService']({'connection':this[_0x2f3a08(0xf0)],'logger':this[_0x2f3a08(0xf2)]}),this[_0x2f3a08(0x13a)]=new salesforce_service_1[(_0x2f3a08(0xbc))]({'connection':this['_connectionSalesforce']}),this[_0x2f3a08(0x114)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x2f3a08(0xbe)],'connection':this[_0x2f3a08(0xf0)],'logger':this[_0x2f3a08(0xf2)],'saveLog':this['saveLog'][_0x2f3a08(0xcd)](this)}),this[_0x2f3a08(0xba)]=new package_export_service_1[(_0x2f3a08(0xe6))]({'veevaService':this[_0x2f3a08(0xbe)],'connection':this['_connectionVeeva'],'logger':this[_0x2f3a08(0xf2)]}),this[_0x2f3a08(0xe8)]=new vpk_service_1[(_0x2f3a08(0xbb))]({'connection':this[_0x2f3a08(0xf0)]});}async[a358_0x598373(0xb7)](){const _0x5e67a4=a358_0x598373;try{const _0x3b1f77=await this[_0x5e67a4(0x113)]();await this[_0x5e67a4(0xf2)][_0x5e67a4(0xcb)]();const _0x3bffbd=await this[_0x5e67a4(0xc0)](_0x3b1f77);await this[_0x5e67a4(0xec)](_0x3bffbd);const _0x2cee58=await this[_0x5e67a4(0x12b)](_0x3b1f77),_0x83fa7a=await this['createZip'](_0x2cee58),_0x151f07=await this[_0x5e67a4(0xe9)](_0x83fa7a);await this[_0x5e67a4(0xf2)][_0x5e67a4(0xcb)]();const _0x5b72b7=await this[_0x5e67a4(0x114)][_0x5e67a4(0xf1)](_0x151f07);await this['_logger'][_0x5e67a4(0xcb)]();const _0x2a3cc5=this[_0x5e67a4(0xb0)](_0x3b1f77,_0x5b72b7[_0x5e67a4(0xe1)]);await this[_0x5e67a4(0x11a)](_0x2a3cc5),await this[_0x5e67a4(0x140)](_0x5b72b7[_0x5e67a4(0x116)],![],_0x5b72b7[_0x5e67a4(0x128)]);}catch(_0x884f0c){await this['finishDeployWithError'](_0x884f0c)['catch'](_0x591d86=>this[_0x5e67a4(0xf8)][_0x5e67a4(0xda)](_0x591d86));}}async['getFlosumComponents'](){const _0x52a985=a358_0x598373,_0x28ae16=new Set(this[_0x52a985(0x12d)]);this[_0x52a985(0xf2)][_0x52a985(0xe0)]('Retrieving\x20components');const _0xd3f996=await new branch_component_history_flosum_component_retriever_1[(_0x52a985(0x134))]({'value':this[_0x52a985(0x120)],'salesforceService':this['_salesforceService']})['retrieve'](),_0x3de336=_0xd3f996[_0x52a985(0xd3)](_0x4ed04e=>_0x28ae16[_0x52a985(0xd2)](_0x4ed04e['id']));if(_0x3de336[_0x52a985(0x11d)]!==this[_0x52a985(0x12d)][_0x52a985(0x11d)])throw new Error(_0x52a985(0x14a));return _0x3de336;}async[a358_0x598373(0xc0)](_0x1eea60){const _0x1dc863=a358_0x598373;var _0x2d304f;this[_0x1dc863(0xf2)][_0x1dc863(0xe0)](_0x1dc863(0x119));const _0x1b1634=await new flosum_component_veeva_component_retriever_1[(_0x1dc863(0x145))]({'value':_0x1eea60,'veevaService':this[_0x1dc863(0xbe)],'logger':this[_0x1dc863(0xf2)]})[_0x1dc863(0x141)](),_0x4c8511=await this[_0x1dc863(0xba)][_0x1dc863(0x118)](_0x1b1634,_0x1dc863(0x102));if(_0x4c8511[_0x1dc863(0x11d)]>0x1)throw new Error(_0x1dc863(0x146));return(_0x2d304f=_0x4c8511[0x0])!==null&&_0x2d304f!==void 0x0?_0x2d304f:_0x4c8511[0x0]=new jszip_1['default'](),_0x4c8511[0x0]['generateAsync']({'type':_0x1dc863(0x12c)});}async[a358_0x598373(0xec)](_0x311d5d){const _0x2e98a4=a358_0x598373;this[_0x2e98a4(0xf2)][_0x2e98a4(0xe0)]('Save\x20Backup\x20to\x20Salesforce');const _0x4c3227={'Body':_0x311d5d,'ContentType':_0x2e98a4(0xc1),'ParentId':this[_0x2e98a4(0x12f)],'Name':flosum_constants_1[_0x2e98a4(0xd1)][_0x2e98a4(0x135)]};await this[_0x2e98a4(0xc4)][_0x2e98a4(0x108)](flosum_constants_1[_0x2e98a4(0xd1)]['ENDPOINT_UPSERT_RECORD']+_0x2e98a4(0x13c),_0x4c3227);}async[a358_0x598373(0x12b)](_0x333dbc){const _0x87db58=a358_0x598373;this[_0x87db58(0xf2)][_0x87db58(0xe0)](_0x87db58(0x13e));const _0x1bfe28=await(0x0,fetch_attachments_1[_0x87db58(0x121)])(this[_0x87db58(0xc4)],_0x333dbc[_0x87db58(0xb8)](_0x5b5d16=>_0x5b5d16[_0x87db58(0xe4)])),_0x24f519=await(0x0,fetch_attachments_1[_0x87db58(0x12b)])(_0x1bfe28,this['_connectionSalesforce']);if(_0x24f519[_0x87db58(0x11d)]!==this['_componentIdList'][_0x87db58(0x11d)])throw new Error(_0x87db58(0xc7));return _0x24f519[_0x87db58(0xb8)](_0x4f614f=>_0x4f614f[_0x87db58(0x133)][_0x87db58(0x14f)]);}async[a358_0x598373(0xf6)](_0x5da4ff){const _0x33dc70=a358_0x598373;this['_logger']['log']('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x1bf41e=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x5da4ff,'deploymentName':this[_0x33dc70(0x13f)]})[_0x33dc70(0xb7)](),_0x2865dc=this['_tempFolder']+'/'+(0x0,shortid_1[_0x33dc70(0x124)])()+_0x33dc70(0x151);return await(0x0,promises_1[_0x33dc70(0xb6)])(_0x2865dc,_0x1bf41e),_0x2865dc;}async[a358_0x598373(0xe9)](_0x104b1b){const _0x32e7c1=a358_0x598373;this[_0x32e7c1(0xf2)]['log'](_0x32e7c1(0xf9));const _0x12d061=await this[_0x32e7c1(0xe8)][_0x32e7c1(0x11f)](_0x104b1b),_0x291846=this[_0x32e7c1(0xfa)]+_0x32e7c1(0x147)+_0x104b1b[_0x32e7c1(0xb1)](_0x104b1b[_0x32e7c1(0xd7)]('/')+0x1);return await(0x0,promises_1[_0x32e7c1(0xb6)])(_0x291846,_0x12d061),await this[_0x32e7c1(0xe8)]['validate'](_0x291846),_0x291846;}async[a358_0x598373(0xcf)](_0x3fac89,_0x105806){const _0x5821dd=a358_0x598373;this[_0x5821dd(0xf2)][_0x5821dd(0xe0)]('Save\x20log');const _0x11dbd0={'Body':Buffer[_0x5821dd(0xd8)](_0x3fac89)[_0x5821dd(0x13b)](_0x5821dd(0x12c)),'ContentType':'text/plain','ParentId':this[_0x5821dd(0x12f)],'Name':_0x105806};await this[_0x5821dd(0xc4)][_0x5821dd(0x108)](flosum_constants_1[_0x5821dd(0xd1)][_0x5821dd(0xfc)]+_0x5821dd(0x13c),_0x11dbd0);}[a358_0x598373(0xb0)](_0x2ed53d,_0x11ef42){const _0x437dc6=a358_0x598373;this[_0x437dc6(0xf2)]['log']('Form\x20Deployment\x20Results');const _0x210e48=_0x2ed53d[_0x437dc6(0x110)]((_0x334ed,_0x289beb)=>_0x334ed[_0x437dc6(0x142)]((_0x289beb['componentType']+'.'+_0x289beb[_0x437dc6(0xe3)])['toLowerCase'](),_0x289beb),new Map());return _0x11ef42[_0x437dc6(0xb8)](_0x4b5d8c=>{const _0x5630ee=_0x437dc6;this['_logger'][_0x5630ee(0xe0)](_0x4b5d8c[_0x5630ee(0x122)]+'.'+_0x4b5d8c[_0x5630ee(0xb4)]+_0x5630ee(0xae)+_0x4b5d8c['status']);const _0x3bdf7e=(_0x4b5d8c[_0x5630ee(0x122)]+'.'+_0x4b5d8c[_0x5630ee(0xb4)])[_0x5630ee(0x125)](),_0x44078a=_0x210e48[_0x5630ee(0x10f)](_0x3bdf7e);return{[constants_1[_0x5630ee(0xc3)]+_0x5630ee(0xb3)]:_0x5630ee(0xb2),[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x4b5d8c['status']===status_enums_1[_0x5630ee(0x148)][_0x5630ee(0x103)]?_0x5630ee(0x10c):_0x5630ee(0x12e),[constants_1['FLOSUM_NAMESPACE']+_0x5630ee(0x106)]:_0x4b5d8c[_0x5630ee(0x11e)],[constants_1[_0x5630ee(0xc3)]+_0x5630ee(0x149)]:_0x4b5d8c['name'],[constants_1['FLOSUM_NAMESPACE']+_0x5630ee(0xbd)]:_0x4b5d8c['type'],[constants_1['FLOSUM_NAMESPACE']+_0x5630ee(0xfd)]:_0x4b5d8c[_0x5630ee(0x105)],[constants_1[_0x5630ee(0xc3)]+_0x5630ee(0x100)]:this[_0x5630ee(0x11c)],[constants_1[_0x5630ee(0xc3)]+_0x5630ee(0xd5)]:this[_0x5630ee(0x12f)],[constants_1[_0x5630ee(0xc3)]+_0x5630ee(0x144)]:_0x44078a[_0x5630ee(0xe4)]};});}async['saveDeploymentResults'](_0x109b5e){const _0x3d7a99=a358_0x598373;this['_logger'][_0x3d7a99(0xe0)](_0x3d7a99(0x13d));const _0xa28a7b=await this[_0x3d7a99(0x13a)]['insertMultipleRecords'](constants_1[_0x3d7a99(0xc3)]+_0x3d7a99(0xfe),_0x109b5e),_0xaabac9=_0xa28a7b[_0x3d7a99(0xd3)](_0x3e6aca=>!_0x3e6aca[_0x3d7a99(0xc5)])[_0x3d7a99(0xb8)](_0x295162=>_0x295162[_0x3d7a99(0x14b)])[_0x3d7a99(0x127)]();if(_0xaabac9['length'])throw new salesforce_dml_error_1[(_0x3d7a99(0xd9))](_0xaabac9);}async[a358_0x598373(0xf3)](_0x48b353){const _0x104fbb=a358_0x598373;this[_0x104fbb(0xf2)][_0x104fbb(0x139)](_0x48b353),await this['_logger'][_0x104fbb(0xcb)](),await this['finishDeploy'](![],!![],'');}async['finishDeploy'](_0x57d98b,_0x5e816f,_0x2f8d6e){const _0x2f6b40=a358_0x598373,_0x494be2='<a\x20href='+this[_0x2f6b40(0xe5)]+'/'+this['_metadataLogId']+_0x2f6b40(0x115)+_0x2f6b40(0x132)+_0x2f6b40(0x143),_0x5e0e3c=_0x2f6b40(0x131)+this[_0x2f6b40(0xe5)]+'/'+this[_0x2f6b40(0x11c)]+'\x20>'+this[_0x2f6b40(0xd4)]+'</a>',_0x32f338=_0x494be2+'\x20of\x20branch\x20to\x20Organization\x20'+_0x5e0e3c+_0x2f6b40(0xce),_0x36bade={[constants_1['FLOSUM_NAMESPACE']+'Action__c']:_0x32f338,[constants_1[_0x2f6b40(0xc3)]+_0x2f6b40(0xd6)]:new Date(),[constants_1[_0x2f6b40(0xc3)]+_0x2f6b40(0xc6)]:this[_0x2f6b40(0x120)],[constants_1[_0x2f6b40(0xc3)]+_0x2f6b40(0xea)]:'Branch',[constants_1[_0x2f6b40(0xc3)]+'Activity_Type__c']:_0x2f6b40(0xf4),[constants_1[_0x2f6b40(0xc3)]+_0x2f6b40(0xdd)]:this['_organisationId']},_0x45313c={[constants_1[_0x2f6b40(0xc3)]+'Is_Error__c']:!_0x57d98b,[constants_1[_0x2f6b40(0xc3)]+_0x2f6b40(0x10a)]:_0x57d98b,[constants_1[_0x2f6b40(0xc3)]+_0x2f6b40(0xde)]:_0x5e816f?status_enums_1[_0x2f6b40(0xfb)][_0x2f6b40(0xf5)]:status_enums_1[_0x2f6b40(0xfb)][_0x2f6b40(0x109)],[constants_1[_0x2f6b40(0xc3)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x2f6b40(0xb5)]:_0x2f8d6e};await this['_connectionSalesforce']['patch'](flosum_constants_1['FlosumConstants'][_0x2f6b40(0xfc)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x2f6b40(0xee)+this[_0x2f6b40(0x12f)],_0x45313c),await this[_0x2f6b40(0xc4)][_0x2f6b40(0x108)](flosum_constants_1['FlosumConstants'][_0x2f6b40(0xfc)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x2f6b40(0xc8),_0x36bade),this[_0x2f6b40(0xf2)]['log'](_0x2f6b40(0xca)+(_0x57d98b?_0x2f6b40(0x101):_0x2f6b40(0xbf))+'.'),await this[_0x2f6b40(0xf2)]['updateLog']();}}function a358_0x209a(_0x1a1585,_0x37319c){const _0x4963e3=a358_0x3a2e();return a358_0x209a=function(_0x45d8c,_0x299c61){_0x45d8c=_0x45d8c-0xae;let _0x3a2ead=_0x4963e3[_0x45d8c];return _0x3a2ead;},a358_0x209a(_0x1a1585,_0x37319c);}function a358_0x3a2e(){const _0x4975b9=['export','Create\x20Backup','saveDeploymentResults','fs/promises','_organisationId','length','deploymentAction','generate','_branchId','fetchAttachmentsDetailsByParentId','type','../../../constants','default','toLowerCase','1512665dofWLE','flat','packageId','666OuoUVB','DeployService','retrieveAttachments','base64','_componentIdList','Failure','_metadataLogId','1791300LAhTzu','<a\x20href=','Veeva\x20Deployment','values','BranchComponentHistoryFlosumComponentRetriever','BACKUP_ZIP_NAME','302740wFAqnj','../constants/flosum.constants','../enums/status.enums','logError','_salesforceService','toString','/Attachment','Save\x20Deployment\x20Results','Retrieving\x20attachments','_deploymentName','finishDeploy','retrieve','set','\x20</a>','Component_History__c','FlosumComponentVeevaComponentRetriever','Cannot\x20Backup\x20more\x20than\x20200\x20components.','/vpk__','PackageComponentStatus','Component_Name__c','Cannot\x20retrieve\x20all\x20components.','errors','deploymentName','157000lInioA','shortid','Body','__importDefault','.zip','\x20:\x20','19308dgrtOZ','formFlosumDeploymentResults','slice','Deployment\x20Result','Type__c','name','Async_Request_Id__c','writeFile','execute','map','./package-export.service','_packageExportService','VpkService','SalesforceService','Component_Type__c','_veevaService','with\x20error','createBackup','application/zip','../../../core','FLOSUM_NAMESPACE','_connectionSalesforce','success','Branch__c','Cannot\x20retrievers\x20all\x20attachments','Log__c','Logger','Deploy\x20completed\x20','updateLog','635585TIVtTO','bind','\x20has\x20been\x20created.','saveLog','2821452Iiaqvu','FlosumConstants','has','filter','_organisationName','Metadata_Log__c','Date__c','lastIndexOf','from','SalesforceDmlError','error','_timeZone','organisationName','TargetId__c','Status__c','3647UcUhxl','log','packageComponentList','../classes/errors/salesforce-dml-error','componentName','componentHistoryId','_instanceUrl','PackageExportService','300aMrGrH','_vpkService','createVpk','Activity_Item__c','../../shared/utils/fetch-attachments','saveBackup','organisationId','Metadata_Log__c/','search','_connectionVeeva','import','_logger','finishDeployWithError','Deployment','EXCEPTION','createZip','timeZone','_systemLogger','Create\x20vpk\x20package','_tempFolder','MetadataLogStatus','ENDPOINT_UPSERT_RECORD','Veeva_Step_Name__c','Deployment_Result__c','defineProperty','Org__c','successfully','Backup','DEPLOYED','85RRjdPT','stepName','Result__c','__esModule','post','COMPLETED','Succeed__c','componentIdList','Success','(((.+)+)+)+$','attachmentLogId','get','reduce','constructor','_attachmentLogId','getFlosumComponents','_packageImportService','\x20>\x20','isDeployed','veeva-deploy'];a358_0x3a2e=function(){return _0x4975b9;};return a358_0x3a2e();}exports[a358_0x598373(0x12a)]=DeployService;