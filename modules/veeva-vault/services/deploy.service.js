const a402_0x1e72e6=a402_0x122d;(function(_0x540d66,_0x14e530){const _0x1a6347=a402_0x122d,_0x43a055=_0x540d66();while(!![]){try{const _0x47d58b=parseInt(_0x1a6347(0x1fb))/0x1+parseInt(_0x1a6347(0x238))/0x2*(-parseInt(_0x1a6347(0x28c))/0x3)+-parseInt(_0x1a6347(0x1f2))/0x4*(parseInt(_0x1a6347(0x24e))/0x5)+-parseInt(_0x1a6347(0x23f))/0x6*(parseInt(_0x1a6347(0x206))/0x7)+-parseInt(_0x1a6347(0x27d))/0x8+-parseInt(_0x1a6347(0x21d))/0x9*(parseInt(_0x1a6347(0x222))/0xa)+parseInt(_0x1a6347(0x209))/0xb;if(_0x47d58b===_0x14e530)break;else _0x43a055['push'](_0x43a055['shift']());}catch(_0xa4ce00){_0x43a055['push'](_0x43a055['shift']());}}}(a402_0x4dec,0x722e1));const a402_0x51def8=(function(){let _0x5526ae=!![];return function(_0x495943,_0x5e10e0){const _0x59c206=_0x5526ae?function(){const _0x38447b=a402_0x122d;if(_0x5e10e0){const _0x2936ec=_0x5e10e0[_0x38447b(0x289)](_0x495943,arguments);return _0x5e10e0=null,_0x2936ec;}}:function(){};return _0x5526ae=![],_0x59c206;};}()),a402_0x38123c=a402_0x51def8(this,function(){const _0x4f11e3=a402_0x122d;return a402_0x38123c[_0x4f11e3(0x1fa)]()[_0x4f11e3(0x273)](_0x4f11e3(0x232))[_0x4f11e3(0x1fa)]()[_0x4f11e3(0x21b)](a402_0x38123c)['search'](_0x4f11e3(0x232));});function a402_0x122d(_0x104d8a,_0x282719){const _0x2662ea=a402_0x4dec();return a402_0x122d=function(_0x38123c,_0x51def8){_0x38123c=_0x38123c-0x1ef;let _0x4decb3=_0x2662ea[_0x38123c];return _0x4decb3;},a402_0x122d(_0x104d8a,_0x282719);}a402_0x38123c();'use strict';var __importDefault=this&&this[a402_0x1e72e6(0x20a)]||function(_0x4c9c18){const _0x24a9ae=a402_0x1e72e6;return _0x4c9c18&&_0x4c9c18[_0x24a9ae(0x1fe)]?_0x4c9c18:{'default':_0x4c9c18};};function a402_0x4dec(){const _0x47f239=['Branch','\x20of\x20branch\x20to\x20Organization\x20','deploymentAction','toString','676360auyMJb','set','_systemLogger','__esModule','type','post','retrieve','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Save\x20log','createZip','\x20>\x20','595lZyooq','</a>','Create\x20vpk\x20package','30166037HGPbGA','__importDefault','branchId','Is_Error__c','../constants/flosum.constants','Status__c','_deploymentName','External_Deployment_Id__c','Action__c','./package-import.service','VpkService','Job_Completed__c','Metadata_Log__c','_metadataLogId','veeva-deploy','Component_Type__c','import','_connectionSalesforce','constructor','base64','2889mvpOUl','Type__c','log','saveBackup','Cannot\x20retrieve\x20all\x20components.','21310sauvjc','packageComponentList','validate','timeZone','map','filter','_branchId','./veeva.service','execute','Deploy\x20completed\x20','retrieveAttachments','from','./package-export.service','Succeed__c','DEPLOYED','Log__c','(((.+)+)+)+$','Veeva_Step_Name__c','values','has','/vpk__','Body','32CYkBBx','_packageExportService','flat','isDeployed','BranchComponentHistoryFlosumComponentRetriever','_veevaService','/Attachment','48714uzPXWL','Deployment','.zip','jszip','updateLog','generateAsync','slice','Result__c','EXCEPTION','Activity_Item__c','_logger','componentHistoryId','Success','name','\x20has\x20been\x20created.','20NDVFfr','get','_instanceUrl','COMPLETED','Org__c','_timeZone','FLOSUM_NAMESPACE','Deployment_Result__c','../../shared/utils/fetch-attachments','Component_Name__c','SalesforceDmlError','DeployService','formFlosumDeploymentResults','Join\x20all\x20mdl\x20into\x20one\x20zip','shortid','ENDPOINT_UPSERT_RECORD','createBackup','Backup','generate','SalesforceService','fs/promises','packageId','deploymentName','metadataLogId','Date__c','application/zip','organisationName','error','../enums/status.enums','Save\x20Deployment\x20Results','_connectionVeeva','_salesforceService','BACKUP_ZIP_NAME','status','saveDeploymentResults','Veeva\x20Deployment','length','search','../classes/deploy/zip-creator.deploy','reduce','success','finishDeploy','\x20:\x20','<a\x20href=','componentType','_componentIdList','../../../core','6196256mOPSqF','./vpk.service','FlosumConstants','PackageImportService','_vpkService','\x20</a>','_attachmentLogId','stepName','default','_organisationName','text/plain','createVpk','apply','_tempFolder','export','63804IQykqw','toLowerCase','MetadataLogStatus','Branch__c','saveLog','_organisationId','insertMultipleRecords','462060nefBMS','getFlosumComponents','PackageComponentStatus','catch','finishDeployWithError'];a402_0x4dec=function(){return _0x47f239;};return a402_0x4dec();}Object['defineProperty'](exports,a402_0x1e72e6(0x1fe),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a402_0x1e72e6(0x242))),promises_1=require(a402_0x1e72e6(0x262)),constants_1=require('../../../constants'),flosum_constants_1=require(a402_0x1e72e6(0x20d)),veeva_service_1=require(a402_0x1e72e6(0x229)),salesforce_service_1=require('./salesforce.service'),core_1=require(a402_0x1e72e6(0x27c)),status_enums_1=require(a402_0x1e72e6(0x26a)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a402_0x1e72e6(0x25c))),fetch_attachments_1=require(a402_0x1e72e6(0x256)),package_import_service_1=require(a402_0x1e72e6(0x212)),branch_component_history_flosum_component_retriever_1=require(a402_0x1e72e6(0x202)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a402_0x1e72e6(0x22e)),vpk_service_1=require(a402_0x1e72e6(0x27e)),zip_creator_deploy_1=require(a402_0x1e72e6(0x274));class DeployService{constructor(_0x3499f9,_0x4df94d,_0x275bf6,_0x2c6b4e,_0x468462,_0x4c92f4){const _0x13973b=a402_0x1e72e6;this['_connectionSalesforce']=_0x4df94d,this['_connectionVeeva']=_0x275bf6,this[_0x13973b(0x249)]=_0x2c6b4e,this[_0x13973b(0x28a)]=_0x468462,this['_instanceUrl']=_0x4c92f4,this[_0x13973b(0x228)]=_0x3499f9[_0x13973b(0x20b)],this[_0x13973b(0x216)]=_0x3499f9[_0x13973b(0x265)],this[_0x13973b(0x283)]=_0x3499f9['attachmentLogId'],this[_0x13973b(0x1f0)]=_0x3499f9['organisationId'],this[_0x13973b(0x253)]=_0x3499f9[_0x13973b(0x225)],this[_0x13973b(0x286)]=_0x3499f9[_0x13973b(0x268)],this[_0x13973b(0x27b)]=_0x3499f9['componentIdList'],this[_0x13973b(0x20f)]=_0x3499f9[_0x13973b(0x264)],this[_0x13973b(0x1fd)]=new core_1['Logger'](_0x13973b(0x217)),this['_veevaService']=new veeva_service_1['VeevaService']({'connection':this[_0x13973b(0x26c)],'logger':this[_0x13973b(0x249)]}),this[_0x13973b(0x26d)]=new salesforce_service_1[(_0x13973b(0x261))]({'connection':this['_connectionSalesforce']}),this['_packageImportService']=new package_import_service_1[(_0x13973b(0x280))]({'veevaService':this['_veevaService'],'connection':this[_0x13973b(0x26c)],'logger':this[_0x13973b(0x249)],'saveLog':this[_0x13973b(0x1ef)]['bind'](this)}),this['_packageExportService']=new package_export_service_1['PackageExportService']({'veevaService':this[_0x13973b(0x23d)],'connection':this[_0x13973b(0x26c)],'logger':this[_0x13973b(0x249)]}),this[_0x13973b(0x281)]=new vpk_service_1[(_0x13973b(0x213))]({'connection':this[_0x13973b(0x26c)]});}async[a402_0x1e72e6(0x22a)](){const _0x2b12f9=a402_0x1e72e6;try{const _0x273581=await this[_0x2b12f9(0x1f3)]();await this[_0x2b12f9(0x249)][_0x2b12f9(0x243)]();const _0x425fbd=await this[_0x2b12f9(0x25e)](_0x273581);await this[_0x2b12f9(0x220)](_0x425fbd);const _0x594428=await this[_0x2b12f9(0x22c)](_0x273581),_0x3e20d7=await this[_0x2b12f9(0x204)](_0x594428),_0x16b590=await this[_0x2b12f9(0x288)](_0x3e20d7);await this[_0x2b12f9(0x249)][_0x2b12f9(0x243)]();const _0x58d945=await this['_packageImportService'][_0x2b12f9(0x219)](_0x16b590);await this['_logger'][_0x2b12f9(0x243)]();const _0x151e77=this[_0x2b12f9(0x25a)](_0x273581,_0x58d945[_0x2b12f9(0x223)]);await this[_0x2b12f9(0x270)](_0x151e77),await this[_0x2b12f9(0x277)](_0x58d945[_0x2b12f9(0x23b)],![],_0x58d945[_0x2b12f9(0x263)]);}catch(_0x16d32e){await this['finishDeployWithError'](_0x16d32e)[_0x2b12f9(0x1f5)](_0x283d8a=>this[_0x2b12f9(0x1fd)][_0x2b12f9(0x269)](_0x283d8a));}}async[a402_0x1e72e6(0x1f3)](){const _0x399f0e=a402_0x1e72e6,_0x4db09=new Set(this[_0x399f0e(0x27b)]);this[_0x399f0e(0x249)]['log']('Retrieving\x20components');const _0x58b7f1=await new branch_component_history_flosum_component_retriever_1[(_0x399f0e(0x23c))]({'value':this[_0x399f0e(0x228)],'salesforceService':this[_0x399f0e(0x26d)]})[_0x399f0e(0x201)](),_0x3ba4fa=_0x58b7f1['filter'](_0x3ebaab=>_0x4db09[_0x399f0e(0x235)](_0x3ebaab['id']));if(_0x3ba4fa[_0x399f0e(0x272)]!==this[_0x399f0e(0x27b)][_0x399f0e(0x272)])throw new Error(_0x399f0e(0x221));return _0x3ba4fa;}async[a402_0x1e72e6(0x25e)](_0x317465){const _0x1a6526=a402_0x1e72e6;var _0x4247fd;this[_0x1a6526(0x249)][_0x1a6526(0x21f)]('Create\x20Backup');const _0x43b776=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x317465,'veevaService':this[_0x1a6526(0x23d)],'logger':this[_0x1a6526(0x249)]})['retrieve'](),_0x5c69f6=await this[_0x1a6526(0x239)][_0x1a6526(0x28b)](_0x43b776,_0x1a6526(0x25f));if(_0x5c69f6[_0x1a6526(0x272)]>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x4247fd=_0x5c69f6[0x0])!==null&&_0x4247fd!==void 0x0?_0x4247fd:_0x5c69f6[0x0]=new jszip_1[(_0x1a6526(0x285))](),_0x5c69f6[0x0][_0x1a6526(0x244)]({'type':_0x1a6526(0x21c)});}async['saveBackup'](_0x2c04f1){const _0x5821ce=a402_0x1e72e6;this['_logger'][_0x5821ce(0x21f)]('Save\x20Backup\x20to\x20Salesforce');const _0x221451={'Body':_0x2c04f1,'ContentType':_0x5821ce(0x267),'ParentId':this[_0x5821ce(0x216)],'Name':flosum_constants_1[_0x5821ce(0x27f)][_0x5821ce(0x26e)]};await this[_0x5821ce(0x21a)][_0x5821ce(0x200)](flosum_constants_1[_0x5821ce(0x27f)][_0x5821ce(0x25d)]+'/Attachment',_0x221451);}async[a402_0x1e72e6(0x22c)](_0x1e58a9){const _0x340e67=a402_0x1e72e6;this[_0x340e67(0x249)][_0x340e67(0x21f)]('Retrieving\x20attachments');const _0x344894=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this['_connectionSalesforce'],_0x1e58a9['map'](_0x33e4fa=>_0x33e4fa[_0x340e67(0x24a)])),_0x428b93=await(0x0,fetch_attachments_1[_0x340e67(0x22c)])(_0x344894,this[_0x340e67(0x21a)]);if(_0x428b93['length']!==this[_0x340e67(0x27b)][_0x340e67(0x272)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x428b93[_0x340e67(0x226)](_0x3bf921=>_0x3bf921[_0x340e67(0x234)][_0x340e67(0x237)]);}async['createZip'](_0x21e002){const _0x488ba2=a402_0x1e72e6;this['_logger'][_0x488ba2(0x21f)](_0x488ba2(0x25b));const _0x962e3d=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x21e002,'deploymentName':this[_0x488ba2(0x20f)]})[_0x488ba2(0x22a)](),_0x4ce80e=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0x488ba2(0x241);return await(0x0,promises_1['writeFile'])(_0x4ce80e,_0x962e3d),_0x4ce80e;}async['createVpk'](_0x304096){const _0x2db309=a402_0x1e72e6;this[_0x2db309(0x249)][_0x2db309(0x21f)](_0x2db309(0x208));const _0x504657=await this['_vpkService'][_0x2db309(0x260)](_0x304096),_0x17af61=this[_0x2db309(0x28a)]+_0x2db309(0x236)+_0x304096[_0x2db309(0x245)](_0x304096['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x17af61,_0x504657),await this['_vpkService'][_0x2db309(0x224)](_0x17af61),_0x17af61;}async['saveLog'](_0x1c54ee,_0x14e521){const _0x337b22=a402_0x1e72e6;this[_0x337b22(0x249)][_0x337b22(0x21f)](_0x337b22(0x203));const _0x139b6c={'Body':Buffer[_0x337b22(0x22d)](_0x1c54ee)[_0x337b22(0x1fa)](_0x337b22(0x21c)),'ContentType':_0x337b22(0x287),'ParentId':this[_0x337b22(0x216)],'Name':_0x14e521};await this[_0x337b22(0x21a)]['post'](flosum_constants_1[_0x337b22(0x27f)][_0x337b22(0x25d)]+_0x337b22(0x23e),_0x139b6c);}[a402_0x1e72e6(0x25a)](_0x856611,_0x2f7aeb){const _0x47bac1=a402_0x1e72e6;this[_0x47bac1(0x249)]['log']('Form\x20Deployment\x20Results');const _0x1aec12=_0x856611[_0x47bac1(0x275)]((_0x4a8e39,_0x3909d7)=>_0x4a8e39[_0x47bac1(0x1fc)]((_0x3909d7[_0x47bac1(0x27a)]+'.'+_0x3909d7['componentName'])[_0x47bac1(0x28d)](),_0x3909d7),new Map());return _0x2f7aeb[_0x47bac1(0x226)](_0x6c308f=>{const _0x47a58d=_0x47bac1;this['_logger'][_0x47a58d(0x21f)](_0x6c308f[_0x47a58d(0x1ff)]+'.'+_0x6c308f[_0x47a58d(0x24c)]+_0x47a58d(0x278)+_0x6c308f[_0x47a58d(0x26f)]);const _0x463084=(_0x6c308f[_0x47a58d(0x1ff)]+'.'+_0x6c308f[_0x47a58d(0x24c)])[_0x47a58d(0x28d)](),_0x509d16=_0x1aec12[_0x47a58d(0x24f)](_0x463084);return{[constants_1[_0x47a58d(0x254)]+_0x47a58d(0x21e)]:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x6c308f[_0x47a58d(0x26f)]===status_enums_1[_0x47a58d(0x1f4)][_0x47a58d(0x230)]?_0x47a58d(0x24b):'Failure',[constants_1[_0x47a58d(0x254)]+_0x47a58d(0x246)]:_0x6c308f[_0x47a58d(0x1f9)],[constants_1[_0x47a58d(0x254)]+_0x47a58d(0x257)]:_0x6c308f[_0x47a58d(0x24c)],[constants_1[_0x47a58d(0x254)]+_0x47a58d(0x218)]:_0x6c308f['type'],[constants_1[_0x47a58d(0x254)]+_0x47a58d(0x233)]:_0x6c308f[_0x47a58d(0x284)],[constants_1['FLOSUM_NAMESPACE']+_0x47a58d(0x252)]:this[_0x47a58d(0x1f0)],[constants_1['FLOSUM_NAMESPACE']+_0x47a58d(0x215)]:this[_0x47a58d(0x216)],[constants_1['FLOSUM_NAMESPACE']+'Component_History__c']:_0x509d16[_0x47a58d(0x24a)]};});}async[a402_0x1e72e6(0x270)](_0x411f69){const _0x1eb098=a402_0x1e72e6;this[_0x1eb098(0x249)][_0x1eb098(0x21f)](_0x1eb098(0x26b));const _0x4da073=await this['_salesforceService'][_0x1eb098(0x1f1)](constants_1[_0x1eb098(0x254)]+_0x1eb098(0x255),_0x411f69),_0x427d60=_0x4da073[_0x1eb098(0x227)](_0x3449c8=>!_0x3449c8[_0x1eb098(0x276)])[_0x1eb098(0x226)](_0x180295=>_0x180295['errors'])[_0x1eb098(0x23a)]();if(_0x427d60[_0x1eb098(0x272)])throw new salesforce_dml_error_1[(_0x1eb098(0x258))](_0x427d60);}async[a402_0x1e72e6(0x1f6)](_0x555588){const _0x2f7bfc=a402_0x1e72e6;this[_0x2f7bfc(0x249)]['logError'](_0x555588),await this[_0x2f7bfc(0x249)][_0x2f7bfc(0x243)](),await this['finishDeploy'](![],!![],'');}async[a402_0x1e72e6(0x277)](_0x247895,_0x129d72,_0x3e121c){const _0xaec7b7=a402_0x1e72e6,_0x172c5a='<a\x20href='+this[_0xaec7b7(0x250)]+'/'+this[_0xaec7b7(0x216)]+_0xaec7b7(0x205)+_0xaec7b7(0x271)+_0xaec7b7(0x282),_0x3d1f2a=_0xaec7b7(0x279)+this[_0xaec7b7(0x250)]+'/'+this[_0xaec7b7(0x1f0)]+'\x20>'+this[_0xaec7b7(0x286)]+_0xaec7b7(0x207),_0x22ed24=_0x172c5a+_0xaec7b7(0x1f8)+_0x3d1f2a+_0xaec7b7(0x24d),_0x3a310d={[constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x211)]:_0x22ed24,[constants_1['FLOSUM_NAMESPACE']+_0xaec7b7(0x266)]:new Date(),[constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x28f)]:this[_0xaec7b7(0x228)],[constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x248)]:_0xaec7b7(0x1f7),[constants_1[_0xaec7b7(0x254)]+'Activity_Type__c']:_0xaec7b7(0x240),[constants_1[_0xaec7b7(0x254)]+'TargetId__c']:this['_organisationId']},_0x229a8f={[constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x20c)]:!_0x247895,[constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x22f)]:_0x247895,[constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x20e)]:_0x129d72?status_enums_1['MetadataLogStatus'][_0xaec7b7(0x247)]:status_enums_1[_0xaec7b7(0x28e)][_0xaec7b7(0x251)],[constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x214)]:!![],[constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x210)]:_0x3e121c};await this[_0xaec7b7(0x21a)]['patch'](flosum_constants_1[_0xaec7b7(0x27f)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0xaec7b7(0x254)]+'Metadata_Log__c/'+this[_0xaec7b7(0x216)],_0x229a8f),await this[_0xaec7b7(0x21a)]['post'](flosum_constants_1[_0xaec7b7(0x27f)][_0xaec7b7(0x25d)]+'/'+constants_1[_0xaec7b7(0x254)]+_0xaec7b7(0x231),_0x3a310d),this[_0xaec7b7(0x249)][_0xaec7b7(0x21f)](_0xaec7b7(0x22b)+(_0x247895?'successfully':'with\x20error')+'.'),await this['_logger'][_0xaec7b7(0x243)]();}}exports[a402_0x1e72e6(0x259)]=DeployService;