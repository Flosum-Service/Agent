const a374_0x5c2da6=a374_0x2510;(function(_0x4abaf1,_0xc30f90){const _0x2a81c8=a374_0x2510,_0xee0ec5=_0x4abaf1();while(!![]){try{const _0x301cc7=parseInt(_0x2a81c8(0x128))/0x1+-parseInt(_0x2a81c8(0x157))/0x2*(-parseInt(_0x2a81c8(0x104))/0x3)+parseInt(_0x2a81c8(0x132))/0x4*(parseInt(_0x2a81c8(0x15a))/0x5)+parseInt(_0x2a81c8(0xdc))/0x6+parseInt(_0x2a81c8(0xd8))/0x7+parseInt(_0x2a81c8(0x141))/0x8+-parseInt(_0x2a81c8(0xf3))/0x9;if(_0x301cc7===_0xc30f90)break;else _0xee0ec5['push'](_0xee0ec5['shift']());}catch(_0x2ed1b8){_0xee0ec5['push'](_0xee0ec5['shift']());}}}(a374_0xbc73,0xde69b));function a374_0x2510(_0x5e7c07,_0x2aeb4a){const _0x501b2c=a374_0xbc73();return a374_0x2510=function(_0x168fc8,_0x2d56af){_0x168fc8=_0x168fc8-0xce;let _0xbc738b=_0x501b2c[_0x168fc8];return _0xbc738b;},a374_0x2510(_0x5e7c07,_0x2aeb4a);}const a374_0x2d56af=(function(){let _0x419e3d=!![];return function(_0x181a70,_0x2df0f8){const _0x21d2a8=_0x419e3d?function(){if(_0x2df0f8){const _0x1ba37c=_0x2df0f8['apply'](_0x181a70,arguments);return _0x2df0f8=null,_0x1ba37c;}}:function(){};return _0x419e3d=![],_0x21d2a8;};}()),a374_0x168fc8=a374_0x2d56af(this,function(){const _0x171f72=a374_0x2510;return a374_0x168fc8[_0x171f72(0xd0)]()['search'](_0x171f72(0x15f))[_0x171f72(0xd0)]()['constructor'](a374_0x168fc8)[_0x171f72(0x150)]('(((.+)+)+)+$');});a374_0x168fc8();'use strict';function a374_0xbc73(){const _0x3568ba=['(((.+)+)+)+$','componentType','_packageExportService','status','validate','import','getFlosumComponents','fetchAttachmentsDetailsByParentId','componentHistoryId','Succeed__c','_metadataLogId','SalesforceService','\x20has\x20been\x20created.','FlosumConstants','_organisationName','_attachmentLogId','./veeva.service','Save\x20log','Status__c','Metadata_Log__c/','defineProperty','toString','\x20>\x20','../../shared/utils/fetch-attachments','Branch','_veevaService','DEPLOYED','createZip','../constants/flosum.constants','4913881PPyIbS','insertMultipleRecords','updateLog','VeevaService','4322526yxlKNo','PackageComponentStatus','Success','type','post','_organisationId','export','Join\x20all\x20mdl\x20into\x20one\x20zip','formFlosumDeploymentResults','__esModule','length','saveLog','_vpkService','successfully','./salesforce.service','get','BranchComponentHistoryFlosumComponentRetriever','Activity_Type__c','ZipCreatorDeploy','../classes/deploy/zip-creator.deploy','timeZone','./vpk.service','Veeva_Step_Name__c','47286090RuJYid','/vpk__','error','deploymentName','ENDPOINT_UPSERT_RECORD','_timeZone','branchId','FLOSUM_NAMESPACE','BACKUP_ZIP_NAME','Job_Completed__c','bind','Branch__c','_packageImportService','organisationId','map','catch','_systemLogger','840kLtlIt','../enums/status.enums','Date__c','name','_logger','patch','errors','_salesforceService','_componentIdList','</a>','DeployService','Component_Type__c','External_Deployment_Id__c','_connectionVeeva','Backup','Create\x20vpk\x20package','_instanceUrl','Create\x20Backup','retrieve','Component_Name__c','generateAsync','../../../core','/Attachment','createVpk','Deployment','saveBackup','generate','Cannot\x20retrieve\x20all\x20components.','Activity_Item__c','set','retrieveAttachments','../../../constants','attachmentLogId','Action__c','slice','execute','306424zitWEn','createBackup','Type__c','writeFile','Cannot\x20retrievers\x20all\x20attachments','Cannot\x20Backup\x20more\x20than\x20200\x20components.','MetadataLogStatus','Result__c','\x20:\x20','\x20</a>','28xiEIpD','toLowerCase','__importDefault','metadataLogId','Deployment_Result__c','Veeva\x20Deployment','_connectionSalesforce','deploymentAction','Failure','Log__c','packageId','Metadata_Log__c','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','VpkService','finishDeploy','13798552dCPajs','FlosumComponentVeevaComponentRetriever','base64','Save\x20Deployment\x20Results','default','jszip','\x20of\x20branch\x20to\x20Organization\x20','finishDeployWithError','_deploymentName','stepName','componentName','shortid','log','_branchId','<a\x20href=','search','_tempFolder','filter','PackageImportService','./package-export.service','../classes/errors/salesforce-dml-error','saveDeploymentResults','10270FIZzGe','has','Form\x20Deployment\x20Results','909690YdttzR','Component_History__c','lastIndexOf','isDeployed','Retrieving\x20attachments'];a374_0xbc73=function(){return _0x3568ba;};return a374_0xbc73();}var __importDefault=this&&this[a374_0x5c2da6(0x134)]||function(_0x48b706){const _0x523a67=a374_0x5c2da6;return _0x48b706&&_0x48b706[_0x523a67(0xe5)]?_0x48b706:{'default':_0x48b706};};Object[a374_0x5c2da6(0xcf)](exports,a374_0x5c2da6(0xe5),{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a374_0x5c2da6(0x146))),promises_1=require('fs/promises'),constants_1=require(a374_0x5c2da6(0x123)),flosum_constants_1=require(a374_0x5c2da6(0xd7)),veeva_service_1=require(a374_0x5c2da6(0x16f)),salesforce_service_1=require(a374_0x5c2da6(0xea)),core_1=require(a374_0x5c2da6(0x119)),status_enums_1=require(a374_0x5c2da6(0x105)),salesforce_dml_error_1=require(a374_0x5c2da6(0x155)),shortid_1=__importDefault(require(a374_0x5c2da6(0x14c))),fetch_attachments_1=require(a374_0x5c2da6(0xd2)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a374_0x5c2da6(0x13e)),package_export_service_1=require(a374_0x5c2da6(0x154)),vpk_service_1=require(a374_0x5c2da6(0xf1)),zip_creator_deploy_1=require(a374_0x5c2da6(0xef));class DeployService{constructor(_0x3db69d,_0x1c9314,_0x5d4de4,_0x4cc8e0,_0x782008,_0x485dc6){const _0x15e4fd=a374_0x5c2da6;this['_connectionSalesforce']=_0x1c9314,this[_0x15e4fd(0x111)]=_0x5d4de4,this['_logger']=_0x4cc8e0,this['_tempFolder']=_0x782008,this['_instanceUrl']=_0x485dc6,this[_0x15e4fd(0x14e)]=_0x3db69d[_0x15e4fd(0xf9)],this[_0x15e4fd(0x169)]=_0x3db69d[_0x15e4fd(0x135)],this[_0x15e4fd(0x16e)]=_0x3db69d[_0x15e4fd(0x124)],this['_organisationId']=_0x3db69d[_0x15e4fd(0x100)],this[_0x15e4fd(0xf8)]=_0x3db69d[_0x15e4fd(0xf0)],this[_0x15e4fd(0x16d)]=_0x3db69d['organisationName'],this[_0x15e4fd(0x10c)]=_0x3db69d['componentIdList'],this[_0x15e4fd(0x149)]=_0x3db69d[_0x15e4fd(0xf6)],this['_systemLogger']=new core_1['Logger']('veeva-deploy'),this[_0x15e4fd(0xd4)]=new veeva_service_1[(_0x15e4fd(0xdb))]({'connection':this['_connectionVeeva'],'logger':this[_0x15e4fd(0x108)]}),this[_0x15e4fd(0x10b)]=new salesforce_service_1[(_0x15e4fd(0x16a))]({'connection':this['_connectionSalesforce']}),this[_0x15e4fd(0xff)]=new package_import_service_1[(_0x15e4fd(0x153))]({'veevaService':this[_0x15e4fd(0xd4)],'connection':this[_0x15e4fd(0x111)],'logger':this[_0x15e4fd(0x108)],'saveLog':this[_0x15e4fd(0xe7)][_0x15e4fd(0xfd)](this)}),this['_packageExportService']=new package_export_service_1['PackageExportService']({'veevaService':this[_0x15e4fd(0xd4)],'connection':this['_connectionVeeva'],'logger':this[_0x15e4fd(0x108)]}),this['_vpkService']=new vpk_service_1[(_0x15e4fd(0x13f))]({'connection':this[_0x15e4fd(0x111)]});}async['execute'](){const _0x3d79f1=a374_0x5c2da6;try{const _0x442ddb=await this[_0x3d79f1(0x165)]();await this[_0x3d79f1(0x108)]['updateLog']();const _0x3124fd=await this[_0x3d79f1(0x129)](_0x442ddb);await this[_0x3d79f1(0x11d)](_0x3124fd);const _0x3430b8=await this[_0x3d79f1(0x122)](_0x442ddb),_0x26c2fd=await this[_0x3d79f1(0xd6)](_0x3430b8),_0x33529d=await this[_0x3d79f1(0x11b)](_0x26c2fd);await this[_0x3d79f1(0x108)]['updateLog']();const _0x5c3afa=await this[_0x3d79f1(0xff)][_0x3d79f1(0x164)](_0x33529d);await this[_0x3d79f1(0x108)][_0x3d79f1(0xda)]();const _0x373907=this[_0x3d79f1(0xe4)](_0x442ddb,_0x5c3afa['packageComponentList']);await this[_0x3d79f1(0x156)](_0x373907),await this[_0x3d79f1(0x140)](_0x5c3afa[_0x3d79f1(0x15d)],![],_0x5c3afa[_0x3d79f1(0x13c)]);}catch(_0x4a52bf){await this['finishDeployWithError'](_0x4a52bf)[_0x3d79f1(0x102)](_0x51d9d9=>this[_0x3d79f1(0x103)][_0x3d79f1(0xf5)](_0x51d9d9));}}async[a374_0x5c2da6(0x165)](){const _0x1bc8a0=a374_0x5c2da6,_0x4dce56=new Set(this[_0x1bc8a0(0x10c)]);this[_0x1bc8a0(0x108)][_0x1bc8a0(0x14d)]('Retrieving\x20components');const _0x300cd0=await new branch_component_history_flosum_component_retriever_1[(_0x1bc8a0(0xec))]({'value':this['_branchId'],'salesforceService':this[_0x1bc8a0(0x10b)]})[_0x1bc8a0(0x116)](),_0x944e04=_0x300cd0[_0x1bc8a0(0x152)](_0x47e385=>_0x4dce56[_0x1bc8a0(0x158)](_0x47e385['id']));if(_0x944e04[_0x1bc8a0(0xe6)]!==this[_0x1bc8a0(0x10c)][_0x1bc8a0(0xe6)])throw new Error(_0x1bc8a0(0x11f));return _0x944e04;}async[a374_0x5c2da6(0x129)](_0x2383a8){const _0x174832=a374_0x5c2da6;var _0x17a958;this[_0x174832(0x108)][_0x174832(0x14d)](_0x174832(0x115));const _0x1efe04=await new flosum_component_veeva_component_retriever_1[(_0x174832(0x142))]({'value':_0x2383a8,'veevaService':this[_0x174832(0xd4)],'logger':this[_0x174832(0x108)]})[_0x174832(0x116)](),_0x229289=await this[_0x174832(0x161)][_0x174832(0xe2)](_0x1efe04,_0x174832(0x112));if(_0x229289['length']>0x1)throw new Error(_0x174832(0x12d));return(_0x17a958=_0x229289[0x0])!==null&&_0x17a958!==void 0x0?_0x17a958:_0x229289[0x0]=new jszip_1[(_0x174832(0x145))](),_0x229289[0x0][_0x174832(0x118)]({'type':'base64'});}async[a374_0x5c2da6(0x11d)](_0x428eea){const _0x5e3a3d=a374_0x5c2da6;this[_0x5e3a3d(0x108)]['log']('Save\x20Backup\x20to\x20Salesforce');const _0x53ed80={'Body':_0x428eea,'ContentType':'application/zip','ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x5e3a3d(0x16c)][_0x5e3a3d(0xfb)]};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x5e3a3d(0x16c)][_0x5e3a3d(0xf7)]+_0x5e3a3d(0x11a),_0x53ed80);}async['retrieveAttachments'](_0x5a7b6e){const _0x3498b2=a374_0x5c2da6;this[_0x3498b2(0x108)][_0x3498b2(0x14d)](_0x3498b2(0x15e));const _0x398117=await(0x0,fetch_attachments_1[_0x3498b2(0x166)])(this[_0x3498b2(0x138)],_0x5a7b6e[_0x3498b2(0x101)](_0x1fb12b=>_0x1fb12b[_0x3498b2(0x167)])),_0x53054f=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x398117,this['_connectionSalesforce']);if(_0x53054f['length']!==this[_0x3498b2(0x10c)][_0x3498b2(0xe6)])throw new Error(_0x3498b2(0x12c));return _0x53054f[_0x3498b2(0x101)](_0x376f63=>_0x376f63['values']['Body']);}async['createZip'](_0x60f275){const _0x170146=a374_0x5c2da6;this[_0x170146(0x108)]['log'](_0x170146(0xe3));const _0x3ecb89=await new zip_creator_deploy_1[(_0x170146(0xee))]({'attachmentBodies':_0x60f275,'deploymentName':this['_deploymentName']})[_0x170146(0x127)](),_0x4101cb=this[_0x170146(0x151)]+'/'+(0x0,shortid_1[_0x170146(0x145)])()+'.zip';return await(0x0,promises_1[_0x170146(0x12b)])(_0x4101cb,_0x3ecb89),_0x4101cb;}async['createVpk'](_0x3edeb9){const _0x5b22f2=a374_0x5c2da6;this[_0x5b22f2(0x108)][_0x5b22f2(0x14d)](_0x5b22f2(0x113));const _0x22c072=await this['_vpkService'][_0x5b22f2(0x11e)](_0x3edeb9),_0x11eb95=this['_tempFolder']+_0x5b22f2(0xf4)+_0x3edeb9[_0x5b22f2(0x126)](_0x3edeb9[_0x5b22f2(0x15c)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x11eb95,_0x22c072),await this[_0x5b22f2(0xe8)][_0x5b22f2(0x163)](_0x11eb95),_0x11eb95;}async[a374_0x5c2da6(0xe7)](_0xcf21d1,_0x1632de){const _0x40cf8d=a374_0x5c2da6;this['_logger'][_0x40cf8d(0x14d)](_0x40cf8d(0x170));const _0x3bef36={'Body':Buffer['from'](_0xcf21d1)[_0x40cf8d(0xd0)](_0x40cf8d(0x143)),'ContentType':'text/plain','ParentId':this[_0x40cf8d(0x169)],'Name':_0x1632de};await this[_0x40cf8d(0x138)][_0x40cf8d(0xe0)](flosum_constants_1[_0x40cf8d(0x16c)][_0x40cf8d(0xf7)]+_0x40cf8d(0x11a),_0x3bef36);}['formFlosumDeploymentResults'](_0x148c00,_0x277ab3){const _0x3c5da5=a374_0x5c2da6;this[_0x3c5da5(0x108)][_0x3c5da5(0x14d)](_0x3c5da5(0x159));const _0x52c414=_0x148c00['reduce']((_0x79fd99,_0x4176dd)=>_0x79fd99[_0x3c5da5(0x121)]((_0x4176dd[_0x3c5da5(0x160)]+'.'+_0x4176dd[_0x3c5da5(0x14b)])[_0x3c5da5(0x133)](),_0x4176dd),new Map());return _0x277ab3['map'](_0x2c77ee=>{const _0x178842=_0x3c5da5;this[_0x178842(0x108)][_0x178842(0x14d)](_0x2c77ee[_0x178842(0xdf)]+'.'+_0x2c77ee[_0x178842(0x107)]+_0x178842(0x130)+_0x2c77ee[_0x178842(0x162)]);const _0x4f9c76=(_0x2c77ee[_0x178842(0xdf)]+'.'+_0x2c77ee[_0x178842(0x107)])[_0x178842(0x133)](),_0x2c8f4a=_0x52c414[_0x178842(0xeb)](_0x4f9c76);return{[constants_1[_0x178842(0xfa)]+_0x178842(0x12a)]:'Deployment\x20Result',[constants_1[_0x178842(0xfa)]+_0x178842(0x171)]:_0x2c77ee[_0x178842(0x162)]===status_enums_1[_0x178842(0xdd)][_0x178842(0xd5)]?_0x178842(0xde):_0x178842(0x13a),[constants_1[_0x178842(0xfa)]+_0x178842(0x12f)]:_0x2c77ee[_0x178842(0x139)],[constants_1['FLOSUM_NAMESPACE']+_0x178842(0x117)]:_0x2c77ee['name'],[constants_1[_0x178842(0xfa)]+_0x178842(0x10f)]:_0x2c77ee[_0x178842(0xdf)],[constants_1['FLOSUM_NAMESPACE']+_0x178842(0xf2)]:_0x2c77ee[_0x178842(0x14a)],[constants_1[_0x178842(0xfa)]+'Org__c']:this[_0x178842(0xe1)],[constants_1[_0x178842(0xfa)]+_0x178842(0x13d)]:this[_0x178842(0x169)],[constants_1[_0x178842(0xfa)]+_0x178842(0x15b)]:_0x2c8f4a[_0x178842(0x167)]};});}async['saveDeploymentResults'](_0x7a98fb){const _0x202e5a=a374_0x5c2da6;this[_0x202e5a(0x108)][_0x202e5a(0x14d)](_0x202e5a(0x144));const _0x20ed7c=await this['_salesforceService'][_0x202e5a(0xd9)](constants_1[_0x202e5a(0xfa)]+_0x202e5a(0x136),_0x7a98fb),_0x2484cf=_0x20ed7c[_0x202e5a(0x152)](_0x38c7a2=>!_0x38c7a2['success'])[_0x202e5a(0x101)](_0x49b0a5=>_0x49b0a5[_0x202e5a(0x10a)])['flat']();if(_0x2484cf[_0x202e5a(0xe6)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x2484cf);}async[a374_0x5c2da6(0x148)](_0x5a6129){const _0x3867ae=a374_0x5c2da6;this[_0x3867ae(0x108)]['logError'](_0x5a6129),await this[_0x3867ae(0x108)][_0x3867ae(0xda)](),await this[_0x3867ae(0x140)](![],!![],'');}async['finishDeploy'](_0x5acf8e,_0x48c0cd,_0x18d801){const _0x3f6019=a374_0x5c2da6,_0xe2da69=_0x3f6019(0x14f)+this[_0x3f6019(0x114)]+'/'+this['_metadataLogId']+_0x3f6019(0xd1)+_0x3f6019(0x137)+_0x3f6019(0x131),_0x230146=_0x3f6019(0x14f)+this['_instanceUrl']+'/'+this[_0x3f6019(0xe1)]+'\x20>'+this[_0x3f6019(0x16d)]+_0x3f6019(0x10d),_0x51ac3c=_0xe2da69+_0x3f6019(0x147)+_0x230146+_0x3f6019(0x16b),_0x6640cb={[constants_1[_0x3f6019(0xfa)]+_0x3f6019(0x125)]:_0x51ac3c,[constants_1[_0x3f6019(0xfa)]+_0x3f6019(0x106)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x3f6019(0xfe)]:this[_0x3f6019(0x14e)],[constants_1['FLOSUM_NAMESPACE']+_0x3f6019(0x120)]:_0x3f6019(0xd3),[constants_1['FLOSUM_NAMESPACE']+_0x3f6019(0xed)]:_0x3f6019(0x11c),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:this[_0x3f6019(0xe1)]},_0x64b5d9={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x5acf8e,[constants_1[_0x3f6019(0xfa)]+_0x3f6019(0x168)]:_0x5acf8e,[constants_1[_0x3f6019(0xfa)]+_0x3f6019(0x171)]:_0x48c0cd?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x3f6019(0x12e)]['COMPLETED'],[constants_1['FLOSUM_NAMESPACE']+_0x3f6019(0xfc)]:!![],[constants_1[_0x3f6019(0xfa)]+_0x3f6019(0x110)]:_0x18d801};await this[_0x3f6019(0x138)][_0x3f6019(0x109)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x3f6019(0xce)+this[_0x3f6019(0x169)],_0x64b5d9),await this[_0x3f6019(0x138)][_0x3f6019(0xe0)](flosum_constants_1['FlosumConstants'][_0x3f6019(0xf7)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x3f6019(0x13b),_0x6640cb),this[_0x3f6019(0x108)]['log']('Deploy\x20completed\x20'+(_0x5acf8e?_0x3f6019(0xe9):'with\x20error')+'.'),await this[_0x3f6019(0x108)][_0x3f6019(0xda)]();}}exports[a374_0x5c2da6(0x10e)]=DeployService;