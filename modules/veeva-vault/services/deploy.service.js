const a390_0xb8f6a2=a390_0x1124;(function(_0x20b7fd,_0x490da5){const _0x4b2dc5=a390_0x1124,_0x4e99f4=_0x20b7fd();while(!![]){try{const _0x2eba57=-parseInt(_0x4b2dc5(0x17f))/0x1*(-parseInt(_0x4b2dc5(0x190))/0x2)+parseInt(_0x4b2dc5(0x1e0))/0x3+parseInt(_0x4b2dc5(0x1af))/0x4+-parseInt(_0x4b2dc5(0x16f))/0x5+-parseInt(_0x4b2dc5(0x14a))/0x6*(-parseInt(_0x4b2dc5(0x19b))/0x7)+parseInt(_0x4b2dc5(0x166))/0x8+-parseInt(_0x4b2dc5(0x171))/0x9;if(_0x2eba57===_0x490da5)break;else _0x4e99f4['push'](_0x4e99f4['shift']());}catch(_0x4fd492){_0x4e99f4['push'](_0x4e99f4['shift']());}}}(a390_0x2618,0xdf5d7));const a390_0x40f597=(function(){let _0x291a2a=!![];return function(_0x49655e,_0x27cc1d){const _0x42507a=_0x291a2a?function(){const _0x5957d9=a390_0x1124;if(_0x27cc1d){const _0x23da38=_0x27cc1d[_0x5957d9(0x183)](_0x49655e,arguments);return _0x27cc1d=null,_0x23da38;}}:function(){};return _0x291a2a=![],_0x42507a;};}()),a390_0x6a554e=a390_0x40f597(this,function(){const _0x16fea1=a390_0x1124;return a390_0x6a554e[_0x16fea1(0x1d9)]()[_0x16fea1(0x16d)](_0x16fea1(0x16e))[_0x16fea1(0x1d9)]()[_0x16fea1(0x194)](a390_0x6a554e)[_0x16fea1(0x16d)](_0x16fea1(0x16e));});a390_0x6a554e();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x1344d7){const _0x501aa5=a390_0x1124;return _0x1344d7&&_0x1344d7[_0x501aa5(0x1c0)]?_0x1344d7:{'default':_0x1344d7};};Object[a390_0xb8f6a2(0x1c6)](exports,a390_0xb8f6a2(0x1c0),{'value':!![]}),exports[a390_0xb8f6a2(0x1b6)]=void 0x0;function a390_0x2618(){const _0x1a155e=['deploymentName','jszip','EXCEPTION','search','(((.+)+)+)+$','2941375vwSXlM','Branch','27565434oQgvRg','SalesforceDmlError','_metadataLogId','retrieve','Branch__c','log','_tempFolder','successfully','./package-export.service','Status__c','saveLog','Job_Completed__c','./salesforce.service','createZip','282202THVzUU','from','insertMultipleRecords','BACKUP_ZIP_NAME','apply','packageComponentList','attachmentLogId','_organisationName','Activity_Type__c','Save\x20Deployment\x20Results','Success','application/zip','success','componentIdList','_branchId','_connectionSalesforce','veeva-deploy','4oYETiM','Deploy\x20completed\x20','timeZone','isDeployed','constructor','../../../constants','_attachmentLogId','\x20of\x20branch\x20to\x20Organization\x20','VeevaService','patch','createBackup','2128KEGEJt','Save\x20log','PackageExportService','FlosumComponentVeevaComponentRetriever','toLowerCase','Cannot\x20retrieve\x20all\x20components.','SalesforceService','componentType','Component_History__c','DEPLOYED','PackageImportService','length','updateLog','createVpk','_salesforceService','status','branchId','_componentIdList','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','../constants/flosum.constants','4424100uXmpbk','_packageImportService','catch','get','PackageComponentStatus','Create\x20vpk\x20package','reduce','DeployService','execute','Is_Error__c','_logger','_instanceUrl','values','VpkService','TargetId__c','_systemLogger','Log__c','__esModule','default','<a\x20href=','name','MetadataLogStatus','saveBackup','defineProperty','Veeva_Step_Name__c','Succeed__c','/vpk__','type','./veeva.service','\x20>\x20','FLOSUM_NAMESPACE','FlosumConstants','Deployment\x20Result','fetchAttachmentsDetailsByParentId','finishDeployWithError','retrieveAttachments','\x20:\x20','Body','Logger','_organisationId','_veevaService','\x20</a>','toString','import','with\x20error','componentHistoryId','.zip','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Save\x20Backup\x20to\x20Salesforce','2679381ANGMae','text/plain','_packageExportService','filter','componentName','External_Deployment_Id__c','./vpk.service','Cannot\x20retrievers\x20all\x20attachments','\x20has\x20been\x20created.','./package-import.service','map','flat','Create\x20Backup','BranchComponentHistoryFlosumComponentRetriever','getFlosumComponents','error','ENDPOINT_UPSERT_RECORD','Date__c','_deploymentName','14298KFMtoW','packageId','Action__c','stepName','Failure','Component_Type__c','errors','../classes/errors/salesforce-dml-error','../../../core','generateAsync','organisationId','base64','_connectionVeeva','Metadata_Log__c/','Component_Name__c','writeFile','Backup','_vpkService','Deployment','finishDeploy','Metadata_Log__c','saveDeploymentResults','COMPLETED','logError','../../shared/utils/fetch-attachments','shortid','deploymentAction','metadataLogId','10224128moSaMr','post','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','/Attachment'];a390_0x2618=function(){return _0x1a155e;};return a390_0x2618();}function a390_0x1124(_0xd2a89e,_0x3a33be){const _0x16060a=a390_0x2618();return a390_0x1124=function(_0x6a554e,_0x40f597){_0x6a554e=_0x6a554e-0x13a;let _0x261893=_0x16060a[_0x6a554e];return _0x261893;},a390_0x1124(_0xd2a89e,_0x3a33be);}const jszip_1=__importDefault(require(a390_0xb8f6a2(0x16b))),promises_1=require('fs/promises'),constants_1=require(a390_0xb8f6a2(0x195)),flosum_constants_1=require(a390_0xb8f6a2(0x1ae)),veeva_service_1=require(a390_0xb8f6a2(0x1cb)),salesforce_service_1=require(a390_0xb8f6a2(0x17d)),core_1=require(a390_0xb8f6a2(0x152)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a390_0xb8f6a2(0x151)),shortid_1=__importDefault(require(a390_0xb8f6a2(0x163))),fetch_attachments_1=require(a390_0xb8f6a2(0x162)),package_import_service_1=require(a390_0xb8f6a2(0x140)),branch_component_history_flosum_component_retriever_1=require(a390_0xb8f6a2(0x1ad)),flosum_component_veeva_component_retriever_1=require(a390_0xb8f6a2(0x168)),package_export_service_1=require(a390_0xb8f6a2(0x179)),vpk_service_1=require(a390_0xb8f6a2(0x13d)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x1cf94e,_0x5032f8,_0x5080da,_0x506ab7,_0x4ec2eb,_0x53608d){const _0x1ddd96=a390_0xb8f6a2;this[_0x1ddd96(0x18e)]=_0x5032f8,this[_0x1ddd96(0x156)]=_0x5080da,this[_0x1ddd96(0x1b9)]=_0x506ab7,this[_0x1ddd96(0x177)]=_0x4ec2eb,this['_instanceUrl']=_0x53608d,this[_0x1ddd96(0x18d)]=_0x1cf94e[_0x1ddd96(0x1ab)],this[_0x1ddd96(0x173)]=_0x1cf94e[_0x1ddd96(0x165)],this[_0x1ddd96(0x196)]=_0x1cf94e[_0x1ddd96(0x185)],this[_0x1ddd96(0x1d6)]=_0x1cf94e[_0x1ddd96(0x154)],this['_timeZone']=_0x1cf94e[_0x1ddd96(0x192)],this[_0x1ddd96(0x186)]=_0x1cf94e['organisationName'],this[_0x1ddd96(0x1ac)]=_0x1cf94e[_0x1ddd96(0x18c)],this[_0x1ddd96(0x149)]=_0x1cf94e[_0x1ddd96(0x16a)],this[_0x1ddd96(0x1be)]=new core_1[(_0x1ddd96(0x1d5))](_0x1ddd96(0x18f)),this[_0x1ddd96(0x1d7)]=new veeva_service_1[(_0x1ddd96(0x198))]({'connection':this[_0x1ddd96(0x156)],'logger':this[_0x1ddd96(0x1b9)]}),this[_0x1ddd96(0x1a9)]=new salesforce_service_1[(_0x1ddd96(0x1a1))]({'connection':this[_0x1ddd96(0x18e)]}),this['_packageImportService']=new package_import_service_1[(_0x1ddd96(0x1a5))]({'veevaService':this[_0x1ddd96(0x1d7)],'connection':this[_0x1ddd96(0x156)],'logger':this['_logger'],'saveLog':this[_0x1ddd96(0x17b)]['bind'](this)}),this[_0x1ddd96(0x1e2)]=new package_export_service_1[(_0x1ddd96(0x19d))]({'veevaService':this[_0x1ddd96(0x1d7)],'connection':this[_0x1ddd96(0x156)],'logger':this[_0x1ddd96(0x1b9)]}),this[_0x1ddd96(0x15b)]=new vpk_service_1[(_0x1ddd96(0x1bc))]({'connection':this['_connectionVeeva']});}async[a390_0xb8f6a2(0x1b7)](){const _0x2af632=a390_0xb8f6a2;try{const _0x5383d8=await this[_0x2af632(0x145)]();await this['_logger'][_0x2af632(0x1a7)]();const _0x42dc7a=await this[_0x2af632(0x19a)](_0x5383d8);await this[_0x2af632(0x1c5)](_0x42dc7a);const _0x1471ca=await this[_0x2af632(0x1d2)](_0x5383d8),_0x1419e5=await this[_0x2af632(0x17e)](_0x1471ca),_0x23431d=await this[_0x2af632(0x1a8)](_0x1419e5);await this[_0x2af632(0x1b9)][_0x2af632(0x1a7)]();const _0x54e111=await this[_0x2af632(0x1b0)][_0x2af632(0x1da)](_0x23431d);await this[_0x2af632(0x1b9)][_0x2af632(0x1a7)]();const _0x385e0a=this['formFlosumDeploymentResults'](_0x5383d8,_0x54e111[_0x2af632(0x184)]);await this[_0x2af632(0x15f)](_0x385e0a),await this[_0x2af632(0x15d)](_0x54e111[_0x2af632(0x193)],![],_0x54e111[_0x2af632(0x14b)]);}catch(_0x50a96b){await this[_0x2af632(0x1d1)](_0x50a96b)[_0x2af632(0x1b1)](_0x4a9bfc=>this[_0x2af632(0x1be)][_0x2af632(0x146)](_0x4a9bfc));}}async[a390_0xb8f6a2(0x145)](){const _0x54e85c=a390_0xb8f6a2,_0x42710c=new Set(this['_componentIdList']);this[_0x54e85c(0x1b9)]['log']('Retrieving\x20components');const _0x63eb2f=await new branch_component_history_flosum_component_retriever_1[(_0x54e85c(0x144))]({'value':this[_0x54e85c(0x18d)],'salesforceService':this['_salesforceService']})[_0x54e85c(0x174)](),_0x5c20c7=_0x63eb2f['filter'](_0x4162e0=>_0x42710c['has'](_0x4162e0['id']));if(_0x5c20c7['length']!==this['_componentIdList']['length'])throw new Error(_0x54e85c(0x1a0));return _0x5c20c7;}async[a390_0xb8f6a2(0x19a)](_0x54fa81){const _0xa25f75=a390_0xb8f6a2;var _0x4269d8;this[_0xa25f75(0x1b9)][_0xa25f75(0x176)](_0xa25f75(0x143));const _0x394df5=await new flosum_component_veeva_component_retriever_1[(_0xa25f75(0x19e))]({'value':_0x54fa81,'veevaService':this[_0xa25f75(0x1d7)],'logger':this[_0xa25f75(0x1b9)]})['retrieve'](),_0x4f69e4=await this[_0xa25f75(0x1e2)]['export'](_0x394df5,_0xa25f75(0x15a));if(_0x4f69e4[_0xa25f75(0x1a6)]>0x1)throw new Error(_0xa25f75(0x1de));return(_0x4269d8=_0x4f69e4[0x0])!==null&&_0x4269d8!==void 0x0?_0x4269d8:_0x4f69e4[0x0]=new jszip_1['default'](),_0x4f69e4[0x0][_0xa25f75(0x153)]({'type':_0xa25f75(0x155)});}async[a390_0xb8f6a2(0x1c5)](_0x3bdc97){const _0x557464=a390_0xb8f6a2;this[_0x557464(0x1b9)]['log'](_0x557464(0x1df));const _0x60e979={'Body':_0x3bdc97,'ContentType':_0x557464(0x18a),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x557464(0x1ce)][_0x557464(0x182)]};await this[_0x557464(0x18e)][_0x557464(0x167)](flosum_constants_1['FlosumConstants'][_0x557464(0x147)]+_0x557464(0x169),_0x60e979);}async['retrieveAttachments'](_0x2431dc){const _0x25ee3f=a390_0xb8f6a2;this[_0x25ee3f(0x1b9)][_0x25ee3f(0x176)]('Retrieving\x20attachments');const _0x3005b1=await(0x0,fetch_attachments_1[_0x25ee3f(0x1d0)])(this[_0x25ee3f(0x18e)],_0x2431dc[_0x25ee3f(0x141)](_0x4c2bbe=>_0x4c2bbe['componentHistoryId'])),_0x190762=await(0x0,fetch_attachments_1[_0x25ee3f(0x1d2)])(_0x3005b1,this[_0x25ee3f(0x18e)]);if(_0x190762[_0x25ee3f(0x1a6)]!==this[_0x25ee3f(0x1ac)][_0x25ee3f(0x1a6)])throw new Error(_0x25ee3f(0x13e));return _0x190762['map'](_0xd9eb9f=>_0xd9eb9f[_0x25ee3f(0x1bb)][_0x25ee3f(0x1d4)]);}async['createZip'](_0x1427a3){const _0xbfea1b=a390_0xb8f6a2;this[_0xbfea1b(0x1b9)][_0xbfea1b(0x176)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x16afcc=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x1427a3,'deploymentName':this[_0xbfea1b(0x149)]})[_0xbfea1b(0x1b7)](),_0x2a4b69=this[_0xbfea1b(0x177)]+'/'+(0x0,shortid_1[_0xbfea1b(0x1c1)])()+_0xbfea1b(0x1dd);return await(0x0,promises_1['writeFile'])(_0x2a4b69,_0x16afcc),_0x2a4b69;}async['createVpk'](_0x27d379){const _0x3fca28=a390_0xb8f6a2;this[_0x3fca28(0x1b9)][_0x3fca28(0x176)](_0x3fca28(0x1b4));const _0x2f1bd3=await this[_0x3fca28(0x15b)]['generate'](_0x27d379),_0x3bf4e4=this['_tempFolder']+_0x3fca28(0x1c9)+_0x27d379['slice'](_0x27d379['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x3fca28(0x159)])(_0x3bf4e4,_0x2f1bd3),await this[_0x3fca28(0x15b)]['validate'](_0x3bf4e4),_0x3bf4e4;}async[a390_0xb8f6a2(0x17b)](_0x5757ff,_0x513a51){const _0x21ca4c=a390_0xb8f6a2;this[_0x21ca4c(0x1b9)][_0x21ca4c(0x176)](_0x21ca4c(0x19c));const _0x493297={'Body':Buffer[_0x21ca4c(0x180)](_0x5757ff)[_0x21ca4c(0x1d9)]('base64'),'ContentType':_0x21ca4c(0x1e1),'ParentId':this[_0x21ca4c(0x173)],'Name':_0x513a51};await this[_0x21ca4c(0x18e)][_0x21ca4c(0x167)](flosum_constants_1[_0x21ca4c(0x1ce)]['ENDPOINT_UPSERT_RECORD']+_0x21ca4c(0x169),_0x493297);}['formFlosumDeploymentResults'](_0x446fd1,_0x420aee){const _0x126c24=a390_0xb8f6a2;this[_0x126c24(0x1b9)][_0x126c24(0x176)]('Form\x20Deployment\x20Results');const _0x50e09c=_0x446fd1[_0x126c24(0x1b5)]((_0x30baab,_0x2c5586)=>_0x30baab['set']((_0x2c5586[_0x126c24(0x1a2)]+'.'+_0x2c5586[_0x126c24(0x13b)])[_0x126c24(0x19f)](),_0x2c5586),new Map());return _0x420aee[_0x126c24(0x141)](_0xc24f7c=>{const _0x226ada=_0x126c24;this[_0x226ada(0x1b9)][_0x226ada(0x176)](_0xc24f7c[_0x226ada(0x1ca)]+'.'+_0xc24f7c[_0x226ada(0x1c3)]+_0x226ada(0x1d3)+_0xc24f7c['status']);const _0x209a77=(_0xc24f7c['type']+'.'+_0xc24f7c[_0x226ada(0x1c3)])[_0x226ada(0x19f)](),_0x16d09d=_0x50e09c[_0x226ada(0x1b2)](_0x209a77);return{[constants_1[_0x226ada(0x1cd)]+'Type__c']:_0x226ada(0x1cf),[constants_1[_0x226ada(0x1cd)]+_0x226ada(0x17a)]:_0xc24f7c[_0x226ada(0x1aa)]===status_enums_1[_0x226ada(0x1b3)][_0x226ada(0x1a4)]?_0x226ada(0x189):_0x226ada(0x14e),[constants_1[_0x226ada(0x1cd)]+'Result__c']:_0xc24f7c[_0x226ada(0x164)],[constants_1[_0x226ada(0x1cd)]+_0x226ada(0x158)]:_0xc24f7c[_0x226ada(0x1c3)],[constants_1[_0x226ada(0x1cd)]+_0x226ada(0x14f)]:_0xc24f7c[_0x226ada(0x1ca)],[constants_1['FLOSUM_NAMESPACE']+_0x226ada(0x1c7)]:_0xc24f7c[_0x226ada(0x14d)],[constants_1[_0x226ada(0x1cd)]+'Org__c']:this[_0x226ada(0x1d6)],[constants_1[_0x226ada(0x1cd)]+_0x226ada(0x15e)]:this[_0x226ada(0x173)],[constants_1[_0x226ada(0x1cd)]+_0x226ada(0x1a3)]:_0x16d09d[_0x226ada(0x1dc)]};});}async[a390_0xb8f6a2(0x15f)](_0x563cab){const _0x3cb795=a390_0xb8f6a2;this[_0x3cb795(0x1b9)]['log'](_0x3cb795(0x188));const _0x4adea9=await this[_0x3cb795(0x1a9)][_0x3cb795(0x181)](constants_1[_0x3cb795(0x1cd)]+'Deployment_Result__c',_0x563cab),_0x2dcc50=_0x4adea9[_0x3cb795(0x13a)](_0x32ce8=>!_0x32ce8[_0x3cb795(0x18b)])[_0x3cb795(0x141)](_0x3a7550=>_0x3a7550[_0x3cb795(0x150)])[_0x3cb795(0x142)]();if(_0x2dcc50['length'])throw new salesforce_dml_error_1[(_0x3cb795(0x172))](_0x2dcc50);}async[a390_0xb8f6a2(0x1d1)](_0x40a621){const _0x4de4c7=a390_0xb8f6a2;this[_0x4de4c7(0x1b9)][_0x4de4c7(0x161)](_0x40a621),await this[_0x4de4c7(0x1b9)][_0x4de4c7(0x1a7)](),await this[_0x4de4c7(0x15d)](![],!![],'');}async[a390_0xb8f6a2(0x15d)](_0x5655a4,_0x538c88,_0x4a7f2e){const _0x2600e1=a390_0xb8f6a2,_0x5658e5=_0x2600e1(0x1c2)+this[_0x2600e1(0x1ba)]+'/'+this[_0x2600e1(0x173)]+_0x2600e1(0x1cc)+'Veeva\x20Deployment'+_0x2600e1(0x1d8),_0x3f938c=_0x2600e1(0x1c2)+this[_0x2600e1(0x1ba)]+'/'+this[_0x2600e1(0x1d6)]+'\x20>'+this[_0x2600e1(0x186)]+'</a>',_0x38bc3f=_0x5658e5+_0x2600e1(0x197)+_0x3f938c+_0x2600e1(0x13f),_0x4f8fc2={[constants_1[_0x2600e1(0x1cd)]+_0x2600e1(0x14c)]:_0x38bc3f,[constants_1[_0x2600e1(0x1cd)]+_0x2600e1(0x148)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x2600e1(0x175)]:this[_0x2600e1(0x18d)],[constants_1[_0x2600e1(0x1cd)]+'Activity_Item__c']:_0x2600e1(0x170),[constants_1['FLOSUM_NAMESPACE']+_0x2600e1(0x187)]:_0x2600e1(0x15c),[constants_1['FLOSUM_NAMESPACE']+_0x2600e1(0x1bd)]:this[_0x2600e1(0x1d6)]},_0x389210={[constants_1[_0x2600e1(0x1cd)]+_0x2600e1(0x1b8)]:!_0x5655a4,[constants_1['FLOSUM_NAMESPACE']+_0x2600e1(0x1c8)]:_0x5655a4,[constants_1[_0x2600e1(0x1cd)]+_0x2600e1(0x17a)]:_0x538c88?status_enums_1[_0x2600e1(0x1c4)][_0x2600e1(0x16c)]:status_enums_1[_0x2600e1(0x1c4)][_0x2600e1(0x160)],[constants_1['FLOSUM_NAMESPACE']+_0x2600e1(0x17c)]:!![],[constants_1[_0x2600e1(0x1cd)]+_0x2600e1(0x13c)]:_0x4a7f2e};await this[_0x2600e1(0x18e)][_0x2600e1(0x199)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x2600e1(0x157)+this[_0x2600e1(0x173)],_0x389210),await this[_0x2600e1(0x18e)]['post'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x2600e1(0x1cd)]+_0x2600e1(0x1bf),_0x4f8fc2),this[_0x2600e1(0x1b9)][_0x2600e1(0x176)](_0x2600e1(0x191)+(_0x5655a4?_0x2600e1(0x178):_0x2600e1(0x1db))+'.'),await this[_0x2600e1(0x1b9)][_0x2600e1(0x1a7)]();}}exports[a390_0xb8f6a2(0x1b6)]=DeployService;