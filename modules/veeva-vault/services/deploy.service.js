const a358_0x46d755=a358_0x2fb6;function a358_0x26e0(){const _0x3ac296=['createBackup','successfully','packageId','map','PackageComponentStatus','Logger','Backup','constructor','Form\x20Deployment\x20Results','SalesforceService','saveDeploymentResults','_deploymentName','error','Save\x20Backup\x20to\x20Salesforce','803KsKQUl','export','Veeva_Step_Name__c','Component_History__c','_connectionVeeva','Activity_Type__c','slice','isDeployed','FlosumConstants','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','createZip','catch','Metadata_Log__c','Component_Name__c','search','VeevaService','_veevaService','\x20has\x20been\x20created.','Action__c','BACKUP_ZIP_NAME','_systemLogger','../constants/flosum.constants','formFlosumDeploymentResults','saveLog','SalesforceDmlError','values','Component_Type__c','has','_componentIdList','Metadata_Log__c/','fs/promises','\x20:\x20','Body','_organisationId','54927LwKBVU','Date__c','veeva-deploy','_tempFolder','ENDPOINT_UPSERT_RECORD','VpkService','PackageImportService','text/plain','</a>','\x20>\x20','shortid','_attachmentLogId','success','validate','type','ZipCreatorDeploy','108RMDzuB','Branch','updateLog','execute','Cannot\x20retrievers\x20all\x20attachments','../../../constants','componentIdList','Deployment_Result__c','EXCEPTION','<a\x20href=','DEPLOYED','_vpkService','errors','/Attachment','Type__c','default','_packageExportService','organisationName','./package-import.service','_packageImportService','getFlosumComponents','saveBackup','deploymentAction','Activity_Item__c','\x20</a>','_timeZone','writeFile','name','componentHistoryId','from','Deployment\x20Result','Save\x20Deployment\x20Results','post','__esModule','Join\x20all\x20mdl\x20into\x20one\x20zip','defineProperty','Cannot\x20Backup\x20more\x20than\x20200\x20components.','deploymentName','./package-export.service','3908950GGNPMP','Job_Completed__c','TargetId__c','72fSfPaL','../classes/deploy/zip-creator.deploy','4855710UmQjgY','Result__c','reduce','_connectionSalesforce','length','timeZone','_instanceUrl','filter','../../shared/utils/fetch-attachments','componentType','../../../core','(((.+)+)+)+$','status','generate','Cannot\x20retrieve\x20all\x20components.','createVpk','retrieve','PackageExportService','_metadataLogId','Retrieving\x20attachments','jszip','DeployService','FLOSUM_NAMESPACE','_branchId','_logger','retrieveAttachments','Deployment','Veeva\x20Deployment','1948464RGIGRp','_salesforceService','_organisationName','Is_Error__c','fetchAttachmentsDetailsByParentId','__importDefault','get','apply','flat','367388KmTkCt','Retrieving\x20components','log','Succeed__c','logError','bind','949806wNfugC','toLowerCase','organisationId','stepName','set','1774hisLWh','Status__c','Deploy\x20completed\x20','../enums/status.enums','finishDeployWithError','toString','Success','COMPLETED','./vpk.service','Branch__c','Org__c','finishDeploy','application/zip'];a358_0x26e0=function(){return _0x3ac296;};return a358_0x26e0();}(function(_0x2237b3,_0xd3cc01){const _0x19af60=a358_0x2fb6,_0x23b013=_0x2237b3();while(!![]){try{const _0x36fc18=parseInt(_0x19af60(0x1e3))/0x1*(parseInt(_0x19af60(0x1c8))/0x2)+-parseInt(_0x19af60(0x205))/0x3*(-parseInt(_0x19af60(0x215))/0x4)+-parseInt(_0x19af60(0x193))/0x5+-parseInt(_0x19af60(0x1b4))/0x6+parseInt(_0x19af60(0x1bd))/0x7+parseInt(_0x19af60(0x196))/0x8*(parseInt(_0x19af60(0x1c3))/0x9)+-parseInt(_0x19af60(0x198))/0xa;if(_0x36fc18===_0xd3cc01)break;else _0x23b013['push'](_0x23b013['shift']());}catch(_0x297f87){_0x23b013['push'](_0x23b013['shift']());}}}(a358_0x26e0,0x96955));const a358_0x4cd4ac=(function(){let _0x550532=!![];return function(_0x529ec1,_0x331c9f){const _0x1046ac=_0x550532?function(){const _0x44a72a=a358_0x2fb6;if(_0x331c9f){const _0x427952=_0x331c9f[_0x44a72a(0x1bb)](_0x529ec1,arguments);return _0x331c9f=null,_0x427952;}}:function(){};return _0x550532=![],_0x1046ac;};}()),a358_0x6217ac=a358_0x4cd4ac(this,function(){const _0x45e9a6=a358_0x2fb6;return a358_0x6217ac[_0x45e9a6(0x1cd)]()[_0x45e9a6(0x1f1)](_0x45e9a6(0x1a3))[_0x45e9a6(0x1cd)]()[_0x45e9a6(0x1dc)](a358_0x6217ac)[_0x45e9a6(0x1f1)](_0x45e9a6(0x1a3));});a358_0x6217ac();'use strict';function a358_0x2fb6(_0xd98c46,_0x58b8ba){const _0x3aa88d=a358_0x26e0();return a358_0x2fb6=function(_0x6217ac,_0x4cd4ac){_0x6217ac=_0x6217ac-0x192;let _0x26e077=_0x3aa88d[_0x6217ac];return _0x26e077;},a358_0x2fb6(_0xd98c46,_0x58b8ba);}var __importDefault=this&&this[a358_0x46d755(0x1b9)]||function(_0x351951){const _0x6a26d1=a358_0x46d755;return _0x351951&&_0x351951[_0x6a26d1(0x236)]?_0x351951:{'default':_0x351951};};Object[a358_0x46d755(0x238)](exports,a358_0x46d755(0x236),{'value':!![]}),exports[a358_0x46d755(0x1ad)]=void 0x0;const jszip_1=__importDefault(require(a358_0x46d755(0x1ac))),promises_1=require(a358_0x46d755(0x201)),constants_1=require(a358_0x46d755(0x21a)),flosum_constants_1=require(a358_0x46d755(0x1f8)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),core_1=require(a358_0x46d755(0x1a2)),status_enums_1=require(a358_0x46d755(0x1cb)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a358_0x46d755(0x20f))),fetch_attachments_1=require(a358_0x46d755(0x1a0)),package_import_service_1=require(a358_0x46d755(0x227)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a358_0x46d755(0x1ec)),package_export_service_1=require(a358_0x46d755(0x192)),vpk_service_1=require(a358_0x46d755(0x1d0)),zip_creator_deploy_1=require(a358_0x46d755(0x197));class DeployService{constructor(_0x6deb8,_0x47357e,_0x593e2d,_0x155ddd,_0x4f51ec,_0x70c472){const _0x320eaf=a358_0x46d755;this[_0x320eaf(0x19b)]=_0x47357e,this[_0x320eaf(0x1e7)]=_0x593e2d,this[_0x320eaf(0x1b0)]=_0x155ddd,this['_tempFolder']=_0x4f51ec,this['_instanceUrl']=_0x70c472,this[_0x320eaf(0x1af)]=_0x6deb8['branchId'],this[_0x320eaf(0x1aa)]=_0x6deb8['metadataLogId'],this[_0x320eaf(0x210)]=_0x6deb8['attachmentLogId'],this[_0x320eaf(0x204)]=_0x6deb8[_0x320eaf(0x1c5)],this[_0x320eaf(0x22e)]=_0x6deb8[_0x320eaf(0x19d)],this[_0x320eaf(0x1b6)]=_0x6deb8[_0x320eaf(0x226)],this[_0x320eaf(0x1ff)]=_0x6deb8[_0x320eaf(0x21b)],this[_0x320eaf(0x1e0)]=_0x6deb8[_0x320eaf(0x23a)],this['_systemLogger']=new core_1[(_0x320eaf(0x1da))](_0x320eaf(0x207)),this[_0x320eaf(0x1f3)]=new veeva_service_1[(_0x320eaf(0x1f2))]({'connection':this[_0x320eaf(0x1e7)],'logger':this[_0x320eaf(0x1b0)]}),this[_0x320eaf(0x1b5)]=new salesforce_service_1[(_0x320eaf(0x1de))]({'connection':this[_0x320eaf(0x19b)]}),this[_0x320eaf(0x228)]=new package_import_service_1[(_0x320eaf(0x20b))]({'veevaService':this[_0x320eaf(0x1f3)],'connection':this[_0x320eaf(0x1e7)],'logger':this[_0x320eaf(0x1b0)],'saveLog':this[_0x320eaf(0x1fa)][_0x320eaf(0x1c2)](this)}),this[_0x320eaf(0x225)]=new package_export_service_1[(_0x320eaf(0x1a9))]({'veevaService':this[_0x320eaf(0x1f3)],'connection':this[_0x320eaf(0x1e7)],'logger':this['_logger']}),this['_vpkService']=new vpk_service_1[(_0x320eaf(0x20a))]({'connection':this['_connectionVeeva']});}async[a358_0x46d755(0x218)](){const _0x27c7ad=a358_0x46d755;try{const _0xeb3509=await this[_0x27c7ad(0x229)]();await this['_logger'][_0x27c7ad(0x217)]();const _0x3272ec=await this[_0x27c7ad(0x1d5)](_0xeb3509);await this['saveBackup'](_0x3272ec);const _0x3c942f=await this[_0x27c7ad(0x1b1)](_0xeb3509),_0x267046=await this[_0x27c7ad(0x1ed)](_0x3c942f),_0x2bfe63=await this[_0x27c7ad(0x1a7)](_0x267046);await this[_0x27c7ad(0x1b0)][_0x27c7ad(0x217)]();const _0x2cb760=await this[_0x27c7ad(0x228)]['import'](_0x2bfe63);await this[_0x27c7ad(0x1b0)][_0x27c7ad(0x217)]();const _0x4767f3=this[_0x27c7ad(0x1f9)](_0xeb3509,_0x2cb760['packageComponentList']);await this['saveDeploymentResults'](_0x4767f3),await this[_0x27c7ad(0x1d3)](_0x2cb760[_0x27c7ad(0x1ea)],![],_0x2cb760[_0x27c7ad(0x1d7)]);}catch(_0x58994c){await this[_0x27c7ad(0x1cc)](_0x58994c)[_0x27c7ad(0x1ee)](_0x1f70d1=>this[_0x27c7ad(0x1f7)][_0x27c7ad(0x1e1)](_0x1f70d1));}}async[a358_0x46d755(0x229)](){const _0x28580d=a358_0x46d755,_0x25c80e=new Set(this[_0x28580d(0x1ff)]);this[_0x28580d(0x1b0)][_0x28580d(0x1bf)](_0x28580d(0x1be));const _0x302972=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x28580d(0x1af)],'salesforceService':this[_0x28580d(0x1b5)]})[_0x28580d(0x1a8)](),_0xd9af4d=_0x302972[_0x28580d(0x19f)](_0x2a0de0=>_0x25c80e[_0x28580d(0x1fe)](_0x2a0de0['id']));if(_0xd9af4d['length']!==this['_componentIdList'][_0x28580d(0x19c)])throw new Error(_0x28580d(0x1a6));return _0xd9af4d;}async[a358_0x46d755(0x1d5)](_0x38d184){const _0xb42673=a358_0x46d755;var _0x461de2;this[_0xb42673(0x1b0)][_0xb42673(0x1bf)]('Create\x20Backup');const _0xc33a6c=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x38d184,'veevaService':this[_0xb42673(0x1f3)],'logger':this[_0xb42673(0x1b0)]})['retrieve'](),_0x39c942=await this['_packageExportService'][_0xb42673(0x1e4)](_0xc33a6c,_0xb42673(0x1db));if(_0x39c942[_0xb42673(0x19c)]>0x1)throw new Error(_0xb42673(0x239));return(_0x461de2=_0x39c942[0x0])!==null&&_0x461de2!==void 0x0?_0x461de2:_0x39c942[0x0]=new jszip_1[(_0xb42673(0x224))](),_0x39c942[0x0]['generateAsync']({'type':'base64'});}async[a358_0x46d755(0x22a)](_0xb41499){const _0x9ac94c=a358_0x46d755;this[_0x9ac94c(0x1b0)][_0x9ac94c(0x1bf)](_0x9ac94c(0x1e2));const _0x444745={'Body':_0xb41499,'ContentType':_0x9ac94c(0x1d4),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x9ac94c(0x1eb)][_0x9ac94c(0x1f6)]};await this['_connectionSalesforce'][_0x9ac94c(0x235)](flosum_constants_1[_0x9ac94c(0x1eb)]['ENDPOINT_UPSERT_RECORD']+_0x9ac94c(0x222),_0x444745);}async['retrieveAttachments'](_0x1150df){const _0x5e9e37=a358_0x46d755;this[_0x5e9e37(0x1b0)][_0x5e9e37(0x1bf)](_0x5e9e37(0x1ab));const _0x593215=await(0x0,fetch_attachments_1[_0x5e9e37(0x1b8)])(this[_0x5e9e37(0x19b)],_0x1150df[_0x5e9e37(0x1d8)](_0x1904ab=>_0x1904ab[_0x5e9e37(0x231)])),_0x486d7f=await(0x0,fetch_attachments_1[_0x5e9e37(0x1b1)])(_0x593215,this[_0x5e9e37(0x19b)]);if(_0x486d7f[_0x5e9e37(0x19c)]!==this[_0x5e9e37(0x1ff)][_0x5e9e37(0x19c)])throw new Error(_0x5e9e37(0x219));return _0x486d7f[_0x5e9e37(0x1d8)](_0x465ca7=>_0x465ca7[_0x5e9e37(0x1fc)][_0x5e9e37(0x203)]);}async[a358_0x46d755(0x1ed)](_0x3c5141){const _0x3cbee0=a358_0x46d755;this[_0x3cbee0(0x1b0)][_0x3cbee0(0x1bf)](_0x3cbee0(0x237));const _0x2366e7=await new zip_creator_deploy_1[(_0x3cbee0(0x214))]({'attachmentBodies':_0x3c5141,'deploymentName':this[_0x3cbee0(0x1e0)]})['execute'](),_0x175134=this[_0x3cbee0(0x208)]+'/'+(0x0,shortid_1[_0x3cbee0(0x224)])()+'.zip';return await(0x0,promises_1[_0x3cbee0(0x22f)])(_0x175134,_0x2366e7),_0x175134;}async[a358_0x46d755(0x1a7)](_0x2d9d51){const _0x45d22b=a358_0x46d755;this[_0x45d22b(0x1b0)][_0x45d22b(0x1bf)]('Create\x20vpk\x20package');const _0x3f9af8=await this[_0x45d22b(0x220)][_0x45d22b(0x1a5)](_0x2d9d51),_0xb7bf67=this[_0x45d22b(0x208)]+'/vpk__'+_0x2d9d51[_0x45d22b(0x1e9)](_0x2d9d51['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0xb7bf67,_0x3f9af8),await this['_vpkService'][_0x45d22b(0x212)](_0xb7bf67),_0xb7bf67;}async[a358_0x46d755(0x1fa)](_0x57932c,_0x3f0417){const _0x51aa21=a358_0x46d755;this[_0x51aa21(0x1b0)][_0x51aa21(0x1bf)]('Save\x20log');const _0x258cdb={'Body':Buffer[_0x51aa21(0x232)](_0x57932c)[_0x51aa21(0x1cd)]('base64'),'ContentType':_0x51aa21(0x20c),'ParentId':this[_0x51aa21(0x1aa)],'Name':_0x3f0417};await this[_0x51aa21(0x19b)][_0x51aa21(0x235)](flosum_constants_1[_0x51aa21(0x1eb)][_0x51aa21(0x209)]+_0x51aa21(0x222),_0x258cdb);}[a358_0x46d755(0x1f9)](_0x1a421c,_0x579b76){const _0x3ebaa3=a358_0x46d755;this['_logger'][_0x3ebaa3(0x1bf)](_0x3ebaa3(0x1dd));const _0x59e337=_0x1a421c[_0x3ebaa3(0x19a)]((_0x330d71,_0x538cbf)=>_0x330d71[_0x3ebaa3(0x1c7)]((_0x538cbf[_0x3ebaa3(0x1a1)]+'.'+_0x538cbf['componentName'])['toLowerCase'](),_0x538cbf),new Map());return _0x579b76[_0x3ebaa3(0x1d8)](_0x1ded39=>{const _0x3aa7d7=_0x3ebaa3;this[_0x3aa7d7(0x1b0)][_0x3aa7d7(0x1bf)](_0x1ded39[_0x3aa7d7(0x213)]+'.'+_0x1ded39['name']+_0x3aa7d7(0x202)+_0x1ded39[_0x3aa7d7(0x1a4)]);const _0x2a3dc1=(_0x1ded39['type']+'.'+_0x1ded39[_0x3aa7d7(0x230)])[_0x3aa7d7(0x1c4)](),_0x3ea520=_0x59e337[_0x3aa7d7(0x1ba)](_0x2a3dc1);return{[constants_1[_0x3aa7d7(0x1ae)]+_0x3aa7d7(0x223)]:_0x3aa7d7(0x233),[constants_1[_0x3aa7d7(0x1ae)]+'Status__c']:_0x1ded39[_0x3aa7d7(0x1a4)]===status_enums_1[_0x3aa7d7(0x1d9)][_0x3aa7d7(0x21f)]?_0x3aa7d7(0x1ce):'Failure',[constants_1[_0x3aa7d7(0x1ae)]+_0x3aa7d7(0x199)]:_0x1ded39[_0x3aa7d7(0x22b)],[constants_1['FLOSUM_NAMESPACE']+_0x3aa7d7(0x1f0)]:_0x1ded39[_0x3aa7d7(0x230)],[constants_1[_0x3aa7d7(0x1ae)]+_0x3aa7d7(0x1fd)]:_0x1ded39['type'],[constants_1[_0x3aa7d7(0x1ae)]+_0x3aa7d7(0x1e5)]:_0x1ded39[_0x3aa7d7(0x1c6)],[constants_1['FLOSUM_NAMESPACE']+_0x3aa7d7(0x1d2)]:this['_organisationId'],[constants_1[_0x3aa7d7(0x1ae)]+_0x3aa7d7(0x1ef)]:this[_0x3aa7d7(0x1aa)],[constants_1[_0x3aa7d7(0x1ae)]+_0x3aa7d7(0x1e6)]:_0x3ea520[_0x3aa7d7(0x231)]};});}async[a358_0x46d755(0x1df)](_0x5c293c){const _0x30b402=a358_0x46d755;this[_0x30b402(0x1b0)][_0x30b402(0x1bf)](_0x30b402(0x234));const _0x33864c=await this[_0x30b402(0x1b5)]['insertMultipleRecords'](constants_1[_0x30b402(0x1ae)]+_0x30b402(0x21c),_0x5c293c),_0x3187c3=_0x33864c[_0x30b402(0x19f)](_0x46b9a0=>!_0x46b9a0[_0x30b402(0x211)])[_0x30b402(0x1d8)](_0x3584eb=>_0x3584eb[_0x30b402(0x221)])[_0x30b402(0x1bc)]();if(_0x3187c3[_0x30b402(0x19c)])throw new salesforce_dml_error_1[(_0x30b402(0x1fb))](_0x3187c3);}async[a358_0x46d755(0x1cc)](_0x3a9933){const _0x116078=a358_0x46d755;this['_logger'][_0x116078(0x1c1)](_0x3a9933),await this[_0x116078(0x1b0)][_0x116078(0x217)](),await this[_0x116078(0x1d3)](![],!![],'');}async[a358_0x46d755(0x1d3)](_0x20b68a,_0x38c71e,_0x5bda78){const _0x4364f5=a358_0x46d755,_0x1f1a15=_0x4364f5(0x21e)+this[_0x4364f5(0x19e)]+'/'+this[_0x4364f5(0x1aa)]+_0x4364f5(0x20e)+_0x4364f5(0x1b3)+_0x4364f5(0x22d),_0x5df126=_0x4364f5(0x21e)+this[_0x4364f5(0x19e)]+'/'+this[_0x4364f5(0x204)]+'\x20>'+this[_0x4364f5(0x1b6)]+_0x4364f5(0x20d),_0x3ada68=_0x1f1a15+'\x20of\x20branch\x20to\x20Organization\x20'+_0x5df126+_0x4364f5(0x1f4),_0x1a42fa={[constants_1['FLOSUM_NAMESPACE']+_0x4364f5(0x1f5)]:_0x3ada68,[constants_1[_0x4364f5(0x1ae)]+_0x4364f5(0x206)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x4364f5(0x1d1)]:this['_branchId'],[constants_1[_0x4364f5(0x1ae)]+_0x4364f5(0x22c)]:_0x4364f5(0x216),[constants_1[_0x4364f5(0x1ae)]+_0x4364f5(0x1e8)]:_0x4364f5(0x1b2),[constants_1['FLOSUM_NAMESPACE']+_0x4364f5(0x195)]:this[_0x4364f5(0x204)]},_0x459579={[constants_1[_0x4364f5(0x1ae)]+_0x4364f5(0x1b7)]:!_0x20b68a,[constants_1[_0x4364f5(0x1ae)]+_0x4364f5(0x1c0)]:_0x20b68a,[constants_1['FLOSUM_NAMESPACE']+_0x4364f5(0x1c9)]:_0x38c71e?status_enums_1['MetadataLogStatus'][_0x4364f5(0x21d)]:status_enums_1['MetadataLogStatus'][_0x4364f5(0x1cf)],[constants_1[_0x4364f5(0x1ae)]+_0x4364f5(0x194)]:!![],[constants_1[_0x4364f5(0x1ae)]+'Async_Request_Id__c']:_0x5bda78};await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x4364f5(0x1eb)][_0x4364f5(0x209)]+'/'+constants_1[_0x4364f5(0x1ae)]+_0x4364f5(0x200)+this[_0x4364f5(0x1aa)],_0x459579),await this['_connectionSalesforce']['post'](flosum_constants_1['FlosumConstants'][_0x4364f5(0x209)]+'/'+constants_1[_0x4364f5(0x1ae)]+'Log__c',_0x1a42fa),this[_0x4364f5(0x1b0)][_0x4364f5(0x1bf)](_0x4364f5(0x1ca)+(_0x20b68a?_0x4364f5(0x1d6):'with\x20error')+'.'),await this[_0x4364f5(0x1b0)][_0x4364f5(0x217)]();}}exports[a358_0x46d755(0x1ad)]=DeployService;