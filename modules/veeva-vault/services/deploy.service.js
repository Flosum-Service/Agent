const a402_0x29e057=a402_0x8a52;(function(_0x445de3,_0x3e46f9){const _0x510527=a402_0x8a52,_0x4b1a7a=_0x445de3();while(!![]){try{const _0x25a43c=parseInt(_0x510527(0x221))/0x1*(parseInt(_0x510527(0x1b4))/0x2)+parseInt(_0x510527(0x1de))/0x3+parseInt(_0x510527(0x1f5))/0x4+parseInt(_0x510527(0x1d8))/0x5+-parseInt(_0x510527(0x213))/0x6+parseInt(_0x510527(0x228))/0x7+-parseInt(_0x510527(0x1f1))/0x8*(parseInt(_0x510527(0x19f))/0x9);if(_0x25a43c===_0x3e46f9)break;else _0x4b1a7a['push'](_0x4b1a7a['shift']());}catch(_0x368517){_0x4b1a7a['push'](_0x4b1a7a['shift']());}}}(a402_0xc9a7,0x29a69));const a402_0x4c7ba6=(function(){let _0x32f1d1=!![];return function(_0x429cdc,_0x25406d){const _0x129aa9=_0x32f1d1?function(){const _0x43ac87=a402_0x8a52;if(_0x25406d){const _0x4701b3=_0x25406d[_0x43ac87(0x1bc)](_0x429cdc,arguments);return _0x25406d=null,_0x4701b3;}}:function(){};return _0x32f1d1=![],_0x129aa9;};}()),a402_0x2805ad=a402_0x4c7ba6(this,function(){const _0x3e9454=a402_0x8a52;return a402_0x2805ad[_0x3e9454(0x20e)]()[_0x3e9454(0x1ca)](_0x3e9454(0x1b5))[_0x3e9454(0x20e)]()[_0x3e9454(0x1d7)](a402_0x2805ad)[_0x3e9454(0x1ca)](_0x3e9454(0x1b5));});a402_0x2805ad();'use strict';function a402_0x8a52(_0x15d479,_0x374c70){const _0x31eff7=a402_0xc9a7();return a402_0x8a52=function(_0x2805ad,_0x4c7ba6){_0x2805ad=_0x2805ad-0x19a;let _0xc9a7a=_0x31eff7[_0x2805ad];return _0xc9a7a;},a402_0x8a52(_0x15d479,_0x374c70);}var __importDefault=this&&this[a402_0x29e057(0x210)]||function(_0x525b93){return _0x525b93&&_0x525b93['__esModule']?_0x525b93:{'default':_0x525b93};};Object[a402_0x29e057(0x216)](exports,a402_0x29e057(0x21d),{'value':!![]}),exports[a402_0x29e057(0x201)]=void 0x0;const jszip_1=__importDefault(require(a402_0x29e057(0x1c9))),promises_1=require(a402_0x29e057(0x1cc)),constants_1=require(a402_0x29e057(0x1e5)),flosum_constants_1=require(a402_0x29e057(0x1a8)),veeva_service_1=require(a402_0x29e057(0x1d6)),salesforce_service_1=require(a402_0x29e057(0x233)),core_1=require(a402_0x29e057(0x1eb)),status_enums_1=require(a402_0x29e057(0x1fb)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a402_0x29e057(0x217))),fetch_attachments_1=require(a402_0x29e057(0x19a)),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a402_0x29e057(0x20f)),flosum_component_veeva_component_retriever_1=require(a402_0x29e057(0x1fe)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a402_0x29e057(0x1d5)),zip_creator_deploy_1=require(a402_0x29e057(0x1a6));class DeployService{constructor(_0x503283,_0x5e9716,_0x413db5,_0x54b6e0,_0x1be90d,_0x59d8b1){const _0x399eae=a402_0x29e057;this[_0x399eae(0x22d)]=_0x5e9716,this['_connectionVeeva']=_0x413db5,this[_0x399eae(0x1a3)]=_0x54b6e0,this[_0x399eae(0x21b)]=_0x1be90d,this[_0x399eae(0x1b6)]=_0x59d8b1,this[_0x399eae(0x1dc)]=_0x503283['branchId'],this[_0x399eae(0x1f3)]=_0x503283[_0x399eae(0x234)],this['_attachmentLogId']=_0x503283[_0x399eae(0x1d3)],this[_0x399eae(0x1fd)]=_0x503283['organisationId'],this[_0x399eae(0x1b0)]=_0x503283['timeZone'],this['_organisationName']=_0x503283[_0x399eae(0x1c6)],this[_0x399eae(0x1c8)]=_0x503283[_0x399eae(0x1aa)],this[_0x399eae(0x1ee)]=_0x503283[_0x399eae(0x1d2)],this['_systemLogger']=new core_1[(_0x399eae(0x1d1))](_0x399eae(0x218)),this[_0x399eae(0x1cd)]=new veeva_service_1['VeevaService']({'connection':this[_0x399eae(0x1f0)],'logger':this[_0x399eae(0x1a3)]}),this[_0x399eae(0x1db)]=new salesforce_service_1['SalesforceService']({'connection':this['_connectionSalesforce']}),this[_0x399eae(0x223)]=new package_import_service_1[(_0x399eae(0x1b9))]({'veevaService':this[_0x399eae(0x1cd)],'connection':this[_0x399eae(0x1f0)],'logger':this[_0x399eae(0x1a3)],'saveLog':this[_0x399eae(0x1ba)][_0x399eae(0x1fc)](this)}),this[_0x399eae(0x22a)]=new package_export_service_1[(_0x399eae(0x1e3))]({'veevaService':this[_0x399eae(0x1cd)],'connection':this['_connectionVeeva'],'logger':this[_0x399eae(0x1a3)]}),this[_0x399eae(0x1c1)]=new vpk_service_1[(_0x399eae(0x1e2))]({'connection':this[_0x399eae(0x1f0)]});}async[a402_0x29e057(0x22b)](){const _0x242557=a402_0x29e057;try{const _0x256a65=await this['getFlosumComponents']();await this['_logger'][_0x242557(0x209)]();const _0x555a89=await this[_0x242557(0x1ff)](_0x256a65);await this['saveBackup'](_0x555a89);const _0x18fdb8=await this[_0x242557(0x222)](_0x256a65),_0x17ccce=await this[_0x242557(0x231)](_0x18fdb8),_0x529195=await this[_0x242557(0x1ac)](_0x17ccce);await this['_logger'][_0x242557(0x209)]();const _0x65b27e=await this['_packageImportService']['import'](_0x529195);await this[_0x242557(0x1a3)]['updateLog']();const _0xced9cc=this[_0x242557(0x237)](_0x256a65,_0x65b27e['packageComponentList']);await this[_0x242557(0x21e)](_0xced9cc),await this[_0x242557(0x1b7)](_0x65b27e[_0x242557(0x1df)],![],_0x65b27e[_0x242557(0x1e8)]);}catch(_0xbaa4e3){await this['finishDeployWithError'](_0xbaa4e3)[_0x242557(0x1b3)](_0x424fa1=>this[_0x242557(0x19d)][_0x242557(0x1e1)](_0x424fa1));}}async[a402_0x29e057(0x1c3)](){const _0x83049c=a402_0x29e057,_0x171c46=new Set(this[_0x83049c(0x1c8)]);this[_0x83049c(0x1a3)][_0x83049c(0x1f7)]('Retrieving\x20components');const _0x3361bf=await new branch_component_history_flosum_component_retriever_1[(_0x83049c(0x21c))]({'value':this['_branchId'],'salesforceService':this[_0x83049c(0x1db)]})[_0x83049c(0x1c4)](),_0x2dc9cc=_0x3361bf['filter'](_0x4e8668=>_0x171c46[_0x83049c(0x1a5)](_0x4e8668['id']));if(_0x2dc9cc['length']!==this[_0x83049c(0x1c8)]['length'])throw new Error(_0x83049c(0x1ce));return _0x2dc9cc;}async[a402_0x29e057(0x1ff)](_0x476a52){const _0x536867=a402_0x29e057;var _0x3fef22;this['_logger'][_0x536867(0x1f7)](_0x536867(0x1f9));const _0x4f2a4f=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x476a52,'veevaService':this[_0x536867(0x1cd)],'logger':this[_0x536867(0x1a3)]})['retrieve'](),_0x4f0026=await this['_packageExportService'][_0x536867(0x1a2)](_0x4f2a4f,_0x536867(0x1f2));if(_0x4f0026['length']>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0x3fef22=_0x4f0026[0x0])!==null&&_0x3fef22!==void 0x0?_0x3fef22:_0x4f0026[0x0]=new jszip_1['default'](),_0x4f0026[0x0][_0x536867(0x1c2)]({'type':'base64'});}async[a402_0x29e057(0x1be)](_0x162192){const _0x29ee95=a402_0x29e057;this[_0x29ee95(0x1a3)][_0x29ee95(0x1f7)](_0x29ee95(0x225));const _0x21cbca={'Body':_0x162192,'ContentType':_0x29ee95(0x1cb),'ParentId':this[_0x29ee95(0x1f3)],'Name':flosum_constants_1[_0x29ee95(0x1b1)][_0x29ee95(0x1ad)]};await this[_0x29ee95(0x22d)]['post'](flosum_constants_1[_0x29ee95(0x1b1)][_0x29ee95(0x205)]+'/Attachment',_0x21cbca);}async[a402_0x29e057(0x222)](_0xcf8ae7){const _0x5a8f55=a402_0x29e057;this['_logger'][_0x5a8f55(0x1f7)](_0x5a8f55(0x22f));const _0x147b3f=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x5a8f55(0x22d)],_0xcf8ae7[_0x5a8f55(0x206)](_0x1ca2bc=>_0x1ca2bc[_0x5a8f55(0x1c5)])),_0x1b1518=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x147b3f,this['_connectionSalesforce']);if(_0x1b1518[_0x5a8f55(0x1da)]!==this[_0x5a8f55(0x1c8)]['length'])throw new Error(_0x5a8f55(0x1f8));return _0x1b1518[_0x5a8f55(0x206)](_0x189623=>_0x189623[_0x5a8f55(0x1ef)][_0x5a8f55(0x1cf)]);}async[a402_0x29e057(0x231)](_0x93ca3){const _0x571353=a402_0x29e057;this['_logger'][_0x571353(0x1f7)](_0x571353(0x1d0));const _0x350b19=await new zip_creator_deploy_1[(_0x571353(0x1ec))]({'attachmentBodies':_0x93ca3,'deploymentName':this[_0x571353(0x1ee)]})[_0x571353(0x22b)](),_0xf39833=this['_tempFolder']+'/'+(0x0,shortid_1[_0x571353(0x1f4)])()+'.zip';return await(0x0,promises_1[_0x571353(0x20a)])(_0xf39833,_0x350b19),_0xf39833;}async['createVpk'](_0x1b8705){const _0x45591c=a402_0x29e057;this[_0x45591c(0x1a3)]['log']('Create\x20vpk\x20package');const _0x41c5e0=await this[_0x45591c(0x1c1)]['generate'](_0x1b8705),_0x3c3226=this[_0x45591c(0x21b)]+_0x45591c(0x1a9)+_0x1b8705[_0x45591c(0x1a7)](_0x1b8705['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x45591c(0x20a)])(_0x3c3226,_0x41c5e0),await this[_0x45591c(0x1c1)][_0x45591c(0x1b8)](_0x3c3226),_0x3c3226;}async[a402_0x29e057(0x1ba)](_0x283227,_0x277599){const _0x2462b0=a402_0x29e057;this[_0x2462b0(0x1a3)][_0x2462b0(0x1f7)](_0x2462b0(0x1b2));const _0x18a1ba={'Body':Buffer['from'](_0x283227)['toString']('base64'),'ContentType':'text/plain','ParentId':this[_0x2462b0(0x1f3)],'Name':_0x277599};await this[_0x2462b0(0x22d)][_0x2462b0(0x1a4)](flosum_constants_1[_0x2462b0(0x1b1)][_0x2462b0(0x205)]+_0x2462b0(0x220),_0x18a1ba);}[a402_0x29e057(0x237)](_0x25cc4e,_0x4d9a57){const _0x523f32=a402_0x29e057;this['_logger']['log'](_0x523f32(0x215));const _0x2aa931=_0x25cc4e[_0x523f32(0x1ed)]((_0x15c3e4,_0x498cb0)=>_0x15c3e4['set']((_0x498cb0['componentType']+'.'+_0x498cb0[_0x523f32(0x202)])[_0x523f32(0x1a0)](),_0x498cb0),new Map());return _0x4d9a57[_0x523f32(0x206)](_0xced0e8=>{const _0x404028=_0x523f32;this[_0x404028(0x1a3)][_0x404028(0x1f7)](_0xced0e8[_0x404028(0x1d4)]+'.'+_0xced0e8[_0x404028(0x214)]+_0x404028(0x20d)+_0xced0e8[_0x404028(0x1c0)]);const _0x1a04a0=(_0xced0e8[_0x404028(0x1d4)]+'.'+_0xced0e8[_0x404028(0x214)])[_0x404028(0x1a0)](),_0x26d7c4=_0x2aa931[_0x404028(0x1d9)](_0x1a04a0);return{[constants_1[_0x404028(0x1bd)]+'Type__c']:_0x404028(0x211),[constants_1['FLOSUM_NAMESPACE']+_0x404028(0x232)]:_0xced0e8['status']===status_enums_1['PackageComponentStatus'][_0x404028(0x1e6)]?_0x404028(0x1bb):_0x404028(0x1bf),[constants_1[_0x404028(0x1bd)]+'Result__c']:_0xced0e8[_0x404028(0x212)],[constants_1[_0x404028(0x1bd)]+_0x404028(0x236)]:_0xced0e8[_0x404028(0x214)],[constants_1['FLOSUM_NAMESPACE']+_0x404028(0x20b)]:_0xced0e8['type'],[constants_1[_0x404028(0x1bd)]+_0x404028(0x219)]:_0xced0e8[_0x404028(0x200)],[constants_1[_0x404028(0x1bd)]+'Org__c']:this[_0x404028(0x1fd)],[constants_1[_0x404028(0x1bd)]+_0x404028(0x208)]:this[_0x404028(0x1f3)],[constants_1[_0x404028(0x1bd)]+_0x404028(0x230)]:_0x26d7c4[_0x404028(0x1c5)]};});}async[a402_0x29e057(0x21e)](_0x1b7342){const _0x2b2bf3=a402_0x29e057;this[_0x2b2bf3(0x1a3)]['log'](_0x2b2bf3(0x1a1));const _0x274ad6=await this['_salesforceService'][_0x2b2bf3(0x21a)](constants_1[_0x2b2bf3(0x1bd)]+_0x2b2bf3(0x22c),_0x1b7342),_0x56f87b=_0x274ad6['filter'](_0x3bca3b=>!_0x3bca3b[_0x2b2bf3(0x1e4)])[_0x2b2bf3(0x206)](_0x3768d9=>_0x3768d9[_0x2b2bf3(0x226)])[_0x2b2bf3(0x19e)]();if(_0x56f87b['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x56f87b);}async['finishDeployWithError'](_0x8c22bb){const _0x37de51=a402_0x29e057;this['_logger'][_0x37de51(0x20c)](_0x8c22bb),await this[_0x37de51(0x1a3)][_0x37de51(0x209)](),await this['finishDeploy'](![],!![],'');}async[a402_0x29e057(0x1b7)](_0x3fd951,_0x2ebeb1,_0x290eff){const _0x2857f5=a402_0x29e057,_0x3a522d=_0x2857f5(0x1ea)+this[_0x2857f5(0x1b6)]+'/'+this[_0x2857f5(0x1f3)]+_0x2857f5(0x1e7)+'Veeva\x20Deployment'+'\x20</a>',_0x347a52=_0x2857f5(0x1ea)+this['_instanceUrl']+'/'+this['_organisationId']+'\x20>'+this[_0x2857f5(0x227)]+_0x2857f5(0x235),_0x758cd6=_0x3a522d+_0x2857f5(0x1ab)+_0x347a52+_0x2857f5(0x1e0),_0x3949ab={[constants_1[_0x2857f5(0x1bd)]+_0x2857f5(0x1f6)]:_0x758cd6,[constants_1['FLOSUM_NAMESPACE']+_0x2857f5(0x1c7)]:new Date(),[constants_1[_0x2857f5(0x1bd)]+'Branch__c']:this[_0x2857f5(0x1dc)],[constants_1['FLOSUM_NAMESPACE']+_0x2857f5(0x19b)]:_0x2857f5(0x1ae),[constants_1[_0x2857f5(0x1bd)]+_0x2857f5(0x1af)]:_0x2857f5(0x204),[constants_1['FLOSUM_NAMESPACE']+_0x2857f5(0x203)]:this[_0x2857f5(0x1fd)]},_0x3ae1ba={[constants_1['FLOSUM_NAMESPACE']+_0x2857f5(0x207)]:!_0x3fd951,[constants_1['FLOSUM_NAMESPACE']+_0x2857f5(0x22e)]:_0x3fd951,[constants_1[_0x2857f5(0x1bd)]+_0x2857f5(0x232)]:_0x2ebeb1?status_enums_1[_0x2857f5(0x224)]['EXCEPTION']:status_enums_1[_0x2857f5(0x224)][_0x2857f5(0x21f)],[constants_1[_0x2857f5(0x1bd)]+_0x2857f5(0x19c)]:!![],[constants_1[_0x2857f5(0x1bd)]+'External_Deployment_Id__c']:_0x290eff};await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x2857f5(0x1b1)][_0x2857f5(0x205)]+'/'+constants_1[_0x2857f5(0x1bd)]+_0x2857f5(0x1e9)+this['_metadataLogId'],_0x3ae1ba),await this[_0x2857f5(0x22d)]['post'](flosum_constants_1[_0x2857f5(0x1b1)][_0x2857f5(0x205)]+'/'+constants_1[_0x2857f5(0x1bd)]+_0x2857f5(0x229),_0x3949ab),this[_0x2857f5(0x1a3)]['log'](_0x2857f5(0x1fa)+(_0x3fd951?_0x2857f5(0x238):_0x2857f5(0x1dd))+'.'),await this[_0x2857f5(0x1a3)][_0x2857f5(0x209)]();}}exports['DeployService']=DeployService;function a402_0xc9a7(){const _0x328d75=['Date__c','_componentIdList','jszip','search','application/zip','fs/promises','_veevaService','Cannot\x20retrieve\x20all\x20components.','Body','Join\x20all\x20mdl\x20into\x20one\x20zip','Logger','deploymentName','attachmentLogId','type','./vpk.service','./veeva.service','constructor','450610ZysMsD','get','length','_salesforceService','_branchId','with\x20error','463839aiZGjs','isDeployed','\x20has\x20been\x20created.','error','VpkService','PackageExportService','success','../../../constants','DEPLOYED','\x20>\x20','packageId','Metadata_Log__c/','<a\x20href=','../../../core','ZipCreatorDeploy','reduce','_deploymentName','values','_connectionVeeva','1528Oshnxj','Backup','_metadataLogId','default','1079312lYMRki','Action__c','log','Cannot\x20retrievers\x20all\x20attachments','Create\x20Backup','Deploy\x20completed\x20','../enums/status.enums','bind','_organisationId','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','createBackup','stepName','DeployService','componentName','TargetId__c','Deployment','ENDPOINT_UPSERT_RECORD','map','Is_Error__c','Metadata_Log__c','updateLog','writeFile','Component_Type__c','logError','\x20:\x20','toString','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','__importDefault','Deployment\x20Result','deploymentAction','1250280nsWWLf','name','Form\x20Deployment\x20Results','defineProperty','shortid','veeva-deploy','Veeva_Step_Name__c','insertMultipleRecords','_tempFolder','BranchComponentHistoryFlosumComponentRetriever','__esModule','saveDeploymentResults','COMPLETED','/Attachment','8246uFLfOs','retrieveAttachments','_packageImportService','MetadataLogStatus','Save\x20Backup\x20to\x20Salesforce','errors','_organisationName','1572494UPMKQV','Log__c','_packageExportService','execute','Deployment_Result__c','_connectionSalesforce','Succeed__c','Retrieving\x20attachments','Component_History__c','createZip','Status__c','./salesforce.service','metadataLogId','</a>','Component_Name__c','formFlosumDeploymentResults','successfully','../../shared/utils/fetch-attachments','Activity_Item__c','Job_Completed__c','_systemLogger','flat','28242bzTZql','toLowerCase','Save\x20Deployment\x20Results','export','_logger','post','has','../classes/deploy/zip-creator.deploy','slice','../constants/flosum.constants','/vpk__','componentIdList','\x20of\x20branch\x20to\x20Organization\x20','createVpk','BACKUP_ZIP_NAME','Branch','Activity_Type__c','_timeZone','FlosumConstants','Save\x20log','catch','58cZFzQd','(((.+)+)+)+$','_instanceUrl','finishDeploy','validate','PackageImportService','saveLog','Success','apply','FLOSUM_NAMESPACE','saveBackup','Failure','status','_vpkService','generateAsync','getFlosumComponents','retrieve','componentHistoryId','organisationName'];a402_0xc9a7=function(){return _0x328d75;};return a402_0xc9a7();}