const a334_0x989a47=a334_0x4887;(function(_0x3ec031,_0x471593){const _0x10b46a=a334_0x4887,_0x44aded=_0x3ec031();while(!![]){try{const _0x2f048a=-parseInt(_0x10b46a(0x123))/0x1*(parseInt(_0x10b46a(0x101))/0x2)+-parseInt(_0x10b46a(0x10a))/0x3+-parseInt(_0x10b46a(0xb5))/0x4+-parseInt(_0x10b46a(0xe2))/0x5+parseInt(_0x10b46a(0xaf))/0x6+-parseInt(_0x10b46a(0x11a))/0x7+parseInt(_0x10b46a(0xc3))/0x8;if(_0x2f048a===_0x471593)break;else _0x44aded['push'](_0x44aded['shift']());}catch(_0x56f880){_0x44aded['push'](_0x44aded['shift']());}}}(a334_0x112e,0x5017f));const a334_0x237abd=(function(){let _0x12571c=!![];return function(_0x3315b4,_0x2f573f){const _0x519a85=_0x12571c?function(){if(_0x2f573f){const _0x1ccece=_0x2f573f['apply'](_0x3315b4,arguments);return _0x2f573f=null,_0x1ccece;}}:function(){};return _0x12571c=![],_0x519a85;};}()),a334_0x209ee6=a334_0x237abd(this,function(){const _0x5aa880=a334_0x4887;return a334_0x209ee6[_0x5aa880(0xf7)]()[_0x5aa880(0x106)](_0x5aa880(0xb0))[_0x5aa880(0xf7)]()[_0x5aa880(0x9f)](a334_0x209ee6)[_0x5aa880(0x106)](_0x5aa880(0xb0));});a334_0x209ee6();'use strict';var __importDefault=this&&this[a334_0x989a47(0xc7)]||function(_0x48b2f1){const _0x107017=a334_0x989a47;return _0x48b2f1&&_0x48b2f1[_0x107017(0xf9)]?_0x48b2f1:{'default':_0x48b2f1};};function a334_0x4887(_0x4cb3c8,_0x342591){const _0x4c165b=a334_0x112e();return a334_0x4887=function(_0x209ee6,_0x237abd){_0x209ee6=_0x209ee6-0x8f;let _0x112e17=_0x4c165b[_0x209ee6];return _0x112e17;},a334_0x4887(_0x4cb3c8,_0x342591);}Object[a334_0x989a47(0xb4)](exports,a334_0x989a47(0xf9),{'value':!![]}),exports[a334_0x989a47(0xd6)]=void 0x0;const jszip_1=__importDefault(require(a334_0x989a47(0xff))),promises_1=require(a334_0x989a47(0xe8)),constants_1=require('../../../constants'),flosum_constants_1=require(a334_0x989a47(0x10b)),veeva_service_1=require(a334_0x989a47(0x12c)),salesforce_service_1=require('./salesforce.service'),core_1=require(a334_0x989a47(0x99)),status_enums_1=require(a334_0x989a47(0xbd)),salesforce_dml_error_1=require(a334_0x989a47(0xb2)),shortid_1=__importDefault(require('shortid')),xml2js_1=require(a334_0x989a47(0xde)),fetch_attachments_1=require(a334_0x989a47(0x103)),package_import_service_1=require(a334_0x989a47(0x102)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a334_0x989a47(0xf8)),vpk_service_1=require('./vpk.service');class DeployService{constructor(_0x4d2785,_0x521547,_0x24d7d1,_0x2c7fd9,_0x2da1be,_0x69ead1){const _0x283d76=a334_0x989a47;this['_connectionSalesforce']=_0x521547,this[_0x283d76(0xbe)]=_0x24d7d1,this[_0x283d76(0x126)]=_0x2c7fd9,this[_0x283d76(0x12a)]=_0x2da1be,this['_instanceUrl']=_0x69ead1,this[_0x283d76(0x91)]=_0x4d2785[_0x283d76(0x10c)],this[_0x283d76(0xb6)]=_0x4d2785[_0x283d76(0x12e)],this[_0x283d76(0xd9)]=_0x4d2785[_0x283d76(0xab)],this['_organisationId']=_0x4d2785[_0x283d76(0x111)],this['_timeZone']=_0x4d2785[_0x283d76(0x98)],this['_organisationName']=_0x4d2785[_0x283d76(0xc0)],this[_0x283d76(0x9b)]=_0x4d2785[_0x283d76(0xc4)],this['_deploymentName']=_0x4d2785['deploymentName'],this[_0x283d76(0x96)]=new core_1[(_0x283d76(0xba))](_0x283d76(0x8f)),this[_0x283d76(0x127)]=new veeva_service_1[(_0x283d76(0xd8))]({'connection':this[_0x283d76(0xbe)],'logger':this['_logger']}),this[_0x283d76(0x11d)]=new salesforce_service_1[(_0x283d76(0x129))]({'connection':this[_0x283d76(0x93)]}),this[_0x283d76(0xe9)]=new package_import_service_1[(_0x283d76(0x132))]({'veevaService':this[_0x283d76(0x127)],'connection':this[_0x283d76(0xbe)],'logger':this[_0x283d76(0x126)],'saveLog':this[_0x283d76(0xce)][_0x283d76(0xd7)](this)}),this[_0x283d76(0xa9)]=new package_export_service_1[(_0x283d76(0x130))]({'veevaService':this[_0x283d76(0x127)],'connection':this['_connectionVeeva'],'logger':this[_0x283d76(0x126)]}),this[_0x283d76(0xe0)]=new vpk_service_1[(_0x283d76(0xa3))]({'connection':this[_0x283d76(0xbe)]});}async[a334_0x989a47(0xbc)](){const _0x6a4b41=a334_0x989a47;try{const _0x1a32ec=await this[_0x6a4b41(0x131)]();await this[_0x6a4b41(0x126)][_0x6a4b41(0x10d)](),await this['createBackup'](_0x1a32ec);const _0x579e1a=await this['retrieveAttachments'](_0x1a32ec),_0x4db4c9=await this[_0x6a4b41(0xd3)](_0x579e1a),_0x2c1772=await this['createVpk'](_0x4db4c9);await this[_0x6a4b41(0x126)][_0x6a4b41(0x10d)]();const _0x604611=await this[_0x6a4b41(0xe9)]['import'](_0x2c1772);await this[_0x6a4b41(0x126)][_0x6a4b41(0x10d)]();const _0x52707f=this[_0x6a4b41(0xef)](_0x1a32ec,_0x604611[_0x6a4b41(0xc1)]);await this[_0x6a4b41(0xb8)](_0x52707f),await this[_0x6a4b41(0x124)](_0x604611['isDeployed'],![],_0x604611['packageId']);}catch(_0x161adb){await this[_0x6a4b41(0xae)](_0x161adb)[_0x6a4b41(0x113)](_0xd31ecf=>this[_0x6a4b41(0x96)][_0x6a4b41(0x12f)](_0xd31ecf));}}async[a334_0x989a47(0x131)](){const _0x36b380=a334_0x989a47,_0x1bf341=new Set(this[_0x36b380(0x9b)]);this[_0x36b380(0x126)][_0x36b380(0x100)](_0x36b380(0x9a));const _0x4623d6=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x36b380(0x91)],'salesforceService':this[_0x36b380(0x11d)]})['retrieve'](),_0x5d9e84=_0x4623d6['filter'](_0x45d30f=>_0x1bf341[_0x36b380(0xa5)](_0x45d30f['id']));if(_0x5d9e84[_0x36b380(0x9d)]!==this[_0x36b380(0x9b)][_0x36b380(0x9d)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x5d9e84;}async['createBackup'](_0x15839f){const _0x488fee=a334_0x989a47;var _0x4aa534;this['_logger'][_0x488fee(0x100)](_0x488fee(0xfa));const _0x22dcc8=await new flosum_component_veeva_component_retriever_1[(_0x488fee(0xeb))]({'value':_0x15839f,'veevaService':this[_0x488fee(0x127)],'logger':this[_0x488fee(0x126)]})[_0x488fee(0xaa)](),_0x387a9e=await this[_0x488fee(0xa9)]['export'](_0x22dcc8,_0x488fee(0x112));if(_0x387a9e[_0x488fee(0x9d)]>0x1)throw new Error(_0x488fee(0x92));(_0x4aa534=_0x387a9e[0x0])!==null&&_0x4aa534!==void 0x0?_0x4aa534:_0x387a9e[0x0]=new jszip_1[(_0x488fee(0x9e))]();const _0x5936f3=await _0x387a9e[0x0]['generateAsync']({'type':'base64'});this[_0x488fee(0x126)][_0x488fee(0x100)](_0x488fee(0xee));const _0x578dc3={'Body':_0x5936f3,'ContentType':'application/zip','ParentId':this[_0x488fee(0xb6)],'Name':flosum_constants_1['FlosumConstants'][_0x488fee(0xc6)]};await this[_0x488fee(0x93)][_0x488fee(0xbf)](flosum_constants_1[_0x488fee(0x128)][_0x488fee(0x97)]+'/Attachment',_0x578dc3),this[_0x488fee(0x126)][_0x488fee(0x100)](_0x488fee(0xd1));}async['retrieveAttachments'](_0x4a5b0e){const _0x438cbe=a334_0x989a47;this[_0x438cbe(0x126)][_0x438cbe(0x100)](_0x438cbe(0xb1));const _0x53050e=await(0x0,fetch_attachments_1[_0x438cbe(0xdb)])(this[_0x438cbe(0x93)],_0x4a5b0e['map'](_0x13b057=>_0x13b057[_0x438cbe(0x104)])),_0x24b411=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x53050e,this[_0x438cbe(0x93)]);if(_0x24b411[_0x438cbe(0x9d)]!==this['_componentIdList'][_0x438cbe(0x9d)])throw new Error(_0x438cbe(0xec));return _0x24b411[_0x438cbe(0x11e)](_0x4e274c=>_0x4e274c[_0x438cbe(0x108)][_0x438cbe(0xcb)]);}async[a334_0x989a47(0xd3)](_0xb231e4){const _0x4abcc2=a334_0x989a47;var _0x31a174;this[_0x4abcc2(0x126)][_0x4abcc2(0x100)](_0x4abcc2(0xad));const _0x3795e7=new jszip_1[(_0x4abcc2(0x9e))]();for(const _0x17ea1c of _0xb231e4){const _0x420746=new jszip_1[(_0x4abcc2(0x9e))]();await _0x420746[_0x4abcc2(0xf3)](_0x17ea1c,{'base64':!![]});for(const _0x54e281 in _0x420746[_0x4abcc2(0x121)]){const _0x1ef058=await((_0x31a174=_0x420746[_0x4abcc2(0xf1)](_0x54e281))===null||_0x31a174===void 0x0?void 0x0:_0x31a174[_0x4abcc2(0xfd)](_0x4abcc2(0x12b)));_0x1ef058&&_0x3795e7[_0x4abcc2(0xf1)](_0x54e281,_0x1ef058);}}const _0x479e61=new xml2js_1[(_0x4abcc2(0x119))]({'headless':!![]}),_0xee95ac={'vaultpackage':{'$':{'xmlns':_0x4abcc2(0xcf)},'name':this[_0x4abcc2(0x11c)],'source':{'vault':undefined,'author':_0x4abcc2(0xc5)},'packagetype':_0x4abcc2(0xcc),'summary':_0x4abcc2(0xea),'description':_0x4abcc2(0xe4)}};_0x3795e7[_0x4abcc2(0xf1)]('vaultpackage.xml',_0x479e61[_0x4abcc2(0xa6)](_0xee95ac));const _0x53ee50=this[_0x4abcc2(0x12a)]+'/'+(0x0,shortid_1['default'])()+_0x4abcc2(0x105),_0x84d588=await _0x3795e7[_0x4abcc2(0xda)]({'type':_0x4abcc2(0xa0)});return await(0x0,promises_1[_0x4abcc2(0xfe)])(_0x53ee50,_0x84d588),_0x53ee50;}async[a334_0x989a47(0x125)](_0x1f52ac){const _0x174598=a334_0x989a47;this['_logger'][_0x174598(0x100)]('Create\x20vpk\x20package');const _0x4baf85=await this[_0x174598(0xe0)][_0x174598(0xe5)](_0x1f52ac),_0x19a7c6=this['_tempFolder']+'/vpk__'+_0x1f52ac[_0x174598(0xa4)](_0x1f52ac[_0x174598(0xbb)]('/')+0x1);return await(0x0,promises_1[_0x174598(0xfe)])(_0x19a7c6,_0x4baf85),await this['_vpkService'][_0x174598(0x109)](_0x19a7c6),_0x19a7c6;}async[a334_0x989a47(0xce)](_0x4520df,_0x209308){const _0x51c763=a334_0x989a47;this[_0x51c763(0x126)][_0x51c763(0x100)](_0x51c763(0xe3));const _0x595582={'Body':Buffer[_0x51c763(0x134)](_0x4520df)[_0x51c763(0xf7)](_0x51c763(0xd2)),'ContentType':_0x51c763(0xa2),'ParentId':this[_0x51c763(0xb6)],'Name':_0x209308};await this[_0x51c763(0x93)][_0x51c763(0xbf)](flosum_constants_1['FlosumConstants'][_0x51c763(0x97)]+'/Attachment',_0x595582);}['formFlosumDeploymentResults'](_0x1ec357,_0x311e25){const _0x1bb043=a334_0x989a47;this[_0x1bb043(0x126)][_0x1bb043(0x100)]('Form\x20Deployment\x20Results');const _0x356b1e=_0x1ec357[_0x1bb043(0xe1)]((_0x3499b0,_0x9081f9)=>_0x3499b0['set']((_0x9081f9[_0x1bb043(0xc2)]+'.'+_0x9081f9[_0x1bb043(0xdd)])[_0x1bb043(0xac)](),_0x9081f9),new Map());return _0x311e25[_0x1bb043(0x11e)](_0xe9d74=>{const _0x5c0196=_0x1bb043;this[_0x5c0196(0x126)][_0x5c0196(0x100)](_0xe9d74[_0x5c0196(0xf5)]+'.'+_0xe9d74[_0x5c0196(0xcd)]+_0x5c0196(0xf2)+_0xe9d74[_0x5c0196(0x120)]);const _0x422dd1=(_0xe9d74[_0x5c0196(0xf5)]+'.'+_0xe9d74[_0x5c0196(0xcd)])[_0x5c0196(0xac)](),_0x5ef411=_0x356b1e[_0x5c0196(0xa1)](_0x422dd1);return{[constants_1['FLOSUM_NAMESPACE']+_0x5c0196(0xa8)]:_0x5c0196(0xed),[constants_1[_0x5c0196(0xc9)]+_0x5c0196(0x133)]:_0xe9d74['status']===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x5c0196(0xf4):_0x5c0196(0x11b),[constants_1[_0x5c0196(0xc9)]+_0x5c0196(0xb3)]:_0xe9d74['deploymentAction'],[constants_1[_0x5c0196(0xc9)]+'Component_Name__c']:_0xe9d74['name'],[constants_1['FLOSUM_NAMESPACE']+_0x5c0196(0xd4)]:_0xe9d74[_0x5c0196(0xf5)],[constants_1[_0x5c0196(0xc9)]+'Veeva_Step_Name__c']:_0xe9d74[_0x5c0196(0x94)],[constants_1['FLOSUM_NAMESPACE']+_0x5c0196(0xdf)]:this[_0x5c0196(0x136)],[constants_1[_0x5c0196(0xc9)]+'Metadata_Log__c']:this['_metadataLogId'],[constants_1[_0x5c0196(0xc9)]+_0x5c0196(0xdc)]:_0x5ef411[_0x5c0196(0x104)]};});}async['saveDeploymentResults'](_0x1adc94){const _0x33b44d=a334_0x989a47;this[_0x33b44d(0x126)][_0x33b44d(0x100)]('Save\x20Deployment\x20Results');const _0x251e28=await this[_0x33b44d(0x11d)][_0x33b44d(0xfb)](constants_1[_0x33b44d(0xc9)]+_0x33b44d(0x135),_0x1adc94),_0x451f0a=_0x251e28[_0x33b44d(0x95)](_0x574c2e=>!_0x574c2e[_0x33b44d(0x110)])[_0x33b44d(0x11e)](_0x347537=>_0x347537[_0x33b44d(0xe7)])[_0x33b44d(0x90)]();if(_0x451f0a[_0x33b44d(0x9d)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x451f0a);}async[a334_0x989a47(0xae)](_0x44fe5d){const _0x1e93e4=a334_0x989a47;this[_0x1e93e4(0x126)][_0x1e93e4(0xc8)](_0x44fe5d),await this[_0x1e93e4(0x126)][_0x1e93e4(0x10d)](),await this[_0x1e93e4(0x124)](![],!![],'');}async[a334_0x989a47(0x124)](_0x563e97,_0x143781,_0x4686e8){const _0x2b7d9d=a334_0x989a47,_0x3172e2=_0x2b7d9d(0x118)+this['_instanceUrl']+'/'+this[_0x2b7d9d(0xb6)]+_0x2b7d9d(0xd5)+_0x2b7d9d(0xe6)+_0x2b7d9d(0x12d),_0x9052ba=_0x2b7d9d(0x118)+this[_0x2b7d9d(0x10e)]+'/'+this[_0x2b7d9d(0x136)]+'\x20>'+this[_0x2b7d9d(0xb7)]+'</a>',_0xd689cf=_0x3172e2+'\x20of\x20branch\x20to\x20Organization\x20'+_0x9052ba+_0x2b7d9d(0xca),_0x3dad21={[constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0xa7)]:_0xd689cf,[constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0x122)]:new Date(),[constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0x11f)]:this[_0x2b7d9d(0x91)],[constants_1['FLOSUM_NAMESPACE']+_0x2b7d9d(0xf6)]:_0x2b7d9d(0xd0),[constants_1[_0x2b7d9d(0xc9)]+'Activity_Type__c']:'Deployment',[constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0x116)]:this[_0x2b7d9d(0x136)]},_0x50aa78={[constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0x115)]:!_0x563e97,[constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0x117)]:_0x563e97,[constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0x133)]:_0x143781?status_enums_1[_0x2b7d9d(0x10f)]['EXCEPTION']:status_enums_1['MetadataLogStatus'][_0x2b7d9d(0xf0)],[constants_1[_0x2b7d9d(0xc9)]+'Job_Completed__c']:!![],[constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0xfc)]:_0x4686e8};await this[_0x2b7d9d(0x93)][_0x2b7d9d(0x107)](flosum_constants_1[_0x2b7d9d(0x128)][_0x2b7d9d(0x97)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c/'+this[_0x2b7d9d(0xb6)],_0x50aa78),await this['_connectionSalesforce']['post'](flosum_constants_1[_0x2b7d9d(0x128)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x2b7d9d(0xc9)]+_0x2b7d9d(0xb9),_0x3dad21),this['_logger'][_0x2b7d9d(0x100)](_0x2b7d9d(0x9c)+(_0x563e97?_0x2b7d9d(0x114):'with\x20error')+'.'),await this[_0x2b7d9d(0x126)][_0x2b7d9d(0x10d)]();}}exports['DeployService']=DeployService;function a334_0x112e(){const _0x206fe9=['stepName','filter','_systemLogger','ENDPOINT_UPSERT_RECORD','timeZone','../../../core','Retrieving\x20components','_componentIdList','Deploy\x20completed\x20','length','default','constructor','nodebuffer','get','text/plain','VpkService','slice','has','buildObject','Action__c','Type__c','_packageExportService','retrieve','attachmentLogId','toLowerCase','Join\x20all\x20mdl\x20into\x20one\x20zip','finishDeployWithError','3708360lLlgVb','(((.+)+)+)+$','Retrieving\x20attachments','../classes/errors/salesforce-dml-error','Result__c','defineProperty','853216OPVYPc','_metadataLogId','_organisationName','saveDeploymentResults','Log__c','Logger','lastIndexOf','execute','../enums/status.enums','_connectionVeeva','post','organisationName','packageComponentList','componentType','12823320xxxOuj','componentIdList','Flosum','BACKUP_ZIP_NAME','__importDefault','logError','FLOSUM_NAMESPACE','\x20has\x20been\x20created.','Body','migration__v','name','saveLog','https://veevavault.com/','Branch','Finish\x20Create\x20Backup','base64','joinAllAttachments','Component_Type__c','\x20>\x20','DeployService','bind','VeevaService','_attachmentLogId','generateAsync','fetchAttachmentsDetailsByParentId','Component_History__c','componentName','xml2js','Org__c','_vpkService','reduce','2159195sxYnzY','Save\x20log','null','generate','Veeva\x20Deployment','errors','fs/promises','_packageImportService','Deploy','FlosumComponentVeevaComponentRetriever','Cannot\x20retrievers\x20all\x20attachments','Deployment\x20Result','Save\x20Backup\x20to\x20Salesforce','formFlosumDeploymentResults','COMPLETED','file','\x20:\x20','loadAsync','Success','type','Activity_Item__c','toString','./package-export.service','__esModule','Create\x20Backup','insertMultipleRecords','Async_Request_Id__c','async','writeFile','jszip','log','2078QybHzk','./package-import.service','../../shared/utils/fetch-attachments','componentHistoryId','.zip','search','patch','values','validate','273381BNHEav','../constants/flosum.constants','branchId','updateLog','_instanceUrl','MetadataLogStatus','success','organisationId','Backup','catch','successfully','Is_Error__c','TargetId__c','Succeed__c','<a\x20href=','Builder','3739967IjJfur','Failure','_deploymentName','_salesforceService','map','Branch__c','status','files','Date__c','599Kanwqu','finishDeploy','createVpk','_logger','_veevaService','FlosumConstants','SalesforceService','_tempFolder','string','./veeva.service','\x20</a>','metadataLogId','error','PackageExportService','getFlosumComponents','PackageImportService','Status__c','from','Deployment_Result__c','_organisationId','veeva-deploy','flat','_branchId','Cannot\x20Backup\x20more\x20than\x20200\x20components.','_connectionSalesforce'];a334_0x112e=function(){return _0x206fe9;};return a334_0x112e();}