const a401_0x42bd35=a401_0xa24e;function a401_0x3d0b(){const _0x4fd097=['37896360EpIjvM','createZip','generate','__importDefault','VeevaService','deploymentName','_organisationId','fs/promises','_instanceUrl','_metadataLogId','_branchId','metadataLogId','defineProperty','Save\x20Deployment\x20Results','constructor','FLOSUM_NAMESPACE','_packageImportService','3394616YrUMoa','logError','8VrddIk','default','Retrieving\x20components','PackageImportService','Org__c','veeva-deploy','Branch','success','</a>','<a\x20href=','11331144CMqibh','has','267252VErBIW','\x20</a>','Body','finishDeploy','1567932amgNEb','saveLog','Type__c','Create\x20Backup','../classes/deploy/zip-creator.deploy','execute','_attachmentLogId','createVpk','_deploymentName','Date__c','search','DeployService','stepName','_veevaService','retrieveAttachments','organisationId','_organisationName','_salesforceService','formFlosumDeploymentResults','flat','../../shared/utils/fetch-attachments','Activity_Item__c','retrieve','ENDPOINT_UPSERT_RECORD','Cannot\x20Backup\x20more\x20than\x20200\x20components.','insertMultipleRecords','import','\x20has\x20been\x20created.','log','Status__c','MetadataLogStatus','Component_Type__c','saveDeploymentResults','External_Deployment_Id__c','_connectionSalesforce','fetchAttachmentsDetailsByParentId','_vpkService','ZipCreatorDeploy','length','.zip','Veeva\x20Deployment','TargetId__c','post','Succeed__c','Join\x20all\x20mdl\x20into\x20one\x20zip','Cannot\x20retrievers\x20all\x20attachments','errors','map','(((.+)+)+)+$','../constants/flosum.constants','Deploy\x20completed\x20','./package-import.service','Metadata_Log__c/','jszip','Form\x20Deployment\x20Results','status','_timeZone','./salesforce.service','attachmentLogId','SalesforceService','with\x20error','getFlosumComponents','base64','Failure','_packageExportService','_componentIdList','validate','text/plain','Log__c','/vpk__','Veeva_Step_Name__c','Create\x20vpk\x20package','\x20>\x20','_logger','Branch__c','Deployment','name','5fmjchN','Metadata_Log__c','finishDeployWithError','componentType','organisationName','type','BranchComponentHistoryFlosumComponentRetriever','1114763QbnOZx','Component_History__c','deploymentAction','PackageExportService','./vpk.service','error','reduce','toString','Save\x20log','FlosumConstants','createBackup','isDeployed','apply','componentHistoryId','Success','COMPLETED','saveBackup','componentIdList','_tempFolder','_systemLogger','7AdpZCY','EXCEPTION','718062UIKbia','slice','\x20of\x20branch\x20to\x20Organization\x20','from','packageId','_connectionVeeva','generateAsync','Component_Name__c','Activity_Type__c','updateLog','/Attachment','Logger','toLowerCase','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Is_Error__c','lastIndexOf','shortid','Deployment_Result__c','../../../constants','VpkService','filter'];a401_0x3d0b=function(){return _0x4fd097;};return a401_0x3d0b();}(function(_0x3f7b99,_0x3a2604){const _0x23c8fd=a401_0xa24e,_0xcbfa81=_0x3f7b99();while(!![]){try{const _0x4c5223=-parseInt(_0x23c8fd(0x218))/0x1+-parseInt(_0x23c8fd(0x1c4))/0x2+parseInt(_0x23c8fd(0x1c0))/0x3*(-parseInt(_0x23c8fd(0x256))/0x4)+-parseInt(_0x23c8fd(0x211))/0x5*(parseInt(_0x23c8fd(0x22e))/0x6)+-parseInt(_0x23c8fd(0x22c))/0x7*(-parseInt(_0x23c8fd(0x254))/0x8)+-parseInt(_0x23c8fd(0x1be))/0x9+parseInt(_0x23c8fd(0x243))/0xa;if(_0x4c5223===_0x3a2604)break;else _0xcbfa81['push'](_0xcbfa81['shift']());}catch(_0x47a9df){_0xcbfa81['push'](_0xcbfa81['shift']());}}}(a401_0x3d0b,0xb9265));const a401_0x57b6a4=(function(){let _0x43b6c9=!![];return function(_0x4376e8,_0x296e04){const _0x1e3f60=_0x43b6c9?function(){const _0xacfe55=a401_0xa24e;if(_0x296e04){const _0x5cd30e=_0x296e04[_0xacfe55(0x224)](_0x4376e8,arguments);return _0x296e04=null,_0x5cd30e;}}:function(){};return _0x43b6c9=![],_0x1e3f60;};}()),a401_0x2b910f=a401_0x57b6a4(this,function(){const _0x370bc7=a401_0xa24e;return a401_0x2b910f[_0x370bc7(0x21f)]()['search'](_0x370bc7(0x1f4))['toString']()[_0x370bc7(0x251)](a401_0x2b910f)[_0x370bc7(0x1ce)](_0x370bc7(0x1f4));});a401_0x2b910f();'use strict';var __importDefault=this&&this[a401_0x42bd35(0x246)]||function(_0x2d861d){return _0x2d861d&&_0x2d861d['__esModule']?_0x2d861d:{'default':_0x2d861d};};Object[a401_0x42bd35(0x24f)](exports,'__esModule',{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a401_0x42bd35(0x1f9))),promises_1=require(a401_0x42bd35(0x24a)),constants_1=require(a401_0x42bd35(0x240)),flosum_constants_1=require(a401_0x42bd35(0x1f5)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a401_0x42bd35(0x1fd)),core_1=require('../../../core'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a401_0x42bd35(0x23e))),fetch_attachments_1=require(a401_0x42bd35(0x1d8)),package_import_service_1=require(a401_0x42bd35(0x1f7)),branch_component_history_flosum_component_retriever_1=require(a401_0x42bd35(0x23b)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a401_0x42bd35(0x21c)),zip_creator_deploy_1=require(a401_0x42bd35(0x1c8));function a401_0xa24e(_0x55a261,_0xc6b821){const _0x5c65bf=a401_0x3d0b();return a401_0xa24e=function(_0x2b910f,_0x57b6a4){_0x2b910f=_0x2b910f-0x1bb;let _0x3d0b52=_0x5c65bf[_0x2b910f];return _0x3d0b52;},a401_0xa24e(_0x55a261,_0xc6b821);}class DeployService{constructor(_0x2152db,_0x8f2800,_0x2a5907,_0x3381af,_0x2308a7,_0x40a3ac){const _0x3bb22c=a401_0x42bd35;this[_0x3bb22c(0x1e6)]=_0x8f2800,this['_connectionVeeva']=_0x2a5907,this[_0x3bb22c(0x20d)]=_0x3381af,this[_0x3bb22c(0x22a)]=_0x2308a7,this['_instanceUrl']=_0x40a3ac,this['_branchId']=_0x2152db['branchId'],this['_metadataLogId']=_0x2152db[_0x3bb22c(0x24e)],this[_0x3bb22c(0x1ca)]=_0x2152db[_0x3bb22c(0x1fe)],this[_0x3bb22c(0x249)]=_0x2152db[_0x3bb22c(0x1d3)],this[_0x3bb22c(0x1fc)]=_0x2152db['timeZone'],this[_0x3bb22c(0x1d4)]=_0x2152db[_0x3bb22c(0x215)],this['_componentIdList']=_0x2152db[_0x3bb22c(0x229)],this[_0x3bb22c(0x1cc)]=_0x2152db[_0x3bb22c(0x248)],this['_systemLogger']=new core_1[(_0x3bb22c(0x239))](_0x3bb22c(0x25b)),this[_0x3bb22c(0x1d1)]=new veeva_service_1[(_0x3bb22c(0x247))]({'connection':this[_0x3bb22c(0x233)],'logger':this[_0x3bb22c(0x20d)]}),this[_0x3bb22c(0x1d5)]=new salesforce_service_1[(_0x3bb22c(0x1ff))]({'connection':this[_0x3bb22c(0x1e6)]}),this[_0x3bb22c(0x253)]=new package_import_service_1[(_0x3bb22c(0x259))]({'veevaService':this[_0x3bb22c(0x1d1)],'connection':this[_0x3bb22c(0x233)],'logger':this[_0x3bb22c(0x20d)],'saveLog':this[_0x3bb22c(0x1c5)]['bind'](this)}),this[_0x3bb22c(0x204)]=new package_export_service_1[(_0x3bb22c(0x21b))]({'veevaService':this['_veevaService'],'connection':this[_0x3bb22c(0x233)],'logger':this[_0x3bb22c(0x20d)]}),this[_0x3bb22c(0x1e8)]=new vpk_service_1[(_0x3bb22c(0x241))]({'connection':this['_connectionVeeva']});}async[a401_0x42bd35(0x1c9)](){const _0x421cd1=a401_0x42bd35;try{const _0x35934f=await this['getFlosumComponents']();await this[_0x421cd1(0x20d)][_0x421cd1(0x237)]();const _0x8f9d3d=await this['createBackup'](_0x35934f);await this['saveBackup'](_0x8f9d3d);const _0x238632=await this[_0x421cd1(0x1d2)](_0x35934f),_0x3852ee=await this[_0x421cd1(0x244)](_0x238632),_0x3f1058=await this[_0x421cd1(0x1cb)](_0x3852ee);await this[_0x421cd1(0x20d)][_0x421cd1(0x237)]();const _0x10d2be=await this['_packageImportService'][_0x421cd1(0x1de)](_0x3f1058);await this[_0x421cd1(0x20d)][_0x421cd1(0x237)]();const _0x84053f=this['formFlosumDeploymentResults'](_0x35934f,_0x10d2be['packageComponentList']);await this[_0x421cd1(0x1e4)](_0x84053f),await this[_0x421cd1(0x1c3)](_0x10d2be[_0x421cd1(0x223)],![],_0x10d2be[_0x421cd1(0x232)]);}catch(_0x3e86fb){await this[_0x421cd1(0x213)](_0x3e86fb)['catch'](_0x4b6f29=>this[_0x421cd1(0x22b)][_0x421cd1(0x21d)](_0x4b6f29));}}async[a401_0x42bd35(0x201)](){const _0x1c81de=a401_0x42bd35,_0x4f9696=new Set(this[_0x1c81de(0x205)]);this['_logger'][_0x1c81de(0x1e0)](_0x1c81de(0x258));const _0x530ef2=await new branch_component_history_flosum_component_retriever_1[(_0x1c81de(0x217))]({'value':this[_0x1c81de(0x24d)],'salesforceService':this['_salesforceService']})[_0x1c81de(0x1da)](),_0x589cf9=_0x530ef2[_0x1c81de(0x242)](_0x32716f=>_0x4f9696[_0x1c81de(0x1bf)](_0x32716f['id']));if(_0x589cf9[_0x1c81de(0x1ea)]!==this['_componentIdList'][_0x1c81de(0x1ea)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x589cf9;}async[a401_0x42bd35(0x222)](_0x2b5ec7){const _0x546979=a401_0x42bd35;var _0x9c440e;this[_0x546979(0x20d)][_0x546979(0x1e0)](_0x546979(0x1c7));const _0x4e9677=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x2b5ec7,'veevaService':this[_0x546979(0x1d1)],'logger':this[_0x546979(0x20d)]})['retrieve'](),_0x218911=await this['_packageExportService']['export'](_0x4e9677,'Backup');if(_0x218911['length']>0x1)throw new Error(_0x546979(0x1dc));return(_0x9c440e=_0x218911[0x0])!==null&&_0x9c440e!==void 0x0?_0x9c440e:_0x218911[0x0]=new jszip_1[(_0x546979(0x257))](),_0x218911[0x0][_0x546979(0x234)]({'type':_0x546979(0x202)});}async[a401_0x42bd35(0x228)](_0x42fd8d){const _0x39865c=a401_0x42bd35;this['_logger']['log']('Save\x20Backup\x20to\x20Salesforce');const _0x2dc519={'Body':_0x42fd8d,'ContentType':'application/zip','ParentId':this[_0x39865c(0x24c)],'Name':flosum_constants_1[_0x39865c(0x221)]['BACKUP_ZIP_NAME']};await this[_0x39865c(0x1e6)][_0x39865c(0x1ee)](flosum_constants_1[_0x39865c(0x221)]['ENDPOINT_UPSERT_RECORD']+_0x39865c(0x238),_0x2dc519);}async['retrieveAttachments'](_0x3387c9){const _0x38d028=a401_0x42bd35;this['_logger'][_0x38d028(0x1e0)]('Retrieving\x20attachments');const _0x2f417d=await(0x0,fetch_attachments_1[_0x38d028(0x1e7)])(this[_0x38d028(0x1e6)],_0x3387c9[_0x38d028(0x1f3)](_0xfc6f55=>_0xfc6f55['componentHistoryId'])),_0x2f0752=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x2f417d,this[_0x38d028(0x1e6)]);if(_0x2f0752[_0x38d028(0x1ea)]!==this[_0x38d028(0x205)][_0x38d028(0x1ea)])throw new Error(_0x38d028(0x1f1));return _0x2f0752[_0x38d028(0x1f3)](_0x133901=>_0x133901['values'][_0x38d028(0x1c2)]);}async[a401_0x42bd35(0x244)](_0x7e61e9){const _0x2c9cc0=a401_0x42bd35;this[_0x2c9cc0(0x20d)][_0x2c9cc0(0x1e0)](_0x2c9cc0(0x1f0));const _0x4a4614=await new zip_creator_deploy_1[(_0x2c9cc0(0x1e9))]({'attachmentBodies':_0x7e61e9,'deploymentName':this[_0x2c9cc0(0x1cc)]})['execute'](),_0x67f852=this[_0x2c9cc0(0x22a)]+'/'+(0x0,shortid_1[_0x2c9cc0(0x257)])()+_0x2c9cc0(0x1eb);return await(0x0,promises_1['writeFile'])(_0x67f852,_0x4a4614),_0x67f852;}async[a401_0x42bd35(0x1cb)](_0x5d9c70){const _0x4eba80=a401_0x42bd35;this[_0x4eba80(0x20d)][_0x4eba80(0x1e0)](_0x4eba80(0x20b));const _0x3ea912=await this[_0x4eba80(0x1e8)][_0x4eba80(0x245)](_0x5d9c70),_0x2d7312=this[_0x4eba80(0x22a)]+_0x4eba80(0x209)+_0x5d9c70[_0x4eba80(0x22f)](_0x5d9c70[_0x4eba80(0x23d)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x2d7312,_0x3ea912),await this[_0x4eba80(0x1e8)][_0x4eba80(0x206)](_0x2d7312),_0x2d7312;}async[a401_0x42bd35(0x1c5)](_0x208cd3,_0x274bcc){const _0x5f0226=a401_0x42bd35;this['_logger']['log'](_0x5f0226(0x220));const _0x425cc6={'Body':Buffer[_0x5f0226(0x231)](_0x208cd3)[_0x5f0226(0x21f)]('base64'),'ContentType':_0x5f0226(0x207),'ParentId':this[_0x5f0226(0x24c)],'Name':_0x274bcc};await this[_0x5f0226(0x1e6)][_0x5f0226(0x1ee)](flosum_constants_1[_0x5f0226(0x221)][_0x5f0226(0x1db)]+'/Attachment',_0x425cc6);}[a401_0x42bd35(0x1d6)](_0x4417c6,_0x579b7e){const _0x5d72ea=a401_0x42bd35;this['_logger'][_0x5d72ea(0x1e0)](_0x5d72ea(0x1fa));const _0x27ad31=_0x4417c6[_0x5d72ea(0x21e)]((_0x16f167,_0x34e576)=>_0x16f167['set']((_0x34e576[_0x5d72ea(0x214)]+'.'+_0x34e576['componentName'])['toLowerCase'](),_0x34e576),new Map());return _0x579b7e['map'](_0x3d9295=>{const _0x4be756=_0x5d72ea;this[_0x4be756(0x20d)]['log'](_0x3d9295[_0x4be756(0x216)]+'.'+_0x3d9295[_0x4be756(0x210)]+'\x20:\x20'+_0x3d9295['status']);const _0x25f7a8=(_0x3d9295['type']+'.'+_0x3d9295[_0x4be756(0x210)])[_0x4be756(0x23a)](),_0x44b335=_0x27ad31['get'](_0x25f7a8);return{[constants_1[_0x4be756(0x252)]+_0x4be756(0x1c6)]:'Deployment\x20Result',[constants_1[_0x4be756(0x252)]+_0x4be756(0x1e1)]:_0x3d9295[_0x4be756(0x1fb)]===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x4be756(0x226):_0x4be756(0x203),[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x3d9295[_0x4be756(0x21a)],[constants_1[_0x4be756(0x252)]+_0x4be756(0x235)]:_0x3d9295[_0x4be756(0x210)],[constants_1[_0x4be756(0x252)]+_0x4be756(0x1e3)]:_0x3d9295[_0x4be756(0x216)],[constants_1['FLOSUM_NAMESPACE']+_0x4be756(0x20a)]:_0x3d9295[_0x4be756(0x1d0)],[constants_1['FLOSUM_NAMESPACE']+_0x4be756(0x25a)]:this[_0x4be756(0x249)],[constants_1[_0x4be756(0x252)]+_0x4be756(0x212)]:this[_0x4be756(0x24c)],[constants_1['FLOSUM_NAMESPACE']+_0x4be756(0x219)]:_0x44b335[_0x4be756(0x225)]};});}async['saveDeploymentResults'](_0x203ea3){const _0x2af1da=a401_0x42bd35;this[_0x2af1da(0x20d)]['log'](_0x2af1da(0x250));const _0x251637=await this[_0x2af1da(0x1d5)][_0x2af1da(0x1dd)](constants_1[_0x2af1da(0x252)]+_0x2af1da(0x23f),_0x203ea3),_0x2818c8=_0x251637['filter'](_0x5213d3=>!_0x5213d3[_0x2af1da(0x1bb)])[_0x2af1da(0x1f3)](_0x4f5067=>_0x4f5067[_0x2af1da(0x1f2)])[_0x2af1da(0x1d7)]();if(_0x2818c8[_0x2af1da(0x1ea)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x2818c8);}async['finishDeployWithError'](_0x19b6a2){const _0x1cb513=a401_0x42bd35;this[_0x1cb513(0x20d)][_0x1cb513(0x255)](_0x19b6a2),await this[_0x1cb513(0x20d)][_0x1cb513(0x237)](),await this[_0x1cb513(0x1c3)](![],!![],'');}async['finishDeploy'](_0x26ddbe,_0x185df4,_0x1d55c9){const _0x135829=a401_0x42bd35,_0x263c8c=_0x135829(0x1bd)+this[_0x135829(0x24b)]+'/'+this['_metadataLogId']+_0x135829(0x20c)+_0x135829(0x1ec)+_0x135829(0x1c1),_0x566448=_0x135829(0x1bd)+this[_0x135829(0x24b)]+'/'+this[_0x135829(0x249)]+'\x20>'+this[_0x135829(0x1d4)]+_0x135829(0x1bc),_0x34309a=_0x263c8c+_0x135829(0x230)+_0x566448+_0x135829(0x1df),_0x2463ce={[constants_1[_0x135829(0x252)]+'Action__c']:_0x34309a,[constants_1[_0x135829(0x252)]+_0x135829(0x1cd)]:new Date(),[constants_1[_0x135829(0x252)]+_0x135829(0x20e)]:this[_0x135829(0x24d)],[constants_1[_0x135829(0x252)]+_0x135829(0x1d9)]:_0x135829(0x25c),[constants_1['FLOSUM_NAMESPACE']+_0x135829(0x236)]:_0x135829(0x20f),[constants_1[_0x135829(0x252)]+_0x135829(0x1ed)]:this[_0x135829(0x249)]},_0x1a1a1e={[constants_1['FLOSUM_NAMESPACE']+_0x135829(0x23c)]:!_0x26ddbe,[constants_1['FLOSUM_NAMESPACE']+_0x135829(0x1ef)]:_0x26ddbe,[constants_1['FLOSUM_NAMESPACE']+_0x135829(0x1e1)]:_0x185df4?status_enums_1[_0x135829(0x1e2)][_0x135829(0x22d)]:status_enums_1[_0x135829(0x1e2)][_0x135829(0x227)],[constants_1[_0x135829(0x252)]+'Job_Completed__c']:!![],[constants_1[_0x135829(0x252)]+_0x135829(0x1e5)]:_0x1d55c9};await this[_0x135829(0x1e6)]['patch'](flosum_constants_1[_0x135829(0x221)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x135829(0x252)]+_0x135829(0x1f8)+this[_0x135829(0x24c)],_0x1a1a1e),await this[_0x135829(0x1e6)][_0x135829(0x1ee)](flosum_constants_1[_0x135829(0x221)][_0x135829(0x1db)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x135829(0x208),_0x2463ce),this[_0x135829(0x20d)][_0x135829(0x1e0)](_0x135829(0x1f6)+(_0x26ddbe?'successfully':_0x135829(0x200))+'.'),await this[_0x135829(0x20d)][_0x135829(0x237)]();}}exports[a401_0x42bd35(0x1cf)]=DeployService;