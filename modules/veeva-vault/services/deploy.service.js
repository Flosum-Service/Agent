const a402_0x44aef9=a402_0x5ad1;function a402_0x5ad1(_0x117873,_0x19350c){const _0x42e08b=a402_0x3c2f();return a402_0x5ad1=function(_0x456901,_0x12c6dc){_0x456901=_0x456901-0x193;let _0x3c2f54=_0x42e08b[_0x456901];return _0x3c2f54;},a402_0x5ad1(_0x117873,_0x19350c);}(function(_0x3201eb,_0x5b5ac4){const _0x4eaad3=a402_0x5ad1,_0x55380c=_0x3201eb();while(!![]){try{const _0x15662b=-parseInt(_0x4eaad3(0x1b8))/0x1*(parseInt(_0x4eaad3(0x233))/0x2)+parseInt(_0x4eaad3(0x22a))/0x3+-parseInt(_0x4eaad3(0x20b))/0x4+parseInt(_0x4eaad3(0x1ee))/0x5*(parseInt(_0x4eaad3(0x218))/0x6)+parseInt(_0x4eaad3(0x1a3))/0x7*(-parseInt(_0x4eaad3(0x212))/0x8)+-parseInt(_0x4eaad3(0x1d0))/0x9*(-parseInt(_0x4eaad3(0x1b2))/0xa)+-parseInt(_0x4eaad3(0x213))/0xb;if(_0x15662b===_0x5b5ac4)break;else _0x55380c['push'](_0x55380c['shift']());}catch(_0x38fb31){_0x55380c['push'](_0x55380c['shift']());}}}(a402_0x3c2f,0xcbe01));const a402_0x12c6dc=(function(){let _0x5c1f08=!![];return function(_0x4d93b1,_0x9a49a1){const _0x4798bb=_0x5c1f08?function(){const _0x1289d1=a402_0x5ad1;if(_0x9a49a1){const _0x3cf914=_0x9a49a1[_0x1289d1(0x1fc)](_0x4d93b1,arguments);return _0x9a49a1=null,_0x3cf914;}}:function(){};return _0x5c1f08=![],_0x4798bb;};}()),a402_0x456901=a402_0x12c6dc(this,function(){const _0x226990=a402_0x5ad1;return a402_0x456901[_0x226990(0x1b5)]()[_0x226990(0x1ad)]('(((.+)+)+)+$')['toString']()[_0x226990(0x1b9)](a402_0x456901)['search'](_0x226990(0x1d5));});a402_0x456901();'use strict';var __importDefault=this&&this[a402_0x44aef9(0x1e7)]||function(_0x1bc86a){const _0x3ad065=a402_0x44aef9;return _0x1bc86a&&_0x1bc86a[_0x3ad065(0x210)]?_0x1bc86a:{'default':_0x1bc86a};};Object[a402_0x44aef9(0x1fa)](exports,a402_0x44aef9(0x210),{'value':!![]}),exports[a402_0x44aef9(0x1ac)]=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a402_0x44aef9(0x1ab)),constants_1=require('../../../constants'),flosum_constants_1=require(a402_0x44aef9(0x1fe)),veeva_service_1=require(a402_0x44aef9(0x1a4)),salesforce_service_1=require('./salesforce.service'),core_1=require(a402_0x44aef9(0x22f)),status_enums_1=require(a402_0x44aef9(0x1f1)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a402_0x44aef9(0x1bb))),fetch_attachments_1=require(a402_0x44aef9(0x19d)),package_import_service_1=require(a402_0x44aef9(0x19e)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a402_0x44aef9(0x1bc)),package_export_service_1=require(a402_0x44aef9(0x217)),vpk_service_1=require(a402_0x44aef9(0x194)),zip_creator_deploy_1=require(a402_0x44aef9(0x1f9));class DeployService{constructor(_0x365d6b,_0x43e3bf,_0x2b2935,_0x3db976,_0x511f3f,_0x3bdd61){const _0x3b40c8=a402_0x44aef9;this[_0x3b40c8(0x223)]=_0x43e3bf,this[_0x3b40c8(0x232)]=_0x2b2935,this[_0x3b40c8(0x1dc)]=_0x3db976,this[_0x3b40c8(0x1e9)]=_0x511f3f,this[_0x3b40c8(0x1cd)]=_0x3bdd61,this[_0x3b40c8(0x214)]=_0x365d6b[_0x3b40c8(0x1a7)],this['_metadataLogId']=_0x365d6b[_0x3b40c8(0x207)],this[_0x3b40c8(0x1f6)]=_0x365d6b[_0x3b40c8(0x20a)],this[_0x3b40c8(0x195)]=_0x365d6b[_0x3b40c8(0x1e6)],this[_0x3b40c8(0x1ea)]=_0x365d6b[_0x3b40c8(0x211)],this[_0x3b40c8(0x1a9)]=_0x365d6b[_0x3b40c8(0x219)],this['_componentIdList']=_0x365d6b['componentIdList'],this[_0x3b40c8(0x21f)]=_0x365d6b['deploymentName'],this[_0x3b40c8(0x1f5)]=new core_1[(_0x3b40c8(0x1c4))](_0x3b40c8(0x1e3)),this[_0x3b40c8(0x1a8)]=new veeva_service_1['VeevaService']({'connection':this['_connectionVeeva'],'logger':this['_logger']}),this[_0x3b40c8(0x209)]=new salesforce_service_1[(_0x3b40c8(0x215))]({'connection':this[_0x3b40c8(0x223)]}),this['_packageImportService']=new package_import_service_1[(_0x3b40c8(0x1cc))]({'veevaService':this['_veevaService'],'connection':this[_0x3b40c8(0x232)],'logger':this[_0x3b40c8(0x1dc)],'saveLog':this[_0x3b40c8(0x1da)][_0x3b40c8(0x197)](this)}),this[_0x3b40c8(0x1d4)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x3b40c8(0x1a8)],'connection':this[_0x3b40c8(0x232)],'logger':this[_0x3b40c8(0x1dc)]}),this['_vpkService']=new vpk_service_1[(_0x3b40c8(0x1ce))]({'connection':this['_connectionVeeva']});}async[a402_0x44aef9(0x21e)](){const _0x33bc82=a402_0x44aef9;try{const _0x346043=await this[_0x33bc82(0x1a5)]();await this[_0x33bc82(0x1dc)]['updateLog']();const _0x2d734c=await this[_0x33bc82(0x1c9)](_0x346043);await this[_0x33bc82(0x1f8)](_0x2d734c);const _0xb64e5f=await this[_0x33bc82(0x227)](_0x346043),_0x48ef8c=await this[_0x33bc82(0x1bf)](_0xb64e5f),_0xbc8919=await this[_0x33bc82(0x221)](_0x48ef8c);await this[_0x33bc82(0x1dc)][_0x33bc82(0x1ca)]();const _0x136a8e=await this[_0x33bc82(0x1f2)][_0x33bc82(0x1d3)](_0xbc8919);await this['_logger']['updateLog']();const _0x20abf7=this[_0x33bc82(0x199)](_0x346043,_0x136a8e[_0x33bc82(0x20d)]);await this[_0x33bc82(0x1d9)](_0x20abf7),await this[_0x33bc82(0x1df)](_0x136a8e['isDeployed'],![],_0x136a8e[_0x33bc82(0x206)]);}catch(_0x554f8b){await this[_0x33bc82(0x1af)](_0x554f8b)[_0x33bc82(0x1c3)](_0x3e8186=>this[_0x33bc82(0x1f5)]['error'](_0x3e8186));}}async[a402_0x44aef9(0x1a5)](){const _0x4b288c=a402_0x44aef9,_0x8a84c3=new Set(this[_0x4b288c(0x1ed)]);this[_0x4b288c(0x1dc)][_0x4b288c(0x1ba)](_0x4b288c(0x1b4));const _0x2a4a98=await new branch_component_history_flosum_component_retriever_1[(_0x4b288c(0x196))]({'value':this[_0x4b288c(0x214)],'salesforceService':this[_0x4b288c(0x209)]})[_0x4b288c(0x193)](),_0x2f31fc=_0x2a4a98[_0x4b288c(0x20f)](_0x4364bd=>_0x8a84c3['has'](_0x4364bd['id']));if(_0x2f31fc[_0x4b288c(0x1e0)]!==this[_0x4b288c(0x1ed)][_0x4b288c(0x1e0)])throw new Error(_0x4b288c(0x19f));return _0x2f31fc;}async[a402_0x44aef9(0x1c9)](_0xa57be6){const _0x4838ed=a402_0x44aef9;var _0x5a87cb;this['_logger']['log'](_0x4838ed(0x1a2));const _0x5270d0=await new flosum_component_veeva_component_retriever_1[(_0x4838ed(0x220))]({'value':_0xa57be6,'veevaService':this[_0x4838ed(0x1a8)],'logger':this[_0x4838ed(0x1dc)]})[_0x4838ed(0x193)](),_0x57f1a6=await this[_0x4838ed(0x1d4)][_0x4838ed(0x231)](_0x5270d0,'Backup');if(_0x57f1a6[_0x4838ed(0x1e0)]>0x1)throw new Error(_0x4838ed(0x1c1));return(_0x5a87cb=_0x57f1a6[0x0])!==null&&_0x5a87cb!==void 0x0?_0x5a87cb:_0x57f1a6[0x0]=new jszip_1['default'](),_0x57f1a6[0x0]['generateAsync']({'type':_0x4838ed(0x230)});}async[a402_0x44aef9(0x1f8)](_0x28ac2d){const _0x2a6254=a402_0x44aef9;this[_0x2a6254(0x1dc)][_0x2a6254(0x1ba)](_0x2a6254(0x1f0));const _0x1b64af={'Body':_0x28ac2d,'ContentType':'application/zip','ParentId':this[_0x2a6254(0x229)],'Name':flosum_constants_1[_0x2a6254(0x19c)][_0x2a6254(0x21c)]};await this[_0x2a6254(0x223)]['post'](flosum_constants_1[_0x2a6254(0x19c)][_0x2a6254(0x1b1)]+_0x2a6254(0x1dd),_0x1b64af);}async[a402_0x44aef9(0x227)](_0x3a9dfd){const _0x342869=a402_0x44aef9;this[_0x342869(0x1dc)][_0x342869(0x1ba)](_0x342869(0x1b0));const _0x34bc9a=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x342869(0x223)],_0x3a9dfd['map'](_0x40ccb2=>_0x40ccb2['componentHistoryId'])),_0x47759a=await(0x0,fetch_attachments_1[_0x342869(0x227)])(_0x34bc9a,this[_0x342869(0x223)]);if(_0x47759a[_0x342869(0x1e0)]!==this['_componentIdList'][_0x342869(0x1e0)])throw new Error(_0x342869(0x22d));return _0x47759a['map'](_0x21df55=>_0x21df55[_0x342869(0x19a)][_0x342869(0x1d1)]);}async[a402_0x44aef9(0x1bf)](_0xa01c5c){const _0x8db080=a402_0x44aef9;this[_0x8db080(0x1dc)][_0x8db080(0x1ba)](_0x8db080(0x1db));const _0x596a71=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0xa01c5c,'deploymentName':this['_deploymentName']})[_0x8db080(0x21e)](),_0x1312ab=this['_tempFolder']+'/'+(0x0,shortid_1[_0x8db080(0x1cf)])()+'.zip';return await(0x0,promises_1['writeFile'])(_0x1312ab,_0x596a71),_0x1312ab;}async[a402_0x44aef9(0x221)](_0x48268c){const _0x1ee4d7=a402_0x44aef9;this[_0x1ee4d7(0x1dc)]['log'](_0x1ee4d7(0x1b3));const _0x2007db=await this['_vpkService'][_0x1ee4d7(0x222)](_0x48268c),_0x29c76a=this[_0x1ee4d7(0x1e9)]+_0x1ee4d7(0x1f7)+_0x48268c['slice'](_0x48268c[_0x1ee4d7(0x1e8)]('/')+0x1);return await(0x0,promises_1[_0x1ee4d7(0x202)])(_0x29c76a,_0x2007db),await this['_vpkService'][_0x1ee4d7(0x1c5)](_0x29c76a),_0x29c76a;}async[a402_0x44aef9(0x1da)](_0x5f2582,_0x51b8de){const _0xe922bb=a402_0x44aef9;this[_0xe922bb(0x1dc)]['log'](_0xe922bb(0x200));const _0x57049d={'Body':Buffer[_0xe922bb(0x1d6)](_0x5f2582)['toString'](_0xe922bb(0x230)),'ContentType':_0xe922bb(0x21a),'ParentId':this[_0xe922bb(0x229)],'Name':_0x51b8de};await this[_0xe922bb(0x223)][_0xe922bb(0x1bd)](flosum_constants_1[_0xe922bb(0x19c)]['ENDPOINT_UPSERT_RECORD']+_0xe922bb(0x1dd),_0x57049d);}[a402_0x44aef9(0x199)](_0x5456db,_0x4d1694){const _0x550026=a402_0x44aef9;this['_logger']['log']('Form\x20Deployment\x20Results');const _0x42eecb=_0x5456db[_0x550026(0x1c6)]((_0x492ade,_0x2b276b)=>_0x492ade[_0x550026(0x22e)]((_0x2b276b[_0x550026(0x1ec)]+'.'+_0x2b276b[_0x550026(0x1b7)])['toLowerCase'](),_0x2b276b),new Map());return _0x4d1694[_0x550026(0x198)](_0x35eb06=>{const _0x3bf766=_0x550026;this[_0x3bf766(0x1dc)][_0x3bf766(0x1ba)](_0x35eb06['type']+'.'+_0x35eb06[_0x3bf766(0x1de)]+'\x20:\x20'+_0x35eb06[_0x3bf766(0x22b)]);const _0x550570=(_0x35eb06[_0x3bf766(0x1c7)]+'.'+_0x35eb06['name'])[_0x3bf766(0x1a1)](),_0x6b3495=_0x42eecb[_0x3bf766(0x1eb)](_0x550570);return{[constants_1[_0x3bf766(0x1fd)]+_0x3bf766(0x22c)]:_0x3bf766(0x1d8),[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x35eb06[_0x3bf766(0x22b)]===status_enums_1[_0x3bf766(0x1d2)][_0x3bf766(0x201)]?_0x3bf766(0x1be):_0x3bf766(0x1a0),[constants_1[_0x3bf766(0x1fd)]+'Result__c']:_0x35eb06[_0x3bf766(0x1e5)],[constants_1['FLOSUM_NAMESPACE']+_0x3bf766(0x208)]:_0x35eb06[_0x3bf766(0x1de)],[constants_1[_0x3bf766(0x1fd)]+_0x3bf766(0x1f4)]:_0x35eb06[_0x3bf766(0x1c7)],[constants_1['FLOSUM_NAMESPACE']+_0x3bf766(0x1aa)]:_0x35eb06[_0x3bf766(0x21d)],[constants_1['FLOSUM_NAMESPACE']+_0x3bf766(0x20e)]:this[_0x3bf766(0x195)],[constants_1[_0x3bf766(0x1fd)]+'Metadata_Log__c']:this['_metadataLogId'],[constants_1['FLOSUM_NAMESPACE']+'Component_History__c']:_0x6b3495[_0x3bf766(0x1ff)]};});}async[a402_0x44aef9(0x1d9)](_0x2194ab){const _0x48f724=a402_0x44aef9;this[_0x48f724(0x1dc)][_0x48f724(0x1ba)](_0x48f724(0x20c));const _0x25d041=await this[_0x48f724(0x209)]['insertMultipleRecords'](constants_1[_0x48f724(0x1fd)]+'Deployment_Result__c',_0x2194ab),_0x56fa6f=_0x25d041['filter'](_0x3ec14f=>!_0x3ec14f[_0x48f724(0x228)])[_0x48f724(0x198)](_0x41b941=>_0x41b941[_0x48f724(0x204)])[_0x48f724(0x1c0)]();if(_0x56fa6f['length'])throw new salesforce_dml_error_1[(_0x48f724(0x216))](_0x56fa6f);}async['finishDeployWithError'](_0x4d5c7f){const _0x46e097=a402_0x44aef9;this[_0x46e097(0x1dc)][_0x46e097(0x1a6)](_0x4d5c7f),await this[_0x46e097(0x1dc)][_0x46e097(0x1ca)](),await this[_0x46e097(0x1df)](![],!![],'');}async[a402_0x44aef9(0x1df)](_0x412724,_0x13728b,_0x2c78e1){const _0x2e2e15=a402_0x44aef9,_0x291d66=_0x2e2e15(0x1ae)+this[_0x2e2e15(0x1cd)]+'/'+this[_0x2e2e15(0x229)]+_0x2e2e15(0x21b)+_0x2e2e15(0x19b)+_0x2e2e15(0x225),_0x408c9f=_0x2e2e15(0x1ae)+this['_instanceUrl']+'/'+this[_0x2e2e15(0x195)]+'\x20>'+this['_organisationName']+'</a>',_0x209a71=_0x291d66+_0x2e2e15(0x224)+_0x408c9f+'\x20has\x20been\x20created.',_0x5cd24b={[constants_1['FLOSUM_NAMESPACE']+'Action__c']:_0x209a71,[constants_1[_0x2e2e15(0x1fd)]+_0x2e2e15(0x1e2)]:new Date(),[constants_1[_0x2e2e15(0x1fd)]+_0x2e2e15(0x1e4)]:this[_0x2e2e15(0x214)],[constants_1[_0x2e2e15(0x1fd)]+_0x2e2e15(0x1b6)]:_0x2e2e15(0x203),[constants_1['FLOSUM_NAMESPACE']+_0x2e2e15(0x1fb)]:_0x2e2e15(0x1f3),[constants_1[_0x2e2e15(0x1fd)]+'TargetId__c']:this[_0x2e2e15(0x195)]},_0x1e0936={[constants_1[_0x2e2e15(0x1fd)]+'Is_Error__c']:!_0x412724,[constants_1[_0x2e2e15(0x1fd)]+_0x2e2e15(0x1d7)]:_0x412724,[constants_1[_0x2e2e15(0x1fd)]+'Status__c']:_0x13728b?status_enums_1[_0x2e2e15(0x205)]['EXCEPTION']:status_enums_1['MetadataLogStatus'][_0x2e2e15(0x1cb)],[constants_1[_0x2e2e15(0x1fd)]+_0x2e2e15(0x1e1)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x2e2e15(0x1c2)]:_0x2c78e1};await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x2e2e15(0x19c)][_0x2e2e15(0x1b1)]+'/'+constants_1[_0x2e2e15(0x1fd)]+'Metadata_Log__c/'+this[_0x2e2e15(0x229)],_0x1e0936),await this[_0x2e2e15(0x223)][_0x2e2e15(0x1bd)](flosum_constants_1[_0x2e2e15(0x19c)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x2e2e15(0x1ef),_0x5cd24b),this['_logger'][_0x2e2e15(0x1ba)]('Deploy\x20completed\x20'+(_0x412724?_0x2e2e15(0x1c8):_0x2e2e15(0x226))+'.'),await this[_0x2e2e15(0x1dc)]['updateLog']();}}exports[a402_0x44aef9(0x1ac)]=DeployService;function a402_0x3c2f(){const _0x217efe=['success','_metadataLogId','4683213UvxAMe','status','Type__c','Cannot\x20retrievers\x20all\x20attachments','set','../../../core','base64','export','_connectionVeeva','2574tjvQqz','retrieve','./vpk.service','_organisationId','BranchComponentHistoryFlosumComponentRetriever','bind','map','formFlosumDeploymentResults','values','Veeva\x20Deployment','FlosumConstants','../../shared/utils/fetch-attachments','./package-import.service','Cannot\x20retrieve\x20all\x20components.','Failure','toLowerCase','Create\x20Backup','7zpcrTe','./veeva.service','getFlosumComponents','logError','branchId','_veevaService','_organisationName','Veeva_Step_Name__c','fs/promises','DeployService','search','<a\x20href=','finishDeployWithError','Retrieving\x20attachments','ENDPOINT_UPSERT_RECORD','59050SwaBNB','Create\x20vpk\x20package','Retrieving\x20components','toString','Activity_Item__c','componentName','698vBINum','constructor','log','shortid','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','post','Success','createZip','flat','Cannot\x20Backup\x20more\x20than\x20200\x20components.','External_Deployment_Id__c','catch','Logger','validate','reduce','type','successfully','createBackup','updateLog','COMPLETED','PackageImportService','_instanceUrl','VpkService','default','2502LSeGQf','Body','PackageComponentStatus','import','_packageExportService','(((.+)+)+)+$','from','Succeed__c','Deployment\x20Result','saveDeploymentResults','saveLog','Join\x20all\x20mdl\x20into\x20one\x20zip','_logger','/Attachment','name','finishDeploy','length','Job_Completed__c','Date__c','veeva-deploy','Branch__c','deploymentAction','organisationId','__importDefault','lastIndexOf','_tempFolder','_timeZone','get','componentType','_componentIdList','3194710QbXuaq','Log__c','Save\x20Backup\x20to\x20Salesforce','../enums/status.enums','_packageImportService','Deployment','Component_Type__c','_systemLogger','_attachmentLogId','/vpk__','saveBackup','../classes/deploy/zip-creator.deploy','defineProperty','Activity_Type__c','apply','FLOSUM_NAMESPACE','../constants/flosum.constants','componentHistoryId','Save\x20log','DEPLOYED','writeFile','Branch','errors','MetadataLogStatus','packageId','metadataLogId','Component_Name__c','_salesforceService','attachmentLogId','396820qDDxCb','Save\x20Deployment\x20Results','packageComponentList','Org__c','filter','__esModule','timeZone','11827912IUHKxc','5835610VqfHOI','_branchId','SalesforceService','SalesforceDmlError','./package-export.service','6eNqvCi','organisationName','text/plain','\x20>\x20','BACKUP_ZIP_NAME','stepName','execute','_deploymentName','FlosumComponentVeevaComponentRetriever','createVpk','generate','_connectionSalesforce','\x20of\x20branch\x20to\x20Organization\x20','\x20</a>','with\x20error','retrieveAttachments'];a402_0x3c2f=function(){return _0x217efe;};return a402_0x3c2f();}