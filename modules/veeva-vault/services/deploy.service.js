const a401_0x20a30f=a401_0x18ed;function a401_0x18ed(_0x38898d,_0x25fb4e){const _0x34f328=a401_0x3a35();return a401_0x18ed=function(_0x382484,_0x48c6b7){_0x382484=_0x382484-0x16e;let _0x3a354f=_0x34f328[_0x382484];return _0x3a354f;},a401_0x18ed(_0x38898d,_0x25fb4e);}(function(_0x4dd1f6,_0x3c3464){const _0x1810c9=a401_0x18ed,_0x236eb3=_0x4dd1f6();while(!![]){try{const _0x4abbb9=parseInt(_0x1810c9(0x1f8))/0x1+-parseInt(_0x1810c9(0x1a2))/0x2+-parseInt(_0x1810c9(0x1c4))/0x3+-parseInt(_0x1810c9(0x204))/0x4*(-parseInt(_0x1810c9(0x1e0))/0x5)+parseInt(_0x1810c9(0x1d9))/0x6+-parseInt(_0x1810c9(0x209))/0x7*(parseInt(_0x1810c9(0x1df))/0x8)+-parseInt(_0x1810c9(0x1ad))/0x9;if(_0x4abbb9===_0x3c3464)break;else _0x236eb3['push'](_0x236eb3['shift']());}catch(_0x50021b){_0x236eb3['push'](_0x236eb3['shift']());}}}(a401_0x3a35,0x89e06));const a401_0x48c6b7=(function(){let _0x35d5b4=!![];return function(_0x32aa8a,_0x2532f7){const _0x39d07d=_0x35d5b4?function(){if(_0x2532f7){const _0x419a84=_0x2532f7['apply'](_0x32aa8a,arguments);return _0x2532f7=null,_0x419a84;}}:function(){};return _0x35d5b4=![],_0x39d07d;};}()),a401_0x382484=a401_0x48c6b7(this,function(){const _0x329d0a=a401_0x18ed;return a401_0x382484[_0x329d0a(0x18d)]()[_0x329d0a(0x192)](_0x329d0a(0x196))[_0x329d0a(0x18d)]()[_0x329d0a(0x182)](a401_0x382484)[_0x329d0a(0x192)](_0x329d0a(0x196));});a401_0x382484();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x612834){return _0x612834&&_0x612834['__esModule']?_0x612834:{'default':_0x612834};};Object[a401_0x20a30f(0x1e9)](exports,a401_0x20a30f(0x1b1),{'value':!![]}),exports[a401_0x20a30f(0x1a9)]=void 0x0;const jszip_1=__importDefault(require(a401_0x20a30f(0x1ca))),promises_1=require('fs/promises'),constants_1=require(a401_0x20a30f(0x1f0)),flosum_constants_1=require(a401_0x20a30f(0x19f)),veeva_service_1=require(a401_0x20a30f(0x1f4)),salesforce_service_1=require(a401_0x20a30f(0x188)),core_1=require('../../../core'),status_enums_1=require(a401_0x20a30f(0x206)),salesforce_dml_error_1=require(a401_0x20a30f(0x1f2)),shortid_1=__importDefault(require(a401_0x20a30f(0x1d1))),fetch_attachments_1=require(a401_0x20a30f(0x1ff)),package_import_service_1=require(a401_0x20a30f(0x1ce)),branch_component_history_flosum_component_retriever_1=require(a401_0x20a30f(0x1b9)),flosum_component_veeva_component_retriever_1=require(a401_0x20a30f(0x1d4)),package_export_service_1=require(a401_0x20a30f(0x1a0)),vpk_service_1=require(a401_0x20a30f(0x178)),zip_creator_deploy_1=require(a401_0x20a30f(0x1de));function a401_0x3a35(){const _0x2c8ef0=['<a\x20href=','deploymentName','error','DeployService','retrieve','formFlosumDeploymentResults','finishDeploy','3941829oAJHiC','import','deploymentAction','FLOSUM_NAMESPACE','__esModule','stepName','createBackup','FlosumConstants','Create\x20vpk\x20package','COMPLETED','PackageComponentStatus','componentHistoryId','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','ZipCreatorDeploy','application/zip','Form\x20Deployment\x20Results','log','Job_Completed__c','_connectionSalesforce','createVpk','\x20</a>','Branch','values','1398378xVtjkB','Success','base64','Action__c','saveLog','Save\x20log','jszip','Succeed__c','text/plain','componentType','./package-import.service','Veeva_Step_Name__c','componentName','shortid','Deployment','_salesforceService','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Result__c','organisationId','PackageImportService','/Attachment','5117742fvQOvh','ENDPOINT_UPSERT_RECORD','\x20has\x20been\x20created.','packageComponentList','Component_History__c','../classes/deploy/zip-creator.deploy','112NMVznm','810fXPbiL','_connectionVeeva','updateLog','Component_Type__c','status','retrieveAttachments','Type__c','type','name','defineProperty','patch','generateAsync','validate','post','Deployment_Result__c','.zip','../../../constants','FlosumComponentVeevaComponentRetriever','../classes/errors/salesforce-dml-error','Activity_Item__c','./veeva.service','_packageExportService','Metadata_Log__c','Body','495494TlyeSv','fetchAttachmentsDetailsByParentId','veeva-deploy','Failure','_systemLogger','getFlosumComponents','has','../../shared/utils/fetch-attachments','_packageImportService','PackageExportService','DEPLOYED','Org__c','13220KgCNke','\x20>\x20','../enums/status.enums','set','Branch__c','49819UbAzNk','createZip','packageId','logError','_vpkService','filter','get','length','Deployment\x20Result','/vpk__','Activity_Type__c','metadataLogId','reduce','_instanceUrl','Cannot\x20Backup\x20more\x20than\x20200\x20components.','_attachmentLogId','_organisationName','isDeployed','Metadata_Log__c/','finishDeployWithError','Backup','./vpk.service','VpkService','_veevaService','SalesforceDmlError','_timeZone','organisationName','_deploymentName','branchId','_logger','map','constructor','export','MetadataLogStatus','_componentIdList','bind','External_Deployment_Id__c','./salesforce.service','writeFile','catch','Status__c','saveBackup','toString','Is_Error__c','Deploy\x20completed\x20','default','_organisationId','search','Retrieving\x20components','_branchId','BACKUP_ZIP_NAME','(((.+)+)+)+$','\x20:\x20','toLowerCase','errors','Date__c','\x20of\x20branch\x20to\x20Organization\x20','_metadataLogId','slice','Join\x20all\x20mdl\x20into\x20one\x20zip','../constants/flosum.constants','./package-export.service','generate','630748RhQPeq','saveDeploymentResults','success','SalesforceService'];a401_0x3a35=function(){return _0x2c8ef0;};return a401_0x3a35();}class DeployService{constructor(_0x434b2c,_0x1ec2ed,_0xa68686,_0x41526b,_0xab8c15,_0x2b6eff){const _0x57b732=a401_0x20a30f;this[_0x57b732(0x1bf)]=_0x1ec2ed,this['_connectionVeeva']=_0xa68686,this[_0x57b732(0x180)]=_0x41526b,this['_tempFolder']=_0xab8c15,this[_0x57b732(0x170)]=_0x2b6eff,this['_branchId']=_0x434b2c[_0x57b732(0x17f)],this['_metadataLogId']=_0x434b2c[_0x57b732(0x16e)],this[_0x57b732(0x172)]=_0x434b2c['attachmentLogId'],this['_organisationId']=_0x434b2c[_0x57b732(0x1d6)],this[_0x57b732(0x17c)]=_0x434b2c['timeZone'],this[_0x57b732(0x173)]=_0x434b2c[_0x57b732(0x17d)],this['_componentIdList']=_0x434b2c['componentIdList'],this['_deploymentName']=_0x434b2c[_0x57b732(0x1a7)],this['_systemLogger']=new core_1['Logger'](_0x57b732(0x1fa)),this[_0x57b732(0x17a)]=new veeva_service_1['VeevaService']({'connection':this['_connectionVeeva'],'logger':this[_0x57b732(0x180)]}),this['_salesforceService']=new salesforce_service_1[(_0x57b732(0x1a5))]({'connection':this['_connectionSalesforce']}),this[_0x57b732(0x200)]=new package_import_service_1[(_0x57b732(0x1d7))]({'veevaService':this[_0x57b732(0x17a)],'connection':this[_0x57b732(0x1e1)],'logger':this[_0x57b732(0x180)],'saveLog':this[_0x57b732(0x1c8)][_0x57b732(0x186)](this)}),this['_packageExportService']=new package_export_service_1[(_0x57b732(0x201))]({'veevaService':this[_0x57b732(0x17a)],'connection':this['_connectionVeeva'],'logger':this[_0x57b732(0x180)]}),this[_0x57b732(0x20d)]=new vpk_service_1[(_0x57b732(0x179))]({'connection':this['_connectionVeeva']});}async['execute'](){const _0x275298=a401_0x20a30f;try{const _0x2d3428=await this['getFlosumComponents']();await this[_0x275298(0x180)][_0x275298(0x1e2)]();const _0x4f3340=await this[_0x275298(0x1b3)](_0x2d3428);await this[_0x275298(0x18c)](_0x4f3340);const _0x3ee9d2=await this[_0x275298(0x1e5)](_0x2d3428),_0x409462=await this[_0x275298(0x20a)](_0x3ee9d2),_0x57efad=await this[_0x275298(0x1c0)](_0x409462);await this[_0x275298(0x180)][_0x275298(0x1e2)]();const _0xced4a1=await this[_0x275298(0x200)][_0x275298(0x1ae)](_0x57efad);await this[_0x275298(0x180)]['updateLog']();const _0x5a3fb1=this[_0x275298(0x1ab)](_0x2d3428,_0xced4a1[_0x275298(0x1dc)]);await this['saveDeploymentResults'](_0x5a3fb1),await this[_0x275298(0x1ac)](_0xced4a1[_0x275298(0x174)],![],_0xced4a1[_0x275298(0x20b)]);}catch(_0x267d2e){await this[_0x275298(0x176)](_0x267d2e)[_0x275298(0x18a)](_0x2972f5=>this[_0x275298(0x1fc)][_0x275298(0x1a8)](_0x2972f5));}}async[a401_0x20a30f(0x1fd)](){const _0xd2f4cd=a401_0x20a30f,_0x1bad40=new Set(this[_0xd2f4cd(0x185)]);this['_logger'][_0xd2f4cd(0x1bd)](_0xd2f4cd(0x193));const _0x27553c=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this['_branchId'],'salesforceService':this[_0xd2f4cd(0x1d3)]})['retrieve'](),_0x41831f=_0x27553c['filter'](_0x87b3e6=>_0x1bad40[_0xd2f4cd(0x1fe)](_0x87b3e6['id']));if(_0x41831f['length']!==this[_0xd2f4cd(0x185)][_0xd2f4cd(0x210)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x41831f;}async['createBackup'](_0x3d7312){const _0x482157=a401_0x20a30f;var _0x2b8340;this['_logger']['log']('Create\x20Backup');const _0x13ceed=await new flosum_component_veeva_component_retriever_1[(_0x482157(0x1f1))]({'value':_0x3d7312,'veevaService':this['_veevaService'],'logger':this[_0x482157(0x180)]})[_0x482157(0x1aa)](),_0x446d79=await this[_0x482157(0x1f5)][_0x482157(0x183)](_0x13ceed,_0x482157(0x177));if(_0x446d79[_0x482157(0x210)]>0x1)throw new Error(_0x482157(0x171));return(_0x2b8340=_0x446d79[0x0])!==null&&_0x2b8340!==void 0x0?_0x2b8340:_0x446d79[0x0]=new jszip_1[(_0x482157(0x190))](),_0x446d79[0x0][_0x482157(0x1eb)]({'type':_0x482157(0x1c6)});}async[a401_0x20a30f(0x18c)](_0x5879f2){const _0x3766c7=a401_0x20a30f;this['_logger'][_0x3766c7(0x1bd)]('Save\x20Backup\x20to\x20Salesforce');const _0x29e857={'Body':_0x5879f2,'ContentType':_0x3766c7(0x1bb),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1[_0x3766c7(0x1b4)][_0x3766c7(0x195)]};await this[_0x3766c7(0x1bf)][_0x3766c7(0x1ed)](flosum_constants_1['FlosumConstants'][_0x3766c7(0x1da)]+_0x3766c7(0x1d8),_0x29e857);}async['retrieveAttachments'](_0x14a8d5){const _0x19717c=a401_0x20a30f;this['_logger']['log']('Retrieving\x20attachments');const _0x4b5ab3=await(0x0,fetch_attachments_1[_0x19717c(0x1f9)])(this[_0x19717c(0x1bf)],_0x14a8d5[_0x19717c(0x181)](_0xde3144=>_0xde3144[_0x19717c(0x1b8)])),_0x2e4e57=await(0x0,fetch_attachments_1[_0x19717c(0x1e5)])(_0x4b5ab3,this['_connectionSalesforce']);if(_0x2e4e57[_0x19717c(0x210)]!==this[_0x19717c(0x185)]['length'])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x2e4e57[_0x19717c(0x181)](_0x503f2f=>_0x503f2f[_0x19717c(0x1c3)][_0x19717c(0x1f7)]);}async[a401_0x20a30f(0x20a)](_0x1b8970){const _0x5bda89=a401_0x20a30f;this[_0x5bda89(0x180)]['log'](_0x5bda89(0x19e));const _0x149e04=await new zip_creator_deploy_1[(_0x5bda89(0x1ba))]({'attachmentBodies':_0x1b8970,'deploymentName':this[_0x5bda89(0x17e)]})['execute'](),_0x37b0c7=this['_tempFolder']+'/'+(0x0,shortid_1[_0x5bda89(0x190)])()+_0x5bda89(0x1ef);return await(0x0,promises_1[_0x5bda89(0x189)])(_0x37b0c7,_0x149e04),_0x37b0c7;}async[a401_0x20a30f(0x1c0)](_0x196918){const _0x9d9c39=a401_0x20a30f;this[_0x9d9c39(0x180)][_0x9d9c39(0x1bd)](_0x9d9c39(0x1b5));const _0x3786f6=await this[_0x9d9c39(0x20d)][_0x9d9c39(0x1a1)](_0x196918),_0x1ca137=this['_tempFolder']+_0x9d9c39(0x212)+_0x196918[_0x9d9c39(0x19d)](_0x196918['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x1ca137,_0x3786f6),await this[_0x9d9c39(0x20d)][_0x9d9c39(0x1ec)](_0x1ca137),_0x1ca137;}async['saveLog'](_0x576a97,_0x52ca4c){const _0x5166a8=a401_0x20a30f;this['_logger'][_0x5166a8(0x1bd)](_0x5166a8(0x1c9));const _0x220b0b={'Body':Buffer['from'](_0x576a97)[_0x5166a8(0x18d)]('base64'),'ContentType':_0x5166a8(0x1cc),'ParentId':this[_0x5166a8(0x19c)],'Name':_0x52ca4c};await this[_0x5166a8(0x1bf)][_0x5166a8(0x1ed)](flosum_constants_1[_0x5166a8(0x1b4)][_0x5166a8(0x1da)]+_0x5166a8(0x1d8),_0x220b0b);}[a401_0x20a30f(0x1ab)](_0x1d14cf,_0x4df6a5){const _0x2d6106=a401_0x20a30f;this[_0x2d6106(0x180)]['log'](_0x2d6106(0x1bc));const _0x358881=_0x1d14cf[_0x2d6106(0x16f)]((_0x48b48b,_0x374e58)=>_0x48b48b[_0x2d6106(0x207)]((_0x374e58[_0x2d6106(0x1cd)]+'.'+_0x374e58[_0x2d6106(0x1d0)])[_0x2d6106(0x198)](),_0x374e58),new Map());return _0x4df6a5[_0x2d6106(0x181)](_0x3cda1a=>{const _0x573b70=_0x2d6106;this['_logger'][_0x573b70(0x1bd)](_0x3cda1a[_0x573b70(0x1e7)]+'.'+_0x3cda1a[_0x573b70(0x1e8)]+_0x573b70(0x197)+_0x3cda1a['status']);const _0x4f1d31=(_0x3cda1a[_0x573b70(0x1e7)]+'.'+_0x3cda1a[_0x573b70(0x1e8)])[_0x573b70(0x198)](),_0x48b8d6=_0x358881[_0x573b70(0x20f)](_0x4f1d31);return{[constants_1[_0x573b70(0x1b0)]+_0x573b70(0x1e6)]:_0x573b70(0x211),[constants_1['FLOSUM_NAMESPACE']+_0x573b70(0x18b)]:_0x3cda1a[_0x573b70(0x1e4)]===status_enums_1[_0x573b70(0x1b7)][_0x573b70(0x202)]?_0x573b70(0x1c5):_0x573b70(0x1fb),[constants_1[_0x573b70(0x1b0)]+_0x573b70(0x1d5)]:_0x3cda1a[_0x573b70(0x1af)],[constants_1[_0x573b70(0x1b0)]+'Component_Name__c']:_0x3cda1a[_0x573b70(0x1e8)],[constants_1['FLOSUM_NAMESPACE']+_0x573b70(0x1e3)]:_0x3cda1a['type'],[constants_1['FLOSUM_NAMESPACE']+_0x573b70(0x1cf)]:_0x3cda1a[_0x573b70(0x1b2)],[constants_1[_0x573b70(0x1b0)]+_0x573b70(0x203)]:this['_organisationId'],[constants_1[_0x573b70(0x1b0)]+_0x573b70(0x1f6)]:this[_0x573b70(0x19c)],[constants_1[_0x573b70(0x1b0)]+_0x573b70(0x1dd)]:_0x48b8d6[_0x573b70(0x1b8)]};});}async[a401_0x20a30f(0x1a3)](_0x3cd3e3){const _0x332e0d=a401_0x20a30f;this[_0x332e0d(0x180)]['log']('Save\x20Deployment\x20Results');const _0x5f35e2=await this[_0x332e0d(0x1d3)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+_0x332e0d(0x1ee),_0x3cd3e3),_0x576f09=_0x5f35e2[_0x332e0d(0x20e)](_0x4141d1=>!_0x4141d1[_0x332e0d(0x1a4)])[_0x332e0d(0x181)](_0x30dbe2=>_0x30dbe2[_0x332e0d(0x199)])['flat']();if(_0x576f09['length'])throw new salesforce_dml_error_1[(_0x332e0d(0x17b))](_0x576f09);}async[a401_0x20a30f(0x176)](_0x15d0e0){const _0x15cdf3=a401_0x20a30f;this['_logger'][_0x15cdf3(0x20c)](_0x15d0e0),await this[_0x15cdf3(0x180)][_0x15cdf3(0x1e2)](),await this[_0x15cdf3(0x1ac)](![],!![],'');}async[a401_0x20a30f(0x1ac)](_0x5d90e3,_0x41dc33,_0x3cb6fc){const _0x272316=a401_0x20a30f,_0x4f98ad=_0x272316(0x1a6)+this[_0x272316(0x170)]+'/'+this['_metadataLogId']+_0x272316(0x205)+'Veeva\x20Deployment'+_0x272316(0x1c1),_0x206e01=_0x272316(0x1a6)+this[_0x272316(0x170)]+'/'+this[_0x272316(0x191)]+'\x20>'+this[_0x272316(0x173)]+'</a>',_0x4465ff=_0x4f98ad+_0x272316(0x19b)+_0x206e01+_0x272316(0x1db),_0x125d32={[constants_1[_0x272316(0x1b0)]+_0x272316(0x1c7)]:_0x4465ff,[constants_1['FLOSUM_NAMESPACE']+_0x272316(0x19a)]:new Date(),[constants_1[_0x272316(0x1b0)]+_0x272316(0x208)]:this[_0x272316(0x194)],[constants_1[_0x272316(0x1b0)]+_0x272316(0x1f3)]:_0x272316(0x1c2),[constants_1['FLOSUM_NAMESPACE']+_0x272316(0x213)]:_0x272316(0x1d2),[constants_1[_0x272316(0x1b0)]+'TargetId__c']:this[_0x272316(0x191)]},_0x3db9d9={[constants_1[_0x272316(0x1b0)]+_0x272316(0x18e)]:!_0x5d90e3,[constants_1[_0x272316(0x1b0)]+_0x272316(0x1cb)]:_0x5d90e3,[constants_1[_0x272316(0x1b0)]+'Status__c']:_0x41dc33?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x272316(0x184)][_0x272316(0x1b6)],[constants_1[_0x272316(0x1b0)]+_0x272316(0x1be)]:!![],[constants_1[_0x272316(0x1b0)]+_0x272316(0x187)]:_0x3cb6fc};await this['_connectionSalesforce'][_0x272316(0x1ea)](flosum_constants_1[_0x272316(0x1b4)][_0x272316(0x1da)]+'/'+constants_1[_0x272316(0x1b0)]+_0x272316(0x175)+this[_0x272316(0x19c)],_0x3db9d9),await this[_0x272316(0x1bf)]['post'](flosum_constants_1[_0x272316(0x1b4)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0x125d32),this[_0x272316(0x180)][_0x272316(0x1bd)](_0x272316(0x18f)+(_0x5d90e3?'successfully':'with\x20error')+'.'),await this['_logger']['updateLog']();}}exports[a401_0x20a30f(0x1a9)]=DeployService;