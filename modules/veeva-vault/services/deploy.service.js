const a373_0x8a5624=a373_0x145c;(function(_0x27c419,_0x5bc7cb){const _0x4b5446=a373_0x145c,_0xd2ae57=_0x27c419();while(!![]){try{const _0x3a2be3=parseInt(_0x4b5446(0x1e2))/0x1+parseInt(_0x4b5446(0x1eb))/0x2+-parseInt(_0x4b5446(0x207))/0x3+parseInt(_0x4b5446(0x1b8))/0x4*(parseInt(_0x4b5446(0x1de))/0x5)+parseInt(_0x4b5446(0x23b))/0x6+parseInt(_0x4b5446(0x227))/0x7*(-parseInt(_0x4b5446(0x20e))/0x8)+-parseInt(_0x4b5446(0x20a))/0x9;if(_0x3a2be3===_0x5bc7cb)break;else _0xd2ae57['push'](_0xd2ae57['shift']());}catch(_0xdd06fd){_0xd2ae57['push'](_0xd2ae57['shift']());}}}(a373_0x2a6e,0xe9246));const a373_0x1b733=(function(){let _0x3e2aa5=!![];return function(_0x23344d,_0x2bb52f){const _0x6c2a31=_0x3e2aa5?function(){const _0x4a46a7=a373_0x145c;if(_0x2bb52f){const _0x2fda9c=_0x2bb52f[_0x4a46a7(0x21c)](_0x23344d,arguments);return _0x2bb52f=null,_0x2fda9c;}}:function(){};return _0x3e2aa5=![],_0x6c2a31;};}()),a373_0x4001b8=a373_0x1b733(this,function(){const _0x16ad8a=a373_0x145c;return a373_0x4001b8['toString']()['search'](_0x16ad8a(0x234))[_0x16ad8a(0x218)]()[_0x16ad8a(0x1d7)](a373_0x4001b8)[_0x16ad8a(0x208)]('(((.+)+)+)+$');});a373_0x4001b8();function a373_0x145c(_0x416211,_0xa59efd){const _0x29b937=a373_0x2a6e();return a373_0x145c=function(_0x4001b8,_0x1b733){_0x4001b8=_0x4001b8-0x1af;let _0x2a6e04=_0x29b937[_0x4001b8];return _0x2a6e04;},a373_0x145c(_0x416211,_0xa59efd);}'use strict';var __importDefault=this&&this[a373_0x8a5624(0x20f)]||function(_0x5ec06e){const _0x4fcaac=a373_0x8a5624;return _0x5ec06e&&_0x5ec06e[_0x4fcaac(0x220)]?_0x5ec06e:{'default':_0x5ec06e};};Object[a373_0x8a5624(0x219)](exports,a373_0x8a5624(0x220),{'value':!![]}),exports[a373_0x8a5624(0x1e8)]=void 0x0;const jszip_1=__importDefault(require(a373_0x8a5624(0x1ca))),promises_1=require(a373_0x8a5624(0x1b7)),constants_1=require(a373_0x8a5624(0x22a)),flosum_constants_1=require(a373_0x8a5624(0x1ed)),veeva_service_1=require(a373_0x8a5624(0x1c7)),salesforce_service_1=require(a373_0x8a5624(0x1d4)),core_1=require('../../../core'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a373_0x8a5624(0x1f4)),shortid_1=__importDefault(require(a373_0x8a5624(0x1f8))),fetch_attachments_1=require(a373_0x8a5624(0x1c9)),package_import_service_1=require(a373_0x8a5624(0x1bd)),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a373_0x8a5624(0x1fa)),zip_creator_deploy_1=require(a373_0x8a5624(0x23d));class DeployService{constructor(_0xfcb711,_0x4e90f7,_0x323c14,_0x5c49cf,_0x5e8e3c,_0x35dda8){const _0x3b479e=a373_0x8a5624;this[_0x3b479e(0x1be)]=_0x4e90f7,this[_0x3b479e(0x1f7)]=_0x323c14,this[_0x3b479e(0x1b2)]=_0x5c49cf,this[_0x3b479e(0x1e1)]=_0x5e8e3c,this['_instanceUrl']=_0x35dda8,this[_0x3b479e(0x1fb)]=_0xfcb711[_0x3b479e(0x1e6)],this[_0x3b479e(0x1d3)]=_0xfcb711[_0x3b479e(0x1f2)],this[_0x3b479e(0x215)]=_0xfcb711[_0x3b479e(0x1c2)],this[_0x3b479e(0x1d1)]=_0xfcb711[_0x3b479e(0x238)],this[_0x3b479e(0x1da)]=_0xfcb711['timeZone'],this[_0x3b479e(0x203)]=_0xfcb711[_0x3b479e(0x1cf)],this['_componentIdList']=_0xfcb711[_0x3b479e(0x233)],this['_deploymentName']=_0xfcb711[_0x3b479e(0x23f)],this[_0x3b479e(0x23e)]=new core_1[(_0x3b479e(0x209))](_0x3b479e(0x1d8)),this[_0x3b479e(0x1dc)]=new veeva_service_1['VeevaService']({'connection':this[_0x3b479e(0x1f7)],'logger':this['_logger']}),this['_salesforceService']=new salesforce_service_1[(_0x3b479e(0x24a))]({'connection':this[_0x3b479e(0x1be)]}),this[_0x3b479e(0x23a)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x3b479e(0x1dc)],'connection':this['_connectionVeeva'],'logger':this[_0x3b479e(0x1b2)],'saveLog':this[_0x3b479e(0x1ef)][_0x3b479e(0x1b3)](this)}),this[_0x3b479e(0x21a)]=new package_export_service_1[(_0x3b479e(0x240))]({'veevaService':this[_0x3b479e(0x1dc)],'connection':this[_0x3b479e(0x1f7)],'logger':this[_0x3b479e(0x1b2)]}),this['_vpkService']=new vpk_service_1['VpkService']({'connection':this[_0x3b479e(0x1f7)]});}async[a373_0x8a5624(0x221)](){const _0x4ac069=a373_0x8a5624;try{const _0x50de7c=await this[_0x4ac069(0x21d)]();await this[_0x4ac069(0x1b2)][_0x4ac069(0x1c6)]();const _0x277706=await this[_0x4ac069(0x1cc)](_0x50de7c);await this[_0x4ac069(0x1b4)](_0x277706);const _0x24c1a6=await this[_0x4ac069(0x247)](_0x50de7c),_0x1f3518=await this['createZip'](_0x24c1a6),_0x1ebfd6=await this[_0x4ac069(0x212)](_0x1f3518);await this[_0x4ac069(0x1b2)][_0x4ac069(0x1c6)]();const _0x3389e0=await this[_0x4ac069(0x23a)]['import'](_0x1ebfd6);await this[_0x4ac069(0x1b2)][_0x4ac069(0x1c6)]();const _0x10d419=this[_0x4ac069(0x1d6)](_0x50de7c,_0x3389e0[_0x4ac069(0x246)]);await this[_0x4ac069(0x20c)](_0x10d419),await this[_0x4ac069(0x1af)](_0x3389e0[_0x4ac069(0x223)],![],_0x3389e0[_0x4ac069(0x1c5)]);}catch(_0x31b1a2){await this[_0x4ac069(0x1ee)](_0x31b1a2)[_0x4ac069(0x1e5)](_0x255e28=>this[_0x4ac069(0x23e)][_0x4ac069(0x1d9)](_0x255e28));}}async[a373_0x8a5624(0x21d)](){const _0x19879e=a373_0x8a5624,_0xdf94f2=new Set(this['_componentIdList']);this[_0x19879e(0x1b2)][_0x19879e(0x239)](_0x19879e(0x1b1));const _0x25f4f8=await new branch_component_history_flosum_component_retriever_1[(_0x19879e(0x231))]({'value':this[_0x19879e(0x1fb)],'salesforceService':this['_salesforceService']})['retrieve'](),_0x31cfdf=_0x25f4f8['filter'](_0x220fd4=>_0xdf94f2[_0x19879e(0x1e4)](_0x220fd4['id']));if(_0x31cfdf[_0x19879e(0x1fc)]!==this['_componentIdList'][_0x19879e(0x1fc)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x31cfdf;}async[a373_0x8a5624(0x1cc)](_0x2a3e07){const _0x76f7b5=a373_0x8a5624;var _0x572c32;this['_logger'][_0x76f7b5(0x239)](_0x76f7b5(0x21b));const _0x171370=await new flosum_component_veeva_component_retriever_1[(_0x76f7b5(0x1ba))]({'value':_0x2a3e07,'veevaService':this[_0x76f7b5(0x1dc)],'logger':this[_0x76f7b5(0x1b2)]})['retrieve'](),_0x5bce78=await this['_packageExportService'][_0x76f7b5(0x241)](_0x171370,_0x76f7b5(0x201));if(_0x5bce78[_0x76f7b5(0x1fc)]>0x1)throw new Error(_0x76f7b5(0x213));return(_0x572c32=_0x5bce78[0x0])!==null&&_0x572c32!==void 0x0?_0x572c32:_0x5bce78[0x0]=new jszip_1[(_0x76f7b5(0x22b))](),_0x5bce78[0x0][_0x76f7b5(0x1c3)]({'type':_0x76f7b5(0x217)});}async[a373_0x8a5624(0x1b4)](_0xe5a6ce){const _0x3d8b66=a373_0x8a5624;this['_logger'][_0x3d8b66(0x239)](_0x3d8b66(0x222));const _0x42c168={'Body':_0xe5a6ce,'ContentType':'application/zip','ParentId':this[_0x3d8b66(0x1d3)],'Name':flosum_constants_1[_0x3d8b66(0x1db)]['BACKUP_ZIP_NAME']};await this['_connectionSalesforce'][_0x3d8b66(0x224)](flosum_constants_1[_0x3d8b66(0x1db)][_0x3d8b66(0x230)]+_0x3d8b66(0x1bf),_0x42c168);}async[a373_0x8a5624(0x247)](_0x3a266a){const _0x350c2f=a373_0x8a5624;this[_0x350c2f(0x1b2)][_0x350c2f(0x239)](_0x350c2f(0x211));const _0x5db542=await(0x0,fetch_attachments_1[_0x350c2f(0x1f3)])(this['_connectionSalesforce'],_0x3a266a['map'](_0x433026=>_0x433026[_0x350c2f(0x204)])),_0x460854=await(0x0,fetch_attachments_1[_0x350c2f(0x247)])(_0x5db542,this[_0x350c2f(0x1be)]);if(_0x460854[_0x350c2f(0x1fc)]!==this[_0x350c2f(0x1fd)][_0x350c2f(0x1fc)])throw new Error(_0x350c2f(0x1c1));return _0x460854['map'](_0x23d36a=>_0x23d36a[_0x350c2f(0x232)][_0x350c2f(0x1ea)]);}async[a373_0x8a5624(0x22c)](_0x463420){const _0x3710db=a373_0x8a5624;this[_0x3710db(0x1b2)][_0x3710db(0x239)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x2e7001=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x463420,'deploymentName':this[_0x3710db(0x1b9)]})[_0x3710db(0x221)](),_0x347709=this['_tempFolder']+'/'+(0x0,shortid_1[_0x3710db(0x22b)])()+_0x3710db(0x242);return await(0x0,promises_1[_0x3710db(0x1ec)])(_0x347709,_0x2e7001),_0x347709;}async[a373_0x8a5624(0x212)](_0x47e016){const _0x4e5269=a373_0x8a5624;this['_logger'][_0x4e5269(0x239)]('Create\x20vpk\x20package');const _0x16f00a=await this[_0x4e5269(0x1f9)]['generate'](_0x47e016),_0x37694d=this[_0x4e5269(0x1e1)]+_0x4e5269(0x206)+_0x47e016['slice'](_0x47e016[_0x4e5269(0x226)]('/')+0x1);return await(0x0,promises_1[_0x4e5269(0x1ec)])(_0x37694d,_0x16f00a),await this[_0x4e5269(0x1f9)][_0x4e5269(0x244)](_0x37694d),_0x37694d;}async[a373_0x8a5624(0x1ef)](_0x4d6403,_0x8ec534){const _0x4dbf73=a373_0x8a5624;this[_0x4dbf73(0x1b2)][_0x4dbf73(0x239)]('Save\x20log');const _0x4627d5={'Body':Buffer['from'](_0x4d6403)[_0x4dbf73(0x218)](_0x4dbf73(0x217)),'ContentType':'text/plain','ParentId':this[_0x4dbf73(0x1d3)],'Name':_0x8ec534};await this[_0x4dbf73(0x1be)][_0x4dbf73(0x224)](flosum_constants_1[_0x4dbf73(0x1db)][_0x4dbf73(0x230)]+_0x4dbf73(0x1bf),_0x4627d5);}['formFlosumDeploymentResults'](_0x5bb0f9,_0x216c7d){const _0x408482=a373_0x8a5624;this[_0x408482(0x1b2)][_0x408482(0x239)]('Form\x20Deployment\x20Results');const _0x4b9d2c=_0x5bb0f9[_0x408482(0x1fe)]((_0x3e8ca6,_0x382b11)=>_0x3e8ca6[_0x408482(0x1e0)]((_0x382b11[_0x408482(0x21f)]+'.'+_0x382b11[_0x408482(0x235)])['toLowerCase'](),_0x382b11),new Map());return _0x216c7d[_0x408482(0x1f0)](_0x1a740a=>{const _0x21d613=_0x408482;this[_0x21d613(0x1b2)][_0x21d613(0x239)](_0x1a740a[_0x21d613(0x216)]+'.'+_0x1a740a[_0x21d613(0x1ff)]+'\x20:\x20'+_0x1a740a[_0x21d613(0x24d)]);const _0x37e5fa=(_0x1a740a[_0x21d613(0x216)]+'.'+_0x1a740a[_0x21d613(0x1ff)])[_0x21d613(0x20d)](),_0x85d2d4=_0x4b9d2c[_0x21d613(0x243)](_0x37e5fa);return{[constants_1[_0x21d613(0x1e9)]+_0x21d613(0x22e)]:_0x21d613(0x1ce),[constants_1['FLOSUM_NAMESPACE']+_0x21d613(0x1e3)]:_0x1a740a['status']===status_enums_1[_0x21d613(0x1c8)]['DEPLOYED']?'Success':_0x21d613(0x236),[constants_1['FLOSUM_NAMESPACE']+_0x21d613(0x1cb)]:_0x1a740a[_0x21d613(0x245)],[constants_1['FLOSUM_NAMESPACE']+_0x21d613(0x22d)]:_0x1a740a['name'],[constants_1[_0x21d613(0x1e9)]+_0x21d613(0x1b6)]:_0x1a740a[_0x21d613(0x216)],[constants_1['FLOSUM_NAMESPACE']+_0x21d613(0x1b0)]:_0x1a740a[_0x21d613(0x202)],[constants_1[_0x21d613(0x1e9)]+_0x21d613(0x1d0)]:this[_0x21d613(0x1d1)],[constants_1[_0x21d613(0x1e9)]+_0x21d613(0x228)]:this[_0x21d613(0x1d3)],[constants_1[_0x21d613(0x1e9)]+_0x21d613(0x1df)]:_0x85d2d4[_0x21d613(0x204)]};});}async[a373_0x8a5624(0x20c)](_0x7d532a){const _0x12a5b8=a373_0x8a5624;this[_0x12a5b8(0x1b2)][_0x12a5b8(0x239)]('Save\x20Deployment\x20Results');const _0x21bb27=await this[_0x12a5b8(0x210)][_0x12a5b8(0x248)](constants_1[_0x12a5b8(0x1e9)]+_0x12a5b8(0x1cd),_0x7d532a),_0x28d9b0=_0x21bb27[_0x12a5b8(0x1c4)](_0x5cf332=>!_0x5cf332[_0x12a5b8(0x1d2)])['map'](_0x251d48=>_0x251d48[_0x12a5b8(0x24c)])['flat']();if(_0x28d9b0[_0x12a5b8(0x1fc)])throw new salesforce_dml_error_1[(_0x12a5b8(0x229))](_0x28d9b0);}async['finishDeployWithError'](_0x40bf54){const _0x2a2c39=a373_0x8a5624;this[_0x2a2c39(0x1b2)]['logError'](_0x40bf54),await this[_0x2a2c39(0x1b2)][_0x2a2c39(0x1c6)](),await this[_0x2a2c39(0x1af)](![],!![],'');}async[a373_0x8a5624(0x1af)](_0x24e6fb,_0x38cbeb,_0x35ed27){const _0x4fd4a8=a373_0x8a5624,_0x34d541=_0x4fd4a8(0x237)+this[_0x4fd4a8(0x1c0)]+'/'+this[_0x4fd4a8(0x1d3)]+_0x4fd4a8(0x24b)+_0x4fd4a8(0x1b5)+'\x20</a>',_0xabe788='<a\x20href='+this['_instanceUrl']+'/'+this[_0x4fd4a8(0x1d1)]+'\x20>'+this[_0x4fd4a8(0x203)]+'</a>',_0x23297d=_0x34d541+_0x4fd4a8(0x22f)+_0xabe788+_0x4fd4a8(0x1dd),_0xdc673={[constants_1[_0x4fd4a8(0x1e9)]+_0x4fd4a8(0x1bb)]:_0x23297d,[constants_1[_0x4fd4a8(0x1e9)]+_0x4fd4a8(0x1d5)]:new Date(),[constants_1[_0x4fd4a8(0x1e9)]+'Branch__c']:this['_branchId'],[constants_1[_0x4fd4a8(0x1e9)]+_0x4fd4a8(0x249)]:_0x4fd4a8(0x1bc),[constants_1[_0x4fd4a8(0x1e9)]+_0x4fd4a8(0x20b)]:_0x4fd4a8(0x205),[constants_1['FLOSUM_NAMESPACE']+_0x4fd4a8(0x21e)]:this['_organisationId']},_0x191515={[constants_1[_0x4fd4a8(0x1e9)]+_0x4fd4a8(0x24e)]:!_0x24e6fb,[constants_1[_0x4fd4a8(0x1e9)]+_0x4fd4a8(0x1f1)]:_0x24e6fb,[constants_1['FLOSUM_NAMESPACE']+_0x4fd4a8(0x1e3)]:_0x38cbeb?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x4fd4a8(0x1f6)][_0x4fd4a8(0x214)],[constants_1[_0x4fd4a8(0x1e9)]+'Job_Completed__c']:!![],[constants_1[_0x4fd4a8(0x1e9)]+_0x4fd4a8(0x225)]:_0x35ed27};await this[_0x4fd4a8(0x1be)][_0x4fd4a8(0x200)](flosum_constants_1[_0x4fd4a8(0x1db)][_0x4fd4a8(0x230)]+'/'+constants_1[_0x4fd4a8(0x1e9)]+_0x4fd4a8(0x1f5)+this['_metadataLogId'],_0x191515),await this[_0x4fd4a8(0x1be)][_0x4fd4a8(0x224)](flosum_constants_1[_0x4fd4a8(0x1db)][_0x4fd4a8(0x230)]+'/'+constants_1[_0x4fd4a8(0x1e9)]+'Log__c',_0xdc673),this['_logger'][_0x4fd4a8(0x239)]('Deploy\x20completed\x20'+(_0x24e6fb?_0x4fd4a8(0x1e7):_0x4fd4a8(0x23c))+'.'),await this['_logger'][_0x4fd4a8(0x1c6)]();}}exports[a373_0x8a5624(0x1e8)]=DeployService;function a373_0x2a6e(){const _0x2694e6=['finishDeploy','Veeva_Step_Name__c','Retrieving\x20components','_logger','bind','saveBackup','Veeva\x20Deployment','Component_Type__c','fs/promises','33964CzjbUH','_deploymentName','FlosumComponentVeevaComponentRetriever','Action__c','Branch','./package-import.service','_connectionSalesforce','/Attachment','_instanceUrl','Cannot\x20retrievers\x20all\x20attachments','attachmentLogId','generateAsync','filter','packageId','updateLog','./veeva.service','PackageComponentStatus','../../shared/utils/fetch-attachments','jszip','Result__c','createBackup','Deployment_Result__c','Deployment\x20Result','organisationName','Org__c','_organisationId','success','_metadataLogId','./salesforce.service','Date__c','formFlosumDeploymentResults','constructor','veeva-deploy','error','_timeZone','FlosumConstants','_veevaService','\x20has\x20been\x20created.','450MkFuvc','Component_History__c','set','_tempFolder','1019878mnplGu','Status__c','has','catch','branchId','successfully','DeployService','FLOSUM_NAMESPACE','Body','1447212bQPxxN','writeFile','../constants/flosum.constants','finishDeployWithError','saveLog','map','Succeed__c','metadataLogId','fetchAttachmentsDetailsByParentId','../classes/errors/salesforce-dml-error','Metadata_Log__c/','MetadataLogStatus','_connectionVeeva','shortid','_vpkService','./vpk.service','_branchId','length','_componentIdList','reduce','name','patch','Backup','stepName','_organisationName','componentHistoryId','Deployment','/vpk__','405702kWZkZU','search','Logger','10710126SANPOC','Activity_Type__c','saveDeploymentResults','toLowerCase','4312744neYWhg','__importDefault','_salesforceService','Retrieving\x20attachments','createVpk','Cannot\x20Backup\x20more\x20than\x20200\x20components.','COMPLETED','_attachmentLogId','type','base64','toString','defineProperty','_packageExportService','Create\x20Backup','apply','getFlosumComponents','TargetId__c','componentType','__esModule','execute','Save\x20Backup\x20to\x20Salesforce','isDeployed','post','External_Deployment_Id__c','lastIndexOf','21rsQjNv','Metadata_Log__c','SalesforceDmlError','../../../constants','default','createZip','Component_Name__c','Type__c','\x20of\x20branch\x20to\x20Organization\x20','ENDPOINT_UPSERT_RECORD','BranchComponentHistoryFlosumComponentRetriever','values','componentIdList','(((.+)+)+)+$','componentName','Failure','<a\x20href=','organisationId','log','_packageImportService','8338818wdejix','with\x20error','../classes/deploy/zip-creator.deploy','_systemLogger','deploymentName','PackageExportService','export','.zip','get','validate','deploymentAction','packageComponentList','retrieveAttachments','insertMultipleRecords','Activity_Item__c','SalesforceService','\x20>\x20','errors','status','Is_Error__c'];a373_0x2a6e=function(){return _0x2694e6;};return a373_0x2a6e();}