const a374_0x284399=a374_0x543c;(function(_0x178edd,_0x2b33aa){const _0x44bb03=a374_0x543c,_0x399422=_0x178edd();while(!![]){try{const _0x153430=-parseInt(_0x44bb03(0x1d1))/0x1*(-parseInt(_0x44bb03(0x1de))/0x2)+parseInt(_0x44bb03(0x1a4))/0x3+parseInt(_0x44bb03(0x22f))/0x4+parseInt(_0x44bb03(0x1a2))/0x5*(-parseInt(_0x44bb03(0x1d9))/0x6)+-parseInt(_0x44bb03(0x232))/0x7*(-parseInt(_0x44bb03(0x1b7))/0x8)+-parseInt(_0x44bb03(0x23d))/0x9*(parseInt(_0x44bb03(0x1b4))/0xa)+parseInt(_0x44bb03(0x215))/0xb*(-parseInt(_0x44bb03(0x1f5))/0xc);if(_0x153430===_0x2b33aa)break;else _0x399422['push'](_0x399422['shift']());}catch(_0x12e22c){_0x399422['push'](_0x399422['shift']());}}}(a374_0x26f0,0xb7a69));const a374_0x3fe50a=(function(){let _0xa2c08c=!![];return function(_0x49af30,_0x2c9db3){const _0x66964d=_0xa2c08c?function(){const _0x275bb2=a374_0x543c;if(_0x2c9db3){const _0x4717c3=_0x2c9db3[_0x275bb2(0x1da)](_0x49af30,arguments);return _0x2c9db3=null,_0x4717c3;}}:function(){};return _0xa2c08c=![],_0x66964d;};}()),a374_0x3357e3=a374_0x3fe50a(this,function(){const _0x4b7979=a374_0x543c;return a374_0x3357e3[_0x4b7979(0x21f)]()[_0x4b7979(0x222)](_0x4b7979(0x1b8))[_0x4b7979(0x21f)]()[_0x4b7979(0x1f8)](a374_0x3357e3)['search'](_0x4b7979(0x1b8));});a374_0x3357e3();'use strict';var __importDefault=this&&this[a374_0x284399(0x1cf)]||function(_0x90ccbc){const _0x37f77e=a374_0x284399;return _0x90ccbc&&_0x90ccbc[_0x37f77e(0x1a8)]?_0x90ccbc:{'default':_0x90ccbc};};function a374_0x543c(_0x2f422d,_0x5902d3){const _0x538d73=a374_0x26f0();return a374_0x543c=function(_0x3357e3,_0x3fe50a){_0x3357e3=_0x3357e3-0x19f;let _0x26f0ef=_0x538d73[_0x3357e3];return _0x26f0ef;},a374_0x543c(_0x2f422d,_0x5902d3);}Object[a374_0x284399(0x230)](exports,a374_0x284399(0x1a8),{'value':!![]}),exports[a374_0x284399(0x1c7)]=void 0x0;function a374_0x26f0(){const _0x550948=['Form\x20Deployment\x20Results','Success','flat','_vpkService','Join\x20all\x20mdl\x20into\x20one\x20zip','../enums/status.enums','EXCEPTION','get','Activity_Type__c','External_Deployment_Id__c','SalesforceService','DeployService','./veeva.service','_instanceUrl','Log__c','lastIndexOf','./package-export.service','createBackup','saveDeploymentResults','__importDefault','_connectionVeeva','3VsrskE','errors','_connectionSalesforce','insertMultipleRecords','Deployment\x20Result','../classes/errors/salesforce-dml-error','_salesforceService','metadataLogId','50646LQgJGj','apply','Save\x20Deployment\x20Results','Create\x20vpk\x20package','FlosumConstants','153258JnHusX','createVpk','FLOSUM_NAMESPACE','COMPLETED','_timeZone','../constants/flosum.constants','Succeed__c','saveLog','\x20of\x20branch\x20to\x20Organization\x20','Component_History__c','Status__c','updateLog','values','Body','Save\x20log','Metadata_Log__c/','packageComponentList','getFlosumComponents','Failure','Is_Error__c','from','writeFile','_deploymentName','444FpiDel','successfully','Action__c','constructor','finishDeploy','post','Deploy\x20completed\x20','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','organisationName','retrieveAttachments','_veevaService','status','fs/promises','Job_Completed__c','generate','\x20>\x20','name','componentHistoryId','deploymentAction','SalesforceDmlError','packageId','_branchId','map','_logger','text/plain','formFlosumDeploymentResults','stepName','../classes/deploy/zip-creator.deploy','_systemLogger','import','\x20has\x20been\x20created.','toLowerCase','647306jHLpAX','veeva-deploy','Deployment','isDeployed','filter','BACKUP_ZIP_NAME','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','MetadataLogStatus','DEPLOYED','base64','toString','<a\x20href=','Branch','search','export','with\x20error','Veeva_Step_Name__c','deploymentName','_componentIdList','retrieve','componentName','Cannot\x20retrieve\x20all\x20components.','has','shortid','Backup','Create\x20Backup','4782604qpzAJX','defineProperty','Deployment_Result__c','85981jlLKOh','success','_tempFolder','type','_organisationId','logError','organisationId','/Attachment','execute','Cannot\x20retrievers\x20all\x20attachments','Retrieving\x20attachments','261aiYKBq','FlosumComponentVeevaComponentRetriever','./salesforce.service','ENDPOINT_UPSERT_RECORD','_attachmentLogId','Component_Type__c','545bYtHdk','Logger','3802800jiUwCD','_organisationName','length','application/zip','__esModule','VeevaService','reduce','slice','Cannot\x20Backup\x20more\x20than\x20200\x20components.','error','ZipCreatorDeploy','_metadataLogId','\x20:\x20','saveBackup','Activity_Item__c','log','62890TCuncQ','createZip','./vpk.service','872naSzpU','(((.+)+)+)+$','timeZone','../../../constants','finishDeployWithError'];a374_0x26f0=function(){return _0x550948;};return a374_0x26f0();}const jszip_1=__importDefault(require('jszip')),promises_1=require(a374_0x284399(0x201)),constants_1=require(a374_0x284399(0x1ba)),flosum_constants_1=require(a374_0x284399(0x1e3)),veeva_service_1=require(a374_0x284399(0x1c8)),salesforce_service_1=require(a374_0x284399(0x23f)),core_1=require('../../../core'),status_enums_1=require(a374_0x284399(0x1c1)),salesforce_dml_error_1=require(a374_0x284399(0x1d6)),shortid_1=__importDefault(require(a374_0x284399(0x22c))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a374_0x284399(0x1fc)),flosum_component_veeva_component_retriever_1=require(a374_0x284399(0x21b)),package_export_service_1=require(a374_0x284399(0x1cc)),vpk_service_1=require(a374_0x284399(0x1b6)),zip_creator_deploy_1=require(a374_0x284399(0x210));class DeployService{constructor(_0x1d1208,_0x5a23ed,_0x1b55d1,_0x3994d9,_0x2d3b9a,_0x284766){const _0x146969=a374_0x284399;this[_0x146969(0x1d3)]=_0x5a23ed,this[_0x146969(0x1d0)]=_0x1b55d1,this[_0x146969(0x20c)]=_0x3994d9,this['_tempFolder']=_0x2d3b9a,this[_0x146969(0x1c9)]=_0x284766,this[_0x146969(0x20a)]=_0x1d1208['branchId'],this[_0x146969(0x1af)]=_0x1d1208[_0x146969(0x1d8)],this[_0x146969(0x1a0)]=_0x1d1208['attachmentLogId'],this[_0x146969(0x236)]=_0x1d1208[_0x146969(0x238)],this[_0x146969(0x1e2)]=_0x1d1208[_0x146969(0x1b9)],this[_0x146969(0x1a5)]=_0x1d1208[_0x146969(0x1fd)],this[_0x146969(0x227)]=_0x1d1208['componentIdList'],this['_deploymentName']=_0x1d1208[_0x146969(0x226)],this[_0x146969(0x211)]=new core_1[(_0x146969(0x1a3))](_0x146969(0x216)),this[_0x146969(0x1ff)]=new veeva_service_1[(_0x146969(0x1a9))]({'connection':this['_connectionVeeva'],'logger':this['_logger']}),this[_0x146969(0x1d7)]=new salesforce_service_1[(_0x146969(0x1c6))]({'connection':this[_0x146969(0x1d3)]}),this['_packageImportService']=new package_import_service_1['PackageImportService']({'veevaService':this['_veevaService'],'connection':this[_0x146969(0x1d0)],'logger':this['_logger'],'saveLog':this['saveLog']['bind'](this)}),this['_packageExportService']=new package_export_service_1['PackageExportService']({'veevaService':this[_0x146969(0x1ff)],'connection':this['_connectionVeeva'],'logger':this[_0x146969(0x20c)]}),this['_vpkService']=new vpk_service_1['VpkService']({'connection':this[_0x146969(0x1d0)]});}async[a374_0x284399(0x23a)](){const _0x44fea7=a374_0x284399;try{const _0x1f160c=await this[_0x44fea7(0x1ef)]();await this[_0x44fea7(0x20c)][_0x44fea7(0x1e9)]();const _0x520a90=await this[_0x44fea7(0x1cd)](_0x1f160c);await this['saveBackup'](_0x520a90);const _0x5d06ba=await this[_0x44fea7(0x1fe)](_0x1f160c),_0x3c6a9a=await this[_0x44fea7(0x1b5)](_0x5d06ba),_0x99c909=await this[_0x44fea7(0x1df)](_0x3c6a9a);await this[_0x44fea7(0x20c)]['updateLog']();const _0x18ac1b=await this['_packageImportService'][_0x44fea7(0x212)](_0x99c909);await this[_0x44fea7(0x20c)]['updateLog']();const _0x4040e9=this[_0x44fea7(0x20e)](_0x1f160c,_0x18ac1b[_0x44fea7(0x1ee)]);await this[_0x44fea7(0x1ce)](_0x4040e9),await this[_0x44fea7(0x1f9)](_0x18ac1b[_0x44fea7(0x218)],![],_0x18ac1b[_0x44fea7(0x209)]);}catch(_0x46cd6c){await this['finishDeployWithError'](_0x46cd6c)['catch'](_0x39d7dc=>this[_0x44fea7(0x211)][_0x44fea7(0x1ad)](_0x39d7dc));}}async[a374_0x284399(0x1ef)](){const _0x3cf13b=a374_0x284399,_0x5dba90=new Set(this[_0x3cf13b(0x227)]);this['_logger']['log']('Retrieving\x20components');const _0x2fdc8d=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this['_branchId'],'salesforceService':this['_salesforceService']})[_0x3cf13b(0x228)](),_0x9334d7=_0x2fdc8d[_0x3cf13b(0x219)](_0x338857=>_0x5dba90[_0x3cf13b(0x22b)](_0x338857['id']));if(_0x9334d7['length']!==this['_componentIdList'][_0x3cf13b(0x1a6)])throw new Error(_0x3cf13b(0x22a));return _0x9334d7;}async[a374_0x284399(0x1cd)](_0x5d207a){const _0x45e8a6=a374_0x284399;var _0x211180;this[_0x45e8a6(0x20c)]['log'](_0x45e8a6(0x22e));const _0x2d769d=await new flosum_component_veeva_component_retriever_1[(_0x45e8a6(0x23e))]({'value':_0x5d207a,'veevaService':this['_veevaService'],'logger':this[_0x45e8a6(0x20c)]})[_0x45e8a6(0x228)](),_0x54bf54=await this['_packageExportService'][_0x45e8a6(0x223)](_0x2d769d,_0x45e8a6(0x22d));if(_0x54bf54['length']>0x1)throw new Error(_0x45e8a6(0x1ac));return(_0x211180=_0x54bf54[0x0])!==null&&_0x211180!==void 0x0?_0x211180:_0x54bf54[0x0]=new jszip_1['default'](),_0x54bf54[0x0]['generateAsync']({'type':_0x45e8a6(0x21e)});}async[a374_0x284399(0x1b1)](_0x3e7ad5){const _0x11255c=a374_0x284399;this[_0x11255c(0x20c)]['log']('Save\x20Backup\x20to\x20Salesforce');const _0x4858b1={'Body':_0x3e7ad5,'ContentType':_0x11255c(0x1a7),'ParentId':this[_0x11255c(0x1af)],'Name':flosum_constants_1['FlosumConstants'][_0x11255c(0x21a)]};await this[_0x11255c(0x1d3)][_0x11255c(0x1fa)](flosum_constants_1[_0x11255c(0x1dd)][_0x11255c(0x19f)]+_0x11255c(0x239),_0x4858b1);}async['retrieveAttachments'](_0x143ef0){const _0x279fb6=a374_0x284399;this['_logger'][_0x279fb6(0x1b3)](_0x279fb6(0x23c));const _0x4d0ab0=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this['_connectionSalesforce'],_0x143ef0['map'](_0xd73ab4=>_0xd73ab4[_0x279fb6(0x206)])),_0x53db1d=await(0x0,fetch_attachments_1[_0x279fb6(0x1fe)])(_0x4d0ab0,this[_0x279fb6(0x1d3)]);if(_0x53db1d[_0x279fb6(0x1a6)]!==this['_componentIdList']['length'])throw new Error(_0x279fb6(0x23b));return _0x53db1d[_0x279fb6(0x20b)](_0x5563a9=>_0x5563a9[_0x279fb6(0x1ea)][_0x279fb6(0x1eb)]);}async[a374_0x284399(0x1b5)](_0x5c7e14){const _0x573160=a374_0x284399;this[_0x573160(0x20c)][_0x573160(0x1b3)](_0x573160(0x1c0));const _0x15e645=await new zip_creator_deploy_1[(_0x573160(0x1ae))]({'attachmentBodies':_0x5c7e14,'deploymentName':this[_0x573160(0x1f4)]})[_0x573160(0x23a)](),_0x1f6e95=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+'.zip';return await(0x0,promises_1[_0x573160(0x1f3)])(_0x1f6e95,_0x15e645),_0x1f6e95;}async[a374_0x284399(0x1df)](_0x3a0b05){const _0x4dc370=a374_0x284399;this[_0x4dc370(0x20c)]['log'](_0x4dc370(0x1dc));const _0x431c82=await this[_0x4dc370(0x1bf)][_0x4dc370(0x203)](_0x3a0b05),_0x481dcf=this[_0x4dc370(0x234)]+'/vpk__'+_0x3a0b05[_0x4dc370(0x1ab)](_0x3a0b05[_0x4dc370(0x1cb)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x481dcf,_0x431c82),await this[_0x4dc370(0x1bf)]['validate'](_0x481dcf),_0x481dcf;}async[a374_0x284399(0x1e5)](_0x11aecd,_0x4ec310){const _0x2e1dda=a374_0x284399;this[_0x2e1dda(0x20c)][_0x2e1dda(0x1b3)](_0x2e1dda(0x1ec));const _0x5e4090={'Body':Buffer[_0x2e1dda(0x1f2)](_0x11aecd)[_0x2e1dda(0x21f)](_0x2e1dda(0x21e)),'ContentType':_0x2e1dda(0x20d),'ParentId':this[_0x2e1dda(0x1af)],'Name':_0x4ec310};await this[_0x2e1dda(0x1d3)][_0x2e1dda(0x1fa)](flosum_constants_1[_0x2e1dda(0x1dd)][_0x2e1dda(0x19f)]+_0x2e1dda(0x239),_0x5e4090);}[a374_0x284399(0x20e)](_0x497e27,_0x454fb0){const _0x120e2a=a374_0x284399;this[_0x120e2a(0x20c)][_0x120e2a(0x1b3)](_0x120e2a(0x1bc));const _0x4bb68f=_0x497e27[_0x120e2a(0x1aa)]((_0x1f9965,_0x52d906)=>_0x1f9965['set']((_0x52d906['componentType']+'.'+_0x52d906[_0x120e2a(0x229)])[_0x120e2a(0x214)](),_0x52d906),new Map());return _0x454fb0['map'](_0x10927a=>{const _0x3686d7=_0x120e2a;this['_logger'][_0x3686d7(0x1b3)](_0x10927a[_0x3686d7(0x235)]+'.'+_0x10927a[_0x3686d7(0x205)]+_0x3686d7(0x1b0)+_0x10927a[_0x3686d7(0x200)]);const _0x1b5632=(_0x10927a['type']+'.'+_0x10927a[_0x3686d7(0x205)])[_0x3686d7(0x214)](),_0x5b5c5a=_0x4bb68f[_0x3686d7(0x1c3)](_0x1b5632);return{[constants_1[_0x3686d7(0x1e0)]+'Type__c']:_0x3686d7(0x1d5),[constants_1['FLOSUM_NAMESPACE']+_0x3686d7(0x1e8)]:_0x10927a[_0x3686d7(0x200)]===status_enums_1['PackageComponentStatus'][_0x3686d7(0x21d)]?_0x3686d7(0x1bd):_0x3686d7(0x1f0),[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x10927a[_0x3686d7(0x207)],[constants_1[_0x3686d7(0x1e0)]+'Component_Name__c']:_0x10927a['name'],[constants_1['FLOSUM_NAMESPACE']+_0x3686d7(0x1a1)]:_0x10927a[_0x3686d7(0x235)],[constants_1[_0x3686d7(0x1e0)]+_0x3686d7(0x225)]:_0x10927a[_0x3686d7(0x20f)],[constants_1[_0x3686d7(0x1e0)]+'Org__c']:this['_organisationId'],[constants_1[_0x3686d7(0x1e0)]+'Metadata_Log__c']:this[_0x3686d7(0x1af)],[constants_1[_0x3686d7(0x1e0)]+_0x3686d7(0x1e7)]:_0x5b5c5a[_0x3686d7(0x206)]};});}async[a374_0x284399(0x1ce)](_0x26781c){const _0x2a7c1a=a374_0x284399;this[_0x2a7c1a(0x20c)][_0x2a7c1a(0x1b3)](_0x2a7c1a(0x1db));const _0xa6f5c0=await this[_0x2a7c1a(0x1d7)][_0x2a7c1a(0x1d4)](constants_1[_0x2a7c1a(0x1e0)]+_0x2a7c1a(0x231),_0x26781c),_0x3519a6=_0xa6f5c0[_0x2a7c1a(0x219)](_0x2b5235=>!_0x2b5235[_0x2a7c1a(0x233)])[_0x2a7c1a(0x20b)](_0x18f427=>_0x18f427[_0x2a7c1a(0x1d2)])[_0x2a7c1a(0x1be)]();if(_0x3519a6[_0x2a7c1a(0x1a6)])throw new salesforce_dml_error_1[(_0x2a7c1a(0x208))](_0x3519a6);}async[a374_0x284399(0x1bb)](_0x14477f){const _0x5e19bf=a374_0x284399;this[_0x5e19bf(0x20c)][_0x5e19bf(0x237)](_0x14477f),await this[_0x5e19bf(0x20c)][_0x5e19bf(0x1e9)](),await this[_0x5e19bf(0x1f9)](![],!![],'');}async['finishDeploy'](_0xdb59c6,_0x2df6e0,_0x4c0401){const _0x1233ed=a374_0x284399,_0x469fd2=_0x1233ed(0x220)+this[_0x1233ed(0x1c9)]+'/'+this[_0x1233ed(0x1af)]+_0x1233ed(0x204)+'Veeva\x20Deployment'+'\x20</a>',_0x2e3f1c=_0x1233ed(0x220)+this[_0x1233ed(0x1c9)]+'/'+this[_0x1233ed(0x236)]+'\x20>'+this[_0x1233ed(0x1a5)]+'</a>',_0x155941=_0x469fd2+_0x1233ed(0x1e6)+_0x2e3f1c+_0x1233ed(0x213),_0x317186={[constants_1[_0x1233ed(0x1e0)]+_0x1233ed(0x1f7)]:_0x155941,[constants_1['FLOSUM_NAMESPACE']+'Date__c']:new Date(),[constants_1[_0x1233ed(0x1e0)]+'Branch__c']:this['_branchId'],[constants_1['FLOSUM_NAMESPACE']+_0x1233ed(0x1b2)]:_0x1233ed(0x221),[constants_1[_0x1233ed(0x1e0)]+_0x1233ed(0x1c4)]:_0x1233ed(0x217),[constants_1[_0x1233ed(0x1e0)]+'TargetId__c']:this[_0x1233ed(0x236)]},_0x52db27={[constants_1[_0x1233ed(0x1e0)]+_0x1233ed(0x1f1)]:!_0xdb59c6,[constants_1[_0x1233ed(0x1e0)]+_0x1233ed(0x1e4)]:_0xdb59c6,[constants_1[_0x1233ed(0x1e0)]+_0x1233ed(0x1e8)]:_0x2df6e0?status_enums_1[_0x1233ed(0x21c)][_0x1233ed(0x1c2)]:status_enums_1['MetadataLogStatus'][_0x1233ed(0x1e1)],[constants_1[_0x1233ed(0x1e0)]+_0x1233ed(0x202)]:!![],[constants_1[_0x1233ed(0x1e0)]+_0x1233ed(0x1c5)]:_0x4c0401};await this[_0x1233ed(0x1d3)]['patch'](flosum_constants_1[_0x1233ed(0x1dd)][_0x1233ed(0x19f)]+'/'+constants_1[_0x1233ed(0x1e0)]+_0x1233ed(0x1ed)+this[_0x1233ed(0x1af)],_0x52db27),await this['_connectionSalesforce']['post'](flosum_constants_1['FlosumConstants'][_0x1233ed(0x19f)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x1233ed(0x1ca),_0x317186),this[_0x1233ed(0x20c)]['log'](_0x1233ed(0x1fb)+(_0xdb59c6?_0x1233ed(0x1f6):_0x1233ed(0x224))+'.'),await this[_0x1233ed(0x20c)]['updateLog']();}}exports['DeployService']=DeployService;