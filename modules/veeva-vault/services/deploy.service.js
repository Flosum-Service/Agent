function a357_0x5b3d(){const _0x250ddb=['MetadataLogStatus','Component_History__c','_deploymentName','Retrieving\x20attachments','../classes/errors/salesforce-dml-error','Type__c','ENDPOINT_UPSERT_RECORD','Failure','SalesforceService','_organisationId','8cVvKcE','veeva-deploy','45828ocnkdP','./veeva.service','4512180mypJTo','Activity_Type__c','40oVMbAj','createZip','<a\x20href=','search','Is_Error__c','Status__c','execute','flat','_packageExportService','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Date__c','</a>','42nHjAhM','Deploy\x20completed\x20','\x20:\x20','reduce','Cannot\x20Backup\x20more\x20than\x20200\x20components.','Veeva_Step_Name__c','createBackup','Create\x20Backup','errors','PackageImportService','_componentIdList','./salesforce.service','error','_connectionVeeva','success','_logger','VpkService','_veevaService','1588464HJkdjq','DEPLOYED','values','createVpk','_attachmentLogId','ZipCreatorDeploy','patch','componentName','bind','3462jHJAff','saveLog','saveBackup','_packageImportService','status','insertMultipleRecords','with\x20error','type','(((.+)+)+)+$','set','\x20of\x20branch\x20to\x20Organization\x20','\x20>\x20','defineProperty','catch','updateLog','6328qXATbh','\x20</a>','log','Metadata_Log__c','getFlosumComponents','metadataLogId','Form\x20Deployment\x20Results','DeployService','formFlosumDeploymentResults','toLowerCase','name','base64','map','_systemLogger','COMPLETED','FlosumConstants','1448030PiaEAy','_salesforceService','SalesforceDmlError','458943yPvmlr','generate','text/plain','toString','Success','Save\x20Deployment\x20Results','finishDeploy','_connectionSalesforce','../constants/flosum.constants','logError','../../../constants','_vpkService','branchId','length','successfully','_tempFolder','validate','organisationId','Join\x20all\x20mdl\x20into\x20one\x20zip','TargetId__c','Metadata_Log__c/','_branchId','FlosumComponentVeevaComponentRetriever','application/zip','apply','_instanceUrl','stepName','retrieve','slice','Retrieving\x20components','Cannot\x20retrieve\x20all\x20components.','.zip','organisationName','1979813VUncON','Deployment_Result__c','Veeva\x20Deployment','Succeed__c','deploymentAction','./vpk.service','componentIdList','Action__c','./package-import.service','fs/promises','post','_metadataLogId','filter','from','Create\x20vpk\x20package','finishDeployWithError','FLOSUM_NAMESPACE','constructor','48TeFIht','PackageComponentStatus','componentType','../classes/deploy/zip-creator.deploy','Component_Name__c','timeZone','componentHistoryId','packageId','Async_Request_Id__c','default','VeevaService','export','_organisationName','lastIndexOf','Body','__importDefault','\x20has\x20been\x20created.','retrieveAttachments','/vpk__','Save\x20log','PackageExportService','Logger','_timeZone'];a357_0x5b3d=function(){return _0x250ddb;};return a357_0x5b3d();}const a357_0x252cd7=a357_0x1524;function a357_0x1524(_0x2c9a81,_0x5765cb){const _0x21da9a=a357_0x5b3d();return a357_0x1524=function(_0x4641d2,_0x5bd65c){_0x4641d2=_0x4641d2-0x1ba;let _0x5b3d17=_0x21da9a[_0x4641d2];return _0x5b3d17;},a357_0x1524(_0x2c9a81,_0x5765cb);}(function(_0x336cce,_0x55df67){const _0x9df7a9=a357_0x1524,_0x14510f=_0x336cce();while(!![]){try{const _0xc8e9ce=-parseInt(_0x9df7a9(0x200))/0x1*(-parseInt(_0x9df7a9(0x1f0))/0x2)+-parseInt(_0x9df7a9(0x23d))/0x3*(parseInt(_0x9df7a9(0x1ee))/0x4)+-parseInt(_0x9df7a9(0x1f2))/0x5+-parseInt(_0x9df7a9(0x21b))/0x6*(-parseInt(_0x9df7a9(0x22a))/0x7)+parseInt(_0x9df7a9(0x1f4))/0x8*(parseInt(_0x9df7a9(0x212))/0x9)+parseInt(_0x9df7a9(0x23a))/0xa+-parseInt(_0x9df7a9(0x1bb))/0xb*(parseInt(_0x9df7a9(0x1cd))/0xc);if(_0xc8e9ce===_0x55df67)break;else _0x14510f['push'](_0x14510f['shift']());}catch(_0xd14e86){_0x14510f['push'](_0x14510f['shift']());}}}(a357_0x5b3d,0x8e525));const a357_0x5bd65c=(function(){let _0x42ac36=!![];return function(_0x1ba4ca,_0x52ec07){const _0x5042ae=_0x42ac36?function(){const _0x3a3c0c=a357_0x1524;if(_0x52ec07){const _0x29ccf2=_0x52ec07[_0x3a3c0c(0x255)](_0x1ba4ca,arguments);return _0x52ec07=null,_0x29ccf2;}}:function(){};return _0x42ac36=![],_0x5042ae;};}()),a357_0x4641d2=a357_0x5bd65c(this,function(){const _0x47f0cc=a357_0x1524;return a357_0x4641d2[_0x47f0cc(0x240)]()[_0x47f0cc(0x1f7)]('(((.+)+)+)+$')[_0x47f0cc(0x240)]()[_0x47f0cc(0x1cc)](a357_0x4641d2)[_0x47f0cc(0x1f7)](_0x47f0cc(0x223));});a357_0x4641d2();'use strict';var __importDefault=this&&this[a357_0x252cd7(0x1dc)]||function(_0x546cb9){return _0x546cb9&&_0x546cb9['__esModule']?_0x546cb9:{'default':_0x546cb9};};Object[a357_0x252cd7(0x227)](exports,'__esModule',{'value':!![]}),exports[a357_0x252cd7(0x231)]=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a357_0x252cd7(0x1c4)),constants_1=require(a357_0x252cd7(0x247)),flosum_constants_1=require(a357_0x252cd7(0x245)),veeva_service_1=require(a357_0x252cd7(0x1f1)),salesforce_service_1=require(a357_0x252cd7(0x20b)),core_1=require('../../../core'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a357_0x252cd7(0x1e8)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require(a357_0x252cd7(0x1c3)),branch_component_history_flosum_component_retriever_1=require(a357_0x252cd7(0x1fd)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a357_0x252cd7(0x1c0)),zip_creator_deploy_1=require(a357_0x252cd7(0x1d0));class DeployService{constructor(_0x29549b,_0x59155c,_0x23db19,_0x343e96,_0x402662,_0x11ad97){const _0x199311=a357_0x252cd7;this[_0x199311(0x244)]=_0x59155c,this[_0x199311(0x20d)]=_0x23db19,this[_0x199311(0x20f)]=_0x343e96,this[_0x199311(0x24c)]=_0x402662,this[_0x199311(0x256)]=_0x11ad97,this[_0x199311(0x252)]=_0x29549b[_0x199311(0x249)],this[_0x199311(0x1c6)]=_0x29549b[_0x199311(0x22f)],this[_0x199311(0x216)]=_0x29549b['attachmentLogId'],this[_0x199311(0x1ed)]=_0x29549b[_0x199311(0x24e)],this[_0x199311(0x1e3)]=_0x29549b[_0x199311(0x1d2)],this[_0x199311(0x1d9)]=_0x29549b[_0x199311(0x1ba)],this[_0x199311(0x20a)]=_0x29549b[_0x199311(0x1c1)],this[_0x199311(0x1e6)]=_0x29549b['deploymentName'],this[_0x199311(0x237)]=new core_1[(_0x199311(0x1e2))](_0x199311(0x1ef)),this[_0x199311(0x211)]=new veeva_service_1[(_0x199311(0x1d7))]({'connection':this[_0x199311(0x20d)],'logger':this[_0x199311(0x20f)]}),this[_0x199311(0x23b)]=new salesforce_service_1[(_0x199311(0x1ec))]({'connection':this['_connectionSalesforce']}),this['_packageImportService']=new package_import_service_1[(_0x199311(0x209))]({'veevaService':this[_0x199311(0x211)],'connection':this[_0x199311(0x20d)],'logger':this[_0x199311(0x20f)],'saveLog':this[_0x199311(0x21c)][_0x199311(0x21a)](this)}),this[_0x199311(0x1fc)]=new package_export_service_1[(_0x199311(0x1e1))]({'veevaService':this[_0x199311(0x211)],'connection':this[_0x199311(0x20d)],'logger':this['_logger']}),this['_vpkService']=new vpk_service_1[(_0x199311(0x210))]({'connection':this['_connectionVeeva']});}async[a357_0x252cd7(0x1fa)](){const _0x474921=a357_0x252cd7;try{const _0x2334f8=await this[_0x474921(0x22e)]();await this[_0x474921(0x20f)][_0x474921(0x229)]();const _0x51c3b3=await this[_0x474921(0x206)](_0x2334f8);await this['saveBackup'](_0x51c3b3);const _0x328d46=await this['retrieveAttachments'](_0x2334f8),_0x278522=await this[_0x474921(0x1f5)](_0x328d46),_0x178225=await this[_0x474921(0x215)](_0x278522);await this['_logger'][_0x474921(0x229)]();const _0x2b1af3=await this[_0x474921(0x21e)]['import'](_0x178225);await this[_0x474921(0x20f)][_0x474921(0x229)]();const _0x2a8b33=this[_0x474921(0x232)](_0x2334f8,_0x2b1af3['packageComponentList']);await this['saveDeploymentResults'](_0x2a8b33),await this[_0x474921(0x243)](_0x2b1af3['isDeployed'],![],_0x2b1af3[_0x474921(0x1d4)]);}catch(_0x406dd2){await this[_0x474921(0x1ca)](_0x406dd2)[_0x474921(0x228)](_0xc46308=>this['_systemLogger'][_0x474921(0x20c)](_0xc46308));}}async[a357_0x252cd7(0x22e)](){const _0x571051=a357_0x252cd7,_0x26cda7=new Set(this[_0x571051(0x20a)]);this[_0x571051(0x20f)][_0x571051(0x22c)](_0x571051(0x25a));const _0x155bf4=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x571051(0x252)],'salesforceService':this['_salesforceService']})[_0x571051(0x258)](),_0x43b058=_0x155bf4[_0x571051(0x1c7)](_0x32830b=>_0x26cda7['has'](_0x32830b['id']));if(_0x43b058['length']!==this[_0x571051(0x20a)][_0x571051(0x24a)])throw new Error(_0x571051(0x25b));return _0x43b058;}async[a357_0x252cd7(0x206)](_0x24b7d4){const _0x46ae90=a357_0x252cd7;var _0x3ddc4f;this[_0x46ae90(0x20f)][_0x46ae90(0x22c)](_0x46ae90(0x207));const _0x4aab7c=await new flosum_component_veeva_component_retriever_1[(_0x46ae90(0x253))]({'value':_0x24b7d4,'veevaService':this[_0x46ae90(0x211)],'logger':this['_logger']})[_0x46ae90(0x258)](),_0x3af0ce=await this[_0x46ae90(0x1fc)][_0x46ae90(0x1d8)](_0x4aab7c,'Backup');if(_0x3af0ce[_0x46ae90(0x24a)]>0x1)throw new Error(_0x46ae90(0x204));return(_0x3ddc4f=_0x3af0ce[0x0])!==null&&_0x3ddc4f!==void 0x0?_0x3ddc4f:_0x3af0ce[0x0]=new jszip_1[(_0x46ae90(0x1d6))](),_0x3af0ce[0x0]['generateAsync']({'type':_0x46ae90(0x235)});}async[a357_0x252cd7(0x21d)](_0x2f379a){const _0x1df379=a357_0x252cd7;this[_0x1df379(0x20f)]['log']('Save\x20Backup\x20to\x20Salesforce');const _0x15d88a={'Body':_0x2f379a,'ContentType':_0x1df379(0x254),'ParentId':this[_0x1df379(0x1c6)],'Name':flosum_constants_1[_0x1df379(0x239)]['BACKUP_ZIP_NAME']};await this['_connectionSalesforce'][_0x1df379(0x1c5)](flosum_constants_1['FlosumConstants'][_0x1df379(0x1ea)]+'/Attachment',_0x15d88a);}async[a357_0x252cd7(0x1de)](_0x29a4e4){const _0x5a82bf=a357_0x252cd7;this[_0x5a82bf(0x20f)][_0x5a82bf(0x22c)](_0x5a82bf(0x1e7));const _0x4eab67=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x5a82bf(0x244)],_0x29a4e4[_0x5a82bf(0x236)](_0xf882e4=>_0xf882e4[_0x5a82bf(0x1d3)])),_0x4924d2=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x4eab67,this[_0x5a82bf(0x244)]);if(_0x4924d2[_0x5a82bf(0x24a)]!==this[_0x5a82bf(0x20a)][_0x5a82bf(0x24a)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x4924d2[_0x5a82bf(0x236)](_0x20d6cf=>_0x20d6cf[_0x5a82bf(0x214)][_0x5a82bf(0x1db)]);}async[a357_0x252cd7(0x1f5)](_0x6e1eba){const _0x521b25=a357_0x252cd7;this[_0x521b25(0x20f)]['log'](_0x521b25(0x24f));const _0x5a989f=await new zip_creator_deploy_1[(_0x521b25(0x217))]({'attachmentBodies':_0x6e1eba,'deploymentName':this[_0x521b25(0x1e6)]})[_0x521b25(0x1fa)](),_0x4921ea=this[_0x521b25(0x24c)]+'/'+(0x0,shortid_1['default'])()+_0x521b25(0x25c);return await(0x0,promises_1['writeFile'])(_0x4921ea,_0x5a989f),_0x4921ea;}async[a357_0x252cd7(0x215)](_0x58c544){const _0x18df3a=a357_0x252cd7;this['_logger']['log'](_0x18df3a(0x1c9));const _0x299942=await this['_vpkService'][_0x18df3a(0x23e)](_0x58c544),_0x1038a0=this[_0x18df3a(0x24c)]+_0x18df3a(0x1df)+_0x58c544[_0x18df3a(0x259)](_0x58c544[_0x18df3a(0x1da)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x1038a0,_0x299942),await this[_0x18df3a(0x248)][_0x18df3a(0x24d)](_0x1038a0),_0x1038a0;}async[a357_0x252cd7(0x21c)](_0x3c2d6a,_0x3163e8){const _0x140a06=a357_0x252cd7;this[_0x140a06(0x20f)][_0x140a06(0x22c)](_0x140a06(0x1e0));const _0x525859={'Body':Buffer[_0x140a06(0x1c8)](_0x3c2d6a)['toString'](_0x140a06(0x235)),'ContentType':_0x140a06(0x23f),'ParentId':this[_0x140a06(0x1c6)],'Name':_0x3163e8};await this[_0x140a06(0x244)]['post'](flosum_constants_1[_0x140a06(0x239)][_0x140a06(0x1ea)]+'/Attachment',_0x525859);}[a357_0x252cd7(0x232)](_0xbf9a46,_0x56ec01){const _0x519eef=a357_0x252cd7;this['_logger'][_0x519eef(0x22c)](_0x519eef(0x230));const _0x46cfca=_0xbf9a46[_0x519eef(0x203)]((_0x2fead1,_0x2c2f15)=>_0x2fead1[_0x519eef(0x224)]((_0x2c2f15[_0x519eef(0x1cf)]+'.'+_0x2c2f15[_0x519eef(0x219)])[_0x519eef(0x233)](),_0x2c2f15),new Map());return _0x56ec01['map'](_0x1ceed5=>{const _0x533baa=_0x519eef;this[_0x533baa(0x20f)][_0x533baa(0x22c)](_0x1ceed5[_0x533baa(0x222)]+'.'+_0x1ceed5['name']+_0x533baa(0x202)+_0x1ceed5[_0x533baa(0x21f)]);const _0x5a517c=(_0x1ceed5[_0x533baa(0x222)]+'.'+_0x1ceed5[_0x533baa(0x234)])[_0x533baa(0x233)](),_0x170fe9=_0x46cfca['get'](_0x5a517c);return{[constants_1[_0x533baa(0x1cb)]+_0x533baa(0x1e9)]:'Deployment\x20Result',[constants_1[_0x533baa(0x1cb)]+_0x533baa(0x1f9)]:_0x1ceed5[_0x533baa(0x21f)]===status_enums_1[_0x533baa(0x1ce)][_0x533baa(0x213)]?_0x533baa(0x241):_0x533baa(0x1eb),[constants_1[_0x533baa(0x1cb)]+'Result__c']:_0x1ceed5[_0x533baa(0x1bf)],[constants_1[_0x533baa(0x1cb)]+_0x533baa(0x1d1)]:_0x1ceed5['name'],[constants_1[_0x533baa(0x1cb)]+'Component_Type__c']:_0x1ceed5[_0x533baa(0x222)],[constants_1[_0x533baa(0x1cb)]+_0x533baa(0x205)]:_0x1ceed5[_0x533baa(0x257)],[constants_1[_0x533baa(0x1cb)]+'Org__c']:this['_organisationId'],[constants_1[_0x533baa(0x1cb)]+_0x533baa(0x22d)]:this[_0x533baa(0x1c6)],[constants_1[_0x533baa(0x1cb)]+_0x533baa(0x1e5)]:_0x170fe9[_0x533baa(0x1d3)]};});}async['saveDeploymentResults'](_0x40a1f9){const _0x116d50=a357_0x252cd7;this[_0x116d50(0x20f)][_0x116d50(0x22c)](_0x116d50(0x242));const _0x129e49=await this[_0x116d50(0x23b)][_0x116d50(0x220)](constants_1[_0x116d50(0x1cb)]+_0x116d50(0x1bc),_0x40a1f9),_0x3bfbd8=_0x129e49['filter'](_0x51befd=>!_0x51befd[_0x116d50(0x20e)])[_0x116d50(0x236)](_0x499093=>_0x499093[_0x116d50(0x208)])[_0x116d50(0x1fb)]();if(_0x3bfbd8[_0x116d50(0x24a)])throw new salesforce_dml_error_1[(_0x116d50(0x23c))](_0x3bfbd8);}async[a357_0x252cd7(0x1ca)](_0x4f72f5){const _0x23aaa1=a357_0x252cd7;this[_0x23aaa1(0x20f)][_0x23aaa1(0x246)](_0x4f72f5),await this[_0x23aaa1(0x20f)]['updateLog'](),await this[_0x23aaa1(0x243)](![],!![],'');}async['finishDeploy'](_0x5d7831,_0x245e9a,_0x37920e){const _0x4fb735=a357_0x252cd7,_0x40e955=_0x4fb735(0x1f6)+this[_0x4fb735(0x256)]+'/'+this['_metadataLogId']+_0x4fb735(0x226)+_0x4fb735(0x1bd)+_0x4fb735(0x22b),_0x18dc29='<a\x20href='+this[_0x4fb735(0x256)]+'/'+this[_0x4fb735(0x1ed)]+'\x20>'+this[_0x4fb735(0x1d9)]+_0x4fb735(0x1ff),_0x34f09b=_0x40e955+_0x4fb735(0x225)+_0x18dc29+_0x4fb735(0x1dd),_0x554c06={[constants_1[_0x4fb735(0x1cb)]+_0x4fb735(0x1c2)]:_0x34f09b,[constants_1[_0x4fb735(0x1cb)]+_0x4fb735(0x1fe)]:new Date(),[constants_1[_0x4fb735(0x1cb)]+'Branch__c']:this[_0x4fb735(0x252)],[constants_1[_0x4fb735(0x1cb)]+'Activity_Item__c']:'Branch',[constants_1[_0x4fb735(0x1cb)]+_0x4fb735(0x1f3)]:'Deployment',[constants_1[_0x4fb735(0x1cb)]+_0x4fb735(0x250)]:this[_0x4fb735(0x1ed)]},_0x51e6e6={[constants_1[_0x4fb735(0x1cb)]+_0x4fb735(0x1f8)]:!_0x5d7831,[constants_1[_0x4fb735(0x1cb)]+_0x4fb735(0x1be)]:_0x5d7831,[constants_1['FLOSUM_NAMESPACE']+_0x4fb735(0x1f9)]:_0x245e9a?status_enums_1[_0x4fb735(0x1e4)]['EXCEPTION']:status_enums_1[_0x4fb735(0x1e4)][_0x4fb735(0x238)],[constants_1[_0x4fb735(0x1cb)]+'Job_Completed__c']:!![],[constants_1[_0x4fb735(0x1cb)]+_0x4fb735(0x1d5)]:_0x37920e};await this['_connectionSalesforce'][_0x4fb735(0x218)](flosum_constants_1[_0x4fb735(0x239)][_0x4fb735(0x1ea)]+'/'+constants_1[_0x4fb735(0x1cb)]+_0x4fb735(0x251)+this['_metadataLogId'],_0x51e6e6),await this[_0x4fb735(0x244)][_0x4fb735(0x1c5)](flosum_constants_1[_0x4fb735(0x239)][_0x4fb735(0x1ea)]+'/'+constants_1[_0x4fb735(0x1cb)]+'Log__c',_0x554c06),this[_0x4fb735(0x20f)][_0x4fb735(0x22c)](_0x4fb735(0x201)+(_0x5d7831?_0x4fb735(0x24b):_0x4fb735(0x221))+'.'),await this[_0x4fb735(0x20f)]['updateLog']();}}exports[a357_0x252cd7(0x231)]=DeployService;