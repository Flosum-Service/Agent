const a402_0x3f73b3=a402_0x343f;(function(_0x4af820,_0x13c9c2){const _0x4b1703=a402_0x343f,_0x21c020=_0x4af820();while(!![]){try{const _0x24267c=-parseInt(_0x4b1703(0x173))/0x1+-parseInt(_0x4b1703(0x1c4))/0x2+parseInt(_0x4b1703(0x1cc))/0x3*(-parseInt(_0x4b1703(0x1b3))/0x4)+parseInt(_0x4b1703(0x198))/0x5*(-parseInt(_0x4b1703(0x162))/0x6)+-parseInt(_0x4b1703(0x1bb))/0x7+parseInt(_0x4b1703(0x1ae))/0x8*(parseInt(_0x4b1703(0x188))/0x9)+parseInt(_0x4b1703(0x170))/0xa;if(_0x24267c===_0x13c9c2)break;else _0x21c020['push'](_0x21c020['shift']());}catch(_0x85e69d){_0x21c020['push'](_0x21c020['shift']());}}}(a402_0x517a,0xb055c));const a402_0xc14b81=(function(){let _0x483abb=!![];return function(_0x34cbe4,_0x4d0126){const _0x3adc89=_0x483abb?function(){if(_0x4d0126){const _0x27bbaf=_0x4d0126['apply'](_0x34cbe4,arguments);return _0x4d0126=null,_0x27bbaf;}}:function(){};return _0x483abb=![],_0x3adc89;};}()),a402_0x244f68=a402_0xc14b81(this,function(){const _0x59a256=a402_0x343f;return a402_0x244f68['toString']()['search']('(((.+)+)+)+$')[_0x59a256(0x1c5)]()['constructor'](a402_0x244f68)[_0x59a256(0x196)]('(((.+)+)+)+$');});a402_0x244f68();'use strict';function a402_0x517a(){const _0x3acf03=['DeployService','_instanceUrl','componentHistoryId','log','reduce','_attachmentLogId','External_Deployment_Id__c','Metadata_Log__c','__esModule','name','Type__c','Create\x20vpk\x20package','108QQSiBE','packageComponentList','componentName','Date__c','_branchId','PackageImportService','timeZone','_systemLogger','execute','createVpk','has','ENDPOINT_UPSERT_RECORD','Activity_Type__c','Job_Completed__c','search','retrieve','85bfyQHT','_organisationName','Metadata_Log__c/','fetchAttachmentsDetailsByParentId','FlosumConstants','PackageComponentStatus','componentType','Branch__c','defineProperty','_packageImportService','DEPLOYED','../../shared/utils/fetch-attachments','type','veeva-deploy','createBackup','filter','createZip','generateAsync','_veevaService','./veeva.service','Success','branchId','46776aOMRCD','values','PackageExportService','/Attachment','from','241212KsDuNN','updateLog','logError','COMPLETED','Result__c','saveDeploymentResults','Component_Name__c','TargetId__c','7343070rdsdfe','SalesforceService','\x20</a>','saveBackup','Succeed__c','formFlosumDeploymentResults','post','organisationName','Join\x20all\x20mdl\x20into\x20one\x20zip','2232198oXzKUp','toString','Logger','Deploy\x20completed\x20','_connectionSalesforce','text/plain','deploymentAction','Retrieving\x20components','69BBBAHb','_timeZone','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','_organisationId','BranchComponentHistoryFlosumComponentRetriever','Create\x20Backup','getFlosumComponents','MetadataLogStatus','FLOSUM_NAMESPACE','application/zip','Form\x20Deployment\x20Results','Is_Error__c','ZipCreatorDeploy','import','set','Deployment_Result__c','finishDeployWithError','export','VpkService','_vpkService','finishDeploy','../classes/deploy/zip-creator.deploy','../classes/errors/salesforce-dml-error','Status__c','jszip','_connectionVeeva','__importDefault','Save\x20Deployment\x20Results','writeFile','_metadataLogId','.zip','Deployment','./package-import.service','../../../constants','_deploymentName','./vpk.service','length','map','saveLog','Action__c','generate','componentIdList','patch','408786WAoPOV','\x20of\x20branch\x20to\x20Organization\x20','lastIndexOf','/vpk__','Cannot\x20retrieve\x20all\x20components.','bind','retrieveAttachments','slice','Cannot\x20Backup\x20more\x20than\x20200\x20components.','toLowerCase','SalesforceDmlError','</a>','../../../core','./package-export.service','60369860EFNeok','_packageExportService','<a\x20href=','674577WBIQaK','base64','_logger','../enums/status.enums','_salesforceService','FlosumComponentVeevaComponentRetriever','_tempFolder','Veeva_Step_Name__c','_componentIdList'];a402_0x517a=function(){return _0x3acf03;};return a402_0x517a();}var __importDefault=this&&this[a402_0x3f73b3(0x151)]||function(_0x5ab7c3){const _0x157db0=a402_0x3f73b3;return _0x5ab7c3&&_0x5ab7c3[_0x157db0(0x184)]?_0x5ab7c3:{'default':_0x5ab7c3};};Object[a402_0x3f73b3(0x1a0)](exports,a402_0x3f73b3(0x184),{'value':!![]}),exports[a402_0x3f73b3(0x17c)]=void 0x0;const jszip_1=__importDefault(require(a402_0x3f73b3(0x14f))),promises_1=require('fs/promises'),constants_1=require(a402_0x3f73b3(0x158)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a402_0x3f73b3(0x1ab)),salesforce_service_1=require('./salesforce.service'),core_1=require(a402_0x3f73b3(0x16e)),status_enums_1=require(a402_0x3f73b3(0x176)),salesforce_dml_error_1=require(a402_0x3f73b3(0x14d)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require(a402_0x3f73b3(0x1a3)),package_import_service_1=require(a402_0x3f73b3(0x157)),branch_component_history_flosum_component_retriever_1=require(a402_0x3f73b3(0x1ce)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a402_0x3f73b3(0x16f)),vpk_service_1=require(a402_0x3f73b3(0x15a)),zip_creator_deploy_1=require(a402_0x3f73b3(0x14c));class DeployService{constructor(_0x2d3ec3,_0x56fac8,_0x19dd63,_0x28cd50,_0x30c1de,_0xf13f41){const _0x2454cb=a402_0x3f73b3;this['_connectionSalesforce']=_0x56fac8,this[_0x2454cb(0x150)]=_0x19dd63,this[_0x2454cb(0x175)]=_0x28cd50,this[_0x2454cb(0x179)]=_0x30c1de,this[_0x2454cb(0x17d)]=_0xf13f41,this[_0x2454cb(0x18c)]=_0x2d3ec3[_0x2454cb(0x1ad)],this[_0x2454cb(0x154)]=_0x2d3ec3['metadataLogId'],this[_0x2454cb(0x181)]=_0x2d3ec3['attachmentLogId'],this['_organisationId']=_0x2d3ec3['organisationId'],this[_0x2454cb(0x1cd)]=_0x2d3ec3[_0x2454cb(0x18e)],this[_0x2454cb(0x199)]=_0x2d3ec3[_0x2454cb(0x1c2)],this[_0x2454cb(0x17b)]=_0x2d3ec3[_0x2454cb(0x160)],this[_0x2454cb(0x159)]=_0x2d3ec3['deploymentName'],this[_0x2454cb(0x18f)]=new core_1[(_0x2454cb(0x1c6))](_0x2454cb(0x1a5)),this[_0x2454cb(0x1aa)]=new veeva_service_1['VeevaService']({'connection':this[_0x2454cb(0x150)],'logger':this[_0x2454cb(0x175)]}),this['_salesforceService']=new salesforce_service_1[(_0x2454cb(0x1bc))]({'connection':this[_0x2454cb(0x1c8)]}),this['_packageImportService']=new package_import_service_1[(_0x2454cb(0x18d))]({'veevaService':this[_0x2454cb(0x1aa)],'connection':this[_0x2454cb(0x150)],'logger':this[_0x2454cb(0x175)],'saveLog':this['saveLog'][_0x2454cb(0x167)](this)}),this[_0x2454cb(0x171)]=new package_export_service_1[(_0x2454cb(0x1b0))]({'veevaService':this[_0x2454cb(0x1aa)],'connection':this['_connectionVeeva'],'logger':this[_0x2454cb(0x175)]}),this[_0x2454cb(0x14a)]=new vpk_service_1[(_0x2454cb(0x149))]({'connection':this[_0x2454cb(0x150)]});}async[a402_0x3f73b3(0x190)](){const _0x5d39a2=a402_0x3f73b3;try{const _0x2181a9=await this[_0x5d39a2(0x1d2)]();await this['_logger'][_0x5d39a2(0x1b4)]();const _0x4dc8ba=await this[_0x5d39a2(0x1a6)](_0x2181a9);await this['saveBackup'](_0x4dc8ba);const _0x2edecb=await this['retrieveAttachments'](_0x2181a9),_0x93a888=await this['createZip'](_0x2edecb),_0x17471a=await this[_0x5d39a2(0x191)](_0x93a888);await this[_0x5d39a2(0x175)][_0x5d39a2(0x1b4)]();const _0xdb21da=await this[_0x5d39a2(0x1a1)][_0x5d39a2(0x1d9)](_0x17471a);await this['_logger'][_0x5d39a2(0x1b4)]();const _0x44e2a6=this[_0x5d39a2(0x1c0)](_0x2181a9,_0xdb21da[_0x5d39a2(0x189)]);await this[_0x5d39a2(0x1b8)](_0x44e2a6),await this[_0x5d39a2(0x14b)](_0xdb21da['isDeployed'],![],_0xdb21da['packageId']);}catch(_0x2f8a87){await this[_0x5d39a2(0x147)](_0x2f8a87)['catch'](_0x126bed=>this[_0x5d39a2(0x18f)]['error'](_0x126bed));}}async[a402_0x3f73b3(0x1d2)](){const _0x2230db=a402_0x3f73b3,_0x51ccb4=new Set(this[_0x2230db(0x17b)]);this['_logger'][_0x2230db(0x17f)](_0x2230db(0x1cb));const _0x18158d=await new branch_component_history_flosum_component_retriever_1[(_0x2230db(0x1d0))]({'value':this[_0x2230db(0x18c)],'salesforceService':this[_0x2230db(0x177)]})['retrieve'](),_0x4c5600=_0x18158d['filter'](_0x88953d=>_0x51ccb4[_0x2230db(0x192)](_0x88953d['id']));if(_0x4c5600[_0x2230db(0x15b)]!==this[_0x2230db(0x17b)]['length'])throw new Error(_0x2230db(0x166));return _0x4c5600;}async[a402_0x3f73b3(0x1a6)](_0x3759da){const _0xfe45fa=a402_0x3f73b3;var _0x5381fb;this[_0xfe45fa(0x175)][_0xfe45fa(0x17f)](_0xfe45fa(0x1d1));const _0x3287ff=await new flosum_component_veeva_component_retriever_1[(_0xfe45fa(0x178))]({'value':_0x3759da,'veevaService':this[_0xfe45fa(0x1aa)],'logger':this[_0xfe45fa(0x175)]})[_0xfe45fa(0x197)](),_0x18cd37=await this['_packageExportService'][_0xfe45fa(0x148)](_0x3287ff,'Backup');if(_0x18cd37[_0xfe45fa(0x15b)]>0x1)throw new Error(_0xfe45fa(0x16a));return(_0x5381fb=_0x18cd37[0x0])!==null&&_0x5381fb!==void 0x0?_0x5381fb:_0x18cd37[0x0]=new jszip_1['default'](),_0x18cd37[0x0][_0xfe45fa(0x1a9)]({'type':_0xfe45fa(0x174)});}async[a402_0x3f73b3(0x1be)](_0x29e364){const _0x29f283=a402_0x3f73b3;this[_0x29f283(0x175)]['log']('Save\x20Backup\x20to\x20Salesforce');const _0x2bc316={'Body':_0x29e364,'ContentType':_0x29f283(0x1d5),'ParentId':this['_metadataLogId'],'Name':flosum_constants_1['FlosumConstants']['BACKUP_ZIP_NAME']};await this[_0x29f283(0x1c8)][_0x29f283(0x1c1)](flosum_constants_1['FlosumConstants'][_0x29f283(0x193)]+_0x29f283(0x1b1),_0x2bc316);}async[a402_0x3f73b3(0x168)](_0x242933){const _0x1eeaf1=a402_0x3f73b3;this[_0x1eeaf1(0x175)][_0x1eeaf1(0x17f)]('Retrieving\x20attachments');const _0x406008=await(0x0,fetch_attachments_1[_0x1eeaf1(0x19b)])(this[_0x1eeaf1(0x1c8)],_0x242933[_0x1eeaf1(0x15c)](_0x3b5ffd=>_0x3b5ffd[_0x1eeaf1(0x17e)])),_0x2380ce=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x406008,this[_0x1eeaf1(0x1c8)]);if(_0x2380ce[_0x1eeaf1(0x15b)]!==this[_0x1eeaf1(0x17b)]['length'])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x2380ce['map'](_0x229a70=>_0x229a70[_0x1eeaf1(0x1af)]['Body']);}async[a402_0x3f73b3(0x1a8)](_0x17132b){const _0x9e3e36=a402_0x3f73b3;this[_0x9e3e36(0x175)]['log'](_0x9e3e36(0x1c3));const _0x460ecf=await new zip_creator_deploy_1[(_0x9e3e36(0x1d8))]({'attachmentBodies':_0x17132b,'deploymentName':this[_0x9e3e36(0x159)]})[_0x9e3e36(0x190)](),_0x22f31c=this[_0x9e3e36(0x179)]+'/'+(0x0,shortid_1['default'])()+_0x9e3e36(0x155);return await(0x0,promises_1[_0x9e3e36(0x153)])(_0x22f31c,_0x460ecf),_0x22f31c;}async[a402_0x3f73b3(0x191)](_0x1518dc){const _0x4abd0e=a402_0x3f73b3;this['_logger']['log'](_0x4abd0e(0x187));const _0x2d0a14=await this[_0x4abd0e(0x14a)][_0x4abd0e(0x15f)](_0x1518dc),_0x3badae=this[_0x4abd0e(0x179)]+_0x4abd0e(0x165)+_0x1518dc[_0x4abd0e(0x169)](_0x1518dc[_0x4abd0e(0x164)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x3badae,_0x2d0a14),await this[_0x4abd0e(0x14a)]['validate'](_0x3badae),_0x3badae;}async[a402_0x3f73b3(0x15d)](_0x37d306,_0x5bca27){const _0x2c5c6d=a402_0x3f73b3;this[_0x2c5c6d(0x175)][_0x2c5c6d(0x17f)]('Save\x20log');const _0x21bde9={'Body':Buffer[_0x2c5c6d(0x1b2)](_0x37d306)[_0x2c5c6d(0x1c5)](_0x2c5c6d(0x174)),'ContentType':_0x2c5c6d(0x1c9),'ParentId':this['_metadataLogId'],'Name':_0x5bca27};await this[_0x2c5c6d(0x1c8)][_0x2c5c6d(0x1c1)](flosum_constants_1[_0x2c5c6d(0x19c)][_0x2c5c6d(0x193)]+'/Attachment',_0x21bde9);}['formFlosumDeploymentResults'](_0x28dfaf,_0x3573f4){const _0x3325f8=a402_0x3f73b3;this[_0x3325f8(0x175)][_0x3325f8(0x17f)](_0x3325f8(0x1d6));const _0x32fca5=_0x28dfaf[_0x3325f8(0x180)]((_0x51ebb7,_0x1c61b1)=>_0x51ebb7[_0x3325f8(0x145)]((_0x1c61b1[_0x3325f8(0x19e)]+'.'+_0x1c61b1[_0x3325f8(0x18a)])[_0x3325f8(0x16b)](),_0x1c61b1),new Map());return _0x3573f4[_0x3325f8(0x15c)](_0x32c3ef=>{const _0x34f98e=_0x3325f8;this[_0x34f98e(0x175)][_0x34f98e(0x17f)](_0x32c3ef[_0x34f98e(0x1a4)]+'.'+_0x32c3ef['name']+'\x20:\x20'+_0x32c3ef['status']);const _0x339830=(_0x32c3ef[_0x34f98e(0x1a4)]+'.'+_0x32c3ef['name'])[_0x34f98e(0x16b)](),_0x3fb9cd=_0x32fca5['get'](_0x339830);return{[constants_1['FLOSUM_NAMESPACE']+_0x34f98e(0x186)]:'Deployment\x20Result',[constants_1[_0x34f98e(0x1d4)]+_0x34f98e(0x14e)]:_0x32c3ef['status']===status_enums_1[_0x34f98e(0x19d)][_0x34f98e(0x1a2)]?_0x34f98e(0x1ac):'Failure',[constants_1[_0x34f98e(0x1d4)]+_0x34f98e(0x1b7)]:_0x32c3ef[_0x34f98e(0x1ca)],[constants_1[_0x34f98e(0x1d4)]+_0x34f98e(0x1b9)]:_0x32c3ef[_0x34f98e(0x185)],[constants_1[_0x34f98e(0x1d4)]+'Component_Type__c']:_0x32c3ef['type'],[constants_1[_0x34f98e(0x1d4)]+_0x34f98e(0x17a)]:_0x32c3ef['stepName'],[constants_1[_0x34f98e(0x1d4)]+'Org__c']:this[_0x34f98e(0x1cf)],[constants_1['FLOSUM_NAMESPACE']+_0x34f98e(0x183)]:this[_0x34f98e(0x154)],[constants_1[_0x34f98e(0x1d4)]+'Component_History__c']:_0x3fb9cd['componentHistoryId']};});}async['saveDeploymentResults'](_0x46be2e){const _0x51f1ac=a402_0x3f73b3;this[_0x51f1ac(0x175)][_0x51f1ac(0x17f)](_0x51f1ac(0x152));const _0x379a60=await this[_0x51f1ac(0x177)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+_0x51f1ac(0x146),_0x46be2e),_0x378cbf=_0x379a60[_0x51f1ac(0x1a7)](_0x4ff7c0=>!_0x4ff7c0['success'])[_0x51f1ac(0x15c)](_0x5c4345=>_0x5c4345['errors'])['flat']();if(_0x378cbf[_0x51f1ac(0x15b)])throw new salesforce_dml_error_1[(_0x51f1ac(0x16c))](_0x378cbf);}async[a402_0x3f73b3(0x147)](_0x52ea3a){const _0x21421c=a402_0x3f73b3;this[_0x21421c(0x175)][_0x21421c(0x1b5)](_0x52ea3a),await this[_0x21421c(0x175)]['updateLog'](),await this[_0x21421c(0x14b)](![],!![],'');}async[a402_0x3f73b3(0x14b)](_0x3a3d24,_0x595b43,_0x3918e5){const _0x57fadb=a402_0x3f73b3,_0x1ae3e2=_0x57fadb(0x172)+this[_0x57fadb(0x17d)]+'/'+this['_metadataLogId']+'\x20>\x20'+'Veeva\x20Deployment'+_0x57fadb(0x1bd),_0x5daf9b=_0x57fadb(0x172)+this[_0x57fadb(0x17d)]+'/'+this[_0x57fadb(0x1cf)]+'\x20>'+this[_0x57fadb(0x199)]+_0x57fadb(0x16d),_0x4b44a0=_0x1ae3e2+_0x57fadb(0x163)+_0x5daf9b+'\x20has\x20been\x20created.',_0x39aab9={[constants_1['FLOSUM_NAMESPACE']+_0x57fadb(0x15e)]:_0x4b44a0,[constants_1[_0x57fadb(0x1d4)]+_0x57fadb(0x18b)]:new Date(),[constants_1[_0x57fadb(0x1d4)]+_0x57fadb(0x19f)]:this[_0x57fadb(0x18c)],[constants_1[_0x57fadb(0x1d4)]+'Activity_Item__c']:'Branch',[constants_1[_0x57fadb(0x1d4)]+_0x57fadb(0x194)]:_0x57fadb(0x156),[constants_1[_0x57fadb(0x1d4)]+_0x57fadb(0x1ba)]:this[_0x57fadb(0x1cf)]},_0x655571={[constants_1['FLOSUM_NAMESPACE']+_0x57fadb(0x1d7)]:!_0x3a3d24,[constants_1['FLOSUM_NAMESPACE']+_0x57fadb(0x1bf)]:_0x3a3d24,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x595b43?status_enums_1[_0x57fadb(0x1d3)]['EXCEPTION']:status_enums_1[_0x57fadb(0x1d3)][_0x57fadb(0x1b6)],[constants_1[_0x57fadb(0x1d4)]+_0x57fadb(0x195)]:!![],[constants_1[_0x57fadb(0x1d4)]+_0x57fadb(0x182)]:_0x3918e5};await this[_0x57fadb(0x1c8)][_0x57fadb(0x161)](flosum_constants_1[_0x57fadb(0x19c)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x57fadb(0x19a)+this[_0x57fadb(0x154)],_0x655571),await this['_connectionSalesforce']['post'](flosum_constants_1[_0x57fadb(0x19c)][_0x57fadb(0x193)]+'/'+constants_1[_0x57fadb(0x1d4)]+'Log__c',_0x39aab9),this[_0x57fadb(0x175)]['log'](_0x57fadb(0x1c7)+(_0x3a3d24?'successfully':'with\x20error')+'.'),await this[_0x57fadb(0x175)][_0x57fadb(0x1b4)]();}}function a402_0x343f(_0x4b7927,_0x3da110){const _0x4e754a=a402_0x517a();return a402_0x343f=function(_0x244f68,_0xc14b81){_0x244f68=_0x244f68-0x145;let _0x517ac0=_0x4e754a[_0x244f68];return _0x517ac0;},a402_0x343f(_0x4b7927,_0x3da110);}exports['DeployService']=DeployService;