const a401_0x3d308c=a401_0x9b4d;(function(_0x3e9183,_0x3d74b9){const _0x182769=a401_0x9b4d,_0x47befe=_0x3e9183();while(!![]){try{const _0x3a85c5=parseInt(_0x182769(0x106))/0x1*(parseInt(_0x182769(0xd9))/0x2)+-parseInt(_0x182769(0x10b))/0x3+-parseInt(_0x182769(0x10f))/0x4*(-parseInt(_0x182769(0xcd))/0x5)+-parseInt(_0x182769(0xd1))/0x6*(-parseInt(_0x182769(0xdf))/0x7)+parseInt(_0x182769(0xcb))/0x8+parseInt(_0x182769(0xf8))/0x9+-parseInt(_0x182769(0x116))/0xa;if(_0x3a85c5===_0x3d74b9)break;else _0x47befe['push'](_0x47befe['shift']());}catch(_0x433b46){_0x47befe['push'](_0x47befe['shift']());}}}(a401_0xa989,0x7ea59));function a401_0x9b4d(_0x22a841,_0x3dc739){const _0x48d5a7=a401_0xa989();return a401_0x9b4d=function(_0x53af2a,_0x2abd19){_0x53af2a=_0x53af2a-0xbd;let _0xa9895c=_0x48d5a7[_0x53af2a];return _0xa9895c;},a401_0x9b4d(_0x22a841,_0x3dc739);}const a401_0x2abd19=(function(){let _0x5255e7=!![];return function(_0x2a405,_0x48d01f){const _0x45d440=_0x5255e7?function(){if(_0x48d01f){const _0x2c2f30=_0x48d01f['apply'](_0x2a405,arguments);return _0x48d01f=null,_0x2c2f30;}}:function(){};return _0x5255e7=![],_0x45d440;};}()),a401_0x53af2a=a401_0x2abd19(this,function(){const _0x5a24d2=a401_0x9b4d;return a401_0x53af2a[_0x5a24d2(0x15d)]()['search'](_0x5a24d2(0x12d))[_0x5a24d2(0x15d)]()['constructor'](a401_0x53af2a)[_0x5a24d2(0x137)]('(((.+)+)+)+$');});a401_0x53af2a();'use strict';var __importDefault=this&&this[a401_0x3d308c(0x14e)]||function(_0x5fba89){const _0x337ec2=a401_0x3d308c;return _0x5fba89&&_0x5fba89[_0x337ec2(0x13f)]?_0x5fba89:{'default':_0x5fba89};};Object[a401_0x3d308c(0x104)](exports,'__esModule',{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a401_0x3d308c(0x153))),promises_1=require(a401_0x3d308c(0xd2)),constants_1=require(a401_0x3d308c(0xf2)),flosum_constants_1=require(a401_0x3d308c(0xda)),veeva_service_1=require(a401_0x3d308c(0xfd)),salesforce_service_1=require('./salesforce.service'),core_1=require('../../../core'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a401_0x3d308c(0x127))),fetch_attachments_1=require(a401_0x3d308c(0x12c)),package_import_service_1=require(a401_0x3d308c(0x121)),branch_component_history_flosum_component_retriever_1=require(a401_0x3d308c(0xd4)),flosum_component_veeva_component_retriever_1=require(a401_0x3d308c(0xbe)),package_export_service_1=require(a401_0x3d308c(0x13e)),vpk_service_1=require(a401_0x3d308c(0x14c)),zip_creator_deploy_1=require(a401_0x3d308c(0x12e));function a401_0xa989(){const _0x48621c=['_organisationName','catch','updateLog','componentHistoryId','Job_Completed__c','get','./vpk.service','createBackup','__importDefault','from','ZipCreatorDeploy','PackageExportService','/Attachment','jszip','componentType','COMPLETED','\x20of\x20branch\x20to\x20Organization\x20','Activity_Item__c','deploymentName','DEPLOYED','successfully','PackageImportService','slice','toString','veeva-deploy','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','writeFile','\x20has\x20been\x20created.','Backup','_instanceUrl','_timeZone','_vpkService','Save\x20Backup\x20to\x20Salesforce','isDeployed','ENDPOINT_UPSERT_RECORD','length','set','error','4767232xmRuyX','Deployment\x20Result','165WDWPPl','Succeed__c','Deployment','componentIdList','4528614DdXXpx','fs/promises','filter','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','_tempFolder','import','</a>','map','222XwmPrc','../constants/flosum.constants','FlosumConstants','reduce','finishDeploy','status','7IagIKx','Org__c','External_Deployment_Id__c','has','_veevaService','SalesforceDmlError','Component_History__c','saveDeploymentResults','saveLog','_systemLogger','BranchComponentHistoryFlosumComponentRetriever','post','Failure','_logger','_branchId','retrieveAttachments','\x20:\x20','_salesforceService','retrieve','../../../constants','Join\x20all\x20mdl\x20into\x20one\x20zip','Deployment_Result__c','Activity_Type__c','log','Status__c','7884360NzmHrF','timeZone','bind','Cannot\x20retrieve\x20all\x20components.','saveBackup','./veeva.service','componentName','patch','name','_metadataLogId','BACKUP_ZIP_NAME','stepName','defineProperty','Body','2950muWcBu','PackageComponentStatus','finishDeployWithError','Metadata_Log__c','packageComponentList','2783160qImbIK','Result__c','default','Cannot\x20Backup\x20more\x20than\x20200\x20components.','82408EPgqHL','Logger','type','_organisationId','createZip','Form\x20Deployment\x20Results','createVpk','17875640QPQnrj','Create\x20Backup','.zip','_connectionSalesforce','Success','Veeva\x20Deployment','_packageImportService','FLOSUM_NAMESPACE','DeployService','lastIndexOf','getFlosumComponents','./package-import.service','success','Component_Name__c','generate','<a\x20href=','\x20</a>','shortid','_packageExportService','Save\x20Deployment\x20Results','export','Branch','../../shared/utils/fetch-attachments','(((.+)+)+)+$','../classes/deploy/zip-creator.deploy','errors','organisationId','_componentIdList','generateAsync','branchId','/vpk__','_deploymentName','_connectionVeeva','search','Date__c','MetadataLogStatus','_attachmentLogId','deploymentAction','Metadata_Log__c/','packageId','./package-export.service','__esModule','text/plain','execute','Deploy\x20completed\x20','insertMultipleRecords','flat','Cannot\x20retrievers\x20all\x20attachments'];a401_0xa989=function(){return _0x48621c;};return a401_0xa989();}class DeployService{constructor(_0x4eb231,_0x2b1604,_0x501976,_0x4faa6b,_0x4238e9,_0x48cefd){const _0x1baf7b=a401_0x3d308c;this[_0x1baf7b(0x119)]=_0x2b1604,this[_0x1baf7b(0x136)]=_0x501976,this[_0x1baf7b(0xec)]=_0x4faa6b,this[_0x1baf7b(0xd5)]=_0x4238e9,this[_0x1baf7b(0xc2)]=_0x48cefd,this[_0x1baf7b(0xed)]=_0x4eb231[_0x1baf7b(0x133)],this[_0x1baf7b(0x101)]=_0x4eb231['metadataLogId'],this[_0x1baf7b(0x13a)]=_0x4eb231['attachmentLogId'],this['_organisationId']=_0x4eb231[_0x1baf7b(0x130)],this[_0x1baf7b(0xc3)]=_0x4eb231[_0x1baf7b(0xf9)],this['_organisationName']=_0x4eb231['organisationName'],this[_0x1baf7b(0x131)]=_0x4eb231[_0x1baf7b(0xd0)],this[_0x1baf7b(0x135)]=_0x4eb231[_0x1baf7b(0x158)],this[_0x1baf7b(0xe8)]=new core_1[(_0x1baf7b(0x110))](_0x1baf7b(0xbd)),this['_veevaService']=new veeva_service_1['VeevaService']({'connection':this[_0x1baf7b(0x136)],'logger':this['_logger']}),this[_0x1baf7b(0xf0)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x1baf7b(0x119)]}),this[_0x1baf7b(0x11c)]=new package_import_service_1[(_0x1baf7b(0x15b))]({'veevaService':this['_veevaService'],'connection':this['_connectionVeeva'],'logger':this[_0x1baf7b(0xec)],'saveLog':this[_0x1baf7b(0xe7)][_0x1baf7b(0xfa)](this)}),this['_packageExportService']=new package_export_service_1[(_0x1baf7b(0x151))]({'veevaService':this['_veevaService'],'connection':this['_connectionVeeva'],'logger':this[_0x1baf7b(0xec)]}),this[_0x1baf7b(0xc4)]=new vpk_service_1['VpkService']({'connection':this[_0x1baf7b(0x136)]});}async[a401_0x3d308c(0x141)](){const _0x1b9b73=a401_0x3d308c;try{const _0x22cb13=await this[_0x1b9b73(0x120)]();await this['_logger'][_0x1b9b73(0x148)]();const _0x4b5a1a=await this[_0x1b9b73(0x14d)](_0x22cb13);await this[_0x1b9b73(0xfc)](_0x4b5a1a);const _0x826950=await this['retrieveAttachments'](_0x22cb13),_0x16cdea=await this[_0x1b9b73(0x113)](_0x826950),_0x4645bd=await this[_0x1b9b73(0x115)](_0x16cdea);await this[_0x1b9b73(0xec)]['updateLog']();const _0x9eb95a=await this['_packageImportService'][_0x1b9b73(0xd6)](_0x4645bd);await this[_0x1b9b73(0xec)][_0x1b9b73(0x148)]();const _0x3a0545=this['formFlosumDeploymentResults'](_0x22cb13,_0x9eb95a[_0x1b9b73(0x10a)]);await this[_0x1b9b73(0xe6)](_0x3a0545),await this[_0x1b9b73(0xdd)](_0x9eb95a[_0x1b9b73(0xc6)],![],_0x9eb95a[_0x1b9b73(0x13d)]);}catch(_0x501707){await this[_0x1b9b73(0x108)](_0x501707)[_0x1b9b73(0x147)](_0x1eec46=>this[_0x1b9b73(0xe8)][_0x1b9b73(0xca)](_0x1eec46));}}async[a401_0x3d308c(0x120)](){const _0x1e4270=a401_0x3d308c,_0xb9c6b6=new Set(this['_componentIdList']);this['_logger'][_0x1e4270(0xf6)]('Retrieving\x20components');const _0x177661=await new branch_component_history_flosum_component_retriever_1[(_0x1e4270(0xe9))]({'value':this[_0x1e4270(0xed)],'salesforceService':this['_salesforceService']})[_0x1e4270(0xf1)](),_0x4e29af=_0x177661[_0x1e4270(0xd3)](_0xae7169=>_0xb9c6b6[_0x1e4270(0xe2)](_0xae7169['id']));if(_0x4e29af['length']!==this[_0x1e4270(0x131)][_0x1e4270(0xc8)])throw new Error(_0x1e4270(0xfb));return _0x4e29af;}async['createBackup'](_0x4c0843){const _0x446d25=a401_0x3d308c;var _0x1f008d;this[_0x446d25(0xec)][_0x446d25(0xf6)](_0x446d25(0x117));const _0x11e198=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x4c0843,'veevaService':this[_0x446d25(0xe3)],'logger':this[_0x446d25(0xec)]})['retrieve'](),_0x4128a1=await this[_0x446d25(0x128)][_0x446d25(0x12a)](_0x11e198,_0x446d25(0xc1));if(_0x4128a1[_0x446d25(0xc8)]>0x1)throw new Error(_0x446d25(0x10e));return(_0x1f008d=_0x4128a1[0x0])!==null&&_0x1f008d!==void 0x0?_0x1f008d:_0x4128a1[0x0]=new jszip_1[(_0x446d25(0x10d))](),_0x4128a1[0x0][_0x446d25(0x132)]({'type':'base64'});}async[a401_0x3d308c(0xfc)](_0x523d9f){const _0x1d2866=a401_0x3d308c;this['_logger']['log'](_0x1d2866(0xc5));const _0x524fcf={'Body':_0x523d9f,'ContentType':'application/zip','ParentId':this[_0x1d2866(0x101)],'Name':flosum_constants_1[_0x1d2866(0xdb)][_0x1d2866(0x102)]};await this[_0x1d2866(0x119)][_0x1d2866(0xea)](flosum_constants_1['FlosumConstants'][_0x1d2866(0xc7)]+'/Attachment',_0x524fcf);}async[a401_0x3d308c(0xee)](_0x5337e1){const _0x3e53c9=a401_0x3d308c;this[_0x3e53c9(0xec)][_0x3e53c9(0xf6)]('Retrieving\x20attachments');const _0x1bae4e=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x3e53c9(0x119)],_0x5337e1[_0x3e53c9(0xd8)](_0x3b4ebb=>_0x3b4ebb['componentHistoryId'])),_0x3973c6=await(0x0,fetch_attachments_1[_0x3e53c9(0xee)])(_0x1bae4e,this[_0x3e53c9(0x119)]);if(_0x3973c6[_0x3e53c9(0xc8)]!==this[_0x3e53c9(0x131)][_0x3e53c9(0xc8)])throw new Error(_0x3e53c9(0x145));return _0x3973c6[_0x3e53c9(0xd8)](_0x52e4b9=>_0x52e4b9['values'][_0x3e53c9(0x105)]);}async[a401_0x3d308c(0x113)](_0x627aaa){const _0x4ce8ba=a401_0x3d308c;this[_0x4ce8ba(0xec)][_0x4ce8ba(0xf6)](_0x4ce8ba(0xf3));const _0x4b9546=await new zip_creator_deploy_1[(_0x4ce8ba(0x150))]({'attachmentBodies':_0x627aaa,'deploymentName':this[_0x4ce8ba(0x135)]})[_0x4ce8ba(0x141)](),_0x48a5c2=this[_0x4ce8ba(0xd5)]+'/'+(0x0,shortid_1['default'])()+_0x4ce8ba(0x118);return await(0x0,promises_1[_0x4ce8ba(0xbf)])(_0x48a5c2,_0x4b9546),_0x48a5c2;}async[a401_0x3d308c(0x115)](_0x196258){const _0x5d95f7=a401_0x3d308c;this['_logger'][_0x5d95f7(0xf6)]('Create\x20vpk\x20package');const _0x3107c0=await this[_0x5d95f7(0xc4)][_0x5d95f7(0x124)](_0x196258),_0xd2160c=this['_tempFolder']+_0x5d95f7(0x134)+_0x196258[_0x5d95f7(0x15c)](_0x196258[_0x5d95f7(0x11f)]('/')+0x1);return await(0x0,promises_1[_0x5d95f7(0xbf)])(_0xd2160c,_0x3107c0),await this[_0x5d95f7(0xc4)]['validate'](_0xd2160c),_0xd2160c;}async[a401_0x3d308c(0xe7)](_0x3f5d9e,_0x2fd0d4){const _0x127424=a401_0x3d308c;this['_logger'][_0x127424(0xf6)]('Save\x20log');const _0x3d21ab={'Body':Buffer[_0x127424(0x14f)](_0x3f5d9e)[_0x127424(0x15d)]('base64'),'ContentType':_0x127424(0x140),'ParentId':this[_0x127424(0x101)],'Name':_0x2fd0d4};await this[_0x127424(0x119)][_0x127424(0xea)](flosum_constants_1[_0x127424(0xdb)]['ENDPOINT_UPSERT_RECORD']+_0x127424(0x152),_0x3d21ab);}['formFlosumDeploymentResults'](_0x2f9049,_0x4740f1){const _0x2aa0b7=a401_0x3d308c;this[_0x2aa0b7(0xec)][_0x2aa0b7(0xf6)](_0x2aa0b7(0x114));const _0x5a9100=_0x2f9049[_0x2aa0b7(0xdc)]((_0x3f0ce2,_0x22a111)=>_0x3f0ce2[_0x2aa0b7(0xc9)]((_0x22a111[_0x2aa0b7(0x154)]+'.'+_0x22a111[_0x2aa0b7(0xfe)])['toLowerCase'](),_0x22a111),new Map());return _0x4740f1[_0x2aa0b7(0xd8)](_0x33a8d8=>{const _0x37bf4e=_0x2aa0b7;this['_logger'][_0x37bf4e(0xf6)](_0x33a8d8[_0x37bf4e(0x111)]+'.'+_0x33a8d8[_0x37bf4e(0x100)]+_0x37bf4e(0xef)+_0x33a8d8[_0x37bf4e(0xde)]);const _0x2d864f=(_0x33a8d8[_0x37bf4e(0x111)]+'.'+_0x33a8d8[_0x37bf4e(0x100)])['toLowerCase'](),_0x5ed7a6=_0x5a9100[_0x37bf4e(0x14b)](_0x2d864f);return{[constants_1[_0x37bf4e(0x11d)]+'Type__c']:_0x37bf4e(0xcc),[constants_1[_0x37bf4e(0x11d)]+_0x37bf4e(0xf7)]:_0x33a8d8[_0x37bf4e(0xde)]===status_enums_1[_0x37bf4e(0x107)][_0x37bf4e(0x159)]?_0x37bf4e(0x11a):_0x37bf4e(0xeb),[constants_1[_0x37bf4e(0x11d)]+_0x37bf4e(0x10c)]:_0x33a8d8[_0x37bf4e(0x13b)],[constants_1[_0x37bf4e(0x11d)]+_0x37bf4e(0x123)]:_0x33a8d8[_0x37bf4e(0x100)],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x33a8d8[_0x37bf4e(0x111)],[constants_1[_0x37bf4e(0x11d)]+'Veeva_Step_Name__c']:_0x33a8d8[_0x37bf4e(0x103)],[constants_1[_0x37bf4e(0x11d)]+_0x37bf4e(0xe0)]:this[_0x37bf4e(0x112)],[constants_1[_0x37bf4e(0x11d)]+_0x37bf4e(0x109)]:this[_0x37bf4e(0x101)],[constants_1['FLOSUM_NAMESPACE']+_0x37bf4e(0xe5)]:_0x5ed7a6[_0x37bf4e(0x149)]};});}async[a401_0x3d308c(0xe6)](_0x88ed70){const _0x38e6cc=a401_0x3d308c;this[_0x38e6cc(0xec)][_0x38e6cc(0xf6)](_0x38e6cc(0x129));const _0x309bdc=await this['_salesforceService'][_0x38e6cc(0x143)](constants_1[_0x38e6cc(0x11d)]+_0x38e6cc(0xf4),_0x88ed70),_0x5a8ef1=_0x309bdc[_0x38e6cc(0xd3)](_0x2dc04d=>!_0x2dc04d[_0x38e6cc(0x122)])['map'](_0x318b67=>_0x318b67[_0x38e6cc(0x12f)])[_0x38e6cc(0x144)]();if(_0x5a8ef1['length'])throw new salesforce_dml_error_1[(_0x38e6cc(0xe4))](_0x5a8ef1);}async[a401_0x3d308c(0x108)](_0x50e57a){const _0x46be63=a401_0x3d308c;this[_0x46be63(0xec)]['logError'](_0x50e57a),await this[_0x46be63(0xec)]['updateLog'](),await this['finishDeploy'](![],!![],'');}async[a401_0x3d308c(0xdd)](_0x1e507e,_0x5a2ee6,_0x543a39){const _0x3b3770=a401_0x3d308c,_0x36622d=_0x3b3770(0x125)+this[_0x3b3770(0xc2)]+'/'+this[_0x3b3770(0x101)]+'\x20>\x20'+_0x3b3770(0x11b)+_0x3b3770(0x126),_0x337b7f=_0x3b3770(0x125)+this[_0x3b3770(0xc2)]+'/'+this[_0x3b3770(0x112)]+'\x20>'+this[_0x3b3770(0x146)]+_0x3b3770(0xd7),_0x137560=_0x36622d+_0x3b3770(0x156)+_0x337b7f+_0x3b3770(0xc0),_0x2b2449={[constants_1[_0x3b3770(0x11d)]+'Action__c']:_0x137560,[constants_1[_0x3b3770(0x11d)]+_0x3b3770(0x138)]:new Date(),[constants_1[_0x3b3770(0x11d)]+'Branch__c']:this[_0x3b3770(0xed)],[constants_1['FLOSUM_NAMESPACE']+_0x3b3770(0x157)]:_0x3b3770(0x12b),[constants_1[_0x3b3770(0x11d)]+_0x3b3770(0xf5)]:_0x3b3770(0xcf),[constants_1[_0x3b3770(0x11d)]+'TargetId__c']:this['_organisationId']},_0x5a4d90={[constants_1[_0x3b3770(0x11d)]+'Is_Error__c']:!_0x1e507e,[constants_1[_0x3b3770(0x11d)]+_0x3b3770(0xce)]:_0x1e507e,[constants_1[_0x3b3770(0x11d)]+_0x3b3770(0xf7)]:_0x5a2ee6?status_enums_1[_0x3b3770(0x139)]['EXCEPTION']:status_enums_1[_0x3b3770(0x139)][_0x3b3770(0x155)],[constants_1[_0x3b3770(0x11d)]+_0x3b3770(0x14a)]:!![],[constants_1[_0x3b3770(0x11d)]+_0x3b3770(0xe1)]:_0x543a39};await this[_0x3b3770(0x119)][_0x3b3770(0xff)](flosum_constants_1[_0x3b3770(0xdb)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x3b3770(0x11d)]+_0x3b3770(0x13c)+this[_0x3b3770(0x101)],_0x5a4d90),await this[_0x3b3770(0x119)][_0x3b3770(0xea)](flosum_constants_1[_0x3b3770(0xdb)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x3b3770(0x11d)]+'Log__c',_0x2b2449),this[_0x3b3770(0xec)][_0x3b3770(0xf6)](_0x3b3770(0x142)+(_0x1e507e?_0x3b3770(0x15a):'with\x20error')+'.'),await this[_0x3b3770(0xec)]['updateLog']();}}exports[a401_0x3d308c(0x11e)]=DeployService;