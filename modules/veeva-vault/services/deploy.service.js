const a402_0x33e4fd=a402_0x541b;function a402_0x208b(){const _0x3910c3=['../../../constants','has','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','_systemLogger','<a\x20href=','VpkService','Deployment\x20Result','Retrieving\x20attachments','set','_veevaService','32OLkElw','Component_History__c','writeFile','_deploymentName','./vpk.service','veeva-deploy','Veeva_Step_Name__c','fs/promises','Org__c','jszip','16cCuClI','finishDeployWithError','Deploy\x20completed\x20','EXCEPTION','flat','Job_Completed__c','Result__c','getFlosumComponents','Logger','Form\x20Deployment\x20Results','_logger','Component_Type__c','finishDeploy','toLowerCase','bind','Save\x20Backup\x20to\x20Salesforce','VeevaService','../../../core','Deployment','export','type','DeployService','Create\x20Backup','import','Type__c','_connectionSalesforce','/vpk__','_organisationId','Action__c','createVpk','\x20</a>','\x20>\x20','_salesforceService','\x20has\x20been\x20created.','_attachmentLogId','_instanceUrl','PackageExportService','./veeva.service','Retrieving\x20components','Status__c','Cannot\x20retrievers\x20all\x20attachments','retrieve','lastIndexOf','map','ZipCreatorDeploy','default','Failure','(((.+)+)+)+$','../classes/errors/salesforce-dml-error','_tempFolder','stepName','_packageImportService','_vpkService','COMPLETED','post','22yjlxrd','packageId','metadataLogId','TargetId__c','_metadataLogId','FLOSUM_NAMESPACE','20MjIFSg','saveBackup','\x20:\x20','./package-export.service','Veeva\x20Deployment','PackageImportService','createZip','BranchComponentHistoryFlosumComponentRetriever','formFlosumDeploymentResults','</a>','retrieveAttachments','Success','generateAsync','logError','SalesforceDmlError','success','../classes/deploy/zip-creator.deploy','Cannot\x20Backup\x20more\x20than\x20200\x20components.','1421196LnaXWX','_componentIdList','974508PIlxur','text/plain','generate','organisationId','2355140GZgGQy','attachmentLogId','./salesforce.service','../enums/status.enums','status','External_Deployment_Id__c','Activity_Item__c','execute','/Attachment','with\x20error','Body','toString','slice','saveDeploymentResults','componentName','base64','_organisationName','componentIdList','Cannot\x20retrieve\x20all\x20components.','_branchId','MetadataLogStatus','validate','length','fetchAttachmentsDetailsByParentId','2413424TlwuHJ','patch','_packageExportService','Backup','branchId','367633EOPTFc','saveLog','apply','catch','componentHistoryId','BACKUP_ZIP_NAME','FlosumComponentVeevaComponentRetriever','.zip','updateLog','Date__c','name','filter','27461FJTuwA','FlosumConstants','ENDPOINT_UPSERT_RECORD','Branch__c','Create\x20vpk\x20package','__esModule','_connectionVeeva','Deployment_Result__c','errors','122127iHyWin','Succeed__c','constructor','9vOIoKr','reduce','log','deploymentAction','createBackup'];a402_0x208b=function(){return _0x3910c3;};return a402_0x208b();}(function(_0x18addf,_0x27d038){const _0x3bdb45=a402_0x541b,_0x3c4c4a=_0x18addf();while(!![]){try{const _0x493d85=parseInt(_0x3bdb45(0x1d0))/0x1+parseInt(_0x3bdb45(0x1cb))/0x2+parseInt(_0x3bdb45(0x1e5))/0x3*(parseInt(_0x3bdb45(0x201))/0x4)+-parseInt(_0x3bdb45(0x23e))/0x5*(parseInt(_0x3bdb45(0x1ad))/0x6)+parseInt(_0x3bdb45(0x1dc))/0x7*(-parseInt(_0x3bdb45(0x1f7))/0x8)+parseInt(_0x3bdb45(0x1e8))/0x9*(-parseInt(_0x3bdb45(0x1b3))/0xa)+parseInt(_0x3bdb45(0x238))/0xb*(parseInt(_0x3bdb45(0x1af))/0xc);if(_0x493d85===_0x27d038)break;else _0x3c4c4a['push'](_0x3c4c4a['shift']());}catch(_0x1b43b4){_0x3c4c4a['push'](_0x3c4c4a['shift']());}}}(a402_0x208b,0xab201));const a402_0x4f7ecd=(function(){let _0x385b11=!![];return function(_0x33cbc9,_0x2088b7){const _0x52273e=_0x385b11?function(){const _0x320eac=a402_0x541b;if(_0x2088b7){const _0x2542b4=_0x2088b7[_0x320eac(0x1d2)](_0x33cbc9,arguments);return _0x2088b7=null,_0x2542b4;}}:function(){};return _0x385b11=![],_0x52273e;};}()),a402_0x4ce01b=a402_0x4f7ecd(this,function(){const _0x396fec=a402_0x541b;return a402_0x4ce01b[_0x396fec(0x1be)]()['search'](_0x396fec(0x230))[_0x396fec(0x1be)]()[_0x396fec(0x1e7)](a402_0x4ce01b)['search']('(((.+)+)+)+$');});a402_0x4ce01b();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x74184d){const _0x518734=a402_0x541b;return _0x74184d&&_0x74184d[_0x518734(0x1e1)]?_0x74184d:{'default':_0x74184d};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a402_0x33e4fd(0x216)]=void 0x0;function a402_0x541b(_0x1ee52d,_0x10e303){const _0x1c6acc=a402_0x208b();return a402_0x541b=function(_0x4ce01b,_0x4f7ecd){_0x4ce01b=_0x4ce01b-0x1a3;let _0x208b9d=_0x1c6acc[_0x4ce01b];return _0x208b9d;},a402_0x541b(_0x1ee52d,_0x10e303);}const jszip_1=__importDefault(require(a402_0x33e4fd(0x200))),promises_1=require(a402_0x33e4fd(0x1fe)),constants_1=require(a402_0x33e4fd(0x1ed)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a402_0x33e4fd(0x226)),salesforce_service_1=require(a402_0x33e4fd(0x1b5)),core_1=require(a402_0x33e4fd(0x212)),status_enums_1=require(a402_0x33e4fd(0x1b6)),salesforce_dml_error_1=require(a402_0x33e4fd(0x231)),shortid_1=__importDefault(require('shortid')),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require('../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever'),flosum_component_veeva_component_retriever_1=require(a402_0x33e4fd(0x1ef)),package_export_service_1=require(a402_0x33e4fd(0x241)),vpk_service_1=require(a402_0x33e4fd(0x1fb)),zip_creator_deploy_1=require(a402_0x33e4fd(0x1ab));class DeployService{constructor(_0x49e742,_0x425aa8,_0x165ca6,_0x4270b5,_0x48f8bc,_0x561b85){const _0x4dd786=a402_0x33e4fd;this[_0x4dd786(0x21a)]=_0x425aa8,this['_connectionVeeva']=_0x165ca6,this[_0x4dd786(0x20b)]=_0x4270b5,this[_0x4dd786(0x232)]=_0x48f8bc,this[_0x4dd786(0x224)]=_0x561b85,this[_0x4dd786(0x1c6)]=_0x49e742[_0x4dd786(0x1cf)],this[_0x4dd786(0x23c)]=_0x49e742[_0x4dd786(0x23a)],this[_0x4dd786(0x223)]=_0x49e742[_0x4dd786(0x1b4)],this[_0x4dd786(0x21c)]=_0x49e742[_0x4dd786(0x1b2)],this['_timeZone']=_0x49e742['timeZone'],this[_0x4dd786(0x1c3)]=_0x49e742['organisationName'],this['_componentIdList']=_0x49e742[_0x4dd786(0x1c4)],this[_0x4dd786(0x1fa)]=_0x49e742['deploymentName'],this[_0x4dd786(0x1f0)]=new core_1[(_0x4dd786(0x209))](_0x4dd786(0x1fc)),this[_0x4dd786(0x1f6)]=new veeva_service_1[(_0x4dd786(0x211))]({'connection':this[_0x4dd786(0x1e2)],'logger':this[_0x4dd786(0x20b)]}),this[_0x4dd786(0x221)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x4dd786(0x21a)]}),this[_0x4dd786(0x234)]=new package_import_service_1[(_0x4dd786(0x243))]({'veevaService':this['_veevaService'],'connection':this[_0x4dd786(0x1e2)],'logger':this[_0x4dd786(0x20b)],'saveLog':this[_0x4dd786(0x1d1)][_0x4dd786(0x20f)](this)}),this[_0x4dd786(0x1cd)]=new package_export_service_1[(_0x4dd786(0x225))]({'veevaService':this[_0x4dd786(0x1f6)],'connection':this[_0x4dd786(0x1e2)],'logger':this[_0x4dd786(0x20b)]}),this[_0x4dd786(0x235)]=new vpk_service_1[(_0x4dd786(0x1f2))]({'connection':this[_0x4dd786(0x1e2)]});}async[a402_0x33e4fd(0x1ba)](){const _0x4a1af2=a402_0x33e4fd;try{const _0x1b16b1=await this[_0x4a1af2(0x208)]();await this['_logger'][_0x4a1af2(0x1d8)]();const _0x21656a=await this[_0x4a1af2(0x1ec)](_0x1b16b1);await this['saveBackup'](_0x21656a);const _0x2ad6f4=await this[_0x4a1af2(0x1a5)](_0x1b16b1),_0x484a2f=await this[_0x4a1af2(0x244)](_0x2ad6f4),_0x20c269=await this[_0x4a1af2(0x21e)](_0x484a2f);await this['_logger']['updateLog']();const _0x605585=await this['_packageImportService'][_0x4a1af2(0x218)](_0x20c269);await this[_0x4a1af2(0x20b)][_0x4a1af2(0x1d8)]();const _0x1ba8cc=this['formFlosumDeploymentResults'](_0x1b16b1,_0x605585['packageComponentList']);await this[_0x4a1af2(0x1c0)](_0x1ba8cc),await this[_0x4a1af2(0x20d)](_0x605585['isDeployed'],![],_0x605585[_0x4a1af2(0x239)]);}catch(_0xd73adf){await this[_0x4a1af2(0x202)](_0xd73adf)[_0x4a1af2(0x1d3)](_0x30dc0b=>this[_0x4a1af2(0x1f0)]['error'](_0x30dc0b));}}async[a402_0x33e4fd(0x208)](){const _0x368552=a402_0x33e4fd,_0x57be29=new Set(this[_0x368552(0x1ae)]);this[_0x368552(0x20b)][_0x368552(0x1ea)](_0x368552(0x227));const _0x7d67a8=await new branch_component_history_flosum_component_retriever_1[(_0x368552(0x245))]({'value':this['_branchId'],'salesforceService':this[_0x368552(0x221)]})[_0x368552(0x22a)](),_0x2f3f00=_0x7d67a8[_0x368552(0x1db)](_0x29b37c=>_0x57be29[_0x368552(0x1ee)](_0x29b37c['id']));if(_0x2f3f00[_0x368552(0x1c9)]!==this[_0x368552(0x1ae)][_0x368552(0x1c9)])throw new Error(_0x368552(0x1c5));return _0x2f3f00;}async[a402_0x33e4fd(0x1ec)](_0x43c500){const _0x4e1ec4=a402_0x33e4fd;var _0x20af7e;this[_0x4e1ec4(0x20b)][_0x4e1ec4(0x1ea)](_0x4e1ec4(0x217));const _0x569bea=await new flosum_component_veeva_component_retriever_1[(_0x4e1ec4(0x1d6))]({'value':_0x43c500,'veevaService':this['_veevaService'],'logger':this[_0x4e1ec4(0x20b)]})[_0x4e1ec4(0x22a)](),_0x1da043=await this[_0x4e1ec4(0x1cd)][_0x4e1ec4(0x214)](_0x569bea,_0x4e1ec4(0x1ce));if(_0x1da043[_0x4e1ec4(0x1c9)]>0x1)throw new Error(_0x4e1ec4(0x1ac));return(_0x20af7e=_0x1da043[0x0])!==null&&_0x20af7e!==void 0x0?_0x20af7e:_0x1da043[0x0]=new jszip_1[(_0x4e1ec4(0x22e))](),_0x1da043[0x0][_0x4e1ec4(0x1a7)]({'type':_0x4e1ec4(0x1c2)});}async[a402_0x33e4fd(0x23f)](_0x1d4eb6){const _0x278fd4=a402_0x33e4fd;this[_0x278fd4(0x20b)][_0x278fd4(0x1ea)](_0x278fd4(0x210));const _0x4b7235={'Body':_0x1d4eb6,'ContentType':'application/zip','ParentId':this[_0x278fd4(0x23c)],'Name':flosum_constants_1[_0x278fd4(0x1dd)][_0x278fd4(0x1d5)]};await this[_0x278fd4(0x21a)][_0x278fd4(0x237)](flosum_constants_1[_0x278fd4(0x1dd)][_0x278fd4(0x1de)]+_0x278fd4(0x1bb),_0x4b7235);}async[a402_0x33e4fd(0x1a5)](_0x58cd46){const _0x401681=a402_0x33e4fd;this['_logger'][_0x401681(0x1ea)](_0x401681(0x1f4));const _0x2e99e2=await(0x0,fetch_attachments_1[_0x401681(0x1ca)])(this[_0x401681(0x21a)],_0x58cd46[_0x401681(0x22c)](_0x32cc35=>_0x32cc35['componentHistoryId'])),_0x5eab15=await(0x0,fetch_attachments_1[_0x401681(0x1a5)])(_0x2e99e2,this[_0x401681(0x21a)]);if(_0x5eab15[_0x401681(0x1c9)]!==this[_0x401681(0x1ae)][_0x401681(0x1c9)])throw new Error(_0x401681(0x229));return _0x5eab15[_0x401681(0x22c)](_0x2c4fa1=>_0x2c4fa1['values'][_0x401681(0x1bd)]);}async['createZip'](_0xd2ae90){const _0x21672a=a402_0x33e4fd;this[_0x21672a(0x20b)][_0x21672a(0x1ea)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x477f04=await new zip_creator_deploy_1[(_0x21672a(0x22d))]({'attachmentBodies':_0xd2ae90,'deploymentName':this[_0x21672a(0x1fa)]})[_0x21672a(0x1ba)](),_0x5a0a14=this[_0x21672a(0x232)]+'/'+(0x0,shortid_1[_0x21672a(0x22e)])()+_0x21672a(0x1d7);return await(0x0,promises_1[_0x21672a(0x1f9)])(_0x5a0a14,_0x477f04),_0x5a0a14;}async[a402_0x33e4fd(0x21e)](_0x3dd6b8){const _0x3871eb=a402_0x33e4fd;this['_logger'][_0x3871eb(0x1ea)](_0x3871eb(0x1e0));const _0x3d1b23=await this[_0x3871eb(0x235)][_0x3871eb(0x1b1)](_0x3dd6b8),_0x2979d6=this['_tempFolder']+_0x3871eb(0x21b)+_0x3dd6b8[_0x3871eb(0x1bf)](_0x3dd6b8[_0x3871eb(0x22b)]('/')+0x1);return await(0x0,promises_1[_0x3871eb(0x1f9)])(_0x2979d6,_0x3d1b23),await this[_0x3871eb(0x235)][_0x3871eb(0x1c8)](_0x2979d6),_0x2979d6;}async[a402_0x33e4fd(0x1d1)](_0x5553ba,_0x1ea2dc){const _0x5956a3=a402_0x33e4fd;this[_0x5956a3(0x20b)][_0x5956a3(0x1ea)]('Save\x20log');const _0x230531={'Body':Buffer['from'](_0x5553ba)[_0x5956a3(0x1be)]('base64'),'ContentType':_0x5956a3(0x1b0),'ParentId':this[_0x5956a3(0x23c)],'Name':_0x1ea2dc};await this[_0x5956a3(0x21a)][_0x5956a3(0x237)](flosum_constants_1[_0x5956a3(0x1dd)][_0x5956a3(0x1de)]+_0x5956a3(0x1bb),_0x230531);}[a402_0x33e4fd(0x1a3)](_0x3c7d6f,_0x281e07){const _0x4036d0=a402_0x33e4fd;this[_0x4036d0(0x20b)][_0x4036d0(0x1ea)](_0x4036d0(0x20a));const _0x29c69e=_0x3c7d6f[_0x4036d0(0x1e9)]((_0xfa66bb,_0x486164)=>_0xfa66bb[_0x4036d0(0x1f5)]((_0x486164['componentType']+'.'+_0x486164[_0x4036d0(0x1c1)])[_0x4036d0(0x20e)](),_0x486164),new Map());return _0x281e07[_0x4036d0(0x22c)](_0x416d08=>{const _0x58b600=_0x4036d0;this[_0x58b600(0x20b)]['log'](_0x416d08[_0x58b600(0x215)]+'.'+_0x416d08['name']+_0x58b600(0x240)+_0x416d08['status']);const _0x267858=(_0x416d08[_0x58b600(0x215)]+'.'+_0x416d08[_0x58b600(0x1da)])[_0x58b600(0x20e)](),_0x5517c9=_0x29c69e['get'](_0x267858);return{[constants_1['FLOSUM_NAMESPACE']+_0x58b600(0x219)]:_0x58b600(0x1f3),[constants_1[_0x58b600(0x23d)]+_0x58b600(0x228)]:_0x416d08[_0x58b600(0x1b7)]===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x58b600(0x1a6):_0x58b600(0x22f),[constants_1[_0x58b600(0x23d)]+_0x58b600(0x207)]:_0x416d08[_0x58b600(0x1eb)],[constants_1[_0x58b600(0x23d)]+'Component_Name__c']:_0x416d08['name'],[constants_1[_0x58b600(0x23d)]+_0x58b600(0x20c)]:_0x416d08['type'],[constants_1[_0x58b600(0x23d)]+_0x58b600(0x1fd)]:_0x416d08[_0x58b600(0x233)],[constants_1[_0x58b600(0x23d)]+_0x58b600(0x1ff)]:this[_0x58b600(0x21c)],[constants_1[_0x58b600(0x23d)]+'Metadata_Log__c']:this['_metadataLogId'],[constants_1[_0x58b600(0x23d)]+_0x58b600(0x1f8)]:_0x5517c9[_0x58b600(0x1d4)]};});}async[a402_0x33e4fd(0x1c0)](_0x49fa93){const _0x5eaffa=a402_0x33e4fd;this['_logger']['log']('Save\x20Deployment\x20Results');const _0x30986d=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x5eaffa(0x23d)]+_0x5eaffa(0x1e3),_0x49fa93),_0x535ee6=_0x30986d[_0x5eaffa(0x1db)](_0x163e77=>!_0x163e77[_0x5eaffa(0x1aa)])[_0x5eaffa(0x22c)](_0x20c597=>_0x20c597[_0x5eaffa(0x1e4)])[_0x5eaffa(0x205)]();if(_0x535ee6[_0x5eaffa(0x1c9)])throw new salesforce_dml_error_1[(_0x5eaffa(0x1a9))](_0x535ee6);}async[a402_0x33e4fd(0x202)](_0xfccd7){const _0x166458=a402_0x33e4fd;this[_0x166458(0x20b)][_0x166458(0x1a8)](_0xfccd7),await this[_0x166458(0x20b)][_0x166458(0x1d8)](),await this[_0x166458(0x20d)](![],!![],'');}async[a402_0x33e4fd(0x20d)](_0x908bcd,_0x31eace,_0x1fdb89){const _0x4b5173=a402_0x33e4fd,_0xad6d5f=_0x4b5173(0x1f1)+this[_0x4b5173(0x224)]+'/'+this['_metadataLogId']+_0x4b5173(0x220)+_0x4b5173(0x242)+_0x4b5173(0x21f),_0x50bcff=_0x4b5173(0x1f1)+this[_0x4b5173(0x224)]+'/'+this[_0x4b5173(0x21c)]+'\x20>'+this[_0x4b5173(0x1c3)]+_0x4b5173(0x1a4),_0x5a6e66=_0xad6d5f+'\x20of\x20branch\x20to\x20Organization\x20'+_0x50bcff+_0x4b5173(0x222),_0x181618={[constants_1[_0x4b5173(0x23d)]+_0x4b5173(0x21d)]:_0x5a6e66,[constants_1[_0x4b5173(0x23d)]+_0x4b5173(0x1d9)]:new Date(),[constants_1[_0x4b5173(0x23d)]+_0x4b5173(0x1df)]:this[_0x4b5173(0x1c6)],[constants_1['FLOSUM_NAMESPACE']+_0x4b5173(0x1b9)]:'Branch',[constants_1[_0x4b5173(0x23d)]+'Activity_Type__c']:_0x4b5173(0x213),[constants_1['FLOSUM_NAMESPACE']+_0x4b5173(0x23b)]:this['_organisationId']},_0x31151b={[constants_1[_0x4b5173(0x23d)]+'Is_Error__c']:!_0x908bcd,[constants_1[_0x4b5173(0x23d)]+_0x4b5173(0x1e6)]:_0x908bcd,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x31eace?status_enums_1['MetadataLogStatus'][_0x4b5173(0x204)]:status_enums_1[_0x4b5173(0x1c7)][_0x4b5173(0x236)],[constants_1['FLOSUM_NAMESPACE']+_0x4b5173(0x206)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x4b5173(0x1b8)]:_0x1fdb89};await this['_connectionSalesforce'][_0x4b5173(0x1cc)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x4b5173(0x23d)]+'Metadata_Log__c/'+this[_0x4b5173(0x23c)],_0x31151b),await this['_connectionSalesforce'][_0x4b5173(0x237)](flosum_constants_1[_0x4b5173(0x1dd)][_0x4b5173(0x1de)]+'/'+constants_1[_0x4b5173(0x23d)]+'Log__c',_0x181618),this[_0x4b5173(0x20b)][_0x4b5173(0x1ea)](_0x4b5173(0x203)+(_0x908bcd?'successfully':_0x4b5173(0x1bc))+'.'),await this[_0x4b5173(0x20b)][_0x4b5173(0x1d8)]();}}exports[a402_0x33e4fd(0x216)]=DeployService;