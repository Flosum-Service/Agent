function a402_0xe843(_0x1aca1c,_0x3e4173){const _0x4307c7=a402_0x6423();return a402_0xe843=function(_0x14fc28,_0x258704){_0x14fc28=_0x14fc28-0x125;let _0x6423e8=_0x4307c7[_0x14fc28];return _0x6423e8;},a402_0xe843(_0x1aca1c,_0x3e4173);}const a402_0x4cdb92=a402_0xe843;(function(_0x235820,_0x43b30d){const _0xe612e6=a402_0xe843,_0x3b23a5=_0x235820();while(!![]){try{const _0x1294c0=-parseInt(_0xe612e6(0x160))/0x1*(parseInt(_0xe612e6(0x194))/0x2)+parseInt(_0xe612e6(0x176))/0x3*(parseInt(_0xe612e6(0x190))/0x4)+parseInt(_0xe612e6(0x161))/0x5*(-parseInt(_0xe612e6(0x154))/0x6)+-parseInt(_0xe612e6(0x145))/0x7*(parseInt(_0xe612e6(0x1a9))/0x8)+parseInt(_0xe612e6(0x12e))/0x9+-parseInt(_0xe612e6(0x125))/0xa+parseInt(_0xe612e6(0x17b))/0xb;if(_0x1294c0===_0x43b30d)break;else _0x3b23a5['push'](_0x3b23a5['shift']());}catch(_0x4d3e74){_0x3b23a5['push'](_0x3b23a5['shift']());}}}(a402_0x6423,0x96490));const a402_0x258704=(function(){let _0x1be873=!![];return function(_0x1f3762,_0x47dbf2){const _0xc2eccc=_0x1be873?function(){if(_0x47dbf2){const _0x58fa33=_0x47dbf2['apply'](_0x1f3762,arguments);return _0x47dbf2=null,_0x58fa33;}}:function(){};return _0x1be873=![],_0xc2eccc;};}()),a402_0x14fc28=a402_0x258704(this,function(){const _0xd10ca5=a402_0xe843;return a402_0x14fc28[_0xd10ca5(0x170)]()[_0xd10ca5(0x169)]('(((.+)+)+)+$')['toString']()[_0xd10ca5(0x164)](a402_0x14fc28)[_0xd10ca5(0x169)]('(((.+)+)+)+$');});function a402_0x6423(){const _0x3497a3=['_connectionVeeva','branchId','stepName','import','name','356FIWAIc','toLowerCase','_instanceUrl','VpkService','20hnONpA','./veeva.service','length','default','isDeployed','_veevaService','.zip','Veeva\x20Deployment','base64','reduce','./package-export.service','Type__c','ZipCreatorDeploy','Save\x20log','_organisationName','BACKUP_ZIP_NAME','saveDeploymentResults','has','FlosumComponentVeevaComponentRetriever','Create\x20Backup','values','11112asssKW','ENDPOINT_UPSERT_RECORD','FlosumConstants','Join\x20all\x20mdl\x20into\x20one\x20zip','__importDefault','componentHistoryId','BranchComponentHistoryFlosumComponentRetriever','_vpkService','post','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','from','Status__c','_deploymentName','Deploy\x20completed\x20','componentName','Date__c','FLOSUM_NAMESPACE','type','timeZone','../../../core','deploymentAction','_packageExportService','execute','Logger','Action__c','Retrieving\x20components','\x20of\x20branch\x20to\x20Organization\x20','fs/promises','External_Deployment_Id__c','Component_Name__c','catch','packageComponentList','394270CifPTL','_timeZone','../enums/status.enums','Activity_Type__c','map','lastIndexOf','Deployment_Result__c','../classes/deploy/zip-creator.deploy','PackageComponentStatus','413361vNRFha','error','_logger','filter','VeevaService','packageId','/Attachment','createVpk','Cannot\x20retrieve\x20all\x20components.','getFlosumComponents','flat','patch','../../shared/utils/fetch-attachments','./vpk.service','Body','_systemLogger','./package-import.service','slice','saveLog','generateAsync','retrieve','Log__c','_metadataLogId','1911cvMYSy','generate','createZip','log','set','__esModule','../classes/errors/salesforce-dml-error','PackageExportService','application/zip','_componentIdList','writeFile','jszip','Retrieving\x20attachments','errors','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','6pJhLbV','Save\x20Deployment\x20Results','Metadata_Log__c','Org__c','Branch','Is_Error__c','_packageImportService','COMPLETED','_connectionSalesforce','PackageImportService','organisationName','_attachmentLogId','19709UHbbNo','5706595lgIeyx','_branchId','_tempFolder','constructor','shortid','text/plain','<a\x20href=','componentType','search','MetadataLogStatus','defineProperty','Branch__c','formFlosumDeploymentResults','Cannot\x20retrievers\x20all\x20attachments','createBackup','toString','Success','updateLog','status','_organisationId','success','33942nErdFG','saveBackup','../../../constants','Result__c','attachmentLogId','14516986lDrZWt','Deployment\x20Result','finishDeploy','organisationId','Component_History__c','deploymentName','</a>','\x20</a>','Veeva_Step_Name__c','Activity_Item__c','Deployment','retrieveAttachments','finishDeployWithError','_salesforceService','DeployService','insertMultipleRecords'];a402_0x6423=function(){return _0x3497a3;};return a402_0x6423();}a402_0x14fc28();'use strict';var __importDefault=this&&this[a402_0x4cdb92(0x1ad)]||function(_0x3228e8){const _0x87c938=a402_0x4cdb92;return _0x3228e8&&_0x3228e8[_0x87c938(0x14a)]?_0x3228e8:{'default':_0x3228e8};};Object[a402_0x4cdb92(0x16b)](exports,a402_0x4cdb92(0x14a),{'value':!![]}),exports[a402_0x4cdb92(0x189)]=void 0x0;const jszip_1=__importDefault(require(a402_0x4cdb92(0x150))),promises_1=require(a402_0x4cdb92(0x1c4)),constants_1=require(a402_0x4cdb92(0x178)),flosum_constants_1=require('../constants/flosum.constants'),veeva_service_1=require(a402_0x4cdb92(0x195)),salesforce_service_1=require('./salesforce.service'),core_1=require(a402_0x4cdb92(0x1bc)),status_enums_1=require(a402_0x4cdb92(0x127)),salesforce_dml_error_1=require(a402_0x4cdb92(0x14b)),shortid_1=__importDefault(require(a402_0x4cdb92(0x165))),fetch_attachments_1=require(a402_0x4cdb92(0x13a)),package_import_service_1=require(a402_0x4cdb92(0x13e)),branch_component_history_flosum_component_retriever_1=require(a402_0x4cdb92(0x153)),flosum_component_veeva_component_retriever_1=require(a402_0x4cdb92(0x1b2)),package_export_service_1=require(a402_0x4cdb92(0x19e)),vpk_service_1=require(a402_0x4cdb92(0x13b)),zip_creator_deploy_1=require(a402_0x4cdb92(0x12c));class DeployService{constructor(_0x3a810d,_0x6b92,_0x34d3fd,_0x9d3685,_0x49a53f,_0x2bb1d2){const _0x3a1bad=a402_0x4cdb92;this[_0x3a1bad(0x15c)]=_0x6b92,this['_connectionVeeva']=_0x34d3fd,this[_0x3a1bad(0x130)]=_0x9d3685,this[_0x3a1bad(0x163)]=_0x49a53f,this[_0x3a1bad(0x192)]=_0x2bb1d2,this['_branchId']=_0x3a810d[_0x3a1bad(0x18c)],this[_0x3a1bad(0x144)]=_0x3a810d['metadataLogId'],this[_0x3a1bad(0x15f)]=_0x3a810d[_0x3a1bad(0x17a)],this['_organisationId']=_0x3a810d[_0x3a1bad(0x17e)],this[_0x3a1bad(0x126)]=_0x3a810d[_0x3a1bad(0x1bb)],this[_0x3a1bad(0x1a2)]=_0x3a810d[_0x3a1bad(0x15e)],this[_0x3a1bad(0x14e)]=_0x3a810d['componentIdList'],this[_0x3a1bad(0x1b5)]=_0x3a810d[_0x3a1bad(0x180)],this[_0x3a1bad(0x13d)]=new core_1[(_0x3a1bad(0x1c0))]('veeva-deploy'),this[_0x3a1bad(0x199)]=new veeva_service_1[(_0x3a1bad(0x132))]({'connection':this[_0x3a1bad(0x18b)],'logger':this[_0x3a1bad(0x130)]}),this[_0x3a1bad(0x188)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x3a1bad(0x15c)]}),this[_0x3a1bad(0x15a)]=new package_import_service_1[(_0x3a1bad(0x15d))]({'veevaService':this[_0x3a1bad(0x199)],'connection':this[_0x3a1bad(0x18b)],'logger':this[_0x3a1bad(0x130)],'saveLog':this[_0x3a1bad(0x140)]['bind'](this)}),this['_packageExportService']=new package_export_service_1[(_0x3a1bad(0x14c))]({'veevaService':this[_0x3a1bad(0x199)],'connection':this[_0x3a1bad(0x18b)],'logger':this['_logger']}),this['_vpkService']=new vpk_service_1[(_0x3a1bad(0x193))]({'connection':this[_0x3a1bad(0x18b)]});}async['execute'](){const _0x2e0a78=a402_0x4cdb92;try{const _0x2a4738=await this[_0x2e0a78(0x137)]();await this['_logger']['updateLog']();const _0x51ccf9=await this[_0x2e0a78(0x16f)](_0x2a4738);await this['saveBackup'](_0x51ccf9);const _0xa52a4e=await this[_0x2e0a78(0x186)](_0x2a4738),_0x256d81=await this['createZip'](_0xa52a4e),_0x5063a6=await this[_0x2e0a78(0x135)](_0x256d81);await this[_0x2e0a78(0x130)]['updateLog']();const _0x3b6351=await this[_0x2e0a78(0x15a)][_0x2e0a78(0x18e)](_0x5063a6);await this[_0x2e0a78(0x130)][_0x2e0a78(0x172)]();const _0x226a33=this[_0x2e0a78(0x16d)](_0x2a4738,_0x3b6351[_0x2e0a78(0x1c8)]);await this[_0x2e0a78(0x1a4)](_0x226a33),await this[_0x2e0a78(0x17d)](_0x3b6351[_0x2e0a78(0x198)],![],_0x3b6351[_0x2e0a78(0x133)]);}catch(_0x416681){await this[_0x2e0a78(0x187)](_0x416681)[_0x2e0a78(0x1c7)](_0x3373bc=>this[_0x2e0a78(0x13d)][_0x2e0a78(0x12f)](_0x3373bc));}}async[a402_0x4cdb92(0x137)](){const _0x4bcbee=a402_0x4cdb92,_0x464e16=new Set(this[_0x4bcbee(0x14e)]);this[_0x4bcbee(0x130)][_0x4bcbee(0x148)](_0x4bcbee(0x1c2));const _0x3d2d97=await new branch_component_history_flosum_component_retriever_1[(_0x4bcbee(0x1af))]({'value':this[_0x4bcbee(0x162)],'salesforceService':this[_0x4bcbee(0x188)]})[_0x4bcbee(0x142)](),_0x1e209c=_0x3d2d97[_0x4bcbee(0x131)](_0xd639fe=>_0x464e16[_0x4bcbee(0x1a5)](_0xd639fe['id']));if(_0x1e209c[_0x4bcbee(0x196)]!==this[_0x4bcbee(0x14e)][_0x4bcbee(0x196)])throw new Error(_0x4bcbee(0x136));return _0x1e209c;}async['createBackup'](_0x3bf683){const _0x219d5e=a402_0x4cdb92;var _0xab0ec6;this[_0x219d5e(0x130)][_0x219d5e(0x148)](_0x219d5e(0x1a7));const _0x62aa64=await new flosum_component_veeva_component_retriever_1[(_0x219d5e(0x1a6))]({'value':_0x3bf683,'veevaService':this[_0x219d5e(0x199)],'logger':this[_0x219d5e(0x130)]})['retrieve'](),_0x4065d4=await this[_0x219d5e(0x1be)]['export'](_0x62aa64,'Backup');if(_0x4065d4['length']>0x1)throw new Error('Cannot\x20Backup\x20more\x20than\x20200\x20components.');return(_0xab0ec6=_0x4065d4[0x0])!==null&&_0xab0ec6!==void 0x0?_0xab0ec6:_0x4065d4[0x0]=new jszip_1[(_0x219d5e(0x197))](),_0x4065d4[0x0][_0x219d5e(0x141)]({'type':_0x219d5e(0x19c)});}async[a402_0x4cdb92(0x177)](_0x4dad88){const _0xb2c58=a402_0x4cdb92;this['_logger'][_0xb2c58(0x148)]('Save\x20Backup\x20to\x20Salesforce');const _0x471d2a={'Body':_0x4dad88,'ContentType':_0xb2c58(0x14d),'ParentId':this[_0xb2c58(0x144)],'Name':flosum_constants_1[_0xb2c58(0x1ab)][_0xb2c58(0x1a3)]};await this['_connectionSalesforce']['post'](flosum_constants_1[_0xb2c58(0x1ab)]['ENDPOINT_UPSERT_RECORD']+_0xb2c58(0x134),_0x471d2a);}async[a402_0x4cdb92(0x186)](_0x2f789e){const _0x54fc5e=a402_0x4cdb92;this[_0x54fc5e(0x130)][_0x54fc5e(0x148)](_0x54fc5e(0x151));const _0x546b4e=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsByParentId'])(this[_0x54fc5e(0x15c)],_0x2f789e[_0x54fc5e(0x129)](_0x2b91bb=>_0x2b91bb[_0x54fc5e(0x1ae)])),_0xd63cfa=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x546b4e,this['_connectionSalesforce']);if(_0xd63cfa[_0x54fc5e(0x196)]!==this[_0x54fc5e(0x14e)][_0x54fc5e(0x196)])throw new Error(_0x54fc5e(0x16e));return _0xd63cfa[_0x54fc5e(0x129)](_0x3c0901=>_0x3c0901[_0x54fc5e(0x1a8)][_0x54fc5e(0x13c)]);}async[a402_0x4cdb92(0x147)](_0x45ae9a){const _0x276d09=a402_0x4cdb92;this[_0x276d09(0x130)][_0x276d09(0x148)](_0x276d09(0x1ac));const _0x2834b4=await new zip_creator_deploy_1[(_0x276d09(0x1a0))]({'attachmentBodies':_0x45ae9a,'deploymentName':this['_deploymentName']})[_0x276d09(0x1bf)](),_0x153743=this[_0x276d09(0x163)]+'/'+(0x0,shortid_1[_0x276d09(0x197)])()+_0x276d09(0x19a);return await(0x0,promises_1[_0x276d09(0x14f)])(_0x153743,_0x2834b4),_0x153743;}async[a402_0x4cdb92(0x135)](_0x261a8d){const _0x399164=a402_0x4cdb92;this['_logger'][_0x399164(0x148)]('Create\x20vpk\x20package');const _0x41aea4=await this[_0x399164(0x1b0)][_0x399164(0x146)](_0x261a8d),_0x3b87b9=this[_0x399164(0x163)]+'/vpk__'+_0x261a8d[_0x399164(0x13f)](_0x261a8d[_0x399164(0x12a)]('/')+0x1);return await(0x0,promises_1[_0x399164(0x14f)])(_0x3b87b9,_0x41aea4),await this[_0x399164(0x1b0)]['validate'](_0x3b87b9),_0x3b87b9;}async[a402_0x4cdb92(0x140)](_0x56d616,_0x3e4d88){const _0x5e47d4=a402_0x4cdb92;this['_logger'][_0x5e47d4(0x148)](_0x5e47d4(0x1a1));const _0x27cd17={'Body':Buffer[_0x5e47d4(0x1b3)](_0x56d616)['toString'](_0x5e47d4(0x19c)),'ContentType':_0x5e47d4(0x166),'ParentId':this[_0x5e47d4(0x144)],'Name':_0x3e4d88};await this[_0x5e47d4(0x15c)][_0x5e47d4(0x1b1)](flosum_constants_1[_0x5e47d4(0x1ab)][_0x5e47d4(0x1aa)]+_0x5e47d4(0x134),_0x27cd17);}[a402_0x4cdb92(0x16d)](_0x3d84b6,_0x50e12d){const _0x3ab4c9=a402_0x4cdb92;this[_0x3ab4c9(0x130)][_0x3ab4c9(0x148)]('Form\x20Deployment\x20Results');const _0x43f4f2=_0x3d84b6[_0x3ab4c9(0x19d)]((_0x1a43c3,_0x283e63)=>_0x1a43c3[_0x3ab4c9(0x149)]((_0x283e63[_0x3ab4c9(0x168)]+'.'+_0x283e63[_0x3ab4c9(0x1b7)])[_0x3ab4c9(0x191)](),_0x283e63),new Map());return _0x50e12d['map'](_0x401d16=>{const _0x5a63eb=_0x3ab4c9;this[_0x5a63eb(0x130)][_0x5a63eb(0x148)](_0x401d16['type']+'.'+_0x401d16['name']+'\x20:\x20'+_0x401d16[_0x5a63eb(0x173)]);const _0x32a992=(_0x401d16[_0x5a63eb(0x1ba)]+'.'+_0x401d16[_0x5a63eb(0x18f)])[_0x5a63eb(0x191)](),_0x2f046f=_0x43f4f2['get'](_0x32a992);return{[constants_1[_0x5a63eb(0x1b9)]+_0x5a63eb(0x19f)]:_0x5a63eb(0x17c),[constants_1['FLOSUM_NAMESPACE']+_0x5a63eb(0x1b4)]:_0x401d16['status']===status_enums_1[_0x5a63eb(0x12d)]['DEPLOYED']?_0x5a63eb(0x171):'Failure',[constants_1[_0x5a63eb(0x1b9)]+_0x5a63eb(0x179)]:_0x401d16[_0x5a63eb(0x1bd)],[constants_1[_0x5a63eb(0x1b9)]+_0x5a63eb(0x1c6)]:_0x401d16[_0x5a63eb(0x18f)],[constants_1[_0x5a63eb(0x1b9)]+'Component_Type__c']:_0x401d16[_0x5a63eb(0x1ba)],[constants_1['FLOSUM_NAMESPACE']+_0x5a63eb(0x183)]:_0x401d16[_0x5a63eb(0x18d)],[constants_1['FLOSUM_NAMESPACE']+_0x5a63eb(0x157)]:this[_0x5a63eb(0x174)],[constants_1['FLOSUM_NAMESPACE']+_0x5a63eb(0x156)]:this[_0x5a63eb(0x144)],[constants_1[_0x5a63eb(0x1b9)]+_0x5a63eb(0x17f)]:_0x2f046f[_0x5a63eb(0x1ae)]};});}async['saveDeploymentResults'](_0x2fd8ce){const _0x157f5c=a402_0x4cdb92;this[_0x157f5c(0x130)][_0x157f5c(0x148)](_0x157f5c(0x155));const _0x123597=await this[_0x157f5c(0x188)][_0x157f5c(0x18a)](constants_1[_0x157f5c(0x1b9)]+_0x157f5c(0x12b),_0x2fd8ce),_0xce02c0=_0x123597[_0x157f5c(0x131)](_0x3c7e30=>!_0x3c7e30[_0x157f5c(0x175)])[_0x157f5c(0x129)](_0x531d22=>_0x531d22[_0x157f5c(0x152)])[_0x157f5c(0x138)]();if(_0xce02c0[_0x157f5c(0x196)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0xce02c0);}async[a402_0x4cdb92(0x187)](_0x35004d){const _0x12e994=a402_0x4cdb92;this['_logger']['logError'](_0x35004d),await this[_0x12e994(0x130)]['updateLog'](),await this[_0x12e994(0x17d)](![],!![],'');}async[a402_0x4cdb92(0x17d)](_0x1cecbe,_0x59bbdd,_0x57723b){const _0x198103=a402_0x4cdb92,_0x14ad77=_0x198103(0x167)+this[_0x198103(0x192)]+'/'+this[_0x198103(0x144)]+'\x20>\x20'+_0x198103(0x19b)+_0x198103(0x182),_0x5d2af6=_0x198103(0x167)+this['_instanceUrl']+'/'+this[_0x198103(0x174)]+'\x20>'+this['_organisationName']+_0x198103(0x181),_0x35d68b=_0x14ad77+_0x198103(0x1c3)+_0x5d2af6+'\x20has\x20been\x20created.',_0xee9197={[constants_1[_0x198103(0x1b9)]+_0x198103(0x1c1)]:_0x35d68b,[constants_1['FLOSUM_NAMESPACE']+_0x198103(0x1b8)]:new Date(),[constants_1[_0x198103(0x1b9)]+_0x198103(0x16c)]:this[_0x198103(0x162)],[constants_1[_0x198103(0x1b9)]+_0x198103(0x184)]:_0x198103(0x158),[constants_1['FLOSUM_NAMESPACE']+_0x198103(0x128)]:_0x198103(0x185),[constants_1[_0x198103(0x1b9)]+'TargetId__c']:this[_0x198103(0x174)]},_0x4d4a30={[constants_1[_0x198103(0x1b9)]+_0x198103(0x159)]:!_0x1cecbe,[constants_1[_0x198103(0x1b9)]+'Succeed__c']:_0x1cecbe,[constants_1[_0x198103(0x1b9)]+_0x198103(0x1b4)]:_0x59bbdd?status_enums_1[_0x198103(0x16a)]['EXCEPTION']:status_enums_1[_0x198103(0x16a)][_0x198103(0x15b)],[constants_1[_0x198103(0x1b9)]+'Job_Completed__c']:!![],[constants_1[_0x198103(0x1b9)]+_0x198103(0x1c5)]:_0x57723b};await this[_0x198103(0x15c)][_0x198103(0x139)](flosum_constants_1['FlosumConstants'][_0x198103(0x1aa)]+'/'+constants_1[_0x198103(0x1b9)]+'Metadata_Log__c/'+this[_0x198103(0x144)],_0x4d4a30),await this[_0x198103(0x15c)][_0x198103(0x1b1)](flosum_constants_1[_0x198103(0x1ab)][_0x198103(0x1aa)]+'/'+constants_1[_0x198103(0x1b9)]+_0x198103(0x143),_0xee9197),this[_0x198103(0x130)]['log'](_0x198103(0x1b6)+(_0x1cecbe?'successfully':'with\x20error')+'.'),await this[_0x198103(0x130)][_0x198103(0x172)]();}}exports[a402_0x4cdb92(0x189)]=DeployService;