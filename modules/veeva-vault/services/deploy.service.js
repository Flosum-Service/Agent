const a334_0xd906a4=a334_0x3f5b;(function(_0x4c6e3c,_0x71301d){const _0x4124ed=a334_0x3f5b,_0x46af1d=_0x4c6e3c();while(!![]){try{const _0x530587=parseInt(_0x4124ed(0x1bf))/0x1*(parseInt(_0x4124ed(0x1ea))/0x2)+-parseInt(_0x4124ed(0x195))/0x3*(parseInt(_0x4124ed(0x145))/0x4)+parseInt(_0x4124ed(0x1e4))/0x5+parseInt(_0x4124ed(0x192))/0x6*(parseInt(_0x4124ed(0x16a))/0x7)+-parseInt(_0x4124ed(0x154))/0x8+parseInt(_0x4124ed(0x1e7))/0x9+-parseInt(_0x4124ed(0x1d8))/0xa*(-parseInt(_0x4124ed(0x15d))/0xb);if(_0x530587===_0x71301d)break;else _0x46af1d['push'](_0x46af1d['shift']());}catch(_0x3dee24){_0x46af1d['push'](_0x46af1d['shift']());}}}(a334_0x1dd6,0x822f0));function a334_0x3f5b(_0xf479da,_0x2a9e2a){const _0x182aa3=a334_0x1dd6();return a334_0x3f5b=function(_0x37fe06,_0x3cf582){_0x37fe06=_0x37fe06-0x134;let _0x1dd631=_0x182aa3[_0x37fe06];return _0x1dd631;},a334_0x3f5b(_0xf479da,_0x2a9e2a);}const a334_0x3cf582=(function(){let _0x4eccb3=!![];return function(_0x72cf39,_0x26bc9c){const _0x258ac5=_0x4eccb3?function(){const _0x572d7d=a334_0x3f5b;if(_0x26bc9c){const _0x4db752=_0x26bc9c[_0x572d7d(0x1af)](_0x72cf39,arguments);return _0x26bc9c=null,_0x4db752;}}:function(){};return _0x4eccb3=![],_0x258ac5;};}()),a334_0x37fe06=a334_0x3cf582(this,function(){const _0x18c272=a334_0x3f5b;return a334_0x37fe06[_0x18c272(0x139)]()['search'](_0x18c272(0x1b2))[_0x18c272(0x139)]()[_0x18c272(0x1c2)](a334_0x37fe06)[_0x18c272(0x1d4)](_0x18c272(0x1b2));});a334_0x37fe06();'use strict';var __importDefault=this&&this[a334_0xd906a4(0x1d9)]||function(_0x12bcd3){const _0x51f40c=a334_0xd906a4;return _0x12bcd3&&_0x12bcd3[_0x51f40c(0x185)]?_0x12bcd3:{'default':_0x12bcd3};};Object[a334_0xd906a4(0x1ac)](exports,a334_0xd906a4(0x185),{'value':!![]}),exports[a334_0xd906a4(0x174)]=void 0x0;const jszip_1=__importDefault(require(a334_0xd906a4(0x169))),promises_1=require(a334_0xd906a4(0x19d)),constants_1=require(a334_0xd906a4(0x1da)),flosum_constants_1=require(a334_0xd906a4(0x14c)),veeva_service_1=require(a334_0xd906a4(0x165)),salesforce_service_1=require(a334_0xd906a4(0x1aa)),core_1=require(a334_0xd906a4(0x1d5)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a334_0xd906a4(0x1c0)),shortid_1=__importDefault(require(a334_0xd906a4(0x157))),xml2js_1=require(a334_0xd906a4(0x155)),fetch_attachments_1=require(a334_0xd906a4(0x18a)),package_import_service_1=require(a334_0xd906a4(0x19f)),branch_component_history_flosum_component_retriever_1=require(a334_0xd906a4(0x1ce)),flosum_component_veeva_component_retriever_1=require(a334_0xd906a4(0x1c6)),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a334_0xd906a4(0x13b));function a334_0x1dd6(){const _0x9693bf=['finishDeploy','metadataLogId','./veeva.service','Create\x20vpk\x20package','branchId','logError','jszip','70uqFhMH','Deployment','execute','vaultpackage.xml','_salesforceService','Veeva_Step_Name__c','packageComponentList','Action__c','FlosumConstants','_logger','DeployService','file','length','_veevaService','DEPLOYED','createBackup','\x20>\x20','type','_instanceUrl','Component_Type__c','.zip','organisationName','MetadataLogStatus','post','from','retrieve','joinAllAttachments','__esModule','filter','Component_Name__c','has','Cannot\x20Backup\x20more\x20than\x20200\x20components.','../../shared/utils/fetch-attachments','ENDPOINT_UPSERT_RECORD','Activity_Type__c','base64','_vpkService','/Attachment','Backup','PackageImportService','182298uzCYvx','Succeed__c','_attachmentLogId','276aWzCqp','null','attachmentLogId','getFlosumComponents','Builder','_metadataLogId','BACKUP_ZIP_NAME','organisationId','fs/promises','componentHistoryId','./package-import.service','errors','deploymentName','</a>','generateAsync','_packageImportService','saveDeploymentResults','componentType','buildObject','Result__c','packageId','./salesforce.service','Deployment_Result__c','defineProperty','fetchAttachmentsDetailsByParentId','Retrieving\x20components','apply','_connectionVeeva','patch','(((.+)+)+)+$','Log__c','status','import','TargetId__c','stepName','with\x20error','formFlosumDeploymentResults','_componentIdList','saveLog','success','_organisationName','timeZone','69383gsQTfi','../classes/errors/salesforce-dml-error','migration__v','constructor','Branch__c','veeva-deploy','SalesforceDmlError','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','FLOSUM_NAMESPACE','Component_History__c','Flosum','_packageExportService','Retrieving\x20attachments','_branchId','componentIdList','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','Logger','values','PackageComponentStatus','Deploy\x20completed\x20','FlosumComponentVeevaComponentRetriever','search','../../../core','reduce','PackageExportService','10TwZdrm','__importDefault','../../../constants','Date__c','retrieveAttachments','BranchComponentHistoryFlosumComponentRetriever','finishDeployWithError','createVpk','log','componentName','<a\x20href=','error','24240Txshlf','_systemLogger','_organisationId','6930432YsGXoq','bind','Join\x20all\x20mdl\x20into\x20one\x20zip','2cyvipm','Activity_Item__c','Veeva\x20Deployment','loadAsync','_deploymentName','writeFile','string','\x20has\x20been\x20created.','COMPLETED','updateLog','deploymentAction','toString','Body','./vpk.service','Success','map','toLowerCase','/vpk__','name','Cannot\x20retrievers\x20all\x20attachments','Metadata_Log__c/','files','Save\x20log','33260yzMUdJ','Metadata_Log__c','Status__c','flat','default','_timeZone','VeevaService','../constants/flosum.constants','_connectionSalesforce','successfully','Failure','Save\x20Deployment\x20Results','Is_Error__c','_tempFolder','SalesforceService','3161840uiAPuM','xml2js','Save\x20Backup\x20to\x20Salesforce','shortid','Type__c','EXCEPTION','slice','Branch','Org__c','5998663RbzkHn','VpkService','Async_Request_Id__c','text/plain','validate','Form\x20Deployment\x20Results'];a334_0x1dd6=function(){return _0x9693bf;};return a334_0x1dd6();}class DeployService{constructor(_0x38dcee,_0x4fd489,_0x1eae5,_0xe16f2,_0x35e65f,_0x336497){const _0x567a03=a334_0xd906a4;this['_connectionSalesforce']=_0x4fd489,this[_0x567a03(0x1b0)]=_0x1eae5,this[_0x567a03(0x173)]=_0xe16f2,this[_0x567a03(0x152)]=_0x35e65f,this[_0x567a03(0x17c)]=_0x336497,this['_branchId']=_0x38dcee[_0x567a03(0x167)],this['_metadataLogId']=_0x38dcee[_0x567a03(0x164)],this[_0x567a03(0x194)]=_0x38dcee[_0x567a03(0x197)],this[_0x567a03(0x1e6)]=_0x38dcee[_0x567a03(0x19c)],this[_0x567a03(0x14a)]=_0x38dcee[_0x567a03(0x1be)],this[_0x567a03(0x1bd)]=_0x38dcee[_0x567a03(0x17f)],this[_0x567a03(0x1ba)]=_0x38dcee[_0x567a03(0x1cd)],this[_0x567a03(0x1ee)]=_0x38dcee[_0x567a03(0x1a1)],this[_0x567a03(0x1e5)]=new core_1[(_0x567a03(0x1cf))](_0x567a03(0x1c4)),this['_veevaService']=new veeva_service_1[(_0x567a03(0x14b))]({'connection':this[_0x567a03(0x1b0)],'logger':this[_0x567a03(0x173)]}),this[_0x567a03(0x16e)]=new salesforce_service_1[(_0x567a03(0x153))]({'connection':this[_0x567a03(0x14d)]}),this[_0x567a03(0x1a4)]=new package_import_service_1[(_0x567a03(0x191))]({'veevaService':this[_0x567a03(0x177)],'connection':this[_0x567a03(0x1b0)],'logger':this[_0x567a03(0x173)],'saveLog':this[_0x567a03(0x1bb)][_0x567a03(0x1e8)](this)}),this[_0x567a03(0x1ca)]=new package_export_service_1[(_0x567a03(0x1d7))]({'veevaService':this[_0x567a03(0x177)],'connection':this['_connectionVeeva'],'logger':this[_0x567a03(0x173)]}),this[_0x567a03(0x18e)]=new vpk_service_1[(_0x567a03(0x15e))]({'connection':this[_0x567a03(0x1b0)]});}async[a334_0xd906a4(0x16c)](){const _0x2dc997=a334_0xd906a4;try{const _0x410b10=await this[_0x2dc997(0x198)]();await this[_0x2dc997(0x173)][_0x2dc997(0x137)](),await this[_0x2dc997(0x179)](_0x410b10);const _0x23caec=await this['retrieveAttachments'](_0x410b10),_0x46ef39=await this[_0x2dc997(0x184)](_0x23caec),_0x8047f4=await this[_0x2dc997(0x1df)](_0x46ef39);await this['_logger'][_0x2dc997(0x137)]();const _0x54a6f4=await this[_0x2dc997(0x1a4)][_0x2dc997(0x1b5)](_0x8047f4);await this[_0x2dc997(0x173)][_0x2dc997(0x137)]();const _0x468876=this['formFlosumDeploymentResults'](_0x410b10,_0x54a6f4[_0x2dc997(0x170)]);await this[_0x2dc997(0x1a5)](_0x468876),await this[_0x2dc997(0x163)](_0x54a6f4['isDeployed'],![],_0x54a6f4[_0x2dc997(0x1a9)]);}catch(_0x4b9228){await this['finishDeployWithError'](_0x4b9228)['catch'](_0xe6bbfd=>this['_systemLogger'][_0x2dc997(0x1e3)](_0xe6bbfd));}}async[a334_0xd906a4(0x198)](){const _0x4ea745=a334_0xd906a4,_0x23a429=new Set(this[_0x4ea745(0x1ba)]);this[_0x4ea745(0x173)][_0x4ea745(0x1e0)](_0x4ea745(0x1ae));const _0x3e95bf=await new branch_component_history_flosum_component_retriever_1[(_0x4ea745(0x1dd))]({'value':this[_0x4ea745(0x1cc)],'salesforceService':this[_0x4ea745(0x16e)]})[_0x4ea745(0x183)](),_0x5e1ae6=_0x3e95bf['filter'](_0x14bcde=>_0x23a429[_0x4ea745(0x188)](_0x14bcde['id']));if(_0x5e1ae6[_0x4ea745(0x176)]!==this[_0x4ea745(0x1ba)][_0x4ea745(0x176)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x5e1ae6;}async[a334_0xd906a4(0x179)](_0x17a1de){const _0x155c4d=a334_0xd906a4;var _0x58274a;this[_0x155c4d(0x173)][_0x155c4d(0x1e0)]('Create\x20Backup');const _0x41a101=await new flosum_component_veeva_component_retriever_1[(_0x155c4d(0x1d3))]({'value':_0x17a1de,'veevaService':this[_0x155c4d(0x177)],'logger':this[_0x155c4d(0x173)]})[_0x155c4d(0x183)](),_0x588690=await this[_0x155c4d(0x1ca)]['export'](_0x41a101,_0x155c4d(0x190));if(_0x588690[_0x155c4d(0x176)]>0x1)throw new Error(_0x155c4d(0x189));(_0x58274a=_0x588690[0x0])!==null&&_0x58274a!==void 0x0?_0x58274a:_0x588690[0x0]=new jszip_1['default']();const _0x11f99c=await _0x588690[0x0][_0x155c4d(0x1a3)]({'type':_0x155c4d(0x18d)});this['_logger']['log'](_0x155c4d(0x156));const _0x5b3056={'Body':_0x11f99c,'ContentType':'application/zip','ParentId':this[_0x155c4d(0x19a)],'Name':flosum_constants_1[_0x155c4d(0x172)][_0x155c4d(0x19b)]};await this[_0x155c4d(0x14d)][_0x155c4d(0x181)](flosum_constants_1[_0x155c4d(0x172)][_0x155c4d(0x18b)]+_0x155c4d(0x18f),_0x5b3056),this[_0x155c4d(0x173)][_0x155c4d(0x1e0)]('Finish\x20Create\x20Backup');}async[a334_0xd906a4(0x1dc)](_0x3d354a){const _0x390b04=a334_0xd906a4;this[_0x390b04(0x173)][_0x390b04(0x1e0)](_0x390b04(0x1cb));const _0x2f06f9=await(0x0,fetch_attachments_1[_0x390b04(0x1ad)])(this[_0x390b04(0x14d)],_0x3d354a[_0x390b04(0x13d)](_0x44490a=>_0x44490a[_0x390b04(0x19e)])),_0x40cf16=await(0x0,fetch_attachments_1[_0x390b04(0x1dc)])(_0x2f06f9,this['_connectionSalesforce']);if(_0x40cf16['length']!==this['_componentIdList'][_0x390b04(0x176)])throw new Error(_0x390b04(0x141));return _0x40cf16[_0x390b04(0x13d)](_0xad6cb4=>_0xad6cb4[_0x390b04(0x1d0)][_0x390b04(0x13a)]);}async['joinAllAttachments'](_0x4bfaeb){const _0x13c1fc=a334_0xd906a4;var _0x12a86f;this[_0x13c1fc(0x173)][_0x13c1fc(0x1e0)](_0x13c1fc(0x1e9));const _0x55249f=new jszip_1[(_0x13c1fc(0x149))]();for(const _0x4dcdb2 of _0x4bfaeb){const _0xad3f6f=new jszip_1[(_0x13c1fc(0x149))]();await _0xad3f6f[_0x13c1fc(0x1ed)](_0x4dcdb2,{'base64':!![]});for(const _0x12beb6 in _0xad3f6f[_0x13c1fc(0x143)]){const _0x41bda7=await((_0x12a86f=_0xad3f6f[_0x13c1fc(0x175)](_0x12beb6))===null||_0x12a86f===void 0x0?void 0x0:_0x12a86f['async'](_0x13c1fc(0x134)));_0x41bda7&&_0x55249f[_0x13c1fc(0x175)](_0x12beb6,_0x41bda7);}}const _0x22c265=new xml2js_1[(_0x13c1fc(0x199))]({'headless':!![]}),_0xb1ae8c={'vaultpackage':{'$':{'xmlns':'https://veevavault.com/'},'name':this[_0x13c1fc(0x1ee)],'source':{'vault':undefined,'author':_0x13c1fc(0x1c9)},'packagetype':_0x13c1fc(0x1c1),'summary':'Deploy','description':_0x13c1fc(0x196)}};_0x55249f[_0x13c1fc(0x175)](_0x13c1fc(0x16d),_0x22c265[_0x13c1fc(0x1a7)](_0xb1ae8c));const _0x42e8b6=this[_0x13c1fc(0x152)]+'/'+(0x0,shortid_1[_0x13c1fc(0x149)])()+_0x13c1fc(0x17e),_0x383aaf=await _0x55249f[_0x13c1fc(0x1a3)]({'type':'nodebuffer'});return await(0x0,promises_1[_0x13c1fc(0x1ef)])(_0x42e8b6,_0x383aaf),_0x42e8b6;}async[a334_0xd906a4(0x1df)](_0x12620e){const _0x4ed27e=a334_0xd906a4;this[_0x4ed27e(0x173)]['log'](_0x4ed27e(0x166));const _0x243845=await this[_0x4ed27e(0x18e)]['generate'](_0x12620e),_0x2687ce=this[_0x4ed27e(0x152)]+_0x4ed27e(0x13f)+_0x12620e[_0x4ed27e(0x15a)](_0x12620e['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x4ed27e(0x1ef)])(_0x2687ce,_0x243845),await this['_vpkService'][_0x4ed27e(0x161)](_0x2687ce),_0x2687ce;}async[a334_0xd906a4(0x1bb)](_0x35f0d2,_0x1c4f6d){const _0x329ca5=a334_0xd906a4;this[_0x329ca5(0x173)][_0x329ca5(0x1e0)](_0x329ca5(0x144));const _0x5de9fe={'Body':Buffer[_0x329ca5(0x182)](_0x35f0d2)[_0x329ca5(0x139)](_0x329ca5(0x18d)),'ContentType':_0x329ca5(0x160),'ParentId':this[_0x329ca5(0x19a)],'Name':_0x1c4f6d};await this[_0x329ca5(0x14d)]['post'](flosum_constants_1[_0x329ca5(0x172)][_0x329ca5(0x18b)]+'/Attachment',_0x5de9fe);}[a334_0xd906a4(0x1b9)](_0x33c138,_0x467ed8){const _0x439486=a334_0xd906a4;this[_0x439486(0x173)][_0x439486(0x1e0)](_0x439486(0x162));const _0x5b71a7=_0x33c138[_0x439486(0x1d6)]((_0x2fcd0a,_0x762318)=>_0x2fcd0a['set']((_0x762318[_0x439486(0x1a6)]+'.'+_0x762318[_0x439486(0x1e1)])['toLowerCase'](),_0x762318),new Map());return _0x467ed8[_0x439486(0x13d)](_0x1c419d=>{const _0x9afe1a=_0x439486;this[_0x9afe1a(0x173)][_0x9afe1a(0x1e0)](_0x1c419d[_0x9afe1a(0x17b)]+'.'+_0x1c419d[_0x9afe1a(0x140)]+'\x20:\x20'+_0x1c419d['status']);const _0x5a0ea2=(_0x1c419d[_0x9afe1a(0x17b)]+'.'+_0x1c419d['name'])[_0x9afe1a(0x13e)](),_0x246461=_0x5b71a7['get'](_0x5a0ea2);return{[constants_1['FLOSUM_NAMESPACE']+_0x9afe1a(0x158)]:'Deployment\x20Result',[constants_1[_0x9afe1a(0x1c7)]+_0x9afe1a(0x147)]:_0x1c419d[_0x9afe1a(0x1b4)]===status_enums_1[_0x9afe1a(0x1d1)][_0x9afe1a(0x178)]?_0x9afe1a(0x13c):_0x9afe1a(0x14f),[constants_1[_0x9afe1a(0x1c7)]+_0x9afe1a(0x1a8)]:_0x1c419d[_0x9afe1a(0x138)],[constants_1[_0x9afe1a(0x1c7)]+_0x9afe1a(0x187)]:_0x1c419d[_0x9afe1a(0x140)],[constants_1['FLOSUM_NAMESPACE']+_0x9afe1a(0x17d)]:_0x1c419d[_0x9afe1a(0x17b)],[constants_1[_0x9afe1a(0x1c7)]+_0x9afe1a(0x16f)]:_0x1c419d[_0x9afe1a(0x1b7)],[constants_1['FLOSUM_NAMESPACE']+_0x9afe1a(0x15c)]:this[_0x9afe1a(0x1e6)],[constants_1[_0x9afe1a(0x1c7)]+_0x9afe1a(0x146)]:this[_0x9afe1a(0x19a)],[constants_1[_0x9afe1a(0x1c7)]+_0x9afe1a(0x1c8)]:_0x246461[_0x9afe1a(0x19e)]};});}async[a334_0xd906a4(0x1a5)](_0x133ee7){const _0x52656e=a334_0xd906a4;this['_logger'][_0x52656e(0x1e0)](_0x52656e(0x150));const _0x22eb13=await this['_salesforceService']['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+_0x52656e(0x1ab),_0x133ee7),_0x1ca2ad=_0x22eb13[_0x52656e(0x186)](_0x1f5466=>!_0x1f5466[_0x52656e(0x1bc)])['map'](_0x4bb094=>_0x4bb094[_0x52656e(0x1a0)])[_0x52656e(0x148)]();if(_0x1ca2ad[_0x52656e(0x176)])throw new salesforce_dml_error_1[(_0x52656e(0x1c5))](_0x1ca2ad);}async[a334_0xd906a4(0x1de)](_0x192b73){const _0x148fb1=a334_0xd906a4;this['_logger'][_0x148fb1(0x168)](_0x192b73),await this[_0x148fb1(0x173)][_0x148fb1(0x137)](),await this['finishDeploy'](![],!![],'');}async['finishDeploy'](_0x3adeb5,_0x72165,_0x562335){const _0xd49606=a334_0xd906a4,_0xd5ee25=_0xd49606(0x1e2)+this[_0xd49606(0x17c)]+'/'+this[_0xd49606(0x19a)]+_0xd49606(0x17a)+_0xd49606(0x1ec)+'\x20</a>',_0x4f07ab=_0xd49606(0x1e2)+this[_0xd49606(0x17c)]+'/'+this[_0xd49606(0x1e6)]+'\x20>'+this['_organisationName']+_0xd49606(0x1a2),_0x18ad43=_0xd5ee25+'\x20of\x20branch\x20to\x20Organization\x20'+_0x4f07ab+_0xd49606(0x135),_0x5bc209={[constants_1[_0xd49606(0x1c7)]+_0xd49606(0x171)]:_0x18ad43,[constants_1[_0xd49606(0x1c7)]+_0xd49606(0x1db)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0xd49606(0x1c3)]:this[_0xd49606(0x1cc)],[constants_1[_0xd49606(0x1c7)]+_0xd49606(0x1eb)]:_0xd49606(0x15b),[constants_1[_0xd49606(0x1c7)]+_0xd49606(0x18c)]:_0xd49606(0x16b),[constants_1[_0xd49606(0x1c7)]+_0xd49606(0x1b6)]:this[_0xd49606(0x1e6)]},_0x40ae6b={[constants_1['FLOSUM_NAMESPACE']+_0xd49606(0x151)]:!_0x3adeb5,[constants_1[_0xd49606(0x1c7)]+_0xd49606(0x193)]:_0x3adeb5,[constants_1[_0xd49606(0x1c7)]+_0xd49606(0x147)]:_0x72165?status_enums_1[_0xd49606(0x180)][_0xd49606(0x159)]:status_enums_1[_0xd49606(0x180)][_0xd49606(0x136)],[constants_1['FLOSUM_NAMESPACE']+'Job_Completed__c']:!![],[constants_1[_0xd49606(0x1c7)]+_0xd49606(0x15f)]:_0x562335};await this[_0xd49606(0x14d)][_0xd49606(0x1b1)](flosum_constants_1[_0xd49606(0x172)][_0xd49606(0x18b)]+'/'+constants_1[_0xd49606(0x1c7)]+_0xd49606(0x142)+this['_metadataLogId'],_0x40ae6b),await this['_connectionSalesforce'][_0xd49606(0x181)](flosum_constants_1['FlosumConstants'][_0xd49606(0x18b)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0xd49606(0x1b3),_0x5bc209),this[_0xd49606(0x173)]['log'](_0xd49606(0x1d2)+(_0x3adeb5?_0xd49606(0x14e):_0xd49606(0x1b8))+'.'),await this[_0xd49606(0x173)][_0xd49606(0x137)]();}}exports[a334_0xd906a4(0x174)]=DeployService;