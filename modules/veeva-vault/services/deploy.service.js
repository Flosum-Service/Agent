function a357_0x1673(_0x5adb7f,_0x128978){const _0x3f7616=a357_0x2389();return a357_0x1673=function(_0x3fe247,_0x3416d8){_0x3fe247=_0x3fe247-0x146;let _0x238921=_0x3f7616[_0x3fe247];return _0x238921;},a357_0x1673(_0x5adb7f,_0x128978);}const a357_0x4fce89=a357_0x1673;(function(_0x1e427e,_0x450bc4){const _0x40a9bd=a357_0x1673,_0x7a30a4=_0x1e427e();while(!![]){try{const _0x460616=-parseInt(_0x40a9bd(0x171))/0x1*(parseInt(_0x40a9bd(0x1c0))/0x2)+parseInt(_0x40a9bd(0x1d5))/0x3*(-parseInt(_0x40a9bd(0x173))/0x4)+parseInt(_0x40a9bd(0x185))/0x5*(parseInt(_0x40a9bd(0x1e4))/0x6)+parseInt(_0x40a9bd(0x169))/0x7+-parseInt(_0x40a9bd(0x15a))/0x8*(parseInt(_0x40a9bd(0x1c7))/0x9)+parseInt(_0x40a9bd(0x1ba))/0xa*(parseInt(_0x40a9bd(0x160))/0xb)+-parseInt(_0x40a9bd(0x188))/0xc*(-parseInt(_0x40a9bd(0x156))/0xd);if(_0x460616===_0x450bc4)break;else _0x7a30a4['push'](_0x7a30a4['shift']());}catch(_0x1f86e2){_0x7a30a4['push'](_0x7a30a4['shift']());}}}(a357_0x2389,0x83849));const a357_0x3416d8=(function(){let _0x56f729=!![];return function(_0x4f370c,_0x1b2ff0){const _0x26a7ed=_0x56f729?function(){if(_0x1b2ff0){const _0x2585fe=_0x1b2ff0['apply'](_0x4f370c,arguments);return _0x1b2ff0=null,_0x2585fe;}}:function(){};return _0x56f729=![],_0x26a7ed;};}()),a357_0x3fe247=a357_0x3416d8(this,function(){const _0x51469b=a357_0x1673;return a357_0x3fe247[_0x51469b(0x168)]()[_0x51469b(0x1cb)](_0x51469b(0x1b9))[_0x51469b(0x168)]()[_0x51469b(0x1b6)](a357_0x3fe247)['search'](_0x51469b(0x1b9));});a357_0x3fe247();function a357_0x2389(){const _0x2feda7=['lastIndexOf','_instanceUrl','Metadata_Log__c/','_veevaService','generateAsync','_salesforceService','bind','status','_deploymentName','Action__c','get','getFlosumComponents','patch','length','8946964StGERF','isDeployed','COMPLETED','catch','3342344jRdhWY','_logger','Metadata_Log__c','set','PackageImportService','Save\x20log','22UdPHGb','success','MetadataLogStatus','successfully','Veeva_Step_Name__c','./package-export.service','_tempFolder','./salesforce.service','toString','5732377bbzuss','fs/promises','../enums/status.enums','_organisationId','logError','FLOSUM_NAMESPACE','reduce','attachmentLogId','1ZrAjdh','shortid','9388CBMIPt','packageComponentList','export','Deployment_Result__c','\x20has\x20been\x20created.','Succeed__c','writeFile','./vpk.service','_connectionVeeva','createBackup','_timeZone','BACKUP_ZIP_NAME','_connectionSalesforce','has','PackageExportService','/vpk__','VeevaService','/Attachment','35sqVRqE','_vpkService','Deployment\x20Result','24jRvDKP','stepName','SalesforceDmlError','retrieve','.zip','Deployment','Log__c','_metadataLogId','Create\x20Backup','organisationName','createVpk','Body','organisationId','text/plain','log','toLowerCase','branchId','Activity_Type__c','Join\x20all\x20mdl\x20into\x20one\x20zip','TargetId__c','Logger','error','../../../constants','componentName','Branch__c','__importDefault','Retrieving\x20components','_branchId','metadataLogId','errors','application/zip','Date__c','componentHistoryId','_packageImportService','createZip','Job_Completed__c','updateLog','filter','FlosumComponentVeevaComponentRetriever','EXCEPTION','PackageComponentStatus','\x20of\x20branch\x20to\x20Organization\x20','_organisationName','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','DEPLOYED','_componentIdList','constructor','\x20</a>','map','(((.+)+)+)+$','763310bMAKQm','FlosumConstants','Activity_Item__c','generate','<a\x20href=','Save\x20Backup\x20to\x20Salesforce','1952002IgRbIF','componentIdList','veeva-deploy','saveLog','finishDeployWithError','Save\x20Deployment\x20Results','retrieveAttachments','9BgmVqw','from','type','Component_Name__c','search','Type__c','ZipCreatorDeploy','../constants/flosum.constants','insertMultipleRecords','base64','name','Branch','validate','Component_History__c','615iORxhI','</a>','DeployService','post','finishDeploy','packageId','fetchAttachmentsDetailsByParentId','saveDeploymentResults','Cannot\x20retrieve\x20all\x20components.','Is_Error__c','import','Status__c','\x20>\x20','BranchComponentHistoryFlosumComponentRetriever','Cannot\x20Backup\x20more\x20than\x20200\x20components.','56226PBHOFf','_systemLogger','Retrieving\x20attachments','Org__c','SalesforceService','__esModule','Result__c','ENDPOINT_UPSERT_RECORD','saveBackup','\x20:\x20','deploymentAction','values','execute','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'];a357_0x2389=function(){return _0x2feda7;};return a357_0x2389();}'use strict';var __importDefault=this&&this[a357_0x4fce89(0x1a1)]||function(_0x12b3d1){const _0x5c01c=a357_0x4fce89;return _0x12b3d1&&_0x12b3d1[_0x5c01c(0x1e9)]?_0x12b3d1:{'default':_0x12b3d1};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a357_0x4fce89(0x1d7)]=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a357_0x4fce89(0x16a)),constants_1=require(a357_0x4fce89(0x19e)),flosum_constants_1=require(a357_0x4fce89(0x1ce)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a357_0x4fce89(0x167)),core_1=require('../../../core'),status_enums_1=require(a357_0x4fce89(0x16b)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),shortid_1=__importDefault(require(a357_0x4fce89(0x172))),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),package_import_service_1=require('./package-import.service'),branch_component_history_flosum_component_retriever_1=require(a357_0x4fce89(0x1b3)),flosum_component_veeva_component_retriever_1=require(a357_0x4fce89(0x147)),package_export_service_1=require(a357_0x4fce89(0x165)),vpk_service_1=require(a357_0x4fce89(0x17a)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x405820,_0x538e2f,_0x52a1b3,_0x3c6078,_0x4e22e9,_0x4f6abd){const _0x2bc64f=a357_0x4fce89;this[_0x2bc64f(0x17f)]=_0x538e2f,this['_connectionVeeva']=_0x52a1b3,this['_logger']=_0x3c6078,this[_0x2bc64f(0x166)]=_0x4e22e9,this[_0x2bc64f(0x149)]=_0x4f6abd,this[_0x2bc64f(0x1a3)]=_0x405820[_0x2bc64f(0x198)],this[_0x2bc64f(0x18f)]=_0x405820[_0x2bc64f(0x1a4)],this['_attachmentLogId']=_0x405820[_0x2bc64f(0x170)],this[_0x2bc64f(0x16c)]=_0x405820[_0x2bc64f(0x194)],this[_0x2bc64f(0x17d)]=_0x405820['timeZone'],this[_0x2bc64f(0x1b2)]=_0x405820[_0x2bc64f(0x191)],this['_componentIdList']=_0x405820[_0x2bc64f(0x1c1)],this[_0x2bc64f(0x150)]=_0x405820['deploymentName'],this[_0x2bc64f(0x1e5)]=new core_1[(_0x2bc64f(0x19c))](_0x2bc64f(0x1c2)),this[_0x2bc64f(0x14b)]=new veeva_service_1[(_0x2bc64f(0x183))]({'connection':this[_0x2bc64f(0x17b)],'logger':this[_0x2bc64f(0x15b)]}),this[_0x2bc64f(0x14d)]=new salesforce_service_1[(_0x2bc64f(0x1e8))]({'connection':this[_0x2bc64f(0x17f)]}),this[_0x2bc64f(0x1a9)]=new package_import_service_1[(_0x2bc64f(0x15e))]({'veevaService':this[_0x2bc64f(0x14b)],'connection':this[_0x2bc64f(0x17b)],'logger':this[_0x2bc64f(0x15b)],'saveLog':this[_0x2bc64f(0x1c3)][_0x2bc64f(0x14e)](this)}),this['_packageExportService']=new package_export_service_1[(_0x2bc64f(0x181))]({'veevaService':this[_0x2bc64f(0x14b)],'connection':this[_0x2bc64f(0x17b)],'logger':this[_0x2bc64f(0x15b)]}),this[_0x2bc64f(0x186)]=new vpk_service_1['VpkService']({'connection':this['_connectionVeeva']});}async[a357_0x4fce89(0x146)](){const _0xb682be=a357_0x4fce89;try{const _0xc9f05e=await this[_0xb682be(0x153)]();await this[_0xb682be(0x15b)][_0xb682be(0x1ac)]();const _0x366815=await this[_0xb682be(0x17c)](_0xc9f05e);await this[_0xb682be(0x1ec)](_0x366815);const _0x118e67=await this['retrieveAttachments'](_0xc9f05e),_0x4a8633=await this[_0xb682be(0x1aa)](_0x118e67),_0x234d7a=await this[_0xb682be(0x192)](_0x4a8633);await this[_0xb682be(0x15b)][_0xb682be(0x1ac)]();const _0x417e8d=await this[_0xb682be(0x1a9)][_0xb682be(0x1df)](_0x234d7a);await this[_0xb682be(0x15b)][_0xb682be(0x1ac)]();const _0x5a3aec=this['formFlosumDeploymentResults'](_0xc9f05e,_0x417e8d[_0xb682be(0x174)]);await this['saveDeploymentResults'](_0x5a3aec),await this[_0xb682be(0x1d9)](_0x417e8d[_0xb682be(0x157)],![],_0x417e8d[_0xb682be(0x1da)]);}catch(_0x583664){await this[_0xb682be(0x1c4)](_0x583664)[_0xb682be(0x159)](_0x1028e4=>this[_0xb682be(0x1e5)][_0xb682be(0x19d)](_0x1028e4));}}async['getFlosumComponents'](){const _0x3aa51d=a357_0x4fce89,_0x2e8463=new Set(this[_0x3aa51d(0x1b5)]);this[_0x3aa51d(0x15b)][_0x3aa51d(0x196)](_0x3aa51d(0x1a2));const _0x2706a5=await new branch_component_history_flosum_component_retriever_1[(_0x3aa51d(0x1e2))]({'value':this['_branchId'],'salesforceService':this[_0x3aa51d(0x14d)]})[_0x3aa51d(0x18b)](),_0x377867=_0x2706a5[_0x3aa51d(0x1ad)](_0x4aaf0e=>_0x2e8463[_0x3aa51d(0x180)](_0x4aaf0e['id']));if(_0x377867[_0x3aa51d(0x155)]!==this[_0x3aa51d(0x1b5)][_0x3aa51d(0x155)])throw new Error(_0x3aa51d(0x1dd));return _0x377867;}async['createBackup'](_0xab5b63){const _0x589b59=a357_0x4fce89;var _0x3cb447;this[_0x589b59(0x15b)][_0x589b59(0x196)](_0x589b59(0x190));const _0xa5fe80=await new flosum_component_veeva_component_retriever_1[(_0x589b59(0x1ae))]({'value':_0xab5b63,'veevaService':this[_0x589b59(0x14b)],'logger':this['_logger']})['retrieve'](),_0x1bf8b2=await this['_packageExportService'][_0x589b59(0x175)](_0xa5fe80,'Backup');if(_0x1bf8b2['length']>0x1)throw new Error(_0x589b59(0x1e3));return(_0x3cb447=_0x1bf8b2[0x0])!==null&&_0x3cb447!==void 0x0?_0x3cb447:_0x1bf8b2[0x0]=new jszip_1['default'](),_0x1bf8b2[0x0][_0x589b59(0x14c)]({'type':_0x589b59(0x1d0)});}async[a357_0x4fce89(0x1ec)](_0x34c9fe){const _0x365003=a357_0x4fce89;this[_0x365003(0x15b)][_0x365003(0x196)](_0x365003(0x1bf));const _0x541c22={'Body':_0x34c9fe,'ContentType':_0x365003(0x1a6),'ParentId':this[_0x365003(0x18f)],'Name':flosum_constants_1[_0x365003(0x1bb)][_0x365003(0x17e)]};await this[_0x365003(0x17f)]['post'](flosum_constants_1['FlosumConstants'][_0x365003(0x1eb)]+_0x365003(0x184),_0x541c22);}async[a357_0x4fce89(0x1c6)](_0x15cd66){const _0x1e5eb1=a357_0x4fce89;this[_0x1e5eb1(0x15b)][_0x1e5eb1(0x196)](_0x1e5eb1(0x1e6));const _0x5c3ec1=await(0x0,fetch_attachments_1[_0x1e5eb1(0x1db)])(this[_0x1e5eb1(0x17f)],_0x15cd66[_0x1e5eb1(0x1b8)](_0x39e94e=>_0x39e94e[_0x1e5eb1(0x1a8)])),_0x1bd46e=await(0x0,fetch_attachments_1[_0x1e5eb1(0x1c6)])(_0x5c3ec1,this[_0x1e5eb1(0x17f)]);if(_0x1bd46e[_0x1e5eb1(0x155)]!==this[_0x1e5eb1(0x1b5)][_0x1e5eb1(0x155)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x1bd46e[_0x1e5eb1(0x1b8)](_0x583186=>_0x583186[_0x1e5eb1(0x1ef)][_0x1e5eb1(0x193)]);}async[a357_0x4fce89(0x1aa)](_0x7f083f){const _0x4c0075=a357_0x4fce89;this[_0x4c0075(0x15b)][_0x4c0075(0x196)](_0x4c0075(0x19a));const _0x324776=await new zip_creator_deploy_1[(_0x4c0075(0x1cd))]({'attachmentBodies':_0x7f083f,'deploymentName':this['_deploymentName']})[_0x4c0075(0x146)](),_0xf358d6=this[_0x4c0075(0x166)]+'/'+(0x0,shortid_1['default'])()+_0x4c0075(0x18c);return await(0x0,promises_1[_0x4c0075(0x179)])(_0xf358d6,_0x324776),_0xf358d6;}async[a357_0x4fce89(0x192)](_0x1eb239){const _0x3b354f=a357_0x4fce89;this[_0x3b354f(0x15b)][_0x3b354f(0x196)]('Create\x20vpk\x20package');const _0x4a71c0=await this[_0x3b354f(0x186)][_0x3b354f(0x1bd)](_0x1eb239),_0x42d847=this['_tempFolder']+_0x3b354f(0x182)+_0x1eb239['slice'](_0x1eb239[_0x3b354f(0x148)]('/')+0x1);return await(0x0,promises_1[_0x3b354f(0x179)])(_0x42d847,_0x4a71c0),await this[_0x3b354f(0x186)][_0x3b354f(0x1d3)](_0x42d847),_0x42d847;}async[a357_0x4fce89(0x1c3)](_0x1f22c7,_0x599f53){const _0x28fc52=a357_0x4fce89;this['_logger'][_0x28fc52(0x196)](_0x28fc52(0x15f));const _0x5256d7={'Body':Buffer[_0x28fc52(0x1c8)](_0x1f22c7)['toString'](_0x28fc52(0x1d0)),'ContentType':_0x28fc52(0x195),'ParentId':this['_metadataLogId'],'Name':_0x599f53};await this['_connectionSalesforce']['post'](flosum_constants_1['FlosumConstants'][_0x28fc52(0x1eb)]+_0x28fc52(0x184),_0x5256d7);}['formFlosumDeploymentResults'](_0x9d3a05,_0x248972){const _0x4b0545=a357_0x4fce89;this['_logger']['log']('Form\x20Deployment\x20Results');const _0x5b8139=_0x9d3a05[_0x4b0545(0x16f)]((_0x5784ab,_0x21b7da)=>_0x5784ab[_0x4b0545(0x15d)]((_0x21b7da['componentType']+'.'+_0x21b7da[_0x4b0545(0x19f)])[_0x4b0545(0x197)](),_0x21b7da),new Map());return _0x248972['map'](_0x36ea88=>{const _0x4b20cf=_0x4b0545;this['_logger'][_0x4b20cf(0x196)](_0x36ea88[_0x4b20cf(0x1c9)]+'.'+_0x36ea88[_0x4b20cf(0x1d1)]+_0x4b20cf(0x1ed)+_0x36ea88[_0x4b20cf(0x14f)]);const _0x4da22c=(_0x36ea88[_0x4b20cf(0x1c9)]+'.'+_0x36ea88[_0x4b20cf(0x1d1)])[_0x4b20cf(0x197)](),_0x2016d8=_0x5b8139[_0x4b20cf(0x152)](_0x4da22c);return{[constants_1['FLOSUM_NAMESPACE']+_0x4b20cf(0x1cc)]:_0x4b20cf(0x187),[constants_1['FLOSUM_NAMESPACE']+_0x4b20cf(0x1e0)]:_0x36ea88[_0x4b20cf(0x14f)]===status_enums_1[_0x4b20cf(0x1b0)][_0x4b20cf(0x1b4)]?'Success':'Failure',[constants_1['FLOSUM_NAMESPACE']+_0x4b20cf(0x1ea)]:_0x36ea88[_0x4b20cf(0x1ee)],[constants_1['FLOSUM_NAMESPACE']+_0x4b20cf(0x1ca)]:_0x36ea88['name'],[constants_1[_0x4b20cf(0x16e)]+'Component_Type__c']:_0x36ea88['type'],[constants_1[_0x4b20cf(0x16e)]+_0x4b20cf(0x164)]:_0x36ea88[_0x4b20cf(0x189)],[constants_1[_0x4b20cf(0x16e)]+_0x4b20cf(0x1e7)]:this[_0x4b20cf(0x16c)],[constants_1['FLOSUM_NAMESPACE']+_0x4b20cf(0x15c)]:this[_0x4b20cf(0x18f)],[constants_1[_0x4b20cf(0x16e)]+_0x4b20cf(0x1d4)]:_0x2016d8['componentHistoryId']};});}async[a357_0x4fce89(0x1dc)](_0x218cd9){const _0x49c1da=a357_0x4fce89;this[_0x49c1da(0x15b)][_0x49c1da(0x196)](_0x49c1da(0x1c5));const _0x82e8c=await this[_0x49c1da(0x14d)][_0x49c1da(0x1cf)](constants_1['FLOSUM_NAMESPACE']+_0x49c1da(0x176),_0x218cd9),_0x30df51=_0x82e8c[_0x49c1da(0x1ad)](_0x5d0bff=>!_0x5d0bff[_0x49c1da(0x161)])['map'](_0x18b4b6=>_0x18b4b6[_0x49c1da(0x1a5)])['flat']();if(_0x30df51[_0x49c1da(0x155)])throw new salesforce_dml_error_1[(_0x49c1da(0x18a))](_0x30df51);}async[a357_0x4fce89(0x1c4)](_0x525ed5){const _0x140bf3=a357_0x4fce89;this[_0x140bf3(0x15b)][_0x140bf3(0x16d)](_0x525ed5),await this[_0x140bf3(0x15b)]['updateLog'](),await this['finishDeploy'](![],!![],'');}async[a357_0x4fce89(0x1d9)](_0x370846,_0x1f71ed,_0x35cc47){const _0x5897f6=a357_0x4fce89,_0x489b64=_0x5897f6(0x1be)+this[_0x5897f6(0x149)]+'/'+this[_0x5897f6(0x18f)]+_0x5897f6(0x1e1)+'Veeva\x20Deployment'+_0x5897f6(0x1b7),_0x5ac30e=_0x5897f6(0x1be)+this[_0x5897f6(0x149)]+'/'+this['_organisationId']+'\x20>'+this[_0x5897f6(0x1b2)]+_0x5897f6(0x1d6),_0x1fce63=_0x489b64+_0x5897f6(0x1b1)+_0x5ac30e+_0x5897f6(0x177),_0x48b356={[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x151)]:_0x1fce63,[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x1a7)]:new Date(),[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x1a0)]:this[_0x5897f6(0x1a3)],[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x1bc)]:_0x5897f6(0x1d2),[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x199)]:_0x5897f6(0x18d),[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x19b)]:this[_0x5897f6(0x16c)]},_0x20fde0={[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x1de)]:!_0x370846,[constants_1['FLOSUM_NAMESPACE']+_0x5897f6(0x178)]:_0x370846,[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x1e0)]:_0x1f71ed?status_enums_1[_0x5897f6(0x162)][_0x5897f6(0x1af)]:status_enums_1[_0x5897f6(0x162)][_0x5897f6(0x158)],[constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x1ab)]:!![],[constants_1[_0x5897f6(0x16e)]+'Async_Request_Id__c']:_0x35cc47};await this[_0x5897f6(0x17f)][_0x5897f6(0x154)](flosum_constants_1[_0x5897f6(0x1bb)][_0x5897f6(0x1eb)]+'/'+constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x14a)+this[_0x5897f6(0x18f)],_0x20fde0),await this[_0x5897f6(0x17f)][_0x5897f6(0x1d8)](flosum_constants_1[_0x5897f6(0x1bb)][_0x5897f6(0x1eb)]+'/'+constants_1[_0x5897f6(0x16e)]+_0x5897f6(0x18e),_0x48b356),this[_0x5897f6(0x15b)][_0x5897f6(0x196)]('Deploy\x20completed\x20'+(_0x370846?_0x5897f6(0x163):'with\x20error')+'.'),await this[_0x5897f6(0x15b)][_0x5897f6(0x1ac)]();}}exports['DeployService']=DeployService;