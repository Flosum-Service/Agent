const a358_0x2ae4bc=a358_0x1323;(function(_0x91eaea,_0x18e6c9){const _0x118efd=a358_0x1323,_0x3b81e9=_0x91eaea();while(!![]){try{const _0x17bba7=parseInt(_0x118efd(0xdb))/0x1+-parseInt(_0x118efd(0x12e))/0x2*(-parseInt(_0x118efd(0x110))/0x3)+-parseInt(_0x118efd(0x10c))/0x4+-parseInt(_0x118efd(0xf1))/0x5*(-parseInt(_0x118efd(0x146))/0x6)+parseInt(_0x118efd(0x15d))/0x7*(parseInt(_0x118efd(0xe8))/0x8)+-parseInt(_0x118efd(0x15b))/0x9+parseInt(_0x118efd(0xc6))/0xa*(-parseInt(_0x118efd(0x112))/0xb);if(_0x17bba7===_0x18e6c9)break;else _0x3b81e9['push'](_0x3b81e9['shift']());}catch(_0x397817){_0x3b81e9['push'](_0x3b81e9['shift']());}}}(a358_0x1007,0x621b5));const a358_0x867d9f=(function(){let _0x58cf1b=!![];return function(_0x5b9308,_0x54c4d0){const _0x5863f0=_0x58cf1b?function(){const _0x41703d=a358_0x1323;if(_0x54c4d0){const _0x5be217=_0x54c4d0[_0x41703d(0x121)](_0x5b9308,arguments);return _0x54c4d0=null,_0x5be217;}}:function(){};return _0x58cf1b=![],_0x5863f0;};}()),a358_0x26ecdf=a358_0x867d9f(this,function(){const _0x2f6c02=a358_0x1323;return a358_0x26ecdf[_0x2f6c02(0xcb)]()[_0x2f6c02(0x158)](_0x2f6c02(0x108))[_0x2f6c02(0xcb)]()[_0x2f6c02(0x120)](a358_0x26ecdf)[_0x2f6c02(0x158)](_0x2f6c02(0x108));});a358_0x26ecdf();'use strict';var __importDefault=this&&this[a358_0x2ae4bc(0xf4)]||function(_0x5068a9){const _0x56d773=a358_0x2ae4bc;return _0x5068a9&&_0x5068a9[_0x56d773(0xd5)]?_0x5068a9:{'default':_0x5068a9};};function a358_0x1007(){const _0x248ebe=['../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','_connectionVeeva','Is_Error__c','\x20</a>','status','createBackup','Failure','application/zip','_tempFolder','9256zxGIPr','DEPLOYED','../../shared/utils/fetch-attachments','Retrieving\x20components','PackageExportService','\x20>\x20','finishDeployWithError','branchId','EXCEPTION','45TtwZeA','componentIdList','<a\x20href=','__importDefault','./salesforce.service','MetadataLogStatus','get','COMPLETED','_organisationName','Metadata_Log__c','_timeZone','Status__c','Body','PackageComponentStatus','veeva-deploy','./vpk.service','_vpkService','Branch','set','createVpk','Save\x20log','default','Date__c','(((.+)+)+)+$','saveBackup','../constants/flosum.constants','_instanceUrl','2434756AAzDOp','_veevaService','logError','Deploy\x20completed\x20','14133gXIwZS','base64','143lzhARr','error','_metadataLogId','_connectionSalesforce','_systemLogger','patch','Deployment','Activity_Type__c','map','with\x20error','catch','../enums/status.enums','has','componentHistoryId','constructor','apply','createZip','FlosumConstants','_salesforceService','organisationName','ENDPOINT_UPSERT_RECORD','Job_Completed__c','getFlosumComponents','Create\x20Backup','_componentIdList','packageId','ZipCreatorDeploy','Log__c','276lBAlFV','values','/Attachment','Success','Component_Name__c','from','Branch__c','retrieveAttachments','Activity_Item__c','Veeva_Step_Name__c','Cannot\x20Backup\x20more\x20than\x20200\x20components.','retrieve','VpkService','Veeva\x20Deployment','timeZone','Org__c','saveLog','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','metadataLogId','PackageImportService','name','slice','log','Deployment\x20Result','70878wHdajb','./veeva.service','_deploymentName','/vpk__','shortid','./package-import.service','saveDeploymentResults','execute','toLowerCase','post','success','_logger','../classes/errors/salesforce-dml-error','../../../constants','lastIndexOf','_organisationId','TargetId__c','deploymentName','search','Join\x20all\x20mdl\x20into\x20one\x20zip','fs/promises','2879028khJbVL','length','4004WYctGF','Action__c','type','flat','filter','</a>','.zip','isDeployed','Save\x20Backup\x20to\x20Salesforce','365710DNcxPX','writeFile','finishDeploy','fetchAttachmentsDetailsByParentId','Component_History__c','toString','attachmentLogId','organisationId','_packageImportService','../../../core','\x20has\x20been\x20created.','jszip','_branchId','updateLog','DeployService','__esModule','Deployment_Result__c','FLOSUM_NAMESPACE','\x20of\x20branch\x20to\x20Organization\x20','./package-export.service','packageComponentList','387610kVQTOw','formFlosumDeploymentResults','SalesforceDmlError','Form\x20Deployment\x20Results'];a358_0x1007=function(){return _0x248ebe;};return a358_0x1007();}Object['defineProperty'](exports,a358_0x2ae4bc(0xd5),{'value':!![]}),exports[a358_0x2ae4bc(0xd4)]=void 0x0;const jszip_1=__importDefault(require(a358_0x2ae4bc(0xd1))),promises_1=require(a358_0x2ae4bc(0x15a)),constants_1=require(a358_0x2ae4bc(0x153)),flosum_constants_1=require(a358_0x2ae4bc(0x10a)),veeva_service_1=require(a358_0x2ae4bc(0x147)),salesforce_service_1=require(a358_0x2ae4bc(0xf5)),core_1=require(a358_0x2ae4bc(0xcf)),status_enums_1=require(a358_0x2ae4bc(0x11d)),salesforce_dml_error_1=require(a358_0x2ae4bc(0x152)),shortid_1=__importDefault(require(a358_0x2ae4bc(0x14a))),fetch_attachments_1=require(a358_0x2ae4bc(0xea)),package_import_service_1=require(a358_0x2ae4bc(0x14b)),branch_component_history_flosum_component_retriever_1=require(a358_0x2ae4bc(0x13f)),flosum_component_veeva_component_retriever_1=require(a358_0x2ae4bc(0xdf)),package_export_service_1=require(a358_0x2ae4bc(0xd9)),vpk_service_1=require(a358_0x2ae4bc(0x100)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');function a358_0x1323(_0xe1c153,_0x4779c3){const _0x52fa97=a358_0x1007();return a358_0x1323=function(_0x26ecdf,_0x867d9f){_0x26ecdf=_0x26ecdf-0xc0;let _0x10074b=_0x52fa97[_0x26ecdf];return _0x10074b;},a358_0x1323(_0xe1c153,_0x4779c3);}class DeployService{constructor(_0x38d1fb,_0x5109ca,_0x15a7c8,_0x5f10d0,_0x524eb3,_0x5a72a3){const _0x1c4ea1=a358_0x2ae4bc;this[_0x1c4ea1(0x115)]=_0x5109ca,this[_0x1c4ea1(0xe0)]=_0x15a7c8,this[_0x1c4ea1(0x151)]=_0x5f10d0,this[_0x1c4ea1(0xe7)]=_0x524eb3,this['_instanceUrl']=_0x5a72a3,this['_branchId']=_0x38d1fb[_0x1c4ea1(0xef)],this[_0x1c4ea1(0x114)]=_0x38d1fb[_0x1c4ea1(0x140)],this['_attachmentLogId']=_0x38d1fb[_0x1c4ea1(0xcc)],this['_organisationId']=_0x38d1fb[_0x1c4ea1(0xcd)],this[_0x1c4ea1(0xfb)]=_0x38d1fb[_0x1c4ea1(0x13c)],this[_0x1c4ea1(0xf9)]=_0x38d1fb[_0x1c4ea1(0x125)],this['_componentIdList']=_0x38d1fb[_0x1c4ea1(0xf2)],this[_0x1c4ea1(0x148)]=_0x38d1fb[_0x1c4ea1(0x157)],this['_systemLogger']=new core_1['Logger'](_0x1c4ea1(0xff)),this['_veevaService']=new veeva_service_1['VeevaService']({'connection':this['_connectionVeeva'],'logger':this[_0x1c4ea1(0x151)]}),this[_0x1c4ea1(0x124)]=new salesforce_service_1['SalesforceService']({'connection':this[_0x1c4ea1(0x115)]}),this[_0x1c4ea1(0xce)]=new package_import_service_1[(_0x1c4ea1(0x141))]({'veevaService':this[_0x1c4ea1(0x10d)],'connection':this[_0x1c4ea1(0xe0)],'logger':this[_0x1c4ea1(0x151)],'saveLog':this[_0x1c4ea1(0x13e)]['bind'](this)}),this['_packageExportService']=new package_export_service_1[(_0x1c4ea1(0xec))]({'veevaService':this['_veevaService'],'connection':this[_0x1c4ea1(0xe0)],'logger':this[_0x1c4ea1(0x151)]}),this[_0x1c4ea1(0x101)]=new vpk_service_1[(_0x1c4ea1(0x13a))]({'connection':this[_0x1c4ea1(0xe0)]});}async[a358_0x2ae4bc(0x14d)](){const _0x5ec731=a358_0x2ae4bc;try{const _0x3610ef=await this[_0x5ec731(0x128)]();await this[_0x5ec731(0x151)][_0x5ec731(0xd3)]();const _0x4c46f2=await this['createBackup'](_0x3610ef);await this['saveBackup'](_0x4c46f2);const _0x5d0bed=await this[_0x5ec731(0x135)](_0x3610ef),_0x56a3bd=await this[_0x5ec731(0x122)](_0x5d0bed),_0x473a87=await this[_0x5ec731(0x104)](_0x56a3bd);await this['_logger'][_0x5ec731(0xd3)]();const _0x17172d=await this[_0x5ec731(0xce)]['import'](_0x473a87);await this['_logger'][_0x5ec731(0xd3)]();const _0x1a3e84=this[_0x5ec731(0xdc)](_0x3610ef,_0x17172d[_0x5ec731(0xda)]);await this['saveDeploymentResults'](_0x1a3e84),await this[_0x5ec731(0xc8)](_0x17172d[_0x5ec731(0xc4)],![],_0x17172d[_0x5ec731(0x12b)]);}catch(_0x8cf0ea){await this[_0x5ec731(0xee)](_0x8cf0ea)[_0x5ec731(0x11c)](_0x1917fe=>this[_0x5ec731(0x116)][_0x5ec731(0x113)](_0x1917fe));}}async['getFlosumComponents'](){const _0x4f2580=a358_0x2ae4bc,_0x44f314=new Set(this[_0x4f2580(0x12a)]);this[_0x4f2580(0x151)][_0x4f2580(0x144)](_0x4f2580(0xeb));const _0x4a4332=await new branch_component_history_flosum_component_retriever_1['BranchComponentHistoryFlosumComponentRetriever']({'value':this[_0x4f2580(0xd2)],'salesforceService':this['_salesforceService']})[_0x4f2580(0x139)](),_0x41a798=_0x4a4332[_0x4f2580(0xc1)](_0x36dc4e=>_0x44f314[_0x4f2580(0x11e)](_0x36dc4e['id']));if(_0x41a798[_0x4f2580(0x15c)]!==this[_0x4f2580(0x12a)][_0x4f2580(0x15c)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x41a798;}async[a358_0x2ae4bc(0xe4)](_0x584f72){const _0x298ec5=a358_0x2ae4bc;var _0x59d0e2;this[_0x298ec5(0x151)][_0x298ec5(0x144)](_0x298ec5(0x129));const _0x566ad3=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x584f72,'veevaService':this[_0x298ec5(0x10d)],'logger':this[_0x298ec5(0x151)]})[_0x298ec5(0x139)](),_0x36275a=await this['_packageExportService']['export'](_0x566ad3,'Backup');if(_0x36275a['length']>0x1)throw new Error(_0x298ec5(0x138));return(_0x59d0e2=_0x36275a[0x0])!==null&&_0x59d0e2!==void 0x0?_0x59d0e2:_0x36275a[0x0]=new jszip_1[(_0x298ec5(0x106))](),_0x36275a[0x0]['generateAsync']({'type':_0x298ec5(0x111)});}async[a358_0x2ae4bc(0x109)](_0xc57b5){const _0x4bbefc=a358_0x2ae4bc;this[_0x4bbefc(0x151)][_0x4bbefc(0x144)](_0x4bbefc(0xc5));const _0x16a864={'Body':_0xc57b5,'ContentType':_0x4bbefc(0xe6),'ParentId':this[_0x4bbefc(0x114)],'Name':flosum_constants_1[_0x4bbefc(0x123)]['BACKUP_ZIP_NAME']};await this[_0x4bbefc(0x115)][_0x4bbefc(0x14f)](flosum_constants_1[_0x4bbefc(0x123)][_0x4bbefc(0x126)]+_0x4bbefc(0x130),_0x16a864);}async[a358_0x2ae4bc(0x135)](_0x1f0c7a){const _0x5c517d=a358_0x2ae4bc;this['_logger'][_0x5c517d(0x144)]('Retrieving\x20attachments');const _0x2a8b5d=await(0x0,fetch_attachments_1[_0x5c517d(0xc9)])(this[_0x5c517d(0x115)],_0x1f0c7a['map'](_0x26329d=>_0x26329d[_0x5c517d(0x11f)])),_0x4eee64=await(0x0,fetch_attachments_1[_0x5c517d(0x135)])(_0x2a8b5d,this[_0x5c517d(0x115)]);if(_0x4eee64['length']!==this[_0x5c517d(0x12a)][_0x5c517d(0x15c)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x4eee64['map'](_0x4948f0=>_0x4948f0[_0x5c517d(0x12f)][_0x5c517d(0xfd)]);}async[a358_0x2ae4bc(0x122)](_0x440a4b){const _0x3f340a=a358_0x2ae4bc;this['_logger'][_0x3f340a(0x144)](_0x3f340a(0x159));const _0x1f9a9d=await new zip_creator_deploy_1[(_0x3f340a(0x12c))]({'attachmentBodies':_0x440a4b,'deploymentName':this[_0x3f340a(0x148)]})[_0x3f340a(0x14d)](),_0x86ceb2=this[_0x3f340a(0xe7)]+'/'+(0x0,shortid_1[_0x3f340a(0x106)])()+_0x3f340a(0xc3);return await(0x0,promises_1[_0x3f340a(0xc7)])(_0x86ceb2,_0x1f9a9d),_0x86ceb2;}async[a358_0x2ae4bc(0x104)](_0x5e73b5){const _0x6eaa2c=a358_0x2ae4bc;this['_logger'][_0x6eaa2c(0x144)]('Create\x20vpk\x20package');const _0x175d5f=await this[_0x6eaa2c(0x101)]['generate'](_0x5e73b5),_0x62cab0=this[_0x6eaa2c(0xe7)]+_0x6eaa2c(0x149)+_0x5e73b5[_0x6eaa2c(0x143)](_0x5e73b5[_0x6eaa2c(0x154)]('/')+0x1);return await(0x0,promises_1[_0x6eaa2c(0xc7)])(_0x62cab0,_0x175d5f),await this[_0x6eaa2c(0x101)]['validate'](_0x62cab0),_0x62cab0;}async[a358_0x2ae4bc(0x13e)](_0x3feca0,_0x18d7d2){const _0x19f989=a358_0x2ae4bc;this[_0x19f989(0x151)][_0x19f989(0x144)](_0x19f989(0x105));const _0x2c7143={'Body':Buffer[_0x19f989(0x133)](_0x3feca0)[_0x19f989(0xcb)](_0x19f989(0x111)),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x18d7d2};await this[_0x19f989(0x115)][_0x19f989(0x14f)](flosum_constants_1[_0x19f989(0x123)][_0x19f989(0x126)]+_0x19f989(0x130),_0x2c7143);}[a358_0x2ae4bc(0xdc)](_0xbe81d0,_0x551105){const _0x20f7f2=a358_0x2ae4bc;this[_0x20f7f2(0x151)]['log'](_0x20f7f2(0xde));const _0x4f406d=_0xbe81d0['reduce']((_0x2af3c3,_0x21ab94)=>_0x2af3c3[_0x20f7f2(0x103)]((_0x21ab94['componentType']+'.'+_0x21ab94['componentName'])[_0x20f7f2(0x14e)](),_0x21ab94),new Map());return _0x551105[_0x20f7f2(0x11a)](_0x5e4c24=>{const _0x3b7f2d=_0x20f7f2;this[_0x3b7f2d(0x151)][_0x3b7f2d(0x144)](_0x5e4c24['type']+'.'+_0x5e4c24['name']+'\x20:\x20'+_0x5e4c24['status']);const _0x12fe76=(_0x5e4c24[_0x3b7f2d(0x15f)]+'.'+_0x5e4c24['name'])[_0x3b7f2d(0x14e)](),_0x3fc5e0=_0x4f406d[_0x3b7f2d(0xf7)](_0x12fe76);return{[constants_1[_0x3b7f2d(0xd7)]+'Type__c']:_0x3b7f2d(0x145),[constants_1['FLOSUM_NAMESPACE']+_0x3b7f2d(0xfc)]:_0x5e4c24[_0x3b7f2d(0xe3)]===status_enums_1[_0x3b7f2d(0xfe)][_0x3b7f2d(0xe9)]?_0x3b7f2d(0x131):_0x3b7f2d(0xe5),[constants_1[_0x3b7f2d(0xd7)]+'Result__c']:_0x5e4c24['deploymentAction'],[constants_1[_0x3b7f2d(0xd7)]+_0x3b7f2d(0x132)]:_0x5e4c24[_0x3b7f2d(0x142)],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x5e4c24[_0x3b7f2d(0x15f)],[constants_1['FLOSUM_NAMESPACE']+_0x3b7f2d(0x137)]:_0x5e4c24['stepName'],[constants_1[_0x3b7f2d(0xd7)]+_0x3b7f2d(0x13d)]:this[_0x3b7f2d(0x155)],[constants_1['FLOSUM_NAMESPACE']+_0x3b7f2d(0xfa)]:this[_0x3b7f2d(0x114)],[constants_1['FLOSUM_NAMESPACE']+_0x3b7f2d(0xca)]:_0x3fc5e0[_0x3b7f2d(0x11f)]};});}async[a358_0x2ae4bc(0x14c)](_0x536895){const _0x5b510e=a358_0x2ae4bc;this[_0x5b510e(0x151)]['log']('Save\x20Deployment\x20Results');const _0x1fdbe5=await this[_0x5b510e(0x124)]['insertMultipleRecords'](constants_1[_0x5b510e(0xd7)]+_0x5b510e(0xd6),_0x536895),_0x3dcbf6=_0x1fdbe5['filter'](_0x122268=>!_0x122268[_0x5b510e(0x150)])[_0x5b510e(0x11a)](_0xe8fc0d=>_0xe8fc0d['errors'])[_0x5b510e(0xc0)]();if(_0x3dcbf6[_0x5b510e(0x15c)])throw new salesforce_dml_error_1[(_0x5b510e(0xdd))](_0x3dcbf6);}async[a358_0x2ae4bc(0xee)](_0x5dae96){const _0x33b896=a358_0x2ae4bc;this[_0x33b896(0x151)][_0x33b896(0x10e)](_0x5dae96),await this[_0x33b896(0x151)][_0x33b896(0xd3)](),await this[_0x33b896(0xc8)](![],!![],'');}async[a358_0x2ae4bc(0xc8)](_0x2ac4f5,_0x247b6d,_0x3ca2a5){const _0xafe316=a358_0x2ae4bc,_0x9451ff='<a\x20href='+this[_0xafe316(0x10b)]+'/'+this[_0xafe316(0x114)]+_0xafe316(0xed)+_0xafe316(0x13b)+_0xafe316(0xe2),_0x3ec1b9=_0xafe316(0xf3)+this[_0xafe316(0x10b)]+'/'+this['_organisationId']+'\x20>'+this[_0xafe316(0xf9)]+_0xafe316(0xc2),_0x989c5=_0x9451ff+_0xafe316(0xd8)+_0x3ec1b9+_0xafe316(0xd0),_0x439b1a={[constants_1[_0xafe316(0xd7)]+_0xafe316(0x15e)]:_0x989c5,[constants_1[_0xafe316(0xd7)]+_0xafe316(0x107)]:new Date(),[constants_1[_0xafe316(0xd7)]+_0xafe316(0x134)]:this['_branchId'],[constants_1[_0xafe316(0xd7)]+_0xafe316(0x136)]:_0xafe316(0x102),[constants_1[_0xafe316(0xd7)]+_0xafe316(0x119)]:_0xafe316(0x118),[constants_1['FLOSUM_NAMESPACE']+_0xafe316(0x156)]:this[_0xafe316(0x155)]},_0x287b8d={[constants_1['FLOSUM_NAMESPACE']+_0xafe316(0xe1)]:!_0x2ac4f5,[constants_1[_0xafe316(0xd7)]+'Succeed__c']:_0x2ac4f5,[constants_1[_0xafe316(0xd7)]+_0xafe316(0xfc)]:_0x247b6d?status_enums_1['MetadataLogStatus'][_0xafe316(0xf0)]:status_enums_1[_0xafe316(0xf6)][_0xafe316(0xf8)],[constants_1['FLOSUM_NAMESPACE']+_0xafe316(0x127)]:!![],[constants_1[_0xafe316(0xd7)]+'External_Deployment_Id__c']:_0x3ca2a5};await this[_0xafe316(0x115)][_0xafe316(0x117)](flosum_constants_1[_0xafe316(0x123)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0xafe316(0xd7)]+'Metadata_Log__c/'+this['_metadataLogId'],_0x287b8d),await this[_0xafe316(0x115)][_0xafe316(0x14f)](flosum_constants_1[_0xafe316(0x123)][_0xafe316(0x126)]+'/'+constants_1[_0xafe316(0xd7)]+_0xafe316(0x12d),_0x439b1a),this['_logger'][_0xafe316(0x144)](_0xafe316(0x10f)+(_0x2ac4f5?'successfully':_0xafe316(0x11b))+'.'),await this[_0xafe316(0x151)]['updateLog']();}}exports[a358_0x2ae4bc(0xd4)]=DeployService;