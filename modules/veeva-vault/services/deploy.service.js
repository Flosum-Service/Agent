const a390_0x3f2ac3=a390_0x2239;(function(_0x4bae97,_0x24e6be){const _0x51e4b2=a390_0x2239,_0x53820d=_0x4bae97();while(!![]){try{const _0x458537=-parseInt(_0x51e4b2(0x219))/0x1*(-parseInt(_0x51e4b2(0x21e))/0x2)+parseInt(_0x51e4b2(0x1bd))/0x3+parseInt(_0x51e4b2(0x1f6))/0x4*(-parseInt(_0x51e4b2(0x220))/0x5)+-parseInt(_0x51e4b2(0x225))/0x6+-parseInt(_0x51e4b2(0x1fc))/0x7+parseInt(_0x51e4b2(0x1d9))/0x8+parseInt(_0x51e4b2(0x19e))/0x9;if(_0x458537===_0x24e6be)break;else _0x53820d['push'](_0x53820d['shift']());}catch(_0x8a3687){_0x53820d['push'](_0x53820d['shift']());}}}(a390_0x4da8,0x4ad97));const a390_0x3db877=(function(){let _0x1fa793=!![];return function(_0x3c666a,_0x46abf0){const _0x40a47f=_0x1fa793?function(){const _0x40e162=a390_0x2239;if(_0x46abf0){const _0x316423=_0x46abf0[_0x40e162(0x1e3)](_0x3c666a,arguments);return _0x46abf0=null,_0x316423;}}:function(){};return _0x1fa793=![],_0x40a47f;};}()),a390_0x422ff6=a390_0x3db877(this,function(){const _0x31211f=a390_0x2239;return a390_0x422ff6[_0x31211f(0x212)]()['search'](_0x31211f(0x20c))[_0x31211f(0x212)]()[_0x31211f(0x1f9)](a390_0x422ff6)[_0x31211f(0x221)](_0x31211f(0x20c));});a390_0x422ff6();function a390_0x2239(_0x3540ff,_0x102dba){const _0x182568=a390_0x4da8();return a390_0x2239=function(_0x422ff6,_0x3db877){_0x422ff6=_0x422ff6-0x19a;let _0x4da811=_0x182568[_0x422ff6];return _0x4da811;},a390_0x2239(_0x3540ff,_0x102dba);}'use strict';function a390_0x4da8(){const _0x5e4484=['Job_Completed__c','_connectionVeeva','base64','shortid','default','_attachmentLogId','Cannot\x20retrieve\x20all\x20components.','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','_packageImportService','componentName','Deployment','Logger','saveDeploymentResults','VpkService','Create\x20Backup','(((.+)+)+)+$','Deployment\x20Result','execute','Deployment_Result__c','get','_connectionSalesforce','toString','/vpk__','Metadata_Log__c/','_branchId','success','post','saveLog','5657PtdOEn','External_Deployment_Id__c','from','with\x20error','\x20>\x20','202Ffvapc','_metadataLogId','1373695qTghTP','search','logError','./veeva.service','_tempFolder','3407814IkdyZt','writeFile','TargetId__c','_deploymentName','./package-export.service','__importDefault','metadataLogId','packageId','Branch','lastIndexOf','166941DhVHFd','Org__c','formFlosumDeploymentResults','Body','import','getFlosumComponents','Backup','componentType','export','ENDPOINT_UPSERT_RECORD','error','Log__c','generate','log','finishDeployWithError','_organisationId','Retrieving\x20components','map','deploymentName','_systemLogger','../constants/flosum.constants','_instanceUrl','toLowerCase','Deploy\x20completed\x20','status','_componentIdList','Save\x20Deployment\x20Results','name','timeZone','organisationId','type','1761747vOFxOD','../classes/errors/salesforce-dml-error','../../../core','BranchComponentHistoryFlosumComponentRetriever','/Attachment','.zip','jszip','Result__c','_organisationName','Component_Type__c','length','retrieve','text/plain','updateLog','_vpkService','finishDeploy','defineProperty','ZipCreatorDeploy','Branch__c','Succeed__c','errors','Status__c','Create\x20vpk\x20package','FlosumComponentVeevaComponentRetriever','packageComponentList','branchId','createBackup','FlosumConstants','2681392xZJzWR','PackageComponentStatus','slice','Retrieving\x20attachments','../../shared/utils/fetch-attachments','createZip','filter','Form\x20Deployment\x20Results','validate','DeployService','apply','\x20</a>','_veevaService','./package-import.service','stepName','Cannot\x20Backup\x20more\x20than\x20200\x20components.','retrieveAttachments','values','FLOSUM_NAMESPACE','MetadataLogStatus','set','Component_History__c','flat','componentHistoryId','_salesforceService','fetchAttachmentsDetailsByParentId','_logger','Activity_Item__c','organisationName','8ggJVSz','Veeva_Step_Name__c','createVpk','constructor','attachmentLogId','\x20of\x20branch\x20to\x20Organization\x20','618093PllEIv'];a390_0x4da8=function(){return _0x5e4484;};return a390_0x4da8();}var __importDefault=this&&this[a390_0x3f2ac3(0x22a)]||function(_0x1d9842){return _0x1d9842&&_0x1d9842['__esModule']?_0x1d9842:{'default':_0x1d9842};};Object[a390_0x3f2ac3(0x1cd)](exports,'__esModule',{'value':!![]}),exports[a390_0x3f2ac3(0x1e2)]=void 0x0;const jszip_1=__importDefault(require(a390_0x3f2ac3(0x1c3))),promises_1=require('fs/promises'),constants_1=require('../../../constants'),flosum_constants_1=require(a390_0x3f2ac3(0x1b2)),veeva_service_1=require(a390_0x3f2ac3(0x223)),salesforce_service_1=require('./salesforce.service'),core_1=require(a390_0x3f2ac3(0x1bf)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a390_0x3f2ac3(0x1be)),shortid_1=__importDefault(require(a390_0x3f2ac3(0x200))),fetch_attachments_1=require(a390_0x3f2ac3(0x1dd)),package_import_service_1=require(a390_0x3f2ac3(0x1e6)),branch_component_history_flosum_component_retriever_1=require(a390_0x3f2ac3(0x204)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require(a390_0x3f2ac3(0x229)),vpk_service_1=require('./vpk.service'),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x88b32f,_0x257b5e,_0x4061b9,_0x243f4b,_0x407510,_0x54d66c){const _0xf34765=a390_0x3f2ac3;this[_0xf34765(0x211)]=_0x257b5e,this['_connectionVeeva']=_0x4061b9,this[_0xf34765(0x1f3)]=_0x243f4b,this[_0xf34765(0x224)]=_0x407510,this[_0xf34765(0x1b3)]=_0x54d66c,this[_0xf34765(0x215)]=_0x88b32f[_0xf34765(0x1d6)],this[_0xf34765(0x21f)]=_0x88b32f[_0xf34765(0x19a)],this[_0xf34765(0x202)]=_0x88b32f[_0xf34765(0x1fa)],this['_organisationId']=_0x88b32f[_0xf34765(0x1bb)],this['_timeZone']=_0x88b32f[_0xf34765(0x1ba)],this[_0xf34765(0x1c5)]=_0x88b32f[_0xf34765(0x1f5)],this[_0xf34765(0x1b7)]=_0x88b32f['componentIdList'],this[_0xf34765(0x228)]=_0x88b32f[_0xf34765(0x1b0)],this[_0xf34765(0x1b1)]=new core_1[(_0xf34765(0x208))]('veeva-deploy'),this[_0xf34765(0x1e5)]=new veeva_service_1['VeevaService']({'connection':this[_0xf34765(0x1fe)],'logger':this[_0xf34765(0x1f3)]}),this[_0xf34765(0x1f1)]=new salesforce_service_1['SalesforceService']({'connection':this['_connectionSalesforce']}),this[_0xf34765(0x205)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0xf34765(0x1e5)],'connection':this[_0xf34765(0x1fe)],'logger':this[_0xf34765(0x1f3)],'saveLog':this[_0xf34765(0x218)]['bind'](this)}),this['_packageExportService']=new package_export_service_1['PackageExportService']({'veevaService':this[_0xf34765(0x1e5)],'connection':this[_0xf34765(0x1fe)],'logger':this['_logger']}),this[_0xf34765(0x1cb)]=new vpk_service_1[(_0xf34765(0x20a))]({'connection':this[_0xf34765(0x1fe)]});}async[a390_0x3f2ac3(0x20e)](){const _0x3fa6d6=a390_0x3f2ac3;try{const _0x327df3=await this[_0x3fa6d6(0x1a3)]();await this[_0x3fa6d6(0x1f3)][_0x3fa6d6(0x1ca)]();const _0x21d1a5=await this[_0x3fa6d6(0x1d7)](_0x327df3);await this['saveBackup'](_0x21d1a5);const _0x2339e9=await this['retrieveAttachments'](_0x327df3),_0x4bcd99=await this[_0x3fa6d6(0x1de)](_0x2339e9),_0x57f631=await this[_0x3fa6d6(0x1f8)](_0x4bcd99);await this[_0x3fa6d6(0x1f3)][_0x3fa6d6(0x1ca)]();const _0x35a9e4=await this[_0x3fa6d6(0x205)][_0x3fa6d6(0x1a2)](_0x57f631);await this[_0x3fa6d6(0x1f3)][_0x3fa6d6(0x1ca)]();const _0x49caf4=this[_0x3fa6d6(0x1a0)](_0x327df3,_0x35a9e4[_0x3fa6d6(0x1d5)]);await this[_0x3fa6d6(0x209)](_0x49caf4),await this[_0x3fa6d6(0x1cc)](_0x35a9e4['isDeployed'],![],_0x35a9e4[_0x3fa6d6(0x19b)]);}catch(_0x2fcc6e){await this[_0x3fa6d6(0x1ac)](_0x2fcc6e)['catch'](_0x30902b=>this[_0x3fa6d6(0x1b1)][_0x3fa6d6(0x1a8)](_0x30902b));}}async['getFlosumComponents'](){const _0x391c0a=a390_0x3f2ac3,_0x49e2e9=new Set(this[_0x391c0a(0x1b7)]);this[_0x391c0a(0x1f3)][_0x391c0a(0x1ab)](_0x391c0a(0x1ae));const _0x36f509=await new branch_component_history_flosum_component_retriever_1[(_0x391c0a(0x1c0))]({'value':this[_0x391c0a(0x215)],'salesforceService':this[_0x391c0a(0x1f1)]})[_0x391c0a(0x1c8)](),_0x35fa82=_0x36f509[_0x391c0a(0x1df)](_0x14af85=>_0x49e2e9['has'](_0x14af85['id']));if(_0x35fa82[_0x391c0a(0x1c7)]!==this['_componentIdList'][_0x391c0a(0x1c7)])throw new Error(_0x391c0a(0x203));return _0x35fa82;}async['createBackup'](_0x5d6e2a){const _0x54b774=a390_0x3f2ac3;var _0x2887c7;this[_0x54b774(0x1f3)][_0x54b774(0x1ab)](_0x54b774(0x20b));const _0x306709=await new flosum_component_veeva_component_retriever_1[(_0x54b774(0x1d4))]({'value':_0x5d6e2a,'veevaService':this[_0x54b774(0x1e5)],'logger':this[_0x54b774(0x1f3)]})[_0x54b774(0x1c8)](),_0x192417=await this['_packageExportService'][_0x54b774(0x1a6)](_0x306709,_0x54b774(0x1a4));if(_0x192417[_0x54b774(0x1c7)]>0x1)throw new Error(_0x54b774(0x1e8));return(_0x2887c7=_0x192417[0x0])!==null&&_0x2887c7!==void 0x0?_0x2887c7:_0x192417[0x0]=new jszip_1[(_0x54b774(0x201))](),_0x192417[0x0]['generateAsync']({'type':'base64'});}async['saveBackup'](_0x1f3170){const _0x250d54=a390_0x3f2ac3;this[_0x250d54(0x1f3)][_0x250d54(0x1ab)]('Save\x20Backup\x20to\x20Salesforce');const _0x2b7ed5={'Body':_0x1f3170,'ContentType':'application/zip','ParentId':this[_0x250d54(0x21f)],'Name':flosum_constants_1['FlosumConstants']['BACKUP_ZIP_NAME']};await this[_0x250d54(0x211)][_0x250d54(0x217)](flosum_constants_1[_0x250d54(0x1d8)][_0x250d54(0x1a7)]+_0x250d54(0x1c1),_0x2b7ed5);}async['retrieveAttachments'](_0x5e1560){const _0x1869eb=a390_0x3f2ac3;this[_0x1869eb(0x1f3)][_0x1869eb(0x1ab)](_0x1869eb(0x1dc));const _0x18ef75=await(0x0,fetch_attachments_1[_0x1869eb(0x1f2)])(this['_connectionSalesforce'],_0x5e1560[_0x1869eb(0x1af)](_0x3b8aca=>_0x3b8aca[_0x1869eb(0x1f0)])),_0x5372a8=await(0x0,fetch_attachments_1[_0x1869eb(0x1e9)])(_0x18ef75,this['_connectionSalesforce']);if(_0x5372a8['length']!==this[_0x1869eb(0x1b7)][_0x1869eb(0x1c7)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x5372a8[_0x1869eb(0x1af)](_0x1a727e=>_0x1a727e[_0x1869eb(0x1ea)][_0x1869eb(0x1a1)]);}async[a390_0x3f2ac3(0x1de)](_0x29aac6){const _0x17f13f=a390_0x3f2ac3;this[_0x17f13f(0x1f3)][_0x17f13f(0x1ab)]('Join\x20all\x20mdl\x20into\x20one\x20zip');const _0x280e75=await new zip_creator_deploy_1[(_0x17f13f(0x1ce))]({'attachmentBodies':_0x29aac6,'deploymentName':this[_0x17f13f(0x228)]})[_0x17f13f(0x20e)](),_0x323075=this[_0x17f13f(0x224)]+'/'+(0x0,shortid_1[_0x17f13f(0x201)])()+_0x17f13f(0x1c2);return await(0x0,promises_1[_0x17f13f(0x226)])(_0x323075,_0x280e75),_0x323075;}async[a390_0x3f2ac3(0x1f8)](_0x5bee76){const _0x567ce5=a390_0x3f2ac3;this[_0x567ce5(0x1f3)][_0x567ce5(0x1ab)](_0x567ce5(0x1d3));const _0x1d1cf4=await this[_0x567ce5(0x1cb)][_0x567ce5(0x1aa)](_0x5bee76),_0x323557=this[_0x567ce5(0x224)]+_0x567ce5(0x213)+_0x5bee76[_0x567ce5(0x1db)](_0x5bee76[_0x567ce5(0x19d)]('/')+0x1);return await(0x0,promises_1[_0x567ce5(0x226)])(_0x323557,_0x1d1cf4),await this[_0x567ce5(0x1cb)][_0x567ce5(0x1e1)](_0x323557),_0x323557;}async[a390_0x3f2ac3(0x218)](_0x4201cc,_0x1547b1){const _0x498d60=a390_0x3f2ac3;this['_logger']['log']('Save\x20log');const _0x32295b={'Body':Buffer[_0x498d60(0x21b)](_0x4201cc)['toString'](_0x498d60(0x1ff)),'ContentType':_0x498d60(0x1c9),'ParentId':this[_0x498d60(0x21f)],'Name':_0x1547b1};await this[_0x498d60(0x211)]['post'](flosum_constants_1[_0x498d60(0x1d8)]['ENDPOINT_UPSERT_RECORD']+_0x498d60(0x1c1),_0x32295b);}[a390_0x3f2ac3(0x1a0)](_0xa3ce1e,_0x2f589e){const _0x2067d0=a390_0x3f2ac3;this['_logger']['log'](_0x2067d0(0x1e0));const _0x2870ae=_0xa3ce1e['reduce']((_0x16720e,_0x1759f0)=>_0x16720e[_0x2067d0(0x1ed)]((_0x1759f0[_0x2067d0(0x1a5)]+'.'+_0x1759f0[_0x2067d0(0x206)])[_0x2067d0(0x1b4)](),_0x1759f0),new Map());return _0x2f589e['map'](_0xba33e0=>{const _0x379182=_0x2067d0;this[_0x379182(0x1f3)][_0x379182(0x1ab)](_0xba33e0[_0x379182(0x1bc)]+'.'+_0xba33e0[_0x379182(0x1b9)]+'\x20:\x20'+_0xba33e0['status']);const _0xaef9bd=(_0xba33e0['type']+'.'+_0xba33e0[_0x379182(0x1b9)])[_0x379182(0x1b4)](),_0x3b7b4b=_0x2870ae[_0x379182(0x210)](_0xaef9bd);return{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:_0x379182(0x20d),[constants_1[_0x379182(0x1eb)]+'Status__c']:_0xba33e0[_0x379182(0x1b6)]===status_enums_1[_0x379182(0x1da)]['DEPLOYED']?'Success':'Failure',[constants_1[_0x379182(0x1eb)]+_0x379182(0x1c4)]:_0xba33e0['deploymentAction'],[constants_1[_0x379182(0x1eb)]+'Component_Name__c']:_0xba33e0[_0x379182(0x1b9)],[constants_1['FLOSUM_NAMESPACE']+_0x379182(0x1c6)]:_0xba33e0[_0x379182(0x1bc)],[constants_1['FLOSUM_NAMESPACE']+_0x379182(0x1f7)]:_0xba33e0[_0x379182(0x1e7)],[constants_1[_0x379182(0x1eb)]+_0x379182(0x19f)]:this['_organisationId'],[constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c']:this['_metadataLogId'],[constants_1['FLOSUM_NAMESPACE']+_0x379182(0x1ee)]:_0x3b7b4b[_0x379182(0x1f0)]};});}async['saveDeploymentResults'](_0x124498){const _0x35b49f=a390_0x3f2ac3;this['_logger'][_0x35b49f(0x1ab)](_0x35b49f(0x1b8));const _0xe3d7e2=await this[_0x35b49f(0x1f1)]['insertMultipleRecords'](constants_1[_0x35b49f(0x1eb)]+_0x35b49f(0x20f),_0x124498),_0x13580e=_0xe3d7e2['filter'](_0x41ea05=>!_0x41ea05[_0x35b49f(0x216)])[_0x35b49f(0x1af)](_0x331de6=>_0x331de6[_0x35b49f(0x1d1)])[_0x35b49f(0x1ef)]();if(_0x13580e[_0x35b49f(0x1c7)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x13580e);}async['finishDeployWithError'](_0x446b7a){const _0x46f89a=a390_0x3f2ac3;this[_0x46f89a(0x1f3)][_0x46f89a(0x222)](_0x446b7a),await this[_0x46f89a(0x1f3)][_0x46f89a(0x1ca)](),await this['finishDeploy'](![],!![],'');}async[a390_0x3f2ac3(0x1cc)](_0x12600c,_0x2d2193,_0x5e958e){const _0x5c71ee=a390_0x3f2ac3,_0x419850='<a\x20href='+this[_0x5c71ee(0x1b3)]+'/'+this[_0x5c71ee(0x21f)]+_0x5c71ee(0x21d)+'Veeva\x20Deployment'+_0x5c71ee(0x1e4),_0x4ee886='<a\x20href='+this[_0x5c71ee(0x1b3)]+'/'+this[_0x5c71ee(0x1ad)]+'\x20>'+this[_0x5c71ee(0x1c5)]+'</a>',_0x105c87=_0x419850+_0x5c71ee(0x1fb)+_0x4ee886+'\x20has\x20been\x20created.',_0xcfbf8c={[constants_1[_0x5c71ee(0x1eb)]+'Action__c']:_0x105c87,[constants_1[_0x5c71ee(0x1eb)]+'Date__c']:new Date(),[constants_1[_0x5c71ee(0x1eb)]+_0x5c71ee(0x1cf)]:this[_0x5c71ee(0x215)],[constants_1[_0x5c71ee(0x1eb)]+_0x5c71ee(0x1f4)]:_0x5c71ee(0x19c),[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0x5c71ee(0x207),[constants_1[_0x5c71ee(0x1eb)]+_0x5c71ee(0x227)]:this[_0x5c71ee(0x1ad)]},_0x5b8ac1={[constants_1[_0x5c71ee(0x1eb)]+'Is_Error__c']:!_0x12600c,[constants_1[_0x5c71ee(0x1eb)]+_0x5c71ee(0x1d0)]:_0x12600c,[constants_1['FLOSUM_NAMESPACE']+_0x5c71ee(0x1d2)]:_0x2d2193?status_enums_1[_0x5c71ee(0x1ec)]['EXCEPTION']:status_enums_1[_0x5c71ee(0x1ec)]['COMPLETED'],[constants_1[_0x5c71ee(0x1eb)]+_0x5c71ee(0x1fd)]:!![],[constants_1[_0x5c71ee(0x1eb)]+_0x5c71ee(0x21a)]:_0x5e958e};await this[_0x5c71ee(0x211)]['patch'](flosum_constants_1[_0x5c71ee(0x1d8)][_0x5c71ee(0x1a7)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x5c71ee(0x214)+this[_0x5c71ee(0x21f)],_0x5b8ac1),await this[_0x5c71ee(0x211)][_0x5c71ee(0x217)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x5c71ee(0x1eb)]+_0x5c71ee(0x1a9),_0xcfbf8c),this[_0x5c71ee(0x1f3)][_0x5c71ee(0x1ab)](_0x5c71ee(0x1b5)+(_0x12600c?'successfully':_0x5c71ee(0x21c))+'.'),await this[_0x5c71ee(0x1f3)]['updateLog']();}}exports['DeployService']=DeployService;