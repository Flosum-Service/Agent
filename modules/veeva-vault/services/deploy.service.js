const a358_0x522906=a358_0x282b;(function(_0x3dd1ac,_0x15387b){const _0x2b2386=a358_0x282b,_0xfc4a23=_0x3dd1ac();while(!![]){try{const _0xc9d01a=parseInt(_0x2b2386(0x111))/0x1*(parseInt(_0x2b2386(0xcc))/0x2)+parseInt(_0x2b2386(0xd4))/0x3*(-parseInt(_0x2b2386(0x12d))/0x4)+parseInt(_0x2b2386(0x115))/0x5+parseInt(_0x2b2386(0xaf))/0x6+parseInt(_0x2b2386(0x11e))/0x7+-parseInt(_0x2b2386(0x12b))/0x8+parseInt(_0x2b2386(0xf2))/0x9;if(_0xc9d01a===_0x15387b)break;else _0xfc4a23['push'](_0xfc4a23['shift']());}catch(_0xdec48b){_0xfc4a23['push'](_0xfc4a23['shift']());}}}(a358_0x3883,0xbb2f4));const a358_0x46d722=(function(){let _0x4269bb=!![];return function(_0x1dcf0e,_0x39adcd){const _0x11f147=_0x4269bb?function(){const _0x25e4cb=a358_0x282b;if(_0x39adcd){const _0x20f18d=_0x39adcd[_0x25e4cb(0xca)](_0x1dcf0e,arguments);return _0x39adcd=null,_0x20f18d;}}:function(){};return _0x4269bb=![],_0x11f147;};}()),a358_0x3d1b22=a358_0x46d722(this,function(){const _0x4ec430=a358_0x282b;return a358_0x3d1b22[_0x4ec430(0x12a)]()[_0x4ec430(0xc4)](_0x4ec430(0xb4))[_0x4ec430(0x12a)]()[_0x4ec430(0x123)](a358_0x3d1b22)['search'](_0x4ec430(0xb4));});a358_0x3d1b22();function a358_0x3883(){const _0x360eec=['Async_Request_Id__c','deploymentAction','BranchComponentHistoryFlosumComponentRetriever','slice','Success','search','Cannot\x20retrieve\x20all\x20components.','Component_Type__c','DEPLOYED','Deployment\x20Result','\x20:\x20','apply','_componentIdList','2067574CUWgbi','../constants/flosum.constants','base64','validate','createBackup','Component_History__c','Save\x20log','Save\x20Backup\x20to\x20Salesforce','3bSJvyc','_connectionVeeva','../enums/status.enums','Job_Completed__c','./package-export.service','Is_Error__c','updateLog','./veeva.service','../classes/errors/salesforce-dml-error','saveLog','length','../../../core','import','default','_vpkService','_metadataLogId','../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever','Save\x20Deployment\x20Results','formFlosumDeploymentResults','Type__c','BACKUP_ZIP_NAME','createVpk','componentType','\x20of\x20branch\x20to\x20Organization\x20','toLowerCase','COMPLETED','Join\x20all\x20mdl\x20into\x20one\x20zip','EXCEPTION','VeevaService','logError','2612898ASlAMv','with\x20error','SalesforceDmlError','Retrieving\x20attachments','/Attachment','ZipCreatorDeploy','fs/promises','shortid','get','Branch','defineProperty','</a>','FlosumComponentVeevaComponentRetriever','_instanceUrl','./vpk.service','insertMultipleRecords','Create\x20vpk\x20package','/vpk__','getFlosumComponents','Activity_Type__c','_veevaService','SalesforceService','fetchAttachmentsDetailsByParentId','patch','_salesforceService','status','\x20</a>','saveDeploymentResults','finishDeploy','application/zip','./salesforce.service','1ybHDAF','jszip','ENDPOINT_UPSERT_RECORD','timeZone','587920uMQBsz','export','VpkService','createZip','../../../constants','reduce','Branch__c','MetadataLogStatus','DeployService','3770067NufYkO','componentIdList','PackageImportService','__esModule','Body','constructor','successfully','__importDefault','_branchId','Form\x20Deployment\x20Results','branchId','Veeva\x20Deployment','toString','9571008DGPBQt','Activity_Item__c','3388348lqfnTB','../../shared/utils/fetch-attachments','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','finishDeployWithError','\x20has\x20been\x20created.','Backup','_attachmentLogId','_organisationId','_logger','type','Component_Name__c','FlosumConstants','post','PackageComponentStatus','generateAsync','<a\x20href=','Failure','FLOSUM_NAMESPACE','metadataLogId','set','Metadata_Log__c','isDeployed','_deploymentName','organisationId','Deployment_Result__c','Status__c','catch','Succeed__c','_connectionSalesforce','filter','veeva-deploy','errors','Deploy\x20completed\x20','retrieve','componentHistoryId','saveBackup','execute','Result__c','writeFile','Metadata_Log__c/','4979382Jshsqm','packageComponentList','log','values','_organisationName','(((.+)+)+)+$','name','Cannot\x20Backup\x20more\x20than\x20200\x20components.','_packageExportService','retrieveAttachments','Veeva_Step_Name__c','Logger','error','./package-import.service','_tempFolder','organisationName'];a358_0x3883=function(){return _0x360eec;};return a358_0x3883();}'use strict';var __importDefault=this&&this[a358_0x522906(0x125)]||function(_0x6ca360){const _0x4f0053=a358_0x522906;return _0x6ca360&&_0x6ca360[_0x4f0053(0x121)]?_0x6ca360:{'default':_0x6ca360};};Object[a358_0x522906(0xfc)](exports,'__esModule',{'value':!![]}),exports['DeployService']=void 0x0;const jszip_1=__importDefault(require(a358_0x522906(0x112))),promises_1=require(a358_0x522906(0xf8)),constants_1=require(a358_0x522906(0x119)),flosum_constants_1=require(a358_0x522906(0xcd)),veeva_service_1=require(a358_0x522906(0xdb)),salesforce_service_1=require(a358_0x522906(0x110)),core_1=require(a358_0x522906(0xdf)),status_enums_1=require(a358_0x522906(0xd6)),salesforce_dml_error_1=require(a358_0x522906(0xdc)),shortid_1=__importDefault(require(a358_0x522906(0xf9))),fetch_attachments_1=require(a358_0x522906(0x12e)),package_import_service_1=require(a358_0x522906(0xbc)),branch_component_history_flosum_component_retriever_1=require(a358_0x522906(0x12f)),flosum_component_veeva_component_retriever_1=require(a358_0x522906(0xe4)),package_export_service_1=require(a358_0x522906(0xd8)),vpk_service_1=require(a358_0x522906(0x100)),zip_creator_deploy_1=require('../classes/deploy/zip-creator.deploy');class DeployService{constructor(_0x4a342b,_0x4bb100,_0x23e060,_0x5e92be,_0x4e95a0,_0x41db95){const _0x44a50b=a358_0x522906;this['_connectionSalesforce']=_0x4bb100,this[_0x44a50b(0xd5)]=_0x23e060,this[_0x44a50b(0x135)]=_0x5e92be,this['_tempFolder']=_0x4e95a0,this['_instanceUrl']=_0x41db95,this['_branchId']=_0x4a342b[_0x44a50b(0x128)],this[_0x44a50b(0xe3)]=_0x4a342b[_0x44a50b(0x13f)],this[_0x44a50b(0x133)]=_0x4a342b['attachmentLogId'],this[_0x44a50b(0x134)]=_0x4a342b[_0x44a50b(0x9e)],this['_timeZone']=_0x4a342b[_0x44a50b(0x114)],this[_0x44a50b(0xb3)]=_0x4a342b[_0x44a50b(0xbe)],this[_0x44a50b(0xcb)]=_0x4a342b[_0x44a50b(0x11f)],this[_0x44a50b(0x9d)]=_0x4a342b['deploymentName'],this['_systemLogger']=new core_1[(_0x44a50b(0xba))](_0x44a50b(0xa5)),this['_veevaService']=new veeva_service_1[(_0x44a50b(0xf0))]({'connection':this['_connectionVeeva'],'logger':this[_0x44a50b(0x135)]}),this[_0x44a50b(0x10a)]=new salesforce_service_1[(_0x44a50b(0x107))]({'connection':this[_0x44a50b(0xa3)]}),this['_packageImportService']=new package_import_service_1[(_0x44a50b(0x120))]({'veevaService':this[_0x44a50b(0x106)],'connection':this[_0x44a50b(0xd5)],'logger':this[_0x44a50b(0x135)],'saveLog':this[_0x44a50b(0xdd)]['bind'](this)}),this[_0x44a50b(0xb7)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x44a50b(0x106)],'connection':this[_0x44a50b(0xd5)],'logger':this['_logger']}),this['_vpkService']=new vpk_service_1[(_0x44a50b(0x117))]({'connection':this['_connectionVeeva']});}async[a358_0x522906(0xab)](){const _0x41353b=a358_0x522906;try{const _0x34bb85=await this[_0x41353b(0x104)]();await this['_logger']['updateLog']();const _0x64121c=await this[_0x41353b(0xd0)](_0x34bb85);await this[_0x41353b(0xaa)](_0x64121c);const _0x5c5f62=await this[_0x41353b(0xb8)](_0x34bb85),_0x83389a=await this[_0x41353b(0x118)](_0x5c5f62),_0x449153=await this[_0x41353b(0xe9)](_0x83389a);await this['_logger'][_0x41353b(0xda)]();const _0x30816d=await this['_packageImportService'][_0x41353b(0xe0)](_0x449153);await this[_0x41353b(0x135)][_0x41353b(0xda)]();const _0x3fcde1=this[_0x41353b(0xe6)](_0x34bb85,_0x30816d[_0x41353b(0xb0)]);await this[_0x41353b(0x10d)](_0x3fcde1),await this[_0x41353b(0x10e)](_0x30816d[_0x41353b(0x9c)],![],_0x30816d['packageId']);}catch(_0x410f36){await this[_0x41353b(0x130)](_0x410f36)[_0x41353b(0xa1)](_0x3ed7df=>this['_systemLogger'][_0x41353b(0xbb)](_0x3ed7df));}}async['getFlosumComponents'](){const _0x1aeebf=a358_0x522906,_0x234512=new Set(this[_0x1aeebf(0xcb)]);this['_logger'][_0x1aeebf(0xb1)]('Retrieving\x20components');const _0x4aaa90=await new branch_component_history_flosum_component_retriever_1[(_0x1aeebf(0xc1))]({'value':this[_0x1aeebf(0x126)],'salesforceService':this['_salesforceService']})[_0x1aeebf(0xa8)](),_0x1ff022=_0x4aaa90[_0x1aeebf(0xa4)](_0x16233a=>_0x234512['has'](_0x16233a['id']));if(_0x1ff022[_0x1aeebf(0xde)]!==this[_0x1aeebf(0xcb)][_0x1aeebf(0xde)])throw new Error(_0x1aeebf(0xc5));return _0x1ff022;}async[a358_0x522906(0xd0)](_0x1d088a){const _0x538b00=a358_0x522906;var _0x3ab5c9;this[_0x538b00(0x135)][_0x538b00(0xb1)]('Create\x20Backup');const _0x42d20b=await new flosum_component_veeva_component_retriever_1[(_0x538b00(0xfe))]({'value':_0x1d088a,'veevaService':this['_veevaService'],'logger':this[_0x538b00(0x135)]})[_0x538b00(0xa8)](),_0x60a5bc=await this[_0x538b00(0xb7)][_0x538b00(0x116)](_0x42d20b,_0x538b00(0x132));if(_0x60a5bc['length']>0x1)throw new Error(_0x538b00(0xb6));return(_0x3ab5c9=_0x60a5bc[0x0])!==null&&_0x3ab5c9!==void 0x0?_0x3ab5c9:_0x60a5bc[0x0]=new jszip_1[(_0x538b00(0xe1))](),_0x60a5bc[0x0][_0x538b00(0x13b)]({'type':_0x538b00(0xce)});}async['saveBackup'](_0x2fe272){const _0x288e92=a358_0x522906;this['_logger']['log'](_0x288e92(0xd3));const _0xdcb497={'Body':_0x2fe272,'ContentType':_0x288e92(0x10f),'ParentId':this[_0x288e92(0xe3)],'Name':flosum_constants_1[_0x288e92(0x138)][_0x288e92(0xe8)]};await this[_0x288e92(0xa3)]['post'](flosum_constants_1[_0x288e92(0x138)]['ENDPOINT_UPSERT_RECORD']+_0x288e92(0xf6),_0xdcb497);}async[a358_0x522906(0xb8)](_0x3606ae){const _0x57503b=a358_0x522906;this[_0x57503b(0x135)][_0x57503b(0xb1)](_0x57503b(0xf5));const _0x5be9c1=await(0x0,fetch_attachments_1[_0x57503b(0x108)])(this[_0x57503b(0xa3)],_0x3606ae['map'](_0x3c128f=>_0x3c128f[_0x57503b(0xa9)])),_0x30fc84=await(0x0,fetch_attachments_1[_0x57503b(0xb8)])(_0x5be9c1,this[_0x57503b(0xa3)]);if(_0x30fc84[_0x57503b(0xde)]!==this[_0x57503b(0xcb)][_0x57503b(0xde)])throw new Error('Cannot\x20retrievers\x20all\x20attachments');return _0x30fc84['map'](_0x184662=>_0x184662[_0x57503b(0xb2)][_0x57503b(0x122)]);}async['createZip'](_0x3045dc){const _0x50726d=a358_0x522906;this['_logger'][_0x50726d(0xb1)](_0x50726d(0xee));const _0x2d6567=await new zip_creator_deploy_1[(_0x50726d(0xf7))]({'attachmentBodies':_0x3045dc,'deploymentName':this['_deploymentName']})[_0x50726d(0xab)](),_0x2fdc1c=this[_0x50726d(0xbd)]+'/'+(0x0,shortid_1[_0x50726d(0xe1)])()+'.zip';return await(0x0,promises_1[_0x50726d(0xad)])(_0x2fdc1c,_0x2d6567),_0x2fdc1c;}async[a358_0x522906(0xe9)](_0x52e912){const _0x137ac7=a358_0x522906;this[_0x137ac7(0x135)]['log'](_0x137ac7(0x102));const _0x1506a2=await this[_0x137ac7(0xe2)]['generate'](_0x52e912),_0x28220d=this['_tempFolder']+_0x137ac7(0x103)+_0x52e912[_0x137ac7(0xc2)](_0x52e912['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x137ac7(0xad)])(_0x28220d,_0x1506a2),await this[_0x137ac7(0xe2)][_0x137ac7(0xcf)](_0x28220d),_0x28220d;}async[a358_0x522906(0xdd)](_0x2c714e,_0x5e29a5){const _0x5fadd4=a358_0x522906;this[_0x5fadd4(0x135)][_0x5fadd4(0xb1)](_0x5fadd4(0xd2));const _0x5c27b5={'Body':Buffer['from'](_0x2c714e)[_0x5fadd4(0x12a)](_0x5fadd4(0xce)),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x5e29a5};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x5fadd4(0x138)]['ENDPOINT_UPSERT_RECORD']+_0x5fadd4(0xf6),_0x5c27b5);}['formFlosumDeploymentResults'](_0x5dbd63,_0x2db6f1){const _0x52d847=a358_0x522906;this['_logger'][_0x52d847(0xb1)](_0x52d847(0x127));const _0x42f46f=_0x5dbd63[_0x52d847(0x11a)]((_0x4cf6ba,_0x3a043f)=>_0x4cf6ba[_0x52d847(0x140)]((_0x3a043f[_0x52d847(0xea)]+'.'+_0x3a043f['componentName'])[_0x52d847(0xec)](),_0x3a043f),new Map());return _0x2db6f1['map'](_0x1f50b1=>{const _0x3ee469=_0x52d847;this[_0x3ee469(0x135)][_0x3ee469(0xb1)](_0x1f50b1[_0x3ee469(0x136)]+'.'+_0x1f50b1['name']+_0x3ee469(0xc9)+_0x1f50b1[_0x3ee469(0x10b)]);const _0x42adb3=(_0x1f50b1['type']+'.'+_0x1f50b1[_0x3ee469(0xb5)])[_0x3ee469(0xec)](),_0x20bab7=_0x42f46f[_0x3ee469(0xfa)](_0x42adb3);return{[constants_1[_0x3ee469(0x13e)]+_0x3ee469(0xe7)]:_0x3ee469(0xc8),[constants_1['FLOSUM_NAMESPACE']+_0x3ee469(0xa0)]:_0x1f50b1['status']===status_enums_1[_0x3ee469(0x13a)][_0x3ee469(0xc7)]?_0x3ee469(0xc3):_0x3ee469(0x13d),[constants_1[_0x3ee469(0x13e)]+_0x3ee469(0xac)]:_0x1f50b1[_0x3ee469(0xc0)],[constants_1[_0x3ee469(0x13e)]+_0x3ee469(0x137)]:_0x1f50b1[_0x3ee469(0xb5)],[constants_1[_0x3ee469(0x13e)]+_0x3ee469(0xc6)]:_0x1f50b1[_0x3ee469(0x136)],[constants_1['FLOSUM_NAMESPACE']+_0x3ee469(0xb9)]:_0x1f50b1['stepName'],[constants_1[_0x3ee469(0x13e)]+'Org__c']:this[_0x3ee469(0x134)],[constants_1[_0x3ee469(0x13e)]+_0x3ee469(0x9b)]:this[_0x3ee469(0xe3)],[constants_1[_0x3ee469(0x13e)]+_0x3ee469(0xd1)]:_0x20bab7[_0x3ee469(0xa9)]};});}async['saveDeploymentResults'](_0x40f4ed){const _0x38f7d6=a358_0x522906;this[_0x38f7d6(0x135)][_0x38f7d6(0xb1)](_0x38f7d6(0xe5));const _0x1c6230=await this[_0x38f7d6(0x10a)][_0x38f7d6(0x101)](constants_1[_0x38f7d6(0x13e)]+_0x38f7d6(0x9f),_0x40f4ed),_0x1450ed=_0x1c6230[_0x38f7d6(0xa4)](_0x15bb0c=>!_0x15bb0c['success'])['map'](_0x22820d=>_0x22820d[_0x38f7d6(0xa6)])['flat']();if(_0x1450ed[_0x38f7d6(0xde)])throw new salesforce_dml_error_1[(_0x38f7d6(0xf4))](_0x1450ed);}async[a358_0x522906(0x130)](_0x1bdc52){const _0x2daabc=a358_0x522906;this[_0x2daabc(0x135)][_0x2daabc(0xf1)](_0x1bdc52),await this[_0x2daabc(0x135)][_0x2daabc(0xda)](),await this[_0x2daabc(0x10e)](![],!![],'');}async[a358_0x522906(0x10e)](_0x29c991,_0x3ea586,_0x1bd8a5){const _0x49ec93=a358_0x522906,_0x3e8a49=_0x49ec93(0x13c)+this[_0x49ec93(0xff)]+'/'+this[_0x49ec93(0xe3)]+'\x20>\x20'+_0x49ec93(0x129)+_0x49ec93(0x10c),_0x554874=_0x49ec93(0x13c)+this[_0x49ec93(0xff)]+'/'+this[_0x49ec93(0x134)]+'\x20>'+this[_0x49ec93(0xb3)]+_0x49ec93(0xfd),_0x1bf9e8=_0x3e8a49+_0x49ec93(0xeb)+_0x554874+_0x49ec93(0x131),_0x5573c4={[constants_1[_0x49ec93(0x13e)]+'Action__c']:_0x1bf9e8,[constants_1[_0x49ec93(0x13e)]+'Date__c']:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x49ec93(0x11b)]:this[_0x49ec93(0x126)],[constants_1[_0x49ec93(0x13e)]+_0x49ec93(0x12c)]:_0x49ec93(0xfb),[constants_1[_0x49ec93(0x13e)]+_0x49ec93(0x105)]:'Deployment',[constants_1[_0x49ec93(0x13e)]+'TargetId__c']:this[_0x49ec93(0x134)]},_0x49cfa9={[constants_1[_0x49ec93(0x13e)]+_0x49ec93(0xd9)]:!_0x29c991,[constants_1[_0x49ec93(0x13e)]+_0x49ec93(0xa2)]:_0x29c991,[constants_1[_0x49ec93(0x13e)]+_0x49ec93(0xa0)]:_0x3ea586?status_enums_1['MetadataLogStatus'][_0x49ec93(0xef)]:status_enums_1[_0x49ec93(0x11c)][_0x49ec93(0xed)],[constants_1[_0x49ec93(0x13e)]+_0x49ec93(0xd7)]:!![],[constants_1[_0x49ec93(0x13e)]+_0x49ec93(0xbf)]:_0x1bd8a5};await this[_0x49ec93(0xa3)][_0x49ec93(0x109)](flosum_constants_1[_0x49ec93(0x138)][_0x49ec93(0x113)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x49ec93(0xae)+this[_0x49ec93(0xe3)],_0x49cfa9),await this['_connectionSalesforce'][_0x49ec93(0x139)](flosum_constants_1[_0x49ec93(0x138)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0x5573c4),this[_0x49ec93(0x135)][_0x49ec93(0xb1)](_0x49ec93(0xa7)+(_0x29c991?_0x49ec93(0x124):_0x49ec93(0xf3))+'.'),await this[_0x49ec93(0x135)][_0x49ec93(0xda)]();}}function a358_0x282b(_0x512710,_0x4f4847){const _0x271fe4=a358_0x3883();return a358_0x282b=function(_0x3d1b22,_0x46d722){_0x3d1b22=_0x3d1b22-0x9b;let _0x3883f1=_0x271fe4[_0x3d1b22];return _0x3883f1;},a358_0x282b(_0x512710,_0x4f4847);}exports[a358_0x522906(0x11d)]=DeployService;