const a358_0x2e9361=a358_0x1ec1;(function(_0x311301,_0x54ccb1){const _0x1c74b2=a358_0x1ec1,_0x27d172=_0x311301();while(!![]){try{const _0x38e09d=-parseInt(_0x1c74b2(0x1ad))/0x1+-parseInt(_0x1c74b2(0x144))/0x2*(parseInt(_0x1c74b2(0x17e))/0x3)+-parseInt(_0x1c74b2(0x18b))/0x4+parseInt(_0x1c74b2(0x191))/0x5*(-parseInt(_0x1c74b2(0x1d1))/0x6)+-parseInt(_0x1c74b2(0x148))/0x7*(parseInt(_0x1c74b2(0x15e))/0x8)+-parseInt(_0x1c74b2(0x1b9))/0x9*(parseInt(_0x1c74b2(0x15a))/0xa)+parseInt(_0x1c74b2(0x156))/0xb*(parseInt(_0x1c74b2(0x196))/0xc);if(_0x38e09d===_0x54ccb1)break;else _0x27d172['push'](_0x27d172['shift']());}catch(_0x7611c7){_0x27d172['push'](_0x27d172['shift']());}}}(a358_0x575a,0xe73bf));function a358_0x1ec1(_0x2006ec,_0x5d0a91){const _0x191dd0=a358_0x575a();return a358_0x1ec1=function(_0x13767a,_0x3e1e61){_0x13767a=_0x13767a-0x13f;let _0x575adf=_0x191dd0[_0x13767a];return _0x575adf;},a358_0x1ec1(_0x2006ec,_0x5d0a91);}const a358_0x3e1e61=(function(){let _0x5881f3=!![];return function(_0x3357cd,_0x541af6){const _0x441edd=_0x5881f3?function(){const _0x24ede4=a358_0x1ec1;if(_0x541af6){const _0xca4070=_0x541af6[_0x24ede4(0x18c)](_0x3357cd,arguments);return _0x541af6=null,_0xca4070;}}:function(){};return _0x5881f3=![],_0x441edd;};}()),a358_0x13767a=a358_0x3e1e61(this,function(){const _0x5507e9=a358_0x1ec1;return a358_0x13767a[_0x5507e9(0x15f)]()['search'](_0x5507e9(0x15c))[_0x5507e9(0x15f)]()[_0x5507e9(0x166)](a358_0x13767a)['search'](_0x5507e9(0x15c));});a358_0x13767a();'use strict';var __importDefault=this&&this[a358_0x2e9361(0x1ab)]||function(_0x39693c){return _0x39693c&&_0x39693c['__esModule']?_0x39693c:{'default':_0x39693c};};Object[a358_0x2e9361(0x182)](exports,'__esModule',{'value':!![]}),exports[a358_0x2e9361(0x1c5)]=void 0x0;const jszip_1=__importDefault(require('jszip')),promises_1=require(a358_0x2e9361(0x171)),constants_1=require(a358_0x2e9361(0x13f)),flosum_constants_1=require(a358_0x2e9361(0x1be)),veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a358_0x2e9361(0x150)),core_1=require('../../../core'),status_enums_1=require(a358_0x2e9361(0x1b1)),salesforce_dml_error_1=require(a358_0x2e9361(0x168)),shortid_1=__importDefault(require(a358_0x2e9361(0x174))),fetch_attachments_1=require(a358_0x2e9361(0x141)),package_import_service_1=require(a358_0x2e9361(0x143)),branch_component_history_flosum_component_retriever_1=require(a358_0x2e9361(0x175)),flosum_component_veeva_component_retriever_1=require('../classes/retrievers/veeva-components/flosum-component.veeva-component.retriever'),package_export_service_1=require('./package-export.service'),vpk_service_1=require(a358_0x2e9361(0x1b7)),zip_creator_deploy_1=require(a358_0x2e9361(0x1bb));class DeployService{constructor(_0x316c39,_0x3bf7c5,_0x273c04,_0xf80626,_0x4a63ac,_0x127fff){const _0x157b36=a358_0x2e9361;this[_0x157b36(0x1ca)]=_0x3bf7c5,this[_0x157b36(0x16e)]=_0x273c04,this[_0x157b36(0x184)]=_0xf80626,this[_0x157b36(0x165)]=_0x4a63ac,this['_instanceUrl']=_0x127fff,this[_0x157b36(0x1b6)]=_0x316c39[_0x157b36(0x1c4)],this[_0x157b36(0x1d4)]=_0x316c39[_0x157b36(0x1d6)],this[_0x157b36(0x151)]=_0x316c39['attachmentLogId'],this[_0x157b36(0x1c8)]=_0x316c39[_0x157b36(0x161)],this[_0x157b36(0x1a1)]=_0x316c39[_0x157b36(0x180)],this[_0x157b36(0x17a)]=_0x316c39['organisationName'],this[_0x157b36(0x183)]=_0x316c39[_0x157b36(0x14a)],this[_0x157b36(0x19d)]=_0x316c39[_0x157b36(0x170)],this[_0x157b36(0x1d5)]=new core_1['Logger']('veeva-deploy'),this[_0x157b36(0x1c2)]=new veeva_service_1['VeevaService']({'connection':this[_0x157b36(0x16e)],'logger':this[_0x157b36(0x184)]}),this['_salesforceService']=new salesforce_service_1[(_0x157b36(0x1a6))]({'connection':this[_0x157b36(0x1ca)]}),this['_packageImportService']=new package_import_service_1[(_0x157b36(0x16b))]({'veevaService':this[_0x157b36(0x1c2)],'connection':this[_0x157b36(0x16e)],'logger':this[_0x157b36(0x184)],'saveLog':this['saveLog']['bind'](this)}),this[_0x157b36(0x14f)]=new package_export_service_1['PackageExportService']({'veevaService':this[_0x157b36(0x1c2)],'connection':this[_0x157b36(0x16e)],'logger':this[_0x157b36(0x184)]}),this[_0x157b36(0x1aa)]=new vpk_service_1[(_0x157b36(0x1ae))]({'connection':this[_0x157b36(0x16e)]});}async[a358_0x2e9361(0x195)](){const _0xc2be0a=a358_0x2e9361;try{const _0x53c9bb=await this['getFlosumComponents']();await this['_logger'][_0xc2be0a(0x1b8)]();const _0x3a6aba=await this[_0xc2be0a(0x1a3)](_0x53c9bb);await this['saveBackup'](_0x3a6aba);const _0x3c1016=await this[_0xc2be0a(0x1c9)](_0x53c9bb),_0x5eac64=await this[_0xc2be0a(0x1bd)](_0x3c1016),_0x530c85=await this[_0xc2be0a(0x189)](_0x5eac64);await this[_0xc2be0a(0x184)][_0xc2be0a(0x1b8)]();const _0x2d15f3=await this['_packageImportService']['import'](_0x530c85);await this[_0xc2be0a(0x184)]['updateLog']();const _0x1179c7=this['formFlosumDeploymentResults'](_0x53c9bb,_0x2d15f3['packageComponentList']);await this[_0xc2be0a(0x1a2)](_0x1179c7),await this[_0xc2be0a(0x158)](_0x2d15f3[_0xc2be0a(0x14c)],![],_0x2d15f3[_0xc2be0a(0x1d2)]);}catch(_0x4cdea2){await this['finishDeployWithError'](_0x4cdea2)[_0xc2be0a(0x1af)](_0x5184df=>this[_0xc2be0a(0x1d5)][_0xc2be0a(0x190)](_0x5184df));}}async[a358_0x2e9361(0x146)](){const _0x2e3b4d=a358_0x2e9361,_0x116d7f=new Set(this[_0x2e3b4d(0x183)]);this['_logger'][_0x2e3b4d(0x147)]('Retrieving\x20components');const _0x4a064d=await new branch_component_history_flosum_component_retriever_1[(_0x2e3b4d(0x152))]({'value':this[_0x2e3b4d(0x1b6)],'salesforceService':this[_0x2e3b4d(0x1d9)]})[_0x2e3b4d(0x1dc)](),_0x2f2934=_0x4a064d['filter'](_0xf01f12=>_0x116d7f['has'](_0xf01f12['id']));if(_0x2f2934['length']!==this[_0x2e3b4d(0x183)][_0x2e3b4d(0x181)])throw new Error('Cannot\x20retrieve\x20all\x20components.');return _0x2f2934;}async[a358_0x2e9361(0x1a3)](_0x5938b1){const _0x22d3b5=a358_0x2e9361;var _0x42cf8c;this[_0x22d3b5(0x184)]['log'](_0x22d3b5(0x1c0));const _0x5587c4=await new flosum_component_veeva_component_retriever_1['FlosumComponentVeevaComponentRetriever']({'value':_0x5938b1,'veevaService':this[_0x22d3b5(0x1c2)],'logger':this['_logger']})['retrieve'](),_0x5c6640=await this[_0x22d3b5(0x14f)][_0x22d3b5(0x18a)](_0x5587c4,_0x22d3b5(0x186));if(_0x5c6640[_0x22d3b5(0x181)]>0x1)throw new Error(_0x22d3b5(0x15d));return(_0x42cf8c=_0x5c6640[0x0])!==null&&_0x42cf8c!==void 0x0?_0x42cf8c:_0x5c6640[0x0]=new jszip_1['default'](),_0x5c6640[0x0][_0x22d3b5(0x178)]({'type':_0x22d3b5(0x164)});}async[a358_0x2e9361(0x1cf)](_0x288f5a){const _0x244426=a358_0x2e9361;this[_0x244426(0x184)][_0x244426(0x147)](_0x244426(0x1a7));const _0x51903f={'Body':_0x288f5a,'ContentType':_0x244426(0x1d8),'ParentId':this[_0x244426(0x1d4)],'Name':flosum_constants_1[_0x244426(0x19b)]['BACKUP_ZIP_NAME']};await this[_0x244426(0x1ca)][_0x244426(0x1da)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0x244426(0x1ce),_0x51903f);}async['retrieveAttachments'](_0x12107b){const _0x21879b=a358_0x2e9361;this[_0x21879b(0x184)][_0x21879b(0x147)](_0x21879b(0x149));const _0x313292=await(0x0,fetch_attachments_1[_0x21879b(0x1b5)])(this[_0x21879b(0x1ca)],_0x12107b[_0x21879b(0x1a8)](_0x4037b1=>_0x4037b1['componentHistoryId'])),_0x28e8f9=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x313292,this[_0x21879b(0x1ca)]);if(_0x28e8f9[_0x21879b(0x181)]!==this['_componentIdList'][_0x21879b(0x181)])throw new Error(_0x21879b(0x1a4));return _0x28e8f9[_0x21879b(0x1a8)](_0x538a42=>_0x538a42[_0x21879b(0x19e)][_0x21879b(0x192)]);}async[a358_0x2e9361(0x1bd)](_0x12a35d){const _0x2ddff5=a358_0x2e9361;this[_0x2ddff5(0x184)][_0x2ddff5(0x147)](_0x2ddff5(0x14b));const _0x5e60df=await new zip_creator_deploy_1['ZipCreatorDeploy']({'attachmentBodies':_0x12a35d,'deploymentName':this[_0x2ddff5(0x19d)]})['execute'](),_0x88a8a9=this[_0x2ddff5(0x165)]+'/'+(0x0,shortid_1[_0x2ddff5(0x18e)])()+'.zip';return await(0x0,promises_1[_0x2ddff5(0x162)])(_0x88a8a9,_0x5e60df),_0x88a8a9;}async[a358_0x2e9361(0x189)](_0x3090ec){const _0x4ffa4e=a358_0x2e9361;this[_0x4ffa4e(0x184)][_0x4ffa4e(0x147)](_0x4ffa4e(0x194));const _0x24b2b2=await this[_0x4ffa4e(0x1aa)][_0x4ffa4e(0x188)](_0x3090ec),_0x166987=this[_0x4ffa4e(0x165)]+_0x4ffa4e(0x172)+_0x3090ec[_0x4ffa4e(0x1ba)](_0x3090ec[_0x4ffa4e(0x1b3)]('/')+0x1);return await(0x0,promises_1[_0x4ffa4e(0x162)])(_0x166987,_0x24b2b2),await this[_0x4ffa4e(0x1aa)][_0x4ffa4e(0x1cc)](_0x166987),_0x166987;}async['saveLog'](_0x371aa4,_0x3301f6){const _0x552dfa=a358_0x2e9361;this[_0x552dfa(0x184)][_0x552dfa(0x147)]('Save\x20log');const _0x5868c2={'Body':Buffer['from'](_0x371aa4)[_0x552dfa(0x15f)]('base64'),'ContentType':_0x552dfa(0x1a0),'ParentId':this['_metadataLogId'],'Name':_0x3301f6};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x552dfa(0x19b)]['ENDPOINT_UPSERT_RECORD']+_0x552dfa(0x1ce),_0x5868c2);}[a358_0x2e9361(0x185)](_0x888123,_0x50a41b){const _0x19ba0b=a358_0x2e9361;this['_logger']['log'](_0x19ba0b(0x19a));const _0x525e00=_0x888123[_0x19ba0b(0x1bf)]((_0x36204d,_0x282006)=>_0x36204d[_0x19ba0b(0x157)]((_0x282006['componentType']+'.'+_0x282006[_0x19ba0b(0x14d)])[_0x19ba0b(0x1c1)](),_0x282006),new Map());return _0x50a41b[_0x19ba0b(0x1a8)](_0x2e6b70=>{const _0x41378f=_0x19ba0b;this[_0x41378f(0x184)][_0x41378f(0x147)](_0x2e6b70[_0x41378f(0x16a)]+'.'+_0x2e6b70[_0x41378f(0x159)]+_0x41378f(0x155)+_0x2e6b70['status']);const _0x5502d7=(_0x2e6b70[_0x41378f(0x16a)]+'.'+_0x2e6b70[_0x41378f(0x159)])['toLowerCase'](),_0x221fff=_0x525e00[_0x41378f(0x18d)](_0x5502d7);return{[constants_1[_0x41378f(0x197)]+_0x41378f(0x14e)]:'Deployment\x20Result',[constants_1[_0x41378f(0x197)]+_0x41378f(0x1b4)]:_0x2e6b70[_0x41378f(0x173)]===status_enums_1[_0x41378f(0x1d7)][_0x41378f(0x140)]?'Success':_0x41378f(0x169),[constants_1[_0x41378f(0x197)]+_0x41378f(0x19c)]:_0x2e6b70[_0x41378f(0x1a9)],[constants_1[_0x41378f(0x197)]+'Component_Name__c']:_0x2e6b70['name'],[constants_1[_0x41378f(0x197)]+_0x41378f(0x1a5)]:_0x2e6b70['type'],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Step_Name__c']:_0x2e6b70[_0x41378f(0x187)],[constants_1[_0x41378f(0x197)]+_0x41378f(0x1b0)]:this[_0x41378f(0x1c8)],[constants_1[_0x41378f(0x197)]+'Metadata_Log__c']:this[_0x41378f(0x1d4)],[constants_1[_0x41378f(0x197)]+'Component_History__c']:_0x221fff[_0x41378f(0x16d)]};});}async[a358_0x2e9361(0x1a2)](_0x8c4d1e){const _0x23f8ae=a358_0x2e9361;this[_0x23f8ae(0x184)][_0x23f8ae(0x147)](_0x23f8ae(0x163));const _0xba60a3=await this[_0x23f8ae(0x1d9)]['insertMultipleRecords'](constants_1[_0x23f8ae(0x197)]+_0x23f8ae(0x1c3),_0x8c4d1e),_0x5459d8=_0xba60a3[_0x23f8ae(0x167)](_0x527e81=>!_0x527e81['success'])[_0x23f8ae(0x1a8)](_0x38afe2=>_0x38afe2[_0x23f8ae(0x1db)])[_0x23f8ae(0x154)]();if(_0x5459d8[_0x23f8ae(0x181)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x5459d8);}async[a358_0x2e9361(0x17c)](_0x2b8ac6){const _0x5ea99a=a358_0x2e9361;this[_0x5ea99a(0x184)][_0x5ea99a(0x1c6)](_0x2b8ac6),await this['_logger'][_0x5ea99a(0x1b8)](),await this['finishDeploy'](![],!![],'');}async[a358_0x2e9361(0x158)](_0x11dbe3,_0x3194fe,_0x20673a){const _0x2f1f07=a358_0x2e9361,_0x75ae3d=_0x2f1f07(0x1ac)+this[_0x2f1f07(0x17f)]+'/'+this[_0x2f1f07(0x1d4)]+'\x20>\x20'+_0x2f1f07(0x177)+_0x2f1f07(0x17d),_0x1dc41b=_0x2f1f07(0x1ac)+this[_0x2f1f07(0x17f)]+'/'+this[_0x2f1f07(0x1c8)]+'\x20>'+this[_0x2f1f07(0x17a)]+_0x2f1f07(0x1d3),_0x908a7f=_0x75ae3d+_0x2f1f07(0x153)+_0x1dc41b+_0x2f1f07(0x1b2),_0x3bac45={[constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x18f)]:_0x908a7f,[constants_1['FLOSUM_NAMESPACE']+_0x2f1f07(0x17b)]:new Date(),[constants_1[_0x2f1f07(0x197)]+'Branch__c']:this[_0x2f1f07(0x1b6)],[constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x199)]:_0x2f1f07(0x1cd),[constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x160)]:_0x2f1f07(0x179),[constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x1d0)]:this[_0x2f1f07(0x1c8)]},_0x375002={[constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x1bc)]:!_0x11dbe3,[constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x198)]:_0x11dbe3,[constants_1['FLOSUM_NAMESPACE']+_0x2f1f07(0x1b4)]:_0x3194fe?status_enums_1[_0x2f1f07(0x176)]['EXCEPTION']:status_enums_1[_0x2f1f07(0x176)][_0x2f1f07(0x16c)],[constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x15b)]:!![],[constants_1[_0x2f1f07(0x197)]+'External_Deployment_Id__c']:_0x20673a};await this[_0x2f1f07(0x1ca)][_0x2f1f07(0x145)](flosum_constants_1[_0x2f1f07(0x19b)][_0x2f1f07(0x193)]+'/'+constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x142)+this[_0x2f1f07(0x1d4)],_0x375002),await this[_0x2f1f07(0x1ca)][_0x2f1f07(0x1da)](flosum_constants_1[_0x2f1f07(0x19b)][_0x2f1f07(0x193)]+'/'+constants_1[_0x2f1f07(0x197)]+_0x2f1f07(0x16f),_0x3bac45),this['_logger']['log'](_0x2f1f07(0x1c7)+(_0x11dbe3?_0x2f1f07(0x19f):_0x2f1f07(0x1cb))+'.'),await this[_0x2f1f07(0x184)]['updateLog']();}}function a358_0x575a(){const _0xf77954=['_attachmentLogId','BranchComponentHistoryFlosumComponentRetriever','\x20of\x20branch\x20to\x20Organization\x20','flat','\x20:\x20','11JJrgge','set','finishDeploy','name','10prpaif','Job_Completed__c','(((.+)+)+)+$','Cannot\x20Backup\x20more\x20than\x20200\x20components.','64672CmoGCW','toString','Activity_Type__c','organisationId','writeFile','Save\x20Deployment\x20Results','base64','_tempFolder','constructor','filter','../classes/errors/salesforce-dml-error','Failure','type','PackageImportService','COMPLETED','componentHistoryId','_connectionVeeva','Log__c','deploymentName','fs/promises','/vpk__','status','shortid','../classes/retrievers/flosum-components/branch-component-history.flosum-component.retriever','MetadataLogStatus','Veeva\x20Deployment','generateAsync','Deployment','_organisationName','Date__c','finishDeployWithError','\x20</a>','60AiWVWk','_instanceUrl','timeZone','length','defineProperty','_componentIdList','_logger','formFlosumDeploymentResults','Backup','stepName','generate','createVpk','export','6006404KVRqrC','apply','get','default','Action__c','error','890fpasBr','Body','ENDPOINT_UPSERT_RECORD','Create\x20vpk\x20package','execute','97223016SeiCai','FLOSUM_NAMESPACE','Succeed__c','Activity_Item__c','Form\x20Deployment\x20Results','FlosumConstants','Result__c','_deploymentName','values','successfully','text/plain','_timeZone','saveDeploymentResults','createBackup','Cannot\x20retrievers\x20all\x20attachments','Component_Type__c','SalesforceService','Save\x20Backup\x20to\x20Salesforce','map','deploymentAction','_vpkService','__importDefault','<a\x20href=','1560088BxtNLj','VpkService','catch','Org__c','../enums/status.enums','\x20has\x20been\x20created.','lastIndexOf','Status__c','fetchAttachmentsDetailsByParentId','_branchId','./vpk.service','updateLog','15872994zaNxCn','slice','../classes/deploy/zip-creator.deploy','Is_Error__c','createZip','../constants/flosum.constants','reduce','Create\x20Backup','toLowerCase','_veevaService','Deployment_Result__c','branchId','DeployService','logError','Deploy\x20completed\x20','_organisationId','retrieveAttachments','_connectionSalesforce','with\x20error','validate','Branch','/Attachment','saveBackup','TargetId__c','28464DXzAIL','packageId','</a>','_metadataLogId','_systemLogger','metadataLogId','PackageComponentStatus','application/zip','_salesforceService','post','errors','retrieve','../../../constants','DEPLOYED','../../shared/utils/fetch-attachments','Metadata_Log__c/','./package-import.service','7838EYWlwn','patch','getFlosumComponents','log','1218OlrESw','Retrieving\x20attachments','componentIdList','Join\x20all\x20mdl\x20into\x20one\x20zip','isDeployed','componentName','Type__c','_packageExportService','./salesforce.service'];a358_0x575a=function(){return _0xf77954;};return a358_0x575a();}exports[a358_0x2e9361(0x1c5)]=DeployService;