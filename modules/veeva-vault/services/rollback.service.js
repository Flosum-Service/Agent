function a404_0x3a8d(){const _0x31a3a8=['saveDeploymentResults','Date__c','lastIndexOf','stepName','./salesforce.service','_metadataLog','Org__c','retrieveDeploymentResults','6576656SKDoLw','SalesforceDmlError','patch','with\x20error','Deployment_Result__c','from','29215DknTAs','success','Cannot\x20find\x20Deployment\x20Results','Branch','Activity_Type__c','retrieveRecords','validate','.zip','DEPLOYED','1086XBbRgg','retrieve','map','Type__c','fetchAttachmentsDetailsById','<a\x20href=','PackageComponentStatus','insertMultipleRecords','Retrieve\x20Metadata\x20Log\x20info','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Form\x20Deployment\x20Results','error','_logger','2498787dgmEUk','EXCEPTION','length','Is_Error__c','../constants/flosum.constants','\x20has\x20been\x20created.','organizationId','19463290tWEuYh','default','Create\x20Vpk\x20package','External_Deployment_Id__c','post','Activity_Item__c','status','Component_Type__c','updateLog','PackageImportService','FLOSUM_NAMESPACE','_instanceUrl','182uIAlaY','52hfeRLM','Action__c','./vpk.service','packageId','Metadata_Log__c/','Cannot\x20find\x20Backup\x20Zip','Log__c','ZipCreatorRollback','Success','createZip','Metadata_Log__c','\x27\x0a\x20\x20\x20\x20','_tempFolder','logError','../classes/errors/salesforce-dml-error','execute','retrieveMetadataLog','Save\x20Deployment\x20Results','Rollback\x20completed\x20','_componentIds','Failure','598392kineMT','_systemLogger','isDeployed','\x20:\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','create','../../shared/utils/fetch-attachments','\x20of\x20branch\x20to\x20Organization\x20','_veevaService','ENDPOINT_UPSERT_RECORD','Job_Completed__c','finishRollback','__esModule','</a>','_timeZone','retrieveAttachments','COMPLETED','_parentMetadataLogId','Deployment','_packageImportService','VpkService','Retrieve\x20Deployment\x20Results','errors','fs/promises','log','Retrieve\x20Backup','_vpkService','createVpk','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','158046rAQyNf','\x20</a>','../../../constants','retrieveBackup','Deployment\x20Result','Body','/Attachment','../classes/retrievers/deployment-results/id.deployment-result.retriever','finishRollbackWithError','formFlosumDeploymentResults','writeFile','RollbackService','1536RjxNyG','Logger','(((.+)+)+)+$','MetadataLogDto','VeevaService','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','../classes/rollback/zip-creator.rollback','Result__c','filter','_salesforceService','type','FlosumConstants','../enums/status.enums','_connectionVeeva','_connectionSalesforce','generate','constructor','BACKUP_ZIP_NAME','toString','_attachmentLogId','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x27\x20AND\x20Name\x20=\x20\x27','name','base64','packageComponentList','successfully','saveLog','values','../dtos/metadata-log.dto','veeva-rollback','MetadataLogStatus','_metadataLogId','Status__c','./package-import.service','Veeva\x20Rollback\x20(Deployment)','Succeed__c','Create\x20zip\x20from\x20backup','bind'];a404_0x3a8d=function(){return _0x31a3a8;};return a404_0x3a8d();}const a404_0x493bc3=a404_0x32ad;(function(_0x186604,_0x14d6a9){const _0x45605e=a404_0x32ad,_0xb7850c=_0x186604();while(!![]){try{const _0x37f4e0=parseInt(_0x45605e(0x117))/0x1*(-parseInt(_0x45605e(0x154))/0x2)+parseInt(_0x45605e(0x161))/0x3+-parseInt(_0x45605e(0x175))/0x4*(parseInt(_0x45605e(0x14b))/0x5)+-parseInt(_0x45605e(0x10b))/0x6*(parseInt(_0x45605e(0x174))/0x7)+-parseInt(_0x45605e(0x145))/0x8+parseInt(_0x45605e(0x18a))/0x9+parseInt(_0x45605e(0x168))/0xa;if(_0x37f4e0===_0x14d6a9)break;else _0xb7850c['push'](_0xb7850c['shift']());}catch(_0x318a2e){_0xb7850c['push'](_0xb7850c['shift']());}}}(a404_0x3a8d,0x68af7));const a404_0x2fdfd1=(function(){let _0x1c6e20=!![];return function(_0x4a6cc9,_0x54d6c5){const _0x3ff30e=_0x1c6e20?function(){if(_0x54d6c5){const _0x2c291e=_0x54d6c5['apply'](_0x4a6cc9,arguments);return _0x54d6c5=null,_0x2c291e;}}:function(){};return _0x1c6e20=![],_0x3ff30e;};}()),a404_0x29d862=a404_0x2fdfd1(this,function(){const _0x391ddb=a404_0x32ad;return a404_0x29d862[_0x391ddb(0x129)]()['search']('(((.+)+)+)+$')[_0x391ddb(0x129)]()[_0x391ddb(0x127)](a404_0x29d862)['search'](_0x391ddb(0x119));});a404_0x29d862();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2c933d){const _0x51eda5=a404_0x32ad;return _0x2c933d&&_0x2c933d[_0x51eda5(0x196)]?_0x2c933d:{'default':_0x2c933d};};Object['defineProperty'](exports,a404_0x493bc3(0x196),{'value':!![]}),exports[a404_0x493bc3(0x116)]=void 0x0;function a404_0x32ad(_0x562c52,_0x1c22e7){const _0x105b95=a404_0x3a8d();return a404_0x32ad=function(_0x29d862,_0x2fdfd1){_0x29d862=_0x29d862-0x10b;let _0x3a8db4=_0x105b95[_0x29d862];return _0x3a8db4;},a404_0x32ad(_0x562c52,_0x1c22e7);}const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a404_0x493bc3(0x141)),package_import_service_1=require(a404_0x493bc3(0x138)),id_deployment_result_retriever_1=require(a404_0x493bc3(0x112)),flosum_constants_1=require(a404_0x493bc3(0x165)),fetch_attachments_1=require(a404_0x493bc3(0x190)),constants_1=require(a404_0x493bc3(0x10d)),zip_creator_rollback_1=require(a404_0x493bc3(0x11d)),shortid_1=__importDefault(require('shortid')),promises_1=require(a404_0x493bc3(0x1a1)),vpk_service_1=require(a404_0x493bc3(0x177)),status_enums_1=require(a404_0x493bc3(0x123)),salesforce_dml_error_1=require(a404_0x493bc3(0x183)),metadata_log_dto_1=require(a404_0x493bc3(0x133)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0xa8425e,connectionVeeva:_0x373795,logger:_0x3dc157,tempFolder:_0x138f87,instanceUrl:_0x1e1c88,timeZone:_0x25b24f,metadataLogId:_0x9a1bc1,attachmentLogId:_0x9dc59b,parentMetadataLogId:_0x24dd20,componentIds:_0x33af09}){const _0x431796=a404_0x493bc3;this[_0x431796(0x125)]=_0xa8425e,this[_0x431796(0x124)]=_0x373795,this[_0x431796(0x160)]=_0x3dc157,this['_tempFolder']=_0x138f87,this[_0x431796(0x173)]=_0x1e1c88,this[_0x431796(0x198)]=_0x25b24f,this[_0x431796(0x136)]=_0x9a1bc1,this[_0x431796(0x12a)]=_0x9dc59b,this['_parentMetadataLogId']=_0x24dd20,this[_0x431796(0x188)]=_0x33af09,this[_0x431796(0x18b)]=new core_1[(_0x431796(0x118))](_0x431796(0x134)),this['_veevaService']=new veeva_service_1[(_0x431796(0x11b))]({'connection':_0x373795,'logger':_0x3dc157}),this[_0x431796(0x120)]=new salesforce_service_1['SalesforceService']({'connection':_0xa8425e}),this[_0x431796(0x19d)]=new package_import_service_1[(_0x431796(0x171))]({'veevaService':this[_0x431796(0x192)],'connection':_0x373795,'logger':_0x3dc157,'saveLog':this[_0x431796(0x131)][_0x431796(0x13c)](this)}),this[_0x431796(0x1a4)]=new vpk_service_1[(_0x431796(0x19e))]({'connection':_0x373795});}async['saveLog'](_0x10710d,_0xb0f801){const _0x24f1f0=a404_0x493bc3;this[_0x24f1f0(0x160)][_0x24f1f0(0x1a2)]('Save\x20log');const _0x18994c={'Body':Buffer[_0x24f1f0(0x14a)](_0x10710d)[_0x24f1f0(0x129)](_0x24f1f0(0x12e)),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0xb0f801};await this[_0x24f1f0(0x125)][_0x24f1f0(0x16c)](flosum_constants_1['FlosumConstants'][_0x24f1f0(0x193)]+_0x24f1f0(0x111),_0x18994c);}async[a404_0x493bc3(0x185)](){const _0x4cb969=a404_0x493bc3;this[_0x4cb969(0x160)]['log'](_0x4cb969(0x15c));const [_0x5edb81]=await this[_0x4cb969(0x120)]['retrieveRecords'](_0x4cb969(0x18e)+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x4cb969(0x172)]+_0x4cb969(0x12b)+constants_1[_0x4cb969(0x172)]+_0x4cb969(0x1a6)+constants_1['FLOSUM_NAMESPACE']+_0x4cb969(0x15d)+this['_metadataLogId']+_0x4cb969(0x180));return new metadata_log_dto_1[(_0x4cb969(0x11a))](_0x5edb81);}async[a404_0x493bc3(0x144)](){const _0x21fc45=a404_0x493bc3;this[_0x21fc45(0x160)]['log'](_0x21fc45(0x19f));const _0x4e330c=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this['_salesforceService'],'value':this['_componentIds']})[_0x21fc45(0x155)]();if(!_0x4e330c['length'])throw new Error(_0x21fc45(0x14d));return _0x4e330c;}async['retrieveBackup'](){const _0x2dd6fa=a404_0x493bc3;this[_0x2dd6fa(0x160)][_0x2dd6fa(0x1a2)](_0x2dd6fa(0x1a3));const _0x16a5b7=await this[_0x2dd6fa(0x120)][_0x2dd6fa(0x150)](_0x2dd6fa(0x11c)+this[_0x2dd6fa(0x19b)]+_0x2dd6fa(0x12c)+flosum_constants_1[_0x2dd6fa(0x122)][_0x2dd6fa(0x128)]+_0x2dd6fa(0x180)),_0x3bbd73=await(0x0,fetch_attachments_1[_0x2dd6fa(0x158)])(this[_0x2dd6fa(0x125)],[_0x16a5b7[0x0]['Id']]),_0x25d474=await(0x0,fetch_attachments_1[_0x2dd6fa(0x199)])(_0x3bbd73,this[_0x2dd6fa(0x125)]);if(!_0x25d474[_0x2dd6fa(0x163)])throw new Error(_0x2dd6fa(0x17a));return _0x25d474[0x0][_0x2dd6fa(0x132)][_0x2dd6fa(0x110)];}async['createZip'](_0x5cb906){const _0x255d78=a404_0x493bc3;this[_0x255d78(0x160)][_0x255d78(0x1a2)](_0x255d78(0x13b));const _0x37c07f=await this[_0x255d78(0x10e)](),_0x31e60a=await new zip_creator_rollback_1[(_0x255d78(0x17c))]({'rollbackName':this[_0x255d78(0x142)][_0x255d78(0x12d)],'backup':_0x37c07f,'deploymentResults':_0x5cb906})[_0x255d78(0x18f)](),_0x6fba7f=this[_0x255d78(0x181)]+'/'+(0x0,shortid_1[_0x255d78(0x169)])()+_0x255d78(0x152);return await(0x0,promises_1[_0x255d78(0x115)])(_0x6fba7f,_0x31e60a),_0x6fba7f;}async[a404_0x493bc3(0x1a5)](_0x5689b7){const _0x3ce26a=a404_0x493bc3;this['_logger'][_0x3ce26a(0x1a2)](_0x3ce26a(0x16a));const _0x318a40=await this[_0x3ce26a(0x1a4)][_0x3ce26a(0x126)](_0x5689b7),_0x318680=this[_0x3ce26a(0x181)]+'/vpk__'+_0x5689b7['slice'](_0x5689b7[_0x3ce26a(0x13f)]('/')+0x1);return await(0x0,promises_1[_0x3ce26a(0x115)])(_0x318680,_0x318a40),await this['_vpkService'][_0x3ce26a(0x151)](_0x318680),_0x318680;}[a404_0x493bc3(0x114)](_0x147616){const _0x3675e0=a404_0x493bc3;return this[_0x3675e0(0x160)]['log'](_0x3675e0(0x15e)),_0x147616[_0x3675e0(0x156)](_0x2f40fc=>{const _0x47e268=_0x3675e0;return this[_0x47e268(0x160)]['log'](_0x2f40fc[_0x47e268(0x121)]+'.'+_0x2f40fc[_0x47e268(0x12d)]+_0x47e268(0x18d)+_0x2f40fc[_0x47e268(0x16e)]),{[constants_1[_0x47e268(0x172)]+_0x47e268(0x157)]:_0x47e268(0x10f),[constants_1[_0x47e268(0x172)]+_0x47e268(0x137)]:_0x2f40fc[_0x47e268(0x16e)]===status_enums_1[_0x47e268(0x15a)][_0x47e268(0x153)]?_0x47e268(0x17d):_0x47e268(0x189),[constants_1['FLOSUM_NAMESPACE']+_0x47e268(0x11e)]:_0x2f40fc['deploymentAction'],[constants_1[_0x47e268(0x172)]+'Component_Name__c']:_0x2f40fc[_0x47e268(0x12d)],[constants_1['FLOSUM_NAMESPACE']+_0x47e268(0x16f)]:_0x2f40fc[_0x47e268(0x121)],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Step_Name__c']:_0x2f40fc[_0x47e268(0x140)],[constants_1[_0x47e268(0x172)]+_0x47e268(0x143)]:this[_0x47e268(0x142)][_0x47e268(0x167)],[constants_1[_0x47e268(0x172)]+_0x47e268(0x17f)]:this[_0x47e268(0x136)]};});}async[a404_0x493bc3(0x13d)](_0x8fe666){const _0x140d5f=a404_0x493bc3;this[_0x140d5f(0x160)][_0x140d5f(0x1a2)](_0x140d5f(0x186));const _0x23028b=await this[_0x140d5f(0x120)][_0x140d5f(0x15b)](constants_1[_0x140d5f(0x172)]+_0x140d5f(0x149),_0x8fe666),_0x471235=_0x23028b[_0x140d5f(0x11f)](_0x11858e=>!_0x11858e[_0x140d5f(0x14c)])[_0x140d5f(0x156)](_0x287b97=>_0x287b97[_0x140d5f(0x1a0)])['flat']();if(_0x471235[_0x140d5f(0x163)])throw new salesforce_dml_error_1[(_0x140d5f(0x146))](_0x471235);}async['finishRollbackWithError'](_0x7abc5f){const _0x2c8fc2=a404_0x493bc3;if(!this['_metadataLog']){this['_systemLogger'][_0x2c8fc2(0x15f)](_0x7abc5f);return;}this[_0x2c8fc2(0x160)][_0x2c8fc2(0x182)](_0x7abc5f),await this[_0x2c8fc2(0x160)][_0x2c8fc2(0x170)](),await this[_0x2c8fc2(0x195)](![],!![],'');}async[a404_0x493bc3(0x195)](_0x3c606c,_0x58ab77,_0xffa5f){const _0x24b568=a404_0x493bc3,{id:_0x5933db,organizationId:_0x4c1a5c,branchId:_0x183910,organizationName:_0xcb5cf3}=this[_0x24b568(0x142)],_0x2db7ed=_0x24b568(0x159)+this[_0x24b568(0x173)]+'/'+_0x5933db+'\x20>\x20'+_0x24b568(0x139)+_0x24b568(0x10c),_0x141db1=_0x24b568(0x159)+this[_0x24b568(0x173)]+'/'+_0x4c1a5c+'\x20>'+_0xcb5cf3+_0x24b568(0x197),_0xd8105e=_0x2db7ed+_0x24b568(0x191)+_0x141db1+_0x24b568(0x166),_0x1a829f={[constants_1[_0x24b568(0x172)]+_0x24b568(0x176)]:_0xd8105e,[constants_1[_0x24b568(0x172)]+_0x24b568(0x13e)]:new Date(),[constants_1[_0x24b568(0x172)]+'Branch__c']:_0x183910,[constants_1['FLOSUM_NAMESPACE']+_0x24b568(0x16d)]:_0x24b568(0x14e),[constants_1['FLOSUM_NAMESPACE']+_0x24b568(0x14f)]:_0x24b568(0x19c),[constants_1[_0x24b568(0x172)]+'TargetId__c']:_0x4c1a5c},_0xb088a0={[constants_1[_0x24b568(0x172)]+_0x24b568(0x164)]:!_0x3c606c,[constants_1[_0x24b568(0x172)]+_0x24b568(0x13a)]:_0x3c606c,[constants_1['FLOSUM_NAMESPACE']+_0x24b568(0x137)]:_0x58ab77?status_enums_1['MetadataLogStatus'][_0x24b568(0x162)]:status_enums_1[_0x24b568(0x135)][_0x24b568(0x19a)],[constants_1[_0x24b568(0x172)]+_0x24b568(0x194)]:!![],[constants_1[_0x24b568(0x172)]+_0x24b568(0x16b)]:_0xffa5f};await this[_0x24b568(0x125)][_0x24b568(0x147)](flosum_constants_1['FlosumConstants'][_0x24b568(0x193)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x24b568(0x179)+this[_0x24b568(0x136)],_0xb088a0),await this[_0x24b568(0x125)][_0x24b568(0x16c)](flosum_constants_1[_0x24b568(0x122)][_0x24b568(0x193)]+'/'+constants_1[_0x24b568(0x172)]+_0x24b568(0x17b),_0x1a829f),this['_logger'][_0x24b568(0x1a2)](_0x24b568(0x187)+(_0x3c606c?_0x24b568(0x130):_0x24b568(0x148))+'.'),await this[_0x24b568(0x160)]['updateLog']();}async[a404_0x493bc3(0x184)](){const _0x252fc7=a404_0x493bc3;try{this[_0x252fc7(0x142)]=await this['retrieveMetadataLog']();const _0x3b8958=await this[_0x252fc7(0x144)]();await this[_0x252fc7(0x160)][_0x252fc7(0x170)]();const _0x4376da=await this[_0x252fc7(0x17e)](_0x3b8958),_0x31d855=await this[_0x252fc7(0x1a5)](_0x4376da);await this[_0x252fc7(0x160)][_0x252fc7(0x170)]();const _0x4887ff=await this[_0x252fc7(0x19d)]['import'](_0x31d855);await this[_0x252fc7(0x160)]['updateLog']();const _0xab81ee=this['formFlosumDeploymentResults'](_0x4887ff[_0x252fc7(0x12f)]);await this[_0x252fc7(0x13d)](_0xab81ee),await this[_0x252fc7(0x195)](_0x4887ff[_0x252fc7(0x18c)],![],_0x4887ff[_0x252fc7(0x178)]);}catch(_0x254847){await this[_0x252fc7(0x113)](_0x254847)['catch'](_0x4f9692=>this[_0x252fc7(0x18b)][_0x252fc7(0x15f)](_0x4f9692));}}}exports['RollbackService']=RollbackService;