const a404_0x3f1dba=a404_0x3b21;function a404_0x1b9c(){const _0x4d3f90=['retrieveAttachments','saveDeploymentResults','Status__c','ENDPOINT_UPSERT_RECORD','Date__c','Failure','saveLog','_veevaService','name','Log__c','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','FLOSUM_NAMESPACE','organizationId','catch','\x27\x20AND\x20Name\x20=\x20\x27','ZipCreatorRollback','Cannot\x20find\x20Backup\x20Zip','(((.+)+)+)+$','_vpkService','908222qmQhZb','Branch','VpkService','Rollback\x20completed\x20','import','115560kTnKcs','createVpk','finishRollbackWithError','Is_Error__c','../../shared/utils/fetch-attachments','1530DEJkGT','values','constructor','Deployment\x20Result','shortid','Cannot\x20find\x20Deployment\x20Results','length','_packageImportService','_instanceUrl','lastIndexOf','Logger','_metadataLog','stepName','_timeZone','fs/promises','from','retrieveMetadataLog','Retrieve\x20Deployment\x20Results','finishRollback','success','_componentIds','createZip','Metadata_Log__c/','Retrieve\x20Metadata\x20Log\x20info','successfully','600152ghVMJS','Component_Type__c','Veeva\x20Rollback\x20(Deployment)','defineProperty','Deployment','/Attachment','__importDefault','.zip','deploymentAction','../constants/flosum.constants','post','RollbackService','retrieve','Create\x20zip\x20from\x20backup','formFlosumDeploymentResults','\x20:\x20','bind','search','1045155sDZHRF','_systemLogger','flat','Form\x20Deployment\x20Results','base64','map','error','retrieveDeploymentResults','type','../dtos/metadata-log.dto','\x20has\x20been\x20created.','log','_attachmentLogId','fetchAttachmentsDetailsById','Veeva_Step_Name__c','_connectionSalesforce','/vpk__','PackageComponentStatus','create','slice','errors','default','_connectionVeeva','6982304gYFsLG','Job_Completed__c','Component_Name__c','_tempFolder','PackageImportService','veeva-rollback','../classes/rollback/zip-creator.rollback','TargetId__c','<a\x20href=','_metadataLogId','patch','updateLog','../../../core','COMPLETED','\x20</a>','../enums/status.enums','\x27\x0a\x20\x20\x20\x20','EXCEPTION','_salesforceService','SalesforceService','BACKUP_ZIP_NAME','Save\x20Deployment\x20Results','_parentMetadataLogId','isDeployed','1138014xkfWwb','execute','../classes/errors/salesforce-dml-error','status','insertMultipleRecords','filter','\x20>\x20','_logger','Deployment_Result__c','VeevaService','./salesforce.service','__esModule','text/plain','FlosumConstants','Action__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','Org__c','Metadata_Log__c','retrieveRecords','writeFile','retrieveBackup','packageId','Result__c','302TWjzzg','Body'];a404_0x1b9c=function(){return _0x4d3f90;};return a404_0x1b9c();}(function(_0x4a7030,_0x470cd5){const _0x4b8102=a404_0x3b21,_0x180b62=_0x4a7030();while(!![]){try{const _0x161f7e=-parseInt(_0x4b8102(0x19c))/0x1+-parseInt(_0x4b8102(0x212))/0x2*(-parseInt(_0x4b8102(0x1a1))/0x3)+-parseInt(_0x4b8102(0x1ba))/0x4+-parseInt(_0x4b8102(0x1cc))/0x5+-parseInt(_0x4b8102(0x1fb))/0x6+-parseInt(_0x4b8102(0x197))/0x7+parseInt(_0x4b8102(0x1e3))/0x8;if(_0x161f7e===_0x470cd5)break;else _0x180b62['push'](_0x180b62['shift']());}catch(_0x907857){_0x180b62['push'](_0x180b62['shift']());}}}(a404_0x1b9c,0x2606a));const a404_0xc0701f=(function(){let _0x3db18f=!![];return function(_0x1c4a91,_0x5074a5){const _0x36b828=_0x3db18f?function(){if(_0x5074a5){const _0x19108b=_0x5074a5['apply'](_0x1c4a91,arguments);return _0x5074a5=null,_0x19108b;}}:function(){};return _0x3db18f=![],_0x36b828;};}()),a404_0x15e964=a404_0xc0701f(this,function(){const _0xdd599e=a404_0x3b21;return a404_0x15e964['toString']()[_0xdd599e(0x1cb)](_0xdd599e(0x195))['toString']()[_0xdd599e(0x1a3)](a404_0x15e964)[_0xdd599e(0x1cb)]('(((.+)+)+)+$');});a404_0x15e964();'use strict';var __importDefault=this&&this[a404_0x3f1dba(0x1c0)]||function(_0x39a219){const _0xb784d1=a404_0x3f1dba;return _0x39a219&&_0x39a219[_0xb784d1(0x206)]?_0x39a219:{'default':_0x39a219};};function a404_0x3b21(_0x13b976,_0x4b1a36){const _0x36d4a8=a404_0x1b9c();return a404_0x3b21=function(_0x15e964,_0xc0701f){_0x15e964=_0x15e964-0x191;let _0x1b9c0d=_0x36d4a8[_0x15e964];return _0x1b9c0d;},a404_0x3b21(_0x13b976,_0x4b1a36);}Object[a404_0x3f1dba(0x1bd)](exports,a404_0x3f1dba(0x206),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a404_0x3f1dba(0x205)),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a404_0x3f1dba(0x1c3)),fetch_attachments_1=require(a404_0x3f1dba(0x1a0)),constants_1=require('../../../constants'),zip_creator_rollback_1=require(a404_0x3f1dba(0x1e9)),shortid_1=__importDefault(require(a404_0x3f1dba(0x1a5))),promises_1=require(a404_0x3f1dba(0x1af)),vpk_service_1=require('./vpk.service'),status_enums_1=require(a404_0x3f1dba(0x1f2)),salesforce_dml_error_1=require(a404_0x3f1dba(0x1fd)),metadata_log_dto_1=require(a404_0x3f1dba(0x1d5)),core_1=require(a404_0x3f1dba(0x1ef));class RollbackService{constructor({connectionSalesforce:_0x5db8bf,connectionVeeva:_0x18ab33,logger:_0x8e3526,tempFolder:_0x2afff9,instanceUrl:_0x1f45f9,timeZone:_0x551c48,metadataLogId:_0x572fd6,attachmentLogId:_0x1cf9e6,parentMetadataLogId:_0x5b5cab,componentIds:_0x47e254}){const _0x3ff426=a404_0x3f1dba;this[_0x3ff426(0x1db)]=_0x5db8bf,this[_0x3ff426(0x1e2)]=_0x18ab33,this[_0x3ff426(0x202)]=_0x8e3526,this[_0x3ff426(0x1e6)]=_0x2afff9,this['_instanceUrl']=_0x1f45f9,this[_0x3ff426(0x1ae)]=_0x551c48,this['_metadataLogId']=_0x572fd6,this[_0x3ff426(0x1d8)]=_0x1cf9e6,this[_0x3ff426(0x1f9)]=_0x5b5cab,this[_0x3ff426(0x1b5)]=_0x47e254,this[_0x3ff426(0x1cd)]=new core_1[(_0x3ff426(0x1ab))](_0x3ff426(0x1e8)),this[_0x3ff426(0x21b)]=new veeva_service_1[(_0x3ff426(0x204))]({'connection':_0x18ab33,'logger':_0x8e3526}),this['_salesforceService']=new salesforce_service_1[(_0x3ff426(0x1f6))]({'connection':_0x5db8bf}),this[_0x3ff426(0x1a8)]=new package_import_service_1[(_0x3ff426(0x1e7))]({'veevaService':this[_0x3ff426(0x21b)],'connection':_0x18ab33,'logger':_0x8e3526,'saveLog':this['saveLog'][_0x3ff426(0x1ca)](this)}),this[_0x3ff426(0x196)]=new vpk_service_1[(_0x3ff426(0x199))]({'connection':_0x18ab33});}async[a404_0x3f1dba(0x21a)](_0x52b7e5,_0x3603b1){const _0x49ee3d=a404_0x3f1dba;this[_0x49ee3d(0x202)][_0x49ee3d(0x1d7)]('Save\x20log');const _0x1defc9={'Body':Buffer[_0x49ee3d(0x1b0)](_0x52b7e5)['toString'](_0x49ee3d(0x1d0)),'ContentType':_0x49ee3d(0x207),'ParentId':this[_0x49ee3d(0x1ec)],'Name':_0x3603b1};await this[_0x49ee3d(0x1db)][_0x49ee3d(0x1c4)](flosum_constants_1[_0x49ee3d(0x208)][_0x49ee3d(0x217)]+_0x49ee3d(0x1bf),_0x1defc9);}async[a404_0x3f1dba(0x1b1)](){const _0x31707e=a404_0x3f1dba;this[_0x31707e(0x202)][_0x31707e(0x1d7)](_0x31707e(0x1b8));const [_0x4af36c]=await this[_0x31707e(0x1f5)][_0x31707e(0x20d)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x31707e(0x21f)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x31707e(0x21f)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x31707e(0x21e)+constants_1[_0x31707e(0x21f)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x31707e(0x1ec)]+_0x31707e(0x1f3));return new metadata_log_dto_1['MetadataLogDto'](_0x4af36c);}async[a404_0x3f1dba(0x1d3)](){const _0x4761c0=a404_0x3f1dba;this[_0x4761c0(0x202)][_0x4761c0(0x1d7)](_0x4761c0(0x1b2));const _0x32cd3=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x4761c0(0x1f5)],'value':this['_componentIds']})[_0x4761c0(0x1c6)]();if(!_0x32cd3[_0x4761c0(0x1a7)])throw new Error(_0x4761c0(0x1a6));return _0x32cd3;}async[a404_0x3f1dba(0x20f)](){const _0x121c59=a404_0x3f1dba;this['_logger'][_0x121c59(0x1d7)]('Retrieve\x20Backup');const _0x321dbd=await this[_0x121c59(0x1f5)][_0x121c59(0x20d)](_0x121c59(0x20a)+this[_0x121c59(0x1f9)]+_0x121c59(0x192)+flosum_constants_1[_0x121c59(0x208)][_0x121c59(0x1f7)]+_0x121c59(0x1f3)),_0x158317=await(0x0,fetch_attachments_1[_0x121c59(0x1d9)])(this[_0x121c59(0x1db)],[_0x321dbd[0x0]['Id']]),_0x1ed129=await(0x0,fetch_attachments_1[_0x121c59(0x214)])(_0x158317,this[_0x121c59(0x1db)]);if(!_0x1ed129['length'])throw new Error(_0x121c59(0x194));return _0x1ed129[0x0][_0x121c59(0x1a2)][_0x121c59(0x213)];}async[a404_0x3f1dba(0x1b6)](_0x265d4e){const _0x3539ec=a404_0x3f1dba;this[_0x3539ec(0x202)][_0x3539ec(0x1d7)](_0x3539ec(0x1c7));const _0x128777=await this['retrieveBackup'](),_0x2197c0=await new zip_creator_rollback_1[(_0x3539ec(0x193))]({'rollbackName':this[_0x3539ec(0x1ac)][_0x3539ec(0x21c)],'backup':_0x128777,'deploymentResults':_0x265d4e})[_0x3539ec(0x1de)](),_0x4d8dda=this[_0x3539ec(0x1e6)]+'/'+(0x0,shortid_1[_0x3539ec(0x1e1)])()+_0x3539ec(0x1c1);return await(0x0,promises_1[_0x3539ec(0x20e)])(_0x4d8dda,_0x2197c0),_0x4d8dda;}async[a404_0x3f1dba(0x19d)](_0xaa000d){const _0x3cf374=a404_0x3f1dba;this[_0x3cf374(0x202)][_0x3cf374(0x1d7)]('Create\x20Vpk\x20package');const _0x41298f=await this[_0x3cf374(0x196)]['generate'](_0xaa000d),_0x578d20=this[_0x3cf374(0x1e6)]+_0x3cf374(0x1dc)+_0xaa000d[_0x3cf374(0x1df)](_0xaa000d[_0x3cf374(0x1aa)]('/')+0x1);return await(0x0,promises_1[_0x3cf374(0x20e)])(_0x578d20,_0x41298f),await this[_0x3cf374(0x196)]['validate'](_0x578d20),_0x578d20;}['formFlosumDeploymentResults'](_0x361999){const _0x3012fe=a404_0x3f1dba;return this[_0x3012fe(0x202)][_0x3012fe(0x1d7)](_0x3012fe(0x1cf)),_0x361999[_0x3012fe(0x1d1)](_0x23b031=>{const _0x32f5ff=_0x3012fe;return this[_0x32f5ff(0x202)][_0x32f5ff(0x1d7)](_0x23b031[_0x32f5ff(0x1d4)]+'.'+_0x23b031[_0x32f5ff(0x21c)]+_0x32f5ff(0x1c9)+_0x23b031[_0x32f5ff(0x1fe)]),{[constants_1[_0x32f5ff(0x21f)]+'Type__c']:_0x32f5ff(0x1a4),[constants_1[_0x32f5ff(0x21f)]+_0x32f5ff(0x216)]:_0x23b031['status']===status_enums_1[_0x32f5ff(0x1dd)]['DEPLOYED']?'Success':_0x32f5ff(0x219),[constants_1[_0x32f5ff(0x21f)]+_0x32f5ff(0x211)]:_0x23b031[_0x32f5ff(0x1c2)],[constants_1['FLOSUM_NAMESPACE']+_0x32f5ff(0x1e5)]:_0x23b031['name'],[constants_1['FLOSUM_NAMESPACE']+_0x32f5ff(0x1bb)]:_0x23b031['type'],[constants_1[_0x32f5ff(0x21f)]+_0x32f5ff(0x1da)]:_0x23b031[_0x32f5ff(0x1ad)],[constants_1[_0x32f5ff(0x21f)]+_0x32f5ff(0x20b)]:this[_0x32f5ff(0x1ac)][_0x32f5ff(0x220)],[constants_1[_0x32f5ff(0x21f)]+_0x32f5ff(0x20c)]:this[_0x32f5ff(0x1ec)]};});}async[a404_0x3f1dba(0x215)](_0x38bc2a){const _0x137883=a404_0x3f1dba;this['_logger'][_0x137883(0x1d7)](_0x137883(0x1f8));const _0x233995=await this[_0x137883(0x1f5)][_0x137883(0x1ff)](constants_1[_0x137883(0x21f)]+_0x137883(0x203),_0x38bc2a),_0x34008a=_0x233995[_0x137883(0x200)](_0x353479=>!_0x353479[_0x137883(0x1b4)])[_0x137883(0x1d1)](_0x5a2df1=>_0x5a2df1[_0x137883(0x1e0)])[_0x137883(0x1ce)]();if(_0x34008a[_0x137883(0x1a7)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x34008a);}async[a404_0x3f1dba(0x19e)](_0x55e4dc){const _0x26556b=a404_0x3f1dba;if(!this['_metadataLog']){this[_0x26556b(0x1cd)][_0x26556b(0x1d2)](_0x55e4dc);return;}this[_0x26556b(0x202)]['logError'](_0x55e4dc),await this[_0x26556b(0x202)]['updateLog'](),await this[_0x26556b(0x1b3)](![],!![],'');}async[a404_0x3f1dba(0x1b3)](_0x171e9c,_0x515886,_0x133bf0){const _0x18224a=a404_0x3f1dba,{id:_0xa21abf,organizationId:_0x480cea,branchId:_0x30dd95,organizationName:_0xad89ef}=this['_metadataLog'],_0x422383=_0x18224a(0x1eb)+this[_0x18224a(0x1a9)]+'/'+_0xa21abf+_0x18224a(0x201)+_0x18224a(0x1bc)+_0x18224a(0x1f1),_0x4a1402=_0x18224a(0x1eb)+this[_0x18224a(0x1a9)]+'/'+_0x480cea+'\x20>'+_0xad89ef+'</a>',_0x48bdb3=_0x422383+'\x20of\x20branch\x20to\x20Organization\x20'+_0x4a1402+_0x18224a(0x1d6),_0x1abdb0={[constants_1[_0x18224a(0x21f)]+_0x18224a(0x209)]:_0x48bdb3,[constants_1[_0x18224a(0x21f)]+_0x18224a(0x218)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+'Branch__c']:_0x30dd95,[constants_1[_0x18224a(0x21f)]+'Activity_Item__c']:_0x18224a(0x198),[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0x18224a(0x1be),[constants_1[_0x18224a(0x21f)]+_0x18224a(0x1ea)]:_0x480cea},_0xf31ef2={[constants_1[_0x18224a(0x21f)]+_0x18224a(0x19f)]:!_0x171e9c,[constants_1[_0x18224a(0x21f)]+'Succeed__c']:_0x171e9c,[constants_1[_0x18224a(0x21f)]+_0x18224a(0x216)]:_0x515886?status_enums_1['MetadataLogStatus'][_0x18224a(0x1f4)]:status_enums_1['MetadataLogStatus'][_0x18224a(0x1f0)],[constants_1['FLOSUM_NAMESPACE']+_0x18224a(0x1e4)]:!![],[constants_1[_0x18224a(0x21f)]+'External_Deployment_Id__c']:_0x133bf0};await this['_connectionSalesforce'][_0x18224a(0x1ed)](flosum_constants_1[_0x18224a(0x208)][_0x18224a(0x217)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x18224a(0x1b7)+this[_0x18224a(0x1ec)],_0xf31ef2),await this[_0x18224a(0x1db)][_0x18224a(0x1c4)](flosum_constants_1[_0x18224a(0x208)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x18224a(0x21f)]+_0x18224a(0x21d),_0x1abdb0),this[_0x18224a(0x202)]['log'](_0x18224a(0x19a)+(_0x171e9c?_0x18224a(0x1b9):'with\x20error')+'.'),await this[_0x18224a(0x202)]['updateLog']();}async[a404_0x3f1dba(0x1fc)](){const _0x3012fd=a404_0x3f1dba;try{this[_0x3012fd(0x1ac)]=await this[_0x3012fd(0x1b1)]();const _0x1a8e59=await this[_0x3012fd(0x1d3)]();await this[_0x3012fd(0x202)]['updateLog']();const _0x2d016e=await this[_0x3012fd(0x1b6)](_0x1a8e59),_0x4c5922=await this[_0x3012fd(0x19d)](_0x2d016e);await this[_0x3012fd(0x202)][_0x3012fd(0x1ee)]();const _0x9efb20=await this['_packageImportService'][_0x3012fd(0x19b)](_0x4c5922);await this['_logger'][_0x3012fd(0x1ee)]();const _0x4dc005=this[_0x3012fd(0x1c8)](_0x9efb20['packageComponentList']);await this[_0x3012fd(0x215)](_0x4dc005),await this[_0x3012fd(0x1b3)](_0x9efb20[_0x3012fd(0x1fa)],![],_0x9efb20[_0x3012fd(0x210)]);}catch(_0x201e99){await this[_0x3012fd(0x19e)](_0x201e99)[_0x3012fd(0x191)](_0x27258b=>this['_systemLogger']['error'](_0x27258b));}}}exports[a404_0x3f1dba(0x1c5)]=RollbackService;