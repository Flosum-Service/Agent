const a360_0x39f969=a360_0x2f91;function a360_0xad56(){const _0x54cd1c=['_componentIds','_attachmentLogId','_veevaService','8jWgdTh','./veeva.service','values','finishRollback','success','lastIndexOf','search','IdDeploymentResultRetriever','ZipCreatorRollback','generate','_timeZone','formFlosumDeploymentResults','<a\x20href=','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','text/plain','22104sHYPkt','Component_Type__c','fs/promises','length','saveLog','ENDPOINT_UPSERT_RECORD','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','status','.zip','Veeva\x20Rollback\x20(Deployment)','toString','\x20of\x20branch\x20to\x20Organization\x20','patch','\x27\x20AND\x20Name\x20=\x20\x27','fetchAttachmentsDetailsById','../../../core','error','with\x20error','\x20</a>','retrieveRecords','./package-import.service','deploymentAction','Failure','retrieve','retrieveAttachments','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','_connectionVeeva','_parentMetadataLogId','SalesforceService','Result__c','Activity_Type__c','_logger','Log__c','Retrieve\x20Backup','Create\x20zip\x20from\x20backup','PackageComponentStatus','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','Body','_metadataLogId','veeva-rollback','COMPLETED','errors','retrieveDeploymentResults','3902855BOueDO','MetadataLogStatus','__esModule','from','553yGybJX','Create\x20Vpk\x20package','Activity_Item__c','48855vvvBUF','External_Deployment_Id__c','2eDMkSI','Metadata_Log__c','Logger','_metadataLog','./vpk.service','/Attachment','name','PackageImportService','defineProperty','log','insertMultipleRecords','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','RollbackService','Deployment','retrieveBackup','615400MruMPc','1133919QQZJYA','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_vpkService','Succeed__c','_systemLogger','Branch','Form\x20Deployment\x20Results','post','shortid','4411190hqSEsc','Component_Name__c','\x20has\x20been\x20created.','_salesforceService','packageComponentList','Success','DEPLOYED','updateLog','BACKUP_ZIP_NAME','Date__c','Metadata_Log__c/','writeFile','_packageImportService','FLOSUM_NAMESPACE','../../shared/utils/fetch-attachments','createVpk','Is_Error__c','Veeva_Step_Name__c','FlosumConstants','Retrieve\x20Metadata\x20Log\x20info','apply','filter','_instanceUrl','flat','createZip','finishRollbackWithError','_tempFolder','execute','retrieveMetadataLog','type','map','successfully','organizationId','_connectionSalesforce','bind','364271kdlGch','</a>','Deployment_Result__c','saveDeploymentResults','packageId','TargetId__c','/vpk__','\x20:\x20','./salesforce.service','constructor','\x20>\x20','VpkService','Type__c','logError','validate','create','52uDlHiJ','\x27\x0a\x20\x20\x20\x20','../../../constants','catch','Org__c'];a360_0xad56=function(){return _0x54cd1c;};return a360_0xad56();}function a360_0x2f91(_0x35d85c,_0x4dd3d3){const _0x56ad98=a360_0xad56();return a360_0x2f91=function(_0x53cf06,_0x29b0f3){_0x53cf06=_0x53cf06-0x18f;let _0xad5606=_0x56ad98[_0x53cf06];return _0xad5606;},a360_0x2f91(_0x35d85c,_0x4dd3d3);}(function(_0x539f86,_0x492b1d){const _0xf6fa91=a360_0x2f91,_0x5d368b=_0x539f86();while(!![]){try{const _0x16c8ea=-parseInt(_0xf6fa91(0x223))/0x1*(parseInt(_0xf6fa91(0x1e7))/0x2)+-parseInt(_0xf6fa91(0x1e5))/0x3*(parseInt(_0xf6fa91(0x19c))/0x4)+-parseInt(_0xf6fa91(0x1f6))/0x5+-parseInt(_0xf6fa91(0x1b3))/0x6*(-parseInt(_0xf6fa91(0x1e2))/0x7)+parseInt(_0xf6fa91(0x1a4))/0x8*(-parseInt(_0xf6fa91(0x1f7))/0x9)+parseInt(_0xf6fa91(0x200))/0xa+parseInt(_0xf6fa91(0x1de))/0xb;if(_0x16c8ea===_0x492b1d)break;else _0x5d368b['push'](_0x5d368b['shift']());}catch(_0x462abc){_0x5d368b['push'](_0x5d368b['shift']());}}}(a360_0xad56,0x3ff19));const a360_0x29b0f3=(function(){let _0x2cce3b=!![];return function(_0x2a4b11,_0x51f0e5){const _0x4f583a=_0x2cce3b?function(){const _0x4a95d1=a360_0x2f91;if(_0x51f0e5){const _0x64a114=_0x51f0e5[_0x4a95d1(0x214)](_0x2a4b11,arguments);return _0x51f0e5=null,_0x64a114;}}:function(){};return _0x2cce3b=![],_0x4f583a;};}()),a360_0x53cf06=a360_0x29b0f3(this,function(){const _0x5b3686=a360_0x2f91;return a360_0x53cf06[_0x5b3686(0x1bd)]()[_0x5b3686(0x1aa)]('(((.+)+)+)+$')[_0x5b3686(0x1bd)]()[_0x5b3686(0x195)](a360_0x53cf06)[_0x5b3686(0x1aa)]('(((.+)+)+)+$');});a360_0x53cf06();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x98430d){const _0x232bdc=a360_0x2f91;return _0x98430d&&_0x98430d[_0x232bdc(0x1e0)]?_0x98430d:{'default':_0x98430d};};Object[a360_0x39f969(0x1ef)](exports,a360_0x39f969(0x1e0),{'value':!![]}),exports[a360_0x39f969(0x1f3)]=void 0x0;const veeva_service_1=require(a360_0x39f969(0x1a5)),salesforce_service_1=require(a360_0x39f969(0x194)),package_import_service_1=require(a360_0x39f969(0x1c7)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a360_0x39f969(0x20e)),constants_1=require(a360_0x39f969(0x19e)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a360_0x39f969(0x1ff))),promises_1=require(a360_0x39f969(0x1b5)),vpk_service_1=require(a360_0x39f969(0x1eb)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a360_0x39f969(0x1c2));class RollbackService{constructor({connectionSalesforce:_0x2a6619,connectionVeeva:_0x3afa9f,logger:_0x56dbeb,tempFolder:_0x2c2e3d,instanceUrl:_0x29da10,timeZone:_0x41a451,metadataLogId:_0x41053a,attachmentLogId:_0x490f41,parentMetadataLogId:_0x5b63fc,componentIds:_0x248147}){const _0x21468d=a360_0x39f969;this[_0x21468d(0x221)]=_0x2a6619,this[_0x21468d(0x1cd)]=_0x3afa9f,this[_0x21468d(0x1d2)]=_0x56dbeb,this[_0x21468d(0x21a)]=_0x2c2e3d,this['_instanceUrl']=_0x29da10,this[_0x21468d(0x1ae)]=_0x41a451,this[_0x21468d(0x1d9)]=_0x41053a,this[_0x21468d(0x1a2)]=_0x490f41,this['_parentMetadataLogId']=_0x5b63fc,this['_componentIds']=_0x248147,this[_0x21468d(0x1fb)]=new core_1[(_0x21468d(0x1e9))](_0x21468d(0x1da)),this[_0x21468d(0x1a3)]=new veeva_service_1['VeevaService']({'connection':_0x3afa9f,'logger':_0x56dbeb}),this[_0x21468d(0x203)]=new salesforce_service_1[(_0x21468d(0x1cf))]({'connection':_0x2a6619}),this['_packageImportService']=new package_import_service_1[(_0x21468d(0x1ee))]({'veevaService':this[_0x21468d(0x1a3)],'connection':_0x3afa9f,'logger':_0x56dbeb,'saveLog':this[_0x21468d(0x1b7)][_0x21468d(0x222)](this)}),this['_vpkService']=new vpk_service_1[(_0x21468d(0x197))]({'connection':_0x3afa9f});}async['saveLog'](_0x5437c9,_0x143e93){const _0x41b8de=a360_0x39f969;this[_0x41b8de(0x1d2)]['log']('Save\x20log');const _0x5f0627={'Body':Buffer[_0x41b8de(0x1e1)](_0x5437c9)['toString']('base64'),'ContentType':_0x41b8de(0x1b2),'ParentId':this[_0x41b8de(0x1d9)],'Name':_0x143e93};await this[_0x41b8de(0x221)][_0x41b8de(0x1fe)](flosum_constants_1['FlosumConstants'][_0x41b8de(0x1b8)]+_0x41b8de(0x1ec),_0x5f0627);}async[a360_0x39f969(0x21c)](){const _0x43ce09=a360_0x39f969;this[_0x43ce09(0x1d2)][_0x43ce09(0x1f0)](_0x43ce09(0x213));const [_0x219039]=await this[_0x43ce09(0x203)][_0x43ce09(0x1c6)](_0x43ce09(0x1f8)+constants_1[_0x43ce09(0x20d)]+_0x43ce09(0x1b9)+constants_1[_0x43ce09(0x20d)]+_0x43ce09(0x1f2)+constants_1['FLOSUM_NAMESPACE']+_0x43ce09(0x1b1)+constants_1['FLOSUM_NAMESPACE']+_0x43ce09(0x1cc)+this['_metadataLogId']+_0x43ce09(0x19d));return new metadata_log_dto_1['MetadataLogDto'](_0x219039);}async[a360_0x39f969(0x1dd)](){const _0x40cbc5=a360_0x39f969;this[_0x40cbc5(0x1d2)][_0x40cbc5(0x1f0)]('Retrieve\x20Deployment\x20Results');const _0x4e718f=await new id_deployment_result_retriever_1[(_0x40cbc5(0x1ab))]({'salesforceService':this[_0x40cbc5(0x203)],'value':this[_0x40cbc5(0x1a1)]})[_0x40cbc5(0x1ca)]();if(!_0x4e718f[_0x40cbc5(0x1b6)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x4e718f;}async['retrieveBackup'](){const _0x45580c=a360_0x39f969;this[_0x45580c(0x1d2)][_0x45580c(0x1f0)](_0x45580c(0x1d4));const _0x48ac30=await this['_salesforceService'][_0x45580c(0x1c6)](_0x45580c(0x1d7)+this[_0x45580c(0x1ce)]+_0x45580c(0x1c0)+flosum_constants_1[_0x45580c(0x212)][_0x45580c(0x208)]+_0x45580c(0x19d)),_0x3f3792=await(0x0,fetch_attachments_1[_0x45580c(0x1c1)])(this[_0x45580c(0x221)],[_0x48ac30[0x0]['Id']]),_0x1f6af8=await(0x0,fetch_attachments_1[_0x45580c(0x1cb)])(_0x3f3792,this['_connectionSalesforce']);if(!_0x1f6af8[_0x45580c(0x1b6)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x1f6af8[0x0][_0x45580c(0x1a6)][_0x45580c(0x1d8)];}async[a360_0x39f969(0x218)](_0x481e15){const _0x5876f8=a360_0x39f969;this[_0x5876f8(0x1d2)]['log'](_0x5876f8(0x1d5));const _0x3e33e1=await this[_0x5876f8(0x1f5)](),_0x31dfa2=await new zip_creator_rollback_1[(_0x5876f8(0x1ac))]({'rollbackName':this[_0x5876f8(0x1ea)][_0x5876f8(0x1ed)],'backup':_0x3e33e1,'deploymentResults':_0x481e15})[_0x5876f8(0x19b)](),_0x179830=this[_0x5876f8(0x21a)]+'/'+(0x0,shortid_1['default'])()+_0x5876f8(0x1bb);return await(0x0,promises_1[_0x5876f8(0x20b)])(_0x179830,_0x31dfa2),_0x179830;}async[a360_0x39f969(0x20f)](_0x139221){const _0x28432e=a360_0x39f969;this[_0x28432e(0x1d2)][_0x28432e(0x1f0)](_0x28432e(0x1e3));const _0x2f76e1=await this['_vpkService'][_0x28432e(0x1ad)](_0x139221),_0x5316aa=this['_tempFolder']+_0x28432e(0x192)+_0x139221['slice'](_0x139221[_0x28432e(0x1a9)]('/')+0x1);return await(0x0,promises_1[_0x28432e(0x20b)])(_0x5316aa,_0x2f76e1),await this[_0x28432e(0x1f9)][_0x28432e(0x19a)](_0x5316aa),_0x5316aa;}['formFlosumDeploymentResults'](_0x53eef3){const _0xa1ec99=a360_0x39f969;return this[_0xa1ec99(0x1d2)][_0xa1ec99(0x1f0)](_0xa1ec99(0x1fd)),_0x53eef3[_0xa1ec99(0x21e)](_0x24cfdc=>{const _0x34fc3f=_0xa1ec99;return this[_0x34fc3f(0x1d2)]['log'](_0x24cfdc[_0x34fc3f(0x21d)]+'.'+_0x24cfdc['name']+_0x34fc3f(0x193)+_0x24cfdc['status']),{[constants_1['FLOSUM_NAMESPACE']+_0x34fc3f(0x198)]:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x24cfdc[_0x34fc3f(0x1ba)]===status_enums_1[_0x34fc3f(0x1d6)][_0x34fc3f(0x206)]?_0x34fc3f(0x205):_0x34fc3f(0x1c9),[constants_1['FLOSUM_NAMESPACE']+_0x34fc3f(0x1d0)]:_0x24cfdc[_0x34fc3f(0x1c8)],[constants_1[_0x34fc3f(0x20d)]+_0x34fc3f(0x201)]:_0x24cfdc[_0x34fc3f(0x1ed)],[constants_1[_0x34fc3f(0x20d)]+_0x34fc3f(0x1b4)]:_0x24cfdc[_0x34fc3f(0x21d)],[constants_1[_0x34fc3f(0x20d)]+_0x34fc3f(0x211)]:_0x24cfdc['stepName'],[constants_1[_0x34fc3f(0x20d)]+_0x34fc3f(0x1a0)]:this['_metadataLog'][_0x34fc3f(0x220)],[constants_1['FLOSUM_NAMESPACE']+_0x34fc3f(0x1e8)]:this[_0x34fc3f(0x1d9)]};});}async[a360_0x39f969(0x18f)](_0x237c2f){const _0x170a62=a360_0x39f969;this['_logger'][_0x170a62(0x1f0)]('Save\x20Deployment\x20Results');const _0x30a280=await this[_0x170a62(0x203)][_0x170a62(0x1f1)](constants_1[_0x170a62(0x20d)]+_0x170a62(0x225),_0x237c2f),_0x775c2c=_0x30a280[_0x170a62(0x215)](_0x468d38=>!_0x468d38[_0x170a62(0x1a8)])[_0x170a62(0x21e)](_0x59d3b=>_0x59d3b[_0x170a62(0x1dc)])[_0x170a62(0x217)]();if(_0x775c2c[_0x170a62(0x1b6)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x775c2c);}async[a360_0x39f969(0x219)](_0x5d5d2f){const _0x4b61a3=a360_0x39f969;if(!this[_0x4b61a3(0x1ea)]){this[_0x4b61a3(0x1fb)][_0x4b61a3(0x1c3)](_0x5d5d2f);return;}this[_0x4b61a3(0x1d2)][_0x4b61a3(0x199)](_0x5d5d2f),await this['_logger'][_0x4b61a3(0x207)](),await this[_0x4b61a3(0x1a7)](![],!![],'');}async[a360_0x39f969(0x1a7)](_0x55bb31,_0x4e89e5,_0xb89436){const _0x26e68f=a360_0x39f969,{id:_0x2e3bba,organizationId:_0x3f73b6,branchId:_0xa5c7a,organizationName:_0x5a086d}=this[_0x26e68f(0x1ea)],_0x6d20e3=_0x26e68f(0x1b0)+this[_0x26e68f(0x216)]+'/'+_0x2e3bba+_0x26e68f(0x196)+_0x26e68f(0x1bc)+_0x26e68f(0x1c5),_0x347e3d=_0x26e68f(0x1b0)+this['_instanceUrl']+'/'+_0x3f73b6+'\x20>'+_0x5a086d+_0x26e68f(0x224),_0x4e22b7=_0x6d20e3+_0x26e68f(0x1be)+_0x347e3d+_0x26e68f(0x202),_0x11cfa4={[constants_1[_0x26e68f(0x20d)]+'Action__c']:_0x4e22b7,[constants_1['FLOSUM_NAMESPACE']+_0x26e68f(0x209)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+'Branch__c']:_0xa5c7a,[constants_1[_0x26e68f(0x20d)]+_0x26e68f(0x1e4)]:_0x26e68f(0x1fc),[constants_1['FLOSUM_NAMESPACE']+_0x26e68f(0x1d1)]:_0x26e68f(0x1f4),[constants_1[_0x26e68f(0x20d)]+_0x26e68f(0x191)]:_0x3f73b6},_0x285ba9={[constants_1[_0x26e68f(0x20d)]+_0x26e68f(0x210)]:!_0x55bb31,[constants_1[_0x26e68f(0x20d)]+_0x26e68f(0x1fa)]:_0x55bb31,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x4e89e5?status_enums_1[_0x26e68f(0x1df)]['EXCEPTION']:status_enums_1[_0x26e68f(0x1df)][_0x26e68f(0x1db)],[constants_1[_0x26e68f(0x20d)]+'Job_Completed__c']:!![],[constants_1[_0x26e68f(0x20d)]+_0x26e68f(0x1e6)]:_0xb89436};await this['_connectionSalesforce'][_0x26e68f(0x1bf)](flosum_constants_1['FlosumConstants'][_0x26e68f(0x1b8)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x26e68f(0x20a)+this[_0x26e68f(0x1d9)],_0x285ba9),await this[_0x26e68f(0x221)][_0x26e68f(0x1fe)](flosum_constants_1[_0x26e68f(0x212)][_0x26e68f(0x1b8)]+'/'+constants_1[_0x26e68f(0x20d)]+_0x26e68f(0x1d3),_0x11cfa4),this['_logger']['log']('Rollback\x20completed\x20'+(_0x55bb31?_0x26e68f(0x21f):_0x26e68f(0x1c4))+'.'),await this[_0x26e68f(0x1d2)]['updateLog']();}async[a360_0x39f969(0x21b)](){const _0x4072ef=a360_0x39f969;try{this[_0x4072ef(0x1ea)]=await this[_0x4072ef(0x21c)]();const _0xb728ee=await this[_0x4072ef(0x1dd)]();await this[_0x4072ef(0x1d2)][_0x4072ef(0x207)]();const _0x383bd4=await this[_0x4072ef(0x218)](_0xb728ee),_0x1f0d45=await this[_0x4072ef(0x20f)](_0x383bd4);await this[_0x4072ef(0x1d2)][_0x4072ef(0x207)]();const _0x2a5aea=await this[_0x4072ef(0x20c)]['import'](_0x1f0d45);await this['_logger']['updateLog']();const _0x27bf0d=this[_0x4072ef(0x1af)](_0x2a5aea[_0x4072ef(0x204)]);await this[_0x4072ef(0x18f)](_0x27bf0d),await this[_0x4072ef(0x1a7)](_0x2a5aea['isDeployed'],![],_0x2a5aea[_0x4072ef(0x190)]);}catch(_0x42139f){await this[_0x4072ef(0x219)](_0x42139f)[_0x4072ef(0x19f)](_0x18d070=>this['_systemLogger'][_0x4072ef(0x1c3)](_0x18d070));}}}exports['RollbackService']=RollbackService;