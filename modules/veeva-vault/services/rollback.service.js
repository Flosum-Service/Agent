function a404_0x1ffe(){const _0x4b0f13=['Log__c','VeevaService','retrieveBackup','../enums/status.enums','Result__c','ENDPOINT_UPSERT_RECORD','createZip','\x27\x0a\x20\x20\x20\x20','insertMultipleRecords','import','6904PRENWs','organizationId','../classes/rollback/zip-creator.rollback','Save\x20log','\x20has\x20been\x20created.','Failure','./salesforce.service','_tempFolder','TargetId__c','../../../constants','_parentMetadataLogId','default','__importDefault','retrieveRecords','log','fetchAttachmentsDetailsById','map','saveDeploymentResults','execute','_metadataLog','2sLzFef','deploymentAction','_connectionVeeva','packageComponentList','Succeed__c','PackageImportService','Action__c','Metadata_Log__c/','VpkService','Veeva_Step_Name__c','success','RollbackService','../constants/flosum.constants','Metadata_Log__c','External_Deployment_Id__c','DEPLOYED','retrieveDeploymentResults','BACKUP_ZIP_NAME','toString','Cannot\x20find\x20Backup\x20Zip','bind','FlosumConstants','flat','ZipCreatorRollback','error','from','Component_Name__c','(((.+)+)+)+$','formFlosumDeploymentResults','status','constructor','_instanceUrl','_packageImportService','IdDeploymentResultRetriever','retrieve','./veeva.service','_veevaService','search','\x20</a>','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','type','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','text/plain','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','successfully','6866415mKdDgb','Body','_connectionSalesforce','SalesforceService','__esModule','8848faAipQ','_logger','../dtos/metadata-log.dto','_systemLogger','/Attachment','Status__c','veeva-rollback','../classes/retrievers/deployment-results/id.deployment-result.retriever','logError','post','updateLog','Is_Error__c','935OjTfGm','createVpk','defineProperty','Success','MetadataLogStatus','length','Retrieve\x20Deployment\x20Results','./vpk.service','writeFile','Job_Completed__c','/vpk__','20bllXaP','Component_Type__c','FLOSUM_NAMESPACE','63734Tfxooz','finishRollback','Form\x20Deployment\x20Results','retrieveAttachments','Activity_Type__c','fs/promises','EXCEPTION','Deployment','_metadataLogId','Deployment_Result__c','_vpkService','<a\x20href=','finishRollbackWithError','.zip','errors','_salesforceService','556296QwZfDJ','\x20of\x20branch\x20to\x20Organization\x20','9DjVApz','3948850xehTRO','1618326TemdUq','isDeployed','_componentIds','Branch__c','catch','COMPLETED','PackageComponentStatus','name','Retrieve\x20Backup','../classes/errors/salesforce-dml-error','_attachmentLogId','packageId','Activity_Item__c','with\x20error','retrieveMetadataLog','372774uGQLJJ','saveLog','Org__c','./package-import.service','generate','Logger','stepName','Cannot\x20find\x20Deployment\x20Results','Create\x20zip\x20from\x20backup'];a404_0x1ffe=function(){return _0x4b0f13;};return a404_0x1ffe();}const a404_0x399a4e=a404_0x3702;(function(_0x1c6fcc,_0x493e11){const _0x2b1437=a404_0x3702,_0x15d1d4=_0x1c6fcc();while(!![]){try{const _0x4c7ad9=-parseInt(_0x2b1437(0x16d))/0x1*(parseInt(_0x2b1437(0x1b9))/0x2)+-parseInt(_0x2b1437(0x1dc))/0x3*(parseInt(_0x2b1437(0x1b6))/0x4)+-parseInt(_0x2b1437(0x19a))/0x5+-parseInt(_0x2b1437(0x1cd))/0x6+-parseInt(_0x2b1437(0x19f))/0x7*(parseInt(_0x2b1437(0x1ef))/0x8)+-parseInt(_0x2b1437(0x1cb))/0x9*(-parseInt(_0x2b1437(0x1cc))/0xa)+parseInt(_0x2b1437(0x1ab))/0xb*(parseInt(_0x2b1437(0x1c9))/0xc);if(_0x4c7ad9===_0x493e11)break;else _0x15d1d4['push'](_0x15d1d4['shift']());}catch(_0x1cecaf){_0x15d1d4['push'](_0x15d1d4['shift']());}}}(a404_0x1ffe,0xdfbe7));const a404_0x559dd6=(function(){let _0x34d9e4=!![];return function(_0x477e4b,_0x535fdb){const _0x48d829=_0x34d9e4?function(){if(_0x535fdb){const _0x38bcea=_0x535fdb['apply'](_0x477e4b,arguments);return _0x535fdb=null,_0x38bcea;}}:function(){};return _0x34d9e4=![],_0x48d829;};}()),a404_0x5bb950=a404_0x559dd6(this,function(){const _0x520c41=a404_0x3702;return a404_0x5bb950[_0x520c41(0x17f)]()[_0x520c41(0x192)](_0x520c41(0x188))[_0x520c41(0x17f)]()[_0x520c41(0x18b)](a404_0x5bb950)['search'](_0x520c41(0x188));});a404_0x5bb950();'use strict';var __importDefault=this&&this[a404_0x399a4e(0x1fb)]||function(_0x517bfc){const _0x9360b=a404_0x399a4e;return _0x517bfc&&_0x517bfc[_0x9360b(0x19e)]?_0x517bfc:{'default':_0x517bfc};};function a404_0x3702(_0x285ec3,_0x3c9839){const _0x1ca90e=a404_0x1ffe();return a404_0x3702=function(_0x5bb950,_0x559dd6){_0x5bb950=_0x5bb950-0x168;let _0x1ffef3=_0x1ca90e[_0x5bb950];return _0x1ffef3;},a404_0x3702(_0x285ec3,_0x3c9839);}Object[a404_0x399a4e(0x1ad)](exports,a404_0x399a4e(0x19e),{'value':!![]}),exports[a404_0x399a4e(0x178)]=void 0x0;const veeva_service_1=require(a404_0x399a4e(0x190)),salesforce_service_1=require(a404_0x399a4e(0x1f5)),package_import_service_1=require(a404_0x399a4e(0x1df)),id_deployment_result_retriever_1=require(a404_0x399a4e(0x1a6)),flosum_constants_1=require(a404_0x399a4e(0x179)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a404_0x399a4e(0x1f8)),zip_creator_rollback_1=require(a404_0x399a4e(0x1f1)),shortid_1=__importDefault(require('shortid')),promises_1=require(a404_0x399a4e(0x1be)),vpk_service_1=require(a404_0x399a4e(0x1b2)),status_enums_1=require(a404_0x399a4e(0x1e8)),salesforce_dml_error_1=require(a404_0x399a4e(0x1d6)),metadata_log_dto_1=require(a404_0x399a4e(0x1a1)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x2edb5a,connectionVeeva:_0x295c2d,logger:_0x5ee51e,tempFolder:_0x2a0222,instanceUrl:_0x4a9dcb,timeZone:_0x3946a8,metadataLogId:_0x55c7fc,attachmentLogId:_0x4556e7,parentMetadataLogId:_0x535532,componentIds:_0x1b5e6e}){const _0x2542a4=a404_0x399a4e;this[_0x2542a4(0x19c)]=_0x2edb5a,this[_0x2542a4(0x16f)]=_0x295c2d,this[_0x2542a4(0x1a0)]=_0x5ee51e,this[_0x2542a4(0x1f6)]=_0x2a0222,this[_0x2542a4(0x18c)]=_0x4a9dcb,this['_timeZone']=_0x3946a8,this['_metadataLogId']=_0x55c7fc,this[_0x2542a4(0x1d7)]=_0x4556e7,this[_0x2542a4(0x1f9)]=_0x535532,this[_0x2542a4(0x1cf)]=_0x1b5e6e,this[_0x2542a4(0x1a2)]=new core_1[(_0x2542a4(0x1e1))](_0x2542a4(0x1a5)),this['_veevaService']=new veeva_service_1[(_0x2542a4(0x1e6))]({'connection':_0x295c2d,'logger':_0x5ee51e}),this[_0x2542a4(0x1c8)]=new salesforce_service_1[(_0x2542a4(0x19d))]({'connection':_0x2edb5a}),this['_packageImportService']=new package_import_service_1[(_0x2542a4(0x172))]({'veevaService':this[_0x2542a4(0x191)],'connection':_0x295c2d,'logger':_0x5ee51e,'saveLog':this[_0x2542a4(0x1dd)][_0x2542a4(0x181)](this)}),this['_vpkService']=new vpk_service_1[(_0x2542a4(0x175))]({'connection':_0x295c2d});}async[a404_0x399a4e(0x1dd)](_0x544b58,_0x9e4352){const _0x5e85e7=a404_0x399a4e;this[_0x5e85e7(0x1a0)][_0x5e85e7(0x1fd)](_0x5e85e7(0x1f2));const _0x5b69e9={'Body':Buffer[_0x5e85e7(0x186)](_0x544b58)[_0x5e85e7(0x17f)]('base64'),'ContentType':_0x5e85e7(0x197),'ParentId':this[_0x5e85e7(0x1c1)],'Name':_0x9e4352};await this['_connectionSalesforce'][_0x5e85e7(0x1a8)](flosum_constants_1[_0x5e85e7(0x182)][_0x5e85e7(0x1ea)]+_0x5e85e7(0x1a3),_0x5b69e9);}async['retrieveMetadataLog'](){const _0x57c978=a404_0x399a4e;this[_0x57c978(0x1a0)][_0x57c978(0x1fd)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x1d62a7]=await this[_0x57c978(0x1c8)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x57c978(0x1b8)]+_0x57c978(0x196)+constants_1['FLOSUM_NAMESPACE']+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x57c978(0x1b8)]+_0x57c978(0x198)+this[_0x57c978(0x1c1)]+_0x57c978(0x1ec));return new metadata_log_dto_1['MetadataLogDto'](_0x1d62a7);}async['retrieveDeploymentResults'](){const _0x5c275b=a404_0x399a4e;this[_0x5c275b(0x1a0)][_0x5c275b(0x1fd)](_0x5c275b(0x1b1));const _0x4a731c=await new id_deployment_result_retriever_1[(_0x5c275b(0x18e))]({'salesforceService':this[_0x5c275b(0x1c8)],'value':this[_0x5c275b(0x1cf)]})[_0x5c275b(0x18f)]();if(!_0x4a731c[_0x5c275b(0x1b0)])throw new Error(_0x5c275b(0x1e3));return _0x4a731c;}async[a404_0x399a4e(0x1e7)](){const _0x1dba88=a404_0x399a4e;this['_logger'][_0x1dba88(0x1fd)](_0x1dba88(0x1d5));const _0x4f794d=await this[_0x1dba88(0x1c8)][_0x1dba88(0x1fc)](_0x1dba88(0x194)+this[_0x1dba88(0x1f9)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0x1dba88(0x182)][_0x1dba88(0x17e)]+_0x1dba88(0x1ec)),_0x23e26f=await(0x0,fetch_attachments_1[_0x1dba88(0x168)])(this[_0x1dba88(0x19c)],[_0x4f794d[0x0]['Id']]),_0x510928=await(0x0,fetch_attachments_1[_0x1dba88(0x1bc)])(_0x23e26f,this[_0x1dba88(0x19c)]);if(!_0x510928[_0x1dba88(0x1b0)])throw new Error(_0x1dba88(0x180));return _0x510928[0x0]['values'][_0x1dba88(0x19b)];}async[a404_0x399a4e(0x1eb)](_0x1dabbd){const _0x33454a=a404_0x399a4e;this[_0x33454a(0x1a0)][_0x33454a(0x1fd)](_0x33454a(0x1e4));const _0x5e473d=await this['retrieveBackup'](),_0x28efbe=await new zip_creator_rollback_1[(_0x33454a(0x184))]({'rollbackName':this[_0x33454a(0x16c)][_0x33454a(0x1d4)],'backup':_0x5e473d,'deploymentResults':_0x1dabbd})['create'](),_0x336aba=this[_0x33454a(0x1f6)]+'/'+(0x0,shortid_1[_0x33454a(0x1fa)])()+_0x33454a(0x1c6);return await(0x0,promises_1[_0x33454a(0x1b3)])(_0x336aba,_0x28efbe),_0x336aba;}async[a404_0x399a4e(0x1ac)](_0x4be35b){const _0x4651ea=a404_0x399a4e;this[_0x4651ea(0x1a0)][_0x4651ea(0x1fd)]('Create\x20Vpk\x20package');const _0x143f94=await this[_0x4651ea(0x1c3)][_0x4651ea(0x1e0)](_0x4be35b),_0x5baac8=this[_0x4651ea(0x1f6)]+_0x4651ea(0x1b5)+_0x4be35b['slice'](_0x4be35b['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x4651ea(0x1b3)])(_0x5baac8,_0x143f94),await this[_0x4651ea(0x1c3)]['validate'](_0x5baac8),_0x5baac8;}[a404_0x399a4e(0x189)](_0x5149a3){const _0x58a0d=a404_0x399a4e;return this['_logger'][_0x58a0d(0x1fd)](_0x58a0d(0x1bb)),_0x5149a3['map'](_0x16599c=>{const _0x49e83c=_0x58a0d;return this[_0x49e83c(0x1a0)]['log'](_0x16599c[_0x49e83c(0x195)]+'.'+_0x16599c[_0x49e83c(0x1d4)]+'\x20:\x20'+_0x16599c['status']),{[constants_1[_0x49e83c(0x1b8)]+'Type__c']:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+_0x49e83c(0x1a4)]:_0x16599c[_0x49e83c(0x18a)]===status_enums_1[_0x49e83c(0x1d3)][_0x49e83c(0x17c)]?_0x49e83c(0x1ae):_0x49e83c(0x1f4),[constants_1[_0x49e83c(0x1b8)]+_0x49e83c(0x1e9)]:_0x16599c[_0x49e83c(0x16e)],[constants_1[_0x49e83c(0x1b8)]+_0x49e83c(0x187)]:_0x16599c[_0x49e83c(0x1d4)],[constants_1[_0x49e83c(0x1b8)]+_0x49e83c(0x1b7)]:_0x16599c['type'],[constants_1['FLOSUM_NAMESPACE']+_0x49e83c(0x176)]:_0x16599c[_0x49e83c(0x1e2)],[constants_1[_0x49e83c(0x1b8)]+_0x49e83c(0x1de)]:this[_0x49e83c(0x16c)][_0x49e83c(0x1f0)],[constants_1['FLOSUM_NAMESPACE']+_0x49e83c(0x17a)]:this['_metadataLogId']};});}async[a404_0x399a4e(0x16a)](_0x4b3fe1){const _0xa1c496=a404_0x399a4e;this[_0xa1c496(0x1a0)][_0xa1c496(0x1fd)]('Save\x20Deployment\x20Results');const _0x53d379=await this[_0xa1c496(0x1c8)][_0xa1c496(0x1ed)](constants_1[_0xa1c496(0x1b8)]+_0xa1c496(0x1c2),_0x4b3fe1),_0x4dcfda=_0x53d379['filter'](_0x5c83d6=>!_0x5c83d6[_0xa1c496(0x177)])[_0xa1c496(0x169)](_0x1658ef=>_0x1658ef[_0xa1c496(0x1c7)])[_0xa1c496(0x183)]();if(_0x4dcfda[_0xa1c496(0x1b0)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x4dcfda);}async['finishRollbackWithError'](_0x4f8386){const _0x23f391=a404_0x399a4e;if(!this['_metadataLog']){this[_0x23f391(0x1a2)][_0x23f391(0x185)](_0x4f8386);return;}this[_0x23f391(0x1a0)][_0x23f391(0x1a7)](_0x4f8386),await this[_0x23f391(0x1a0)]['updateLog'](),await this['finishRollback'](![],!![],'');}async[a404_0x399a4e(0x1ba)](_0x36fc3c,_0xc9d6d6,_0x4f6391){const _0x5ec15a=a404_0x399a4e,{id:_0x47888a,organizationId:_0xcdf6a5,branchId:_0x219288,organizationName:_0x292c64}=this[_0x5ec15a(0x16c)],_0x3d5eb2=_0x5ec15a(0x1c4)+this[_0x5ec15a(0x18c)]+'/'+_0x47888a+'\x20>\x20'+'Veeva\x20Rollback\x20(Deployment)'+_0x5ec15a(0x193),_0x3d61ec=_0x5ec15a(0x1c4)+this[_0x5ec15a(0x18c)]+'/'+_0xcdf6a5+'\x20>'+_0x292c64+'</a>',_0x27f4cf=_0x3d5eb2+_0x5ec15a(0x1ca)+_0x3d61ec+_0x5ec15a(0x1f3),_0x1b695a={[constants_1[_0x5ec15a(0x1b8)]+_0x5ec15a(0x173)]:_0x27f4cf,[constants_1[_0x5ec15a(0x1b8)]+'Date__c']:new Date(),[constants_1[_0x5ec15a(0x1b8)]+_0x5ec15a(0x1d0)]:_0x219288,[constants_1[_0x5ec15a(0x1b8)]+_0x5ec15a(0x1d9)]:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x5ec15a(0x1bd)]:_0x5ec15a(0x1c0),[constants_1[_0x5ec15a(0x1b8)]+_0x5ec15a(0x1f7)]:_0xcdf6a5},_0x44983c={[constants_1[_0x5ec15a(0x1b8)]+_0x5ec15a(0x1aa)]:!_0x36fc3c,[constants_1[_0x5ec15a(0x1b8)]+_0x5ec15a(0x171)]:_0x36fc3c,[constants_1[_0x5ec15a(0x1b8)]+'Status__c']:_0xc9d6d6?status_enums_1[_0x5ec15a(0x1af)][_0x5ec15a(0x1bf)]:status_enums_1['MetadataLogStatus'][_0x5ec15a(0x1d2)],[constants_1[_0x5ec15a(0x1b8)]+_0x5ec15a(0x1b4)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x5ec15a(0x17b)]:_0x4f6391};await this[_0x5ec15a(0x19c)]['patch'](flosum_constants_1[_0x5ec15a(0x182)][_0x5ec15a(0x1ea)]+'/'+constants_1[_0x5ec15a(0x1b8)]+_0x5ec15a(0x174)+this[_0x5ec15a(0x1c1)],_0x44983c),await this[_0x5ec15a(0x19c)]['post'](flosum_constants_1[_0x5ec15a(0x182)][_0x5ec15a(0x1ea)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x5ec15a(0x1e5),_0x1b695a),this['_logger'][_0x5ec15a(0x1fd)]('Rollback\x20completed\x20'+(_0x36fc3c?_0x5ec15a(0x199):_0x5ec15a(0x1da))+'.'),await this[_0x5ec15a(0x1a0)][_0x5ec15a(0x1a9)]();}async[a404_0x399a4e(0x16b)](){const _0x2ad57e=a404_0x399a4e;try{this[_0x2ad57e(0x16c)]=await this[_0x2ad57e(0x1db)]();const _0x3c7c6d=await this[_0x2ad57e(0x17d)]();await this[_0x2ad57e(0x1a0)][_0x2ad57e(0x1a9)]();const _0x47a517=await this[_0x2ad57e(0x1eb)](_0x3c7c6d),_0x2b31ad=await this['createVpk'](_0x47a517);await this[_0x2ad57e(0x1a0)][_0x2ad57e(0x1a9)]();const _0x7e9f5a=await this[_0x2ad57e(0x18d)][_0x2ad57e(0x1ee)](_0x2b31ad);await this[_0x2ad57e(0x1a0)][_0x2ad57e(0x1a9)]();const _0x4f17f6=this['formFlosumDeploymentResults'](_0x7e9f5a[_0x2ad57e(0x170)]);await this[_0x2ad57e(0x16a)](_0x4f17f6),await this['finishRollback'](_0x7e9f5a[_0x2ad57e(0x1ce)],![],_0x7e9f5a[_0x2ad57e(0x1d8)]);}catch(_0x4a70da){await this[_0x2ad57e(0x1c5)](_0x4a70da)[_0x2ad57e(0x1d1)](_0x148c5a=>this['_systemLogger']['error'](_0x148c5a));}}}exports[a404_0x399a4e(0x178)]=RollbackService;