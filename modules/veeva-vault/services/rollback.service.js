const a360_0x1f230e=a360_0x1ff5;(function(_0x269c5d,_0xd0654d){const _0x3cb05b=a360_0x1ff5,_0x2537c6=_0x269c5d();while(!![]){try{const _0x18ca2b=-parseInt(_0x3cb05b(0x1ad))/0x1+-parseInt(_0x3cb05b(0x143))/0x2+parseInt(_0x3cb05b(0x1c8))/0x3+-parseInt(_0x3cb05b(0x157))/0x4+parseInt(_0x3cb05b(0x158))/0x5+-parseInt(_0x3cb05b(0x1ca))/0x6+parseInt(_0x3cb05b(0x168))/0x7;if(_0x18ca2b===_0xd0654d)break;else _0x2537c6['push'](_0x2537c6['shift']());}catch(_0x1791a9){_0x2537c6['push'](_0x2537c6['shift']());}}}(a360_0xe7a1,0x657d6));function a360_0x1ff5(_0x1656f4,_0x2569bd){const _0x48623d=a360_0xe7a1();return a360_0x1ff5=function(_0x1fa8ba,_0x4ec9ef){_0x1fa8ba=_0x1fa8ba-0x140;let _0xe7a1b=_0x48623d[_0x1fa8ba];return _0xe7a1b;},a360_0x1ff5(_0x1656f4,_0x2569bd);}const a360_0x4ec9ef=(function(){let _0x853e5f=!![];return function(_0xe6b839,_0x383c26){const _0x447e9e=_0x853e5f?function(){const _0x48cc15=a360_0x1ff5;if(_0x383c26){const _0x101bd7=_0x383c26[_0x48cc15(0x160)](_0xe6b839,arguments);return _0x383c26=null,_0x101bd7;}}:function(){};return _0x853e5f=![],_0x447e9e;};}()),a360_0x1fa8ba=a360_0x4ec9ef(this,function(){const _0x67cf6a=a360_0x1ff5;return a360_0x1fa8ba[_0x67cf6a(0x1a3)]()[_0x67cf6a(0x1a6)](_0x67cf6a(0x1c1))[_0x67cf6a(0x1a3)]()[_0x67cf6a(0x1af)](a360_0x1fa8ba)['search'](_0x67cf6a(0x1c1));});function a360_0xe7a1(){const _0x51fcd2=['from','Action__c','stepName','</a>','819063GbbtAa','./veeva.service','2902464ObGAlz','Save\x20Deployment\x20Results','SalesforceService','Is_Error__c','fetchAttachmentsDetailsById','Job_Completed__c','catch','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','type','/Attachment','Status__c','Succeed__c','864526iedhLO','_vpkService','shortid','Cannot\x20find\x20Deployment\x20Results','Deployment','EXCEPTION','Branch__c','finishRollbackWithError','VeevaService','DEPLOYED','../enums/status.enums','_metadataLogId','finishRollback','errors','length','saveLog','createVpk','_componentIds','../constants/flosum.constants','defineProperty','3024104ElufJd','618165ZZOQqL','../dtos/metadata-log.dto','retrieveBackup','post','organizationId','Result__c','filter','_tempFolder','apply','packageComponentList','retrieveRecords','FlosumConstants','log','COMPLETED','Async_Request_Id__c','Save\x20log','16707278fKgghq','create','\x20</a>','updateLog','./vpk.service','_logger','patch','Org__c','logError','VpkService','Deployment\x20Result','insertMultipleRecords','writeFile','_timeZone','success','map','Deployment_Result__c','ZipCreatorRollback','Component_Name__c','_metadataLog','FLOSUM_NAMESPACE','_salesforceService','_packageImportService','../classes/rollback/zip-creator.rollback','retrieveAttachments','ENDPOINT_UPSERT_RECORD','PackageComponentStatus','./salesforce.service','TargetId__c','MetadataLogStatus','values','Retrieve\x20Deployment\x20Results','Type__c','Activity_Item__c','error','\x20has\x20been\x20created.','text/plain','default','IdDeploymentResultRetriever','Failure','RollbackService','generate','PackageImportService','isDeployed','Retrieve\x20Metadata\x20Log\x20info','retrieveDeploymentResults','./package-import.service','bind','name','.zip','Metadata_Log__c','_instanceUrl','packageId','retrieveMetadataLog','/vpk__','flat','Component_Type__c','import','../classes/errors/salesforce-dml-error','toString','BACKUP_ZIP_NAME','formFlosumDeploymentResults','search','createZip','<a\x20href=','_systemLogger','\x27\x20AND\x20Name\x20=\x20\x27','../../../core','\x27\x0a\x20\x20\x20\x20','695673nKTvjd','Date__c','constructor','deploymentAction','Veeva\x20Rollback\x20(Deployment)','Logger','_connectionSalesforce','base64','veeva-rollback','__esModule','slice','../classes/retrievers/deployment-results/id.deployment-result.retriever','Create\x20zip\x20from\x20backup','../../../constants','MetadataLogDto','_parentMetadataLogId','Activity_Type__c','Log__c','status','retrieve','(((.+)+)+)+$','Branch','\x20of\x20branch\x20to\x20Organization\x20'];a360_0xe7a1=function(){return _0x51fcd2;};return a360_0xe7a1();}a360_0x1fa8ba();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3cad31){return _0x3cad31&&_0x3cad31['__esModule']?_0x3cad31:{'default':_0x3cad31};};Object[a360_0x1f230e(0x156)](exports,a360_0x1f230e(0x1b6),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a360_0x1f230e(0x1c9)),salesforce_service_1=require(a360_0x1f230e(0x183)),package_import_service_1=require(a360_0x1f230e(0x196)),id_deployment_result_retriever_1=require(a360_0x1f230e(0x1b8)),flosum_constants_1=require(a360_0x1f230e(0x155)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a360_0x1f230e(0x1ba)),zip_creator_rollback_1=require(a360_0x1f230e(0x17f)),shortid_1=__importDefault(require(a360_0x1f230e(0x145))),promises_1=require('fs/promises'),vpk_service_1=require(a360_0x1f230e(0x16c)),status_enums_1=require(a360_0x1f230e(0x14d)),salesforce_dml_error_1=require(a360_0x1f230e(0x1a2)),metadata_log_dto_1=require(a360_0x1f230e(0x159)),core_1=require(a360_0x1f230e(0x1ab));class RollbackService{constructor({connectionSalesforce:_0x467021,connectionVeeva:_0xe64545,logger:_0x1b7faa,tempFolder:_0x5923ab,instanceUrl:_0x40b8c7,timeZone:_0x3f776c,metadataLogId:_0x1d85d3,attachmentLogId:_0x1a4d47,parentMetadataLogId:_0xb812a7,componentIds:_0x1db4b1}){const _0x2a7863=a360_0x1f230e;this[_0x2a7863(0x1b3)]=_0x467021,this['_connectionVeeva']=_0xe64545,this[_0x2a7863(0x16d)]=_0x1b7faa,this[_0x2a7863(0x15f)]=_0x5923ab,this['_instanceUrl']=_0x40b8c7,this[_0x2a7863(0x175)]=_0x3f776c,this[_0x2a7863(0x14e)]=_0x1d85d3,this['_attachmentLogId']=_0x1a4d47,this[_0x2a7863(0x1bc)]=_0xb812a7,this[_0x2a7863(0x154)]=_0x1db4b1,this['_systemLogger']=new core_1[(_0x2a7863(0x1b2))](_0x2a7863(0x1b5)),this['_veevaService']=new veeva_service_1[(_0x2a7863(0x14b))]({'connection':_0xe64545,'logger':_0x1b7faa}),this[_0x2a7863(0x17d)]=new salesforce_service_1[(_0x2a7863(0x1cc))]({'connection':_0x467021}),this['_packageImportService']=new package_import_service_1[(_0x2a7863(0x192))]({'veevaService':this['_veevaService'],'connection':_0xe64545,'logger':_0x1b7faa,'saveLog':this[_0x2a7863(0x152)][_0x2a7863(0x197)](this)}),this[_0x2a7863(0x144)]=new vpk_service_1[(_0x2a7863(0x171))]({'connection':_0xe64545});}async['saveLog'](_0x2ba4a7,_0x2d9671){const _0x4c55bc=a360_0x1f230e;this['_logger']['log'](_0x4c55bc(0x167));const _0x59496f={'Body':Buffer[_0x4c55bc(0x1c4)](_0x2ba4a7)[_0x4c55bc(0x1a3)](_0x4c55bc(0x1b4)),'ContentType':_0x4c55bc(0x18c),'ParentId':this[_0x4c55bc(0x14e)],'Name':_0x2d9671};await this[_0x4c55bc(0x1b3)][_0x4c55bc(0x15b)](flosum_constants_1[_0x4c55bc(0x163)][_0x4c55bc(0x181)]+_0x4c55bc(0x140),_0x59496f);}async[a360_0x1f230e(0x19d)](){const _0x2a6e53=a360_0x1f230e;this['_logger'][_0x2a6e53(0x164)](_0x2a6e53(0x194));const [_0x1063a4]=await this[_0x2a6e53(0x17d)][_0x2a6e53(0x162)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x2a6e53(0x17c)]+_0x2a6e53(0x1d1)+constants_1[_0x2a6e53(0x17c)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x2a6e53(0x17c)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x2a6e53(0x14e)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x2a6e53(0x1bb))](_0x1063a4);}async[a360_0x1f230e(0x195)](){const _0x1fc1d3=a360_0x1f230e;this[_0x1fc1d3(0x16d)][_0x1fc1d3(0x164)](_0x1fc1d3(0x187));const _0xcc6ff0=await new id_deployment_result_retriever_1[(_0x1fc1d3(0x18e))]({'salesforceService':this[_0x1fc1d3(0x17d)],'value':this['_componentIds']})[_0x1fc1d3(0x1c0)]();if(!_0xcc6ff0[_0x1fc1d3(0x151)])throw new Error(_0x1fc1d3(0x146));return _0xcc6ff0;}async[a360_0x1f230e(0x15a)](){const _0x3795a7=a360_0x1f230e;this[_0x3795a7(0x16d)][_0x3795a7(0x164)]('Retrieve\x20Backup');const _0x5bb4bb=await this[_0x3795a7(0x17d)][_0x3795a7(0x162)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x3795a7(0x1bc)]+_0x3795a7(0x1aa)+flosum_constants_1[_0x3795a7(0x163)][_0x3795a7(0x1a4)]+_0x3795a7(0x1ac)),_0x176b1e=await(0x0,fetch_attachments_1[_0x3795a7(0x1ce)])(this[_0x3795a7(0x1b3)],[_0x5bb4bb[0x0]['Id']]),_0x3e3912=await(0x0,fetch_attachments_1[_0x3795a7(0x180)])(_0x176b1e,this[_0x3795a7(0x1b3)]);if(!_0x3e3912[_0x3795a7(0x151)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x3e3912[0x0][_0x3795a7(0x186)]['Body'];}async[a360_0x1f230e(0x1a7)](_0xa99cf2){const _0x52afb0=a360_0x1f230e;this[_0x52afb0(0x16d)][_0x52afb0(0x164)](_0x52afb0(0x1b9));const _0x8db610=await this[_0x52afb0(0x15a)](),_0x25371b=await new zip_creator_rollback_1[(_0x52afb0(0x179))]({'rollbackName':this['_metadataLog'][_0x52afb0(0x198)],'backup':_0x8db610,'deploymentResults':_0xa99cf2})[_0x52afb0(0x169)](),_0x2ccd44=this['_tempFolder']+'/'+(0x0,shortid_1[_0x52afb0(0x18d)])()+_0x52afb0(0x199);return await(0x0,promises_1[_0x52afb0(0x174)])(_0x2ccd44,_0x25371b),_0x2ccd44;}async['createVpk'](_0x55919b){const _0x473b76=a360_0x1f230e;this['_logger']['log']('Create\x20Vpk\x20package');const _0x69970d=await this[_0x473b76(0x144)][_0x473b76(0x191)](_0x55919b),_0x40480a=this[_0x473b76(0x15f)]+_0x473b76(0x19e)+_0x55919b[_0x473b76(0x1b7)](_0x55919b['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x473b76(0x174)])(_0x40480a,_0x69970d),await this[_0x473b76(0x144)]['validate'](_0x40480a),_0x40480a;}[a360_0x1f230e(0x1a5)](_0x42846e){const _0x17690=a360_0x1f230e;return this[_0x17690(0x16d)][_0x17690(0x164)]('Form\x20Deployment\x20Results'),_0x42846e[_0x17690(0x177)](_0x4f1040=>{const _0x142f2f=_0x17690;return this['_logger']['log'](_0x4f1040[_0x142f2f(0x1d2)]+'.'+_0x4f1040[_0x142f2f(0x198)]+'\x20:\x20'+_0x4f1040[_0x142f2f(0x1bf)]),{[constants_1[_0x142f2f(0x17c)]+_0x142f2f(0x188)]:_0x142f2f(0x172),[constants_1[_0x142f2f(0x17c)]+'Status__c']:_0x4f1040['status']===status_enums_1[_0x142f2f(0x182)][_0x142f2f(0x14c)]?'Success':_0x142f2f(0x18f),[constants_1['FLOSUM_NAMESPACE']+_0x142f2f(0x15d)]:_0x4f1040[_0x142f2f(0x1b0)],[constants_1['FLOSUM_NAMESPACE']+_0x142f2f(0x17a)]:_0x4f1040[_0x142f2f(0x198)],[constants_1[_0x142f2f(0x17c)]+_0x142f2f(0x1a0)]:_0x4f1040['type'],[constants_1[_0x142f2f(0x17c)]+'Veeva_Step_Name__c']:_0x4f1040[_0x142f2f(0x1c6)],[constants_1[_0x142f2f(0x17c)]+_0x142f2f(0x16f)]:this[_0x142f2f(0x17b)][_0x142f2f(0x15c)],[constants_1['FLOSUM_NAMESPACE']+_0x142f2f(0x19a)]:this[_0x142f2f(0x14e)]};});}async['saveDeploymentResults'](_0x4a9bee){const _0x1b6b5b=a360_0x1f230e;this[_0x1b6b5b(0x16d)][_0x1b6b5b(0x164)](_0x1b6b5b(0x1cb));const _0x412b05=await this['_salesforceService'][_0x1b6b5b(0x173)](constants_1[_0x1b6b5b(0x17c)]+_0x1b6b5b(0x178),_0x4a9bee),_0xbda913=_0x412b05[_0x1b6b5b(0x15e)](_0x197707=>!_0x197707[_0x1b6b5b(0x176)])[_0x1b6b5b(0x177)](_0x271500=>_0x271500[_0x1b6b5b(0x150)])[_0x1b6b5b(0x19f)]();if(_0xbda913[_0x1b6b5b(0x151)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0xbda913);}async[a360_0x1f230e(0x14a)](_0x8e88bb){const _0x6e224a=a360_0x1f230e;if(!this[_0x6e224a(0x17b)]){this[_0x6e224a(0x1a9)][_0x6e224a(0x18a)](_0x8e88bb);return;}this['_logger'][_0x6e224a(0x170)](_0x8e88bb),await this['_logger'][_0x6e224a(0x16b)](),await this[_0x6e224a(0x14f)](![],!![],'');}async[a360_0x1f230e(0x14f)](_0x2b0bcc,_0xfab3b2,_0x460433){const _0x5439ec=a360_0x1f230e,{id:_0x323c66,organizationId:_0x1bf369,branchId:_0x5e42ba,organizationName:_0x2ec0e0}=this[_0x5439ec(0x17b)],_0x35a41f='<a\x20href='+this[_0x5439ec(0x19b)]+'/'+_0x323c66+'\x20>\x20'+_0x5439ec(0x1b1)+_0x5439ec(0x16a),_0x291733=_0x5439ec(0x1a8)+this[_0x5439ec(0x19b)]+'/'+_0x1bf369+'\x20>'+_0x2ec0e0+_0x5439ec(0x1c7),_0x13433b=_0x35a41f+_0x5439ec(0x1c3)+_0x291733+_0x5439ec(0x18b),_0x1d4231={[constants_1[_0x5439ec(0x17c)]+_0x5439ec(0x1c5)]:_0x13433b,[constants_1['FLOSUM_NAMESPACE']+_0x5439ec(0x1ae)]:new Date(),[constants_1[_0x5439ec(0x17c)]+_0x5439ec(0x149)]:_0x5e42ba,[constants_1[_0x5439ec(0x17c)]+_0x5439ec(0x189)]:_0x5439ec(0x1c2),[constants_1[_0x5439ec(0x17c)]+_0x5439ec(0x1bd)]:_0x5439ec(0x147),[constants_1[_0x5439ec(0x17c)]+_0x5439ec(0x184)]:_0x1bf369},_0x4f2d4f={[constants_1[_0x5439ec(0x17c)]+_0x5439ec(0x1cd)]:!_0x2b0bcc,[constants_1[_0x5439ec(0x17c)]+_0x5439ec(0x142)]:_0x2b0bcc,[constants_1[_0x5439ec(0x17c)]+_0x5439ec(0x141)]:_0xfab3b2?status_enums_1[_0x5439ec(0x185)][_0x5439ec(0x148)]:status_enums_1[_0x5439ec(0x185)][_0x5439ec(0x165)],[constants_1['FLOSUM_NAMESPACE']+_0x5439ec(0x1cf)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x5439ec(0x166)]:_0x460433};await this['_connectionSalesforce'][_0x5439ec(0x16e)](flosum_constants_1[_0x5439ec(0x163)][_0x5439ec(0x181)]+'/'+constants_1[_0x5439ec(0x17c)]+'Metadata_Log__c/'+this[_0x5439ec(0x14e)],_0x4f2d4f),await this[_0x5439ec(0x1b3)][_0x5439ec(0x15b)](flosum_constants_1[_0x5439ec(0x163)][_0x5439ec(0x181)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x5439ec(0x1be),_0x1d4231),this[_0x5439ec(0x16d)][_0x5439ec(0x164)]('Rollback\x20completed\x20'+(_0x2b0bcc?'successfully':'with\x20error')+'.'),await this[_0x5439ec(0x16d)][_0x5439ec(0x16b)]();}async['execute'](){const _0x3036b8=a360_0x1f230e;try{this[_0x3036b8(0x17b)]=await this['retrieveMetadataLog']();const _0x8faf61=await this[_0x3036b8(0x195)]();await this[_0x3036b8(0x16d)][_0x3036b8(0x16b)]();const _0x1697b9=await this[_0x3036b8(0x1a7)](_0x8faf61),_0x4ec841=await this[_0x3036b8(0x153)](_0x1697b9);await this[_0x3036b8(0x16d)][_0x3036b8(0x16b)]();const _0x5a9d2c=await this[_0x3036b8(0x17e)][_0x3036b8(0x1a1)](_0x4ec841);await this[_0x3036b8(0x16d)][_0x3036b8(0x16b)]();const _0x536ac2=this[_0x3036b8(0x1a5)](_0x5a9d2c[_0x3036b8(0x161)]);await this['saveDeploymentResults'](_0x536ac2),await this[_0x3036b8(0x14f)](_0x5a9d2c[_0x3036b8(0x193)],![],_0x5a9d2c[_0x3036b8(0x19c)]);}catch(_0x49a7b9){await this[_0x3036b8(0x14a)](_0x49a7b9)[_0x3036b8(0x1d0)](_0x5eeb27=>this[_0x3036b8(0x1a9)]['error'](_0x5eeb27));}}}exports[a360_0x1f230e(0x190)]=RollbackService;