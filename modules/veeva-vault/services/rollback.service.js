const a337_0x30ba99=a337_0x3a1f;(function(_0x496bf4,_0x51af7a){const _0x2b1dd7=a337_0x3a1f,_0x484519=_0x496bf4();while(!![]){try{const _0x51fa93=-parseInt(_0x2b1dd7(0x16b))/0x1+parseInt(_0x2b1dd7(0x11a))/0x2+-parseInt(_0x2b1dd7(0x140))/0x3*(-parseInt(_0x2b1dd7(0x195))/0x4)+parseInt(_0x2b1dd7(0x115))/0x5*(-parseInt(_0x2b1dd7(0x18a))/0x6)+-parseInt(_0x2b1dd7(0x149))/0x7+-parseInt(_0x2b1dd7(0x158))/0x8*(-parseInt(_0x2b1dd7(0x134))/0x9)+-parseInt(_0x2b1dd7(0x166))/0xa*(parseInt(_0x2b1dd7(0x168))/0xb);if(_0x51fa93===_0x51af7a)break;else _0x484519['push'](_0x484519['shift']());}catch(_0x2cad89){_0x484519['push'](_0x484519['shift']());}}}(a337_0x71d1,0x84683));const a337_0x58fac8=(function(){let _0x289da2=!![];return function(_0x5ee638,_0x52a06c){const _0x4069ac=_0x289da2?function(){const _0x1a0997=a337_0x3a1f;if(_0x52a06c){const _0x558733=_0x52a06c[_0x1a0997(0x137)](_0x5ee638,arguments);return _0x52a06c=null,_0x558733;}}:function(){};return _0x289da2=![],_0x4069ac;};}()),a337_0x401575=a337_0x58fac8(this,function(){const _0x3e9fa3=a337_0x3a1f;return a337_0x401575[_0x3e9fa3(0x175)]()['search'](_0x3e9fa3(0x17d))[_0x3e9fa3(0x175)]()[_0x3e9fa3(0x186)](a337_0x401575)['search']('(((.+)+)+)+$');});a337_0x401575();'use strict';var __importDefault=this&&this[a337_0x30ba99(0x18f)]||function(_0x39913b){const _0xa207f3=a337_0x30ba99;return _0x39913b&&_0x39913b[_0xa207f3(0x10d)]?_0x39913b:{'default':_0x39913b};};function a337_0x71d1(){const _0x5aa414=['../../../constants','Save\x20log','name','DEPLOYED','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','./vpk.service','Success','EXCEPTION','_connectionSalesforce','VpkService','../classes/errors/salesforce-dml-error','4571944fulCty','Rollback\x20completed\x20','patch','RollbackService','MetadataLogDto','status','Status__c','filter','FLOSUM_NAMESPACE','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','fs/promises','finishRollback','</a>','Failure','521320JXytTK','../../../core','11VLLUQg','packageComponentList','Veeva\x20Rollback\x20(Deployment)','41891sUcNWC','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','_systemLogger','BACKUP_ZIP_NAME','deploymentAction','_metadataLog','organizationId','retrieveMetadataLog','error','/vpk__','toString','logError','Deployment\x20Result','_veevaService','Date__c','\x20has\x20been\x20created.','Log__c','Succeed__c','(((.+)+)+)+$','Logger','Cannot\x20find\x20Backup\x20Zip','Result__c','\x20</a>','Deployment','errors','formFlosumDeploymentResults','Type__c','constructor','./veeva.service','defineProperty','Activity_Item__c','5598WPoCVC','SalesforceDmlError','Veeva_Step_Name__c','lastIndexOf','Branch__c','__importDefault','map','IdDeploymentResultRetriever','\x20>\x20','<a\x20href=','type','4cApykf','saveLog','create','PackageComponentStatus','Retrieve\x20Deployment\x20Results','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_timeZone','length','../../shared/utils/fetch-attachments','../classes/rollback/zip-creator.rollback','Metadata_Log__c/','Activity_Type__c','__esModule','text/plain','execute','fetchAttachmentsDetailsById','Save\x20Deployment\x20Results','VeevaService','saveDeploymentResults','_connectionVeeva','4385uFuaCc','Create\x20zip\x20from\x20backup','log','Component_Name__c','_vpkService','1978096BYDSPP','Job_Completed__c','../classes/retrievers/deployment-results/id.deployment-result.retriever','.zip','/Attachment','\x20of\x20branch\x20to\x20Organization\x20','Action__c','\x27\x0a\x20\x20\x20\x20','stepName','_parentMetadataLogId','updateLog','\x20:\x20','validate','Metadata_Log__c','_metadataLogId','_salesforceService','catch','post','values','./salesforce.service','shortid','_logger','with\x20error','../constants/flosum.constants','finishRollbackWithError','bind','9HIvxRK','retrieveDeploymentResults','retrieveRecords','apply','_componentIds','createVpk','isDeployed','successfully','retrieveBackup','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_instanceUrl','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','2177331AjLvJs','FlosumConstants','Async_Request_Id__c','Retrieve\x20Backup','_tempFolder','flat','retrieve','success','insertMultipleRecords','5822005pWUvVI','ENDPOINT_UPSERT_RECORD','\x27\x20AND\x20Name\x20=\x20\x27','Body'];a337_0x71d1=function(){return _0x5aa414;};return a337_0x71d1();}Object[a337_0x30ba99(0x188)](exports,a337_0x30ba99(0x10d),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a337_0x30ba99(0x187)),salesforce_service_1=require(a337_0x30ba99(0x12d)),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require(a337_0x30ba99(0x11c)),flosum_constants_1=require(a337_0x30ba99(0x131)),fetch_attachments_1=require(a337_0x30ba99(0x109)),constants_1=require(a337_0x30ba99(0x14d)),zip_creator_rollback_1=require(a337_0x30ba99(0x10a)),shortid_1=__importDefault(require(a337_0x30ba99(0x12e))),promises_1=require(a337_0x30ba99(0x162)),vpk_service_1=require(a337_0x30ba99(0x152)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a337_0x30ba99(0x157)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a337_0x30ba99(0x167));function a337_0x3a1f(_0x1b16ac,_0x238fad){const _0x5e9d46=a337_0x71d1();return a337_0x3a1f=function(_0x401575,_0x58fac8){_0x401575=_0x401575-0x107;let _0x71d17f=_0x5e9d46[_0x401575];return _0x71d17f;},a337_0x3a1f(_0x1b16ac,_0x238fad);}class RollbackService{constructor({connectionSalesforce:_0x3a373d,connectionVeeva:_0x1abb19,logger:_0x244202,tempFolder:_0xe47392,instanceUrl:_0x12c24e,timeZone:_0x269700,metadataLogId:_0x5e4598,attachmentLogId:_0x327402,parentMetadataLogId:_0x3f14bd,componentIds:_0x33b79c}){const _0x16d150=a337_0x30ba99;this[_0x16d150(0x155)]=_0x3a373d,this[_0x16d150(0x114)]=_0x1abb19,this['_logger']=_0x244202,this[_0x16d150(0x144)]=_0xe47392,this[_0x16d150(0x13e)]=_0x12c24e,this[_0x16d150(0x107)]=_0x269700,this['_metadataLogId']=_0x5e4598,this['_attachmentLogId']=_0x327402,this[_0x16d150(0x123)]=_0x3f14bd,this['_componentIds']=_0x33b79c,this[_0x16d150(0x16d)]=new core_1[(_0x16d150(0x17e))]('veeva-rollback'),this[_0x16d150(0x178)]=new veeva_service_1[(_0x16d150(0x112))]({'connection':_0x1abb19,'logger':_0x244202}),this[_0x16d150(0x129)]=new salesforce_service_1['SalesforceService']({'connection':_0x3a373d}),this['_packageImportService']=new package_import_service_1['PackageImportService']({'veevaService':this[_0x16d150(0x178)],'connection':_0x1abb19,'logger':_0x244202,'saveLog':this[_0x16d150(0x196)][_0x16d150(0x133)](this)}),this[_0x16d150(0x119)]=new vpk_service_1[(_0x16d150(0x156))]({'connection':_0x1abb19});}async[a337_0x30ba99(0x196)](_0x3768f6,_0x1f757f){const _0xfbaad=a337_0x30ba99;this[_0xfbaad(0x12f)][_0xfbaad(0x117)](_0xfbaad(0x14e));const _0x4a45de={'Body':Buffer['from'](_0x3768f6)[_0xfbaad(0x175)]('base64'),'ContentType':_0xfbaad(0x10e),'ParentId':this[_0xfbaad(0x128)],'Name':_0x1f757f};await this[_0xfbaad(0x155)]['post'](flosum_constants_1['FlosumConstants'][_0xfbaad(0x14a)]+_0xfbaad(0x11e),_0x4a45de);}async['retrieveMetadataLog'](){const _0x206093=a337_0x30ba99;this['_logger'][_0x206093(0x117)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x398849]=await this[_0x206093(0x129)]['retrieveRecords'](_0x206093(0x151)+constants_1[_0x206093(0x160)]+_0x206093(0x19a)+constants_1[_0x206093(0x160)]+_0x206093(0x13d)+constants_1['FLOSUM_NAMESPACE']+_0x206093(0x161)+constants_1[_0x206093(0x160)]+_0x206093(0x16c)+this[_0x206093(0x128)]+_0x206093(0x121));return new metadata_log_dto_1[(_0x206093(0x15c))](_0x398849);}async[a337_0x30ba99(0x135)](){const _0x2c822b=a337_0x30ba99;this[_0x2c822b(0x12f)][_0x2c822b(0x117)](_0x2c822b(0x199));const _0x4fca6e=await new id_deployment_result_retriever_1[(_0x2c822b(0x191))]({'salesforceService':this[_0x2c822b(0x129)],'value':this[_0x2c822b(0x138)]})[_0x2c822b(0x146)]();if(!_0x4fca6e[_0x2c822b(0x108)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x4fca6e;}async[a337_0x30ba99(0x13c)](){const _0x4a32ff=a337_0x30ba99;this[_0x4a32ff(0x12f)][_0x4a32ff(0x117)](_0x4a32ff(0x143));const _0x1c4180=await this['_salesforceService'][_0x4a32ff(0x136)](_0x4a32ff(0x13f)+this[_0x4a32ff(0x123)]+_0x4a32ff(0x14b)+flosum_constants_1[_0x4a32ff(0x141)][_0x4a32ff(0x16e)]+_0x4a32ff(0x121)),_0x2a2451=await(0x0,fetch_attachments_1[_0x4a32ff(0x110)])(this[_0x4a32ff(0x155)],[_0x1c4180[0x0]['Id']]),_0x3fa422=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x2a2451,this[_0x4a32ff(0x155)]);if(!_0x3fa422[_0x4a32ff(0x108)])throw new Error(_0x4a32ff(0x17f));return _0x3fa422[0x0][_0x4a32ff(0x12c)][_0x4a32ff(0x14c)];}async['createZip'](_0x327712){const _0x4a6e7d=a337_0x30ba99;this['_logger'][_0x4a6e7d(0x117)](_0x4a6e7d(0x116));const _0x1a53a4=await this[_0x4a6e7d(0x13c)](),_0x40df06=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x4a6e7d(0x170)][_0x4a6e7d(0x14f)],'backup':_0x1a53a4,'deploymentResults':_0x327712})[_0x4a6e7d(0x197)](),_0x1db335=this[_0x4a6e7d(0x144)]+'/'+(0x0,shortid_1['default'])()+_0x4a6e7d(0x11d);return await(0x0,promises_1['writeFile'])(_0x1db335,_0x40df06),_0x1db335;}async['createVpk'](_0x2a9889){const _0x155620=a337_0x30ba99;this['_logger']['log']('Create\x20Vpk\x20package');const _0x4c8aab=await this['_vpkService']['generate'](_0x2a9889),_0x417048=this['_tempFolder']+_0x155620(0x174)+_0x2a9889['slice'](_0x2a9889[_0x155620(0x18d)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x417048,_0x4c8aab),await this[_0x155620(0x119)][_0x155620(0x126)](_0x417048),_0x417048;}[a337_0x30ba99(0x184)](_0x23c1c8){const _0x2e0903=a337_0x30ba99;return this['_logger'][_0x2e0903(0x117)]('Form\x20Deployment\x20Results'),_0x23c1c8[_0x2e0903(0x190)](_0x3a68d6=>{const _0x54460d=_0x2e0903;return this[_0x54460d(0x12f)]['log'](_0x3a68d6[_0x54460d(0x194)]+'.'+_0x3a68d6[_0x54460d(0x14f)]+_0x54460d(0x125)+_0x3a68d6[_0x54460d(0x15d)]),{[constants_1[_0x54460d(0x160)]+_0x54460d(0x185)]:_0x54460d(0x177),[constants_1[_0x54460d(0x160)]+_0x54460d(0x15e)]:_0x3a68d6[_0x54460d(0x15d)]===status_enums_1[_0x54460d(0x198)][_0x54460d(0x150)]?_0x54460d(0x153):_0x54460d(0x165),[constants_1[_0x54460d(0x160)]+_0x54460d(0x180)]:_0x3a68d6[_0x54460d(0x16f)],[constants_1['FLOSUM_NAMESPACE']+_0x54460d(0x118)]:_0x3a68d6[_0x54460d(0x14f)],[constants_1[_0x54460d(0x160)]+'Component_Type__c']:_0x3a68d6[_0x54460d(0x194)],[constants_1[_0x54460d(0x160)]+_0x54460d(0x18c)]:_0x3a68d6[_0x54460d(0x122)],[constants_1[_0x54460d(0x160)]+'Org__c']:this[_0x54460d(0x170)][_0x54460d(0x171)],[constants_1[_0x54460d(0x160)]+_0x54460d(0x127)]:this[_0x54460d(0x128)]};});}async['saveDeploymentResults'](_0x359b30){const _0x1f98b3=a337_0x30ba99;this[_0x1f98b3(0x12f)][_0x1f98b3(0x117)](_0x1f98b3(0x111));const _0x355bd6=await this[_0x1f98b3(0x129)][_0x1f98b3(0x148)](constants_1[_0x1f98b3(0x160)]+'Deployment_Result__c',_0x359b30),_0x5b79db=_0x355bd6[_0x1f98b3(0x15f)](_0x3969ee=>!_0x3969ee[_0x1f98b3(0x147)])[_0x1f98b3(0x190)](_0x454bdd=>_0x454bdd[_0x1f98b3(0x183)])[_0x1f98b3(0x145)]();if(_0x5b79db[_0x1f98b3(0x108)])throw new salesforce_dml_error_1[(_0x1f98b3(0x18b))](_0x5b79db);}async[a337_0x30ba99(0x132)](_0x34831d){const _0x2c9756=a337_0x30ba99;if(!this[_0x2c9756(0x170)]){this[_0x2c9756(0x16d)][_0x2c9756(0x173)](_0x34831d);return;}this[_0x2c9756(0x12f)][_0x2c9756(0x176)](_0x34831d),await this[_0x2c9756(0x12f)][_0x2c9756(0x124)](),await this[_0x2c9756(0x163)](![],!![],'');}async['finishRollback'](_0x6c8913,_0x5e653c,_0x99fe3d){const _0x3eeb23=a337_0x30ba99,{id:_0x1298a8,organizationId:_0x36887a,branchId:_0x1d2501,organizationName:_0x382ca4}=this[_0x3eeb23(0x170)],_0x27ec11=_0x3eeb23(0x193)+this[_0x3eeb23(0x13e)]+'/'+_0x1298a8+_0x3eeb23(0x192)+_0x3eeb23(0x16a)+_0x3eeb23(0x181),_0x1152c7=_0x3eeb23(0x193)+this[_0x3eeb23(0x13e)]+'/'+_0x36887a+'\x20>'+_0x382ca4+_0x3eeb23(0x164),_0x99cc61=_0x27ec11+_0x3eeb23(0x11f)+_0x1152c7+_0x3eeb23(0x17a),_0x482f52={[constants_1[_0x3eeb23(0x160)]+_0x3eeb23(0x120)]:_0x99cc61,[constants_1[_0x3eeb23(0x160)]+_0x3eeb23(0x179)]:new Date(),[constants_1[_0x3eeb23(0x160)]+_0x3eeb23(0x18e)]:_0x1d2501,[constants_1[_0x3eeb23(0x160)]+_0x3eeb23(0x189)]:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x3eeb23(0x10c)]:_0x3eeb23(0x182),[constants_1[_0x3eeb23(0x160)]+'TargetId__c']:_0x36887a},_0x465cb4={[constants_1[_0x3eeb23(0x160)]+'Is_Error__c']:!_0x6c8913,[constants_1['FLOSUM_NAMESPACE']+_0x3eeb23(0x17c)]:_0x6c8913,[constants_1[_0x3eeb23(0x160)]+'Status__c']:_0x5e653c?status_enums_1['MetadataLogStatus'][_0x3eeb23(0x154)]:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x3eeb23(0x160)]+_0x3eeb23(0x11b)]:!![],[constants_1[_0x3eeb23(0x160)]+_0x3eeb23(0x142)]:_0x99fe3d};await this[_0x3eeb23(0x155)][_0x3eeb23(0x15a)](flosum_constants_1[_0x3eeb23(0x141)][_0x3eeb23(0x14a)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x3eeb23(0x10b)+this[_0x3eeb23(0x128)],_0x465cb4),await this['_connectionSalesforce'][_0x3eeb23(0x12b)](flosum_constants_1[_0x3eeb23(0x141)][_0x3eeb23(0x14a)]+'/'+constants_1[_0x3eeb23(0x160)]+_0x3eeb23(0x17b),_0x482f52),this[_0x3eeb23(0x12f)][_0x3eeb23(0x117)](_0x3eeb23(0x159)+(_0x6c8913?_0x3eeb23(0x13b):_0x3eeb23(0x130))+'.'),await this[_0x3eeb23(0x12f)][_0x3eeb23(0x124)]();}async[a337_0x30ba99(0x10f)](){const _0x3d9d9c=a337_0x30ba99;try{this['_metadataLog']=await this[_0x3d9d9c(0x172)]();const _0x2cae6c=await this[_0x3d9d9c(0x135)]();await this[_0x3d9d9c(0x12f)][_0x3d9d9c(0x124)]();const _0x5c869c=await this['createZip'](_0x2cae6c),_0x13ec64=await this[_0x3d9d9c(0x139)](_0x5c869c);await this[_0x3d9d9c(0x12f)][_0x3d9d9c(0x124)]();const _0x3b6148=await this['_packageImportService']['import'](_0x13ec64);await this[_0x3d9d9c(0x12f)]['updateLog']();const _0xfc261f=this[_0x3d9d9c(0x184)](_0x3b6148[_0x3d9d9c(0x169)]);await this[_0x3d9d9c(0x113)](_0xfc261f),await this['finishRollback'](_0x3b6148[_0x3d9d9c(0x13a)],![],_0x3b6148['packageId']);}catch(_0x51e8ca){await this['finishRollbackWithError'](_0x51e8ca)[_0x3d9d9c(0x12a)](_0x509609=>this[_0x3d9d9c(0x16d)][_0x3d9d9c(0x173)](_0x509609));}}}exports[a337_0x30ba99(0x15b)]=RollbackService;