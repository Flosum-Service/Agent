const a405_0x454759=a405_0x4543;(function(_0x527e6d,_0x4d58e9){const _0x575d8e=a405_0x4543,_0x1a9e57=_0x527e6d();while(!![]){try{const _0x22ce03=parseInt(_0x575d8e(0x17d))/0x1*(-parseInt(_0x575d8e(0x1e0))/0x2)+-parseInt(_0x575d8e(0x17f))/0x3*(-parseInt(_0x575d8e(0x1e2))/0x4)+parseInt(_0x575d8e(0x1d6))/0x5+-parseInt(_0x575d8e(0x167))/0x6*(-parseInt(_0x575d8e(0x160))/0x7)+-parseInt(_0x575d8e(0x1ba))/0x8*(parseInt(_0x575d8e(0x1c1))/0x9)+parseInt(_0x575d8e(0x198))/0xa+-parseInt(_0x575d8e(0x1a9))/0xb*(parseInt(_0x575d8e(0x158))/0xc);if(_0x22ce03===_0x4d58e9)break;else _0x1a9e57['push'](_0x1a9e57['shift']());}catch(_0x5a975e){_0x1a9e57['push'](_0x1a9e57['shift']());}}}(a405_0x25f5,0x204f1));const a405_0x23f2be=(function(){let _0x4c1cfa=!![];return function(_0xe80c5,_0x4ae95f){const _0x2ff5c5=_0x4c1cfa?function(){const _0x283151=a405_0x4543;if(_0x4ae95f){const _0x154b7e=_0x4ae95f[_0x283151(0x1dc)](_0xe80c5,arguments);return _0x4ae95f=null,_0x154b7e;}}:function(){};return _0x4c1cfa=![],_0x2ff5c5;};}()),a405_0x169edf=a405_0x23f2be(this,function(){const _0x51d5b2=a405_0x4543;return a405_0x169edf[_0x51d5b2(0x1d5)]()[_0x51d5b2(0x17c)]('(((.+)+)+)+$')[_0x51d5b2(0x1d5)]()[_0x51d5b2(0x156)](a405_0x169edf)[_0x51d5b2(0x17c)](_0x51d5b2(0x1dd));});a405_0x169edf();'use strict';var __importDefault=this&&this[a405_0x454759(0x1be)]||function(_0x3cc9a8){return _0x3cc9a8&&_0x3cc9a8['__esModule']?_0x3cc9a8:{'default':_0x3cc9a8};};Object[a405_0x454759(0x18a)](exports,'__esModule',{'value':!![]}),exports[a405_0x454759(0x1de)]=void 0x0;const veeva_service_1=require(a405_0x454759(0x19e)),salesforce_service_1=require(a405_0x454759(0x184)),package_import_service_1=require(a405_0x454759(0x165)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a405_0x454759(0x169)),fetch_attachments_1=require(a405_0x454759(0x16a)),constants_1=require(a405_0x454759(0x1b5)),zip_creator_rollback_1=require(a405_0x454759(0x15d)),shortid_1=__importDefault(require('shortid')),promises_1=require(a405_0x454759(0x1db)),vpk_service_1=require(a405_0x454759(0x1a2)),status_enums_1=require(a405_0x454759(0x16b)),salesforce_dml_error_1=require(a405_0x454759(0x17a)),metadata_log_dto_1=require(a405_0x454759(0x151)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x330f99,connectionVeeva:_0x178541,logger:_0x305d21,tempFolder:_0x5ca377,instanceUrl:_0x8edbde,timeZone:_0x358034,metadataLogId:_0x3d221c,attachmentLogId:_0x376cc5,parentMetadataLogId:_0x2a0d2d,componentIds:_0x473372}){const _0x4f64e6=a405_0x454759;this['_connectionSalesforce']=_0x330f99,this['_connectionVeeva']=_0x178541,this[_0x4f64e6(0x18c)]=_0x305d21,this['_tempFolder']=_0x5ca377,this['_instanceUrl']=_0x8edbde,this[_0x4f64e6(0x183)]=_0x358034,this[_0x4f64e6(0x1d9)]=_0x3d221c,this['_attachmentLogId']=_0x376cc5,this[_0x4f64e6(0x19c)]=_0x2a0d2d,this[_0x4f64e6(0x1a7)]=_0x473372,this[_0x4f64e6(0x168)]=new core_1[(_0x4f64e6(0x189))](_0x4f64e6(0x16d)),this[_0x4f64e6(0x180)]=new veeva_service_1['VeevaService']({'connection':_0x178541,'logger':_0x305d21}),this[_0x4f64e6(0x1b4)]=new salesforce_service_1[(_0x4f64e6(0x1d2))]({'connection':_0x330f99}),this[_0x4f64e6(0x1cb)]=new package_import_service_1[(_0x4f64e6(0x1aa))]({'veevaService':this['_veevaService'],'connection':_0x178541,'logger':_0x305d21,'saveLog':this[_0x4f64e6(0x18f)]['bind'](this)}),this[_0x4f64e6(0x1bf)]=new vpk_service_1[(_0x4f64e6(0x1df))]({'connection':_0x178541});}async['saveLog'](_0x1789d2,_0x4dc54d){const _0x393212=a405_0x454759;this['_logger'][_0x393212(0x1ac)]('Save\x20log');const _0x4299ac={'Body':Buffer[_0x393212(0x1b3)](_0x1789d2)[_0x393212(0x1d5)](_0x393212(0x1d3)),'ContentType':'text/plain','ParentId':this[_0x393212(0x1d9)],'Name':_0x4dc54d};await this[_0x393212(0x1cf)]['post'](flosum_constants_1[_0x393212(0x17e)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x4299ac);}async[a405_0x454759(0x1b1)](){const _0x3bc741=a405_0x454759;this[_0x3bc741(0x18c)]['log'](_0x3bc741(0x193));const [_0x505f56]=await this[_0x3bc741(0x1b4)]['retrieveRecords'](_0x3bc741(0x155)+constants_1[_0x3bc741(0x15b)]+_0x3bc741(0x190)+constants_1['FLOSUM_NAMESPACE']+_0x3bc741(0x1bb)+constants_1['FLOSUM_NAMESPACE']+_0x3bc741(0x1a6)+constants_1[_0x3bc741(0x15b)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x3bc741(0x1d9)]+_0x3bc741(0x1d1));return new metadata_log_dto_1[(_0x3bc741(0x181))](_0x505f56);}async[a405_0x454759(0x16c)](){const _0x495b8f=a405_0x454759;this['_logger'][_0x495b8f(0x1ac)](_0x495b8f(0x1e1));const _0x81e854=await new id_deployment_result_retriever_1[(_0x495b8f(0x159))]({'salesforceService':this[_0x495b8f(0x1b4)],'value':this['_componentIds']})[_0x495b8f(0x15a)]();if(!_0x81e854[_0x495b8f(0x1b8)])throw new Error(_0x495b8f(0x1c5));return _0x81e854;}async['retrieveBackup'](){const _0x56c62f=a405_0x454759;this[_0x56c62f(0x18c)][_0x56c62f(0x1ac)]('Retrieve\x20Backup');const _0x424640=await this[_0x56c62f(0x1b4)]['retrieveRecords'](_0x56c62f(0x15f)+this[_0x56c62f(0x19c)]+_0x56c62f(0x1da)+flosum_constants_1[_0x56c62f(0x17e)][_0x56c62f(0x1ce)]+_0x56c62f(0x1d1)),_0x2627ad=await(0x0,fetch_attachments_1[_0x56c62f(0x174)])(this['_connectionSalesforce'],[_0x424640[0x0]['Id']]),_0x459af1=await(0x0,fetch_attachments_1[_0x56c62f(0x172)])(_0x2627ad,this[_0x56c62f(0x1cf)]);if(!_0x459af1[_0x56c62f(0x1b8)])throw new Error(_0x56c62f(0x154));return _0x459af1[0x0][_0x56c62f(0x18e)]['Body'];}async[a405_0x454759(0x173)](_0x5614aa){const _0x44a33b=a405_0x454759;this[_0x44a33b(0x18c)][_0x44a33b(0x1ac)](_0x44a33b(0x19d));const _0x5aa1a4=await this[_0x44a33b(0x1c9)](),_0x43577d=await new zip_creator_rollback_1[(_0x44a33b(0x171))]({'rollbackName':this['_metadataLog'][_0x44a33b(0x1d7)],'backup':_0x5aa1a4,'deploymentResults':_0x5614aa})[_0x44a33b(0x1ad)](),_0x147000=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0x44a33b(0x1ca);return await(0x0,promises_1[_0x44a33b(0x185)])(_0x147000,_0x43577d),_0x147000;}async['createVpk'](_0x4e5a84){const _0x53ae27=a405_0x454759;this[_0x53ae27(0x18c)][_0x53ae27(0x1ac)](_0x53ae27(0x186));const _0x393f81=await this['_vpkService'][_0x53ae27(0x197)](_0x4e5a84),_0x1d55a2=this['_tempFolder']+_0x53ae27(0x1cc)+_0x4e5a84['slice'](_0x4e5a84[_0x53ae27(0x1a0)]('/')+0x1);return await(0x0,promises_1[_0x53ae27(0x185)])(_0x1d55a2,_0x393f81),await this[_0x53ae27(0x1bf)][_0x53ae27(0x187)](_0x1d55a2),_0x1d55a2;}[a405_0x454759(0x153)](_0x4840d4){const _0x5e5b40=a405_0x454759;return this[_0x5e5b40(0x18c)]['log']('Form\x20Deployment\x20Results'),_0x4840d4['map'](_0x84276f=>{const _0x4ec4b2=_0x5e5b40;return this[_0x4ec4b2(0x18c)][_0x4ec4b2(0x1ac)](_0x84276f['type']+'.'+_0x84276f[_0x4ec4b2(0x1d7)]+'\x20:\x20'+_0x84276f[_0x4ec4b2(0x1a8)]),{[constants_1[_0x4ec4b2(0x15b)]+_0x4ec4b2(0x19b)]:_0x4ec4b2(0x199),[constants_1['FLOSUM_NAMESPACE']+_0x4ec4b2(0x1b6)]:_0x84276f['status']===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x4ec4b2(0x1ae):'Failure',[constants_1[_0x4ec4b2(0x15b)]+'Result__c']:_0x84276f[_0x4ec4b2(0x1a1)],[constants_1[_0x4ec4b2(0x15b)]+_0x4ec4b2(0x18b)]:_0x84276f[_0x4ec4b2(0x1d7)],[constants_1[_0x4ec4b2(0x15b)]+'Component_Type__c']:_0x84276f[_0x4ec4b2(0x194)],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Step_Name__c']:_0x84276f[_0x4ec4b2(0x162)],[constants_1['FLOSUM_NAMESPACE']+_0x4ec4b2(0x15e)]:this[_0x4ec4b2(0x1b2)][_0x4ec4b2(0x1c0)],[constants_1[_0x4ec4b2(0x15b)]+_0x4ec4b2(0x195)]:this['_metadataLogId']};});}async[a405_0x454759(0x152)](_0x356d3a){const _0x966141=a405_0x454759;this[_0x966141(0x18c)][_0x966141(0x1ac)]('Save\x20Deployment\x20Results');const _0x49a70e=await this['_salesforceService'][_0x966141(0x176)](constants_1[_0x966141(0x15b)]+_0x966141(0x161),_0x356d3a),_0x4e290e=_0x49a70e[_0x966141(0x16f)](_0x345fa7=>!_0x345fa7[_0x966141(0x1b9)])['map'](_0x2c8c57=>_0x2c8c57[_0x966141(0x1bd)])[_0x966141(0x1ab)]();if(_0x4e290e['length'])throw new salesforce_dml_error_1[(_0x966141(0x179))](_0x4e290e);}async[a405_0x454759(0x19a)](_0x1b2b8e){const _0x3ce341=a405_0x454759;if(!this['_metadataLog']){this[_0x3ce341(0x168)]['error'](_0x1b2b8e);return;}this['_logger']['logError'](_0x1b2b8e),await this[_0x3ce341(0x18c)][_0x3ce341(0x1b0)](),await this[_0x3ce341(0x182)](![],!![],'');}async['finishRollback'](_0xcfc752,_0x5a3695,_0x370770){const _0x325b8c=a405_0x454759,{id:_0x5cf6f6,organizationId:_0x561859,branchId:_0x10ad3b,organizationName:_0x11738b}=this[_0x325b8c(0x1b2)],_0xaf4836=_0x325b8c(0x1c6)+this[_0x325b8c(0x1c3)]+'/'+_0x5cf6f6+'\x20>\x20'+'Veeva\x20Rollback\x20(Deployment)'+'\x20</a>',_0x445799=_0x325b8c(0x1c6)+this['_instanceUrl']+'/'+_0x561859+'\x20>'+_0x11738b+_0x325b8c(0x1a3),_0x25d878=_0xaf4836+_0x325b8c(0x17b)+_0x445799+_0x325b8c(0x16e),_0x54f9b9={[constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x1bc)]:_0x25d878,[constants_1['FLOSUM_NAMESPACE']+_0x325b8c(0x1c4)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x325b8c(0x1a5)]:_0x10ad3b,[constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x1d0)]:_0x325b8c(0x1b7),[constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x1d8)]:_0x325b8c(0x157),[constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x1af)]:_0x561859},_0x4d3ed7={[constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x175)]:!_0xcfc752,[constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x164)]:_0xcfc752,[constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x1b6)]:_0x5a3695?status_enums_1[_0x325b8c(0x15c)][_0x325b8c(0x166)]:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1['FLOSUM_NAMESPACE']+_0x325b8c(0x1c2)]:!![],[constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x192)]:_0x370770};await this[_0x325b8c(0x1cf)][_0x325b8c(0x188)](flosum_constants_1[_0x325b8c(0x17e)][_0x325b8c(0x191)]+'/'+constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x1cd)+this[_0x325b8c(0x1d9)],_0x4d3ed7),await this[_0x325b8c(0x1cf)][_0x325b8c(0x1e3)](flosum_constants_1[_0x325b8c(0x17e)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x325b8c(0x15b)]+_0x325b8c(0x178),_0x54f9b9),this[_0x325b8c(0x18c)][_0x325b8c(0x1ac)](_0x325b8c(0x196)+(_0xcfc752?_0x325b8c(0x19f):_0x325b8c(0x170))+'.'),await this['_logger'][_0x325b8c(0x1b0)]();}async[a405_0x454759(0x1c7)](){const _0x151b77=a405_0x454759;try{this[_0x151b77(0x1b2)]=await this['retrieveMetadataLog']();const _0x271327=await this['retrieveDeploymentResults']();await this[_0x151b77(0x18c)]['updateLog']();const _0x4bc283=await this['createZip'](_0x271327),_0x3e15c6=await this[_0x151b77(0x1d4)](_0x4bc283);await this[_0x151b77(0x18c)][_0x151b77(0x1b0)]();const _0x367028=await this[_0x151b77(0x1cb)]['import'](_0x3e15c6);await this['_logger'][_0x151b77(0x1b0)]();const _0x2b9045=this[_0x151b77(0x153)](_0x367028[_0x151b77(0x18d)]);await this[_0x151b77(0x152)](_0x2b9045),await this[_0x151b77(0x182)](_0x367028[_0x151b77(0x1c8)],![],_0x367028[_0x151b77(0x163)]);}catch(_0x4d6ad4){await this[_0x151b77(0x19a)](_0x4d6ad4)[_0x151b77(0x1a4)](_0x44a6d3=>this['_systemLogger'][_0x151b77(0x177)](_0x44a6d3));}}}exports[a405_0x454759(0x1de)]=RollbackService;function a405_0x4543(_0x528aa0,_0x218b03){const _0x241eaf=a405_0x25f5();return a405_0x4543=function(_0x169edf,_0x23f2be){_0x169edf=_0x169edf-0x151;let _0x25f54e=_0x241eaf[_0x169edf];return _0x25f54e;},a405_0x4543(_0x528aa0,_0x218b03);}function a405_0x25f5(){const _0x43a1c5=['_metadataLog','from','_salesforceService','../../../constants','Status__c','Branch','length','success','8aeqXdL','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Action__c','errors','__importDefault','_vpkService','organizationId','2080944gbVFts','Job_Completed__c','_instanceUrl','Date__c','Cannot\x20find\x20Deployment\x20Results','<a\x20href=','execute','isDeployed','retrieveBackup','.zip','_packageImportService','/vpk__','Metadata_Log__c/','BACKUP_ZIP_NAME','_connectionSalesforce','Activity_Item__c','\x27\x0a\x20\x20\x20\x20','SalesforceService','base64','createVpk','toString','1094265XEcvQg','name','Activity_Type__c','_metadataLogId','\x27\x20AND\x20Name\x20=\x20\x27','fs/promises','apply','(((.+)+)+)+$','RollbackService','VpkService','2IcPLcq','Retrieve\x20Deployment\x20Results','3028vDuQVV','post','../dtos/metadata-log.dto','saveDeploymentResults','formFlosumDeploymentResults','Cannot\x20find\x20Backup\x20Zip','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','constructor','Deployment','12zjpnFk','IdDeploymentResultRetriever','retrieve','FLOSUM_NAMESPACE','MetadataLogStatus','../classes/rollback/zip-creator.rollback','Org__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','28PBPhkP','Deployment_Result__c','stepName','packageId','Succeed__c','./package-import.service','EXCEPTION','110928lFSZgd','_systemLogger','../constants/flosum.constants','../../shared/utils/fetch-attachments','../enums/status.enums','retrieveDeploymentResults','veeva-rollback','\x20has\x20been\x20created.','filter','with\x20error','ZipCreatorRollback','retrieveAttachments','createZip','fetchAttachmentsDetailsById','Is_Error__c','insertMultipleRecords','error','Log__c','SalesforceDmlError','../classes/errors/salesforce-dml-error','\x20of\x20branch\x20to\x20Organization\x20','search','58039uzfuxw','FlosumConstants','1023sBOxqp','_veevaService','MetadataLogDto','finishRollback','_timeZone','./salesforce.service','writeFile','Create\x20Vpk\x20package','validate','patch','Logger','defineProperty','Component_Name__c','_logger','packageComponentList','values','saveLog','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','ENDPOINT_UPSERT_RECORD','External_Deployment_Id__c','Retrieve\x20Metadata\x20Log\x20info','type','Metadata_Log__c','Rollback\x20completed\x20','generate','404730sBboxf','Deployment\x20Result','finishRollbackWithError','Type__c','_parentMetadataLogId','Create\x20zip\x20from\x20backup','./veeva.service','successfully','lastIndexOf','deploymentAction','./vpk.service','</a>','catch','Branch__c','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','_componentIds','status','1868053emhBwQ','PackageImportService','flat','log','create','Success','TargetId__c','updateLog','retrieveMetadataLog'];a405_0x25f5=function(){return _0x43a1c5;};return a405_0x25f5();}