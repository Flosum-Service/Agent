const a405_0x28102a=a405_0x5dc9;(function(_0x443eef,_0x125538){const _0x40ca30=a405_0x5dc9,_0x48ed43=_0x443eef();while(!![]){try{const _0x578adc=parseInt(_0x40ca30(0xdd))/0x1*(-parseInt(_0x40ca30(0xc5))/0x2)+-parseInt(_0x40ca30(0xb0))/0x3+parseInt(_0x40ca30(0xee))/0x4+parseInt(_0x40ca30(0x104))/0x5+-parseInt(_0x40ca30(0x107))/0x6+parseInt(_0x40ca30(0xc3))/0x7+-parseInt(_0x40ca30(0xb5))/0x8;if(_0x578adc===_0x125538)break;else _0x48ed43['push'](_0x48ed43['shift']());}catch(_0x43416b){_0x48ed43['push'](_0x48ed43['shift']());}}}(a405_0x539a,0x2ff97));function a405_0x539a(){const _0x583eb0=['values','_vpkService','./veeva.service','Log__c','successfully','lastIndexOf','saveDeploymentResults','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x27\x0a\x20\x20\x20\x20','FLOSUM_NAMESPACE','PackageComponentStatus','isDeployed','Activity_Item__c','search','Date__c','_logger','success','219318fRYyNA','__esModule','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','slice','__importDefault','2339152rfRiAd','generate','Retrieve\x20Backup','_salesforceService','defineProperty','retrieve','constructor','(((.+)+)+)+$','finishRollbackWithError','_metadataLog','_attachmentLogId','Branch','apply','External_Deployment_Id__c','1238454UnSqnG','retrieveMetadataLog','2pPkmZV','bind','<a\x20href=','../../../core','Component_Type__c','_connectionSalesforce','name','saveLog','toString','MetadataLogStatus','BACKUP_ZIP_NAME','../classes/errors/salesforce-dml-error','catch','Body','\x20>\x20','deploymentAction','createZip','Retrieve\x20Metadata\x20Log\x20info','\x27\x20AND\x20Name\x20=\x20\x27','Component_Name__c','_parentMetadataLogId','from','Metadata_Log__c/','./package-import.service','183725PoAbMA','veeva-rollback','_connectionVeeva','TargetId__c','type','SalesforceService','log','text/plain','Logger','Branch__c','_metadataLogId','FlosumConstants','Rollback\x20completed\x20','Deployment','status','IdDeploymentResultRetriever','/Attachment','975548ovkmoR','Save\x20Deployment\x20Results','/vpk__','logError','fetchAttachmentsDetailsById','_componentIds','default','Is_Error__c','</a>','DEPLOYED','Save\x20log','Success','updateLog','retrieveRecords','Cannot\x20find\x20Backup\x20Zip','../classes/retrievers/deployment-results/id.deployment-result.retriever','map','Cannot\x20find\x20Deployment\x20Results','insertMultipleRecords','RollbackService','length','Succeed__c','1788040AFzTQN','\x20:\x20','_veevaService','196134krMYrd','errors','post','VeevaService','../../shared/utils/fetch-attachments','Metadata_Log__c','Status__c','import','packageId','Activity_Type__c','COMPLETED','Veeva_Step_Name__c','./salesforce.service','_packageImportService','Form\x20Deployment\x20Results','_tempFolder','error','_timeZone','Type__c','retrieveDeploymentResults','retrieveBackup','Veeva\x20Rollback\x20(Deployment)','retrieveAttachments','formFlosumDeploymentResults','.zip','filter','Create\x20Vpk\x20package','writeFile','VpkService','Retrieve\x20Deployment\x20Results','shortid','Deployment\x20Result','finishRollback','Create\x20zip\x20from\x20backup','createVpk','_systemLogger','\x20</a>','_instanceUrl','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x20of\x20branch\x20to\x20Organization\x20','validate','../dtos/metadata-log.dto','ENDPOINT_UPSERT_RECORD'];a405_0x539a=function(){return _0x583eb0;};return a405_0x539a();}function a405_0x5dc9(_0x30ccb6,_0x4292eb){const _0x32797c=a405_0x539a();return a405_0x5dc9=function(_0x1ef3b6,_0x461bba){_0x1ef3b6=_0x1ef3b6-0xa7;let _0x539aed=_0x32797c[_0x1ef3b6];return _0x539aed;},a405_0x5dc9(_0x30ccb6,_0x4292eb);}const a405_0x461bba=(function(){let _0x2b0f17=!![];return function(_0x21d202,_0x54a19d){const _0x272c67=_0x2b0f17?function(){const _0x4c2577=a405_0x5dc9;if(_0x54a19d){const _0xc1a0d7=_0x54a19d[_0x4c2577(0xc1)](_0x21d202,arguments);return _0x54a19d=null,_0xc1a0d7;}}:function(){};return _0x2b0f17=![],_0x272c67;};}()),a405_0x1ef3b6=a405_0x461bba(this,function(){const _0x4f3a5e=a405_0x5dc9;return a405_0x1ef3b6['toString']()[_0x4f3a5e(0xac)](_0x4f3a5e(0xbc))[_0x4f3a5e(0xcd)]()[_0x4f3a5e(0xbb)](a405_0x1ef3b6)['search']('(((.+)+)+)+$');});a405_0x1ef3b6();'use strict';var __importDefault=this&&this[a405_0x28102a(0xb4)]||function(_0x4ca827){const _0x217328=a405_0x28102a;return _0x4ca827&&_0x4ca827[_0x217328(0xb1)]?_0x4ca827:{'default':_0x4ca827};};Object[a405_0x28102a(0xb9)](exports,a405_0x28102a(0xb1),{'value':!![]}),exports[a405_0x28102a(0x101)]=void 0x0;const veeva_service_1=require(a405_0x28102a(0x134)),salesforce_service_1=require(a405_0x28102a(0x113)),package_import_service_1=require(a405_0x28102a(0xdc)),id_deployment_result_retriever_1=require(a405_0x28102a(0xfd)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a405_0x28102a(0x10b)),constants_1=require('../../../constants'),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a405_0x28102a(0x125))),promises_1=require('fs/promises'),vpk_service_1=require('./vpk.service'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a405_0x28102a(0xd0)),metadata_log_dto_1=require(a405_0x28102a(0x130)),core_1=require(a405_0x28102a(0xc8));class RollbackService{constructor({connectionSalesforce:_0x4359d,connectionVeeva:_0x4f0d34,logger:_0x2d93ab,tempFolder:_0x1d6205,instanceUrl:_0xc194d4,timeZone:_0x117012,metadataLogId:_0x1deb65,attachmentLogId:_0x186df9,parentMetadataLogId:_0x42c083,componentIds:_0xb7f6f7}){const _0x1c2796=a405_0x28102a;this[_0x1c2796(0xca)]=_0x4359d,this[_0x1c2796(0xdf)]=_0x4f0d34,this[_0x1c2796(0xae)]=_0x2d93ab,this[_0x1c2796(0x116)]=_0x1d6205,this[_0x1c2796(0x12c)]=_0xc194d4,this[_0x1c2796(0x118)]=_0x117012,this[_0x1c2796(0xe7)]=_0x1deb65,this[_0x1c2796(0xbf)]=_0x186df9,this[_0x1c2796(0xd9)]=_0x42c083,this[_0x1c2796(0xf3)]=_0xb7f6f7,this[_0x1c2796(0x12a)]=new core_1[(_0x1c2796(0xe5))](_0x1c2796(0xde)),this['_veevaService']=new veeva_service_1[(_0x1c2796(0x10a))]({'connection':_0x4f0d34,'logger':_0x2d93ab}),this[_0x1c2796(0xb8)]=new salesforce_service_1[(_0x1c2796(0xe2))]({'connection':_0x4359d}),this[_0x1c2796(0x114)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x1c2796(0x106)],'connection':_0x4f0d34,'logger':_0x2d93ab,'saveLog':this[_0x1c2796(0xcc)][_0x1c2796(0xc6)](this)}),this['_vpkService']=new vpk_service_1[(_0x1c2796(0x123))]({'connection':_0x4f0d34});}async['saveLog'](_0x5d55d6,_0x5607a2){const _0x18c31a=a405_0x28102a;this[_0x18c31a(0xae)]['log'](_0x18c31a(0xf8));const _0x2cb4c0={'Body':Buffer[_0x18c31a(0xda)](_0x5d55d6)[_0x18c31a(0xcd)]('base64'),'ContentType':_0x18c31a(0xe4),'ParentId':this[_0x18c31a(0xe7)],'Name':_0x5607a2};await this[_0x18c31a(0xca)][_0x18c31a(0x109)](flosum_constants_1[_0x18c31a(0xe8)][_0x18c31a(0x131)]+_0x18c31a(0xed),_0x2cb4c0);}async[a405_0x28102a(0xc4)](){const _0x2da29d=a405_0x28102a;this['_logger'][_0x2da29d(0xe3)](_0x2da29d(0xd6));const [_0x519a7c]=await this[_0x2da29d(0xb8)]['retrieveRecords'](_0x2da29d(0x12d)+constants_1[_0x2da29d(0xa8)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x2da29d(0xa8)]+_0x2da29d(0x139)+constants_1[_0x2da29d(0xa8)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x2da29d(0xa8)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this['_metadataLogId']+_0x2da29d(0xa7));return new metadata_log_dto_1['MetadataLogDto'](_0x519a7c);}async[a405_0x28102a(0x11a)](){const _0x8d6af=a405_0x28102a;this[_0x8d6af(0xae)][_0x8d6af(0xe3)](_0x8d6af(0x124));const _0x5cf6f7=await new id_deployment_result_retriever_1[(_0x8d6af(0xec))]({'salesforceService':this[_0x8d6af(0xb8)],'value':this[_0x8d6af(0xf3)]})[_0x8d6af(0xba)]();if(!_0x5cf6f7['length'])throw new Error(_0x8d6af(0xff));return _0x5cf6f7;}async['retrieveBackup'](){const _0x1588d1=a405_0x28102a;this['_logger'][_0x1588d1(0xe3)](_0x1588d1(0xb7));const _0x11feab=await this['_salesforceService'][_0x1588d1(0xfb)](_0x1588d1(0xb2)+this[_0x1588d1(0xd9)]+_0x1588d1(0xd7)+flosum_constants_1[_0x1588d1(0xe8)][_0x1588d1(0xcf)]+_0x1588d1(0xa7)),_0x2c45b5=await(0x0,fetch_attachments_1[_0x1588d1(0xf2)])(this['_connectionSalesforce'],[_0x11feab[0x0]['Id']]),_0x56b262=await(0x0,fetch_attachments_1[_0x1588d1(0x11d)])(_0x2c45b5,this[_0x1588d1(0xca)]);if(!_0x56b262[_0x1588d1(0x102)])throw new Error(_0x1588d1(0xfc));return _0x56b262[0x0][_0x1588d1(0x132)][_0x1588d1(0xd2)];}async[a405_0x28102a(0xd5)](_0xf1a84c){const _0x33a105=a405_0x28102a;this[_0x33a105(0xae)][_0x33a105(0xe3)](_0x33a105(0x128));const _0x58ec1f=await this[_0x33a105(0x11b)](),_0x45fd8d=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x33a105(0xbe)][_0x33a105(0xcb)],'backup':_0x58ec1f,'deploymentResults':_0xf1a84c})['create'](),_0x536716=this[_0x33a105(0x116)]+'/'+(0x0,shortid_1[_0x33a105(0xf4)])()+_0x33a105(0x11f);return await(0x0,promises_1[_0x33a105(0x122)])(_0x536716,_0x45fd8d),_0x536716;}async['createVpk'](_0x41476b){const _0x3edacc=a405_0x28102a;this[_0x3edacc(0xae)]['log'](_0x3edacc(0x121));const _0x18cbe7=await this[_0x3edacc(0x133)][_0x3edacc(0xb6)](_0x41476b),_0x1e5794=this[_0x3edacc(0x116)]+_0x3edacc(0xf0)+_0x41476b[_0x3edacc(0xb3)](_0x41476b[_0x3edacc(0x137)]('/')+0x1);return await(0x0,promises_1[_0x3edacc(0x122)])(_0x1e5794,_0x18cbe7),await this[_0x3edacc(0x133)][_0x3edacc(0x12f)](_0x1e5794),_0x1e5794;}[a405_0x28102a(0x11e)](_0x5477c5){const _0x52b7d6=a405_0x28102a;return this['_logger'][_0x52b7d6(0xe3)](_0x52b7d6(0x115)),_0x5477c5[_0x52b7d6(0xfe)](_0x7de2a5=>{const _0x449a6f=_0x52b7d6;return this['_logger']['log'](_0x7de2a5[_0x449a6f(0xe1)]+'.'+_0x7de2a5[_0x449a6f(0xcb)]+_0x449a6f(0x105)+_0x7de2a5[_0x449a6f(0xeb)]),{[constants_1[_0x449a6f(0xa8)]+_0x449a6f(0x119)]:_0x449a6f(0x126),[constants_1[_0x449a6f(0xa8)]+_0x449a6f(0x10d)]:_0x7de2a5[_0x449a6f(0xeb)]===status_enums_1[_0x449a6f(0xa9)][_0x449a6f(0xf7)]?_0x449a6f(0xf9):'Failure',[constants_1[_0x449a6f(0xa8)]+'Result__c']:_0x7de2a5[_0x449a6f(0xd4)],[constants_1['FLOSUM_NAMESPACE']+_0x449a6f(0xd8)]:_0x7de2a5[_0x449a6f(0xcb)],[constants_1[_0x449a6f(0xa8)]+_0x449a6f(0xc9)]:_0x7de2a5['type'],[constants_1[_0x449a6f(0xa8)]+_0x449a6f(0x112)]:_0x7de2a5['stepName'],[constants_1[_0x449a6f(0xa8)]+'Org__c']:this[_0x449a6f(0xbe)]['organizationId'],[constants_1[_0x449a6f(0xa8)]+_0x449a6f(0x10c)]:this[_0x449a6f(0xe7)]};});}async[a405_0x28102a(0x138)](_0x2d3069){const _0x1bb826=a405_0x28102a;this[_0x1bb826(0xae)][_0x1bb826(0xe3)](_0x1bb826(0xef));const _0x2df831=await this[_0x1bb826(0xb8)][_0x1bb826(0x100)](constants_1[_0x1bb826(0xa8)]+'Deployment_Result__c',_0x2d3069),_0x4eee63=_0x2df831[_0x1bb826(0x120)](_0x2292e3=>!_0x2292e3[_0x1bb826(0xaf)])['map'](_0x598286=>_0x598286[_0x1bb826(0x108)])['flat']();if(_0x4eee63[_0x1bb826(0x102)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x4eee63);}async[a405_0x28102a(0xbd)](_0x3d5b55){const _0x5dabc0=a405_0x28102a;if(!this['_metadataLog']){this[_0x5dabc0(0x12a)][_0x5dabc0(0x117)](_0x3d5b55);return;}this['_logger'][_0x5dabc0(0xf1)](_0x3d5b55),await this[_0x5dabc0(0xae)][_0x5dabc0(0xfa)](),await this[_0x5dabc0(0x127)](![],!![],'');}async[a405_0x28102a(0x127)](_0x373bef,_0x25963a,_0xc5c070){const _0x43ce81=a405_0x28102a,{id:_0x2e81f9,organizationId:_0x5ad277,branchId:_0x370b17,organizationName:_0x2f7499}=this[_0x43ce81(0xbe)],_0x5d686e=_0x43ce81(0xc7)+this[_0x43ce81(0x12c)]+'/'+_0x2e81f9+_0x43ce81(0xd3)+_0x43ce81(0x11c)+_0x43ce81(0x12b),_0x26a348=_0x43ce81(0xc7)+this[_0x43ce81(0x12c)]+'/'+_0x5ad277+'\x20>'+_0x2f7499+_0x43ce81(0xf6),_0x5c98f3=_0x5d686e+_0x43ce81(0x12e)+_0x26a348+'\x20has\x20been\x20created.',_0x514da5={[constants_1[_0x43ce81(0xa8)]+'Action__c']:_0x5c98f3,[constants_1[_0x43ce81(0xa8)]+_0x43ce81(0xad)]:new Date(),[constants_1[_0x43ce81(0xa8)]+_0x43ce81(0xe6)]:_0x370b17,[constants_1[_0x43ce81(0xa8)]+_0x43ce81(0xab)]:_0x43ce81(0xc0),[constants_1[_0x43ce81(0xa8)]+_0x43ce81(0x110)]:_0x43ce81(0xea),[constants_1[_0x43ce81(0xa8)]+_0x43ce81(0xe0)]:_0x5ad277},_0xe15d1e={[constants_1[_0x43ce81(0xa8)]+_0x43ce81(0xf5)]:!_0x373bef,[constants_1[_0x43ce81(0xa8)]+_0x43ce81(0x103)]:_0x373bef,[constants_1[_0x43ce81(0xa8)]+_0x43ce81(0x10d)]:_0x25963a?status_enums_1[_0x43ce81(0xce)]['EXCEPTION']:status_enums_1[_0x43ce81(0xce)][_0x43ce81(0x111)],[constants_1[_0x43ce81(0xa8)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x43ce81(0xc2)]:_0xc5c070};await this[_0x43ce81(0xca)]['patch'](flosum_constants_1['FlosumConstants'][_0x43ce81(0x131)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x43ce81(0xdb)+this[_0x43ce81(0xe7)],_0xe15d1e),await this[_0x43ce81(0xca)][_0x43ce81(0x109)](flosum_constants_1[_0x43ce81(0xe8)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x43ce81(0xa8)]+_0x43ce81(0x135),_0x514da5),this['_logger'][_0x43ce81(0xe3)](_0x43ce81(0xe9)+(_0x373bef?_0x43ce81(0x136):'with\x20error')+'.'),await this[_0x43ce81(0xae)][_0x43ce81(0xfa)]();}async['execute'](){const _0x45ddaf=a405_0x28102a;try{this['_metadataLog']=await this[_0x45ddaf(0xc4)]();const _0x3f32b9=await this[_0x45ddaf(0x11a)]();await this['_logger'][_0x45ddaf(0xfa)]();const _0x341a27=await this['createZip'](_0x3f32b9),_0x5c9aa7=await this[_0x45ddaf(0x129)](_0x341a27);await this[_0x45ddaf(0xae)][_0x45ddaf(0xfa)]();const _0x2fc296=await this['_packageImportService'][_0x45ddaf(0x10e)](_0x5c9aa7);await this[_0x45ddaf(0xae)]['updateLog']();const _0x1ef5f9=this[_0x45ddaf(0x11e)](_0x2fc296['packageComponentList']);await this[_0x45ddaf(0x138)](_0x1ef5f9),await this['finishRollback'](_0x2fc296[_0x45ddaf(0xaa)],![],_0x2fc296[_0x45ddaf(0x10f)]);}catch(_0x143150){await this[_0x45ddaf(0xbd)](_0x143150)[_0x45ddaf(0xd1)](_0x23d6fa=>this[_0x45ddaf(0x12a)]['error'](_0x23d6fa));}}}exports[a405_0x28102a(0x101)]=RollbackService;