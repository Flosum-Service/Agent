const a361_0x36b195=a361_0x4080;(function(_0x2cf941,_0x38eb87){const _0x5d0c1c=a361_0x4080,_0xe457e6=_0x2cf941();while(!![]){try{const _0x43772e=parseInt(_0x5d0c1c(0xf0))/0x1*(-parseInt(_0x5d0c1c(0xe3))/0x2)+-parseInt(_0x5d0c1c(0x125))/0x3*(-parseInt(_0x5d0c1c(0x123))/0x4)+-parseInt(_0x5d0c1c(0xfd))/0x5+-parseInt(_0x5d0c1c(0x13d))/0x6+-parseInt(_0x5d0c1c(0xf5))/0x7+-parseInt(_0x5d0c1c(0x133))/0x8+parseInt(_0x5d0c1c(0x11a))/0x9;if(_0x43772e===_0x38eb87)break;else _0xe457e6['push'](_0xe457e6['shift']());}catch(_0x388e3e){_0xe457e6['push'](_0xe457e6['shift']());}}}(a361_0x46b0,0xd3df5));function a361_0x46b0(){const _0x2cc144=['retrieveMetadataLog','8890904stGQaA','shortid','Metadata_Log__c','type','Create\x20Vpk\x20package','execute','patch','VeevaService','PackageImportService','_tempFolder','731244aBWSZT','map','Body','\x27\x20AND\x20Name\x20=\x20\x27','_logger','retrieve','success','External_Deployment_Id__c','saveLog','Deployment\x20Result','PackageComponentStatus','Cannot\x20find\x20Backup\x20Zip','__importDefault','createZip','import','Branch__c','_instanceUrl','_vpkService','successfully','VpkService','Activity_Type__c','fetchAttachmentsDetailsById','.zip','_parentMetadataLogId','error','\x20:\x20','<a\x20href=','catch','filter','_systemLogger','_attachmentLogId','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','EXCEPTION','./package-import.service','FlosumConstants','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Rollback\x20completed\x20','SalesforceDmlError','Veeva\x20Rollback\x20(Deployment)','\x27\x0a\x20\x20\x20\x20','BACKUP_ZIP_NAME','_metadataLog','Save\x20log','Deployment_Result__c','Component_Name__c','Succeed__c','/vpk__','retrieveBackup','createVpk','lastIndexOf','__esModule','packageComponentList','create','\x20has\x20been\x20created.','./vpk.service','../../../constants','retrieveDeploymentResults','../constants/flosum.constants','33644MdizEx','\x20>\x20','slice','ENDPOINT_UPSERT_RECORD','</a>','COMPLETED','_componentIds','logError','organizationId','../classes/retrievers/deployment-results/id.deployment-result.retriever','_timeZone','from','post','97yrzrtj','Failure','Log__c','with\x20error','_packageImportService','8361087AEXwjg','IdDeploymentResultRetriever','writeFile','SalesforceService','constructor','MetadataLogDto','DEPLOYED','saveDeploymentResults','5445365RrZWdU','Component_Type__c','base64','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','fs/promises','FLOSUM_NAMESPACE','generate','search','Retrieve\x20Backup','Form\x20Deployment\x20Results','_salesforceService','_connectionSalesforce','finishRollback','updateLog','Branch','\x20</a>','(((.+)+)+)+$','toString','Date__c','Deployment','name','Is_Error__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','retrieveRecords','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_veevaService','Logger','Create\x20zip\x20from\x20backup','../../shared/utils/fetch-attachments','43274520JvlbxR','MetadataLogStatus','values','length','status','Action__c','stepName','log','Result__c','59656NswtyI','validate','243eAqAsg','_metadataLogId','./veeva.service','../classes/errors/salesforce-dml-error','Type__c','Org__c','Metadata_Log__c/','insertMultipleRecords','_connectionVeeva','Retrieve\x20Metadata\x20Log\x20info','RollbackService','formFlosumDeploymentResults','../enums/status.enums'];a361_0x46b0=function(){return _0x2cc144;};return a361_0x46b0();}const a361_0x5d7da0=(function(){let _0x2c62d4=!![];return function(_0x10197f,_0x8be9c1){const _0x3a518d=_0x2c62d4?function(){if(_0x8be9c1){const _0xa0b693=_0x8be9c1['apply'](_0x10197f,arguments);return _0x8be9c1=null,_0xa0b693;}}:function(){};return _0x2c62d4=![],_0x3a518d;};}()),a361_0x232bd7=a361_0x5d7da0(this,function(){const _0x267be1=a361_0x4080;return a361_0x232bd7[_0x267be1(0x10e)]()[_0x267be1(0x104)](_0x267be1(0x10d))['toString']()[_0x267be1(0xf9)](a361_0x232bd7)[_0x267be1(0x104)](_0x267be1(0x10d));});a361_0x232bd7();'use strict';function a361_0x4080(_0x1cbed3,_0x48aa5d){const _0x2da016=a361_0x46b0();return a361_0x4080=function(_0x232bd7,_0x5d7da0){_0x232bd7=_0x232bd7-0xcb;let _0x46b034=_0x2da016[_0x232bd7];return _0x46b034;},a361_0x4080(_0x1cbed3,_0x48aa5d);}var __importDefault=this&&this[a361_0x36b195(0x149)]||function(_0x6012de){const _0x30cccc=a361_0x36b195;return _0x6012de&&_0x6012de[_0x30cccc(0xdb)]?_0x6012de:{'default':_0x6012de};};Object['defineProperty'](exports,a361_0x36b195(0xdb),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a361_0x36b195(0x127)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a361_0x36b195(0x15e)),id_deployment_result_retriever_1=require(a361_0x36b195(0xec)),flosum_constants_1=require(a361_0x36b195(0xe2)),fetch_attachments_1=require(a361_0x36b195(0x119)),constants_1=require(a361_0x36b195(0xe0)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a361_0x36b195(0x134))),promises_1=require(a361_0x36b195(0x101)),vpk_service_1=require(a361_0x36b195(0xdf)),status_enums_1=require(a361_0x36b195(0x131)),salesforce_dml_error_1=require(a361_0x36b195(0x128)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x53fd7a,connectionVeeva:_0x14cc67,logger:_0x53eb8c,tempFolder:_0x5e111b,instanceUrl:_0x4dcfab,timeZone:_0x32c09a,metadataLogId:_0x2fb82e,attachmentLogId:_0x24dedd,parentMetadataLogId:_0x20516b,componentIds:_0x1957ef}){const _0x293815=a361_0x36b195;this['_connectionSalesforce']=_0x53fd7a,this[_0x293815(0x12d)]=_0x14cc67,this[_0x293815(0x141)]=_0x53eb8c,this['_tempFolder']=_0x5e111b,this[_0x293815(0x14d)]=_0x4dcfab,this[_0x293815(0xed)]=_0x32c09a,this['_metadataLogId']=_0x2fb82e,this[_0x293815(0x15b)]=_0x24dedd,this[_0x293815(0x154)]=_0x20516b,this[_0x293815(0xe9)]=_0x1957ef,this[_0x293815(0x15a)]=new core_1[(_0x293815(0x117))]('veeva-rollback'),this[_0x293815(0x116)]=new veeva_service_1[(_0x293815(0x13a))]({'connection':_0x14cc67,'logger':_0x53eb8c}),this[_0x293815(0x107)]=new salesforce_service_1[(_0x293815(0xf8))]({'connection':_0x53fd7a}),this[_0x293815(0xf4)]=new package_import_service_1[(_0x293815(0x13b))]({'veevaService':this[_0x293815(0x116)],'connection':_0x14cc67,'logger':_0x53eb8c,'saveLog':this[_0x293815(0x145)]['bind'](this)}),this['_vpkService']=new vpk_service_1[(_0x293815(0x150))]({'connection':_0x14cc67});}async[a361_0x36b195(0x145)](_0x5c07c1,_0x457a24){const _0x311fe3=a361_0x36b195;this[_0x311fe3(0x141)][_0x311fe3(0x121)](_0x311fe3(0xd3));const _0x34e31d={'Body':Buffer[_0x311fe3(0xee)](_0x5c07c1)[_0x311fe3(0x10e)](_0x311fe3(0xff)),'ContentType':'text/plain','ParentId':this[_0x311fe3(0x126)],'Name':_0x457a24};await this['_connectionSalesforce'][_0x311fe3(0xef)](flosum_constants_1[_0x311fe3(0xcb)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x34e31d);}async[a361_0x36b195(0x132)](){const _0x2c792f=a361_0x36b195;this[_0x2c792f(0x141)][_0x2c792f(0x121)](_0x2c792f(0x12e));const [_0x16971b]=await this[_0x2c792f(0x107)]['retrieveRecords'](_0x2c792f(0x100)+constants_1[_0x2c792f(0x102)]+_0x2c792f(0x115)+constants_1[_0x2c792f(0x102)]+_0x2c792f(0x15c)+constants_1[_0x2c792f(0x102)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1['FLOSUM_NAMESPACE']+_0x2c792f(0xcc)+this['_metadataLogId']+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x2c792f(0xfa))](_0x16971b);}async[a361_0x36b195(0xe1)](){const _0x48610b=a361_0x36b195;this[_0x48610b(0x141)][_0x48610b(0x121)]('Retrieve\x20Deployment\x20Results');const _0x227af9=await new id_deployment_result_retriever_1[(_0x48610b(0xf6))]({'salesforceService':this['_salesforceService'],'value':this[_0x48610b(0xe9)]})[_0x48610b(0x142)]();if(!_0x227af9[_0x48610b(0x11d)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x227af9;}async['retrieveBackup'](){const _0x1e78b=a361_0x36b195;this[_0x1e78b(0x141)][_0x1e78b(0x121)](_0x1e78b(0x105));const _0x1b1a94=await this[_0x1e78b(0x107)][_0x1e78b(0x114)](_0x1e78b(0x113)+this[_0x1e78b(0x154)]+_0x1e78b(0x140)+flosum_constants_1[_0x1e78b(0xcb)][_0x1e78b(0xd1)]+_0x1e78b(0xd0)),_0x13f91b=await(0x0,fetch_attachments_1[_0x1e78b(0x152)])(this[_0x1e78b(0x108)],[_0x1b1a94[0x0]['Id']]),_0x309c33=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x13f91b,this[_0x1e78b(0x108)]);if(!_0x309c33[_0x1e78b(0x11d)])throw new Error(_0x1e78b(0x148));return _0x309c33[0x0][_0x1e78b(0x11c)][_0x1e78b(0x13f)];}async[a361_0x36b195(0x14a)](_0x5829a7){const _0x408fb4=a361_0x36b195;this[_0x408fb4(0x141)][_0x408fb4(0x121)](_0x408fb4(0x118));const _0x18ad18=await this[_0x408fb4(0xd8)](),_0x31fbbb=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x408fb4(0xd2)][_0x408fb4(0x111)],'backup':_0x18ad18,'deploymentResults':_0x5829a7})[_0x408fb4(0xdd)](),_0x3df2aa=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0x408fb4(0x153);return await(0x0,promises_1[_0x408fb4(0xf7)])(_0x3df2aa,_0x31fbbb),_0x3df2aa;}async[a361_0x36b195(0xd9)](_0x3e6a0d){const _0x1d9e1f=a361_0x36b195;this['_logger'][_0x1d9e1f(0x121)](_0x1d9e1f(0x137));const _0x4816b4=await this[_0x1d9e1f(0x14e)][_0x1d9e1f(0x103)](_0x3e6a0d),_0x54fcfa=this[_0x1d9e1f(0x13c)]+_0x1d9e1f(0xd7)+_0x3e6a0d[_0x1d9e1f(0xe5)](_0x3e6a0d[_0x1d9e1f(0xda)]('/')+0x1);return await(0x0,promises_1[_0x1d9e1f(0xf7)])(_0x54fcfa,_0x4816b4),await this['_vpkService'][_0x1d9e1f(0x124)](_0x54fcfa),_0x54fcfa;}['formFlosumDeploymentResults'](_0xec141){const _0x1b35f2=a361_0x36b195;return this[_0x1b35f2(0x141)][_0x1b35f2(0x121)](_0x1b35f2(0x106)),_0xec141[_0x1b35f2(0x13e)](_0x5ad658=>{const _0xc0af05=_0x1b35f2;return this[_0xc0af05(0x141)][_0xc0af05(0x121)](_0x5ad658[_0xc0af05(0x136)]+'.'+_0x5ad658[_0xc0af05(0x111)]+_0xc0af05(0x156)+_0x5ad658[_0xc0af05(0x11e)]),{[constants_1[_0xc0af05(0x102)]+_0xc0af05(0x129)]:_0xc0af05(0x146),[constants_1[_0xc0af05(0x102)]+'Status__c']:_0x5ad658[_0xc0af05(0x11e)]===status_enums_1[_0xc0af05(0x147)][_0xc0af05(0xfb)]?'Success':_0xc0af05(0xf1),[constants_1[_0xc0af05(0x102)]+_0xc0af05(0x122)]:_0x5ad658['deploymentAction'],[constants_1[_0xc0af05(0x102)]+_0xc0af05(0xd5)]:_0x5ad658[_0xc0af05(0x111)],[constants_1['FLOSUM_NAMESPACE']+_0xc0af05(0xfe)]:_0x5ad658[_0xc0af05(0x136)],[constants_1[_0xc0af05(0x102)]+'Veeva_Step_Name__c']:_0x5ad658[_0xc0af05(0x120)],[constants_1[_0xc0af05(0x102)]+_0xc0af05(0x12a)]:this[_0xc0af05(0xd2)][_0xc0af05(0xeb)],[constants_1[_0xc0af05(0x102)]+_0xc0af05(0x135)]:this['_metadataLogId']};});}async[a361_0x36b195(0xfc)](_0x376613){const _0x48e99d=a361_0x36b195;this['_logger'][_0x48e99d(0x121)]('Save\x20Deployment\x20Results');const _0x54a104=await this[_0x48e99d(0x107)][_0x48e99d(0x12c)](constants_1[_0x48e99d(0x102)]+_0x48e99d(0xd4),_0x376613),_0x7830c0=_0x54a104[_0x48e99d(0x159)](_0x2b7ea4=>!_0x2b7ea4[_0x48e99d(0x143)])['map'](_0x1c119d=>_0x1c119d['errors'])['flat']();if(_0x7830c0[_0x48e99d(0x11d)])throw new salesforce_dml_error_1[(_0x48e99d(0xce))](_0x7830c0);}async['finishRollbackWithError'](_0x3a0821){const _0x44a76c=a361_0x36b195;if(!this[_0x44a76c(0xd2)]){this[_0x44a76c(0x15a)][_0x44a76c(0x155)](_0x3a0821);return;}this[_0x44a76c(0x141)][_0x44a76c(0xea)](_0x3a0821),await this[_0x44a76c(0x141)][_0x44a76c(0x10a)](),await this[_0x44a76c(0x109)](![],!![],'');}async[a361_0x36b195(0x109)](_0x1e6e6a,_0x382e76,_0x4e39f7){const _0x385dc8=a361_0x36b195,{id:_0x4cee25,organizationId:_0x2452ca,branchId:_0x51bb32,organizationName:_0x26819a}=this[_0x385dc8(0xd2)],_0x19a39b='<a\x20href='+this[_0x385dc8(0x14d)]+'/'+_0x4cee25+_0x385dc8(0xe4)+_0x385dc8(0xcf)+_0x385dc8(0x10c),_0x37981b=_0x385dc8(0x157)+this[_0x385dc8(0x14d)]+'/'+_0x2452ca+'\x20>'+_0x26819a+_0x385dc8(0xe7),_0x1f57c6=_0x19a39b+'\x20of\x20branch\x20to\x20Organization\x20'+_0x37981b+_0x385dc8(0xde),_0x2335d0={[constants_1[_0x385dc8(0x102)]+_0x385dc8(0x11f)]:_0x1f57c6,[constants_1[_0x385dc8(0x102)]+_0x385dc8(0x10f)]:new Date(),[constants_1[_0x385dc8(0x102)]+_0x385dc8(0x14c)]:_0x51bb32,[constants_1[_0x385dc8(0x102)]+'Activity_Item__c']:_0x385dc8(0x10b),[constants_1[_0x385dc8(0x102)]+_0x385dc8(0x151)]:_0x385dc8(0x110),[constants_1[_0x385dc8(0x102)]+'TargetId__c']:_0x2452ca},_0x3398a3={[constants_1['FLOSUM_NAMESPACE']+_0x385dc8(0x112)]:!_0x1e6e6a,[constants_1['FLOSUM_NAMESPACE']+_0x385dc8(0xd6)]:_0x1e6e6a,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x382e76?status_enums_1[_0x385dc8(0x11b)][_0x385dc8(0x15d)]:status_enums_1[_0x385dc8(0x11b)][_0x385dc8(0xe8)],[constants_1[_0x385dc8(0x102)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x385dc8(0x144)]:_0x4e39f7};await this[_0x385dc8(0x108)][_0x385dc8(0x139)](flosum_constants_1['FlosumConstants'][_0x385dc8(0xe6)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x385dc8(0x12b)+this[_0x385dc8(0x126)],_0x3398a3),await this[_0x385dc8(0x108)][_0x385dc8(0xef)](flosum_constants_1['FlosumConstants'][_0x385dc8(0xe6)]+'/'+constants_1[_0x385dc8(0x102)]+_0x385dc8(0xf2),_0x2335d0),this[_0x385dc8(0x141)][_0x385dc8(0x121)](_0x385dc8(0xcd)+(_0x1e6e6a?_0x385dc8(0x14f):_0x385dc8(0xf3))+'.'),await this[_0x385dc8(0x141)]['updateLog']();}async[a361_0x36b195(0x138)](){const _0x265d35=a361_0x36b195;try{this[_0x265d35(0xd2)]=await this[_0x265d35(0x132)]();const _0x37b958=await this['retrieveDeploymentResults']();await this[_0x265d35(0x141)]['updateLog']();const _0x4c31db=await this[_0x265d35(0x14a)](_0x37b958),_0x14c7fd=await this[_0x265d35(0xd9)](_0x4c31db);await this[_0x265d35(0x141)][_0x265d35(0x10a)]();const _0x5bfc95=await this[_0x265d35(0xf4)][_0x265d35(0x14b)](_0x14c7fd);await this[_0x265d35(0x141)][_0x265d35(0x10a)]();const _0x2b8ed7=this[_0x265d35(0x130)](_0x5bfc95[_0x265d35(0xdc)]);await this['saveDeploymentResults'](_0x2b8ed7),await this[_0x265d35(0x109)](_0x5bfc95['isDeployed'],![],_0x5bfc95['packageId']);}catch(_0x14681b){await this['finishRollbackWithError'](_0x14681b)[_0x265d35(0x158)](_0x33afa7=>this['_systemLogger'][_0x265d35(0x155)](_0x33afa7));}}}exports[a361_0x36b195(0x12f)]=RollbackService;