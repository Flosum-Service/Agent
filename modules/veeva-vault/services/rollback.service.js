const a406_0x322e95=a406_0x407e;(function(_0x283f46,_0x2f11c8){const _0x559555=a406_0x407e,_0x12f55a=_0x283f46();while(!![]){try{const _0x1fa480=parseInt(_0x559555(0x102))/0x1+parseInt(_0x559555(0x167))/0x2+parseInt(_0x559555(0x146))/0x3+parseInt(_0x559555(0x139))/0x4+-parseInt(_0x559555(0x147))/0x5*(parseInt(_0x559555(0x15d))/0x6)+-parseInt(_0x559555(0x119))/0x7*(-parseInt(_0x559555(0x126))/0x8)+-parseInt(_0x559555(0x192))/0x9;if(_0x1fa480===_0x2f11c8)break;else _0x12f55a['push'](_0x12f55a['shift']());}catch(_0x158d69){_0x12f55a['push'](_0x12f55a['shift']());}}}(a406_0x3987,0x296c9));const a406_0x4cdf1c=(function(){let _0x2c6b1e=!![];return function(_0x5112fd,_0x583737){const _0xe4fb99=_0x2c6b1e?function(){const _0x44a76d=a406_0x407e;if(_0x583737){const _0xdf514a=_0x583737[_0x44a76d(0x134)](_0x5112fd,arguments);return _0x583737=null,_0xdf514a;}}:function(){};return _0x2c6b1e=![],_0xe4fb99;};}()),a406_0x3c13c8=a406_0x4cdf1c(this,function(){const _0x46c93c=a406_0x407e;return a406_0x3c13c8[_0x46c93c(0x10f)]()[_0x46c93c(0x17e)](_0x46c93c(0x172))['toString']()[_0x46c93c(0x179)](a406_0x3c13c8)['search'](_0x46c93c(0x172));});a406_0x3c13c8();function a406_0x407e(_0x2a8c63,_0x14a06e){const _0x4ea458=a406_0x3987();return a406_0x407e=function(_0x3c13c8,_0x4cdf1c){_0x3c13c8=_0x3c13c8-0x102;let _0x3987e7=_0x4ea458[_0x3c13c8];return _0x3987e7;},a406_0x407e(_0x2a8c63,_0x14a06e);}'use strict';var __importDefault=this&&this[a406_0x322e95(0x158)]||function(_0x1d2584){const _0x460928=a406_0x322e95;return _0x1d2584&&_0x1d2584[_0x460928(0x128)]?_0x1d2584:{'default':_0x1d2584};};Object[a406_0x322e95(0x138)](exports,a406_0x322e95(0x128),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a406_0x322e95(0x182)),salesforce_service_1=require(a406_0x322e95(0x136)),package_import_service_1=require(a406_0x322e95(0x12f)),id_deployment_result_retriever_1=require(a406_0x322e95(0x164)),flosum_constants_1=require(a406_0x322e95(0x178)),fetch_attachments_1=require(a406_0x322e95(0x149)),constants_1=require(a406_0x322e95(0x18b)),zip_creator_rollback_1=require(a406_0x322e95(0x116)),shortid_1=__importDefault(require('shortid')),promises_1=require(a406_0x322e95(0x15f)),vpk_service_1=require('./vpk.service'),status_enums_1=require(a406_0x322e95(0x177)),salesforce_dml_error_1=require(a406_0x322e95(0x150)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x3a58db,connectionVeeva:_0x1c2071,logger:_0x249305,tempFolder:_0x3a127d,instanceUrl:_0x45499c,timeZone:_0x19e16d,metadataLogId:_0x29f462,attachmentLogId:_0x210272,parentMetadataLogId:_0x4631ec,componentIds:_0x82f91b}){const _0x59ea05=a406_0x322e95;this[_0x59ea05(0x12e)]=_0x3a58db,this[_0x59ea05(0x166)]=_0x1c2071,this['_logger']=_0x249305,this[_0x59ea05(0x123)]=_0x3a127d,this[_0x59ea05(0x165)]=_0x45499c,this[_0x59ea05(0x11d)]=_0x19e16d,this[_0x59ea05(0x12b)]=_0x29f462,this[_0x59ea05(0x191)]=_0x210272,this[_0x59ea05(0x148)]=_0x4631ec,this[_0x59ea05(0x120)]=_0x82f91b,this[_0x59ea05(0x10c)]=new core_1['Logger'](_0x59ea05(0x122)),this[_0x59ea05(0x153)]=new veeva_service_1[(_0x59ea05(0x133))]({'connection':_0x1c2071,'logger':_0x249305}),this['_salesforceService']=new salesforce_service_1[(_0x59ea05(0x157))]({'connection':_0x3a58db}),this[_0x59ea05(0x13e)]=new package_import_service_1[(_0x59ea05(0x127))]({'veevaService':this[_0x59ea05(0x153)],'connection':_0x1c2071,'logger':_0x249305,'saveLog':this[_0x59ea05(0x10e)][_0x59ea05(0x17c)](this)}),this[_0x59ea05(0x15a)]=new vpk_service_1[(_0x59ea05(0x143))]({'connection':_0x1c2071});}async[a406_0x322e95(0x10e)](_0x43f863,_0x185121){const _0xaaeb6f=a406_0x322e95;this[_0xaaeb6f(0x124)]['log'](_0xaaeb6f(0x17b));const _0x3b8180={'Body':Buffer[_0xaaeb6f(0x18a)](_0x43f863)[_0xaaeb6f(0x10f)](_0xaaeb6f(0x13c)),'ContentType':_0xaaeb6f(0x195),'ParentId':this[_0xaaeb6f(0x12b)],'Name':_0x185121};await this[_0xaaeb6f(0x12e)][_0xaaeb6f(0x184)](flosum_constants_1[_0xaaeb6f(0x10b)][_0xaaeb6f(0x117)]+_0xaaeb6f(0x105),_0x3b8180);}async[a406_0x322e95(0x109)](){const _0x1727a5=a406_0x322e95;this[_0x1727a5(0x124)][_0x1727a5(0x131)](_0x1727a5(0x16d));const [_0x10e6ab]=await this[_0x1727a5(0x152)][_0x1727a5(0x11a)](_0x1727a5(0x108)+constants_1[_0x1727a5(0x16c)]+_0x1727a5(0x16e)+constants_1[_0x1727a5(0x16c)]+_0x1727a5(0x185)+constants_1[_0x1727a5(0x16c)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x1727a5(0x16c)]+_0x1727a5(0x193)+this[_0x1727a5(0x12b)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x1727a5(0x151))](_0x10e6ab);}async[a406_0x322e95(0x137)](){const _0x2c1994=a406_0x322e95;this['_logger']['log'](_0x2c1994(0x14f));const _0x16a007=await new id_deployment_result_retriever_1[(_0x2c1994(0x104))]({'salesforceService':this[_0x2c1994(0x152)],'value':this[_0x2c1994(0x120)]})[_0x2c1994(0x121)]();if(!_0x16a007[_0x2c1994(0x135)])throw new Error(_0x2c1994(0x11f));return _0x16a007;}async['retrieveBackup'](){const _0x450d79=a406_0x322e95;this[_0x450d79(0x124)][_0x450d79(0x131)](_0x450d79(0x162));const _0x3d599e=await this[_0x450d79(0x152)][_0x450d79(0x11a)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x450d79(0x148)]+_0x450d79(0x11c)+flosum_constants_1[_0x450d79(0x10b)]['BACKUP_ZIP_NAME']+_0x450d79(0x17a)),_0x2b4f00=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this['_connectionSalesforce'],[_0x3d599e[0x0]['Id']]),_0x5bb8cc=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x2b4f00,this[_0x450d79(0x12e)]);if(!_0x5bb8cc[_0x450d79(0x135)])throw new Error(_0x450d79(0x125));return _0x5bb8cc[0x0]['values'][_0x450d79(0x16b)];}async[a406_0x322e95(0x140)](_0x5bdb32){const _0x1d6d5e=a406_0x322e95;this['_logger']['log'](_0x1d6d5e(0x13b));const _0xda07e8=await this[_0x1d6d5e(0x198)](),_0x490341=await new zip_creator_rollback_1[(_0x1d6d5e(0x189))]({'rollbackName':this[_0x1d6d5e(0x159)][_0x1d6d5e(0x188)],'backup':_0xda07e8,'deploymentResults':_0x5bdb32})[_0x1d6d5e(0x190)](),_0x2ea5c9=this[_0x1d6d5e(0x123)]+'/'+(0x0,shortid_1['default'])()+'.zip';return await(0x0,promises_1[_0x1d6d5e(0x14c)])(_0x2ea5c9,_0x490341),_0x2ea5c9;}async[a406_0x322e95(0x14a)](_0x32b9f7){const _0x444eba=a406_0x322e95;this[_0x444eba(0x124)][_0x444eba(0x131)]('Create\x20Vpk\x20package');const _0x2de8be=await this[_0x444eba(0x15a)]['generate'](_0x32b9f7),_0x4d8349=this[_0x444eba(0x123)]+_0x444eba(0x132)+_0x32b9f7[_0x444eba(0x19a)](_0x32b9f7[_0x444eba(0x163)]('/')+0x1);return await(0x0,promises_1[_0x444eba(0x14c)])(_0x4d8349,_0x2de8be),await this[_0x444eba(0x15a)][_0x444eba(0x187)](_0x4d8349),_0x4d8349;}[a406_0x322e95(0x155)](_0x33ae0a){const _0x162b71=a406_0x322e95;return this['_logger'][_0x162b71(0x131)](_0x162b71(0x183)),_0x33ae0a[_0x162b71(0x154)](_0x38a65b=>{const _0x2ca8a3=_0x162b71;return this[_0x2ca8a3(0x124)][_0x2ca8a3(0x131)](_0x38a65b['type']+'.'+_0x38a65b[_0x2ca8a3(0x188)]+_0x2ca8a3(0x180)+_0x38a65b[_0x2ca8a3(0x107)]),{[constants_1['FLOSUM_NAMESPACE']+_0x2ca8a3(0x12a)]:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x38a65b[_0x2ca8a3(0x107)]===status_enums_1[_0x2ca8a3(0x16f)][_0x2ca8a3(0x144)]?_0x2ca8a3(0x196):_0x2ca8a3(0x10d),[constants_1[_0x2ca8a3(0x16c)]+_0x2ca8a3(0x13a)]:_0x38a65b[_0x2ca8a3(0x113)],[constants_1['FLOSUM_NAMESPACE']+_0x2ca8a3(0x103)]:_0x38a65b[_0x2ca8a3(0x188)],[constants_1[_0x2ca8a3(0x16c)]+_0x2ca8a3(0x15e)]:_0x38a65b['type'],[constants_1[_0x2ca8a3(0x16c)]+_0x2ca8a3(0x18f)]:_0x38a65b[_0x2ca8a3(0x168)],[constants_1[_0x2ca8a3(0x16c)]+_0x2ca8a3(0x161)]:this[_0x2ca8a3(0x159)][_0x2ca8a3(0x112)],[constants_1[_0x2ca8a3(0x16c)]+_0x2ca8a3(0x12d)]:this[_0x2ca8a3(0x12b)]};});}async[a406_0x322e95(0x197)](_0xdd7b91){const _0x45bf2f=a406_0x322e95;this[_0x45bf2f(0x124)][_0x45bf2f(0x131)](_0x45bf2f(0x15c));const _0x59b64d=await this['_salesforceService'][_0x45bf2f(0x173)](constants_1[_0x45bf2f(0x16c)]+'Deployment_Result__c',_0xdd7b91),_0x606b5b=_0x59b64d[_0x45bf2f(0x174)](_0x35d2eb=>!_0x35d2eb[_0x45bf2f(0x129)])[_0x45bf2f(0x154)](_0x41ecce=>_0x41ecce[_0x45bf2f(0x169)])[_0x45bf2f(0x18d)]();if(_0x606b5b['length'])throw new salesforce_dml_error_1[(_0x45bf2f(0x110))](_0x606b5b);}async[a406_0x322e95(0x18e)](_0xacf622){const _0x3b7bae=a406_0x322e95;if(!this[_0x3b7bae(0x159)]){this['_systemLogger'][_0x3b7bae(0x17f)](_0xacf622);return;}this[_0x3b7bae(0x124)][_0x3b7bae(0x16a)](_0xacf622),await this[_0x3b7bae(0x124)]['updateLog'](),await this[_0x3b7bae(0x118)](![],!![],'');}async['finishRollback'](_0x20363d,_0x4e2ed8,_0x2b7075){const _0x5950a9=a406_0x322e95,{id:_0x15b7bc,organizationId:_0x323f32,branchId:_0x244569,organizationName:_0x4b86c6}=this[_0x5950a9(0x159)],_0x1572aa=_0x5950a9(0x11e)+this[_0x5950a9(0x165)]+'/'+_0x15b7bc+_0x5950a9(0x181)+_0x5950a9(0x13d)+'\x20</a>',_0xa514b7=_0x5950a9(0x11e)+this['_instanceUrl']+'/'+_0x323f32+'\x20>'+_0x4b86c6+_0x5950a9(0x175),_0x587b5e=_0x1572aa+_0x5950a9(0x176)+_0xa514b7+_0x5950a9(0x12c),_0x5b7243={[constants_1[_0x5950a9(0x16c)]+_0x5950a9(0x111)]:_0x587b5e,[constants_1['FLOSUM_NAMESPACE']+_0x5950a9(0x106)]:new Date(),[constants_1[_0x5950a9(0x16c)]+_0x5950a9(0x114)]:_0x244569,[constants_1[_0x5950a9(0x16c)]+'Activity_Item__c']:'Branch',[constants_1[_0x5950a9(0x16c)]+'Activity_Type__c']:_0x5950a9(0x115),[constants_1[_0x5950a9(0x16c)]+_0x5950a9(0x10a)]:_0x323f32},_0x1ae8f3={[constants_1[_0x5950a9(0x16c)]+_0x5950a9(0x160)]:!_0x20363d,[constants_1[_0x5950a9(0x16c)]+_0x5950a9(0x156)]:_0x20363d,[constants_1[_0x5950a9(0x16c)]+'Status__c']:_0x4e2ed8?status_enums_1['MetadataLogStatus'][_0x5950a9(0x186)]:status_enums_1[_0x5950a9(0x11b)][_0x5950a9(0x130)],[constants_1[_0x5950a9(0x16c)]+_0x5950a9(0x141)]:!![],[constants_1[_0x5950a9(0x16c)]+_0x5950a9(0x170)]:_0x2b7075};await this[_0x5950a9(0x12e)]['patch'](flosum_constants_1['FlosumConstants'][_0x5950a9(0x117)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x5950a9(0x13f)+this['_metadataLogId'],_0x1ae8f3),await this[_0x5950a9(0x12e)]['post'](flosum_constants_1[_0x5950a9(0x10b)][_0x5950a9(0x117)]+'/'+constants_1[_0x5950a9(0x16c)]+_0x5950a9(0x171),_0x5b7243),this['_logger']['log'](_0x5950a9(0x199)+(_0x20363d?_0x5950a9(0x14e):_0x5950a9(0x145))+'.'),await this[_0x5950a9(0x124)][_0x5950a9(0x14d)]();}async[a406_0x322e95(0x18c)](){const _0x4cb2ba=a406_0x322e95;try{this[_0x4cb2ba(0x159)]=await this['retrieveMetadataLog']();const _0x536528=await this[_0x4cb2ba(0x137)]();await this[_0x4cb2ba(0x124)][_0x4cb2ba(0x14d)]();const _0x3b6189=await this['createZip'](_0x536528),_0x53ae28=await this[_0x4cb2ba(0x14a)](_0x3b6189);await this[_0x4cb2ba(0x124)][_0x4cb2ba(0x14d)]();const _0x1adf1c=await this['_packageImportService'][_0x4cb2ba(0x17d)](_0x53ae28);await this['_logger'][_0x4cb2ba(0x14d)]();const _0x24d748=this['formFlosumDeploymentResults'](_0x1adf1c[_0x4cb2ba(0x142)]);await this[_0x4cb2ba(0x197)](_0x24d748),await this[_0x4cb2ba(0x118)](_0x1adf1c['isDeployed'],![],_0x1adf1c[_0x4cb2ba(0x14b)]);}catch(_0x1ced5c){await this[_0x4cb2ba(0x18e)](_0x1ced5c)[_0x4cb2ba(0x15b)](_0x357112=>this['_systemLogger'][_0x4cb2ba(0x17f)](_0x357112));}}}exports[a406_0x322e95(0x194)]=RollbackService;function a406_0x3987(){const _0x900fc7=['map','formFlosumDeploymentResults','Succeed__c','SalesforceService','__importDefault','_metadataLog','_vpkService','catch','Save\x20Deployment\x20Results','222waBMRs','Component_Type__c','fs/promises','Is_Error__c','Org__c','Retrieve\x20Backup','lastIndexOf','../classes/retrievers/deployment-results/id.deployment-result.retriever','_instanceUrl','_connectionVeeva','387082eXlXry','stepName','errors','logError','Body','FLOSUM_NAMESPACE','Retrieve\x20Metadata\x20Log\x20info','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','PackageComponentStatus','External_Deployment_Id__c','Log__c','(((.+)+)+)+$','insertMultipleRecords','filter','</a>','\x20of\x20branch\x20to\x20Organization\x20','../enums/status.enums','../constants/flosum.constants','constructor','\x27\x0a\x20\x20\x20\x20','Save\x20log','bind','import','search','error','\x20:\x20','\x20>\x20','./veeva.service','Form\x20Deployment\x20Results','post','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','EXCEPTION','validate','name','ZipCreatorRollback','from','../../../constants','execute','flat','finishRollbackWithError','Veeva_Step_Name__c','create','_attachmentLogId','4880007ZDeJHC','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','RollbackService','text/plain','Success','saveDeploymentResults','retrieveBackup','Rollback\x20completed\x20','slice','325567RJIzeK','Component_Name__c','IdDeploymentResultRetriever','/Attachment','Date__c','status','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','retrieveMetadataLog','TargetId__c','FlosumConstants','_systemLogger','Failure','saveLog','toString','SalesforceDmlError','Action__c','organizationId','deploymentAction','Branch__c','Deployment','../classes/rollback/zip-creator.rollback','ENDPOINT_UPSERT_RECORD','finishRollback','2012269PrZhMA','retrieveRecords','MetadataLogStatus','\x27\x20AND\x20Name\x20=\x20\x27','_timeZone','<a\x20href=','Cannot\x20find\x20Deployment\x20Results','_componentIds','retrieve','veeva-rollback','_tempFolder','_logger','Cannot\x20find\x20Backup\x20Zip','8ppLQZR','PackageImportService','__esModule','success','Type__c','_metadataLogId','\x20has\x20been\x20created.','Metadata_Log__c','_connectionSalesforce','./package-import.service','COMPLETED','log','/vpk__','VeevaService','apply','length','./salesforce.service','retrieveDeploymentResults','defineProperty','552076qXSuQk','Result__c','Create\x20zip\x20from\x20backup','base64','Veeva\x20Rollback\x20(Deployment)','_packageImportService','Metadata_Log__c/','createZip','Job_Completed__c','packageComponentList','VpkService','DEPLOYED','with\x20error','287031SrgeWy','44375fYfVFs','_parentMetadataLogId','../../shared/utils/fetch-attachments','createVpk','packageId','writeFile','updateLog','successfully','Retrieve\x20Deployment\x20Results','../classes/errors/salesforce-dml-error','MetadataLogDto','_salesforceService','_veevaService'];a406_0x3987=function(){return _0x900fc7;};return a406_0x3987();}