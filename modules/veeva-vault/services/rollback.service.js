const a392_0x10ad4b=a392_0x329d;(function(_0x2bc9f5,_0x344569){const _0x3e97c4=a392_0x329d,_0xaf2e8c=_0x2bc9f5();while(!![]){try{const _0x342ba7=-parseInt(_0x3e97c4(0x149))/0x1*(-parseInt(_0x3e97c4(0x176))/0x2)+parseInt(_0x3e97c4(0x15d))/0x3+-parseInt(_0x3e97c4(0x16f))/0x4+parseInt(_0x3e97c4(0x135))/0x5+parseInt(_0x3e97c4(0x19f))/0x6+-parseInt(_0x3e97c4(0x133))/0x7+-parseInt(_0x3e97c4(0x126))/0x8*(parseInt(_0x3e97c4(0x180))/0x9);if(_0x342ba7===_0x344569)break;else _0xaf2e8c['push'](_0xaf2e8c['shift']());}catch(_0x475949){_0xaf2e8c['push'](_0xaf2e8c['shift']());}}}(a392_0x3868,0x51b11));const a392_0xcf51f=(function(){let _0x15c789=!![];return function(_0x46e65b,_0x511142){const _0x471a76=_0x15c789?function(){if(_0x511142){const _0x205cb1=_0x511142['apply'](_0x46e65b,arguments);return _0x511142=null,_0x205cb1;}}:function(){};return _0x15c789=![],_0x471a76;};}()),a392_0x50f853=a392_0xcf51f(this,function(){const _0x5dc0ac=a392_0x329d;return a392_0x50f853[_0x5dc0ac(0x164)]()[_0x5dc0ac(0x17d)](_0x5dc0ac(0x132))['toString']()['constructor'](a392_0x50f853)[_0x5dc0ac(0x17d)](_0x5dc0ac(0x132));});a392_0x50f853();'use strict';var __importDefault=this&&this[a392_0x10ad4b(0x1a4)]||function(_0x1483bf){const _0x42dbb5=a392_0x10ad4b;return _0x1483bf&&_0x1483bf[_0x42dbb5(0x17c)]?_0x1483bf:{'default':_0x1483bf};};function a392_0x3868(){const _0x494077=['_instanceUrl','Veeva_Step_Name__c','../constants/flosum.constants','../enums/status.enums','Create\x20zip\x20from\x20backup','Save\x20Deployment\x20Results','shortid','Job_Completed__c','status','filter','_salesforceService','Activity_Item__c','finishRollbackWithError','</a>','TargetId__c','success','organizationId','_timeZone','create','createVpk','Component_Name__c','validate','Veeva\x20Rollback\x20(Deployment)','_packageImportService','deploymentAction','updateLog','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','catch','408444tPNNNV','\x27\x20AND\x20Name\x20=\x20\x27','execute','Deployment','Component_Type__c','__importDefault','\x20>\x20','import','../dtos/metadata-log.dto','_tempFolder','post','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Org__c','\x20</a>','saveLog','/Attachment','log','./veeva.service','COMPLETED','length','../classes/errors/salesforce-dml-error','Status__c','Rollback\x20completed\x20','writeFile','Retrieve\x20Deployment\x20Results','errors','_vpkService','retrieveDeploymentResults','PackageComponentStatus','70400ofOoDB','_metadataLogId','retrieveAttachments','fs/promises','SalesforceService','ZipCreatorRollback','text/plain','defineProperty','./package-import.service','ENDPOINT_UPSERT_RECORD','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','.zip','(((.+)+)+)+$','4404967xJPdUw','veeva-rollback','1243440iSPsdb','values','\x27\x0a\x20\x20\x20\x20','finishRollback','Cannot\x20find\x20Backup\x20Zip','Is_Error__c','FLOSUM_NAMESPACE','_componentIds','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','VpkService','SalesforceDmlError','_logger','_parentMetadataLogId','base64','Result__c','../../../core','formFlosumDeploymentResults','Log__c','Metadata_Log__c','retrieveBackup','1SAuspb','successfully','insertMultipleRecords','error','./vpk.service','with\x20error','saveDeploymentResults','VeevaService','DEPLOYED','Deployment\x20Result','IdDeploymentResultRetriever','../classes/rollback/zip-creator.rollback','\x20:\x20','BACKUP_ZIP_NAME','FlosumConstants','_systemLogger','map','../../../constants','\x20of\x20branch\x20to\x20Organization\x20','RollbackService','741522IfwqhK','Success','Type__c','PackageImportService','logError','Retrieve\x20Metadata\x20Log\x20info','Succeed__c','toString','retrieve','bind','from','packageId','Create\x20Vpk\x20package','\x20has\x20been\x20created.','_attachmentLogId','MetadataLogStatus','retrieveRecords','Failure','52808lQjeED','type','isDeployed','_metadataLog','_connectionSalesforce','EXCEPTION','fetchAttachmentsDetailsById','879112KvJCak','flat','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Activity_Type__c','External_Deployment_Id__c','Action__c','__esModule','search','./salesforce.service','slice','27OOuhia','<a\x20href=','Deployment_Result__c'];a392_0x3868=function(){return _0x494077;};return a392_0x3868();}Object[a392_0x10ad4b(0x12d)](exports,a392_0x10ad4b(0x17c),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a392_0x10ad4b(0x1b0)),salesforce_service_1=require(a392_0x10ad4b(0x17e)),package_import_service_1=require(a392_0x10ad4b(0x12e)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a392_0x10ad4b(0x185)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a392_0x10ad4b(0x15a)),zip_creator_rollback_1=require(a392_0x10ad4b(0x154)),shortid_1=__importDefault(require(a392_0x10ad4b(0x189))),promises_1=require(a392_0x10ad4b(0x129)),vpk_service_1=require(a392_0x10ad4b(0x14d)),status_enums_1=require(a392_0x10ad4b(0x186)),salesforce_dml_error_1=require(a392_0x10ad4b(0x1b3)),metadata_log_dto_1=require(a392_0x10ad4b(0x1a7)),core_1=require(a392_0x10ad4b(0x144));function a392_0x329d(_0x3c4e41,_0x3b5d1a){const _0x129378=a392_0x3868();return a392_0x329d=function(_0x50f853,_0xcf51f){_0x50f853=_0x50f853-0x120;let _0x38680a=_0x129378[_0x50f853];return _0x38680a;},a392_0x329d(_0x3c4e41,_0x3b5d1a);}class RollbackService{constructor({connectionSalesforce:_0x94f304,connectionVeeva:_0x42d9e6,logger:_0x71e307,tempFolder:_0x332b39,instanceUrl:_0x49b3a6,timeZone:_0x34cc68,metadataLogId:_0x4fc389,attachmentLogId:_0x18145d,parentMetadataLogId:_0x333e20,componentIds:_0xd8f20d}){const _0x1bdcfc=a392_0x10ad4b;this[_0x1bdcfc(0x173)]=_0x94f304,this['_connectionVeeva']=_0x42d9e6,this['_logger']=_0x71e307,this[_0x1bdcfc(0x1a8)]=_0x332b39,this[_0x1bdcfc(0x183)]=_0x49b3a6,this[_0x1bdcfc(0x194)]=_0x34cc68,this[_0x1bdcfc(0x127)]=_0x4fc389,this[_0x1bdcfc(0x16b)]=_0x18145d,this[_0x1bdcfc(0x141)]=_0x333e20,this[_0x1bdcfc(0x13c)]=_0xd8f20d,this[_0x1bdcfc(0x158)]=new core_1['Logger'](_0x1bdcfc(0x134)),this['_veevaService']=new veeva_service_1[(_0x1bdcfc(0x150))]({'connection':_0x42d9e6,'logger':_0x71e307}),this[_0x1bdcfc(0x18d)]=new salesforce_service_1[(_0x1bdcfc(0x12a))]({'connection':_0x94f304}),this[_0x1bdcfc(0x19a)]=new package_import_service_1[(_0x1bdcfc(0x160))]({'veevaService':this['_veevaService'],'connection':_0x42d9e6,'logger':_0x71e307,'saveLog':this[_0x1bdcfc(0x1ad)][_0x1bdcfc(0x166)](this)}),this[_0x1bdcfc(0x123)]=new vpk_service_1[(_0x1bdcfc(0x13e))]({'connection':_0x42d9e6});}async['saveLog'](_0x4e2c1a,_0xf50963){const _0x4c3121=a392_0x10ad4b;this[_0x4c3121(0x140)]['log']('Save\x20log');const _0x397694={'Body':Buffer[_0x4c3121(0x167)](_0x4e2c1a)[_0x4c3121(0x164)](_0x4c3121(0x142)),'ContentType':_0x4c3121(0x12c),'ParentId':this[_0x4c3121(0x127)],'Name':_0xf50963};await this['_connectionSalesforce']['post'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0x4c3121(0x1ae),_0x397694);}async['retrieveMetadataLog'](){const _0x57a565=a392_0x10ad4b;this['_logger']['log'](_0x57a565(0x162));const [_0x18ea55]=await this[_0x57a565(0x18d)]['retrieveRecords'](_0x57a565(0x19d)+constants_1['FLOSUM_NAMESPACE']+_0x57a565(0x178)+constants_1['FLOSUM_NAMESPACE']+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x57a565(0x13b)]+_0x57a565(0x1aa)+constants_1[_0x57a565(0x13b)]+_0x57a565(0x13d)+this[_0x57a565(0x127)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1['MetadataLogDto'](_0x18ea55);}async['retrieveDeploymentResults'](){const _0x3de573=a392_0x10ad4b;this[_0x3de573(0x140)]['log'](_0x3de573(0x121));const _0x16b74c=await new id_deployment_result_retriever_1[(_0x3de573(0x153))]({'salesforceService':this[_0x3de573(0x18d)],'value':this[_0x3de573(0x13c)]})[_0x3de573(0x165)]();if(!_0x16b74c[_0x3de573(0x1b2)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x16b74c;}async[a392_0x10ad4b(0x148)](){const _0x325829=a392_0x10ad4b;this['_logger'][_0x325829(0x1af)]('Retrieve\x20Backup');const _0x707b6c=await this[_0x325829(0x18d)][_0x325829(0x16d)](_0x325829(0x130)+this[_0x325829(0x141)]+_0x325829(0x1a0)+flosum_constants_1[_0x325829(0x157)][_0x325829(0x156)]+_0x325829(0x137)),_0x37cb42=await(0x0,fetch_attachments_1[_0x325829(0x175)])(this[_0x325829(0x173)],[_0x707b6c[0x0]['Id']]),_0x1666c6=await(0x0,fetch_attachments_1[_0x325829(0x128)])(_0x37cb42,this[_0x325829(0x173)]);if(!_0x1666c6[_0x325829(0x1b2)])throw new Error(_0x325829(0x139));return _0x1666c6[0x0][_0x325829(0x136)]['Body'];}async['createZip'](_0x4d0c81){const _0x552874=a392_0x10ad4b;this[_0x552874(0x140)][_0x552874(0x1af)](_0x552874(0x187));const _0x56ec2d=await this[_0x552874(0x148)](),_0x12efd3=await new zip_creator_rollback_1[(_0x552874(0x12b))]({'rollbackName':this[_0x552874(0x172)]['name'],'backup':_0x56ec2d,'deploymentResults':_0x4d0c81})[_0x552874(0x195)](),_0x1e9bee=this[_0x552874(0x1a8)]+'/'+(0x0,shortid_1['default'])()+_0x552874(0x131);return await(0x0,promises_1[_0x552874(0x120)])(_0x1e9bee,_0x12efd3),_0x1e9bee;}async[a392_0x10ad4b(0x196)](_0x45e4a1){const _0x4a297e=a392_0x10ad4b;this[_0x4a297e(0x140)]['log'](_0x4a297e(0x169));const _0x256db3=await this['_vpkService']['generate'](_0x45e4a1),_0x451bf3=this[_0x4a297e(0x1a8)]+'/vpk__'+_0x45e4a1[_0x4a297e(0x17f)](_0x45e4a1['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x451bf3,_0x256db3),await this[_0x4a297e(0x123)][_0x4a297e(0x198)](_0x451bf3),_0x451bf3;}[a392_0x10ad4b(0x145)](_0x25af91){const _0x5c6e68=a392_0x10ad4b;return this['_logger'][_0x5c6e68(0x1af)]('Form\x20Deployment\x20Results'),_0x25af91[_0x5c6e68(0x159)](_0x253dbb=>{const _0x313dbc=_0x5c6e68;return this[_0x313dbc(0x140)][_0x313dbc(0x1af)](_0x253dbb[_0x313dbc(0x170)]+'.'+_0x253dbb['name']+_0x313dbc(0x155)+_0x253dbb[_0x313dbc(0x18b)]),{[constants_1['FLOSUM_NAMESPACE']+_0x313dbc(0x15f)]:_0x313dbc(0x152),[constants_1['FLOSUM_NAMESPACE']+_0x313dbc(0x1b4)]:_0x253dbb[_0x313dbc(0x18b)]===status_enums_1[_0x313dbc(0x125)][_0x313dbc(0x151)]?_0x313dbc(0x15e):_0x313dbc(0x16e),[constants_1[_0x313dbc(0x13b)]+_0x313dbc(0x143)]:_0x253dbb[_0x313dbc(0x19b)],[constants_1[_0x313dbc(0x13b)]+_0x313dbc(0x197)]:_0x253dbb['name'],[constants_1['FLOSUM_NAMESPACE']+_0x313dbc(0x1a3)]:_0x253dbb['type'],[constants_1[_0x313dbc(0x13b)]+_0x313dbc(0x184)]:_0x253dbb['stepName'],[constants_1[_0x313dbc(0x13b)]+_0x313dbc(0x1ab)]:this[_0x313dbc(0x172)][_0x313dbc(0x193)],[constants_1[_0x313dbc(0x13b)]+_0x313dbc(0x147)]:this[_0x313dbc(0x127)]};});}async['saveDeploymentResults'](_0x1a2f49){const _0x436a65=a392_0x10ad4b;this[_0x436a65(0x140)][_0x436a65(0x1af)](_0x436a65(0x188));const _0x43126b=await this[_0x436a65(0x18d)][_0x436a65(0x14b)](constants_1[_0x436a65(0x13b)]+_0x436a65(0x182),_0x1a2f49),_0x516558=_0x43126b[_0x436a65(0x18c)](_0x4286b5=>!_0x4286b5[_0x436a65(0x192)])[_0x436a65(0x159)](_0x195c69=>_0x195c69[_0x436a65(0x122)])[_0x436a65(0x177)]();if(_0x516558[_0x436a65(0x1b2)])throw new salesforce_dml_error_1[(_0x436a65(0x13f))](_0x516558);}async[a392_0x10ad4b(0x18f)](_0x2969b8){const _0x350a15=a392_0x10ad4b;if(!this[_0x350a15(0x172)]){this[_0x350a15(0x158)][_0x350a15(0x14c)](_0x2969b8);return;}this[_0x350a15(0x140)][_0x350a15(0x161)](_0x2969b8),await this[_0x350a15(0x140)][_0x350a15(0x19c)](),await this[_0x350a15(0x138)](![],!![],'');}async[a392_0x10ad4b(0x138)](_0x251b73,_0x4d80b3,_0x5b9a43){const _0x175f5e=a392_0x10ad4b,{id:_0x21344e,organizationId:_0x130ded,branchId:_0x4113f6,organizationName:_0x28ff40}=this[_0x175f5e(0x172)],_0x5a4f8c=_0x175f5e(0x181)+this[_0x175f5e(0x183)]+'/'+_0x21344e+_0x175f5e(0x1a5)+_0x175f5e(0x199)+_0x175f5e(0x1ac),_0x437f05=_0x175f5e(0x181)+this['_instanceUrl']+'/'+_0x130ded+'\x20>'+_0x28ff40+_0x175f5e(0x190),_0x59b67e=_0x5a4f8c+_0x175f5e(0x15b)+_0x437f05+_0x175f5e(0x16a),_0x940249={[constants_1[_0x175f5e(0x13b)]+_0x175f5e(0x17b)]:_0x59b67e,[constants_1[_0x175f5e(0x13b)]+'Date__c']:new Date(),[constants_1[_0x175f5e(0x13b)]+'Branch__c']:_0x4113f6,[constants_1[_0x175f5e(0x13b)]+_0x175f5e(0x18e)]:'Branch',[constants_1[_0x175f5e(0x13b)]+_0x175f5e(0x179)]:_0x175f5e(0x1a2),[constants_1['FLOSUM_NAMESPACE']+_0x175f5e(0x191)]:_0x130ded},_0xb31420={[constants_1[_0x175f5e(0x13b)]+_0x175f5e(0x13a)]:!_0x251b73,[constants_1[_0x175f5e(0x13b)]+_0x175f5e(0x163)]:_0x251b73,[constants_1[_0x175f5e(0x13b)]+_0x175f5e(0x1b4)]:_0x4d80b3?status_enums_1['MetadataLogStatus'][_0x175f5e(0x174)]:status_enums_1[_0x175f5e(0x16c)][_0x175f5e(0x1b1)],[constants_1['FLOSUM_NAMESPACE']+_0x175f5e(0x18a)]:!![],[constants_1[_0x175f5e(0x13b)]+_0x175f5e(0x17a)]:_0x5b9a43};await this['_connectionSalesforce']['patch'](flosum_constants_1['FlosumConstants'][_0x175f5e(0x12f)]+'/'+constants_1[_0x175f5e(0x13b)]+'Metadata_Log__c/'+this[_0x175f5e(0x127)],_0xb31420),await this['_connectionSalesforce'][_0x175f5e(0x1a9)](flosum_constants_1[_0x175f5e(0x157)][_0x175f5e(0x12f)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x175f5e(0x146),_0x940249),this[_0x175f5e(0x140)][_0x175f5e(0x1af)](_0x175f5e(0x1b5)+(_0x251b73?_0x175f5e(0x14a):_0x175f5e(0x14e))+'.'),await this[_0x175f5e(0x140)]['updateLog']();}async[a392_0x10ad4b(0x1a1)](){const _0xcb006a=a392_0x10ad4b;try{this['_metadataLog']=await this['retrieveMetadataLog']();const _0xe8f0eb=await this[_0xcb006a(0x124)]();await this[_0xcb006a(0x140)][_0xcb006a(0x19c)]();const _0x3bce00=await this['createZip'](_0xe8f0eb),_0x16e464=await this['createVpk'](_0x3bce00);await this[_0xcb006a(0x140)][_0xcb006a(0x19c)]();const _0x516e28=await this[_0xcb006a(0x19a)][_0xcb006a(0x1a6)](_0x16e464);await this['_logger'][_0xcb006a(0x19c)]();const _0x1ee698=this[_0xcb006a(0x145)](_0x516e28['packageComponentList']);await this[_0xcb006a(0x14f)](_0x1ee698),await this[_0xcb006a(0x138)](_0x516e28[_0xcb006a(0x171)],![],_0x516e28[_0xcb006a(0x168)]);}catch(_0x35769f){await this[_0xcb006a(0x18f)](_0x35769f)[_0xcb006a(0x19e)](_0x5ae9dd=>this[_0xcb006a(0x158)]['error'](_0x5ae9dd));}}}exports[a392_0x10ad4b(0x15c)]=RollbackService;