function a361_0x12ae(){const _0x2c495f=['finishRollbackWithError','BACKUP_ZIP_NAME','veeva-rollback','Date__c','437521ZUZXWi','../constants/flosum.constants','deploymentAction','packageId','saveLog','values','search','finishRollback','DEPLOYED','_packageImportService','Component_Type__c','Activity_Item__c','Branch__c','__importDefault','553365GnUPsQ','Metadata_Log__c/','Log__c','_vpkService','_metadataLogId','_logger','</a>','Retrieve\x20Backup','Status__c','shortid','Veeva_Step_Name__c','_salesforceService','retrieve','successfully','updateLog','MetadataLogStatus','log','Create\x20Vpk\x20package','Retrieve\x20Deployment\x20Results','2xMmbaS','fs/promises','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_connectionSalesforce','COMPLETED','\x27\x20AND\x20Name\x20=\x20\x27','Org__c','writeFile','constructor','Is_Error__c','toString','../../../constants','FlosumConstants','.zip','from','organizationId','(((.+)+)+)+$','1266231KjsTqg','Retrieve\x20Metadata\x20Log\x20info','success','ENDPOINT_UPSERT_RECORD','Form\x20Deployment\x20Results','generate','RollbackService','../classes/errors/salesforce-dml-error','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','validate','805288luADcC','SalesforceDmlError','_parentMetadataLogId','createZip','error','_componentIds','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','<a\x20href=','slice','post','execute','\x27\x0a\x20\x20\x20\x20','EXCEPTION','Component_Name__c','FLOSUM_NAMESPACE','_systemLogger','_timeZone','Logger','./veeva.service','PackageImportService','378dslFGN','catch','Job_Completed__c','formFlosumDeploymentResults','retrieveAttachments','retrieveRecords','TargetId__c','\x20:\x20','isDeployed','ZipCreatorRollback','_veevaService','VeevaService','bind','insertMultipleRecords','1285TDSbrQ','_tempFolder','retrieveBackup','type','2706TZVeXO','saveDeploymentResults','packageComponentList','../classes/rollback/zip-creator.rollback','MetadataLogDto','\x20</a>','fetchAttachmentsDetailsById','Failure','../classes/retrievers/deployment-results/id.deployment-result.retriever','Success','Metadata_Log__c','retrieveDeploymentResults','name','5420NANhel','status','_instanceUrl','default','map','_metadataLog','Save\x20log','retrieveMetadataLog','with\x20error','createVpk','Deployment_Result__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','__esModule','length','./package-import.service','/Attachment','../../shared/utils/fetch-attachments','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Async_Request_Id__c','../dtos/metadata-log.dto','../enums/status.enums','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','./vpk.service','9239920BPvrvi','Body','/vpk__','apply','Type__c'];a361_0x12ae=function(){return _0x2c495f;};return a361_0x12ae();}function a361_0x56d6(_0x4bf37d,_0x477272){const _0x1316c6=a361_0x12ae();return a361_0x56d6=function(_0x1bc4c2,_0x4bdf46){_0x1bc4c2=_0x1bc4c2-0x142;let _0x12ae4d=_0x1316c6[_0x1bc4c2];return _0x12ae4d;},a361_0x56d6(_0x4bf37d,_0x477272);}const a361_0x57b61c=a361_0x56d6;(function(_0x30acb0,_0x119e1b){const _0x2e0fb2=a361_0x56d6,_0x158bb2=_0x30acb0();while(!![]){try{const _0x5dd152=-parseInt(_0x2e0fb2(0x1c7))/0x1*(-parseInt(_0x2e0fb2(0x159))/0x2)+parseInt(_0x2e0fb2(0x16a))/0x3+-parseInt(_0x2e0fb2(0x1a7))/0x4*(-parseInt(_0x2e0fb2(0x196))/0x5)+parseInt(_0x2e0fb2(0x19a))/0x6*(parseInt(_0x2e0fb2(0x188))/0x7)+-parseInt(_0x2e0fb2(0x174))/0x8+parseInt(_0x2e0fb2(0x146))/0x9+-parseInt(_0x2e0fb2(0x1be))/0xa;if(_0x5dd152===_0x119e1b)break;else _0x158bb2['push'](_0x158bb2['shift']());}catch(_0x134eb4){_0x158bb2['push'](_0x158bb2['shift']());}}}(a361_0x12ae,0x41adb));const a361_0x4bdf46=(function(){let _0x33b172=!![];return function(_0x389b0b,_0x661228){const _0x4b6c95=_0x33b172?function(){const _0x4e4e15=a361_0x56d6;if(_0x661228){const _0x149bd9=_0x661228[_0x4e4e15(0x1c1)](_0x389b0b,arguments);return _0x661228=null,_0x149bd9;}}:function(){};return _0x33b172=![],_0x4b6c95;};}()),a361_0x1bc4c2=a361_0x4bdf46(this,function(){const _0x521cf8=a361_0x56d6;return a361_0x1bc4c2[_0x521cf8(0x163)]()[_0x521cf8(0x1cd)](_0x521cf8(0x169))['toString']()[_0x521cf8(0x161)](a361_0x1bc4c2)[_0x521cf8(0x1cd)](_0x521cf8(0x169));});a361_0x1bc4c2();'use strict';var __importDefault=this&&this[a361_0x57b61c(0x145)]||function(_0x5750d8){const _0x532799=a361_0x57b61c;return _0x5750d8&&_0x5750d8[_0x532799(0x1b3)]?_0x5750d8:{'default':_0x5750d8};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a361_0x57b61c(0x186)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a361_0x57b61c(0x1b5)),id_deployment_result_retriever_1=require(a361_0x57b61c(0x1a2)),flosum_constants_1=require(a361_0x57b61c(0x1c8)),fetch_attachments_1=require(a361_0x57b61c(0x1b7)),constants_1=require(a361_0x57b61c(0x164)),zip_creator_rollback_1=require(a361_0x57b61c(0x19d)),shortid_1=__importDefault(require(a361_0x57b61c(0x14f))),promises_1=require(a361_0x57b61c(0x15a)),vpk_service_1=require(a361_0x57b61c(0x1bd)),status_enums_1=require(a361_0x57b61c(0x1bb)),salesforce_dml_error_1=require(a361_0x57b61c(0x171)),metadata_log_dto_1=require(a361_0x57b61c(0x1ba)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x2ea8a3,connectionVeeva:_0x1803cc,logger:_0x1bbba4,tempFolder:_0x5376ad,instanceUrl:_0x33e6e4,timeZone:_0x4ead75,metadataLogId:_0x416ecf,attachmentLogId:_0x365a91,parentMetadataLogId:_0x2f84f3,componentIds:_0x103854}){const _0x25ce7a=a361_0x57b61c;this['_connectionSalesforce']=_0x2ea8a3,this['_connectionVeeva']=_0x1803cc,this[_0x25ce7a(0x14b)]=_0x1bbba4,this[_0x25ce7a(0x197)]=_0x5376ad,this[_0x25ce7a(0x1a9)]=_0x33e6e4,this[_0x25ce7a(0x184)]=_0x4ead75,this[_0x25ce7a(0x14a)]=_0x416ecf,this['_attachmentLogId']=_0x365a91,this[_0x25ce7a(0x176)]=_0x2f84f3,this[_0x25ce7a(0x179)]=_0x103854,this[_0x25ce7a(0x183)]=new core_1[(_0x25ce7a(0x185))](_0x25ce7a(0x1c5)),this[_0x25ce7a(0x192)]=new veeva_service_1[(_0x25ce7a(0x193))]({'connection':_0x1803cc,'logger':_0x1bbba4}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':_0x2ea8a3}),this[_0x25ce7a(0x1d0)]=new package_import_service_1[(_0x25ce7a(0x187))]({'veevaService':this[_0x25ce7a(0x192)],'connection':_0x1803cc,'logger':_0x1bbba4,'saveLog':this[_0x25ce7a(0x1cb)][_0x25ce7a(0x194)](this)}),this[_0x25ce7a(0x149)]=new vpk_service_1['VpkService']({'connection':_0x1803cc});}async[a361_0x57b61c(0x1cb)](_0x1f087c,_0x406b42){const _0x1db406=a361_0x57b61c;this[_0x1db406(0x14b)][_0x1db406(0x156)](_0x1db406(0x1ad));const _0x28f218={'Body':Buffer[_0x1db406(0x167)](_0x1f087c)[_0x1db406(0x163)]('base64'),'ContentType':'text/plain','ParentId':this[_0x1db406(0x14a)],'Name':_0x406b42};await this[_0x1db406(0x15c)][_0x1db406(0x17d)](flosum_constants_1[_0x1db406(0x165)][_0x1db406(0x16d)]+_0x1db406(0x1b6),_0x28f218);}async[a361_0x57b61c(0x1ae)](){const _0x2d12bc=a361_0x57b61c;this['_logger'][_0x2d12bc(0x156)](_0x2d12bc(0x16b));const [_0x5a3d0a]=await this[_0x2d12bc(0x151)][_0x2d12bc(0x18d)](_0x2d12bc(0x17a)+constants_1[_0x2d12bc(0x182)]+_0x2d12bc(0x15b)+constants_1[_0x2d12bc(0x182)]+_0x2d12bc(0x1bc)+constants_1['FLOSUM_NAMESPACE']+_0x2d12bc(0x1b8)+constants_1['FLOSUM_NAMESPACE']+_0x2d12bc(0x172)+this[_0x2d12bc(0x14a)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x2d12bc(0x19e))](_0x5a3d0a);}async[a361_0x57b61c(0x1a5)](){const _0x532de7=a361_0x57b61c;this['_logger'][_0x532de7(0x156)](_0x532de7(0x158));const _0x2009eb=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x532de7(0x151)],'value':this[_0x532de7(0x179)]})[_0x532de7(0x152)]();if(!_0x2009eb[_0x532de7(0x1b4)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x2009eb;}async[a361_0x57b61c(0x198)](){const _0x43b12b=a361_0x57b61c;this[_0x43b12b(0x14b)][_0x43b12b(0x156)](_0x43b12b(0x14d));const _0x459d6c=await this[_0x43b12b(0x151)]['retrieveRecords'](_0x43b12b(0x1b2)+this['_parentMetadataLogId']+_0x43b12b(0x15e)+flosum_constants_1[_0x43b12b(0x165)][_0x43b12b(0x1c4)]+_0x43b12b(0x17f)),_0x4a0673=await(0x0,fetch_attachments_1[_0x43b12b(0x1a0)])(this[_0x43b12b(0x15c)],[_0x459d6c[0x0]['Id']]),_0x4d0a13=await(0x0,fetch_attachments_1[_0x43b12b(0x18c)])(_0x4a0673,this[_0x43b12b(0x15c)]);if(!_0x4d0a13[_0x43b12b(0x1b4)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x4d0a13[0x0][_0x43b12b(0x1cc)][_0x43b12b(0x1bf)];}async[a361_0x57b61c(0x177)](_0x167db2){const _0x7833e4=a361_0x57b61c;this[_0x7833e4(0x14b)][_0x7833e4(0x156)]('Create\x20zip\x20from\x20backup');const _0x30a2a5=await this[_0x7833e4(0x198)](),_0x176d7c=await new zip_creator_rollback_1[(_0x7833e4(0x191))]({'rollbackName':this[_0x7833e4(0x1ac)][_0x7833e4(0x1a6)],'backup':_0x30a2a5,'deploymentResults':_0x167db2})['create'](),_0x376dc7=this[_0x7833e4(0x197)]+'/'+(0x0,shortid_1[_0x7833e4(0x1aa)])()+_0x7833e4(0x166);return await(0x0,promises_1['writeFile'])(_0x376dc7,_0x176d7c),_0x376dc7;}async[a361_0x57b61c(0x1b0)](_0x13ab0){const _0x400b71=a361_0x57b61c;this[_0x400b71(0x14b)]['log'](_0x400b71(0x157));const _0x3f2401=await this[_0x400b71(0x149)][_0x400b71(0x16f)](_0x13ab0),_0x12d40e=this[_0x400b71(0x197)]+_0x400b71(0x1c0)+_0x13ab0[_0x400b71(0x17c)](_0x13ab0['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x400b71(0x160)])(_0x12d40e,_0x3f2401),await this[_0x400b71(0x149)][_0x400b71(0x173)](_0x12d40e),_0x12d40e;}[a361_0x57b61c(0x18b)](_0x34d05f){const _0x4adb4c=a361_0x57b61c;return this[_0x4adb4c(0x14b)][_0x4adb4c(0x156)](_0x4adb4c(0x16e)),_0x34d05f[_0x4adb4c(0x1ab)](_0x3ae6c1=>{const _0x30a368=_0x4adb4c;return this[_0x30a368(0x14b)][_0x30a368(0x156)](_0x3ae6c1[_0x30a368(0x199)]+'.'+_0x3ae6c1[_0x30a368(0x1a6)]+_0x30a368(0x18f)+_0x3ae6c1[_0x30a368(0x1a8)]),{[constants_1['FLOSUM_NAMESPACE']+_0x30a368(0x1c2)]:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+_0x30a368(0x14e)]:_0x3ae6c1[_0x30a368(0x1a8)]===status_enums_1['PackageComponentStatus'][_0x30a368(0x1cf)]?_0x30a368(0x1a3):_0x30a368(0x1a1),[constants_1[_0x30a368(0x182)]+'Result__c']:_0x3ae6c1[_0x30a368(0x1c9)],[constants_1[_0x30a368(0x182)]+_0x30a368(0x181)]:_0x3ae6c1[_0x30a368(0x1a6)],[constants_1[_0x30a368(0x182)]+_0x30a368(0x142)]:_0x3ae6c1['type'],[constants_1[_0x30a368(0x182)]+_0x30a368(0x150)]:_0x3ae6c1['stepName'],[constants_1[_0x30a368(0x182)]+_0x30a368(0x15f)]:this[_0x30a368(0x1ac)][_0x30a368(0x168)],[constants_1['FLOSUM_NAMESPACE']+_0x30a368(0x1a4)]:this['_metadataLogId']};});}async[a361_0x57b61c(0x19b)](_0x18700f){const _0x2f78dd=a361_0x57b61c;this['_logger'][_0x2f78dd(0x156)]('Save\x20Deployment\x20Results');const _0x2efcfb=await this[_0x2f78dd(0x151)][_0x2f78dd(0x195)](constants_1[_0x2f78dd(0x182)]+_0x2f78dd(0x1b1),_0x18700f),_0x5b7716=_0x2efcfb['filter'](_0x472b2a=>!_0x472b2a[_0x2f78dd(0x16c)])[_0x2f78dd(0x1ab)](_0xbcb73c=>_0xbcb73c['errors'])['flat']();if(_0x5b7716[_0x2f78dd(0x1b4)])throw new salesforce_dml_error_1[(_0x2f78dd(0x175))](_0x5b7716);}async[a361_0x57b61c(0x1c3)](_0xf3b893){const _0x368006=a361_0x57b61c;if(!this[_0x368006(0x1ac)]){this[_0x368006(0x183)][_0x368006(0x178)](_0xf3b893);return;}this[_0x368006(0x14b)]['logError'](_0xf3b893),await this[_0x368006(0x14b)][_0x368006(0x154)](),await this[_0x368006(0x1ce)](![],!![],'');}async[a361_0x57b61c(0x1ce)](_0xf3d816,_0x1d704f,_0x4a99db){const _0x31ca7d=a361_0x57b61c,{id:_0x25821c,organizationId:_0x116b35,branchId:_0x5cdd00,organizationName:_0x2f88c6}=this['_metadataLog'],_0x15f390=_0x31ca7d(0x17b)+this[_0x31ca7d(0x1a9)]+'/'+_0x25821c+'\x20>\x20'+'Veeva\x20Rollback\x20(Deployment)'+_0x31ca7d(0x19f),_0x101d11='<a\x20href='+this['_instanceUrl']+'/'+_0x116b35+'\x20>'+_0x2f88c6+_0x31ca7d(0x14c),_0x44cd9b=_0x15f390+'\x20of\x20branch\x20to\x20Organization\x20'+_0x101d11+'\x20has\x20been\x20created.',_0x142124={[constants_1[_0x31ca7d(0x182)]+'Action__c']:_0x44cd9b,[constants_1[_0x31ca7d(0x182)]+_0x31ca7d(0x1c6)]:new Date(),[constants_1[_0x31ca7d(0x182)]+_0x31ca7d(0x144)]:_0x5cdd00,[constants_1[_0x31ca7d(0x182)]+_0x31ca7d(0x143)]:'Branch',[constants_1[_0x31ca7d(0x182)]+'Activity_Type__c']:'Deployment',[constants_1[_0x31ca7d(0x182)]+_0x31ca7d(0x18e)]:_0x116b35},_0x585401={[constants_1[_0x31ca7d(0x182)]+_0x31ca7d(0x162)]:!_0xf3d816,[constants_1[_0x31ca7d(0x182)]+'Succeed__c']:_0xf3d816,[constants_1[_0x31ca7d(0x182)]+_0x31ca7d(0x14e)]:_0x1d704f?status_enums_1[_0x31ca7d(0x155)][_0x31ca7d(0x180)]:status_enums_1[_0x31ca7d(0x155)][_0x31ca7d(0x15d)],[constants_1[_0x31ca7d(0x182)]+_0x31ca7d(0x18a)]:!![],[constants_1[_0x31ca7d(0x182)]+_0x31ca7d(0x1b9)]:_0x4a99db};await this['_connectionSalesforce']['patch'](flosum_constants_1['FlosumConstants'][_0x31ca7d(0x16d)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x31ca7d(0x147)+this[_0x31ca7d(0x14a)],_0x585401),await this[_0x31ca7d(0x15c)][_0x31ca7d(0x17d)](flosum_constants_1['FlosumConstants'][_0x31ca7d(0x16d)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x31ca7d(0x148),_0x142124),this[_0x31ca7d(0x14b)][_0x31ca7d(0x156)]('Rollback\x20completed\x20'+(_0xf3d816?_0x31ca7d(0x153):_0x31ca7d(0x1af))+'.'),await this[_0x31ca7d(0x14b)][_0x31ca7d(0x154)]();}async[a361_0x57b61c(0x17e)](){const _0x1c95c5=a361_0x57b61c;try{this[_0x1c95c5(0x1ac)]=await this[_0x1c95c5(0x1ae)]();const _0xa7d243=await this[_0x1c95c5(0x1a5)]();await this[_0x1c95c5(0x14b)][_0x1c95c5(0x154)]();const _0x4a8670=await this[_0x1c95c5(0x177)](_0xa7d243),_0x209e71=await this[_0x1c95c5(0x1b0)](_0x4a8670);await this['_logger'][_0x1c95c5(0x154)]();const _0x4ea838=await this[_0x1c95c5(0x1d0)]['import'](_0x209e71);await this[_0x1c95c5(0x14b)][_0x1c95c5(0x154)]();const _0x5ec1d4=this['formFlosumDeploymentResults'](_0x4ea838[_0x1c95c5(0x19c)]);await this['saveDeploymentResults'](_0x5ec1d4),await this[_0x1c95c5(0x1ce)](_0x4ea838[_0x1c95c5(0x190)],![],_0x4ea838[_0x1c95c5(0x1ca)]);}catch(_0x3aff38){await this[_0x1c95c5(0x1c3)](_0x3aff38)[_0x1c95c5(0x189)](_0xe6cff3=>this[_0x1c95c5(0x183)]['error'](_0xe6cff3));}}}exports[a361_0x57b61c(0x170)]=RollbackService;