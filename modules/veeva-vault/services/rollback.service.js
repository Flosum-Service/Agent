const a356_0x19c31b=a356_0xf017;(function(_0x1d1a5f,_0x55e353){const _0x1cb156=a356_0xf017,_0x14147c=_0x1d1a5f();while(!![]){try{const _0x1576b2=parseInt(_0x1cb156(0x148))/0x1+parseInt(_0x1cb156(0x16c))/0x2*(parseInt(_0x1cb156(0x15b))/0x3)+parseInt(_0x1cb156(0x101))/0x4*(parseInt(_0x1cb156(0x166))/0x5)+parseInt(_0x1cb156(0x103))/0x6*(-parseInt(_0x1cb156(0x163))/0x7)+-parseInt(_0x1cb156(0x147))/0x8*(parseInt(_0x1cb156(0x10f))/0x9)+-parseInt(_0x1cb156(0x133))/0xa+parseInt(_0x1cb156(0x15e))/0xb*(parseInt(_0x1cb156(0x11b))/0xc);if(_0x1576b2===_0x55e353)break;else _0x14147c['push'](_0x14147c['shift']());}catch(_0x4cfea4){_0x14147c['push'](_0x14147c['shift']());}}}(a356_0x4b5a,0x9f725));const a356_0x4fc5fa=(function(){let _0x485221=!![];return function(_0xc10000,_0x34726a){const _0x27c8f2=_0x485221?function(){const _0x15bac0=a356_0xf017;if(_0x34726a){const _0xa8ff0=_0x34726a[_0x15bac0(0x140)](_0xc10000,arguments);return _0x34726a=null,_0xa8ff0;}}:function(){};return _0x485221=![],_0x27c8f2;};}()),a356_0x142c5e=a356_0x4fc5fa(this,function(){const _0x46e35=a356_0xf017;return a356_0x142c5e[_0x46e35(0x144)]()['search']('(((.+)+)+)+$')[_0x46e35(0x144)]()[_0x46e35(0x151)](a356_0x142c5e)[_0x46e35(0x160)](_0x46e35(0xfa));});a356_0x142c5e();function a356_0x4b5a(){const _0x23088b=['writeFile','\x20</a>','flat','from','_connectionSalesforce','slice','Branch','Retrieve\x20Backup','(((.+)+)+)+$','Body','_tempFolder','retrieveAttachments','Retrieve\x20Deployment\x20Results','Org__c','formFlosumDeploymentResults','116elMYGp','catch','79674pqVKHw','retrieveRecords','lastIndexOf','stepName','updateLog','Form\x20Deployment\x20Results','_timeZone','../constants/flosum.constants','EXCEPTION','_logger','./package-import.service','retrieveMetadataLog','16101XVyhYe','_systemLogger','execute','MetadataLogStatus','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','finishRollback','/Attachment','\x27\x20AND\x20Name\x20=\x20\x27','_attachmentLogId','Job_Completed__c','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Action__c','48iVJezV','Retrieve\x20Metadata\x20Log\x20info','\x20>\x20','saveDeploymentResults','deploymentAction','Failure','Save\x20log','patch','MetadataLogDto','_packageImportService','Rollback\x20completed\x20','\x20:\x20','_metadataLogId','RollbackService','bind','../dtos/metadata-log.dto','Branch__c','FlosumConstants','../../../core','_veevaService','<a\x20href=','Status__c','_connectionVeeva','validate','11555770DYsgav','_instanceUrl','post','./veeva.service','Deployment\x20Result','generate','Veeva\x20Rollback\x20(Deployment)','error','DEPLOYED','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','PackageImportService','Activity_Item__c','length','apply','log','packageComponentList','success','toString','Activity_Type__c','Succeed__c','3992nkGfyF','1211835hZTWlm','Cannot\x20find\x20Deployment\x20Results','with\x20error','retrieveDeploymentResults','text/plain','Deployment','../enums/status.enums','Create\x20Vpk\x20package','logError','constructor','\x20has\x20been\x20created.','Result__c','fs/promises','_metadataLog','PackageComponentStatus','SalesforceService','Is_Error__c','type','packageId','260655MEYmsl','\x27\x0a\x20\x20\x20\x20','shortid','2008787awWMCh','retrieve','search','Create\x20zip\x20from\x20backup','Save\x20Deployment\x20Results','133OKdSqt','FLOSUM_NAMESPACE','Date__c','114455FKIXHM','SalesforceDmlError','_vpkService','Logger','_parentMetadataLogId','insertMultipleRecords','8FTXAAK','Success','veeva-rollback','Deployment_Result__c','createZip','default','Metadata_Log__c/','errors','../classes/errors/salesforce-dml-error','../classes/rollback/zip-creator.rollback','../classes/retrievers/deployment-results/id.deployment-result.retriever','.zip','defineProperty','createVpk','finishRollbackWithError','import','ZipCreatorRollback','ENDPOINT_UPSERT_RECORD','Veeva_Step_Name__c','./vpk.service','_salesforceService','../../../constants','create','__esModule','IdDeploymentResultRetriever','Component_Name__c','map','./salesforce.service','name','Metadata_Log__c','status'];a356_0x4b5a=function(){return _0x23088b;};return a356_0x4b5a();}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x7d42e1){const _0x465436=a356_0xf017;return _0x7d42e1&&_0x7d42e1[_0x465436(0x183)]?_0x7d42e1:{'default':_0x7d42e1};};Object[a356_0x19c31b(0x178)](exports,a356_0x19c31b(0x183),{'value':!![]}),exports[a356_0x19c31b(0x128)]=void 0x0;const veeva_service_1=require(a356_0x19c31b(0x136)),salesforce_service_1=require(a356_0x19c31b(0xee)),package_import_service_1=require(a356_0x19c31b(0x10d)),id_deployment_result_retriever_1=require(a356_0x19c31b(0x176)),flosum_constants_1=require(a356_0x19c31b(0x10a)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a356_0x19c31b(0x181)),zip_creator_rollback_1=require(a356_0x19c31b(0x175)),shortid_1=__importDefault(require(a356_0x19c31b(0x15d))),promises_1=require(a356_0x19c31b(0x154)),vpk_service_1=require(a356_0x19c31b(0x17f)),status_enums_1=require(a356_0x19c31b(0x14e)),salesforce_dml_error_1=require(a356_0x19c31b(0x174)),metadata_log_dto_1=require(a356_0x19c31b(0x12a)),core_1=require(a356_0x19c31b(0x12d));function a356_0xf017(_0x24bc54,_0x130af8){const _0x1ae1f3=a356_0x4b5a();return a356_0xf017=function(_0x142c5e,_0x4fc5fa){_0x142c5e=_0x142c5e-0xee;let _0x4b5a92=_0x1ae1f3[_0x142c5e];return _0x4b5a92;},a356_0xf017(_0x24bc54,_0x130af8);}class RollbackService{constructor({connectionSalesforce:_0x2e49a8,connectionVeeva:_0x542a24,logger:_0x729b2a,tempFolder:_0xfce35b,instanceUrl:_0x1e1d8e,timeZone:_0x1b4e32,metadataLogId:_0x45381a,attachmentLogId:_0x2ab3bc,parentMetadataLogId:_0x50be27,componentIds:_0x350ec3}){const _0x480ee4=a356_0x19c31b;this[_0x480ee4(0xf6)]=_0x2e49a8,this[_0x480ee4(0x131)]=_0x542a24,this[_0x480ee4(0x10c)]=_0x729b2a,this[_0x480ee4(0xfc)]=_0xfce35b,this['_instanceUrl']=_0x1e1d8e,this[_0x480ee4(0x109)]=_0x1b4e32,this[_0x480ee4(0x127)]=_0x45381a,this[_0x480ee4(0x117)]=_0x2ab3bc,this[_0x480ee4(0x16a)]=_0x50be27,this['_componentIds']=_0x350ec3,this[_0x480ee4(0x110)]=new core_1[(_0x480ee4(0x169))](_0x480ee4(0x16e)),this[_0x480ee4(0x12e)]=new veeva_service_1['VeevaService']({'connection':_0x542a24,'logger':_0x729b2a}),this[_0x480ee4(0x180)]=new salesforce_service_1[(_0x480ee4(0x157))]({'connection':_0x2e49a8}),this[_0x480ee4(0x124)]=new package_import_service_1[(_0x480ee4(0x13d))]({'veevaService':this[_0x480ee4(0x12e)],'connection':_0x542a24,'logger':_0x729b2a,'saveLog':this['saveLog'][_0x480ee4(0x129)](this)}),this[_0x480ee4(0x168)]=new vpk_service_1['VpkService']({'connection':_0x542a24});}async['saveLog'](_0x208cdd,_0x30ed4e){const _0x174447=a356_0x19c31b;this[_0x174447(0x10c)][_0x174447(0x141)](_0x174447(0x121));const _0x5242f9={'Body':Buffer[_0x174447(0xf5)](_0x208cdd)[_0x174447(0x144)]('base64'),'ContentType':_0x174447(0x14c),'ParentId':this['_metadataLogId'],'Name':_0x30ed4e};await this[_0x174447(0xf6)][_0x174447(0x135)](flosum_constants_1[_0x174447(0x12c)][_0x174447(0x17d)]+_0x174447(0x115),_0x5242f9);}async[a356_0x19c31b(0x10e)](){const _0x4c4c83=a356_0x19c31b;this['_logger'][_0x4c4c83(0x141)](_0x4c4c83(0x11c));const [_0x5505df]=await this[_0x4c4c83(0x180)][_0x4c4c83(0x104)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x4c4c83(0x164)]+_0x4c4c83(0x119)+constants_1[_0x4c4c83(0x164)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x4c4c83(0x164)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x4c4c83(0x164)]+_0x4c4c83(0x13c)+this[_0x4c4c83(0x127)]+_0x4c4c83(0x15c));return new metadata_log_dto_1[(_0x4c4c83(0x123))](_0x5505df);}async[a356_0x19c31b(0x14b)](){const _0xe103d8=a356_0x19c31b;this[_0xe103d8(0x10c)][_0xe103d8(0x141)](_0xe103d8(0xfe));const _0x48d79d=await new id_deployment_result_retriever_1[(_0xe103d8(0x184))]({'salesforceService':this[_0xe103d8(0x180)],'value':this['_componentIds']})[_0xe103d8(0x15f)]();if(!_0x48d79d['length'])throw new Error(_0xe103d8(0x149));return _0x48d79d;}async['retrieveBackup'](){const _0x8f3c36=a356_0x19c31b;this[_0x8f3c36(0x10c)][_0x8f3c36(0x141)](_0x8f3c36(0xf9));const _0x2b2689=await this[_0x8f3c36(0x180)]['retrieveRecords'](_0x8f3c36(0x113)+this['_parentMetadataLogId']+_0x8f3c36(0x116)+flosum_constants_1['FlosumConstants']['BACKUP_ZIP_NAME']+_0x8f3c36(0x15c)),_0x366d30=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x8f3c36(0xf6)],[_0x2b2689[0x0]['Id']]),_0x552768=await(0x0,fetch_attachments_1[_0x8f3c36(0xfd)])(_0x366d30,this[_0x8f3c36(0xf6)]);if(!_0x552768['length'])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x552768[0x0]['values'][_0x8f3c36(0xfb)];}async[a356_0x19c31b(0x170)](_0xef2169){const _0x367024=a356_0x19c31b;this[_0x367024(0x10c)][_0x367024(0x141)](_0x367024(0x161));const _0x4878a7=await this['retrieveBackup'](),_0x34755b=await new zip_creator_rollback_1[(_0x367024(0x17c))]({'rollbackName':this[_0x367024(0x155)][_0x367024(0xef)],'backup':_0x4878a7,'deploymentResults':_0xef2169})[_0x367024(0x182)](),_0x3b9ddb=this[_0x367024(0xfc)]+'/'+(0x0,shortid_1[_0x367024(0x171)])()+_0x367024(0x177);return await(0x0,promises_1['writeFile'])(_0x3b9ddb,_0x34755b),_0x3b9ddb;}async[a356_0x19c31b(0x179)](_0xc7e5eb){const _0x4a3388=a356_0x19c31b;this[_0x4a3388(0x10c)][_0x4a3388(0x141)](_0x4a3388(0x14f));const _0x4626dd=await this[_0x4a3388(0x168)][_0x4a3388(0x138)](_0xc7e5eb),_0x487bcb=this[_0x4a3388(0xfc)]+'/vpk__'+_0xc7e5eb[_0x4a3388(0xf7)](_0xc7e5eb[_0x4a3388(0x105)]('/')+0x1);return await(0x0,promises_1[_0x4a3388(0xf2)])(_0x487bcb,_0x4626dd),await this['_vpkService'][_0x4a3388(0x132)](_0x487bcb),_0x487bcb;}['formFlosumDeploymentResults'](_0x3afeb0){const _0x1a4515=a356_0x19c31b;return this[_0x1a4515(0x10c)][_0x1a4515(0x141)](_0x1a4515(0x108)),_0x3afeb0[_0x1a4515(0x186)](_0x262abd=>{const _0xea3f91=_0x1a4515;return this[_0xea3f91(0x10c)][_0xea3f91(0x141)](_0x262abd['type']+'.'+_0x262abd['name']+_0xea3f91(0x126)+_0x262abd['status']),{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:_0xea3f91(0x137),[constants_1['FLOSUM_NAMESPACE']+_0xea3f91(0x130)]:_0x262abd[_0xea3f91(0xf1)]===status_enums_1[_0xea3f91(0x156)][_0xea3f91(0x13b)]?_0xea3f91(0x16d):_0xea3f91(0x120),[constants_1[_0xea3f91(0x164)]+_0xea3f91(0x153)]:_0x262abd[_0xea3f91(0x11f)],[constants_1[_0xea3f91(0x164)]+_0xea3f91(0x185)]:_0x262abd[_0xea3f91(0xef)],[constants_1[_0xea3f91(0x164)]+'Component_Type__c']:_0x262abd[_0xea3f91(0x159)],[constants_1[_0xea3f91(0x164)]+_0xea3f91(0x17e)]:_0x262abd[_0xea3f91(0x106)],[constants_1[_0xea3f91(0x164)]+_0xea3f91(0xff)]:this[_0xea3f91(0x155)]['organizationId'],[constants_1[_0xea3f91(0x164)]+_0xea3f91(0xf0)]:this[_0xea3f91(0x127)]};});}async[a356_0x19c31b(0x11e)](_0x4170e4){const _0x38364a=a356_0x19c31b;this[_0x38364a(0x10c)][_0x38364a(0x141)](_0x38364a(0x162));const _0x4c8885=await this[_0x38364a(0x180)][_0x38364a(0x16b)](constants_1[_0x38364a(0x164)]+_0x38364a(0x16f),_0x4170e4),_0x39d22c=_0x4c8885['filter'](_0x15d8fd=>!_0x15d8fd[_0x38364a(0x143)])[_0x38364a(0x186)](_0x221f17=>_0x221f17[_0x38364a(0x173)])[_0x38364a(0xf4)]();if(_0x39d22c[_0x38364a(0x13f)])throw new salesforce_dml_error_1[(_0x38364a(0x167))](_0x39d22c);}async[a356_0x19c31b(0x17a)](_0x3d98df){const _0x37d2e2=a356_0x19c31b;if(!this['_metadataLog']){this['_systemLogger'][_0x37d2e2(0x13a)](_0x3d98df);return;}this[_0x37d2e2(0x10c)][_0x37d2e2(0x150)](_0x3d98df),await this['_logger']['updateLog'](),await this[_0x37d2e2(0x114)](![],!![],'');}async['finishRollback'](_0x19f705,_0x268fa4,_0x2d101b){const _0x488375=a356_0x19c31b,{id:_0x420e4a,organizationId:_0x3b6b47,branchId:_0x21c9c3,organizationName:_0x48b197}=this['_metadataLog'],_0x269dfd='<a\x20href='+this[_0x488375(0x134)]+'/'+_0x420e4a+_0x488375(0x11d)+_0x488375(0x139)+_0x488375(0xf3),_0x403f2d=_0x488375(0x12f)+this[_0x488375(0x134)]+'/'+_0x3b6b47+'\x20>'+_0x48b197+'</a>',_0x1aee20=_0x269dfd+'\x20of\x20branch\x20to\x20Organization\x20'+_0x403f2d+_0x488375(0x152),_0x4132a7={[constants_1[_0x488375(0x164)]+_0x488375(0x11a)]:_0x1aee20,[constants_1['FLOSUM_NAMESPACE']+_0x488375(0x165)]:new Date(),[constants_1[_0x488375(0x164)]+_0x488375(0x12b)]:_0x21c9c3,[constants_1[_0x488375(0x164)]+_0x488375(0x13e)]:_0x488375(0xf8),[constants_1[_0x488375(0x164)]+_0x488375(0x145)]:_0x488375(0x14d),[constants_1[_0x488375(0x164)]+'TargetId__c']:_0x3b6b47},_0xfa7d98={[constants_1[_0x488375(0x164)]+_0x488375(0x158)]:!_0x19f705,[constants_1['FLOSUM_NAMESPACE']+_0x488375(0x146)]:_0x19f705,[constants_1[_0x488375(0x164)]+'Status__c']:_0x268fa4?status_enums_1[_0x488375(0x112)][_0x488375(0x10b)]:status_enums_1[_0x488375(0x112)]['COMPLETED'],[constants_1[_0x488375(0x164)]+_0x488375(0x118)]:!![],[constants_1[_0x488375(0x164)]+'Async_Request_Id__c']:_0x2d101b};await this['_connectionSalesforce'][_0x488375(0x122)](flosum_constants_1[_0x488375(0x12c)][_0x488375(0x17d)]+'/'+constants_1[_0x488375(0x164)]+_0x488375(0x172)+this[_0x488375(0x127)],_0xfa7d98),await this[_0x488375(0xf6)][_0x488375(0x135)](flosum_constants_1[_0x488375(0x12c)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x488375(0x164)]+'Log__c',_0x4132a7),this['_logger'][_0x488375(0x141)](_0x488375(0x125)+(_0x19f705?'successfully':_0x488375(0x14a))+'.'),await this[_0x488375(0x10c)]['updateLog']();}async[a356_0x19c31b(0x111)](){const _0x267e60=a356_0x19c31b;try{this[_0x267e60(0x155)]=await this[_0x267e60(0x10e)]();const _0x48d2b1=await this[_0x267e60(0x14b)]();await this[_0x267e60(0x10c)][_0x267e60(0x107)]();const _0x50e9dd=await this[_0x267e60(0x170)](_0x48d2b1),_0x30dafb=await this[_0x267e60(0x179)](_0x50e9dd);await this[_0x267e60(0x10c)][_0x267e60(0x107)]();const _0x240427=await this[_0x267e60(0x124)][_0x267e60(0x17b)](_0x30dafb);await this[_0x267e60(0x10c)]['updateLog']();const _0x20566a=this[_0x267e60(0x100)](_0x240427[_0x267e60(0x142)]);await this[_0x267e60(0x11e)](_0x20566a),await this[_0x267e60(0x114)](_0x240427['isDeployed'],![],_0x240427[_0x267e60(0x15a)]);}catch(_0x4a3b09){await this[_0x267e60(0x17a)](_0x4a3b09)[_0x267e60(0x102)](_0x137ffe=>this[_0x267e60(0x110)][_0x267e60(0x13a)](_0x137ffe));}}}exports[a356_0x19c31b(0x128)]=RollbackService;