const a337_0xaf8d5b=a337_0x2528;(function(_0x122071,_0x5e0317){const _0x420720=a337_0x2528,_0x488520=_0x122071();while(!![]){try{const _0x71769d=parseInt(_0x420720(0x1be))/0x1*(-parseInt(_0x420720(0x201))/0x2)+parseInt(_0x420720(0x1e5))/0x3+parseInt(_0x420720(0x1f1))/0x4+-parseInt(_0x420720(0x1dc))/0x5+-parseInt(_0x420720(0x1b8))/0x6*(-parseInt(_0x420720(0x1de))/0x7)+parseInt(_0x420720(0x1cf))/0x8+parseInt(_0x420720(0x1ca))/0x9*(parseInt(_0x420720(0x1d9))/0xa);if(_0x71769d===_0x5e0317)break;else _0x488520['push'](_0x488520['shift']());}catch(_0x22409d){_0x488520['push'](_0x488520['shift']());}}}(a337_0xffa5,0xce5f8));const a337_0xf572e9=(function(){let _0x4691bb=!![];return function(_0x24adab,_0x215195){const _0x4dec37=_0x4691bb?function(){const _0x54e93e=a337_0x2528;if(_0x215195){const _0x375c9c=_0x215195[_0x54e93e(0x1a7)](_0x24adab,arguments);return _0x215195=null,_0x375c9c;}}:function(){};return _0x4691bb=![],_0x4dec37;};}()),a337_0x54e44f=a337_0xf572e9(this,function(){const _0x110cf7=a337_0x2528;return a337_0x54e44f[_0x110cf7(0x197)]()['search'](_0x110cf7(0x1d5))[_0x110cf7(0x197)]()[_0x110cf7(0x1fe)](a337_0x54e44f)[_0x110cf7(0x1cd)]('(((.+)+)+)+$');});a337_0x54e44f();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x27a762){const _0x348520=a337_0x2528;return _0x27a762&&_0x27a762[_0x348520(0x210)]?_0x27a762:{'default':_0x27a762};};Object[a337_0xaf8d5b(0x1b3)](exports,a337_0xaf8d5b(0x210),{'value':!![]}),exports[a337_0xaf8d5b(0x1e2)]=void 0x0;function a337_0xffa5(){const _0x1142d4=['35lWuRmG','default','./vpk.service','flat','RollbackService','VpkService','error','3154467DakDRK','logError','Action__c','patch','_packageImportService','retrieveBackup','filter','Async_Request_Id__c','saveLog','type','length','</a>','730132VADvJa','../classes/errors/salesforce-dml-error','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_salesforceService','stepName','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_vpkService','errors','Deployment\x20Result','VeevaService','import','createZip','Form\x20Deployment\x20Results','constructor','_instanceUrl','Status__c','486566mYDGBq','.zip','<a\x20href=','post','EXCEPTION','ENDPOINT_UPSERT_RECORD','packageComponentList','_metadataLog','COMPLETED','createVpk','_metadataLogId','../dtos/metadata-log.dto','_connectionVeeva','text/plain','retrieveMetadataLog','__esModule','Veeva_Step_Name__c','Logger','catch','_parentMetadataLogId','Create\x20Vpk\x20package','Deployment_Result__c','saveDeploymentResults','\x20:\x20','updateLog','insertMultipleRecords','log','MetadataLogDto','DEPLOYED','FlosumConstants','toString','bind','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','MetadataLogStatus','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','PackageImportService','Retrieve\x20Deployment\x20Results','Success','Is_Error__c','finishRollback','Date__c','Component_Type__c','Metadata_Log__c/','writeFile','Log__c','Cannot\x20find\x20Backup\x20Zip','apply','lastIndexOf','./package-import.service','SalesforceService','\x20>\x20','FLOSUM_NAMESPACE','Save\x20Deployment\x20Results','Org__c','Deployment','SalesforceDmlError','Retrieve\x20Backup','\x27\x0a\x20\x20\x20\x20','defineProperty','finishRollbackWithError','Type__c','status','Veeva\x20Rollback\x20(Deployment)','484014VmBWiQ','ZipCreatorRollback','deploymentAction','retrieveAttachments','name','_attachmentLogId','6ecSNRl','packageId','_systemLogger','Body','shortid','Activity_Item__c','Job_Completed__c','fetchAttachmentsDetailsById','_tempFolder','slice','_veevaService','successfully','9gSxbwm','_timeZone','with\x20error','search','organizationId','7126024hcFGak','retrieveDeploymentResults','formFlosumDeploymentResults','_logger','retrieveRecords','../../../constants','(((.+)+)+)+$','../enums/status.enums','../classes/retrievers/deployment-results/id.deployment-result.retriever','_connectionSalesforce','13887790slkKxL','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Failure','8059485AhrZyt','map'];a337_0xffa5=function(){return _0x1142d4;};return a337_0xffa5();}const veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a337_0xaf8d5b(0x1a9)),id_deployment_result_retriever_1=require(a337_0xaf8d5b(0x1d7)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a337_0xaf8d5b(0x1d4)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a337_0xaf8d5b(0x1c2))),promises_1=require('fs/promises'),vpk_service_1=require(a337_0xaf8d5b(0x1e0)),status_enums_1=require(a337_0xaf8d5b(0x1d6)),salesforce_dml_error_1=require(a337_0xaf8d5b(0x1f2)),metadata_log_dto_1=require(a337_0xaf8d5b(0x20c)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x49eb95,connectionVeeva:_0x93bb48,logger:_0x312498,tempFolder:_0x5c1dc6,instanceUrl:_0x2e20c7,timeZone:_0x2b4562,metadataLogId:_0x546749,attachmentLogId:_0xc55ed2,parentMetadataLogId:_0x4ccfcd,componentIds:_0x24b0db}){const _0x10b09a=a337_0xaf8d5b;this[_0x10b09a(0x1d8)]=_0x49eb95,this[_0x10b09a(0x20d)]=_0x93bb48,this[_0x10b09a(0x1d2)]=_0x312498,this[_0x10b09a(0x1c6)]=_0x5c1dc6,this[_0x10b09a(0x1ff)]=_0x2e20c7,this[_0x10b09a(0x1cb)]=_0x2b4562,this[_0x10b09a(0x20b)]=_0x546749,this[_0x10b09a(0x1bd)]=_0xc55ed2,this[_0x10b09a(0x214)]=_0x4ccfcd,this['_componentIds']=_0x24b0db,this[_0x10b09a(0x1c0)]=new core_1[(_0x10b09a(0x212))]('veeva-rollback'),this[_0x10b09a(0x1c8)]=new veeva_service_1[(_0x10b09a(0x1fa))]({'connection':_0x93bb48,'logger':_0x312498}),this[_0x10b09a(0x1f4)]=new salesforce_service_1[(_0x10b09a(0x1aa))]({'connection':_0x49eb95}),this[_0x10b09a(0x1e9)]=new package_import_service_1[(_0x10b09a(0x19c))]({'veevaService':this[_0x10b09a(0x1c8)],'connection':_0x93bb48,'logger':_0x312498,'saveLog':this[_0x10b09a(0x1ed)][_0x10b09a(0x198)](this)}),this[_0x10b09a(0x1f7)]=new vpk_service_1[(_0x10b09a(0x1e3))]({'connection':_0x93bb48});}async['saveLog'](_0x2248b8,_0x2fa05c){const _0x2a1e38=a337_0xaf8d5b;this['_logger'][_0x2a1e38(0x193)]('Save\x20log');const _0x2b7ded={'Body':Buffer['from'](_0x2248b8)[_0x2a1e38(0x197)]('base64'),'ContentType':_0x2a1e38(0x20e),'ParentId':this[_0x2a1e38(0x20b)],'Name':_0x2fa05c};await this['_connectionSalesforce']['post'](flosum_constants_1['FlosumConstants'][_0x2a1e38(0x206)]+'/Attachment',_0x2b7ded);}async[a337_0xaf8d5b(0x20f)](){const _0x498850=a337_0xaf8d5b;this[_0x498850(0x1d2)]['log']('Retrieve\x20Metadata\x20Log\x20info');const [_0x57e7f6]=await this['_salesforceService'][_0x498850(0x1d3)](_0x498850(0x1da)+constants_1['FLOSUM_NAMESPACE']+_0x498850(0x1f6)+constants_1[_0x498850(0x1ac)]+_0x498850(0x1f3)+constants_1[_0x498850(0x1ac)]+_0x498850(0x199)+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x498850(0x20b)]+_0x498850(0x1b2));return new metadata_log_dto_1[(_0x498850(0x194))](_0x57e7f6);}async[a337_0xaf8d5b(0x1d0)](){const _0x1ffe43=a337_0xaf8d5b;this['_logger'][_0x1ffe43(0x193)](_0x1ffe43(0x19d));const _0x4660fe=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x1ffe43(0x1f4)],'value':this['_componentIds']})['retrieve']();if(!_0x4660fe[_0x1ffe43(0x1ef)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x4660fe;}async[a337_0xaf8d5b(0x1ea)](){const _0x4da23f=a337_0xaf8d5b;this['_logger'][_0x4da23f(0x193)](_0x4da23f(0x1b1));const _0x2dd340=await this[_0x4da23f(0x1f4)][_0x4da23f(0x1d3)](_0x4da23f(0x19b)+this[_0x4da23f(0x214)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0x4da23f(0x196)]['BACKUP_ZIP_NAME']+_0x4da23f(0x1b2)),_0x564a30=await(0x0,fetch_attachments_1[_0x4da23f(0x1c5)])(this[_0x4da23f(0x1d8)],[_0x2dd340[0x0]['Id']]),_0x31ba57=await(0x0,fetch_attachments_1[_0x4da23f(0x1bb)])(_0x564a30,this['_connectionSalesforce']);if(!_0x31ba57[_0x4da23f(0x1ef)])throw new Error(_0x4da23f(0x1a6));return _0x31ba57[0x0]['values'][_0x4da23f(0x1c1)];}async[a337_0xaf8d5b(0x1fc)](_0x49c9eb){const _0x1453d5=a337_0xaf8d5b;this[_0x1453d5(0x1d2)][_0x1453d5(0x193)]('Create\x20zip\x20from\x20backup');const _0xa45297=await this[_0x1453d5(0x1ea)](),_0x17713b=await new zip_creator_rollback_1[(_0x1453d5(0x1b9))]({'rollbackName':this[_0x1453d5(0x208)][_0x1453d5(0x1bc)],'backup':_0xa45297,'deploymentResults':_0x49c9eb})['create'](),_0x5bb8be=this[_0x1453d5(0x1c6)]+'/'+(0x0,shortid_1[_0x1453d5(0x1df)])()+_0x1453d5(0x202);return await(0x0,promises_1[_0x1453d5(0x1a4)])(_0x5bb8be,_0x17713b),_0x5bb8be;}async['createVpk'](_0x24aaee){const _0x464022=a337_0xaf8d5b;this['_logger'][_0x464022(0x193)](_0x464022(0x215));const _0x2ec89a=await this[_0x464022(0x1f7)]['generate'](_0x24aaee),_0x15c975=this[_0x464022(0x1c6)]+'/vpk__'+_0x24aaee[_0x464022(0x1c7)](_0x24aaee[_0x464022(0x1a8)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x15c975,_0x2ec89a),await this['_vpkService']['validate'](_0x15c975),_0x15c975;}['formFlosumDeploymentResults'](_0x3f9f11){const _0x1b30fc=a337_0xaf8d5b;return this[_0x1b30fc(0x1d2)]['log'](_0x1b30fc(0x1fd)),_0x3f9f11['map'](_0x516308=>{const _0x1432f4=_0x1b30fc;return this[_0x1432f4(0x1d2)][_0x1432f4(0x193)](_0x516308[_0x1432f4(0x1ee)]+'.'+_0x516308[_0x1432f4(0x1bc)]+_0x1432f4(0x190)+_0x516308[_0x1432f4(0x1b6)]),{[constants_1[_0x1432f4(0x1ac)]+_0x1432f4(0x1b5)]:_0x1432f4(0x1f9),[constants_1[_0x1432f4(0x1ac)]+_0x1432f4(0x200)]:_0x516308['status']===status_enums_1['PackageComponentStatus'][_0x1432f4(0x195)]?_0x1432f4(0x19e):_0x1432f4(0x1db),[constants_1[_0x1432f4(0x1ac)]+'Result__c']:_0x516308[_0x1432f4(0x1ba)],[constants_1[_0x1432f4(0x1ac)]+'Component_Name__c']:_0x516308[_0x1432f4(0x1bc)],[constants_1['FLOSUM_NAMESPACE']+_0x1432f4(0x1a2)]:_0x516308['type'],[constants_1['FLOSUM_NAMESPACE']+_0x1432f4(0x211)]:_0x516308[_0x1432f4(0x1f5)],[constants_1['FLOSUM_NAMESPACE']+_0x1432f4(0x1ae)]:this[_0x1432f4(0x208)][_0x1432f4(0x1ce)],[constants_1[_0x1432f4(0x1ac)]+'Metadata_Log__c']:this[_0x1432f4(0x20b)]};});}async['saveDeploymentResults'](_0x2eb4ac){const _0x387599=a337_0xaf8d5b;this['_logger']['log'](_0x387599(0x1ad));const _0xc8e01d=await this[_0x387599(0x1f4)][_0x387599(0x192)](constants_1[_0x387599(0x1ac)]+_0x387599(0x18e),_0x2eb4ac),_0x36f079=_0xc8e01d[_0x387599(0x1eb)](_0x370283=>!_0x370283['success'])[_0x387599(0x1dd)](_0x137ff8=>_0x137ff8[_0x387599(0x1f8)])[_0x387599(0x1e1)]();if(_0x36f079['length'])throw new salesforce_dml_error_1[(_0x387599(0x1b0))](_0x36f079);}async[a337_0xaf8d5b(0x1b4)](_0x194e51){const _0x499393=a337_0xaf8d5b;if(!this['_metadataLog']){this[_0x499393(0x1c0)][_0x499393(0x1e4)](_0x194e51);return;}this[_0x499393(0x1d2)][_0x499393(0x1e6)](_0x194e51),await this[_0x499393(0x1d2)][_0x499393(0x191)](),await this[_0x499393(0x1a0)](![],!![],'');}async[a337_0xaf8d5b(0x1a0)](_0x508358,_0x3a5da7,_0x27961c){const _0x1e1f0b=a337_0xaf8d5b,{id:_0x7bc819,organizationId:_0x221ee0,branchId:_0x5ec1af,organizationName:_0x4d11c4}=this['_metadataLog'],_0x58b3a1='<a\x20href='+this[_0x1e1f0b(0x1ff)]+'/'+_0x7bc819+_0x1e1f0b(0x1ab)+_0x1e1f0b(0x1b7)+'\x20</a>',_0x56b07d=_0x1e1f0b(0x203)+this[_0x1e1f0b(0x1ff)]+'/'+_0x221ee0+'\x20>'+_0x4d11c4+_0x1e1f0b(0x1f0),_0x5e17d8=_0x58b3a1+'\x20of\x20branch\x20to\x20Organization\x20'+_0x56b07d+'\x20has\x20been\x20created.',_0xb9df30={[constants_1[_0x1e1f0b(0x1ac)]+_0x1e1f0b(0x1e7)]:_0x5e17d8,[constants_1[_0x1e1f0b(0x1ac)]+_0x1e1f0b(0x1a1)]:new Date(),[constants_1[_0x1e1f0b(0x1ac)]+'Branch__c']:_0x5ec1af,[constants_1[_0x1e1f0b(0x1ac)]+_0x1e1f0b(0x1c3)]:'Branch',[constants_1[_0x1e1f0b(0x1ac)]+'Activity_Type__c']:_0x1e1f0b(0x1af),[constants_1[_0x1e1f0b(0x1ac)]+'TargetId__c']:_0x221ee0},_0x5042fc={[constants_1[_0x1e1f0b(0x1ac)]+_0x1e1f0b(0x19f)]:!_0x508358,[constants_1[_0x1e1f0b(0x1ac)]+'Succeed__c']:_0x508358,[constants_1[_0x1e1f0b(0x1ac)]+_0x1e1f0b(0x200)]:_0x3a5da7?status_enums_1[_0x1e1f0b(0x19a)][_0x1e1f0b(0x205)]:status_enums_1['MetadataLogStatus'][_0x1e1f0b(0x209)],[constants_1[_0x1e1f0b(0x1ac)]+_0x1e1f0b(0x1c4)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x1e1f0b(0x1ec)]:_0x27961c};await this[_0x1e1f0b(0x1d8)][_0x1e1f0b(0x1e8)](flosum_constants_1[_0x1e1f0b(0x196)][_0x1e1f0b(0x206)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x1e1f0b(0x1a3)+this[_0x1e1f0b(0x20b)],_0x5042fc),await this[_0x1e1f0b(0x1d8)][_0x1e1f0b(0x204)](flosum_constants_1[_0x1e1f0b(0x196)][_0x1e1f0b(0x206)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x1e1f0b(0x1a5),_0xb9df30),this['_logger'][_0x1e1f0b(0x193)]('Rollback\x20completed\x20'+(_0x508358?_0x1e1f0b(0x1c9):_0x1e1f0b(0x1cc))+'.'),await this[_0x1e1f0b(0x1d2)][_0x1e1f0b(0x191)]();}async['execute'](){const _0x21cad6=a337_0xaf8d5b;try{this[_0x21cad6(0x208)]=await this[_0x21cad6(0x20f)]();const _0x135184=await this[_0x21cad6(0x1d0)]();await this[_0x21cad6(0x1d2)][_0x21cad6(0x191)]();const _0x4fb1b8=await this[_0x21cad6(0x1fc)](_0x135184),_0x334a71=await this[_0x21cad6(0x20a)](_0x4fb1b8);await this[_0x21cad6(0x1d2)][_0x21cad6(0x191)]();const _0x1b15e6=await this[_0x21cad6(0x1e9)][_0x21cad6(0x1fb)](_0x334a71);await this[_0x21cad6(0x1d2)][_0x21cad6(0x191)]();const _0x578ef5=this[_0x21cad6(0x1d1)](_0x1b15e6[_0x21cad6(0x207)]);await this[_0x21cad6(0x18f)](_0x578ef5),await this['finishRollback'](_0x1b15e6['isDeployed'],![],_0x1b15e6[_0x21cad6(0x1bf)]);}catch(_0x7d0550){await this['finishRollbackWithError'](_0x7d0550)[_0x21cad6(0x213)](_0x2e02de=>this['_systemLogger'][_0x21cad6(0x1e4)](_0x2e02de));}}}function a337_0x2528(_0x5a9c21,_0x283443){const _0x4af6c7=a337_0xffa5();return a337_0x2528=function(_0x54e44f,_0xf572e9){_0x54e44f=_0x54e44f-0x18e;let _0xffa5fb=_0x4af6c7[_0x54e44f];return _0xffa5fb;},a337_0x2528(_0x5a9c21,_0x283443);}exports[a337_0xaf8d5b(0x1e2)]=RollbackService;