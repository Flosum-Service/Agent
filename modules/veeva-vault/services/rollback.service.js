const a361_0x3b9b45=a361_0x2edc;function a361_0x4c94(){const _0x38a6c5=['Retrieve\x20Backup','finishRollback','.zip','default','execute','Metadata_Log__c','status','_metadataLogId','saveLog','IdDeploymentResultRetriever','VpkService','error','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Retrieve\x20Metadata\x20Log\x20info','_connectionVeeva','643098hYluvc','_attachmentLogId','SalesforceDmlError','</a>','Deployment_Result__c','Status__c','finishRollbackWithError','fs/promises','_salesforceService','Veeva\x20Rollback\x20(Deployment)','isDeployed','SalesforceService','/Attachment','Body','_systemLogger','1143aodywl','FlosumConstants','createVpk','\x27\x0a\x20\x20\x20\x20','insertMultipleRecords','Cannot\x20find\x20Deployment\x20Results','EXCEPTION','Component_Type__c','\x20</a>','saveDeploymentResults','Activity_Type__c','\x20of\x20branch\x20to\x20Organization\x20','validate','Logger','DEPLOYED','patch','retrieveMetadataLog','../../../constants','Form\x20Deployment\x20Results','Branch','\x27\x20AND\x20Name\x20=\x20\x27','bind','__importDefault','Deployment\x20Result','BACKUP_ZIP_NAME','MetadataLogStatus','Is_Error__c','search','_parentMetadataLogId','updateLog','<a\x20href=','Component_Name__c','Retrieve\x20Deployment\x20Results','stepName','Date__c','33PoyUuL','694ZLUnyr','10MrUaWF','178414wmMEPn','post','logError','Log__c','toString','Failure','Save\x20log','slice','veeva-rollback','VeevaService','retrieveRecords','Success','ENDPOINT_UPSERT_RECORD','Succeed__c','PackageImportService','formFlosumDeploymentResults','length','defineProperty','Job_Completed__c','(((.+)+)+)+$','RollbackService','map','apply','flat','success','catch','__esModule','_timeZone','748622pvRwpt','_instanceUrl','writeFile','_packageImportService','Branch__c','values','../classes/retrievers/deployment-results/id.deployment-result.retriever','_metadataLog','Rollback\x20completed\x20','_logger','constructor','Result__c','MetadataLogDto','Create\x20Vpk\x20package','Save\x20Deployment\x20Results','packageComponentList','1895316ydYfZj','../classes/errors/salesforce-dml-error','./vpk.service','ZipCreatorRollback','./salesforce.service','retrieveBackup','type','packageId','\x20:\x20','FLOSUM_NAMESPACE','text/plain','Async_Request_Id__c','shortid','filter','with\x20error','_veevaService','name','errors','Activity_Item__c','retrieveAttachments','log','../enums/status.enums','63100gEwjgR','lastIndexOf','_vpkService','Type__c','8RfzloE','./package-import.service','import','324wkZoHw','base64','createZip','../../../core','retrieveDeploymentResults','213800GrigiL','_tempFolder','Veeva_Step_Name__c','./veeva.service','_connectionSalesforce','successfully','Metadata_Log__c/','Org__c'];a361_0x4c94=function(){return _0x38a6c5;};return a361_0x4c94();}(function(_0x146953,_0x28a9d2){const _0x71f8b=a361_0x2edc,_0x2740b5=_0x146953();while(!![]){try{const _0x2466b0=parseInt(_0x71f8b(0x1c6))/0x1+-parseInt(_0x71f8b(0x1c4))/0x2*(-parseInt(_0x71f8b(0x23a))/0x3)+-parseInt(_0x71f8b(0x214))/0x4+-parseInt(_0x71f8b(0x1c5))/0x5*(-parseInt(_0x71f8b(0x22b))/0x6)+-parseInt(_0x71f8b(0x1e2))/0x7*(parseInt(_0x71f8b(0x20c))/0x8)+-parseInt(_0x71f8b(0x20f))/0x9*(-parseInt(_0x71f8b(0x208))/0xa)+parseInt(_0x71f8b(0x1c3))/0xb*(-parseInt(_0x71f8b(0x1f2))/0xc);if(_0x2466b0===_0x28a9d2)break;else _0x2740b5['push'](_0x2740b5['shift']());}catch(_0x198a85){_0x2740b5['push'](_0x2740b5['shift']());}}}(a361_0x4c94,0x1cca2));const a361_0x2b0b06=(function(){let _0x181828=!![];return function(_0x1630a0,_0x5757ca){const _0x347f17=_0x181828?function(){const _0x18ad20=a361_0x2edc;if(_0x5757ca){const _0x171a71=_0x5757ca[_0x18ad20(0x1dc)](_0x1630a0,arguments);return _0x5757ca=null,_0x171a71;}}:function(){};return _0x181828=![],_0x347f17;};}()),a361_0x171fd5=a361_0x2b0b06(this,function(){const _0x3c79fb=a361_0x2edc;return a361_0x171fd5[_0x3c79fb(0x1ca)]()[_0x3c79fb(0x1bb)](_0x3c79fb(0x1d9))[_0x3c79fb(0x1ca)]()[_0x3c79fb(0x1ec)](a361_0x171fd5)[_0x3c79fb(0x1bb)](_0x3c79fb(0x1d9));});a361_0x171fd5();'use strict';function a361_0x2edc(_0x3c57fc,_0x3cf3e5){const _0x25484c=a361_0x4c94();return a361_0x2edc=function(_0x171fd5,_0x2b0b06){_0x171fd5=_0x171fd5-0x1b1;let _0x4c94a1=_0x25484c[_0x171fd5];return _0x4c94a1;},a361_0x2edc(_0x3c57fc,_0x3cf3e5);}var __importDefault=this&&this[a361_0x3b9b45(0x1b6)]||function(_0x8e3f54){const _0x50c36b=a361_0x3b9b45;return _0x8e3f54&&_0x8e3f54[_0x50c36b(0x1e0)]?_0x8e3f54:{'default':_0x8e3f54};};Object[a361_0x3b9b45(0x1d7)](exports,a361_0x3b9b45(0x1e0),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a361_0x3b9b45(0x217)),salesforce_service_1=require(a361_0x3b9b45(0x1f6)),package_import_service_1=require(a361_0x3b9b45(0x20d)),id_deployment_result_retriever_1=require(a361_0x3b9b45(0x1e8)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a361_0x3b9b45(0x1b1)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a361_0x3b9b45(0x1fe))),promises_1=require(a361_0x3b9b45(0x232)),vpk_service_1=require(a361_0x3b9b45(0x1f4)),status_enums_1=require(a361_0x3b9b45(0x207)),salesforce_dml_error_1=require(a361_0x3b9b45(0x1f3)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a361_0x3b9b45(0x212));class RollbackService{constructor({connectionSalesforce:_0x311389,connectionVeeva:_0x68e213,logger:_0x5526a6,tempFolder:_0x1fd391,instanceUrl:_0x524863,timeZone:_0x5174a5,metadataLogId:_0x16d962,attachmentLogId:_0x8c6583,parentMetadataLogId:_0x5990dc,componentIds:_0x44c32c}){const _0x25ff74=a361_0x3b9b45;this[_0x25ff74(0x218)]=_0x311389,this[_0x25ff74(0x22a)]=_0x68e213,this[_0x25ff74(0x1eb)]=_0x5526a6,this[_0x25ff74(0x215)]=_0x1fd391,this[_0x25ff74(0x1e3)]=_0x524863,this[_0x25ff74(0x1e1)]=_0x5174a5,this[_0x25ff74(0x223)]=_0x16d962,this[_0x25ff74(0x22c)]=_0x8c6583,this[_0x25ff74(0x1bc)]=_0x5990dc,this['_componentIds']=_0x44c32c,this['_systemLogger']=new core_1[(_0x25ff74(0x247))](_0x25ff74(0x1ce)),this[_0x25ff74(0x201)]=new veeva_service_1[(_0x25ff74(0x1cf))]({'connection':_0x68e213,'logger':_0x5526a6}),this['_salesforceService']=new salesforce_service_1[(_0x25ff74(0x236))]({'connection':_0x311389}),this[_0x25ff74(0x1e5)]=new package_import_service_1[(_0x25ff74(0x1d4))]({'veevaService':this[_0x25ff74(0x201)],'connection':_0x68e213,'logger':_0x5526a6,'saveLog':this[_0x25ff74(0x224)][_0x25ff74(0x1b5)](this)}),this[_0x25ff74(0x20a)]=new vpk_service_1[(_0x25ff74(0x226))]({'connection':_0x68e213});}async[a361_0x3b9b45(0x224)](_0x4cef52,_0x4c899f){const _0x34a5d3=a361_0x3b9b45;this[_0x34a5d3(0x1eb)][_0x34a5d3(0x206)](_0x34a5d3(0x1cc));const _0x3a4a35={'Body':Buffer['from'](_0x4cef52)[_0x34a5d3(0x1ca)](_0x34a5d3(0x210)),'ContentType':_0x34a5d3(0x1fc),'ParentId':this[_0x34a5d3(0x223)],'Name':_0x4c899f};await this[_0x34a5d3(0x218)][_0x34a5d3(0x1c7)](flosum_constants_1['FlosumConstants'][_0x34a5d3(0x1d2)]+_0x34a5d3(0x237),_0x3a4a35);}async['retrieveMetadataLog'](){const _0x248709=a361_0x3b9b45;this[_0x248709(0x1eb)][_0x248709(0x206)](_0x248709(0x229));const [_0x35f56c]=await this[_0x248709(0x233)][_0x248709(0x1d0)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x248709(0x1fb)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x248709(0x1fb)]+_0x248709(0x228)+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x248709(0x223)]+_0x248709(0x23d));return new metadata_log_dto_1[(_0x248709(0x1ee))](_0x35f56c);}async[a361_0x3b9b45(0x213)](){const _0x21bea0=a361_0x3b9b45;this[_0x21bea0(0x1eb)]['log'](_0x21bea0(0x1c0));const _0x85a441=await new id_deployment_result_retriever_1[(_0x21bea0(0x225))]({'salesforceService':this['_salesforceService'],'value':this['_componentIds']})['retrieve']();if(!_0x85a441[_0x21bea0(0x1d6)])throw new Error(_0x21bea0(0x23f));return _0x85a441;}async[a361_0x3b9b45(0x1f7)](){const _0x9b5a43=a361_0x3b9b45;this[_0x9b5a43(0x1eb)]['log'](_0x9b5a43(0x21c));const _0x25935d=await this['_salesforceService']['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x9b5a43(0x1bc)]+_0x9b5a43(0x1b4)+flosum_constants_1[_0x9b5a43(0x23b)][_0x9b5a43(0x1b8)]+_0x9b5a43(0x23d)),_0xbf898f=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x9b5a43(0x218)],[_0x25935d[0x0]['Id']]),_0x4db41a=await(0x0,fetch_attachments_1[_0x9b5a43(0x205)])(_0xbf898f,this[_0x9b5a43(0x218)]);if(!_0x4db41a[_0x9b5a43(0x1d6)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x4db41a[0x0][_0x9b5a43(0x1e7)][_0x9b5a43(0x238)];}async['createZip'](_0x45cf92){const _0x668945=a361_0x3b9b45;this[_0x668945(0x1eb)][_0x668945(0x206)]('Create\x20zip\x20from\x20backup');const _0x5307bd=await this['retrieveBackup'](),_0x5ee8c2=await new zip_creator_rollback_1[(_0x668945(0x1f5))]({'rollbackName':this[_0x668945(0x1e9)]['name'],'backup':_0x5307bd,'deploymentResults':_0x45cf92})['create'](),_0x53f864=this[_0x668945(0x215)]+'/'+(0x0,shortid_1[_0x668945(0x21f)])()+_0x668945(0x21e);return await(0x0,promises_1['writeFile'])(_0x53f864,_0x5ee8c2),_0x53f864;}async[a361_0x3b9b45(0x23c)](_0x57db00){const _0x3ce0a3=a361_0x3b9b45;this[_0x3ce0a3(0x1eb)][_0x3ce0a3(0x206)](_0x3ce0a3(0x1ef));const _0x25c77c=await this[_0x3ce0a3(0x20a)]['generate'](_0x57db00),_0x517c6b=this[_0x3ce0a3(0x215)]+'/vpk__'+_0x57db00[_0x3ce0a3(0x1cd)](_0x57db00[_0x3ce0a3(0x209)]('/')+0x1);return await(0x0,promises_1[_0x3ce0a3(0x1e4)])(_0x517c6b,_0x25c77c),await this[_0x3ce0a3(0x20a)][_0x3ce0a3(0x246)](_0x517c6b),_0x517c6b;}['formFlosumDeploymentResults'](_0xe2f3ab){const _0x2ee8ea=a361_0x3b9b45;return this[_0x2ee8ea(0x1eb)]['log'](_0x2ee8ea(0x1b2)),_0xe2f3ab[_0x2ee8ea(0x1db)](_0x39b0eb=>{const _0x29916f=_0x2ee8ea;return this['_logger']['log'](_0x39b0eb[_0x29916f(0x1f8)]+'.'+_0x39b0eb[_0x29916f(0x202)]+_0x29916f(0x1fa)+_0x39b0eb[_0x29916f(0x222)]),{[constants_1[_0x29916f(0x1fb)]+_0x29916f(0x20b)]:_0x29916f(0x1b7),[constants_1[_0x29916f(0x1fb)]+_0x29916f(0x230)]:_0x39b0eb[_0x29916f(0x222)]===status_enums_1['PackageComponentStatus'][_0x29916f(0x248)]?_0x29916f(0x1d1):_0x29916f(0x1cb),[constants_1[_0x29916f(0x1fb)]+_0x29916f(0x1ed)]:_0x39b0eb['deploymentAction'],[constants_1[_0x29916f(0x1fb)]+_0x29916f(0x1bf)]:_0x39b0eb['name'],[constants_1[_0x29916f(0x1fb)]+_0x29916f(0x241)]:_0x39b0eb[_0x29916f(0x1f8)],[constants_1[_0x29916f(0x1fb)]+_0x29916f(0x216)]:_0x39b0eb[_0x29916f(0x1c1)],[constants_1[_0x29916f(0x1fb)]+_0x29916f(0x21b)]:this[_0x29916f(0x1e9)]['organizationId'],[constants_1[_0x29916f(0x1fb)]+_0x29916f(0x221)]:this[_0x29916f(0x223)]};});}async[a361_0x3b9b45(0x243)](_0x5aff77){const _0x23928d=a361_0x3b9b45;this[_0x23928d(0x1eb)][_0x23928d(0x206)](_0x23928d(0x1f0));const _0x555c38=await this['_salesforceService'][_0x23928d(0x23e)](constants_1[_0x23928d(0x1fb)]+_0x23928d(0x22f),_0x5aff77),_0x3a6b1e=_0x555c38[_0x23928d(0x1ff)](_0x2bd2c4=>!_0x2bd2c4[_0x23928d(0x1de)])[_0x23928d(0x1db)](_0x592acd=>_0x592acd[_0x23928d(0x203)])[_0x23928d(0x1dd)]();if(_0x3a6b1e[_0x23928d(0x1d6)])throw new salesforce_dml_error_1[(_0x23928d(0x22d))](_0x3a6b1e);}async[a361_0x3b9b45(0x231)](_0x1d8e1b){const _0x6580c2=a361_0x3b9b45;if(!this[_0x6580c2(0x1e9)]){this[_0x6580c2(0x239)][_0x6580c2(0x227)](_0x1d8e1b);return;}this[_0x6580c2(0x1eb)][_0x6580c2(0x1c8)](_0x1d8e1b),await this['_logger'][_0x6580c2(0x1bd)](),await this[_0x6580c2(0x21d)](![],!![],'');}async[a361_0x3b9b45(0x21d)](_0x4c8de4,_0x59bbc5,_0x24c306){const _0x2142f6=a361_0x3b9b45,{id:_0x383199,organizationId:_0x5abe74,branchId:_0x340543,organizationName:_0x15f1d6}=this['_metadataLog'],_0xde5eff=_0x2142f6(0x1be)+this[_0x2142f6(0x1e3)]+'/'+_0x383199+'\x20>\x20'+_0x2142f6(0x234)+_0x2142f6(0x242),_0x4e643c=_0x2142f6(0x1be)+this[_0x2142f6(0x1e3)]+'/'+_0x5abe74+'\x20>'+_0x15f1d6+_0x2142f6(0x22e),_0x1169af=_0xde5eff+_0x2142f6(0x245)+_0x4e643c+'\x20has\x20been\x20created.',_0x211812={[constants_1[_0x2142f6(0x1fb)]+'Action__c']:_0x1169af,[constants_1['FLOSUM_NAMESPACE']+_0x2142f6(0x1c2)]:new Date(),[constants_1[_0x2142f6(0x1fb)]+_0x2142f6(0x1e6)]:_0x340543,[constants_1['FLOSUM_NAMESPACE']+_0x2142f6(0x204)]:_0x2142f6(0x1b3),[constants_1['FLOSUM_NAMESPACE']+_0x2142f6(0x244)]:'Deployment',[constants_1[_0x2142f6(0x1fb)]+'TargetId__c']:_0x5abe74},_0xa04759={[constants_1[_0x2142f6(0x1fb)]+_0x2142f6(0x1ba)]:!_0x4c8de4,[constants_1[_0x2142f6(0x1fb)]+_0x2142f6(0x1d3)]:_0x4c8de4,[constants_1['FLOSUM_NAMESPACE']+_0x2142f6(0x230)]:_0x59bbc5?status_enums_1['MetadataLogStatus'][_0x2142f6(0x240)]:status_enums_1[_0x2142f6(0x1b9)]['COMPLETED'],[constants_1[_0x2142f6(0x1fb)]+_0x2142f6(0x1d8)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x2142f6(0x1fd)]:_0x24c306};await this[_0x2142f6(0x218)][_0x2142f6(0x249)](flosum_constants_1[_0x2142f6(0x23b)][_0x2142f6(0x1d2)]+'/'+constants_1[_0x2142f6(0x1fb)]+_0x2142f6(0x21a)+this[_0x2142f6(0x223)],_0xa04759),await this[_0x2142f6(0x218)][_0x2142f6(0x1c7)](flosum_constants_1['FlosumConstants'][_0x2142f6(0x1d2)]+'/'+constants_1[_0x2142f6(0x1fb)]+_0x2142f6(0x1c9),_0x211812),this[_0x2142f6(0x1eb)][_0x2142f6(0x206)](_0x2142f6(0x1ea)+(_0x4c8de4?_0x2142f6(0x219):_0x2142f6(0x200))+'.'),await this[_0x2142f6(0x1eb)][_0x2142f6(0x1bd)]();}async[a361_0x3b9b45(0x220)](){const _0x149a07=a361_0x3b9b45;try{this[_0x149a07(0x1e9)]=await this[_0x149a07(0x24a)]();const _0x4b47d4=await this['retrieveDeploymentResults']();await this[_0x149a07(0x1eb)][_0x149a07(0x1bd)]();const _0x48d213=await this[_0x149a07(0x211)](_0x4b47d4),_0x1de7b8=await this[_0x149a07(0x23c)](_0x48d213);await this['_logger']['updateLog']();const _0x4e6f18=await this['_packageImportService'][_0x149a07(0x20e)](_0x1de7b8);await this[_0x149a07(0x1eb)]['updateLog']();const _0x34e6f2=this[_0x149a07(0x1d5)](_0x4e6f18[_0x149a07(0x1f1)]);await this[_0x149a07(0x243)](_0x34e6f2),await this[_0x149a07(0x21d)](_0x4e6f18[_0x149a07(0x235)],![],_0x4e6f18[_0x149a07(0x1f9)]);}catch(_0x3feea1){await this[_0x149a07(0x231)](_0x3feea1)[_0x149a07(0x1df)](_0x457a76=>this[_0x149a07(0x239)]['error'](_0x457a76));}}}exports[a361_0x3b9b45(0x1da)]=RollbackService;