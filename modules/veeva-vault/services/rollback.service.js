const a393_0x318622=a393_0x5d50;(function(_0x3dadf3,_0x551725){const _0x48157b=a393_0x5d50,_0x5a06d5=_0x3dadf3();while(!![]){try{const _0x233720=parseInt(_0x48157b(0x1c1))/0x1*(parseInt(_0x48157b(0x1c3))/0x2)+-parseInt(_0x48157b(0x185))/0x3+-parseInt(_0x48157b(0x1b1))/0x4+-parseInt(_0x48157b(0x1f1))/0x5*(-parseInt(_0x48157b(0x1eb))/0x6)+parseInt(_0x48157b(0x188))/0x7*(-parseInt(_0x48157b(0x1bd))/0x8)+-parseInt(_0x48157b(0x186))/0x9+parseInt(_0x48157b(0x17f))/0xa;if(_0x233720===_0x551725)break;else _0x5a06d5['push'](_0x5a06d5['shift']());}catch(_0x37dcfa){_0x5a06d5['push'](_0x5a06d5['shift']());}}}(a393_0x56d7,0x84308));const a393_0x55f1df=(function(){let _0x17789c=!![];return function(_0x145766,_0x4aad48){const _0x1c9086=_0x17789c?function(){const _0x325f50=a393_0x5d50;if(_0x4aad48){const _0x459328=_0x4aad48[_0x325f50(0x171)](_0x145766,arguments);return _0x4aad48=null,_0x459328;}}:function(){};return _0x17789c=![],_0x1c9086;};}()),a393_0x5c7aad=a393_0x55f1df(this,function(){const _0x58e557=a393_0x5d50;return a393_0x5c7aad[_0x58e557(0x1d0)]()[_0x58e557(0x1b8)](_0x58e557(0x1da))[_0x58e557(0x1d0)]()[_0x58e557(0x1be)](a393_0x5c7aad)['search']('(((.+)+)+)+$');});a393_0x5c7aad();function a393_0x56d7(){const _0x467abb=['2270290ogNiux','retrieve','Create\x20Vpk\x20package','retrieveDeploymentResults','Activity_Type__c','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','error','Retrieve\x20Metadata\x20Log\x20info','packageComponentList','Job_Completed__c','Cannot\x20find\x20Deployment\x20Results','_connectionSalesforce','finishRollbackWithError','Cannot\x20find\x20Backup\x20Zip','type','\x27\x0a\x20\x20\x20\x20','saveDeploymentResults','packageId','execute','_systemLogger','Deployment\x20Result','_parentMetadataLogId','validate','apply','.zip','retrieveMetadataLog','values','\x20of\x20branch\x20to\x20Organization\x20','../../shared/utils/fetch-attachments','stepName','deploymentAction','create','Failure','Deployment','\x27\x20AND\x20Name\x20=\x20\x27','_salesforceService','import','30315070XkEfuI','shortid','Is_Error__c','../constants/flosum.constants','</a>','Rollback\x20completed\x20','2197554nTqnHz','7722720efLjvZ','organizationId','714mMzOHK','Succeed__c','updateLog','retrieveBackup','createZip','Veeva\x20Rollback\x20(Deployment)','Type__c','../dtos/metadata-log.dto','retrieveAttachments','./package-import.service','PackageComponentStatus','_logger','Logger','./veeva.service','_tempFolder','VpkService','retrieveRecords','_attachmentLogId','post','../classes/retrievers/deployment-results/id.deployment-result.retriever','FlosumConstants','Org__c','status','COMPLETED','Save\x20Deployment\x20Results','_veevaService','fs/promises','Success','Branch__c','saveLog','successfully','Component_Name__c','ENDPOINT_UPSERT_RECORD','Status__c','generate','map','DEPLOYED','length','from','createVpk','Save\x20log','4089988HbFXIL','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Retrieve\x20Backup','finishRollback','errors','Create\x20zip\x20from\x20backup','Body','search','__esModule','Veeva_Step_Name__c','SalesforceDmlError','FLOSUM_NAMESPACE','62384FBTmDz','constructor','../enums/status.enums','<a\x20href=','1OsBvBJ','catch','20632qgzRvV','\x20has\x20been\x20created.','Log__c','log','ZipCreatorRollback','MetadataLogStatus','\x20:\x20','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Activity_Item__c','writeFile','flat','Metadata_Log__c/','IdDeploymentResultRetriever','toString','_timeZone','_instanceUrl','Form\x20Deployment\x20Results','Deployment_Result__c','_metadataLog','_connectionVeeva','\x20</a>','name','fetchAttachmentsDetailsById','(((.+)+)+)+$','formFlosumDeploymentResults','patch','../classes/rollback/zip-creator.rollback','base64','Retrieve\x20Deployment\x20Results','../../../constants','_metadataLogId','Branch','RollbackService','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','EXCEPTION','Date__c','Metadata_Log__c','\x20>\x20','TargetId__c','_packageImportService','12QbSRhI','_componentIds','insertMultipleRecords','success','/Attachment','isDeployed'];a393_0x56d7=function(){return _0x467abb;};return a393_0x56d7();}function a393_0x5d50(_0x2c54f5,_0x3ba8f3){const _0x522507=a393_0x56d7();return a393_0x5d50=function(_0x5c7aad,_0x55f1df){_0x5c7aad=_0x5c7aad-0x164;let _0x56d710=_0x522507[_0x5c7aad];return _0x56d710;},a393_0x5d50(_0x2c54f5,_0x3ba8f3);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x386089){const _0x55fac2=a393_0x5d50;return _0x386089&&_0x386089[_0x55fac2(0x1b9)]?_0x386089:{'default':_0x386089};};Object['defineProperty'](exports,a393_0x318622(0x1b9),{'value':!![]}),exports[a393_0x318622(0x1e3)]=void 0x0;const veeva_service_1=require(a393_0x318622(0x195)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a393_0x318622(0x191)),id_deployment_result_retriever_1=require(a393_0x318622(0x19b)),flosum_constants_1=require(a393_0x318622(0x182)),fetch_attachments_1=require(a393_0x318622(0x176)),constants_1=require(a393_0x318622(0x1e0)),zip_creator_rollback_1=require(a393_0x318622(0x1dd)),shortid_1=__importDefault(require(a393_0x318622(0x180))),promises_1=require(a393_0x318622(0x1a2)),vpk_service_1=require('./vpk.service'),status_enums_1=require(a393_0x318622(0x1bf)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a393_0x318622(0x18f)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x3183a3,connectionVeeva:_0xf8c784,logger:_0x2edebe,tempFolder:_0x4770d1,instanceUrl:_0x44139f,timeZone:_0x464665,metadataLogId:_0x4ff8ca,attachmentLogId:_0x1c7b25,parentMetadataLogId:_0x38293c,componentIds:_0x1e45c3}){const _0x1305b5=a393_0x318622;this[_0x1305b5(0x165)]=_0x3183a3,this[_0x1305b5(0x1d6)]=_0xf8c784,this['_logger']=_0x2edebe,this['_tempFolder']=_0x4770d1,this[_0x1305b5(0x1d2)]=_0x44139f,this[_0x1305b5(0x1d1)]=_0x464665,this[_0x1305b5(0x1e1)]=_0x4ff8ca,this[_0x1305b5(0x199)]=_0x1c7b25,this[_0x1305b5(0x16f)]=_0x38293c,this[_0x1305b5(0x1ec)]=_0x1e45c3,this[_0x1305b5(0x16d)]=new core_1[(_0x1305b5(0x194))]('veeva-rollback'),this[_0x1305b5(0x1a1)]=new veeva_service_1['VeevaService']({'connection':_0xf8c784,'logger':_0x2edebe}),this[_0x1305b5(0x17d)]=new salesforce_service_1['SalesforceService']({'connection':_0x3183a3}),this[_0x1305b5(0x1ea)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x1305b5(0x1a1)],'connection':_0xf8c784,'logger':_0x2edebe,'saveLog':this[_0x1305b5(0x1a5)]['bind'](this)}),this['_vpkService']=new vpk_service_1[(_0x1305b5(0x197))]({'connection':_0xf8c784});}async[a393_0x318622(0x1a5)](_0x375e6f,_0x5c5650){const _0x5555a2=a393_0x318622;this[_0x5555a2(0x193)][_0x5555a2(0x1c6)](_0x5555a2(0x1b0));const _0x241243={'Body':Buffer[_0x5555a2(0x1ae)](_0x375e6f)['toString'](_0x5555a2(0x1de)),'ContentType':'text/plain','ParentId':this[_0x5555a2(0x1e1)],'Name':_0x5c5650};await this[_0x5555a2(0x165)][_0x5555a2(0x19a)](flosum_constants_1['FlosumConstants'][_0x5555a2(0x1a8)]+_0x5555a2(0x1ef),_0x241243);}async[a393_0x318622(0x173)](){const _0x49bc52=a393_0x318622;this[_0x49bc52(0x193)][_0x49bc52(0x1c6)](_0x49bc52(0x1f8));const [_0x569220]=await this[_0x49bc52(0x17d)][_0x49bc52(0x198)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x49bc52(0x1f6)+constants_1['FLOSUM_NAMESPACE']+_0x49bc52(0x1ca)+constants_1[_0x49bc52(0x1bc)]+_0x49bc52(0x1e4)+constants_1[_0x49bc52(0x1bc)]+_0x49bc52(0x1b2)+this[_0x49bc52(0x1e1)]+_0x49bc52(0x169));return new metadata_log_dto_1['MetadataLogDto'](_0x569220);}async[a393_0x318622(0x1f4)](){const _0x272e99=a393_0x318622;this['_logger']['log'](_0x272e99(0x1df));const _0x443b07=await new id_deployment_result_retriever_1[(_0x272e99(0x1cf))]({'salesforceService':this[_0x272e99(0x17d)],'value':this[_0x272e99(0x1ec)]})[_0x272e99(0x1f2)]();if(!_0x443b07[_0x272e99(0x1ad)])throw new Error(_0x272e99(0x164));return _0x443b07;}async[a393_0x318622(0x18b)](){const _0x4752b0=a393_0x318622;this[_0x4752b0(0x193)][_0x4752b0(0x1c6)](_0x4752b0(0x1b3));const _0x13eb8d=await this[_0x4752b0(0x17d)][_0x4752b0(0x198)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x4752b0(0x16f)]+_0x4752b0(0x17c)+flosum_constants_1[_0x4752b0(0x19c)]['BACKUP_ZIP_NAME']+_0x4752b0(0x169)),_0x5480c6=await(0x0,fetch_attachments_1[_0x4752b0(0x1d9)])(this[_0x4752b0(0x165)],[_0x13eb8d[0x0]['Id']]),_0x4d16c1=await(0x0,fetch_attachments_1[_0x4752b0(0x190)])(_0x5480c6,this['_connectionSalesforce']);if(!_0x4d16c1[_0x4752b0(0x1ad)])throw new Error(_0x4752b0(0x167));return _0x4d16c1[0x0][_0x4752b0(0x174)][_0x4752b0(0x1b7)];}async[a393_0x318622(0x18c)](_0x51646f){const _0x2b57a8=a393_0x318622;this[_0x2b57a8(0x193)]['log'](_0x2b57a8(0x1b6));const _0x30d3a6=await this[_0x2b57a8(0x18b)](),_0x27e54e=await new zip_creator_rollback_1[(_0x2b57a8(0x1c7))]({'rollbackName':this[_0x2b57a8(0x1d5)][_0x2b57a8(0x1d8)],'backup':_0x30d3a6,'deploymentResults':_0x51646f})[_0x2b57a8(0x179)](),_0x397580=this[_0x2b57a8(0x196)]+'/'+(0x0,shortid_1['default'])()+_0x2b57a8(0x172);return await(0x0,promises_1[_0x2b57a8(0x1cc)])(_0x397580,_0x27e54e),_0x397580;}async[a393_0x318622(0x1af)](_0x12f614){const _0x11d34b=a393_0x318622;this[_0x11d34b(0x193)][_0x11d34b(0x1c6)](_0x11d34b(0x1f3));const _0x2c7bd2=await this['_vpkService'][_0x11d34b(0x1aa)](_0x12f614),_0x31010c=this[_0x11d34b(0x196)]+'/vpk__'+_0x12f614['slice'](_0x12f614['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x31010c,_0x2c7bd2),await this['_vpkService'][_0x11d34b(0x170)](_0x31010c),_0x31010c;}[a393_0x318622(0x1db)](_0x26efb3){const _0x13bb5c=a393_0x318622;return this[_0x13bb5c(0x193)][_0x13bb5c(0x1c6)](_0x13bb5c(0x1d3)),_0x26efb3['map'](_0x2c8f4f=>{const _0x198918=_0x13bb5c;return this[_0x198918(0x193)][_0x198918(0x1c6)](_0x2c8f4f[_0x198918(0x168)]+'.'+_0x2c8f4f[_0x198918(0x1d8)]+_0x198918(0x1c9)+_0x2c8f4f[_0x198918(0x19e)]),{[constants_1['FLOSUM_NAMESPACE']+_0x198918(0x18e)]:_0x198918(0x16e),[constants_1[_0x198918(0x1bc)]+_0x198918(0x1a9)]:_0x2c8f4f[_0x198918(0x19e)]===status_enums_1[_0x198918(0x192)][_0x198918(0x1ac)]?_0x198918(0x1a3):_0x198918(0x17a),[constants_1[_0x198918(0x1bc)]+'Result__c']:_0x2c8f4f[_0x198918(0x178)],[constants_1['FLOSUM_NAMESPACE']+_0x198918(0x1a7)]:_0x2c8f4f[_0x198918(0x1d8)],[constants_1[_0x198918(0x1bc)]+'Component_Type__c']:_0x2c8f4f[_0x198918(0x168)],[constants_1[_0x198918(0x1bc)]+_0x198918(0x1ba)]:_0x2c8f4f[_0x198918(0x177)],[constants_1[_0x198918(0x1bc)]+_0x198918(0x19d)]:this['_metadataLog'][_0x198918(0x187)],[constants_1[_0x198918(0x1bc)]+_0x198918(0x1e7)]:this['_metadataLogId']};});}async['saveDeploymentResults'](_0x4f1a74){const _0x260407=a393_0x318622;this[_0x260407(0x193)]['log'](_0x260407(0x1a0));const _0x2f7072=await this['_salesforceService'][_0x260407(0x1ed)](constants_1[_0x260407(0x1bc)]+_0x260407(0x1d4),_0x4f1a74),_0x121453=_0x2f7072['filter'](_0x587aa4=>!_0x587aa4[_0x260407(0x1ee)])[_0x260407(0x1ab)](_0x3be41b=>_0x3be41b[_0x260407(0x1b5)])[_0x260407(0x1cd)]();if(_0x121453[_0x260407(0x1ad)])throw new salesforce_dml_error_1[(_0x260407(0x1bb))](_0x121453);}async[a393_0x318622(0x166)](_0x246bb7){const _0xa39bd2=a393_0x318622;if(!this['_metadataLog']){this['_systemLogger'][_0xa39bd2(0x1f7)](_0x246bb7);return;}this[_0xa39bd2(0x193)]['logError'](_0x246bb7),await this['_logger'][_0xa39bd2(0x18a)](),await this[_0xa39bd2(0x1b4)](![],!![],'');}async[a393_0x318622(0x1b4)](_0x504dd7,_0x45150a,_0x539b8c){const _0x8e860b=a393_0x318622,{id:_0x87bb02,organizationId:_0x30563f,branchId:_0x415de8,organizationName:_0x44673b}=this[_0x8e860b(0x1d5)],_0x18b0de=_0x8e860b(0x1c0)+this[_0x8e860b(0x1d2)]+'/'+_0x87bb02+_0x8e860b(0x1e8)+_0x8e860b(0x18d)+_0x8e860b(0x1d7),_0x1f2817=_0x8e860b(0x1c0)+this[_0x8e860b(0x1d2)]+'/'+_0x30563f+'\x20>'+_0x44673b+_0x8e860b(0x183),_0x3ea703=_0x18b0de+_0x8e860b(0x175)+_0x1f2817+_0x8e860b(0x1c4),_0x4f97ec={[constants_1[_0x8e860b(0x1bc)]+'Action__c']:_0x3ea703,[constants_1['FLOSUM_NAMESPACE']+_0x8e860b(0x1e6)]:new Date(),[constants_1[_0x8e860b(0x1bc)]+_0x8e860b(0x1a4)]:_0x415de8,[constants_1[_0x8e860b(0x1bc)]+_0x8e860b(0x1cb)]:_0x8e860b(0x1e2),[constants_1['FLOSUM_NAMESPACE']+_0x8e860b(0x1f5)]:_0x8e860b(0x17b),[constants_1['FLOSUM_NAMESPACE']+_0x8e860b(0x1e9)]:_0x30563f},_0x2bf333={[constants_1['FLOSUM_NAMESPACE']+_0x8e860b(0x181)]:!_0x504dd7,[constants_1[_0x8e860b(0x1bc)]+_0x8e860b(0x189)]:_0x504dd7,[constants_1[_0x8e860b(0x1bc)]+_0x8e860b(0x1a9)]:_0x45150a?status_enums_1['MetadataLogStatus'][_0x8e860b(0x1e5)]:status_enums_1[_0x8e860b(0x1c8)][_0x8e860b(0x19f)],[constants_1[_0x8e860b(0x1bc)]+_0x8e860b(0x1fa)]:!![],[constants_1['FLOSUM_NAMESPACE']+'External_Deployment_Id__c']:_0x539b8c};await this['_connectionSalesforce'][_0x8e860b(0x1dc)](flosum_constants_1[_0x8e860b(0x19c)][_0x8e860b(0x1a8)]+'/'+constants_1[_0x8e860b(0x1bc)]+_0x8e860b(0x1ce)+this[_0x8e860b(0x1e1)],_0x2bf333),await this[_0x8e860b(0x165)][_0x8e860b(0x19a)](flosum_constants_1[_0x8e860b(0x19c)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x8e860b(0x1c5),_0x4f97ec),this[_0x8e860b(0x193)]['log'](_0x8e860b(0x184)+(_0x504dd7?_0x8e860b(0x1a6):'with\x20error')+'.'),await this[_0x8e860b(0x193)][_0x8e860b(0x18a)]();}async[a393_0x318622(0x16c)](){const _0xd593b0=a393_0x318622;try{this['_metadataLog']=await this[_0xd593b0(0x173)]();const _0x22615e=await this[_0xd593b0(0x1f4)]();await this['_logger'][_0xd593b0(0x18a)]();const _0x4f1498=await this[_0xd593b0(0x18c)](_0x22615e),_0x3254a1=await this[_0xd593b0(0x1af)](_0x4f1498);await this[_0xd593b0(0x193)][_0xd593b0(0x18a)]();const _0x4bcb8d=await this[_0xd593b0(0x1ea)][_0xd593b0(0x17e)](_0x3254a1);await this[_0xd593b0(0x193)][_0xd593b0(0x18a)]();const _0x4559db=this[_0xd593b0(0x1db)](_0x4bcb8d[_0xd593b0(0x1f9)]);await this[_0xd593b0(0x16a)](_0x4559db),await this['finishRollback'](_0x4bcb8d[_0xd593b0(0x1f0)],![],_0x4bcb8d[_0xd593b0(0x16b)]);}catch(_0x47e628){await this['finishRollbackWithError'](_0x47e628)[_0xd593b0(0x1c2)](_0x971655=>this[_0xd593b0(0x16d)]['error'](_0x971655));}}}exports[a393_0x318622(0x1e3)]=RollbackService;