const a404_0x4c95dc=a404_0xd01a;(function(_0x4aa5f5,_0x377bc1){const _0x5d75ba=a404_0xd01a,_0x514bd8=_0x4aa5f5();while(!![]){try{const _0x4c0d4b=-parseInt(_0x5d75ba(0x159))/0x1+-parseInt(_0x5d75ba(0x156))/0x2*(-parseInt(_0x5d75ba(0x137))/0x3)+-parseInt(_0x5d75ba(0x128))/0x4*(-parseInt(_0x5d75ba(0x119))/0x5)+parseInt(_0x5d75ba(0x18d))/0x6+parseInt(_0x5d75ba(0x150))/0x7+-parseInt(_0x5d75ba(0x111))/0x8*(parseInt(_0x5d75ba(0x180))/0x9)+-parseInt(_0x5d75ba(0x194))/0xa*(-parseInt(_0x5d75ba(0x139))/0xb);if(_0x4c0d4b===_0x377bc1)break;else _0x514bd8['push'](_0x514bd8['shift']());}catch(_0x34028c){_0x514bd8['push'](_0x514bd8['shift']());}}}(a404_0x398d,0x6eba8));const a404_0x90aca0=(function(){let _0x5b3ea4=!![];return function(_0x122713,_0x35e27e){const _0x2531ce=_0x5b3ea4?function(){const _0x5ee02d=a404_0xd01a;if(_0x35e27e){const _0x4b09b0=_0x35e27e[_0x5ee02d(0x169)](_0x122713,arguments);return _0x35e27e=null,_0x4b09b0;}}:function(){};return _0x5b3ea4=![],_0x2531ce;};}()),a404_0x47b22f=a404_0x90aca0(this,function(){const _0x329967=a404_0xd01a;return a404_0x47b22f[_0x329967(0x189)]()['search']('(((.+)+)+)+$')['toString']()['constructor'](a404_0x47b22f)['search'](_0x329967(0x145));});a404_0x47b22f();function a404_0x398d(){const _0x70dfa6=['saveDeploymentResults','organizationId','values','with\x20error','8TYvUgX','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Component_Name__c','_instanceUrl','from','Form\x20Deployment\x20Results','../constants/flosum.constants','Logger','771430RPwMqg','_packageImportService','shortid','../classes/retrievers/deployment-results/id.deployment-result.retriever','\x20of\x20branch\x20to\x20Organization\x20','./package-import.service','finishRollbackWithError','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','RollbackService','../classes/errors/salesforce-dml-error','Deployment_Result__c','\x27\x0a\x20\x20\x20\x20','\x27\x20AND\x20Name\x20=\x20\x27','retrieve','stepName','4oPdOxr','Status__c','fs/promises','Branch','Save\x20Deployment\x20Results','Date__c','Type__c','_attachmentLogId','slice','/Attachment','_logger','Component_Type__c','VeevaService','fetchAttachmentsDetailsById','_vpkService','55779NdHWxn','default','66hzUoRB','Cannot\x20find\x20Deployment\x20Results','veeva-rollback','_parentMetadataLogId','.zip','errors','_metadataLog','../../../constants','formFlosumDeploymentResults','FlosumConstants','lastIndexOf','retrieveBackup','(((.+)+)+)+$','error','updateLog','packageId','PackageComponentStatus','EXCEPTION','Branch__c','</a>','length','IdDeploymentResultRetriever','MetadataLogStatus','4239277sLTvQy','<a\x20href=','retrieveAttachments','FLOSUM_NAMESPACE','__esModule','execute','2kasjjC','retrieveDeploymentResults','Retrieve\x20Metadata\x20Log\x20info','632372iRrgjc','createVpk','deploymentAction','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','log','Success','DEPLOYED','Action__c','Activity_Item__c','Log__c','/vpk__','_salesforceService','packageComponentList','insertMultipleRecords','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','success','apply','Result__c','Metadata_Log__c/','Succeed__c','_timeZone','Create\x20zip\x20from\x20backup','bind','retrieveRecords','Metadata_Log__c','finishRollback','Create\x20Vpk\x20package','\x20>\x20','Is_Error__c','_veevaService','type','successfully','Veeva\x20Rollback\x20(Deployment)','post','VpkService','map','filter','External_Deployment_Id__c','logError','2323071NWtdiG','createZip','Retrieve\x20Deployment\x20Results','_componentIds','saveLog','./veeva.service','catch','_metadataLogId','ENDPOINT_UPSERT_RECORD','toString','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','PackageImportService','SalesforceDmlError','2758914HJDOdi','MetadataLogDto','retrieveMetadataLog','flat','Job_Completed__c','_connectionSalesforce','../../shared/utils/fetch-attachments','176210fMNvro','./vpk.service','name','validate','_tempFolder','status','_systemLogger'];a404_0x398d=function(){return _0x70dfa6;};return a404_0x398d();}function a404_0xd01a(_0x5d6398,_0x51eefe){const _0x2ea1c5=a404_0x398d();return a404_0xd01a=function(_0x47b22f,_0x90aca0){_0x47b22f=_0x47b22f-0x111;let _0x398df9=_0x2ea1c5[_0x47b22f];return _0x398df9;},a404_0xd01a(_0x5d6398,_0x51eefe);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x49b739){const _0x52eb56=a404_0xd01a;return _0x49b739&&_0x49b739[_0x52eb56(0x154)]?_0x49b739:{'default':_0x49b739};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a404_0x4c95dc(0x121)]=void 0x0;const veeva_service_1=require(a404_0x4c95dc(0x185)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a404_0x4c95dc(0x11e)),id_deployment_result_retriever_1=require(a404_0x4c95dc(0x11c)),flosum_constants_1=require(a404_0x4c95dc(0x117)),fetch_attachments_1=require(a404_0x4c95dc(0x193)),constants_1=require(a404_0x4c95dc(0x140)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a404_0x4c95dc(0x11b))),promises_1=require(a404_0x4c95dc(0x12a)),vpk_service_1=require(a404_0x4c95dc(0x195)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a404_0x4c95dc(0x122)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x4ff35f,connectionVeeva:_0x57ed0e,logger:_0x138efe,tempFolder:_0x4b72ce,instanceUrl:_0x2cdce0,timeZone:_0x2dacd2,metadataLogId:_0x3dffd1,attachmentLogId:_0x2c8e8b,parentMetadataLogId:_0x1a53ff,componentIds:_0x9ae841}){const _0x19b274=a404_0x4c95dc;this['_connectionSalesforce']=_0x4ff35f,this['_connectionVeeva']=_0x57ed0e,this[_0x19b274(0x132)]=_0x138efe,this['_tempFolder']=_0x4b72ce,this['_instanceUrl']=_0x2cdce0,this[_0x19b274(0x16d)]=_0x2dacd2,this[_0x19b274(0x187)]=_0x3dffd1,this[_0x19b274(0x12f)]=_0x2c8e8b,this[_0x19b274(0x13c)]=_0x1a53ff,this[_0x19b274(0x183)]=_0x9ae841,this[_0x19b274(0x19a)]=new core_1[(_0x19b274(0x118))](_0x19b274(0x13b)),this[_0x19b274(0x176)]=new veeva_service_1[(_0x19b274(0x134))]({'connection':_0x57ed0e,'logger':_0x138efe}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':_0x4ff35f}),this[_0x19b274(0x11a)]=new package_import_service_1[(_0x19b274(0x18b))]({'veevaService':this[_0x19b274(0x176)],'connection':_0x57ed0e,'logger':_0x138efe,'saveLog':this[_0x19b274(0x184)][_0x19b274(0x16f)](this)}),this[_0x19b274(0x136)]=new vpk_service_1[(_0x19b274(0x17b))]({'connection':_0x57ed0e});}async[a404_0x4c95dc(0x184)](_0x4623af,_0x584e62){const _0x498539=a404_0x4c95dc;this[_0x498539(0x132)]['log']('Save\x20log');const _0x20e4e0={'Body':Buffer[_0x498539(0x115)](_0x4623af)['toString']('base64'),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x584e62};await this['_connectionSalesforce'][_0x498539(0x17a)](flosum_constants_1[_0x498539(0x142)]['ENDPOINT_UPSERT_RECORD']+_0x498539(0x131),_0x20e4e0);}async['retrieveMetadataLog'](){const _0x4e42e5=a404_0x4c95dc;this[_0x4e42e5(0x132)][_0x4e42e5(0x15d)](_0x4e42e5(0x158));const [_0x1c76e3]=await this['_salesforceService']['retrieveRecords'](_0x4e42e5(0x167)+constants_1[_0x4e42e5(0x153)]+_0x4e42e5(0x15c)+constants_1[_0x4e42e5(0x153)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x4e42e5(0x112)+constants_1[_0x4e42e5(0x153)]+_0x4e42e5(0x120)+this[_0x4e42e5(0x187)]+_0x4e42e5(0x124));return new metadata_log_dto_1[(_0x4e42e5(0x18e))](_0x1c76e3);}async[a404_0x4c95dc(0x157)](){const _0x1b5265=a404_0x4c95dc;this[_0x1b5265(0x132)][_0x1b5265(0x15d)](_0x1b5265(0x182));const _0x22df19=await new id_deployment_result_retriever_1[(_0x1b5265(0x14e))]({'salesforceService':this[_0x1b5265(0x164)],'value':this['_componentIds']})[_0x1b5265(0x126)]();if(!_0x22df19['length'])throw new Error(_0x1b5265(0x13a));return _0x22df19;}async[a404_0x4c95dc(0x144)](){const _0x5e01cf=a404_0x4c95dc;this[_0x5e01cf(0x132)][_0x5e01cf(0x15d)]('Retrieve\x20Backup');const _0x179cb3=await this[_0x5e01cf(0x164)][_0x5e01cf(0x170)](_0x5e01cf(0x18a)+this['_parentMetadataLogId']+_0x5e01cf(0x125)+flosum_constants_1['FlosumConstants']['BACKUP_ZIP_NAME']+_0x5e01cf(0x124)),_0x29009f=await(0x0,fetch_attachments_1[_0x5e01cf(0x135)])(this[_0x5e01cf(0x192)],[_0x179cb3[0x0]['Id']]),_0x13180a=await(0x0,fetch_attachments_1[_0x5e01cf(0x152)])(_0x29009f,this['_connectionSalesforce']);if(!_0x13180a[_0x5e01cf(0x14d)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x13180a[0x0][_0x5e01cf(0x19d)]['Body'];}async[a404_0x4c95dc(0x181)](_0x270104){const _0x58a9e0=a404_0x4c95dc;this['_logger']['log'](_0x58a9e0(0x16e));const _0x26d6ed=await this[_0x58a9e0(0x144)](),_0x2a6ef4=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x58a9e0(0x13f)][_0x58a9e0(0x196)],'backup':_0x26d6ed,'deploymentResults':_0x270104})['create'](),_0x3fa0dc=this[_0x58a9e0(0x198)]+'/'+(0x0,shortid_1[_0x58a9e0(0x138)])()+_0x58a9e0(0x13d);return await(0x0,promises_1['writeFile'])(_0x3fa0dc,_0x2a6ef4),_0x3fa0dc;}async[a404_0x4c95dc(0x15a)](_0x87da81){const _0x2ee47b=a404_0x4c95dc;this['_logger'][_0x2ee47b(0x15d)](_0x2ee47b(0x173));const _0x2e57bf=await this[_0x2ee47b(0x136)]['generate'](_0x87da81),_0x3fb8c6=this[_0x2ee47b(0x198)]+_0x2ee47b(0x163)+_0x87da81[_0x2ee47b(0x130)](_0x87da81[_0x2ee47b(0x143)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x3fb8c6,_0x2e57bf),await this[_0x2ee47b(0x136)][_0x2ee47b(0x197)](_0x3fb8c6),_0x3fb8c6;}[a404_0x4c95dc(0x141)](_0x417e0c){const _0x36a2c5=a404_0x4c95dc;return this[_0x36a2c5(0x132)]['log'](_0x36a2c5(0x116)),_0x417e0c[_0x36a2c5(0x17c)](_0x90e05e=>{const _0x485b19=_0x36a2c5;return this[_0x485b19(0x132)][_0x485b19(0x15d)](_0x90e05e[_0x485b19(0x177)]+'.'+_0x90e05e[_0x485b19(0x196)]+'\x20:\x20'+_0x90e05e[_0x485b19(0x199)]),{[constants_1[_0x485b19(0x153)]+_0x485b19(0x12e)]:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+_0x485b19(0x129)]:_0x90e05e[_0x485b19(0x199)]===status_enums_1[_0x485b19(0x149)][_0x485b19(0x15f)]?_0x485b19(0x15e):'Failure',[constants_1[_0x485b19(0x153)]+_0x485b19(0x16a)]:_0x90e05e[_0x485b19(0x15b)],[constants_1[_0x485b19(0x153)]+_0x485b19(0x113)]:_0x90e05e[_0x485b19(0x196)],[constants_1[_0x485b19(0x153)]+_0x485b19(0x133)]:_0x90e05e[_0x485b19(0x177)],[constants_1[_0x485b19(0x153)]+'Veeva_Step_Name__c']:_0x90e05e[_0x485b19(0x127)],[constants_1[_0x485b19(0x153)]+'Org__c']:this[_0x485b19(0x13f)][_0x485b19(0x19c)],[constants_1['FLOSUM_NAMESPACE']+_0x485b19(0x171)]:this[_0x485b19(0x187)]};});}async['saveDeploymentResults'](_0x354e57){const _0x4c277b=a404_0x4c95dc;this[_0x4c277b(0x132)][_0x4c277b(0x15d)](_0x4c277b(0x12c));const _0x2ce8e1=await this[_0x4c277b(0x164)][_0x4c277b(0x166)](constants_1[_0x4c277b(0x153)]+_0x4c277b(0x123),_0x354e57),_0x287027=_0x2ce8e1[_0x4c277b(0x17d)](_0x1c3eb3=>!_0x1c3eb3[_0x4c277b(0x168)])[_0x4c277b(0x17c)](_0x511ebd=>_0x511ebd[_0x4c277b(0x13e)])[_0x4c277b(0x190)]();if(_0x287027['length'])throw new salesforce_dml_error_1[(_0x4c277b(0x18c))](_0x287027);}async[a404_0x4c95dc(0x11f)](_0x162681){const _0xac7485=a404_0x4c95dc;if(!this[_0xac7485(0x13f)]){this['_systemLogger'][_0xac7485(0x146)](_0x162681);return;}this[_0xac7485(0x132)][_0xac7485(0x17f)](_0x162681),await this[_0xac7485(0x132)][_0xac7485(0x147)](),await this['finishRollback'](![],!![],'');}async[a404_0x4c95dc(0x172)](_0x1dd88f,_0x44df10,_0x58b1a9){const _0x52b572=a404_0x4c95dc,{id:_0x85832d,organizationId:_0x13a398,branchId:_0x1c5eb0,organizationName:_0x4f228a}=this[_0x52b572(0x13f)],_0xa595eb=_0x52b572(0x151)+this[_0x52b572(0x114)]+'/'+_0x85832d+_0x52b572(0x174)+_0x52b572(0x179)+'\x20</a>',_0x223c54=_0x52b572(0x151)+this[_0x52b572(0x114)]+'/'+_0x13a398+'\x20>'+_0x4f228a+_0x52b572(0x14c),_0x3b61b1=_0xa595eb+_0x52b572(0x11d)+_0x223c54+'\x20has\x20been\x20created.',_0x324b65={[constants_1['FLOSUM_NAMESPACE']+_0x52b572(0x160)]:_0x3b61b1,[constants_1[_0x52b572(0x153)]+_0x52b572(0x12d)]:new Date(),[constants_1[_0x52b572(0x153)]+_0x52b572(0x14b)]:_0x1c5eb0,[constants_1['FLOSUM_NAMESPACE']+_0x52b572(0x161)]:_0x52b572(0x12b),[constants_1[_0x52b572(0x153)]+'Activity_Type__c']:'Deployment',[constants_1[_0x52b572(0x153)]+'TargetId__c']:_0x13a398},_0x5e130f={[constants_1[_0x52b572(0x153)]+_0x52b572(0x175)]:!_0x1dd88f,[constants_1[_0x52b572(0x153)]+_0x52b572(0x16c)]:_0x1dd88f,[constants_1['FLOSUM_NAMESPACE']+_0x52b572(0x129)]:_0x44df10?status_enums_1[_0x52b572(0x14f)][_0x52b572(0x14a)]:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x52b572(0x153)]+_0x52b572(0x191)]:!![],[constants_1[_0x52b572(0x153)]+_0x52b572(0x17e)]:_0x58b1a9};await this[_0x52b572(0x192)]['patch'](flosum_constants_1[_0x52b572(0x142)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x52b572(0x153)]+_0x52b572(0x16b)+this['_metadataLogId'],_0x5e130f),await this[_0x52b572(0x192)]['post'](flosum_constants_1['FlosumConstants'][_0x52b572(0x188)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x52b572(0x162),_0x324b65),this[_0x52b572(0x132)]['log']('Rollback\x20completed\x20'+(_0x1dd88f?_0x52b572(0x178):_0x52b572(0x19e))+'.'),await this[_0x52b572(0x132)][_0x52b572(0x147)]();}async[a404_0x4c95dc(0x155)](){const _0x173136=a404_0x4c95dc;try{this[_0x173136(0x13f)]=await this[_0x173136(0x18f)]();const _0x33f3e7=await this[_0x173136(0x157)]();await this[_0x173136(0x132)][_0x173136(0x147)]();const _0x35d53d=await this[_0x173136(0x181)](_0x33f3e7),_0x3e7c9e=await this[_0x173136(0x15a)](_0x35d53d);await this['_logger']['updateLog']();const _0x12f3c1=await this[_0x173136(0x11a)]['import'](_0x3e7c9e);await this[_0x173136(0x132)]['updateLog']();const _0x1219cd=this['formFlosumDeploymentResults'](_0x12f3c1[_0x173136(0x165)]);await this[_0x173136(0x19b)](_0x1219cd),await this[_0x173136(0x172)](_0x12f3c1['isDeployed'],![],_0x12f3c1[_0x173136(0x148)]);}catch(_0x3a2c25){await this['finishRollbackWithError'](_0x3a2c25)[_0x173136(0x186)](_0x14aa13=>this[_0x173136(0x19a)][_0x173136(0x146)](_0x14aa13));}}}exports[a404_0x4c95dc(0x121)]=RollbackService;