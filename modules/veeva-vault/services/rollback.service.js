const a360_0x33a564=a360_0x4409;(function(_0x320dca,_0x30fdf8){const _0x547ea0=a360_0x4409,_0x107110=_0x320dca();while(!![]){try{const _0x266007=parseInt(_0x547ea0(0x135))/0x1*(parseInt(_0x547ea0(0xe1))/0x2)+parseInt(_0x547ea0(0x112))/0x3+parseInt(_0x547ea0(0xf4))/0x4*(-parseInt(_0x547ea0(0x117))/0x5)+-parseInt(_0x547ea0(0x145))/0x6*(-parseInt(_0x547ea0(0xe7))/0x7)+-parseInt(_0x547ea0(0x10f))/0x8+-parseInt(_0x547ea0(0x124))/0x9+parseInt(_0x547ea0(0x160))/0xa;if(_0x266007===_0x30fdf8)break;else _0x107110['push'](_0x107110['shift']());}catch(_0x29a2fb){_0x107110['push'](_0x107110['shift']());}}}(a360_0x3f82,0xb1fda));const a360_0x1b758f=(function(){let _0x5437f8=!![];return function(_0x3d8e28,_0x24d436){const _0x47f62a=_0x5437f8?function(){if(_0x24d436){const _0x50ca5a=_0x24d436['apply'](_0x3d8e28,arguments);return _0x24d436=null,_0x50ca5a;}}:function(){};return _0x5437f8=![],_0x47f62a;};}()),a360_0x4b3c45=a360_0x1b758f(this,function(){const _0x4760ec=a360_0x4409;return a360_0x4b3c45[_0x4760ec(0x158)]()['search'](_0x4760ec(0x106))[_0x4760ec(0x158)]()['constructor'](a360_0x4b3c45)['search'](_0x4760ec(0x106));});a360_0x4b3c45();function a360_0x4409(_0x3b8aef,_0x57e493){const _0xe0422a=a360_0x3f82();return a360_0x4409=function(_0x4b3c45,_0x1b758f){_0x4b3c45=_0x4b3c45-0xe0;let _0x3f821c=_0xe0422a[_0x4b3c45];return _0x3f821c;},a360_0x4409(_0x3b8aef,_0x57e493);}'use strict';var __importDefault=this&&this[a360_0x33a564(0x11d)]||function(_0x47c8a1){const _0x59cee3=a360_0x33a564;return _0x47c8a1&&_0x47c8a1[_0x59cee3(0xe4)]?_0x47c8a1:{'default':_0x47c8a1};};function a360_0x3f82(){const _0xd1798c=['__importDefault','Date__c','_parentMetadataLogId','<a\x20href=','Org__c','../enums/status.enums','text/plain','12898935buTzPB','retrieveBackup','PackageImportService','packageId','Metadata_Log__c/','base64','writeFile','../classes/errors/salesforce-dml-error','./veeva.service','FLOSUM_NAMESPACE','type','Metadata_Log__c','TargetId__c','log','RollbackService','_metadataLogId','Result__c','5753WriIFD','_vpkService','successfully','Rollback\x20completed\x20','_instanceUrl','retrieveRecords','\x27\x20AND\x20Name\x20=\x20\x27','MetadataLogDto','organizationId','status','Succeed__c','Retrieve\x20Backup','createVpk','\x20:\x20','COMPLETED','execute','6IZDRPZ','Failure','_systemLogger','success','\x27\x0a\x20\x20\x20\x20','ZipCreatorRollback','retrieveMetadataLog','veeva-rollback','../dtos/metadata-log.dto','Cannot\x20find\x20Deployment\x20Results','packageComponentList','_connectionSalesforce','Body','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Component_Type__c','../../../core','\x20>\x20','flat','from','toString','shortid','MetadataLogStatus','fs/promises','retrieveDeploymentResults','FlosumConstants','bind','Veeva\x20Rollback\x20(Deployment)','12582920KygRtc','_metadataLog','fetchAttachmentsDetailsById','retrieve','lastIndexOf','IdDeploymentResultRetriever','Component_Name__c','/vpk__','Create\x20Vpk\x20package','Deployment\x20Result','Save\x20log','values','insertMultipleRecords','DEPLOYED','./salesforce.service','Type__c','finishRollback','ENDPOINT_UPSERT_RECORD','errors','504ycyYfp','import','finishRollbackWithError','__esModule','createZip','_componentIds','5019763qaKbXP','retrieveAttachments','error','SalesforceService','SalesforceDmlError','BACKUP_ZIP_NAME','_tempFolder','Form\x20Deployment\x20Results','Status__c','Veeva_Step_Name__c','_veevaService','Log__c','formFlosumDeploymentResults','1244444RKDxLq','Branch','Retrieve\x20Deployment\x20Results','../../shared/utils/fetch-attachments','Is_Error__c','_logger','\x20of\x20branch\x20to\x20Organization\x20','VpkService','VeevaService','./vpk.service','../../../constants','post','with\x20error','name','/Attachment','Success','_packageImportService','map','(((.+)+)+)+$','./package-import.service','../classes/rollback/zip-creator.rollback','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Branch__c','updateLog','Logger','.zip','Retrieve\x20Metadata\x20Log\x20info','8418392BBTlOO','validate','../classes/retrievers/deployment-results/id.deployment-result.retriever','3101553aJWwUA','create','length','_salesforceService','../constants/flosum.constants','20MYFhgc','Deployment','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','deploymentAction','Save\x20Deployment\x20Results','filter'];a360_0x3f82=function(){return _0xd1798c;};return a360_0x3f82();}Object['defineProperty'](exports,a360_0x33a564(0xe4),{'value':!![]}),exports[a360_0x33a564(0x132)]=void 0x0;const veeva_service_1=require(a360_0x33a564(0x12c)),salesforce_service_1=require(a360_0x33a564(0x16e)),package_import_service_1=require(a360_0x33a564(0x107)),id_deployment_result_retriever_1=require(a360_0x33a564(0x111)),flosum_constants_1=require(a360_0x33a564(0x116)),fetch_attachments_1=require(a360_0x33a564(0xf7)),constants_1=require(a360_0x33a564(0xfe)),zip_creator_rollback_1=require(a360_0x33a564(0x108)),shortid_1=__importDefault(require(a360_0x33a564(0x159))),promises_1=require(a360_0x33a564(0x15b)),vpk_service_1=require(a360_0x33a564(0xfd)),status_enums_1=require(a360_0x33a564(0x122)),salesforce_dml_error_1=require(a360_0x33a564(0x12b)),metadata_log_dto_1=require(a360_0x33a564(0x14d)),core_1=require(a360_0x33a564(0x154));class RollbackService{constructor({connectionSalesforce:_0x32415e,connectionVeeva:_0x5d7718,logger:_0x29460f,tempFolder:_0x10e7b0,instanceUrl:_0x438acb,timeZone:_0x296aeb,metadataLogId:_0x4c3ea1,attachmentLogId:_0x339111,parentMetadataLogId:_0xf795b7,componentIds:_0x4eb70e}){const _0x2eff9f=a360_0x33a564;this[_0x2eff9f(0x150)]=_0x32415e,this['_connectionVeeva']=_0x5d7718,this[_0x2eff9f(0xf9)]=_0x29460f,this[_0x2eff9f(0xed)]=_0x10e7b0,this[_0x2eff9f(0x139)]=_0x438acb,this['_timeZone']=_0x296aeb,this[_0x2eff9f(0x133)]=_0x4c3ea1,this['_attachmentLogId']=_0x339111,this[_0x2eff9f(0x11f)]=_0xf795b7,this[_0x2eff9f(0xe6)]=_0x4eb70e,this['_systemLogger']=new core_1[(_0x2eff9f(0x10c))](_0x2eff9f(0x14c)),this[_0x2eff9f(0xf1)]=new veeva_service_1[(_0x2eff9f(0xfc))]({'connection':_0x5d7718,'logger':_0x29460f}),this[_0x2eff9f(0x115)]=new salesforce_service_1[(_0x2eff9f(0xea))]({'connection':_0x32415e}),this[_0x2eff9f(0x104)]=new package_import_service_1[(_0x2eff9f(0x126))]({'veevaService':this[_0x2eff9f(0xf1)],'connection':_0x5d7718,'logger':_0x29460f,'saveLog':this['saveLog'][_0x2eff9f(0x15e)](this)}),this[_0x2eff9f(0x136)]=new vpk_service_1[(_0x2eff9f(0xfb))]({'connection':_0x5d7718});}async['saveLog'](_0x572503,_0x3bda6f){const _0x155d4c=a360_0x33a564;this[_0x155d4c(0xf9)][_0x155d4c(0x131)](_0x155d4c(0x16a));const _0xf60af2={'Body':Buffer[_0x155d4c(0x157)](_0x572503)[_0x155d4c(0x158)](_0x155d4c(0x129)),'ContentType':_0x155d4c(0x123),'ParentId':this[_0x155d4c(0x133)],'Name':_0x3bda6f};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x155d4c(0x15d)]['ENDPOINT_UPSERT_RECORD']+_0x155d4c(0x102),_0xf60af2);}async[a360_0x33a564(0x14b)](){const _0x52af6d=a360_0x33a564;this[_0x52af6d(0xf9)]['log'](_0x52af6d(0x10e));const [_0x58a150]=await this[_0x52af6d(0x115)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x52af6d(0x12d)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x52af6d(0x12d)]+_0x52af6d(0x152)+constants_1[_0x52af6d(0x12d)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x52af6d(0x12d)]+_0x52af6d(0x109)+this[_0x52af6d(0x133)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x52af6d(0x13c))](_0x58a150);}async[a360_0x33a564(0x15c)](){const _0x361200=a360_0x33a564;this[_0x361200(0xf9)][_0x361200(0x131)](_0x361200(0xf6));const _0x573ddb=await new id_deployment_result_retriever_1[(_0x361200(0x165))]({'salesforceService':this['_salesforceService'],'value':this[_0x361200(0xe6)]})[_0x361200(0x163)]();if(!_0x573ddb[_0x361200(0x114)])throw new Error(_0x361200(0x14e));return _0x573ddb;}async[a360_0x33a564(0x125)](){const _0x7fda0f=a360_0x33a564;this['_logger']['log'](_0x7fda0f(0x140));const _0x324b12=await this['_salesforceService'][_0x7fda0f(0x13a)](_0x7fda0f(0x119)+this[_0x7fda0f(0x11f)]+_0x7fda0f(0x13b)+flosum_constants_1[_0x7fda0f(0x15d)][_0x7fda0f(0xec)]+_0x7fda0f(0x149)),_0x147d12=await(0x0,fetch_attachments_1[_0x7fda0f(0x162)])(this['_connectionSalesforce'],[_0x324b12[0x0]['Id']]),_0x519596=await(0x0,fetch_attachments_1[_0x7fda0f(0xe8)])(_0x147d12,this[_0x7fda0f(0x150)]);if(!_0x519596[_0x7fda0f(0x114)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x519596[0x0][_0x7fda0f(0x16b)][_0x7fda0f(0x151)];}async[a360_0x33a564(0xe5)](_0x516ad6){const _0x1a7b6f=a360_0x33a564;this['_logger'][_0x1a7b6f(0x131)]('Create\x20zip\x20from\x20backup');const _0x397343=await this[_0x1a7b6f(0x125)](),_0x9f0a09=await new zip_creator_rollback_1[(_0x1a7b6f(0x14a))]({'rollbackName':this[_0x1a7b6f(0x161)]['name'],'backup':_0x397343,'deploymentResults':_0x516ad6})[_0x1a7b6f(0x113)](),_0x17dd7c=this[_0x1a7b6f(0xed)]+'/'+(0x0,shortid_1['default'])()+_0x1a7b6f(0x10d);return await(0x0,promises_1[_0x1a7b6f(0x12a)])(_0x17dd7c,_0x9f0a09),_0x17dd7c;}async['createVpk'](_0x384bc2){const _0x7656c5=a360_0x33a564;this[_0x7656c5(0xf9)]['log'](_0x7656c5(0x168));const _0x53bba4=await this['_vpkService']['generate'](_0x384bc2),_0x55d569=this[_0x7656c5(0xed)]+_0x7656c5(0x167)+_0x384bc2['slice'](_0x384bc2[_0x7656c5(0x164)]('/')+0x1);return await(0x0,promises_1[_0x7656c5(0x12a)])(_0x55d569,_0x53bba4),await this[_0x7656c5(0x136)][_0x7656c5(0x110)](_0x55d569),_0x55d569;}[a360_0x33a564(0xf3)](_0x238ffc){const _0x55a3ec=a360_0x33a564;return this['_logger'][_0x55a3ec(0x131)](_0x55a3ec(0xee)),_0x238ffc[_0x55a3ec(0x105)](_0xf511c1=>{const _0xeb00bd=_0x55a3ec;return this['_logger'][_0xeb00bd(0x131)](_0xf511c1[_0xeb00bd(0x12e)]+'.'+_0xf511c1['name']+_0xeb00bd(0x142)+_0xf511c1['status']),{[constants_1[_0xeb00bd(0x12d)]+_0xeb00bd(0x16f)]:_0xeb00bd(0x169),[constants_1[_0xeb00bd(0x12d)]+'Status__c']:_0xf511c1[_0xeb00bd(0x13e)]===status_enums_1['PackageComponentStatus'][_0xeb00bd(0x16d)]?_0xeb00bd(0x103):_0xeb00bd(0x146),[constants_1[_0xeb00bd(0x12d)]+_0xeb00bd(0x134)]:_0xf511c1[_0xeb00bd(0x11a)],[constants_1[_0xeb00bd(0x12d)]+_0xeb00bd(0x166)]:_0xf511c1[_0xeb00bd(0x101)],[constants_1[_0xeb00bd(0x12d)]+_0xeb00bd(0x153)]:_0xf511c1['type'],[constants_1[_0xeb00bd(0x12d)]+_0xeb00bd(0xf0)]:_0xf511c1['stepName'],[constants_1[_0xeb00bd(0x12d)]+_0xeb00bd(0x121)]:this[_0xeb00bd(0x161)][_0xeb00bd(0x13d)],[constants_1['FLOSUM_NAMESPACE']+_0xeb00bd(0x12f)]:this[_0xeb00bd(0x133)]};});}async['saveDeploymentResults'](_0x21fd20){const _0x5372fd=a360_0x33a564;this[_0x5372fd(0xf9)][_0x5372fd(0x131)](_0x5372fd(0x11b));const _0xb3ad77=await this[_0x5372fd(0x115)][_0x5372fd(0x16c)](constants_1[_0x5372fd(0x12d)]+'Deployment_Result__c',_0x21fd20),_0xe98383=_0xb3ad77[_0x5372fd(0x11c)](_0x32546c=>!_0x32546c[_0x5372fd(0x148)])[_0x5372fd(0x105)](_0x242d9c=>_0x242d9c[_0x5372fd(0xe0)])[_0x5372fd(0x156)]();if(_0xe98383[_0x5372fd(0x114)])throw new salesforce_dml_error_1[(_0x5372fd(0xeb))](_0xe98383);}async[a360_0x33a564(0xe3)](_0x128db3){const _0x12fd4a=a360_0x33a564;if(!this[_0x12fd4a(0x161)]){this[_0x12fd4a(0x147)]['error'](_0x128db3);return;}this[_0x12fd4a(0xf9)]['logError'](_0x128db3),await this['_logger'][_0x12fd4a(0x10b)](),await this['finishRollback'](![],!![],'');}async[a360_0x33a564(0x170)](_0x20618f,_0x4e70e,_0x4ee3eb){const _0x463b3b=a360_0x33a564,{id:_0x26e750,organizationId:_0xe045fd,branchId:_0x4521c6,organizationName:_0x1b3de9}=this['_metadataLog'],_0x7881a8=_0x463b3b(0x120)+this['_instanceUrl']+'/'+_0x26e750+_0x463b3b(0x155)+_0x463b3b(0x15f)+'\x20</a>',_0x4919ad=_0x463b3b(0x120)+this[_0x463b3b(0x139)]+'/'+_0xe045fd+'\x20>'+_0x1b3de9+'</a>',_0x4a4af9=_0x7881a8+_0x463b3b(0xfa)+_0x4919ad+'\x20has\x20been\x20created.',_0x13f420={[constants_1[_0x463b3b(0x12d)]+'Action__c']:_0x4a4af9,[constants_1[_0x463b3b(0x12d)]+_0x463b3b(0x11e)]:new Date(),[constants_1[_0x463b3b(0x12d)]+_0x463b3b(0x10a)]:_0x4521c6,[constants_1[_0x463b3b(0x12d)]+'Activity_Item__c']:_0x463b3b(0xf5),[constants_1[_0x463b3b(0x12d)]+'Activity_Type__c']:_0x463b3b(0x118),[constants_1[_0x463b3b(0x12d)]+_0x463b3b(0x130)]:_0xe045fd},_0x4073bf={[constants_1['FLOSUM_NAMESPACE']+_0x463b3b(0xf8)]:!_0x20618f,[constants_1[_0x463b3b(0x12d)]+_0x463b3b(0x13f)]:_0x20618f,[constants_1[_0x463b3b(0x12d)]+_0x463b3b(0xef)]:_0x4e70e?status_enums_1[_0x463b3b(0x15a)]['EXCEPTION']:status_enums_1['MetadataLogStatus'][_0x463b3b(0x143)],[constants_1[_0x463b3b(0x12d)]+'Job_Completed__c']:!![],[constants_1[_0x463b3b(0x12d)]+'Async_Request_Id__c']:_0x4ee3eb};await this['_connectionSalesforce']['patch'](flosum_constants_1['FlosumConstants'][_0x463b3b(0x171)]+'/'+constants_1[_0x463b3b(0x12d)]+_0x463b3b(0x128)+this[_0x463b3b(0x133)],_0x4073bf),await this['_connectionSalesforce'][_0x463b3b(0xff)](flosum_constants_1[_0x463b3b(0x15d)][_0x463b3b(0x171)]+'/'+constants_1[_0x463b3b(0x12d)]+_0x463b3b(0xf2),_0x13f420),this['_logger'][_0x463b3b(0x131)](_0x463b3b(0x138)+(_0x20618f?_0x463b3b(0x137):_0x463b3b(0x100))+'.'),await this['_logger'][_0x463b3b(0x10b)]();}async[a360_0x33a564(0x144)](){const _0x3b2d4b=a360_0x33a564;try{this[_0x3b2d4b(0x161)]=await this[_0x3b2d4b(0x14b)]();const _0x382f67=await this[_0x3b2d4b(0x15c)]();await this[_0x3b2d4b(0xf9)][_0x3b2d4b(0x10b)]();const _0x45697b=await this[_0x3b2d4b(0xe5)](_0x382f67),_0xe6539d=await this[_0x3b2d4b(0x141)](_0x45697b);await this['_logger'][_0x3b2d4b(0x10b)]();const _0x5a4ec4=await this[_0x3b2d4b(0x104)][_0x3b2d4b(0xe2)](_0xe6539d);await this['_logger'][_0x3b2d4b(0x10b)]();const _0x42a5e5=this[_0x3b2d4b(0xf3)](_0x5a4ec4[_0x3b2d4b(0x14f)]);await this['saveDeploymentResults'](_0x42a5e5),await this[_0x3b2d4b(0x170)](_0x5a4ec4['isDeployed'],![],_0x5a4ec4[_0x3b2d4b(0x127)]);}catch(_0x1bdc1f){await this[_0x3b2d4b(0xe3)](_0x1bdc1f)['catch'](_0x328f2e=>this[_0x3b2d4b(0x147)][_0x3b2d4b(0xe9)](_0x328f2e));}}}exports[a360_0x33a564(0x132)]=RollbackService;