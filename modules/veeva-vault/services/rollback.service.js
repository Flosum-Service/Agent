function a360_0x2517(_0x3df52f,_0x5499e8){const _0x1a3fcc=a360_0x121e();return a360_0x2517=function(_0x1d79d8,_0x225088){_0x1d79d8=_0x1d79d8-0xe2;let _0x121e00=_0x1a3fcc[_0x1d79d8];return _0x121e00;},a360_0x2517(_0x3df52f,_0x5499e8);}const a360_0x32be67=a360_0x2517;function a360_0x121e(){const _0x13f2be=['success','PackageImportService','\x27\x0a\x20\x20\x20\x20','_attachmentLogId','_metadataLog','createVpk','Create\x20zip\x20from\x20backup','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','TargetId__c','retrieveDeploymentResults','FLOSUM_NAMESPACE','IdDeploymentResultRetriever','_connectionSalesforce','Async_Request_Id__c','Is_Error__c','saveLog','DEPLOYED','import','31269NgfAxI','MetadataLogStatus','Activity_Type__c','38285mReFYB','generate','15rQdSXN','constructor','Metadata_Log__c/','Branch','\x20</a>','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Save\x20Deployment\x20Results','Activity_Item__c','\x20>\x20','patch','validate','stepName','Retrieve\x20Backup','Branch__c','Deployment','Body','3455736JWqGmk','_vpkService','_tempFolder','retrieveAttachments','retrieveBackup','Result__c','slice','_salesforceService','retrieveRecords','../dtos/metadata-log.dto','isDeployed','2313350KtUsnU','search','./vpk.service','finishRollbackWithError','(((.+)+)+)+$','Veeva\x20Rollback\x20(Deployment)','Cannot\x20find\x20Backup\x20Zip','EXCEPTION','_veevaService','VeevaService','/vpk__','error','veeva-rollback','8Mhirof','_componentIds','catch','BACKUP_ZIP_NAME','_metadataLogId','10946331ZwqVKo','../classes/rollback/zip-creator.rollback','_parentMetadataLogId','FlosumConstants','successfully','shortid','name','<a\x20href=','createZip','Save\x20log','fetchAttachmentsDetailsById','logError','writeFile','default','Deployment_Result__c','insertMultipleRecords','defineProperty','Type__c','toString','../../../constants','deploymentAction','MetadataLogDto','636iNlXZn','SalesforceService','_packageImportService','_systemLogger','apply','Retrieve\x20Deployment\x20Results','bind','formFlosumDeploymentResults','COMPLETED','Component_Name__c','_instanceUrl','Metadata_Log__c','Log__c','2726721fAtKQc','\x20of\x20branch\x20to\x20Organization\x20','errors','type','__esModule','Rollback\x20completed\x20','423676nmbiyI','Retrieve\x20Metadata\x20Log\x20info','updateLog','Job_Completed__c','Form\x20Deployment\x20Results','Status__c','ENDPOINT_UPSERT_RECORD','./veeva.service','</a>','\x27\x20AND\x20Name\x20=\x20\x27','log','Org__c','_timeZone','finishRollback','/Attachment','_logger','Success','text/plain','_connectionVeeva','flat','saveDeploymentResults','../../../core','./package-import.service','\x20has\x20been\x20created.','map','10bwFENQ','packageComponentList','retrieveMetadataLog','length','with\x20error','base64','organizationId','Deployment\x20Result','Action__c','retrieve','SalesforceDmlError','from'];a360_0x121e=function(){return _0x13f2be;};return a360_0x121e();}(function(_0x7f7169,_0x128162){const _0xabfc18=a360_0x2517,_0x1b9a5b=_0x7f7169();while(!![]){try{const _0x5743fe=parseInt(_0xabfc18(0x104))/0x1+-parseInt(_0xabfc18(0x15c))/0x2*(-parseInt(_0xabfc18(0x106))/0x3)+parseInt(_0xabfc18(0x116))/0x4+parseInt(_0xabfc18(0x121))/0x5+parseInt(_0xabfc18(0x149))/0x6*(-parseInt(_0xabfc18(0x101))/0x7)+-parseInt(_0xabfc18(0x12e))/0x8*(parseInt(_0xabfc18(0x156))/0x9)+parseInt(_0xabfc18(0xe3))/0xa*(-parseInt(_0xabfc18(0x133))/0xb);if(_0x5743fe===_0x128162)break;else _0x1b9a5b['push'](_0x1b9a5b['shift']());}catch(_0x5c33b6){_0x1b9a5b['push'](_0x1b9a5b['shift']());}}}(a360_0x121e,0x9f4c7));const a360_0x225088=(function(){let _0x4f918b=!![];return function(_0x5c2d14,_0x38a7ff){const _0x345a88=_0x4f918b?function(){const _0x384343=a360_0x2517;if(_0x38a7ff){const _0x6f3d18=_0x38a7ff[_0x384343(0x14d)](_0x5c2d14,arguments);return _0x38a7ff=null,_0x6f3d18;}}:function(){};return _0x4f918b=![],_0x345a88;};}()),a360_0x1d79d8=a360_0x225088(this,function(){const _0x15b118=a360_0x2517;return a360_0x1d79d8['toString']()[_0x15b118(0x122)]('(((.+)+)+)+$')['toString']()[_0x15b118(0x107)](a360_0x1d79d8)[_0x15b118(0x122)](_0x15b118(0x125));});a360_0x1d79d8();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x4549bd){const _0x4aedf1=a360_0x2517;return _0x4549bd&&_0x4549bd[_0x4aedf1(0x15a)]?_0x4549bd:{'default':_0x4549bd};};Object[a360_0x32be67(0x143)](exports,a360_0x32be67(0x15a),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a360_0x32be67(0x163)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a360_0x32be67(0x172)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a360_0x32be67(0x146)),zip_creator_rollback_1=require(a360_0x32be67(0x134)),shortid_1=__importDefault(require(a360_0x32be67(0x138))),promises_1=require('fs/promises'),vpk_service_1=require(a360_0x32be67(0x123)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a360_0x32be67(0x11f)),core_1=require(a360_0x32be67(0x171));class RollbackService{constructor({connectionSalesforce:_0x5e967f,connectionVeeva:_0x1992a1,logger:_0x5f32b5,tempFolder:_0x304865,instanceUrl:_0x292992,timeZone:_0x261b8f,metadataLogId:_0x337d3a,attachmentLogId:_0x31fcc8,parentMetadataLogId:_0x4b8206,componentIds:_0x4ed8be}){const _0x962aac=a360_0x32be67;this[_0x962aac(0xfb)]=_0x5e967f,this[_0x962aac(0x16e)]=_0x1992a1,this[_0x962aac(0x16b)]=_0x5f32b5,this['_tempFolder']=_0x304865,this[_0x962aac(0x153)]=_0x292992,this[_0x962aac(0x168)]=_0x261b8f,this[_0x962aac(0x132)]=_0x337d3a,this[_0x962aac(0xf2)]=_0x31fcc8,this['_parentMetadataLogId']=_0x4b8206,this[_0x962aac(0x12f)]=_0x4ed8be,this[_0x962aac(0x14c)]=new core_1['Logger'](_0x962aac(0x12d)),this[_0x962aac(0x129)]=new veeva_service_1[(_0x962aac(0x12a))]({'connection':_0x1992a1,'logger':_0x5f32b5}),this[_0x962aac(0x11d)]=new salesforce_service_1[(_0x962aac(0x14a))]({'connection':_0x5e967f}),this['_packageImportService']=new package_import_service_1[(_0x962aac(0xf0))]({'veevaService':this[_0x962aac(0x129)],'connection':_0x1992a1,'logger':_0x5f32b5,'saveLog':this[_0x962aac(0xfe)][_0x962aac(0x14f)](this)}),this[_0x962aac(0x117)]=new vpk_service_1['VpkService']({'connection':_0x1992a1});}async['saveLog'](_0x15f6f5,_0x5e0d40){const _0x2446dc=a360_0x32be67;this[_0x2446dc(0x16b)][_0x2446dc(0x166)](_0x2446dc(0x13c));const _0x1dab7c={'Body':Buffer[_0x2446dc(0xee)](_0x15f6f5)[_0x2446dc(0x145)](_0x2446dc(0xe8)),'ContentType':_0x2446dc(0x16d),'ParentId':this[_0x2446dc(0x132)],'Name':_0x5e0d40};await this[_0x2446dc(0xfb)]['post'](flosum_constants_1[_0x2446dc(0x136)][_0x2446dc(0x162)]+_0x2446dc(0x16a),_0x1dab7c);}async[a360_0x32be67(0xe5)](){const _0x2ea2db=a360_0x32be67;this['_logger']['log'](_0x2ea2db(0x15d));const [_0x230e00]=await this[_0x2ea2db(0x11d)][_0x2ea2db(0x11e)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x2ea2db(0xf9)]+_0x2ea2db(0x10b)+constants_1[_0x2ea2db(0xf9)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this['_metadataLogId']+_0x2ea2db(0xf1));return new metadata_log_dto_1[(_0x2ea2db(0x148))](_0x230e00);}async[a360_0x32be67(0xf8)](){const _0x1696ac=a360_0x32be67;this['_logger'][_0x1696ac(0x166)](_0x1696ac(0x14e));const _0x87550e=await new id_deployment_result_retriever_1[(_0x1696ac(0xfa))]({'salesforceService':this['_salesforceService'],'value':this[_0x1696ac(0x12f)]})[_0x1696ac(0xec)]();if(!_0x87550e[_0x1696ac(0xe6)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x87550e;}async[a360_0x32be67(0x11a)](){const _0x3f527c=a360_0x32be67;this[_0x3f527c(0x16b)][_0x3f527c(0x166)](_0x3f527c(0x112));const _0x2d7933=await this[_0x3f527c(0x11d)][_0x3f527c(0x11e)](_0x3f527c(0xf6)+this[_0x3f527c(0x135)]+_0x3f527c(0x165)+flosum_constants_1[_0x3f527c(0x136)][_0x3f527c(0x131)]+'\x27\x0a\x20\x20\x20\x20'),_0x510976=await(0x0,fetch_attachments_1[_0x3f527c(0x13d)])(this[_0x3f527c(0xfb)],[_0x2d7933[0x0]['Id']]),_0x49a599=await(0x0,fetch_attachments_1[_0x3f527c(0x119)])(_0x510976,this[_0x3f527c(0xfb)]);if(!_0x49a599[_0x3f527c(0xe6)])throw new Error(_0x3f527c(0x127));return _0x49a599[0x0]['values'][_0x3f527c(0x115)];}async[a360_0x32be67(0x13b)](_0x57de54){const _0x56f844=a360_0x32be67;this['_logger'][_0x56f844(0x166)](_0x56f844(0xf5));const _0xa7d4be=await this[_0x56f844(0x11a)](),_0x1bd3e6=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this['_metadataLog']['name'],'backup':_0xa7d4be,'deploymentResults':_0x57de54})['create'](),_0x358c72=this['_tempFolder']+'/'+(0x0,shortid_1[_0x56f844(0x140)])()+'.zip';return await(0x0,promises_1[_0x56f844(0x13f)])(_0x358c72,_0x1bd3e6),_0x358c72;}async[a360_0x32be67(0xf4)](_0x126605){const _0xdff454=a360_0x32be67;this[_0xdff454(0x16b)][_0xdff454(0x166)]('Create\x20Vpk\x20package');const _0x249a5a=await this[_0xdff454(0x117)][_0xdff454(0x105)](_0x126605),_0x141650=this[_0xdff454(0x118)]+_0xdff454(0x12b)+_0x126605[_0xdff454(0x11c)](_0x126605['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x141650,_0x249a5a),await this[_0xdff454(0x117)][_0xdff454(0x110)](_0x141650),_0x141650;}[a360_0x32be67(0x150)](_0x16d21a){const _0x3d269f=a360_0x32be67;return this[_0x3d269f(0x16b)][_0x3d269f(0x166)](_0x3d269f(0x160)),_0x16d21a[_0x3d269f(0xe2)](_0x2a4d07=>{const _0x3bea1d=_0x3d269f;return this[_0x3bea1d(0x16b)]['log'](_0x2a4d07[_0x3bea1d(0x159)]+'.'+_0x2a4d07['name']+'\x20:\x20'+_0x2a4d07['status']),{[constants_1[_0x3bea1d(0xf9)]+_0x3bea1d(0x144)]:_0x3bea1d(0xea),[constants_1[_0x3bea1d(0xf9)]+_0x3bea1d(0x161)]:_0x2a4d07['status']===status_enums_1['PackageComponentStatus'][_0x3bea1d(0xff)]?_0x3bea1d(0x16c):'Failure',[constants_1[_0x3bea1d(0xf9)]+_0x3bea1d(0x11b)]:_0x2a4d07[_0x3bea1d(0x147)],[constants_1[_0x3bea1d(0xf9)]+_0x3bea1d(0x152)]:_0x2a4d07[_0x3bea1d(0x139)],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x2a4d07[_0x3bea1d(0x159)],[constants_1[_0x3bea1d(0xf9)]+'Veeva_Step_Name__c']:_0x2a4d07[_0x3bea1d(0x111)],[constants_1[_0x3bea1d(0xf9)]+_0x3bea1d(0x167)]:this[_0x3bea1d(0xf3)][_0x3bea1d(0xe9)],[constants_1[_0x3bea1d(0xf9)]+_0x3bea1d(0x154)]:this['_metadataLogId']};});}async[a360_0x32be67(0x170)](_0x398e3d){const _0x1a6479=a360_0x32be67;this[_0x1a6479(0x16b)][_0x1a6479(0x166)](_0x1a6479(0x10c));const _0x23582b=await this['_salesforceService'][_0x1a6479(0x142)](constants_1[_0x1a6479(0xf9)]+_0x1a6479(0x141),_0x398e3d),_0x21e6ed=_0x23582b['filter'](_0x77c2c1=>!_0x77c2c1[_0x1a6479(0xef)])[_0x1a6479(0xe2)](_0x46a11e=>_0x46a11e[_0x1a6479(0x158)])[_0x1a6479(0x16f)]();if(_0x21e6ed[_0x1a6479(0xe6)])throw new salesforce_dml_error_1[(_0x1a6479(0xed))](_0x21e6ed);}async[a360_0x32be67(0x124)](_0x1d6e3b){const _0x38d582=a360_0x32be67;if(!this[_0x38d582(0xf3)]){this['_systemLogger'][_0x38d582(0x12c)](_0x1d6e3b);return;}this[_0x38d582(0x16b)][_0x38d582(0x13e)](_0x1d6e3b),await this[_0x38d582(0x16b)][_0x38d582(0x15e)](),await this[_0x38d582(0x169)](![],!![],'');}async[a360_0x32be67(0x169)](_0x2bb05c,_0x312a28,_0x48311d){const _0x277a12=a360_0x32be67,{id:_0x3e6607,organizationId:_0x30b2d7,branchId:_0x1c03e7,organizationName:_0x10ea65}=this[_0x277a12(0xf3)],_0x607166=_0x277a12(0x13a)+this[_0x277a12(0x153)]+'/'+_0x3e6607+_0x277a12(0x10e)+_0x277a12(0x126)+_0x277a12(0x10a),_0x53c6a0=_0x277a12(0x13a)+this[_0x277a12(0x153)]+'/'+_0x30b2d7+'\x20>'+_0x10ea65+_0x277a12(0x164),_0x54eef1=_0x607166+_0x277a12(0x157)+_0x53c6a0+_0x277a12(0x173),_0x2a030c={[constants_1[_0x277a12(0xf9)]+_0x277a12(0xeb)]:_0x54eef1,[constants_1['FLOSUM_NAMESPACE']+'Date__c']:new Date(),[constants_1[_0x277a12(0xf9)]+_0x277a12(0x113)]:_0x1c03e7,[constants_1[_0x277a12(0xf9)]+_0x277a12(0x10d)]:_0x277a12(0x109),[constants_1['FLOSUM_NAMESPACE']+_0x277a12(0x103)]:_0x277a12(0x114),[constants_1[_0x277a12(0xf9)]+_0x277a12(0xf7)]:_0x30b2d7},_0xb17a62={[constants_1[_0x277a12(0xf9)]+_0x277a12(0xfd)]:!_0x2bb05c,[constants_1[_0x277a12(0xf9)]+'Succeed__c']:_0x2bb05c,[constants_1['FLOSUM_NAMESPACE']+_0x277a12(0x161)]:_0x312a28?status_enums_1[_0x277a12(0x102)][_0x277a12(0x128)]:status_enums_1[_0x277a12(0x102)][_0x277a12(0x151)],[constants_1[_0x277a12(0xf9)]+_0x277a12(0x15f)]:!![],[constants_1[_0x277a12(0xf9)]+_0x277a12(0xfc)]:_0x48311d};await this['_connectionSalesforce'][_0x277a12(0x10f)](flosum_constants_1[_0x277a12(0x136)][_0x277a12(0x162)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x277a12(0x108)+this[_0x277a12(0x132)],_0xb17a62),await this[_0x277a12(0xfb)]['post'](flosum_constants_1[_0x277a12(0x136)][_0x277a12(0x162)]+'/'+constants_1[_0x277a12(0xf9)]+_0x277a12(0x155),_0x2a030c),this['_logger']['log'](_0x277a12(0x15b)+(_0x2bb05c?_0x277a12(0x137):_0x277a12(0xe7))+'.'),await this[_0x277a12(0x16b)][_0x277a12(0x15e)]();}async['execute'](){const _0x17c8fb=a360_0x32be67;try{this[_0x17c8fb(0xf3)]=await this['retrieveMetadataLog']();const _0x42c07b=await this[_0x17c8fb(0xf8)]();await this[_0x17c8fb(0x16b)][_0x17c8fb(0x15e)]();const _0x124877=await this[_0x17c8fb(0x13b)](_0x42c07b),_0x329951=await this['createVpk'](_0x124877);await this[_0x17c8fb(0x16b)][_0x17c8fb(0x15e)]();const _0x4de78c=await this[_0x17c8fb(0x14b)][_0x17c8fb(0x100)](_0x329951);await this['_logger'][_0x17c8fb(0x15e)]();const _0x49ce25=this['formFlosumDeploymentResults'](_0x4de78c[_0x17c8fb(0xe4)]);await this[_0x17c8fb(0x170)](_0x49ce25),await this[_0x17c8fb(0x169)](_0x4de78c[_0x17c8fb(0x120)],![],_0x4de78c['packageId']);}catch(_0x4b0c69){await this[_0x17c8fb(0x124)](_0x4b0c69)[_0x17c8fb(0x130)](_0x491fd3=>this[_0x17c8fb(0x14c)]['error'](_0x491fd3));}}}exports['RollbackService']=RollbackService;