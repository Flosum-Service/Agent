const a361_0x443f1a=a361_0x4ab8;function a361_0x46a4(){const _0x180241=['/vpk__','Status__c','Save\x20Deployment\x20Results','successfully','Job_Completed__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','RollbackService','Body','_connectionSalesforce','../classes/errors/salesforce-dml-error','./package-import.service','errors','_veevaService','\x20>\x20','veeva-rollback','ZipCreatorRollback','map','../../../constants','toString','Cannot\x20find\x20Deployment\x20Results','filter','\x27\x0a\x20\x20\x20\x20','type','Veeva_Step_Name__c','default','fetchAttachmentsDetailsById','PackageImportService','_packageImportService','../enums/status.enums','\x20</a>','Create\x20Vpk\x20package','_systemLogger','post','values','stepName','with\x20error','saveLog','formFlosumDeploymentResults','shortid','2384820EcUEEf','fs/promises','createZip','defineProperty','Metadata_Log__c/','retrieveRecords','_instanceUrl','_tempFolder','TargetId__c','\x20of\x20branch\x20to\x20Organization\x20','Rollback\x20completed\x20','483Slfppf','VeevaService','VpkService','saveDeploymentResults','\x27\x20AND\x20Name\x20=\x20\x27','logError','(((.+)+)+)+$','44vaWfoi','./vpk.service','length','_componentIds','Branch','Logger','_timeZone','from','7245oGiFPq','status','_attachmentLogId','./salesforce.service','insertMultipleRecords','342IZTKZz','finishRollback','6012hTMwjR','_salesforceService','</a>','SalesforceService','ENDPOINT_UPSERT_RECORD','FlosumConstants','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','FLOSUM_NAMESPACE','__esModule','Success','Deployment','retrieveBackup','error','../../../core','/Attachment','Date__c','_metadataLog','execute','../../shared/utils/fetch-attachments','../constants/flosum.constants','Activity_Type__c','finishRollbackWithError','Retrieve\x20Backup','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','MetadataLogStatus','Save\x20log','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','retrieveAttachments','Failure','61136cPGqFY','_vpkService','deploymentAction','writeFile','Branch__c','log','catch','createVpk','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','generate','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Org__c','search','bind','4990jfiztL','../dtos/metadata-log.dto','Create\x20zip\x20from\x20backup','Activity_Item__c','_logger','slice','base64','IdDeploymentResultRetriever','12dfuJte','Component_Type__c','name','retrieve','7688WSRBNC','patch','SalesforceDmlError','updateLog','Cannot\x20find\x20Backup\x20Zip','3541704ehAZPA','import','<a\x20href=','\x20:\x20','BACKUP_ZIP_NAME','flat','./veeva.service','MetadataLogDto','retrieveDeploymentResults','EXCEPTION','1732764EpijmX','\x20has\x20been\x20created.','External_Deployment_Id__c','lastIndexOf','Deployment\x20Result','success','Component_Name__c','_metadataLogId','Deployment_Result__c','retrieveMetadataLog','Is_Error__c','Veeva\x20Rollback\x20(Deployment)'];a361_0x46a4=function(){return _0x180241;};return a361_0x46a4();}function a361_0x4ab8(_0x287753,_0x4a4838){const _0x285116=a361_0x46a4();return a361_0x4ab8=function(_0x1498f0,_0xfc7f4){_0x1498f0=_0x1498f0-0x12a;let _0x46a45f=_0x285116[_0x1498f0];return _0x46a45f;},a361_0x4ab8(_0x287753,_0x4a4838);}(function(_0x1ac2f1,_0x3861c4){const _0x38a361=a361_0x4ab8,_0x3c7b61=_0x1ac2f1();while(!![]){try{const _0x2ab012=-parseInt(_0x38a361(0x163))/0x1*(-parseInt(_0x38a361(0x179))/0x2)+-parseInt(_0x38a361(0x144))/0x3*(parseInt(_0x38a361(0x146))/0x4)+-parseInt(_0x38a361(0x1bf))/0x5+parseInt(_0x38a361(0x182))/0x6+parseInt(_0x38a361(0x130))/0x7*(-parseInt(_0x38a361(0x17d))/0x8)+-parseInt(_0x38a361(0x13f))/0x9*(parseInt(_0x38a361(0x171))/0xa)+-parseInt(_0x38a361(0x137))/0xb*(-parseInt(_0x38a361(0x18c))/0xc);if(_0x2ab012===_0x3861c4)break;else _0x3c7b61['push'](_0x3c7b61['shift']());}catch(_0x1f5fcb){_0x3c7b61['push'](_0x3c7b61['shift']());}}}(a361_0x46a4,0x6624a));const a361_0xfc7f4=(function(){let _0x36c8fe=!![];return function(_0x146c74,_0x2efd9f){const _0x144841=_0x36c8fe?function(){if(_0x2efd9f){const _0x1ff4c3=_0x2efd9f['apply'](_0x146c74,arguments);return _0x2efd9f=null,_0x1ff4c3;}}:function(){};return _0x36c8fe=![],_0x144841;};}()),a361_0x1498f0=a361_0xfc7f4(this,function(){const _0x38acb3=a361_0x4ab8;return a361_0x1498f0['toString']()[_0x38acb3(0x16f)](_0x38acb3(0x136))['toString']()['constructor'](a361_0x1498f0)[_0x38acb3(0x16f)](_0x38acb3(0x136));});a361_0x1498f0();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x41ee1e){const _0xce1c35=a361_0x4ab8;return _0x41ee1e&&_0x41ee1e[_0xce1c35(0x14e)]?_0x41ee1e:{'default':_0x41ee1e};};Object[a361_0x443f1a(0x1c2)](exports,a361_0x443f1a(0x14e),{'value':!![]}),exports[a361_0x443f1a(0x19e)]=void 0x0;const veeva_service_1=require(a361_0x443f1a(0x188)),salesforce_service_1=require(a361_0x443f1a(0x142)),package_import_service_1=require(a361_0x443f1a(0x1a2)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a361_0x443f1a(0x159)),fetch_attachments_1=require(a361_0x443f1a(0x158)),constants_1=require(a361_0x443f1a(0x1a9)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a361_0x443f1a(0x1be))),promises_1=require(a361_0x443f1a(0x1c0)),vpk_service_1=require(a361_0x443f1a(0x138)),status_enums_1=require(a361_0x443f1a(0x1b4)),salesforce_dml_error_1=require(a361_0x443f1a(0x1a1)),metadata_log_dto_1=require(a361_0x443f1a(0x172)),core_1=require(a361_0x443f1a(0x153));class RollbackService{constructor({connectionSalesforce:_0x3023c8,connectionVeeva:_0x2226ed,logger:_0x23e003,tempFolder:_0xbee1cb,instanceUrl:_0x3a6d3e,timeZone:_0x39d3ec,metadataLogId:_0x2dbd3c,attachmentLogId:_0x575dfe,parentMetadataLogId:_0x175c84,componentIds:_0x280bbe}){const _0x507bc5=a361_0x443f1a;this[_0x507bc5(0x1a0)]=_0x3023c8,this['_connectionVeeva']=_0x2226ed,this[_0x507bc5(0x175)]=_0x23e003,this[_0x507bc5(0x12c)]=_0xbee1cb,this['_instanceUrl']=_0x3a6d3e,this[_0x507bc5(0x13d)]=_0x39d3ec,this['_metadataLogId']=_0x2dbd3c,this[_0x507bc5(0x141)]=_0x575dfe,this['_parentMetadataLogId']=_0x175c84,this['_componentIds']=_0x280bbe,this[_0x507bc5(0x1b7)]=new core_1[(_0x507bc5(0x13c))](_0x507bc5(0x1a6)),this[_0x507bc5(0x1a4)]=new veeva_service_1[(_0x507bc5(0x131))]({'connection':_0x2226ed,'logger':_0x23e003}),this[_0x507bc5(0x147)]=new salesforce_service_1[(_0x507bc5(0x149))]({'connection':_0x3023c8}),this[_0x507bc5(0x1b3)]=new package_import_service_1[(_0x507bc5(0x1b2))]({'veevaService':this[_0x507bc5(0x1a4)],'connection':_0x2226ed,'logger':_0x23e003,'saveLog':this['saveLog'][_0x507bc5(0x170)](this)}),this[_0x507bc5(0x164)]=new vpk_service_1[(_0x507bc5(0x132))]({'connection':_0x2226ed});}async[a361_0x443f1a(0x1bc)](_0x10d064,_0xa79fd2){const _0x3aa9a1=a361_0x443f1a;this[_0x3aa9a1(0x175)]['log'](_0x3aa9a1(0x15f));const _0x121d09={'Body':Buffer[_0x3aa9a1(0x13e)](_0x10d064)[_0x3aa9a1(0x1aa)](_0x3aa9a1(0x177)),'ContentType':'text/plain','ParentId':this[_0x3aa9a1(0x193)],'Name':_0xa79fd2};await this[_0x3aa9a1(0x1a0)][_0x3aa9a1(0x1b8)](flosum_constants_1['FlosumConstants'][_0x3aa9a1(0x14a)]+_0x3aa9a1(0x154),_0x121d09);}async[a361_0x443f1a(0x195)](){const _0x522364=a361_0x443f1a;this['_logger'][_0x522364(0x168)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x32019f]=await this[_0x522364(0x147)][_0x522364(0x12a)](_0x522364(0x15d)+constants_1[_0x522364(0x14d)]+_0x522364(0x14c)+constants_1['FLOSUM_NAMESPACE']+_0x522364(0x16d)+constants_1[_0x522364(0x14d)]+_0x522364(0x16b)+constants_1[_0x522364(0x14d)]+_0x522364(0x160)+this['_metadataLogId']+_0x522364(0x1ad));return new metadata_log_dto_1[(_0x522364(0x189))](_0x32019f);}async['retrieveDeploymentResults'](){const _0x3cd1cd=a361_0x443f1a;this[_0x3cd1cd(0x175)][_0x3cd1cd(0x168)]('Retrieve\x20Deployment\x20Results');const _0x35c857=await new id_deployment_result_retriever_1[(_0x3cd1cd(0x178))]({'salesforceService':this[_0x3cd1cd(0x147)],'value':this[_0x3cd1cd(0x13a)]})[_0x3cd1cd(0x17c)]();if(!_0x35c857[_0x3cd1cd(0x139)])throw new Error(_0x3cd1cd(0x1ab));return _0x35c857;}async['retrieveBackup'](){const _0x266dc2=a361_0x443f1a;this[_0x266dc2(0x175)][_0x266dc2(0x168)](_0x266dc2(0x15c));const _0x240118=await this[_0x266dc2(0x147)][_0x266dc2(0x12a)](_0x266dc2(0x19d)+this['_parentMetadataLogId']+_0x266dc2(0x134)+flosum_constants_1[_0x266dc2(0x14b)][_0x266dc2(0x186)]+_0x266dc2(0x1ad)),_0x528216=await(0x0,fetch_attachments_1[_0x266dc2(0x1b1)])(this['_connectionSalesforce'],[_0x240118[0x0]['Id']]),_0x14266f=await(0x0,fetch_attachments_1[_0x266dc2(0x161)])(_0x528216,this[_0x266dc2(0x1a0)]);if(!_0x14266f[_0x266dc2(0x139)])throw new Error(_0x266dc2(0x181));return _0x14266f[0x0][_0x266dc2(0x1b9)][_0x266dc2(0x19f)];}async[a361_0x443f1a(0x1c1)](_0x3c6cb0){const _0x29caa5=a361_0x443f1a;this[_0x29caa5(0x175)][_0x29caa5(0x168)](_0x29caa5(0x173));const _0x3aa106=await this[_0x29caa5(0x151)](),_0x40eb85=await new zip_creator_rollback_1[(_0x29caa5(0x1a7))]({'rollbackName':this[_0x29caa5(0x156)][_0x29caa5(0x17b)],'backup':_0x3aa106,'deploymentResults':_0x3c6cb0})['create'](),_0x55e933=this['_tempFolder']+'/'+(0x0,shortid_1[_0x29caa5(0x1b0)])()+'.zip';return await(0x0,promises_1[_0x29caa5(0x166)])(_0x55e933,_0x40eb85),_0x55e933;}async[a361_0x443f1a(0x16a)](_0x304c7a){const _0x3a800c=a361_0x443f1a;this[_0x3a800c(0x175)]['log'](_0x3a800c(0x1b6));const _0x297839=await this['_vpkService'][_0x3a800c(0x16c)](_0x304c7a),_0x102bf9=this[_0x3a800c(0x12c)]+_0x3a800c(0x198)+_0x304c7a[_0x3a800c(0x176)](_0x304c7a[_0x3a800c(0x18f)]('/')+0x1);return await(0x0,promises_1[_0x3a800c(0x166)])(_0x102bf9,_0x297839),await this['_vpkService']['validate'](_0x102bf9),_0x102bf9;}[a361_0x443f1a(0x1bd)](_0x157c01){const _0x1cab8a=a361_0x443f1a;return this[_0x1cab8a(0x175)][_0x1cab8a(0x168)]('Form\x20Deployment\x20Results'),_0x157c01[_0x1cab8a(0x1a8)](_0x4bbdd4=>{const _0x4b9cf5=_0x1cab8a;return this[_0x4b9cf5(0x175)]['log'](_0x4bbdd4['type']+'.'+_0x4bbdd4[_0x4b9cf5(0x17b)]+_0x4b9cf5(0x185)+_0x4bbdd4[_0x4b9cf5(0x140)]),{[constants_1[_0x4b9cf5(0x14d)]+'Type__c']:_0x4b9cf5(0x190),[constants_1[_0x4b9cf5(0x14d)]+_0x4b9cf5(0x199)]:_0x4bbdd4[_0x4b9cf5(0x140)]===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x4b9cf5(0x14f):_0x4b9cf5(0x162),[constants_1[_0x4b9cf5(0x14d)]+'Result__c']:_0x4bbdd4[_0x4b9cf5(0x165)],[constants_1['FLOSUM_NAMESPACE']+_0x4b9cf5(0x192)]:_0x4bbdd4[_0x4b9cf5(0x17b)],[constants_1['FLOSUM_NAMESPACE']+_0x4b9cf5(0x17a)]:_0x4bbdd4[_0x4b9cf5(0x1ae)],[constants_1['FLOSUM_NAMESPACE']+_0x4b9cf5(0x1af)]:_0x4bbdd4[_0x4b9cf5(0x1ba)],[constants_1[_0x4b9cf5(0x14d)]+_0x4b9cf5(0x16e)]:this[_0x4b9cf5(0x156)]['organizationId'],[constants_1[_0x4b9cf5(0x14d)]+'Metadata_Log__c']:this['_metadataLogId']};});}async[a361_0x443f1a(0x133)](_0x54e89c){const _0x178900=a361_0x443f1a;this[_0x178900(0x175)][_0x178900(0x168)](_0x178900(0x19a));const _0x46bf35=await this[_0x178900(0x147)][_0x178900(0x143)](constants_1[_0x178900(0x14d)]+_0x178900(0x194),_0x54e89c),_0xbc7b6e=_0x46bf35[_0x178900(0x1ac)](_0x3da94d=>!_0x3da94d[_0x178900(0x191)])['map'](_0x5d475e=>_0x5d475e[_0x178900(0x1a3)])[_0x178900(0x187)]();if(_0xbc7b6e[_0x178900(0x139)])throw new salesforce_dml_error_1[(_0x178900(0x17f))](_0xbc7b6e);}async['finishRollbackWithError'](_0x188acf){const _0x11a7ca=a361_0x443f1a;if(!this[_0x11a7ca(0x156)]){this[_0x11a7ca(0x1b7)][_0x11a7ca(0x152)](_0x188acf);return;}this[_0x11a7ca(0x175)][_0x11a7ca(0x135)](_0x188acf),await this['_logger'][_0x11a7ca(0x180)](),await this['finishRollback'](![],!![],'');}async['finishRollback'](_0x47b4a1,_0x130d7a,_0x17ea57){const _0x58443e=a361_0x443f1a,{id:_0x3eeb94,organizationId:_0xac6f96,branchId:_0x5f868a,organizationName:_0x550d3c}=this['_metadataLog'],_0x185bea='<a\x20href='+this[_0x58443e(0x12b)]+'/'+_0x3eeb94+_0x58443e(0x1a5)+_0x58443e(0x197)+_0x58443e(0x1b5),_0x1721f9=_0x58443e(0x184)+this[_0x58443e(0x12b)]+'/'+_0xac6f96+'\x20>'+_0x550d3c+_0x58443e(0x148),_0x177165=_0x185bea+_0x58443e(0x12e)+_0x1721f9+_0x58443e(0x18d),_0x3b0eee={[constants_1[_0x58443e(0x14d)]+'Action__c']:_0x177165,[constants_1[_0x58443e(0x14d)]+_0x58443e(0x155)]:new Date(),[constants_1[_0x58443e(0x14d)]+_0x58443e(0x167)]:_0x5f868a,[constants_1[_0x58443e(0x14d)]+_0x58443e(0x174)]:_0x58443e(0x13b),[constants_1[_0x58443e(0x14d)]+_0x58443e(0x15a)]:_0x58443e(0x150),[constants_1[_0x58443e(0x14d)]+_0x58443e(0x12d)]:_0xac6f96},_0x55f95d={[constants_1[_0x58443e(0x14d)]+_0x58443e(0x196)]:!_0x47b4a1,[constants_1[_0x58443e(0x14d)]+'Succeed__c']:_0x47b4a1,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x130d7a?status_enums_1['MetadataLogStatus'][_0x58443e(0x18b)]:status_enums_1[_0x58443e(0x15e)]['COMPLETED'],[constants_1[_0x58443e(0x14d)]+_0x58443e(0x19c)]:!![],[constants_1[_0x58443e(0x14d)]+_0x58443e(0x18e)]:_0x17ea57};await this[_0x58443e(0x1a0)][_0x58443e(0x17e)](flosum_constants_1['FlosumConstants'][_0x58443e(0x14a)]+'/'+constants_1[_0x58443e(0x14d)]+_0x58443e(0x1c3)+this[_0x58443e(0x193)],_0x55f95d),await this[_0x58443e(0x1a0)]['post'](flosum_constants_1['FlosumConstants'][_0x58443e(0x14a)]+'/'+constants_1[_0x58443e(0x14d)]+'Log__c',_0x3b0eee),this[_0x58443e(0x175)][_0x58443e(0x168)](_0x58443e(0x12f)+(_0x47b4a1?_0x58443e(0x19b):_0x58443e(0x1bb))+'.'),await this['_logger'][_0x58443e(0x180)]();}async[a361_0x443f1a(0x157)](){const _0x441b72=a361_0x443f1a;try{this['_metadataLog']=await this[_0x441b72(0x195)]();const _0x304792=await this[_0x441b72(0x18a)]();await this['_logger'][_0x441b72(0x180)]();const _0x11c02e=await this[_0x441b72(0x1c1)](_0x304792),_0x4340f5=await this[_0x441b72(0x16a)](_0x11c02e);await this['_logger']['updateLog']();const _0x18c4b5=await this['_packageImportService'][_0x441b72(0x183)](_0x4340f5);await this[_0x441b72(0x175)]['updateLog']();const _0x1e2cb8=this['formFlosumDeploymentResults'](_0x18c4b5['packageComponentList']);await this[_0x441b72(0x133)](_0x1e2cb8),await this[_0x441b72(0x145)](_0x18c4b5['isDeployed'],![],_0x18c4b5['packageId']);}catch(_0x58248c){await this[_0x441b72(0x15b)](_0x58248c)[_0x441b72(0x169)](_0x1cc294=>this['_systemLogger']['error'](_0x1cc294));}}}exports[a361_0x443f1a(0x19e)]=RollbackService;