const a361_0x4bc1ce=a361_0x5a7d;function a361_0x4b70(){const _0x37ec51=['RollbackService','status','\x20:\x20','_attachmentLogId','_veevaService','_componentIds','(((.+)+)+)+$','Create\x20zip\x20from\x20backup','retrieveDeploymentResults','\x27\x20AND\x20Name\x20=\x20\x27','retrieveAttachments','catch','DEPLOYED','11IBeFwH','Date__c','Log__c','1700885FMwaGY','MetadataLogStatus','toString','writeFile','./veeva.service','\x20of\x20branch\x20to\x20Organization\x20','organizationId','saveLog','Component_Type__c','_parentMetadataLogId','packageComponentList','12OPGkPr','create','flat','Is_Error__c','../enums/status.enums','.zip','SalesforceDmlError','./vpk.service','values','map','2361520VOrAOk','validate','retrieve','<a\x20href=','_vpkService','Veeva_Step_Name__c','createVpk','logError','56XmezQQ','fetchAttachmentsDetailsById','\x20</a>','../constants/flosum.constants','PackageComponentStatus','apply','_connectionVeeva','successfully','Failure','Activity_Item__c','_systemLogger','saveDeploymentResults','finishRollbackWithError','Retrieve\x20Metadata\x20Log\x20info','base64','BACKUP_ZIP_NAME','Save\x20Deployment\x20Results','length','error','../../shared/utils/fetch-attachments','_logger','_connectionSalesforce','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','../classes/rollback/zip-creator.rollback','_timeZone','VpkService','../classes/errors/salesforce-dml-error','914168FhRugE','PackageImportService','464680ossIOP','retrieveRecords','Branch','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','VeevaService','./salesforce.service','import','Cannot\x20find\x20Backup\x20Zip','updateLog','Deployment','../classes/retrievers/deployment-results/id.deployment-result.retriever','_metadataLogId','SalesforceService','Save\x20log','insertMultipleRecords','Rollback\x20completed\x20','Veeva\x20Rollback\x20(Deployment)','Activity_Type__c','shortid','createZip','Metadata_Log__c','FlosumConstants','29687412mKWYwK','63nGbisc','errors','generate','_salesforceService','retrieveMetadataLog','Body','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','ENDPOINT_UPSERT_RECORD','_instanceUrl','../../../core','Success','Action__c','../../../constants','Branch__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Deployment_Result__c','1627910OsUstC','External_Deployment_Id__c','Deployment\x20Result','post','/vpk__','from','Retrieve\x20Deployment\x20Results','retrieveBackup','191031KBAVGN','Form\x20Deployment\x20Results','patch','TargetId__c','IdDeploymentResultRetriever','__esModule','./package-import.service','_metadataLog','FLOSUM_NAMESPACE','filter','Cannot\x20find\x20Deployment\x20Results','search','stepName','log','defineProperty','_tempFolder','1YGwTin','lastIndexOf','formFlosumDeploymentResults','finishRollback','name'];a361_0x4b70=function(){return _0x37ec51;};return a361_0x4b70();}(function(_0x18eab2,_0x3d08c3){const _0x4ddc20=a361_0x5a7d,_0x174d18=_0x18eab2();while(!![]){try{const _0x85f7e0=-parseInt(_0x4ddc20(0xdb))/0x1*(-parseInt(_0x4ddc20(0x9c))/0x2)+-parseInt(_0x4ddc20(0xcb))/0x3*(-parseInt(_0x4ddc20(0x7f))/0x4)+-parseInt(_0x4ddc20(0xf0))/0x5*(-parseInt(_0x4ddc20(0xfb))/0x6)+parseInt(_0x4ddc20(0x77))/0x7+-parseInt(_0x4ddc20(0x9a))/0x8*(-parseInt(_0x4ddc20(0xb3))/0x9)+parseInt(_0x4ddc20(0xc3))/0xa*(parseInt(_0x4ddc20(0xed))/0xb)+-parseInt(_0x4ddc20(0xb2))/0xc;if(_0x85f7e0===_0x3d08c3)break;else _0x174d18['push'](_0x174d18['shift']());}catch(_0x5289ae){_0x174d18['push'](_0x174d18['shift']());}}}(a361_0x4b70,0x99dfd));const a361_0x3fc9e8=(function(){let _0x2efa71=!![];return function(_0x526466,_0xacfec6){const _0x2e017a=_0x2efa71?function(){const _0x2a2075=a361_0x5a7d;if(_0xacfec6){const _0x3aa89b=_0xacfec6[_0x2a2075(0x84)](_0x526466,arguments);return _0xacfec6=null,_0x3aa89b;}}:function(){};return _0x2efa71=![],_0x2e017a;};}()),a361_0x674d00=a361_0x3fc9e8(this,function(){const _0x22da4a=a361_0x5a7d;return a361_0x674d00[_0x22da4a(0xf2)]()[_0x22da4a(0xd6)]('(((.+)+)+)+$')['toString']()['constructor'](a361_0x674d00)[_0x22da4a(0xd6)](_0x22da4a(0xe6));});a361_0x674d00();'use strict';function a361_0x5a7d(_0x349171,_0x58f72d){const _0x8f5cbe=a361_0x4b70();return a361_0x5a7d=function(_0x674d00,_0x3fc9e8){_0x674d00=_0x674d00-0x76;let _0x4b70ff=_0x8f5cbe[_0x674d00];return _0x4b70ff;},a361_0x5a7d(_0x349171,_0x58f72d);}var __importDefault=this&&this['__importDefault']||function(_0x424abd){const _0x21c0b5=a361_0x5a7d;return _0x424abd&&_0x424abd[_0x21c0b5(0xd0)]?_0x424abd:{'default':_0x424abd};};Object[a361_0x4bc1ce(0xd9)](exports,'__esModule',{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a361_0x4bc1ce(0xf4)),salesforce_service_1=require(a361_0x4bc1ce(0xa1)),package_import_service_1=require(a361_0x4bc1ce(0xd1)),id_deployment_result_retriever_1=require(a361_0x4bc1ce(0xa6)),flosum_constants_1=require(a361_0x4bc1ce(0x82)),fetch_attachments_1=require(a361_0x4bc1ce(0x92)),constants_1=require(a361_0x4bc1ce(0xbf)),zip_creator_rollback_1=require(a361_0x4bc1ce(0x96)),shortid_1=__importDefault(require(a361_0x4bc1ce(0xae))),promises_1=require('fs/promises'),vpk_service_1=require(a361_0x4bc1ce(0x102)),status_enums_1=require(a361_0x4bc1ce(0xff)),salesforce_dml_error_1=require(a361_0x4bc1ce(0x99)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a361_0x4bc1ce(0xbc));class RollbackService{constructor({connectionSalesforce:_0x12dcba,connectionVeeva:_0x34a38b,logger:_0x14b8ba,tempFolder:_0x2cf687,instanceUrl:_0x2ef596,timeZone:_0xa89e28,metadataLogId:_0x1b6661,attachmentLogId:_0x51a89b,parentMetadataLogId:_0x4ce1e6,componentIds:_0x590220}){const _0x2b31dc=a361_0x4bc1ce;this[_0x2b31dc(0x94)]=_0x12dcba,this[_0x2b31dc(0x85)]=_0x34a38b,this[_0x2b31dc(0x93)]=_0x14b8ba,this[_0x2b31dc(0xda)]=_0x2cf687,this[_0x2b31dc(0xbb)]=_0x2ef596,this[_0x2b31dc(0x97)]=_0xa89e28,this[_0x2b31dc(0xa7)]=_0x1b6661,this[_0x2b31dc(0xe3)]=_0x51a89b,this[_0x2b31dc(0xf9)]=_0x4ce1e6,this[_0x2b31dc(0xe5)]=_0x590220,this[_0x2b31dc(0x89)]=new core_1['Logger']('veeva-rollback'),this[_0x2b31dc(0xe4)]=new veeva_service_1[(_0x2b31dc(0xa0))]({'connection':_0x34a38b,'logger':_0x14b8ba}),this[_0x2b31dc(0xb6)]=new salesforce_service_1[(_0x2b31dc(0xa8))]({'connection':_0x12dcba}),this['_packageImportService']=new package_import_service_1[(_0x2b31dc(0x9b))]({'veevaService':this['_veevaService'],'connection':_0x34a38b,'logger':_0x14b8ba,'saveLog':this[_0x2b31dc(0xf7)]['bind'](this)}),this[_0x2b31dc(0x7b)]=new vpk_service_1[(_0x2b31dc(0x98))]({'connection':_0x34a38b});}async['saveLog'](_0x4eb1b8,_0x2a53bb){const _0x271699=a361_0x4bc1ce;this[_0x271699(0x93)][_0x271699(0xd8)](_0x271699(0xa9));const _0x27d05f={'Body':Buffer[_0x271699(0xc8)](_0x4eb1b8)[_0x271699(0xf2)](_0x271699(0x8d)),'ContentType':'text/plain','ParentId':this[_0x271699(0xa7)],'Name':_0x2a53bb};await this[_0x271699(0x94)][_0x271699(0xc6)](flosum_constants_1[_0x271699(0xb1)][_0x271699(0xba)]+'/Attachment',_0x27d05f);}async[a361_0x4bc1ce(0xb7)](){const _0xa67af7=a361_0x4bc1ce;this[_0xa67af7(0x93)][_0xa67af7(0xd8)](_0xa67af7(0x8c));const [_0x24b0ff]=await this[_0xa67af7(0xb6)][_0xa67af7(0x9d)](_0xa67af7(0xc1)+constants_1[_0xa67af7(0xd3)]+_0xa67af7(0xb9)+constants_1[_0xa67af7(0xd3)]+_0xa67af7(0x9f)+constants_1[_0xa67af7(0xd3)]+_0xa67af7(0x95)+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this['_metadataLogId']+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1['MetadataLogDto'](_0x24b0ff);}async[a361_0x4bc1ce(0xe8)](){const _0x4f1093=a361_0x4bc1ce;this[_0x4f1093(0x93)]['log'](_0x4f1093(0xc9));const _0x19c551=await new id_deployment_result_retriever_1[(_0x4f1093(0xcf))]({'salesforceService':this[_0x4f1093(0xb6)],'value':this[_0x4f1093(0xe5)]})[_0x4f1093(0x79)]();if(!_0x19c551[_0x4f1093(0x90)])throw new Error(_0x4f1093(0xd5));return _0x19c551;}async[a361_0x4bc1ce(0xca)](){const _0x1fd4b3=a361_0x4bc1ce;this['_logger']['log']('Retrieve\x20Backup');const _0x5513b0=await this[_0x1fd4b3(0xb6)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x1fd4b3(0xf9)]+_0x1fd4b3(0xe9)+flosum_constants_1[_0x1fd4b3(0xb1)][_0x1fd4b3(0x8e)]+'\x27\x0a\x20\x20\x20\x20'),_0x4297b8=await(0x0,fetch_attachments_1[_0x1fd4b3(0x80)])(this[_0x1fd4b3(0x94)],[_0x5513b0[0x0]['Id']]),_0xdcaf99=await(0x0,fetch_attachments_1[_0x1fd4b3(0xea)])(_0x4297b8,this['_connectionSalesforce']);if(!_0xdcaf99[_0x1fd4b3(0x90)])throw new Error(_0x1fd4b3(0xa3));return _0xdcaf99[0x0][_0x1fd4b3(0x103)][_0x1fd4b3(0xb8)];}async[a361_0x4bc1ce(0xaf)](_0x51c46b){const _0x16e6cf=a361_0x4bc1ce;this[_0x16e6cf(0x93)]['log'](_0x16e6cf(0xe7));const _0x41959b=await this['retrieveBackup'](),_0x33c2b0=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x16e6cf(0xd2)][_0x16e6cf(0xdf)],'backup':_0x41959b,'deploymentResults':_0x51c46b})[_0x16e6cf(0xfc)](),_0x25300f=this[_0x16e6cf(0xda)]+'/'+(0x0,shortid_1['default'])()+_0x16e6cf(0x100);return await(0x0,promises_1['writeFile'])(_0x25300f,_0x33c2b0),_0x25300f;}async[a361_0x4bc1ce(0x7d)](_0x41dbc9){const _0x34d046=a361_0x4bc1ce;this[_0x34d046(0x93)][_0x34d046(0xd8)]('Create\x20Vpk\x20package');const _0x5be67e=await this[_0x34d046(0x7b)][_0x34d046(0xb5)](_0x41dbc9),_0x323dea=this[_0x34d046(0xda)]+_0x34d046(0xc7)+_0x41dbc9['slice'](_0x41dbc9[_0x34d046(0xdc)]('/')+0x1);return await(0x0,promises_1[_0x34d046(0xf3)])(_0x323dea,_0x5be67e),await this[_0x34d046(0x7b)][_0x34d046(0x78)](_0x323dea),_0x323dea;}[a361_0x4bc1ce(0xdd)](_0x24a9ef){const _0x1548d9=a361_0x4bc1ce;return this[_0x1548d9(0x93)][_0x1548d9(0xd8)](_0x1548d9(0xcc)),_0x24a9ef[_0x1548d9(0x76)](_0x203c80=>{const _0x3717da=_0x1548d9;return this[_0x3717da(0x93)][_0x3717da(0xd8)](_0x203c80['type']+'.'+_0x203c80['name']+_0x3717da(0xe2)+_0x203c80['status']),{[constants_1[_0x3717da(0xd3)]+'Type__c']:_0x3717da(0xc5),[constants_1[_0x3717da(0xd3)]+'Status__c']:_0x203c80[_0x3717da(0xe1)]===status_enums_1[_0x3717da(0x83)][_0x3717da(0xec)]?_0x3717da(0xbd):_0x3717da(0x87),[constants_1[_0x3717da(0xd3)]+'Result__c']:_0x203c80['deploymentAction'],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x203c80[_0x3717da(0xdf)],[constants_1[_0x3717da(0xd3)]+_0x3717da(0xf8)]:_0x203c80['type'],[constants_1[_0x3717da(0xd3)]+_0x3717da(0x7c)]:_0x203c80[_0x3717da(0xd7)],[constants_1[_0x3717da(0xd3)]+'Org__c']:this[_0x3717da(0xd2)][_0x3717da(0xf6)],[constants_1[_0x3717da(0xd3)]+_0x3717da(0xb0)]:this['_metadataLogId']};});}async[a361_0x4bc1ce(0x8a)](_0x3f7ab8){const _0x5f3136=a361_0x4bc1ce;this['_logger'][_0x5f3136(0xd8)](_0x5f3136(0x8f));const _0x4f6c5f=await this['_salesforceService'][_0x5f3136(0xaa)](constants_1['FLOSUM_NAMESPACE']+_0x5f3136(0xc2),_0x3f7ab8),_0x1ba834=_0x4f6c5f[_0x5f3136(0xd4)](_0x3dbaaa=>!_0x3dbaaa['success'])[_0x5f3136(0x76)](_0xb1c95c=>_0xb1c95c[_0x5f3136(0xb4)])[_0x5f3136(0xfd)]();if(_0x1ba834[_0x5f3136(0x90)])throw new salesforce_dml_error_1[(_0x5f3136(0x101))](_0x1ba834);}async[a361_0x4bc1ce(0x8b)](_0x45b9c8){const _0x211ce5=a361_0x4bc1ce;if(!this[_0x211ce5(0xd2)]){this[_0x211ce5(0x89)][_0x211ce5(0x91)](_0x45b9c8);return;}this[_0x211ce5(0x93)][_0x211ce5(0x7e)](_0x45b9c8),await this['_logger']['updateLog'](),await this['finishRollback'](![],!![],'');}async[a361_0x4bc1ce(0xde)](_0x6e5ba7,_0x4375c2,_0x4356aa){const _0x431755=a361_0x4bc1ce,{id:_0x7d7a59,organizationId:_0x4b9370,branchId:_0x132167,organizationName:_0x232e67}=this[_0x431755(0xd2)],_0x194137=_0x431755(0x7a)+this['_instanceUrl']+'/'+_0x7d7a59+'\x20>\x20'+_0x431755(0xac)+_0x431755(0x81),_0x5a00d1=_0x431755(0x7a)+this[_0x431755(0xbb)]+'/'+_0x4b9370+'\x20>'+_0x232e67+'</a>',_0x3c8124=_0x194137+_0x431755(0xf5)+_0x5a00d1+'\x20has\x20been\x20created.',_0x50afc0={[constants_1['FLOSUM_NAMESPACE']+_0x431755(0xbe)]:_0x3c8124,[constants_1['FLOSUM_NAMESPACE']+_0x431755(0xee)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x431755(0xc0)]:_0x132167,[constants_1[_0x431755(0xd3)]+_0x431755(0x88)]:_0x431755(0x9e),[constants_1[_0x431755(0xd3)]+_0x431755(0xad)]:_0x431755(0xa5),[constants_1['FLOSUM_NAMESPACE']+_0x431755(0xce)]:_0x4b9370},_0x184917={[constants_1[_0x431755(0xd3)]+_0x431755(0xfe)]:!_0x6e5ba7,[constants_1['FLOSUM_NAMESPACE']+'Succeed__c']:_0x6e5ba7,[constants_1[_0x431755(0xd3)]+'Status__c']:_0x4375c2?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x431755(0xf1)]['COMPLETED'],[constants_1[_0x431755(0xd3)]+'Job_Completed__c']:!![],[constants_1[_0x431755(0xd3)]+_0x431755(0xc4)]:_0x4356aa};await this[_0x431755(0x94)][_0x431755(0xcd)](flosum_constants_1[_0x431755(0xb1)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x431755(0xd3)]+'Metadata_Log__c/'+this[_0x431755(0xa7)],_0x184917),await this[_0x431755(0x94)][_0x431755(0xc6)](flosum_constants_1[_0x431755(0xb1)][_0x431755(0xba)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x431755(0xef),_0x50afc0),this[_0x431755(0x93)]['log'](_0x431755(0xab)+(_0x6e5ba7?_0x431755(0x86):'with\x20error')+'.'),await this['_logger'][_0x431755(0xa4)]();}async['execute'](){const _0x325562=a361_0x4bc1ce;try{this['_metadataLog']=await this[_0x325562(0xb7)]();const _0x3fb251=await this['retrieveDeploymentResults']();await this['_logger'][_0x325562(0xa4)]();const _0x2361cc=await this['createZip'](_0x3fb251),_0x4ea978=await this[_0x325562(0x7d)](_0x2361cc);await this['_logger'][_0x325562(0xa4)]();const _0x41417c=await this['_packageImportService'][_0x325562(0xa2)](_0x4ea978);await this[_0x325562(0x93)]['updateLog']();const _0x5bfe49=this[_0x325562(0xdd)](_0x41417c[_0x325562(0xfa)]);await this[_0x325562(0x8a)](_0x5bfe49),await this[_0x325562(0xde)](_0x41417c['isDeployed'],![],_0x41417c['packageId']);}catch(_0x257f54){await this['finishRollbackWithError'](_0x257f54)[_0x325562(0xeb)](_0x30d656=>this['_systemLogger'][_0x325562(0x91)](_0x30d656));}}}exports[a361_0x4bc1ce(0xe0)]=RollbackService;