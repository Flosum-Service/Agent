const a361_0x500fc7=a361_0x53c6;(function(_0x1a28c8,_0x19ce2b){const _0x533abb=a361_0x53c6,_0x3c6285=_0x1a28c8();while(!![]){try{const _0x2b268d=parseInt(_0x533abb(0xdd))/0x1+parseInt(_0x533abb(0x13d))/0x2+-parseInt(_0x533abb(0x15a))/0x3*(parseInt(_0x533abb(0xdf))/0x4)+parseInt(_0x533abb(0xf6))/0x5*(parseInt(_0x533abb(0x158))/0x6)+parseInt(_0x533abb(0xe4))/0x7+-parseInt(_0x533abb(0x130))/0x8+parseInt(_0x533abb(0xde))/0x9*(-parseInt(_0x533abb(0x133))/0xa);if(_0x2b268d===_0x19ce2b)break;else _0x3c6285['push'](_0x3c6285['shift']());}catch(_0x4e4e6c){_0x3c6285['push'](_0x3c6285['shift']());}}}(a361_0xeea2,0x2555e));function a361_0xeea2(){const _0x574064=['VpkService','type','Deployment_Result__c','_tempFolder','createZip','57490zBKGSu','29718wBsWXE','32cCDuty','__importDefault','\x20</a>','retrieveMetadataLog','Save\x20Deployment\x20Results','2016147CIKBIR','./vpk.service','<a\x20href=','Cannot\x20find\x20Deployment\x20Results','updateLog','from','Action__c','Component_Name__c','_systemLogger','log','../enums/status.enums','formFlosumDeploymentResults','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','.zip','insertMultipleRecords','map','values','toString','5LRtrAn','\x20has\x20been\x20created.','RollbackService','\x20of\x20branch\x20to\x20Organization\x20','_timeZone','Retrieve\x20Backup','Log__c','retrieveBackup','_salesforceService','packageId','Deployment','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Retrieve\x20Metadata\x20Log\x20info','Logger','</a>','../../shared/utils/fetch-attachments','/Attachment','Result__c','import','./veeva.service','create','createVpk','MetadataLogStatus','success','\x27\x20AND\x20Name\x20=\x20\x27','_logger','../../../constants','__esModule','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','SalesforceDmlError','retrieveDeploymentResults','ENDPOINT_UPSERT_RECORD','packageComponentList','_veevaService','Create\x20Vpk\x20package','External_Deployment_Id__c','PackageComponentStatus','Metadata_Log__c','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','name','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','_componentIds','Is_Error__c','SalesforceService','Veeva\x20Rollback\x20(Deployment)','Activity_Item__c','status','error','organizationId','\x20>\x20','DEPLOYED','finishRollback','Type__c','COMPLETED','_connectionVeeva','length','saveLog','_metadataLog','2445144lURWnY','_metadataLogId','post','160KoZbBd','Branch','\x27\x0a\x20\x20\x20\x20','Activity_Type__c','retrieveRecords','search','finishRollbackWithError','veeva-rollback','\x20:\x20','_vpkService','589838XPoFPa','../constants/flosum.constants','_instanceUrl','Deployment\x20Result','lastIndexOf','Org__c','default','retrieve','with\x20error','text/plain','Retrieve\x20Deployment\x20Results','successfully','IdDeploymentResultRetriever','logError','_connectionSalesforce','_attachmentLogId','(((.+)+)+)+$','defineProperty','writeFile','../classes/errors/salesforce-dml-error','_packageImportService','Cannot\x20find\x20Backup\x20Zip','Metadata_Log__c/','saveDeploymentResults','fetchAttachmentsDetailsById','FLOSUM_NAMESPACE','../classes/rollback/zip-creator.rollback','322290SNsJvK','TargetId__c','68529gYssAQ','constructor','Create\x20zip\x20from\x20backup','Date__c','catch','FlosumConstants','generate'];a361_0xeea2=function(){return _0x574064;};return a361_0xeea2();}function a361_0x53c6(_0x1e8802,_0x1cc899){const _0x510135=a361_0xeea2();return a361_0x53c6=function(_0x2a6739,_0x55754f){_0x2a6739=_0x2a6739-0xd7;let _0xeea2f1=_0x510135[_0x2a6739];return _0xeea2f1;},a361_0x53c6(_0x1e8802,_0x1cc899);}const a361_0x55754f=(function(){let _0x4b2f0c=!![];return function(_0x480754,_0x4c12de){const _0x3695ba=_0x4b2f0c?function(){if(_0x4c12de){const _0x426e29=_0x4c12de['apply'](_0x480754,arguments);return _0x4c12de=null,_0x426e29;}}:function(){};return _0x4b2f0c=![],_0x3695ba;};}()),a361_0x2a6739=a361_0x55754f(this,function(){const _0x12d6b1=a361_0x53c6;return a361_0x2a6739[_0x12d6b1(0xf5)]()[_0x12d6b1(0x138)](_0x12d6b1(0x14d))[_0x12d6b1(0xf5)]()[_0x12d6b1(0x15b)](a361_0x2a6739)[_0x12d6b1(0x138)](_0x12d6b1(0x14d));});a361_0x2a6739();'use strict';var __importDefault=this&&this[a361_0x500fc7(0xe0)]||function(_0x4cbf41){return _0x4cbf41&&_0x4cbf41['__esModule']?_0x4cbf41:{'default':_0x4cbf41};};Object[a361_0x500fc7(0x14e)](exports,a361_0x500fc7(0x111),{'value':!![]}),exports[a361_0x500fc7(0xf8)]=void 0x0;const veeva_service_1=require(a361_0x500fc7(0x109)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a361_0x500fc7(0x13e)),fetch_attachments_1=require(a361_0x500fc7(0x105)),constants_1=require(a361_0x500fc7(0x110)),zip_creator_rollback_1=require(a361_0x500fc7(0x157)),shortid_1=__importDefault(require('shortid')),promises_1=require('fs/promises'),vpk_service_1=require(a361_0x500fc7(0xe5)),status_enums_1=require(a361_0x500fc7(0xee)),salesforce_dml_error_1=require(a361_0x500fc7(0x150)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x424aa4,connectionVeeva:_0x428e98,logger:_0x5397f0,tempFolder:_0x227975,instanceUrl:_0x5f5094,timeZone:_0x3b7abe,metadataLogId:_0x7b442e,attachmentLogId:_0x253c24,parentMetadataLogId:_0x180081,componentIds:_0x33c4a9}){const _0x56dd50=a361_0x500fc7;this[_0x56dd50(0x14b)]=_0x424aa4,this[_0x56dd50(0x12c)]=_0x428e98,this['_logger']=_0x5397f0,this['_tempFolder']=_0x227975,this[_0x56dd50(0x13f)]=_0x5f5094,this[_0x56dd50(0xfa)]=_0x3b7abe,this[_0x56dd50(0x131)]=_0x7b442e,this[_0x56dd50(0x14c)]=_0x253c24,this['_parentMetadataLogId']=_0x180081,this['_componentIds']=_0x33c4a9,this[_0x56dd50(0xec)]=new core_1[(_0x56dd50(0x103))](_0x56dd50(0x13a)),this[_0x56dd50(0x117)]=new veeva_service_1['VeevaService']({'connection':_0x428e98,'logger':_0x5397f0}),this[_0x56dd50(0xfe)]=new salesforce_service_1[(_0x56dd50(0x121))]({'connection':_0x424aa4}),this[_0x56dd50(0x151)]=new package_import_service_1['PackageImportService']({'veevaService':this['_veevaService'],'connection':_0x428e98,'logger':_0x5397f0,'saveLog':this[_0x56dd50(0x12e)]['bind'](this)}),this[_0x56dd50(0x13c)]=new vpk_service_1[(_0x56dd50(0xd8))]({'connection':_0x428e98});}async[a361_0x500fc7(0x12e)](_0x5c0301,_0x50d1d0){const _0x555c87=a361_0x500fc7;this[_0x555c87(0x10f)][_0x555c87(0xed)]('Save\x20log');const _0x15bcc8={'Body':Buffer[_0x555c87(0xe9)](_0x5c0301)[_0x555c87(0xf5)]('base64'),'ContentType':_0x555c87(0x146),'ParentId':this[_0x555c87(0x131)],'Name':_0x50d1d0};await this['_connectionSalesforce'][_0x555c87(0x132)](flosum_constants_1[_0x555c87(0x15f)][_0x555c87(0x115)]+_0x555c87(0x106),_0x15bcc8);}async[a361_0x500fc7(0xe2)](){const _0x146725=a361_0x500fc7;this[_0x146725(0x10f)][_0x146725(0xed)](_0x146725(0x102));const [_0x3493c6]=await this[_0x146725(0xfe)][_0x146725(0x137)](_0x146725(0x112)+constants_1[_0x146725(0x156)]+_0x146725(0xf0)+constants_1[_0x146725(0x156)]+_0x146725(0x11c)+constants_1[_0x146725(0x156)]+_0x146725(0x11e)+constants_1[_0x146725(0x156)]+_0x146725(0x101)+this['_metadataLogId']+_0x146725(0x135));return new metadata_log_dto_1['MetadataLogDto'](_0x3493c6);}async[a361_0x500fc7(0x114)](){const _0x26d82c=a361_0x500fc7;this[_0x26d82c(0x10f)]['log'](_0x26d82c(0x147));const _0x11aaff=await new id_deployment_result_retriever_1[(_0x26d82c(0x149))]({'salesforceService':this['_salesforceService'],'value':this[_0x26d82c(0x11f)]})[_0x26d82c(0x144)]();if(!_0x11aaff['length'])throw new Error(_0x26d82c(0xe7));return _0x11aaff;}async[a361_0x500fc7(0xfd)](){const _0x1df4d9=a361_0x500fc7;this[_0x1df4d9(0x10f)][_0x1df4d9(0xed)](_0x1df4d9(0xfb));const _0x815d4b=await this['_salesforceService'][_0x1df4d9(0x137)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this['_parentMetadataLogId']+_0x1df4d9(0x10e)+flosum_constants_1['FlosumConstants']['BACKUP_ZIP_NAME']+_0x1df4d9(0x135)),_0x357ae1=await(0x0,fetch_attachments_1[_0x1df4d9(0x155)])(this[_0x1df4d9(0x14b)],[_0x815d4b[0x0]['Id']]),_0x537d4d=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x357ae1,this[_0x1df4d9(0x14b)]);if(!_0x537d4d['length'])throw new Error(_0x1df4d9(0x152));return _0x537d4d[0x0][_0x1df4d9(0xf4)]['Body'];}async[a361_0x500fc7(0xdc)](_0x23225b){const _0x41b371=a361_0x500fc7;this[_0x41b371(0x10f)][_0x41b371(0xed)](_0x41b371(0x15c));const _0x2e6e8d=await this[_0x41b371(0xfd)](),_0x34b1dc=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x41b371(0x12f)]['name'],'backup':_0x2e6e8d,'deploymentResults':_0x23225b})[_0x41b371(0x10a)](),_0x2c62a5=this[_0x41b371(0xdb)]+'/'+(0x0,shortid_1[_0x41b371(0x143)])()+_0x41b371(0xf1);return await(0x0,promises_1[_0x41b371(0x14f)])(_0x2c62a5,_0x34b1dc),_0x2c62a5;}async[a361_0x500fc7(0x10b)](_0x426ffa){const _0x349d56=a361_0x500fc7;this['_logger']['log'](_0x349d56(0x118));const _0x38c7e7=await this[_0x349d56(0x13c)][_0x349d56(0xd7)](_0x426ffa),_0x103d53=this[_0x349d56(0xdb)]+'/vpk__'+_0x426ffa['slice'](_0x426ffa[_0x349d56(0x141)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x103d53,_0x38c7e7),await this['_vpkService']['validate'](_0x103d53),_0x103d53;}['formFlosumDeploymentResults'](_0x243f7f){const _0x27d5b4=a361_0x500fc7;return this[_0x27d5b4(0x10f)][_0x27d5b4(0xed)]('Form\x20Deployment\x20Results'),_0x243f7f[_0x27d5b4(0xf3)](_0x250506=>{const _0x391337=_0x27d5b4;return this['_logger'][_0x391337(0xed)](_0x250506[_0x391337(0xd9)]+'.'+_0x250506[_0x391337(0x11d)]+_0x391337(0x13b)+_0x250506[_0x391337(0x124)]),{[constants_1[_0x391337(0x156)]+_0x391337(0x12a)]:_0x391337(0x140),[constants_1[_0x391337(0x156)]+'Status__c']:_0x250506[_0x391337(0x124)]===status_enums_1[_0x391337(0x11a)][_0x391337(0x128)]?'Success':'Failure',[constants_1[_0x391337(0x156)]+_0x391337(0x107)]:_0x250506['deploymentAction'],[constants_1[_0x391337(0x156)]+_0x391337(0xeb)]:_0x250506[_0x391337(0x11d)],[constants_1[_0x391337(0x156)]+'Component_Type__c']:_0x250506[_0x391337(0xd9)],[constants_1[_0x391337(0x156)]+'Veeva_Step_Name__c']:_0x250506['stepName'],[constants_1[_0x391337(0x156)]+_0x391337(0x142)]:this[_0x391337(0x12f)][_0x391337(0x126)],[constants_1['FLOSUM_NAMESPACE']+_0x391337(0x11b)]:this[_0x391337(0x131)]};});}async[a361_0x500fc7(0x154)](_0x42e03b){const _0x32f268=a361_0x500fc7;this[_0x32f268(0x10f)][_0x32f268(0xed)](_0x32f268(0xe3));const _0x5a663f=await this[_0x32f268(0xfe)][_0x32f268(0xf2)](constants_1[_0x32f268(0x156)]+_0x32f268(0xda),_0x42e03b),_0x9cd813=_0x5a663f['filter'](_0x54b7a1=>!_0x54b7a1[_0x32f268(0x10d)])[_0x32f268(0xf3)](_0x2e6015=>_0x2e6015['errors'])['flat']();if(_0x9cd813[_0x32f268(0x12d)])throw new salesforce_dml_error_1[(_0x32f268(0x113))](_0x9cd813);}async['finishRollbackWithError'](_0x5ab232){const _0x166581=a361_0x500fc7;if(!this[_0x166581(0x12f)]){this[_0x166581(0xec)][_0x166581(0x125)](_0x5ab232);return;}this[_0x166581(0x10f)][_0x166581(0x14a)](_0x5ab232),await this[_0x166581(0x10f)][_0x166581(0xe8)](),await this[_0x166581(0x129)](![],!![],'');}async['finishRollback'](_0x47612e,_0x24ef75,_0xa633c2){const _0x3cf21e=a361_0x500fc7,{id:_0x2ab151,organizationId:_0x25ba5e,branchId:_0x50dfce,organizationName:_0x4db750}=this['_metadataLog'],_0x27d0b0=_0x3cf21e(0xe6)+this['_instanceUrl']+'/'+_0x2ab151+_0x3cf21e(0x127)+_0x3cf21e(0x122)+_0x3cf21e(0xe1),_0x5f2e5e=_0x3cf21e(0xe6)+this[_0x3cf21e(0x13f)]+'/'+_0x25ba5e+'\x20>'+_0x4db750+_0x3cf21e(0x104),_0x55b89f=_0x27d0b0+_0x3cf21e(0xf9)+_0x5f2e5e+_0x3cf21e(0xf7),_0x1f79f5={[constants_1[_0x3cf21e(0x156)]+_0x3cf21e(0xea)]:_0x55b89f,[constants_1[_0x3cf21e(0x156)]+_0x3cf21e(0x15d)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+'Branch__c']:_0x50dfce,[constants_1[_0x3cf21e(0x156)]+_0x3cf21e(0x123)]:_0x3cf21e(0x134),[constants_1[_0x3cf21e(0x156)]+_0x3cf21e(0x136)]:_0x3cf21e(0x100),[constants_1[_0x3cf21e(0x156)]+_0x3cf21e(0x159)]:_0x25ba5e},_0x389bd5={[constants_1['FLOSUM_NAMESPACE']+_0x3cf21e(0x120)]:!_0x47612e,[constants_1[_0x3cf21e(0x156)]+'Succeed__c']:_0x47612e,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x24ef75?status_enums_1[_0x3cf21e(0x10c)]['EXCEPTION']:status_enums_1[_0x3cf21e(0x10c)][_0x3cf21e(0x12b)],[constants_1[_0x3cf21e(0x156)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x3cf21e(0x119)]:_0xa633c2};await this[_0x3cf21e(0x14b)]['patch'](flosum_constants_1['FlosumConstants'][_0x3cf21e(0x115)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x3cf21e(0x153)+this[_0x3cf21e(0x131)],_0x389bd5),await this['_connectionSalesforce'][_0x3cf21e(0x132)](flosum_constants_1[_0x3cf21e(0x15f)][_0x3cf21e(0x115)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x3cf21e(0xfc),_0x1f79f5),this[_0x3cf21e(0x10f)][_0x3cf21e(0xed)]('Rollback\x20completed\x20'+(_0x47612e?_0x3cf21e(0x148):_0x3cf21e(0x145))+'.'),await this[_0x3cf21e(0x10f)]['updateLog']();}async['execute'](){const _0x2a78e4=a361_0x500fc7;try{this[_0x2a78e4(0x12f)]=await this[_0x2a78e4(0xe2)]();const _0x471288=await this[_0x2a78e4(0x114)]();await this['_logger'][_0x2a78e4(0xe8)]();const _0x1e71c6=await this[_0x2a78e4(0xdc)](_0x471288),_0x1b3550=await this['createVpk'](_0x1e71c6);await this[_0x2a78e4(0x10f)]['updateLog']();const _0x25f70a=await this[_0x2a78e4(0x151)][_0x2a78e4(0x108)](_0x1b3550);await this[_0x2a78e4(0x10f)][_0x2a78e4(0xe8)]();const _0x1a4561=this[_0x2a78e4(0xef)](_0x25f70a[_0x2a78e4(0x116)]);await this['saveDeploymentResults'](_0x1a4561),await this[_0x2a78e4(0x129)](_0x25f70a['isDeployed'],![],_0x25f70a[_0x2a78e4(0xff)]);}catch(_0x380373){await this[_0x2a78e4(0x139)](_0x380373)[_0x2a78e4(0x15e)](_0x381cdb=>this[_0x2a78e4(0xec)][_0x2a78e4(0x125)](_0x381cdb));}}}exports[a361_0x500fc7(0xf8)]=RollbackService;