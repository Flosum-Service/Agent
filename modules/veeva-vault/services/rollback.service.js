const a404_0x24b71f=a404_0x10a4;(function(_0x1e77c9,_0x2a72c7){const _0x27dccc=a404_0x10a4,_0x5be0bd=_0x1e77c9();while(!![]){try{const _0x583453=parseInt(_0x27dccc(0x1d0))/0x1+parseInt(_0x27dccc(0x1b4))/0x2*(parseInt(_0x27dccc(0x1e6))/0x3)+-parseInt(_0x27dccc(0x1e8))/0x4+parseInt(_0x27dccc(0x1db))/0x5*(-parseInt(_0x27dccc(0x1cd))/0x6)+-parseInt(_0x27dccc(0x1e7))/0x7+parseInt(_0x27dccc(0x1ff))/0x8+-parseInt(_0x27dccc(0x1f0))/0x9*(-parseInt(_0x27dccc(0x18b))/0xa);if(_0x583453===_0x2a72c7)break;else _0x5be0bd['push'](_0x5be0bd['shift']());}catch(_0x2f522f){_0x5be0bd['push'](_0x5be0bd['shift']());}}}(a404_0x5e19,0x33c80));function a404_0x10a4(_0x41ceaa,_0x231d6b){const _0x2d425a=a404_0x5e19();return a404_0x10a4=function(_0x5e10c0,_0x388ddf){_0x5e10c0=_0x5e10c0-0x17a;let _0x5e19b4=_0x2d425a[_0x5e10c0];return _0x5e19b4;},a404_0x10a4(_0x41ceaa,_0x231d6b);}function a404_0x5e19(){const _0x55c58e=['_connectionSalesforce','RollbackService','FlosumConstants','log','Retrieve\x20Metadata\x20Log\x20info','DEPLOYED','../classes/retrievers/deployment-results/id.deployment-result.retriever','catch','Result__c','_instanceUrl','../constants/flosum.constants','_timeZone','/vpk__','packageComponentList','740RUBUKw','ENDPOINT_UPSERT_RECORD','retrieve','Component_Name__c','_attachmentLogId','default','status','filter','Logger','Save\x20Deployment\x20Results','./salesforce.service','BACKUP_ZIP_NAME','import','insertMultipleRecords','error','constructor','../../../constants','External_Deployment_Id__c','Cannot\x20find\x20Backup\x20Zip','finishRollback','_vpkService','fs/promises','length','\x20:\x20','Form\x20Deployment\x20Results','6xrQGZt','Branch','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','199005wpTHWj','SalesforceDmlError','flat','../classes/errors/salesforce-dml-error','retrieveBackup','bind','generate','../../../core','FLOSUM_NAMESPACE','success','createZip','1224275fviguZ','\x27\x0a\x20\x20\x20\x20','_veevaService','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','patch','Metadata_Log__c','toString','_logger','Action__c','retrieveRecords','organizationId','60OlxNGs','438522YieJpo','257948xUukBU','Deployment','Component_Type__c','ZipCreatorRollback','from','map','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','name','6471UDiJht','Job_Completed__c','fetchAttachmentsDetailsById','_componentIds','Rollback\x20completed\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','../classes/rollback/zip-creator.rollback','Create\x20zip\x20from\x20backup','createVpk','defineProperty','successfully','Success','finishRollbackWithError','_metadataLogId','post','939208jONJzv','\x20of\x20branch\x20to\x20Organization\x20','Status__c','type','MetadataLogStatus','isDeployed','slice','MetadataLogDto','\x27\x20AND\x20Name\x20=\x20\x27','Retrieve\x20Deployment\x20Results','_tempFolder','Branch__c','_parentMetadataLogId','Type__c','saveLog','errors','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Date__c','retrieveAttachments','lastIndexOf','Failure','create','SalesforceService','\x20</a>','logError','execute','__importDefault','../../shared/utils/fetch-attachments','Retrieve\x20Backup','3620WIrcSO','_salesforceService','retrieveDeploymentResults','Activity_Type__c','Org__c','_packageImportService','__esModule','./package-import.service','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','with\x20error','<a\x20href=','Is_Error__c','VpkService','Cannot\x20find\x20Deployment\x20Results','updateLog','retrieveMetadataLog','packageId','/Attachment','Create\x20Vpk\x20package','_metadataLog','./veeva.service','PackageComponentStatus','search','deploymentAction','saveDeploymentResults','_systemLogger','TargetId__c'];a404_0x5e19=function(){return _0x55c58e;};return a404_0x5e19();}const a404_0x388ddf=(function(){let _0x1f2948=!![];return function(_0xc09e9d,_0x8265fd){const _0x486b5e=_0x1f2948?function(){if(_0x8265fd){const _0x3dd17d=_0x8265fd['apply'](_0xc09e9d,arguments);return _0x8265fd=null,_0x3dd17d;}}:function(){};return _0x1f2948=![],_0x486b5e;};}()),a404_0x5e10c0=a404_0x388ddf(this,function(){const _0x4e16e7=a404_0x10a4;return a404_0x5e10c0['toString']()[_0x4e16e7(0x1a1)]('(((.+)+)+)+$')[_0x4e16e7(0x1e1)]()[_0x4e16e7(0x1c3)](a404_0x5e10c0)[_0x4e16e7(0x1a1)]('(((.+)+)+)+$');});a404_0x5e10c0();'use strict';var __importDefault=this&&this[a404_0x24b71f(0x188)]||function(_0x26c86e){return _0x26c86e&&_0x26c86e['__esModule']?_0x26c86e:{'default':_0x26c86e};};Object[a404_0x24b71f(0x1f9)](exports,a404_0x24b71f(0x191),{'value':!![]}),exports[a404_0x24b71f(0x1a7)]=void 0x0;const veeva_service_1=require(a404_0x24b71f(0x19f)),salesforce_service_1=require(a404_0x24b71f(0x1be)),package_import_service_1=require(a404_0x24b71f(0x192)),id_deployment_result_retriever_1=require(a404_0x24b71f(0x1ac)),flosum_constants_1=require(a404_0x24b71f(0x1b0)),fetch_attachments_1=require(a404_0x24b71f(0x189)),constants_1=require(a404_0x24b71f(0x1c4)),zip_creator_rollback_1=require(a404_0x24b71f(0x1f6)),shortid_1=__importDefault(require('shortid')),promises_1=require(a404_0x24b71f(0x1c9)),vpk_service_1=require('./vpk.service'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a404_0x24b71f(0x1d3)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a404_0x24b71f(0x1d7));class RollbackService{constructor({connectionSalesforce:_0x3478f2,connectionVeeva:_0x3a0a6d,logger:_0x2d772f,tempFolder:_0x53b2bd,instanceUrl:_0x57ccff,timeZone:_0x537286,metadataLogId:_0xd61f,attachmentLogId:_0x3f2677,parentMetadataLogId:_0x5a54a2,componentIds:_0xb2d70d}){const _0x5aeb8f=a404_0x24b71f;this[_0x5aeb8f(0x1a6)]=_0x3478f2,this['_connectionVeeva']=_0x3a0a6d,this[_0x5aeb8f(0x1e2)]=_0x2d772f,this[_0x5aeb8f(0x209)]=_0x53b2bd,this[_0x5aeb8f(0x1af)]=_0x57ccff,this[_0x5aeb8f(0x1b1)]=_0x537286,this['_metadataLogId']=_0xd61f,this[_0x5aeb8f(0x1b8)]=_0x3f2677,this[_0x5aeb8f(0x17a)]=_0x5a54a2,this['_componentIds']=_0xb2d70d,this['_systemLogger']=new core_1[(_0x5aeb8f(0x1bc))]('veeva-rollback'),this[_0x5aeb8f(0x1dd)]=new veeva_service_1['VeevaService']({'connection':_0x3a0a6d,'logger':_0x2d772f}),this['_salesforceService']=new salesforce_service_1[(_0x5aeb8f(0x184))]({'connection':_0x3478f2}),this[_0x5aeb8f(0x190)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x5aeb8f(0x1dd)],'connection':_0x3a0a6d,'logger':_0x2d772f,'saveLog':this[_0x5aeb8f(0x17c)][_0x5aeb8f(0x1d5)](this)}),this['_vpkService']=new vpk_service_1[(_0x5aeb8f(0x197))]({'connection':_0x3a0a6d});}async['saveLog'](_0x5bf7f5,_0x43eae1){const _0x45f155=a404_0x24b71f;this[_0x45f155(0x1e2)][_0x45f155(0x1a9)]('Save\x20log');const _0x563db6={'Body':Buffer[_0x45f155(0x1ec)](_0x5bf7f5)[_0x45f155(0x1e1)]('base64'),'ContentType':'text/plain','ParentId':this[_0x45f155(0x1fd)],'Name':_0x43eae1};await this['_connectionSalesforce'][_0x45f155(0x1fe)](flosum_constants_1[_0x45f155(0x1a8)][_0x45f155(0x1b5)]+_0x45f155(0x19c),_0x563db6);}async[a404_0x24b71f(0x19a)](){const _0xf72960=a404_0x24b71f;this[_0xf72960(0x1e2)][_0xf72960(0x1a9)](_0xf72960(0x1aa));const [_0x3f1bac]=await this[_0xf72960(0x18c)][_0xf72960(0x1e4)](_0xf72960(0x193)+constants_1['FLOSUM_NAMESPACE']+_0xf72960(0x17e)+constants_1['FLOSUM_NAMESPACE']+_0xf72960(0x1cf)+constants_1[_0xf72960(0x1d8)]+_0xf72960(0x1de)+constants_1[_0xf72960(0x1d8)]+_0xf72960(0x1ee)+this['_metadataLogId']+_0xf72960(0x1dc));return new metadata_log_dto_1[(_0xf72960(0x206))](_0x3f1bac);}async[a404_0x24b71f(0x18d)](){const _0x44434e=a404_0x24b71f;this[_0x44434e(0x1e2)]['log'](_0x44434e(0x208));const _0x521d37=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x44434e(0x18c)],'value':this[_0x44434e(0x1f3)]})[_0x44434e(0x1b6)]();if(!_0x521d37['length'])throw new Error(_0x44434e(0x198));return _0x521d37;}async[a404_0x24b71f(0x1d4)](){const _0x490f25=a404_0x24b71f;this['_logger'][_0x490f25(0x1a9)](_0x490f25(0x18a));const _0x2570cd=await this['_salesforceService'][_0x490f25(0x1e4)](_0x490f25(0x1f5)+this[_0x490f25(0x17a)]+_0x490f25(0x207)+flosum_constants_1[_0x490f25(0x1a8)][_0x490f25(0x1bf)]+_0x490f25(0x1dc)),_0x2e907c=await(0x0,fetch_attachments_1[_0x490f25(0x1f2)])(this[_0x490f25(0x1a6)],[_0x2570cd[0x0]['Id']]),_0x55578e=await(0x0,fetch_attachments_1[_0x490f25(0x180)])(_0x2e907c,this[_0x490f25(0x1a6)]);if(!_0x55578e[_0x490f25(0x1ca)])throw new Error(_0x490f25(0x1c6));return _0x55578e[0x0]['values']['Body'];}async['createZip'](_0x16c62a){const _0x1408d9=a404_0x24b71f;this[_0x1408d9(0x1e2)]['log'](_0x1408d9(0x1f7));const _0x178795=await this[_0x1408d9(0x1d4)](),_0x317cb9=await new zip_creator_rollback_1[(_0x1408d9(0x1eb))]({'rollbackName':this[_0x1408d9(0x19e)][_0x1408d9(0x1ef)],'backup':_0x178795,'deploymentResults':_0x16c62a})[_0x1408d9(0x183)](),_0x46e31b=this[_0x1408d9(0x209)]+'/'+(0x0,shortid_1[_0x1408d9(0x1b9)])()+'.zip';return await(0x0,promises_1['writeFile'])(_0x46e31b,_0x317cb9),_0x46e31b;}async[a404_0x24b71f(0x1f8)](_0x3655df){const _0x2f508c=a404_0x24b71f;this[_0x2f508c(0x1e2)]['log'](_0x2f508c(0x19d));const _0x43670f=await this[_0x2f508c(0x1c8)][_0x2f508c(0x1d6)](_0x3655df),_0x5eacaa=this[_0x2f508c(0x209)]+_0x2f508c(0x1b2)+_0x3655df[_0x2f508c(0x205)](_0x3655df[_0x2f508c(0x181)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x5eacaa,_0x43670f),await this[_0x2f508c(0x1c8)]['validate'](_0x5eacaa),_0x5eacaa;}['formFlosumDeploymentResults'](_0x320174){const _0x40fb70=a404_0x24b71f;return this[_0x40fb70(0x1e2)][_0x40fb70(0x1a9)](_0x40fb70(0x1cc)),_0x320174[_0x40fb70(0x1ed)](_0x2a10d5=>{const _0x1d3b37=_0x40fb70;return this['_logger'][_0x1d3b37(0x1a9)](_0x2a10d5[_0x1d3b37(0x202)]+'.'+_0x2a10d5['name']+_0x1d3b37(0x1cb)+_0x2a10d5['status']),{[constants_1['FLOSUM_NAMESPACE']+_0x1d3b37(0x17b)]:'Deployment\x20Result',[constants_1[_0x1d3b37(0x1d8)]+_0x1d3b37(0x201)]:_0x2a10d5[_0x1d3b37(0x1ba)]===status_enums_1[_0x1d3b37(0x1a0)][_0x1d3b37(0x1ab)]?_0x1d3b37(0x1fb):_0x1d3b37(0x182),[constants_1[_0x1d3b37(0x1d8)]+_0x1d3b37(0x1ae)]:_0x2a10d5[_0x1d3b37(0x1a2)],[constants_1['FLOSUM_NAMESPACE']+_0x1d3b37(0x1b7)]:_0x2a10d5['name'],[constants_1[_0x1d3b37(0x1d8)]+_0x1d3b37(0x1ea)]:_0x2a10d5['type'],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Step_Name__c']:_0x2a10d5['stepName'],[constants_1[_0x1d3b37(0x1d8)]+_0x1d3b37(0x18f)]:this[_0x1d3b37(0x19e)][_0x1d3b37(0x1e5)],[constants_1[_0x1d3b37(0x1d8)]+_0x1d3b37(0x1e0)]:this[_0x1d3b37(0x1fd)]};});}async[a404_0x24b71f(0x1a3)](_0x18443c){const _0x26d8b9=a404_0x24b71f;this[_0x26d8b9(0x1e2)][_0x26d8b9(0x1a9)](_0x26d8b9(0x1bd));const _0xa595cd=await this[_0x26d8b9(0x18c)][_0x26d8b9(0x1c1)](constants_1[_0x26d8b9(0x1d8)]+'Deployment_Result__c',_0x18443c),_0x5debfe=_0xa595cd[_0x26d8b9(0x1bb)](_0x3f408e=>!_0x3f408e[_0x26d8b9(0x1d9)])[_0x26d8b9(0x1ed)](_0x3adc83=>_0x3adc83[_0x26d8b9(0x17d)])[_0x26d8b9(0x1d2)]();if(_0x5debfe[_0x26d8b9(0x1ca)])throw new salesforce_dml_error_1[(_0x26d8b9(0x1d1))](_0x5debfe);}async['finishRollbackWithError'](_0x4b8a4c){const _0x153fc2=a404_0x24b71f;if(!this[_0x153fc2(0x19e)]){this[_0x153fc2(0x1a4)]['error'](_0x4b8a4c);return;}this[_0x153fc2(0x1e2)][_0x153fc2(0x186)](_0x4b8a4c),await this[_0x153fc2(0x1e2)][_0x153fc2(0x199)](),await this['finishRollback'](![],!![],'');}async[a404_0x24b71f(0x1c7)](_0x40f38a,_0x26f53a,_0x4868e6){const _0x366da5=a404_0x24b71f,{id:_0x238464,organizationId:_0x18b64e,branchId:_0x565063,organizationName:_0x4bd597}=this[_0x366da5(0x19e)],_0x1a482d=_0x366da5(0x195)+this[_0x366da5(0x1af)]+'/'+_0x238464+'\x20>\x20'+'Veeva\x20Rollback\x20(Deployment)'+_0x366da5(0x185),_0x165b70=_0x366da5(0x195)+this['_instanceUrl']+'/'+_0x18b64e+'\x20>'+_0x4bd597+'</a>',_0x4a6ade=_0x1a482d+_0x366da5(0x200)+_0x165b70+'\x20has\x20been\x20created.',_0x288678={[constants_1[_0x366da5(0x1d8)]+_0x366da5(0x1e3)]:_0x4a6ade,[constants_1[_0x366da5(0x1d8)]+_0x366da5(0x17f)]:new Date(),[constants_1[_0x366da5(0x1d8)]+_0x366da5(0x20a)]:_0x565063,[constants_1[_0x366da5(0x1d8)]+'Activity_Item__c']:_0x366da5(0x1ce),[constants_1['FLOSUM_NAMESPACE']+_0x366da5(0x18e)]:_0x366da5(0x1e9),[constants_1[_0x366da5(0x1d8)]+_0x366da5(0x1a5)]:_0x18b64e},_0x42b6bc={[constants_1['FLOSUM_NAMESPACE']+_0x366da5(0x196)]:!_0x40f38a,[constants_1[_0x366da5(0x1d8)]+'Succeed__c']:_0x40f38a,[constants_1[_0x366da5(0x1d8)]+_0x366da5(0x201)]:_0x26f53a?status_enums_1[_0x366da5(0x203)]['EXCEPTION']:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x366da5(0x1d8)]+_0x366da5(0x1f1)]:!![],[constants_1[_0x366da5(0x1d8)]+_0x366da5(0x1c5)]:_0x4868e6};await this[_0x366da5(0x1a6)][_0x366da5(0x1df)](flosum_constants_1[_0x366da5(0x1a8)][_0x366da5(0x1b5)]+'/'+constants_1[_0x366da5(0x1d8)]+'Metadata_Log__c/'+this[_0x366da5(0x1fd)],_0x42b6bc),await this[_0x366da5(0x1a6)]['post'](flosum_constants_1[_0x366da5(0x1a8)][_0x366da5(0x1b5)]+'/'+constants_1[_0x366da5(0x1d8)]+'Log__c',_0x288678),this[_0x366da5(0x1e2)]['log'](_0x366da5(0x1f4)+(_0x40f38a?_0x366da5(0x1fa):_0x366da5(0x194))+'.'),await this[_0x366da5(0x1e2)][_0x366da5(0x199)]();}async[a404_0x24b71f(0x187)](){const _0x53a26e=a404_0x24b71f;try{this[_0x53a26e(0x19e)]=await this[_0x53a26e(0x19a)]();const _0x55330f=await this[_0x53a26e(0x18d)]();await this['_logger'][_0x53a26e(0x199)]();const _0xcf98cd=await this[_0x53a26e(0x1da)](_0x55330f),_0x2a2fd1=await this[_0x53a26e(0x1f8)](_0xcf98cd);await this['_logger'][_0x53a26e(0x199)]();const _0x2bb127=await this['_packageImportService'][_0x53a26e(0x1c0)](_0x2a2fd1);await this[_0x53a26e(0x1e2)]['updateLog']();const _0xb7dc2=this['formFlosumDeploymentResults'](_0x2bb127[_0x53a26e(0x1b3)]);await this[_0x53a26e(0x1a3)](_0xb7dc2),await this[_0x53a26e(0x1c7)](_0x2bb127[_0x53a26e(0x204)],![],_0x2bb127[_0x53a26e(0x19b)]);}catch(_0x4ecce2){await this[_0x53a26e(0x1fc)](_0x4ecce2)[_0x53a26e(0x1ad)](_0x5d8681=>this[_0x53a26e(0x1a4)][_0x53a26e(0x1c2)](_0x5d8681));}}}exports[a404_0x24b71f(0x1a7)]=RollbackService;