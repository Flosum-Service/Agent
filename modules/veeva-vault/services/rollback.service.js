const a377_0x3efd06=a377_0x20b2;(function(_0x10b032,_0x1bded6){const _0xd253a0=a377_0x20b2,_0x1423ee=_0x10b032();while(!![]){try{const _0x2656d9=-parseInt(_0xd253a0(0x208))/0x1*(parseInt(_0xd253a0(0x1f4))/0x2)+parseInt(_0xd253a0(0x188))/0x3+-parseInt(_0xd253a0(0x201))/0x4*(parseInt(_0xd253a0(0x1b3))/0x5)+parseInt(_0xd253a0(0x179))/0x6*(-parseInt(_0xd253a0(0x18e))/0x7)+-parseInt(_0xd253a0(0x200))/0x8*(parseInt(_0xd253a0(0x1ad))/0x9)+-parseInt(_0xd253a0(0x1dd))/0xa*(parseInt(_0xd253a0(0x205))/0xb)+-parseInt(_0xd253a0(0x1f3))/0xc*(-parseInt(_0xd253a0(0x1c1))/0xd);if(_0x2656d9===_0x1bded6)break;else _0x1423ee['push'](_0x1423ee['shift']());}catch(_0x201fb2){_0x1423ee['push'](_0x1423ee['shift']());}}}(a377_0x3d80,0xdf571));const a377_0x681bb7=(function(){let _0x2efd25=!![];return function(_0x24965f,_0x2cabfe){const _0x4f63d5=_0x2efd25?function(){if(_0x2cabfe){const _0x6bf8f3=_0x2cabfe['apply'](_0x24965f,arguments);return _0x2cabfe=null,_0x6bf8f3;}}:function(){};return _0x2efd25=![],_0x4f63d5;};}()),a377_0x51f829=a377_0x681bb7(this,function(){const _0x2deaa0=a377_0x20b2;return a377_0x51f829[_0x2deaa0(0x202)]()[_0x2deaa0(0x1e8)](_0x2deaa0(0x180))[_0x2deaa0(0x202)]()[_0x2deaa0(0x17f)](a377_0x51f829)[_0x2deaa0(0x1e8)](_0x2deaa0(0x180));});function a377_0x20b2(_0x59605c,_0x8983a9){const _0x4401ac=a377_0x3d80();return a377_0x20b2=function(_0x51f829,_0x681bb7){_0x51f829=_0x51f829-0x172;let _0x3d8041=_0x4401ac[_0x51f829];return _0x3d8041;},a377_0x20b2(_0x59605c,_0x8983a9);}a377_0x51f829();function a377_0x3d80(){const _0x59fd54=['Create\x20Vpk\x20package','organizationId','\x20</a>','patch','filter','Job_Completed__c','fetchAttachmentsDetailsById','845TYUDnI','COMPLETED','_connectionSalesforce','Component_Type__c','DEPLOYED','Retrieve\x20Metadata\x20Log\x20info','FlosumConstants','finishRollbackWithError','with\x20error','Success','/vpk__','log','retrieveAttachments','Result__c','SalesforceService','.zip','/Attachment','ZipCreatorRollback','_componentIds','_instanceUrl','FLOSUM_NAMESPACE','fs/promises','successfully','packageComponentList','retrieve','./veeva.service','ENDPOINT_UPSERT_RECORD','Activity_Item__c','90TQsZGs','\x20of\x20branch\x20to\x20Organization\x20','writeFile','./package-import.service','status','length','Org__c','finishRollback','../../shared/utils/fetch-attachments','Type__c','Is_Error__c','search','retrieveDeploymentResults','PackageImportService','_salesforceService','MetadataLogDto','MetadataLogStatus','VeevaService','packageId','post','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','_metadataLog','1083540tIyhei','105434oORCMK','_packageImportService','External_Deployment_Id__c','generate','Body','stepName','_connectionVeeva','errors','retrieveBackup','retrieveMetadataLog','../../../constants','VpkService','8898728gIsvcj','984BmxwfZ','toString','../dtos/metadata-log.dto','from','1361679jNCaGw','Deployment_Result__c','Action__c','1mvwJXr','Save\x20Deployment\x20Results','retrieveRecords','../constants/flosum.constants','Deployment\x20Result','../classes/retrievers/deployment-results/id.deployment-result.retriever','createZip','flat','\x20:\x20','7334742bMopwH','shortid','_vpkService','base64','../classes/errors/salesforce-dml-error','error','constructor','(((.+)+)+)+$','saveLog','deploymentAction','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','map','./salesforce.service','_tempFolder','__esModule','631344eLeRNs','SalesforceDmlError','defineProperty','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Activity_Type__c','./vpk.service','7wXCFnD','RollbackService','Deployment','BACKUP_ZIP_NAME','Retrieve\x20Backup','catch','validate','updateLog','Log__c','../enums/status.enums','Veeva\x20Rollback\x20(Deployment)','_logger','name','default','slice','Veeva_Step_Name__c','createVpk','execute','Cannot\x20find\x20Backup\x20Zip','Branch','PackageComponentStatus','Cannot\x20find\x20Deployment\x20Results','Branch__c','Metadata_Log__c','../../../core','_metadataLogId','import','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','type','Form\x20Deployment\x20Results','_veevaService','9lswIvI','formFlosumDeploymentResults','create','Succeed__c','\x27\x20AND\x20Name\x20=\x20\x27','Status__c','33805tgsAiZ','saveDeploymentResults','_systemLogger','\x27\x0a\x20\x20\x20\x20','Save\x20log','<a\x20href=','EXCEPTION'];a377_0x3d80=function(){return _0x59fd54;};return a377_0x3d80();}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x312dc1){return _0x312dc1&&_0x312dc1['__esModule']?_0x312dc1:{'default':_0x312dc1};};Object[a377_0x3efd06(0x18a)](exports,a377_0x3efd06(0x187),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a377_0x3efd06(0x1da)),salesforce_service_1=require(a377_0x3efd06(0x185)),package_import_service_1=require(a377_0x3efd06(0x1e0)),id_deployment_result_retriever_1=require(a377_0x3efd06(0x175)),flosum_constants_1=require(a377_0x3efd06(0x173)),fetch_attachments_1=require(a377_0x3efd06(0x1e5)),constants_1=require(a377_0x3efd06(0x1fe)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a377_0x3efd06(0x17a))),promises_1=require(a377_0x3efd06(0x1d6)),vpk_service_1=require(a377_0x3efd06(0x18d)),status_enums_1=require(a377_0x3efd06(0x197)),salesforce_dml_error_1=require(a377_0x3efd06(0x17d)),metadata_log_dto_1=require(a377_0x3efd06(0x203)),core_1=require(a377_0x3efd06(0x1a6));class RollbackService{constructor({connectionSalesforce:_0x288095,connectionVeeva:_0x2dbced,logger:_0x4369aa,tempFolder:_0x3522aa,instanceUrl:_0x1b5c1a,timeZone:_0x3c12cb,metadataLogId:_0x3e398f,attachmentLogId:_0x1d1d47,parentMetadataLogId:_0x12d8c4,componentIds:_0x42d952}){const _0x408cbf=a377_0x3efd06;this['_connectionSalesforce']=_0x288095,this[_0x408cbf(0x1fa)]=_0x2dbced,this['_logger']=_0x4369aa,this[_0x408cbf(0x186)]=_0x3522aa,this[_0x408cbf(0x1d4)]=_0x1b5c1a,this['_timeZone']=_0x3c12cb,this[_0x408cbf(0x1a7)]=_0x3e398f,this['_attachmentLogId']=_0x1d1d47,this['_parentMetadataLogId']=_0x12d8c4,this[_0x408cbf(0x1d3)]=_0x42d952,this[_0x408cbf(0x1b5)]=new core_1['Logger']('veeva-rollback'),this[_0x408cbf(0x1ac)]=new veeva_service_1[(_0x408cbf(0x1ee))]({'connection':_0x2dbced,'logger':_0x4369aa}),this[_0x408cbf(0x1eb)]=new salesforce_service_1[(_0x408cbf(0x1cf))]({'connection':_0x288095}),this[_0x408cbf(0x1f5)]=new package_import_service_1[(_0x408cbf(0x1ea))]({'veevaService':this[_0x408cbf(0x1ac)],'connection':_0x2dbced,'logger':_0x4369aa,'saveLog':this['saveLog']['bind'](this)}),this[_0x408cbf(0x17b)]=new vpk_service_1[(_0x408cbf(0x1ff))]({'connection':_0x2dbced});}async[a377_0x3efd06(0x181)](_0x39fd87,_0x13775b){const _0x146bb0=a377_0x3efd06;this[_0x146bb0(0x199)][_0x146bb0(0x1cc)](_0x146bb0(0x1b7));const _0x4729a3={'Body':Buffer[_0x146bb0(0x204)](_0x39fd87)[_0x146bb0(0x202)](_0x146bb0(0x17c)),'ContentType':'text/plain','ParentId':this[_0x146bb0(0x1a7)],'Name':_0x13775b};await this[_0x146bb0(0x1c3)][_0x146bb0(0x1f0)](flosum_constants_1[_0x146bb0(0x1c7)][_0x146bb0(0x1db)]+_0x146bb0(0x1d1),_0x4729a3);}async[a377_0x3efd06(0x1fd)](){const _0x46f4d2=a377_0x3efd06;this[_0x46f4d2(0x199)][_0x46f4d2(0x1cc)](_0x46f4d2(0x1c6));const [_0x2dc482]=await this[_0x46f4d2(0x1eb)][_0x46f4d2(0x172)](_0x46f4d2(0x183)+constants_1[_0x46f4d2(0x1d5)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x46f4d2(0x1d5)]+_0x46f4d2(0x1a9)+constants_1[_0x46f4d2(0x1d5)]+_0x46f4d2(0x18b)+constants_1[_0x46f4d2(0x1d5)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x46f4d2(0x1a7)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x46f4d2(0x1ec))](_0x2dc482);}async[a377_0x3efd06(0x1e9)](){const _0x4bd900=a377_0x3efd06;this['_logger'][_0x4bd900(0x1cc)]('Retrieve\x20Deployment\x20Results');const _0x31f6ec=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x4bd900(0x1eb)],'value':this['_componentIds']})[_0x4bd900(0x1d9)]();if(!_0x31f6ec[_0x4bd900(0x1e2)])throw new Error(_0x4bd900(0x1a3));return _0x31f6ec;}async[a377_0x3efd06(0x1fc)](){const _0x1ab92f=a377_0x3efd06;this[_0x1ab92f(0x199)][_0x1ab92f(0x1cc)](_0x1ab92f(0x192));const _0x552f61=await this[_0x1ab92f(0x1eb)][_0x1ab92f(0x172)](_0x1ab92f(0x1f1)+this['_parentMetadataLogId']+_0x1ab92f(0x1b1)+flosum_constants_1[_0x1ab92f(0x1c7)][_0x1ab92f(0x191)]+_0x1ab92f(0x1b6)),_0x32cc79=await(0x0,fetch_attachments_1[_0x1ab92f(0x1c0)])(this[_0x1ab92f(0x1c3)],[_0x552f61[0x0]['Id']]),_0x642061=await(0x0,fetch_attachments_1[_0x1ab92f(0x1cd)])(_0x32cc79,this['_connectionSalesforce']);if(!_0x642061['length'])throw new Error(_0x1ab92f(0x1a0));return _0x642061[0x0]['values'][_0x1ab92f(0x1f8)];}async[a377_0x3efd06(0x176)](_0x2069b4){const _0x144f8e=a377_0x3efd06;this[_0x144f8e(0x199)][_0x144f8e(0x1cc)]('Create\x20zip\x20from\x20backup');const _0x464b97=await this[_0x144f8e(0x1fc)](),_0xfa2dca=await new zip_creator_rollback_1[(_0x144f8e(0x1d2))]({'rollbackName':this['_metadataLog']['name'],'backup':_0x464b97,'deploymentResults':_0x2069b4})[_0x144f8e(0x1af)](),_0x38a2a7=this[_0x144f8e(0x186)]+'/'+(0x0,shortid_1[_0x144f8e(0x19b)])()+_0x144f8e(0x1d0);return await(0x0,promises_1[_0x144f8e(0x1df)])(_0x38a2a7,_0xfa2dca),_0x38a2a7;}async[a377_0x3efd06(0x19e)](_0x569eef){const _0x594210=a377_0x3efd06;this[_0x594210(0x199)][_0x594210(0x1cc)](_0x594210(0x1ba));const _0x1f19fe=await this[_0x594210(0x17b)][_0x594210(0x1f7)](_0x569eef),_0x457c6a=this[_0x594210(0x186)]+_0x594210(0x1cb)+_0x569eef[_0x594210(0x19c)](_0x569eef['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x457c6a,_0x1f19fe),await this['_vpkService'][_0x594210(0x194)](_0x457c6a),_0x457c6a;}['formFlosumDeploymentResults'](_0x54b836){const _0x281d00=a377_0x3efd06;return this[_0x281d00(0x199)]['log'](_0x281d00(0x1ab)),_0x54b836[_0x281d00(0x184)](_0x57a1f7=>{const _0x5ee7c2=_0x281d00;return this[_0x5ee7c2(0x199)][_0x5ee7c2(0x1cc)](_0x57a1f7[_0x5ee7c2(0x1aa)]+'.'+_0x57a1f7[_0x5ee7c2(0x19a)]+_0x5ee7c2(0x178)+_0x57a1f7[_0x5ee7c2(0x1e1)]),{[constants_1[_0x5ee7c2(0x1d5)]+_0x5ee7c2(0x1e6)]:_0x5ee7c2(0x174),[constants_1[_0x5ee7c2(0x1d5)]+_0x5ee7c2(0x1b2)]:_0x57a1f7[_0x5ee7c2(0x1e1)]===status_enums_1[_0x5ee7c2(0x1a2)][_0x5ee7c2(0x1c5)]?_0x5ee7c2(0x1ca):'Failure',[constants_1['FLOSUM_NAMESPACE']+_0x5ee7c2(0x1ce)]:_0x57a1f7[_0x5ee7c2(0x182)],[constants_1[_0x5ee7c2(0x1d5)]+'Component_Name__c']:_0x57a1f7[_0x5ee7c2(0x19a)],[constants_1[_0x5ee7c2(0x1d5)]+_0x5ee7c2(0x1c4)]:_0x57a1f7[_0x5ee7c2(0x1aa)],[constants_1['FLOSUM_NAMESPACE']+_0x5ee7c2(0x19d)]:_0x57a1f7[_0x5ee7c2(0x1f9)],[constants_1['FLOSUM_NAMESPACE']+_0x5ee7c2(0x1e3)]:this[_0x5ee7c2(0x1f2)][_0x5ee7c2(0x1bb)],[constants_1[_0x5ee7c2(0x1d5)]+_0x5ee7c2(0x1a5)]:this[_0x5ee7c2(0x1a7)]};});}async[a377_0x3efd06(0x1b4)](_0x55f7cc){const _0x2b7296=a377_0x3efd06;this[_0x2b7296(0x199)][_0x2b7296(0x1cc)](_0x2b7296(0x209));const _0x53881d=await this[_0x2b7296(0x1eb)]['insertMultipleRecords'](constants_1[_0x2b7296(0x1d5)]+_0x2b7296(0x206),_0x55f7cc),_0x59ee78=_0x53881d[_0x2b7296(0x1be)](_0x2f0363=>!_0x2f0363['success'])['map'](_0x2a2d19=>_0x2a2d19[_0x2b7296(0x1fb)])[_0x2b7296(0x177)]();if(_0x59ee78[_0x2b7296(0x1e2)])throw new salesforce_dml_error_1[(_0x2b7296(0x189))](_0x59ee78);}async['finishRollbackWithError'](_0x3f5b14){const _0x4b6bc4=a377_0x3efd06;if(!this[_0x4b6bc4(0x1f2)]){this['_systemLogger'][_0x4b6bc4(0x17e)](_0x3f5b14);return;}this[_0x4b6bc4(0x199)]['logError'](_0x3f5b14),await this[_0x4b6bc4(0x199)][_0x4b6bc4(0x195)](),await this[_0x4b6bc4(0x1e4)](![],!![],'');}async[a377_0x3efd06(0x1e4)](_0x39493e,_0x484ae4,_0xb6d2aa){const _0x44795b=a377_0x3efd06,{id:_0x1f5ff4,organizationId:_0x411eb3,branchId:_0xb06b6b,organizationName:_0xf58a13}=this[_0x44795b(0x1f2)],_0x9464d=_0x44795b(0x1b8)+this[_0x44795b(0x1d4)]+'/'+_0x1f5ff4+'\x20>\x20'+_0x44795b(0x198)+_0x44795b(0x1bc),_0x29dac6=_0x44795b(0x1b8)+this[_0x44795b(0x1d4)]+'/'+_0x411eb3+'\x20>'+_0xf58a13+'</a>',_0x407e9d=_0x9464d+_0x44795b(0x1de)+_0x29dac6+'\x20has\x20been\x20created.',_0x15cef1={[constants_1[_0x44795b(0x1d5)]+_0x44795b(0x207)]:_0x407e9d,[constants_1['FLOSUM_NAMESPACE']+'Date__c']:new Date(),[constants_1[_0x44795b(0x1d5)]+_0x44795b(0x1a4)]:_0xb06b6b,[constants_1[_0x44795b(0x1d5)]+_0x44795b(0x1dc)]:_0x44795b(0x1a1),[constants_1[_0x44795b(0x1d5)]+_0x44795b(0x18c)]:_0x44795b(0x190),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:_0x411eb3},_0x64745a={[constants_1[_0x44795b(0x1d5)]+_0x44795b(0x1e7)]:!_0x39493e,[constants_1[_0x44795b(0x1d5)]+_0x44795b(0x1b0)]:_0x39493e,[constants_1['FLOSUM_NAMESPACE']+_0x44795b(0x1b2)]:_0x484ae4?status_enums_1[_0x44795b(0x1ed)][_0x44795b(0x1b9)]:status_enums_1[_0x44795b(0x1ed)][_0x44795b(0x1c2)],[constants_1['FLOSUM_NAMESPACE']+_0x44795b(0x1bf)]:!![],[constants_1[_0x44795b(0x1d5)]+_0x44795b(0x1f6)]:_0xb6d2aa};await this[_0x44795b(0x1c3)][_0x44795b(0x1bd)](flosum_constants_1['FlosumConstants'][_0x44795b(0x1db)]+'/'+constants_1[_0x44795b(0x1d5)]+'Metadata_Log__c/'+this[_0x44795b(0x1a7)],_0x64745a),await this[_0x44795b(0x1c3)][_0x44795b(0x1f0)](flosum_constants_1[_0x44795b(0x1c7)][_0x44795b(0x1db)]+'/'+constants_1[_0x44795b(0x1d5)]+_0x44795b(0x196),_0x15cef1),this[_0x44795b(0x199)][_0x44795b(0x1cc)]('Rollback\x20completed\x20'+(_0x39493e?_0x44795b(0x1d7):_0x44795b(0x1c9))+'.'),await this['_logger'][_0x44795b(0x195)]();}async[a377_0x3efd06(0x19f)](){const _0x359b7f=a377_0x3efd06;try{this[_0x359b7f(0x1f2)]=await this[_0x359b7f(0x1fd)]();const _0x1031fe=await this['retrieveDeploymentResults']();await this['_logger'][_0x359b7f(0x195)]();const _0x320ad9=await this['createZip'](_0x1031fe),_0x424dc8=await this[_0x359b7f(0x19e)](_0x320ad9);await this['_logger'][_0x359b7f(0x195)]();const _0x273262=await this['_packageImportService'][_0x359b7f(0x1a8)](_0x424dc8);await this['_logger'][_0x359b7f(0x195)]();const _0x512d49=this[_0x359b7f(0x1ae)](_0x273262[_0x359b7f(0x1d8)]);await this[_0x359b7f(0x1b4)](_0x512d49),await this['finishRollback'](_0x273262['isDeployed'],![],_0x273262[_0x359b7f(0x1ef)]);}catch(_0x1f3068){await this[_0x359b7f(0x1c8)](_0x1f3068)[_0x359b7f(0x193)](_0x5695a4=>this[_0x359b7f(0x1b5)][_0x359b7f(0x17e)](_0x5695a4));}}}exports[a377_0x3efd06(0x18f)]=RollbackService;