const a337_0x882d73=a337_0x2342;(function(_0x4bf455,_0x23e9e8){const _0x1c9c80=a337_0x2342,_0x499398=_0x4bf455();while(!![]){try{const _0x15ac71=parseInt(_0x1c9c80(0x1af))/0x1+parseInt(_0x1c9c80(0x1df))/0x2+parseInt(_0x1c9c80(0x1aa))/0x3+parseInt(_0x1c9c80(0x19f))/0x4+-parseInt(_0x1c9c80(0x1c2))/0x5+-parseInt(_0x1c9c80(0x1c5))/0x6*(-parseInt(_0x1c9c80(0x19d))/0x7)+parseInt(_0x1c9c80(0x1c9))/0x8*(-parseInt(_0x1c9c80(0x1ef))/0x9);if(_0x15ac71===_0x23e9e8)break;else _0x499398['push'](_0x499398['shift']());}catch(_0x2761d6){_0x499398['push'](_0x499398['shift']());}}}(a337_0x4c07,0xab107));const a337_0x588307=(function(){let _0x520dfc=!![];return function(_0x2eb1ce,_0x2b7d45){const _0x390968=_0x520dfc?function(){const _0x24b118=a337_0x2342;if(_0x2b7d45){const _0x53036d=_0x2b7d45[_0x24b118(0x1fe)](_0x2eb1ce,arguments);return _0x2b7d45=null,_0x53036d;}}:function(){};return _0x520dfc=![],_0x390968;};}()),a337_0x210e35=a337_0x588307(this,function(){const _0xe90ee6=a337_0x2342;return a337_0x210e35[_0xe90ee6(0x1f9)]()['search'](_0xe90ee6(0x1d2))[_0xe90ee6(0x1f9)]()['constructor'](a337_0x210e35)[_0xe90ee6(0x213)](_0xe90ee6(0x1d2));});a337_0x210e35();'use strict';function a337_0x2342(_0x4ee239,_0x2b4738){const _0x34fac7=a337_0x4c07();return a337_0x2342=function(_0x210e35,_0x588307){_0x210e35=_0x210e35-0x188;let _0x4c07c3=_0x34fac7[_0x210e35];return _0x4c07c3;},a337_0x2342(_0x4ee239,_0x2b4738);}var __importDefault=this&&this[a337_0x882d73(0x1eb)]||function(_0x19d5b6){const _0x34126f=a337_0x882d73;return _0x19d5b6&&_0x19d5b6[_0x34126f(0x1a3)]?_0x19d5b6:{'default':_0x19d5b6};};Object[a337_0x882d73(0x1d4)](exports,a337_0x882d73(0x1a3),{'value':!![]}),exports[a337_0x882d73(0x1c4)]=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a337_0x882d73(0x1e3)),package_import_service_1=require(a337_0x882d73(0x1a0)),id_deployment_result_retriever_1=require(a337_0x882d73(0x1cf)),flosum_constants_1=require(a337_0x882d73(0x1b0)),fetch_attachments_1=require(a337_0x882d73(0x1ee)),constants_1=require(a337_0x882d73(0x1d7)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require('shortid')),promises_1=require(a337_0x882d73(0x1e6)),vpk_service_1=require('./vpk.service'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a337_0x882d73(0x1f5)),core_1=require(a337_0x882d73(0x194));class RollbackService{constructor({connectionSalesforce:_0x16a3be,connectionVeeva:_0x38082a,logger:_0x2806ab,tempFolder:_0x576159,instanceUrl:_0x5653a1,timeZone:_0x393c2c,metadataLogId:_0x35d6a5,attachmentLogId:_0x406c78,parentMetadataLogId:_0x28b24f,componentIds:_0x152c8e}){const _0x297b3f=a337_0x882d73;this['_connectionSalesforce']=_0x16a3be,this[_0x297b3f(0x1fa)]=_0x38082a,this[_0x297b3f(0x209)]=_0x2806ab,this['_tempFolder']=_0x576159,this[_0x297b3f(0x1f1)]=_0x5653a1,this[_0x297b3f(0x19a)]=_0x393c2c,this['_metadataLogId']=_0x35d6a5,this['_attachmentLogId']=_0x406c78,this['_parentMetadataLogId']=_0x28b24f,this[_0x297b3f(0x1cc)]=_0x152c8e,this[_0x297b3f(0x1c0)]=new core_1[(_0x297b3f(0x210))](_0x297b3f(0x1ff)),this[_0x297b3f(0x192)]=new veeva_service_1[(_0x297b3f(0x1c3))]({'connection':_0x38082a,'logger':_0x2806ab}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':_0x16a3be}),this['_packageImportService']=new package_import_service_1[(_0x297b3f(0x1ec))]({'veevaService':this[_0x297b3f(0x192)],'connection':_0x38082a,'logger':_0x2806ab,'saveLog':this['saveLog'][_0x297b3f(0x1b6)](this)}),this[_0x297b3f(0x1e4)]=new vpk_service_1[(_0x297b3f(0x1ab))]({'connection':_0x38082a});}async[a337_0x882d73(0x1d1)](_0x26d23b,_0x504bdb){const _0x362b70=a337_0x882d73;this[_0x362b70(0x209)]['log'](_0x362b70(0x1bf));const _0x1ad6fb={'Body':Buffer['from'](_0x26d23b)[_0x362b70(0x1f9)](_0x362b70(0x207)),'ContentType':_0x362b70(0x20a),'ParentId':this[_0x362b70(0x18e)],'Name':_0x504bdb};await this['_connectionSalesforce'][_0x362b70(0x1b9)](flosum_constants_1[_0x362b70(0x1f7)][_0x362b70(0x1b3)]+_0x362b70(0x1ae),_0x1ad6fb);}async[a337_0x882d73(0x200)](){const _0x4b1bc6=a337_0x882d73;this[_0x4b1bc6(0x209)]['log'](_0x4b1bc6(0x1f6));const [_0x54303f]=await this[_0x4b1bc6(0x190)][_0x4b1bc6(0x203)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x4b1bc6(0x1d0)]+_0x4b1bc6(0x20b)+constants_1['FLOSUM_NAMESPACE']+_0x4b1bc6(0x1db)+constants_1['FLOSUM_NAMESPACE']+_0x4b1bc6(0x199)+this[_0x4b1bc6(0x18e)]+_0x4b1bc6(0x197));return new metadata_log_dto_1['MetadataLogDto'](_0x54303f);}async[a337_0x882d73(0x1e8)](){const _0x122248=a337_0x882d73;this[_0x122248(0x209)][_0x122248(0x20f)](_0x122248(0x1f3));const _0x41554f=await new id_deployment_result_retriever_1[(_0x122248(0x18b))]({'salesforceService':this[_0x122248(0x190)],'value':this[_0x122248(0x1cc)]})['retrieve']();if(!_0x41554f[_0x122248(0x18c)])throw new Error(_0x122248(0x1fd));return _0x41554f;}async['retrieveBackup'](){const _0xf1402=a337_0x882d73;this[_0xf1402(0x209)][_0xf1402(0x20f)](_0xf1402(0x1cb));const _0x3548df=await this['_salesforceService'][_0xf1402(0x203)](_0xf1402(0x1ac)+this[_0xf1402(0x1a4)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1['FlosumConstants'][_0xf1402(0x193)]+_0xf1402(0x197)),_0x1f8849=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0xf1402(0x19b)],[_0x3548df[0x0]['Id']]),_0x515520=await(0x0,fetch_attachments_1[_0xf1402(0x1ca)])(_0x1f8849,this[_0xf1402(0x19b)]);if(!_0x515520[_0xf1402(0x18c)])throw new Error(_0xf1402(0x1e1));return _0x515520[0x0][_0xf1402(0x1e5)][_0xf1402(0x18d)];}async['createZip'](_0x17ceba){const _0x331e88=a337_0x882d73;this[_0x331e88(0x209)][_0x331e88(0x20f)](_0x331e88(0x1c1));const _0x17c9e1=await this[_0x331e88(0x1b2)](),_0x4d489f=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x331e88(0x1ba)][_0x331e88(0x1d3)],'backup':_0x17c9e1,'deploymentResults':_0x17ceba})['create'](),_0x4636ea=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+'.zip';return await(0x0,promises_1[_0x331e88(0x1fc)])(_0x4636ea,_0x4d489f),_0x4636ea;}async['createVpk'](_0x1284ff){const _0x249507=a337_0x882d73;this[_0x249507(0x209)][_0x249507(0x20f)](_0x249507(0x1bd));const _0x2de6cf=await this[_0x249507(0x1e4)][_0x249507(0x195)](_0x1284ff),_0x511f42=this['_tempFolder']+_0x249507(0x1b8)+_0x1284ff[_0x249507(0x196)](_0x1284ff['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x249507(0x1fc)])(_0x511f42,_0x2de6cf),await this[_0x249507(0x1e4)]['validate'](_0x511f42),_0x511f42;}[a337_0x882d73(0x1e2)](_0xc99b15){const _0x2f9aef=a337_0x882d73;return this[_0x2f9aef(0x209)][_0x2f9aef(0x20f)](_0x2f9aef(0x188)),_0xc99b15[_0x2f9aef(0x1a9)](_0x5ca50e=>{const _0x53c70d=_0x2f9aef;return this[_0x53c70d(0x209)][_0x53c70d(0x20f)](_0x5ca50e[_0x53c70d(0x1f4)]+'.'+_0x5ca50e[_0x53c70d(0x1d3)]+'\x20:\x20'+_0x5ca50e[_0x53c70d(0x20d)]),{[constants_1[_0x53c70d(0x1d0)]+'Type__c']:_0x53c70d(0x202),[constants_1['FLOSUM_NAMESPACE']+_0x53c70d(0x1d9)]:_0x5ca50e['status']===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x53c70d(0x1bc):_0x53c70d(0x1a1),[constants_1[_0x53c70d(0x1d0)]+_0x53c70d(0x1a8)]:_0x5ca50e['deploymentAction'],[constants_1[_0x53c70d(0x1d0)]+_0x53c70d(0x1b7)]:_0x5ca50e['name'],[constants_1[_0x53c70d(0x1d0)]+_0x53c70d(0x189)]:_0x5ca50e[_0x53c70d(0x1f4)],[constants_1['FLOSUM_NAMESPACE']+_0x53c70d(0x211)]:_0x5ca50e['stepName'],[constants_1['FLOSUM_NAMESPACE']+_0x53c70d(0x1a5)]:this['_metadataLog'][_0x53c70d(0x1bb)],[constants_1[_0x53c70d(0x1d0)]+_0x53c70d(0x1c7)]:this[_0x53c70d(0x18e)]};});}async[a337_0x882d73(0x1fb)](_0x593e02){const _0x358f5c=a337_0x882d73;this[_0x358f5c(0x209)][_0x358f5c(0x20f)](_0x358f5c(0x1ce));const _0x2c3cbd=await this[_0x358f5c(0x190)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x593e02),_0x5da20d=_0x2c3cbd[_0x358f5c(0x198)](_0x58c445=>!_0x58c445[_0x358f5c(0x1dd)])[_0x358f5c(0x1a9)](_0x3e93f8=>_0x3e93f8[_0x358f5c(0x1b5)])[_0x358f5c(0x1e9)]();if(_0x5da20d[_0x358f5c(0x18c)])throw new salesforce_dml_error_1[(_0x358f5c(0x206))](_0x5da20d);}async[a337_0x882d73(0x201)](_0x177256){const _0x4f3fe1=a337_0x882d73;if(!this['_metadataLog']){this[_0x4f3fe1(0x1c0)]['error'](_0x177256);return;}this[_0x4f3fe1(0x209)][_0x4f3fe1(0x1a2)](_0x177256),await this[_0x4f3fe1(0x209)][_0x4f3fe1(0x1de)](),await this[_0x4f3fe1(0x212)](![],!![],'');}async[a337_0x882d73(0x212)](_0x43d79d,_0x36ae59,_0x41f5e0){const _0x183584=a337_0x882d73,{id:_0x1a3f49,organizationId:_0x180469,branchId:_0x199e00,organizationName:_0x17006a}=this['_metadataLog'],_0x376b21=_0x183584(0x1be)+this[_0x183584(0x1f1)]+'/'+_0x1a3f49+'\x20>\x20'+_0x183584(0x214)+_0x183584(0x1a6),_0x144169=_0x183584(0x1be)+this[_0x183584(0x1f1)]+'/'+_0x180469+'\x20>'+_0x17006a+_0x183584(0x1f8),_0x461bf9=_0x376b21+_0x183584(0x1b1)+_0x144169+'\x20has\x20been\x20created.',_0x521123={[constants_1[_0x183584(0x1d0)]+_0x183584(0x1c8)]:_0x461bf9,[constants_1[_0x183584(0x1d0)]+_0x183584(0x20e)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x183584(0x19e)]:_0x199e00,[constants_1[_0x183584(0x1d0)]+_0x183584(0x1dc)]:_0x183584(0x191),[constants_1['FLOSUM_NAMESPACE']+_0x183584(0x1b4)]:_0x183584(0x1c6),[constants_1[_0x183584(0x1d0)]+'TargetId__c']:_0x180469},_0x52f8b0={[constants_1[_0x183584(0x1d0)]+_0x183584(0x18a)]:!_0x43d79d,[constants_1[_0x183584(0x1d0)]+_0x183584(0x20c)]:_0x43d79d,[constants_1[_0x183584(0x1d0)]+_0x183584(0x1d9)]:_0x36ae59?status_enums_1['MetadataLogStatus'][_0x183584(0x1a7)]:status_enums_1[_0x183584(0x1e7)][_0x183584(0x208)],[constants_1[_0x183584(0x1d0)]+_0x183584(0x1f2)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x183584(0x1f0)]:_0x41f5e0};await this['_connectionSalesforce'][_0x183584(0x1da)](flosum_constants_1[_0x183584(0x1f7)][_0x183584(0x1b3)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x183584(0x18f)+this['_metadataLogId'],_0x52f8b0),await this[_0x183584(0x19b)]['post'](flosum_constants_1[_0x183584(0x1f7)][_0x183584(0x1b3)]+'/'+constants_1[_0x183584(0x1d0)]+'Log__c',_0x521123),this[_0x183584(0x209)][_0x183584(0x20f)](_0x183584(0x204)+(_0x43d79d?_0x183584(0x19c):'with\x20error')+'.'),await this[_0x183584(0x209)]['updateLog']();}async[a337_0x882d73(0x1d5)](){const _0x5f199b=a337_0x882d73;try{this[_0x5f199b(0x1ba)]=await this[_0x5f199b(0x200)]();const _0x1bdec4=await this[_0x5f199b(0x1e8)]();await this[_0x5f199b(0x209)][_0x5f199b(0x1de)]();const _0x47acb8=await this[_0x5f199b(0x1e0)](_0x1bdec4),_0x1aea97=await this['createVpk'](_0x47acb8);await this[_0x5f199b(0x209)][_0x5f199b(0x1de)]();const _0x52c183=await this[_0x5f199b(0x205)][_0x5f199b(0x1d8)](_0x1aea97);await this[_0x5f199b(0x209)]['updateLog']();const _0x40e521=this[_0x5f199b(0x1e2)](_0x52c183[_0x5f199b(0x1ed)]);await this[_0x5f199b(0x1fb)](_0x40e521),await this[_0x5f199b(0x212)](_0x52c183[_0x5f199b(0x1d6)],![],_0x52c183[_0x5f199b(0x1ad)]);}catch(_0x2a9eea){await this[_0x5f199b(0x201)](_0x2a9eea)[_0x5f199b(0x1ea)](_0x30598c=>this[_0x5f199b(0x1c0)][_0x5f199b(0x1cd)](_0x30598c));}}}function a337_0x4c07(){const _0x2b12cc=['filter','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','_timeZone','_connectionSalesforce','successfully','6118XLVGhw','Branch__c','5461312IutpNx','./package-import.service','Failure','logError','__esModule','_parentMetadataLogId','Org__c','\x20</a>','EXCEPTION','Result__c','map','2598204ShksmB','VpkService','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','packageId','/Attachment','1262866vcoTLk','../constants/flosum.constants','\x20of\x20branch\x20to\x20Organization\x20','retrieveBackup','ENDPOINT_UPSERT_RECORD','Activity_Type__c','errors','bind','Component_Name__c','/vpk__','post','_metadataLog','organizationId','Success','Create\x20Vpk\x20package','<a\x20href=','Save\x20log','_systemLogger','Create\x20zip\x20from\x20backup','5972075QIbftN','VeevaService','RollbackService','6330GnhSOL','Deployment','Metadata_Log__c','Action__c','376zcfJBb','retrieveAttachments','Retrieve\x20Backup','_componentIds','error','Save\x20Deployment\x20Results','../classes/retrievers/deployment-results/id.deployment-result.retriever','FLOSUM_NAMESPACE','saveLog','(((.+)+)+)+$','name','defineProperty','execute','isDeployed','../../../constants','import','Status__c','patch','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Activity_Item__c','success','updateLog','1182486XghkQS','createZip','Cannot\x20find\x20Backup\x20Zip','formFlosumDeploymentResults','./salesforce.service','_vpkService','values','fs/promises','MetadataLogStatus','retrieveDeploymentResults','flat','catch','__importDefault','PackageImportService','packageComponentList','../../shared/utils/fetch-attachments','596007nhKlee','Async_Request_Id__c','_instanceUrl','Job_Completed__c','Retrieve\x20Deployment\x20Results','type','../dtos/metadata-log.dto','Retrieve\x20Metadata\x20Log\x20info','FlosumConstants','</a>','toString','_connectionVeeva','saveDeploymentResults','writeFile','Cannot\x20find\x20Deployment\x20Results','apply','veeva-rollback','retrieveMetadataLog','finishRollbackWithError','Deployment\x20Result','retrieveRecords','Rollback\x20completed\x20','_packageImportService','SalesforceDmlError','base64','COMPLETED','_logger','text/plain','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Succeed__c','status','Date__c','log','Logger','Veeva_Step_Name__c','finishRollback','search','Veeva\x20Rollback\x20(Deployment)','Form\x20Deployment\x20Results','Component_Type__c','Is_Error__c','IdDeploymentResultRetriever','length','Body','_metadataLogId','Metadata_Log__c/','_salesforceService','Branch','_veevaService','BACKUP_ZIP_NAME','../../../core','generate','slice','\x27\x0a\x20\x20\x20\x20'];a337_0x4c07=function(){return _0x2b12cc;};return a337_0x4c07();}exports[a337_0x882d73(0x1c4)]=RollbackService;