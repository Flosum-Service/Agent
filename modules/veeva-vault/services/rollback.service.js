const a404_0x1cdf67=a404_0x245b;(function(_0x52622c,_0x5dfa65){const _0x3ea73b=a404_0x245b,_0x5a1dda=_0x52622c();while(!![]){try{const _0x577610=-parseInt(_0x3ea73b(0x153))/0x1+-parseInt(_0x3ea73b(0x1a8))/0x2*(-parseInt(_0x3ea73b(0x13e))/0x3)+parseInt(_0x3ea73b(0x19b))/0x4*(-parseInt(_0x3ea73b(0x163))/0x5)+parseInt(_0x3ea73b(0x1bf))/0x6+parseInt(_0x3ea73b(0x1a4))/0x7+parseInt(_0x3ea73b(0x1bc))/0x8*(parseInt(_0x3ea73b(0x169))/0x9)+-parseInt(_0x3ea73b(0x172))/0xa*(parseInt(_0x3ea73b(0x15b))/0xb);if(_0x577610===_0x5dfa65)break;else _0x5a1dda['push'](_0x5a1dda['shift']());}catch(_0x1ffb99){_0x5a1dda['push'](_0x5a1dda['shift']());}}}(a404_0x4051,0xd96c0));const a404_0xa169bd=(function(){let _0x3f3b0c=!![];return function(_0x1cb828,_0x4ae6f9){const _0x1832d5=_0x3f3b0c?function(){const _0x2ab029=a404_0x245b;if(_0x4ae6f9){const _0x2c80cf=_0x4ae6f9[_0x2ab029(0x1a6)](_0x1cb828,arguments);return _0x4ae6f9=null,_0x2c80cf;}}:function(){};return _0x3f3b0c=![],_0x1832d5;};}()),a404_0x1e36ad=a404_0xa169bd(this,function(){const _0x562c0f=a404_0x245b;return a404_0x1e36ad[_0x562c0f(0x191)]()[_0x562c0f(0x14c)](_0x562c0f(0x178))[_0x562c0f(0x191)]()[_0x562c0f(0x19e)](a404_0x1e36ad)['search'](_0x562c0f(0x178));});a404_0x1e36ad();function a404_0x245b(_0x11121b,_0xc41975){const _0x62d304=a404_0x4051();return a404_0x245b=function(_0x1e36ad,_0xa169bd){_0x1e36ad=_0x1e36ad-0x133;let _0x405144=_0x62d304[_0x1e36ad];return _0x405144;},a404_0x245b(_0x11121b,_0xc41975);}function a404_0x4051(){const _0x21d7f3=['fs/promises','bind','execute','Log__c','MetadataLogStatus','11994486GcxuCr','/Attachment','apply','Result__c','2SLPBRw','ENDPOINT_UPSERT_RECORD','_tempFolder','flat','packageId','Metadata_Log__c','VpkService','\x20</a>','updateLog','/vpk__','deploymentAction','../classes/errors/salesforce-dml-error','_vpkService','Rollback\x20completed\x20','\x20has\x20been\x20created.','import','Is_Error__c','finishRollbackWithError','IdDeploymentResultRetriever','retrieveDeploymentResults','120AhMcAw','\x20>\x20','catch','1926588GYtFez','BACKUP_ZIP_NAME','insertMultipleRecords','status','text/plain','Retrieve\x20Metadata\x20Log\x20info','../../../core','createZip','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','COMPLETED','Save\x20log','type','Save\x20Deployment\x20Results','default','5169576IzdVrS','formFlosumDeploymentResults','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','_salesforceService','base64','from','validate','lastIndexOf','\x27\x0a\x20\x20\x20\x20','Cannot\x20find\x20Deployment\x20Results','_attachmentLogId','Activity_Type__c','filter','PackageImportService','search','./salesforce.service','EXCEPTION','length','PackageComponentStatus','map','_systemLogger','844997mSyWoh','./veeva.service','Retrieve\x20Deployment\x20Results','fetchAttachmentsDetailsById','error','log','_connectionSalesforce','Component_Type__c','178398LlGpMY','Branch','veeva-rollback','Retrieve\x20Backup','Metadata_Log__c/','External_Deployment_Id__c','retrieveBackup','\x20of\x20branch\x20to\x20Organization\x20','25725DilQYS','shortid','writeFile','Logger','../classes/rollback/zip-creator.rollback','Failure','526122FYTUBD','_logger','_connectionVeeva','Success','Deployment','createVpk','saveDeploymentResults','RollbackService','_parentMetadataLogId','820DbZJtP','Job_Completed__c','__esModule','__importDefault','_packageImportService','slice','(((.+)+)+)+$','logError','organizationId','_metadataLog','create','Status__c','post','Succeed__c','packageComponentList','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','ZipCreatorRollback','retrieveMetadataLog','./vpk.service','saveLog','retrieveRecords','../enums/status.enums','DEPLOYED','successfully','Date__c','name','_componentIds','_timeZone','defineProperty','retrieveAttachments','stepName','toString','../dtos/metadata-log.dto','_metadataLogId','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','generate','FLOSUM_NAMESPACE','_veevaService','Branch__c','FlosumConstants','finishRollback','1220EWMzNL','VeevaService','Action__c','constructor'];a404_0x4051=function(){return _0x21d7f3;};return a404_0x4051();}'use strict';var __importDefault=this&&this[a404_0x1cdf67(0x175)]||function(_0x55cda7){return _0x55cda7&&_0x55cda7['__esModule']?_0x55cda7:{'default':_0x55cda7};};Object[a404_0x1cdf67(0x18e)](exports,a404_0x1cdf67(0x174),{'value':!![]}),exports[a404_0x1cdf67(0x170)]=void 0x0;const veeva_service_1=require(a404_0x1cdf67(0x154)),salesforce_service_1=require(a404_0x1cdf67(0x14d)),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require('../../../constants'),zip_creator_rollback_1=require(a404_0x1cdf67(0x167)),shortid_1=__importDefault(require(a404_0x1cdf67(0x164))),promises_1=require(a404_0x1cdf67(0x19f)),vpk_service_1=require(a404_0x1cdf67(0x184)),status_enums_1=require(a404_0x1cdf67(0x187)),salesforce_dml_error_1=require(a404_0x1cdf67(0x1b3)),metadata_log_dto_1=require(a404_0x1cdf67(0x192)),core_1=require(a404_0x1cdf67(0x136));class RollbackService{constructor({connectionSalesforce:_0x1e2df5,connectionVeeva:_0x4207c7,logger:_0x44797b,tempFolder:_0x456f72,instanceUrl:_0x402c37,timeZone:_0x4b199d,metadataLogId:_0x4b4d98,attachmentLogId:_0x245809,parentMetadataLogId:_0x4443ac,componentIds:_0x58ac73}){const _0x50f178=a404_0x1cdf67;this['_connectionSalesforce']=_0x1e2df5,this[_0x50f178(0x16b)]=_0x4207c7,this[_0x50f178(0x16a)]=_0x44797b,this[_0x50f178(0x1aa)]=_0x456f72,this['_instanceUrl']=_0x402c37,this[_0x50f178(0x18d)]=_0x4b199d,this[_0x50f178(0x193)]=_0x4b4d98,this[_0x50f178(0x148)]=_0x245809,this[_0x50f178(0x171)]=_0x4443ac,this[_0x50f178(0x18c)]=_0x58ac73,this['_systemLogger']=new core_1[(_0x50f178(0x166))](_0x50f178(0x15d)),this['_veevaService']=new veeva_service_1[(_0x50f178(0x19c))]({'connection':_0x4207c7,'logger':_0x44797b}),this[_0x50f178(0x141)]=new salesforce_service_1['SalesforceService']({'connection':_0x1e2df5}),this[_0x50f178(0x176)]=new package_import_service_1[(_0x50f178(0x14b))]({'veevaService':this[_0x50f178(0x197)],'connection':_0x4207c7,'logger':_0x44797b,'saveLog':this[_0x50f178(0x185)][_0x50f178(0x1a0)](this)}),this[_0x50f178(0x1b4)]=new vpk_service_1[(_0x50f178(0x1ae))]({'connection':_0x4207c7});}async[a404_0x1cdf67(0x185)](_0x1c7f47,_0x3ba8c4){const _0x3562b9=a404_0x1cdf67;this[_0x3562b9(0x16a)][_0x3562b9(0x158)](_0x3562b9(0x13a));const _0x341214={'Body':Buffer[_0x3562b9(0x143)](_0x1c7f47)[_0x3562b9(0x191)](_0x3562b9(0x142)),'ContentType':_0x3562b9(0x134),'ParentId':this['_metadataLogId'],'Name':_0x3ba8c4};await this[_0x3562b9(0x159)][_0x3562b9(0x17e)](flosum_constants_1[_0x3562b9(0x199)][_0x3562b9(0x1a9)]+_0x3562b9(0x1a5),_0x341214);}async[a404_0x1cdf67(0x183)](){const _0x1aed60=a404_0x1cdf67;this[_0x1aed60(0x16a)]['log'](_0x1aed60(0x135));const [_0x9d2702]=await this[_0x1aed60(0x141)][_0x1aed60(0x186)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x1aed60(0x196)]+_0x1aed60(0x138)+constants_1[_0x1aed60(0x196)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x1aed60(0x196)]+_0x1aed60(0x181)+constants_1[_0x1aed60(0x196)]+_0x1aed60(0x194)+this[_0x1aed60(0x193)]+_0x1aed60(0x146));return new metadata_log_dto_1['MetadataLogDto'](_0x9d2702);}async[a404_0x1cdf67(0x1bb)](){const _0x410cc6=a404_0x1cdf67;this[_0x410cc6(0x16a)][_0x410cc6(0x158)](_0x410cc6(0x155));const _0x548b5=await new id_deployment_result_retriever_1[(_0x410cc6(0x1ba))]({'salesforceService':this[_0x410cc6(0x141)],'value':this[_0x410cc6(0x18c)]})['retrieve']();if(!_0x548b5[_0x410cc6(0x14f)])throw new Error(_0x410cc6(0x147));return _0x548b5;}async['retrieveBackup'](){const _0x2edd60=a404_0x1cdf67;this[_0x2edd60(0x16a)][_0x2edd60(0x158)](_0x2edd60(0x15e));const _0x14b328=await this['_salesforceService']['retrieveRecords'](_0x2edd60(0x140)+this['_parentMetadataLogId']+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0x2edd60(0x199)][_0x2edd60(0x1c0)]+'\x27\x0a\x20\x20\x20\x20'),_0x588f8b=await(0x0,fetch_attachments_1[_0x2edd60(0x156)])(this[_0x2edd60(0x159)],[_0x14b328[0x0]['Id']]),_0x23f8c1=await(0x0,fetch_attachments_1[_0x2edd60(0x18f)])(_0x588f8b,this[_0x2edd60(0x159)]);if(!_0x23f8c1[_0x2edd60(0x14f)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x23f8c1[0x0]['values']['Body'];}async[a404_0x1cdf67(0x137)](_0x400ff6){const _0x37157b=a404_0x1cdf67;this[_0x37157b(0x16a)][_0x37157b(0x158)]('Create\x20zip\x20from\x20backup');const _0x3caa76=await this[_0x37157b(0x161)](),_0x308e67=await new zip_creator_rollback_1[(_0x37157b(0x182))]({'rollbackName':this['_metadataLog'][_0x37157b(0x18b)],'backup':_0x3caa76,'deploymentResults':_0x400ff6})[_0x37157b(0x17c)](),_0x3f22a4=this[_0x37157b(0x1aa)]+'/'+(0x0,shortid_1[_0x37157b(0x13d)])()+'.zip';return await(0x0,promises_1[_0x37157b(0x165)])(_0x3f22a4,_0x308e67),_0x3f22a4;}async[a404_0x1cdf67(0x16e)](_0x39abc4){const _0x5792c2=a404_0x1cdf67;this[_0x5792c2(0x16a)][_0x5792c2(0x158)]('Create\x20Vpk\x20package');const _0x34d26e=await this[_0x5792c2(0x1b4)][_0x5792c2(0x195)](_0x39abc4),_0x30d3d2=this[_0x5792c2(0x1aa)]+_0x5792c2(0x1b1)+_0x39abc4[_0x5792c2(0x177)](_0x39abc4[_0x5792c2(0x145)]('/')+0x1);return await(0x0,promises_1[_0x5792c2(0x165)])(_0x30d3d2,_0x34d26e),await this['_vpkService'][_0x5792c2(0x144)](_0x30d3d2),_0x30d3d2;}[a404_0x1cdf67(0x13f)](_0x3846ac){const _0x2de17b=a404_0x1cdf67;return this['_logger'][_0x2de17b(0x158)]('Form\x20Deployment\x20Results'),_0x3846ac['map'](_0x925fe1=>{const _0x4a19f5=_0x2de17b;return this[_0x4a19f5(0x16a)][_0x4a19f5(0x158)](_0x925fe1['type']+'.'+_0x925fe1['name']+'\x20:\x20'+_0x925fe1[_0x4a19f5(0x133)]),{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:'Deployment\x20Result',[constants_1['FLOSUM_NAMESPACE']+_0x4a19f5(0x17d)]:_0x925fe1[_0x4a19f5(0x133)]===status_enums_1[_0x4a19f5(0x150)][_0x4a19f5(0x188)]?_0x4a19f5(0x16c):_0x4a19f5(0x168),[constants_1[_0x4a19f5(0x196)]+_0x4a19f5(0x1a7)]:_0x925fe1[_0x4a19f5(0x1b2)],[constants_1[_0x4a19f5(0x196)]+'Component_Name__c']:_0x925fe1['name'],[constants_1[_0x4a19f5(0x196)]+_0x4a19f5(0x15a)]:_0x925fe1[_0x4a19f5(0x13b)],[constants_1[_0x4a19f5(0x196)]+'Veeva_Step_Name__c']:_0x925fe1[_0x4a19f5(0x190)],[constants_1[_0x4a19f5(0x196)]+'Org__c']:this['_metadataLog'][_0x4a19f5(0x17a)],[constants_1[_0x4a19f5(0x196)]+_0x4a19f5(0x1ad)]:this[_0x4a19f5(0x193)]};});}async[a404_0x1cdf67(0x16f)](_0x539edc){const _0x2571c3=a404_0x1cdf67;this[_0x2571c3(0x16a)][_0x2571c3(0x158)](_0x2571c3(0x13c));const _0xbfa7e0=await this[_0x2571c3(0x141)][_0x2571c3(0x1c1)](constants_1[_0x2571c3(0x196)]+'Deployment_Result__c',_0x539edc),_0x5a99d1=_0xbfa7e0[_0x2571c3(0x14a)](_0x28de7b=>!_0x28de7b['success'])[_0x2571c3(0x151)](_0x3495db=>_0x3495db['errors'])[_0x2571c3(0x1ab)]();if(_0x5a99d1[_0x2571c3(0x14f)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x5a99d1);}async[a404_0x1cdf67(0x1b9)](_0x423cb3){const _0x36d6cd=a404_0x1cdf67;if(!this[_0x36d6cd(0x17b)]){this[_0x36d6cd(0x152)][_0x36d6cd(0x157)](_0x423cb3);return;}this[_0x36d6cd(0x16a)][_0x36d6cd(0x179)](_0x423cb3),await this[_0x36d6cd(0x16a)]['updateLog'](),await this[_0x36d6cd(0x19a)](![],!![],'');}async['finishRollback'](_0x3ef517,_0x50f123,_0x184543){const _0x11cc1c=a404_0x1cdf67,{id:_0x5a1ab0,organizationId:_0x2ddbfa,branchId:_0x41d573,organizationName:_0x4da36b}=this[_0x11cc1c(0x17b)],_0x5131c2='<a\x20href='+this['_instanceUrl']+'/'+_0x5a1ab0+_0x11cc1c(0x1bd)+'Veeva\x20Rollback\x20(Deployment)'+_0x11cc1c(0x1af),_0x4750d2='<a\x20href='+this['_instanceUrl']+'/'+_0x2ddbfa+'\x20>'+_0x4da36b+'</a>',_0x1060c4=_0x5131c2+_0x11cc1c(0x162)+_0x4750d2+_0x11cc1c(0x1b6),_0x4bb8ed={[constants_1['FLOSUM_NAMESPACE']+_0x11cc1c(0x19d)]:_0x1060c4,[constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x18a)]:new Date(),[constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x198)]:_0x41d573,[constants_1[_0x11cc1c(0x196)]+'Activity_Item__c']:_0x11cc1c(0x15c),[constants_1['FLOSUM_NAMESPACE']+_0x11cc1c(0x149)]:_0x11cc1c(0x16d),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:_0x2ddbfa},_0x4a2659={[constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x1b8)]:!_0x3ef517,[constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x17f)]:_0x3ef517,[constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x17d)]:_0x50f123?status_enums_1['MetadataLogStatus'][_0x11cc1c(0x14e)]:status_enums_1[_0x11cc1c(0x1a3)][_0x11cc1c(0x139)],[constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x173)]:!![],[constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x160)]:_0x184543};await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x11cc1c(0x199)][_0x11cc1c(0x1a9)]+'/'+constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x15f)+this[_0x11cc1c(0x193)],_0x4a2659),await this['_connectionSalesforce'][_0x11cc1c(0x17e)](flosum_constants_1[_0x11cc1c(0x199)][_0x11cc1c(0x1a9)]+'/'+constants_1[_0x11cc1c(0x196)]+_0x11cc1c(0x1a2),_0x4bb8ed),this[_0x11cc1c(0x16a)][_0x11cc1c(0x158)](_0x11cc1c(0x1b5)+(_0x3ef517?_0x11cc1c(0x189):'with\x20error')+'.'),await this['_logger'][_0x11cc1c(0x1b0)]();}async[a404_0x1cdf67(0x1a1)](){const _0x3d1e6a=a404_0x1cdf67;try{this[_0x3d1e6a(0x17b)]=await this['retrieveMetadataLog']();const _0x22eb2f=await this[_0x3d1e6a(0x1bb)]();await this[_0x3d1e6a(0x16a)][_0x3d1e6a(0x1b0)]();const _0x478625=await this[_0x3d1e6a(0x137)](_0x22eb2f),_0x1366bb=await this[_0x3d1e6a(0x16e)](_0x478625);await this['_logger']['updateLog']();const _0x4e09a6=await this['_packageImportService'][_0x3d1e6a(0x1b7)](_0x1366bb);await this[_0x3d1e6a(0x16a)][_0x3d1e6a(0x1b0)]();const _0x3c9617=this[_0x3d1e6a(0x13f)](_0x4e09a6[_0x3d1e6a(0x180)]);await this[_0x3d1e6a(0x16f)](_0x3c9617),await this[_0x3d1e6a(0x19a)](_0x4e09a6['isDeployed'],![],_0x4e09a6[_0x3d1e6a(0x1ac)]);}catch(_0x46ae53){await this[_0x3d1e6a(0x1b9)](_0x46ae53)[_0x3d1e6a(0x1be)](_0x38ae2f=>this['_systemLogger'][_0x3d1e6a(0x157)](_0x38ae2f));}}}exports['RollbackService']=RollbackService;