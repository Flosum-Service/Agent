const a377_0x478045=a377_0x337d;(function(_0x3b5948,_0x3d3ef7){const _0x35111f=a377_0x337d,_0x4e2404=_0x3b5948();while(!![]){try{const _0x3e1a20=parseInt(_0x35111f(0x1a6))/0x1*(-parseInt(_0x35111f(0x1e9))/0x2)+parseInt(_0x35111f(0x203))/0x3*(-parseInt(_0x35111f(0x1b7))/0x4)+-parseInt(_0x35111f(0x1b1))/0x5*(-parseInt(_0x35111f(0x1a7))/0x6)+-parseInt(_0x35111f(0x1d2))/0x7*(-parseInt(_0x35111f(0x197))/0x8)+-parseInt(_0x35111f(0x212))/0x9*(parseInt(_0x35111f(0x1ba))/0xa)+parseInt(_0x35111f(0x18e))/0xb+parseInt(_0x35111f(0x20a))/0xc;if(_0x3e1a20===_0x3d3ef7)break;else _0x4e2404['push'](_0x4e2404['shift']());}catch(_0x12e3cf){_0x4e2404['push'](_0x4e2404['shift']());}}}(a377_0x5614,0x2137c));const a377_0x5e059e=(function(){let _0x326259=!![];return function(_0xed44d,_0x381c72){const _0xdadce8=_0x326259?function(){const _0x918eb6=a377_0x337d;if(_0x381c72){const _0x56b91a=_0x381c72[_0x918eb6(0x186)](_0xed44d,arguments);return _0x381c72=null,_0x56b91a;}}:function(){};return _0x326259=![],_0xdadce8;};}()),a377_0x214026=a377_0x5e059e(this,function(){const _0x1b2138=a377_0x337d;return a377_0x214026['toString']()['search'](_0x1b2138(0x1c2))[_0x1b2138(0x1a4)]()[_0x1b2138(0x1f3)](a377_0x214026)[_0x1b2138(0x1b2)](_0x1b2138(0x1c2));});a377_0x214026();function a377_0x337d(_0x19f09c,_0x520acc){const _0x40a598=a377_0x5614();return a377_0x337d=function(_0x214026,_0x5e059e){_0x214026=_0x214026-0x184;let _0x56147b=_0x40a598[_0x214026];return _0x56147b;},a377_0x337d(_0x19f09c,_0x520acc);}'use strict';var __importDefault=this&&this[a377_0x478045(0x1f1)]||function(_0x35b52c){return _0x35b52c&&_0x35b52c['__esModule']?_0x35b52c:{'default':_0x35b52c};};Object[a377_0x478045(0x1e8)](exports,a377_0x478045(0x1ae),{'value':!![]}),exports[a377_0x478045(0x18b)]=void 0x0;const veeva_service_1=require(a377_0x478045(0x1be)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a377_0x478045(0x1fe)),id_deployment_result_retriever_1=require(a377_0x478045(0x19c)),flosum_constants_1=require(a377_0x478045(0x18d)),fetch_attachments_1=require(a377_0x478045(0x1e2)),constants_1=require(a377_0x478045(0x1d6)),zip_creator_rollback_1=require(a377_0x478045(0x199)),shortid_1=__importDefault(require('shortid')),promises_1=require(a377_0x478045(0x1dc)),vpk_service_1=require(a377_0x478045(0x1a3)),status_enums_1=require(a377_0x478045(0x1d1)),salesforce_dml_error_1=require(a377_0x478045(0x1fa)),metadata_log_dto_1=require(a377_0x478045(0x1c3)),core_1=require('../../../core');function a377_0x5614(){const _0x3cdf50=['\x27\x20AND\x20Name\x20=\x20\x27','<a\x20href=','Job_Completed__c','validate','\x27\x0a\x20\x20\x20\x20','apply','retrieveBackup','Form\x20Deployment\x20Results','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','createVpk','RollbackService','IdDeploymentResultRetriever','../constants/flosum.constants','2296943xSUJZs','Deployment_Result__c','Type__c','length','\x20</a>','saveLog','\x20>\x20','retrieveDeploymentResults','Veeva_Step_Name__c','224TNRfZR','with\x20error','../classes/rollback/zip-creator.rollback','MetadataLogDto','_parentMetadataLogId','../classes/retrievers/deployment-results/id.deployment-result.retriever','map','Status__c','_salesforceService','lastIndexOf','name','_timeZone','./vpk.service','toString','Branch','5ioxVRM','1195140XxuFQw','Cannot\x20find\x20Deployment\x20Results','Cannot\x20find\x20Backup\x20Zip','_systemLogger','finishRollbackWithError','DEPLOYED','SalesforceService','__esModule','fetchAttachmentsDetailsById','</a>','5nhcAHK','search','Result__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_veevaService','retrieveAttachments','20urHqMP','_tempFolder','stepName','2460wbfCRn','bind','TargetId__c','error','./veeva.service','External_Deployment_Id__c','FlosumConstants','VeevaService','(((.+)+)+)+$','../dtos/metadata-log.dto','import','insertMultipleRecords','Date__c','filter','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','veeva-rollback','Component_Name__c','_logger','Veeva\x20Rollback\x20(Deployment)','Failure','retrieveRecords','BACKUP_ZIP_NAME','Success','../enums/status.enums','58324AnacnB','log','_instanceUrl','isDeployed','../../../constants','slice','from','Retrieve\x20Deployment\x20Results','default','Rollback\x20completed\x20','fs/promises','Metadata_Log__c/','PackageImportService','Deployment','Save\x20Deployment\x20Results','_connectionSalesforce','../../shared/utils/fetch-attachments','generate','saveDeploymentResults','createZip','VpkService','execute','defineProperty','101294sZWYgJ','Body','updateLog','Create\x20Vpk\x20package','Log__c','/vpk__','Activity_Type__c','create','__importDefault','base64','constructor','ENDPOINT_UPSERT_RECORD','Org__c','deploymentAction','Metadata_Log__c','post','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','../classes/errors/salesforce-dml-error','_attachmentLogId','retrieveMetadataLog','_packageImportService','./package-import.service','FLOSUM_NAMESPACE','_componentIds','_metadataLogId','_connectionVeeva','83991dTFAoe','formFlosumDeploymentResults','MetadataLogStatus','Create\x20zip\x20from\x20backup','_metadataLog','finishRollback','patch','1144308PwKBfL','writeFile','_vpkService','packageComponentList','Component_Type__c','values','status','retrieve','7587eVkUdU'];a377_0x5614=function(){return _0x3cdf50;};return a377_0x5614();}class RollbackService{constructor({connectionSalesforce:_0x4b058d,connectionVeeva:_0x2a10d9,logger:_0xda4502,tempFolder:_0x12d130,instanceUrl:_0x473265,timeZone:_0x3b026d,metadataLogId:_0x27bd39,attachmentLogId:_0x33728f,parentMetadataLogId:_0x12b6ec,componentIds:_0x39cd18}){const _0xa6305d=a377_0x478045;this['_connectionSalesforce']=_0x4b058d,this[_0xa6305d(0x202)]=_0x2a10d9,this[_0xa6305d(0x1cb)]=_0xda4502,this[_0xa6305d(0x1b8)]=_0x12d130,this[_0xa6305d(0x1d4)]=_0x473265,this[_0xa6305d(0x1a2)]=_0x3b026d,this[_0xa6305d(0x201)]=_0x27bd39,this[_0xa6305d(0x1fb)]=_0x33728f,this[_0xa6305d(0x19b)]=_0x12b6ec,this['_componentIds']=_0x39cd18,this['_systemLogger']=new core_1['Logger'](_0xa6305d(0x1c9)),this[_0xa6305d(0x1b5)]=new veeva_service_1[(_0xa6305d(0x1c1))]({'connection':_0x2a10d9,'logger':_0xda4502}),this['_salesforceService']=new salesforce_service_1[(_0xa6305d(0x1ad))]({'connection':_0x4b058d}),this[_0xa6305d(0x1fd)]=new package_import_service_1[(_0xa6305d(0x1de))]({'veevaService':this[_0xa6305d(0x1b5)],'connection':_0x2a10d9,'logger':_0xda4502,'saveLog':this['saveLog'][_0xa6305d(0x1bb)](this)}),this[_0xa6305d(0x20c)]=new vpk_service_1[(_0xa6305d(0x1e6))]({'connection':_0x2a10d9});}async[a377_0x478045(0x193)](_0x504d49,_0x303dd1){const _0x4792ff=a377_0x478045;this['_logger'][_0x4792ff(0x1d3)]('Save\x20log');const _0xe77fe5={'Body':Buffer[_0x4792ff(0x1d8)](_0x504d49)[_0x4792ff(0x1a4)](_0x4792ff(0x1f2)),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x303dd1};await this[_0x4792ff(0x1e1)][_0x4792ff(0x1f8)](flosum_constants_1[_0x4792ff(0x1c0)][_0x4792ff(0x1f4)]+'/Attachment',_0xe77fe5);}async[a377_0x478045(0x1fc)](){const _0x33c019=a377_0x478045;this[_0x33c019(0x1cb)]['log']('Retrieve\x20Metadata\x20Log\x20info');const [_0x2ab6f5]=await this['_salesforceService']['retrieveRecords'](_0x33c019(0x1b4)+constants_1[_0x33c019(0x1ff)]+_0x33c019(0x1c8)+constants_1[_0x33c019(0x1ff)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x33c019(0x1ff)]+_0x33c019(0x1f9)+constants_1[_0x33c019(0x1ff)]+_0x33c019(0x189)+this[_0x33c019(0x201)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x33c019(0x19a))](_0x2ab6f5);}async[a377_0x478045(0x195)](){const _0x48b166=a377_0x478045;this['_logger'][_0x48b166(0x1d3)](_0x48b166(0x1d9));const _0xec4a35=await new id_deployment_result_retriever_1[(_0x48b166(0x18c))]({'salesforceService':this[_0x48b166(0x19f)],'value':this[_0x48b166(0x200)]})[_0x48b166(0x211)]();if(!_0xec4a35[_0x48b166(0x191)])throw new Error(_0x48b166(0x1a8));return _0xec4a35;}async['retrieveBackup'](){const _0x1fcdaa=a377_0x478045;this[_0x1fcdaa(0x1cb)][_0x1fcdaa(0x1d3)]('Retrieve\x20Backup');const _0x416f25=await this[_0x1fcdaa(0x19f)][_0x1fcdaa(0x1ce)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x1fcdaa(0x19b)]+_0x1fcdaa(0x213)+flosum_constants_1[_0x1fcdaa(0x1c0)][_0x1fcdaa(0x1cf)]+_0x1fcdaa(0x185)),_0x527066=await(0x0,fetch_attachments_1[_0x1fcdaa(0x1af)])(this[_0x1fcdaa(0x1e1)],[_0x416f25[0x0]['Id']]),_0x2fb795=await(0x0,fetch_attachments_1[_0x1fcdaa(0x1b6)])(_0x527066,this[_0x1fcdaa(0x1e1)]);if(!_0x2fb795[_0x1fcdaa(0x191)])throw new Error(_0x1fcdaa(0x1a9));return _0x2fb795[0x0][_0x1fcdaa(0x20f)][_0x1fcdaa(0x1ea)];}async[a377_0x478045(0x1e5)](_0x5438d3){const _0x253650=a377_0x478045;this[_0x253650(0x1cb)][_0x253650(0x1d3)](_0x253650(0x206));const _0x375781=await this[_0x253650(0x187)](),_0x2bd1fc=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this['_metadataLog'][_0x253650(0x1a1)],'backup':_0x375781,'deploymentResults':_0x5438d3})[_0x253650(0x1f0)](),_0x3fa3b3=this[_0x253650(0x1b8)]+'/'+(0x0,shortid_1[_0x253650(0x1da)])()+'.zip';return await(0x0,promises_1[_0x253650(0x20b)])(_0x3fa3b3,_0x2bd1fc),_0x3fa3b3;}async[a377_0x478045(0x18a)](_0x642e2d){const _0x5ac201=a377_0x478045;this[_0x5ac201(0x1cb)]['log'](_0x5ac201(0x1ec));const _0x1eb10a=await this[_0x5ac201(0x20c)][_0x5ac201(0x1e3)](_0x642e2d),_0x1e8a87=this[_0x5ac201(0x1b8)]+_0x5ac201(0x1ee)+_0x642e2d[_0x5ac201(0x1d7)](_0x642e2d[_0x5ac201(0x1a0)]('/')+0x1);return await(0x0,promises_1[_0x5ac201(0x20b)])(_0x1e8a87,_0x1eb10a),await this['_vpkService'][_0x5ac201(0x184)](_0x1e8a87),_0x1e8a87;}[a377_0x478045(0x204)](_0x3e9dd7){const _0x4829bb=a377_0x478045;return this[_0x4829bb(0x1cb)][_0x4829bb(0x1d3)](_0x4829bb(0x188)),_0x3e9dd7['map'](_0x4920af=>{const _0x3071d3=_0x4829bb;return this[_0x3071d3(0x1cb)][_0x3071d3(0x1d3)](_0x4920af['type']+'.'+_0x4920af['name']+'\x20:\x20'+_0x4920af['status']),{[constants_1[_0x3071d3(0x1ff)]+_0x3071d3(0x190)]:'Deployment\x20Result',[constants_1[_0x3071d3(0x1ff)]+_0x3071d3(0x19e)]:_0x4920af[_0x3071d3(0x210)]===status_enums_1['PackageComponentStatus'][_0x3071d3(0x1ac)]?_0x3071d3(0x1d0):_0x3071d3(0x1cd),[constants_1[_0x3071d3(0x1ff)]+_0x3071d3(0x1b3)]:_0x4920af[_0x3071d3(0x1f6)],[constants_1[_0x3071d3(0x1ff)]+_0x3071d3(0x1ca)]:_0x4920af['name'],[constants_1[_0x3071d3(0x1ff)]+_0x3071d3(0x20e)]:_0x4920af['type'],[constants_1[_0x3071d3(0x1ff)]+_0x3071d3(0x196)]:_0x4920af[_0x3071d3(0x1b9)],[constants_1[_0x3071d3(0x1ff)]+_0x3071d3(0x1f5)]:this[_0x3071d3(0x207)]['organizationId'],[constants_1[_0x3071d3(0x1ff)]+_0x3071d3(0x1f7)]:this[_0x3071d3(0x201)]};});}async[a377_0x478045(0x1e4)](_0x1d3fc3){const _0x63ed3e=a377_0x478045;this[_0x63ed3e(0x1cb)][_0x63ed3e(0x1d3)](_0x63ed3e(0x1e0));const _0x4db13c=await this['_salesforceService'][_0x63ed3e(0x1c5)](constants_1[_0x63ed3e(0x1ff)]+_0x63ed3e(0x18f),_0x1d3fc3),_0x5d5c01=_0x4db13c[_0x63ed3e(0x1c7)](_0x4b3013=>!_0x4b3013['success'])[_0x63ed3e(0x19d)](_0x3da903=>_0x3da903['errors'])['flat']();if(_0x5d5c01[_0x63ed3e(0x191)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x5d5c01);}async[a377_0x478045(0x1ab)](_0x32f480){const _0x10ea1c=a377_0x478045;if(!this[_0x10ea1c(0x207)]){this[_0x10ea1c(0x1aa)][_0x10ea1c(0x1bd)](_0x32f480);return;}this['_logger']['logError'](_0x32f480),await this[_0x10ea1c(0x1cb)][_0x10ea1c(0x1eb)](),await this[_0x10ea1c(0x208)](![],!![],'');}async[a377_0x478045(0x208)](_0x5128f9,_0x546b5b,_0x50fc7e){const _0x2a10ee=a377_0x478045,{id:_0x3d59f5,organizationId:_0x1d6ddf,branchId:_0x520071,organizationName:_0x45cef8}=this[_0x2a10ee(0x207)],_0x5a93ce=_0x2a10ee(0x214)+this[_0x2a10ee(0x1d4)]+'/'+_0x3d59f5+_0x2a10ee(0x194)+_0x2a10ee(0x1cc)+_0x2a10ee(0x192),_0x507ccc=_0x2a10ee(0x214)+this[_0x2a10ee(0x1d4)]+'/'+_0x1d6ddf+'\x20>'+_0x45cef8+_0x2a10ee(0x1b0),_0x157b95=_0x5a93ce+'\x20of\x20branch\x20to\x20Organization\x20'+_0x507ccc+'\x20has\x20been\x20created.',_0x4d9e31={[constants_1['FLOSUM_NAMESPACE']+'Action__c']:_0x157b95,[constants_1[_0x2a10ee(0x1ff)]+_0x2a10ee(0x1c6)]:new Date(),[constants_1[_0x2a10ee(0x1ff)]+'Branch__c']:_0x520071,[constants_1[_0x2a10ee(0x1ff)]+'Activity_Item__c']:_0x2a10ee(0x1a5),[constants_1[_0x2a10ee(0x1ff)]+_0x2a10ee(0x1ef)]:_0x2a10ee(0x1df),[constants_1['FLOSUM_NAMESPACE']+_0x2a10ee(0x1bc)]:_0x1d6ddf},_0xf7dfc5={[constants_1[_0x2a10ee(0x1ff)]+'Is_Error__c']:!_0x5128f9,[constants_1[_0x2a10ee(0x1ff)]+'Succeed__c']:_0x5128f9,[constants_1[_0x2a10ee(0x1ff)]+'Status__c']:_0x546b5b?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x2a10ee(0x205)]['COMPLETED'],[constants_1[_0x2a10ee(0x1ff)]+_0x2a10ee(0x215)]:!![],[constants_1[_0x2a10ee(0x1ff)]+_0x2a10ee(0x1bf)]:_0x50fc7e};await this['_connectionSalesforce'][_0x2a10ee(0x209)](flosum_constants_1[_0x2a10ee(0x1c0)][_0x2a10ee(0x1f4)]+'/'+constants_1[_0x2a10ee(0x1ff)]+_0x2a10ee(0x1dd)+this[_0x2a10ee(0x201)],_0xf7dfc5),await this[_0x2a10ee(0x1e1)][_0x2a10ee(0x1f8)](flosum_constants_1['FlosumConstants'][_0x2a10ee(0x1f4)]+'/'+constants_1[_0x2a10ee(0x1ff)]+_0x2a10ee(0x1ed),_0x4d9e31),this['_logger']['log'](_0x2a10ee(0x1db)+(_0x5128f9?'successfully':_0x2a10ee(0x198))+'.'),await this['_logger']['updateLog']();}async[a377_0x478045(0x1e7)](){const _0x3908c3=a377_0x478045;try{this[_0x3908c3(0x207)]=await this[_0x3908c3(0x1fc)]();const _0x364fa8=await this['retrieveDeploymentResults']();await this[_0x3908c3(0x1cb)][_0x3908c3(0x1eb)]();const _0x2d5fdf=await this[_0x3908c3(0x1e5)](_0x364fa8),_0x155265=await this[_0x3908c3(0x18a)](_0x2d5fdf);await this[_0x3908c3(0x1cb)][_0x3908c3(0x1eb)]();const _0x4804d9=await this[_0x3908c3(0x1fd)][_0x3908c3(0x1c4)](_0x155265);await this['_logger'][_0x3908c3(0x1eb)]();const _0x101c69=this[_0x3908c3(0x204)](_0x4804d9[_0x3908c3(0x20d)]);await this[_0x3908c3(0x1e4)](_0x101c69),await this[_0x3908c3(0x208)](_0x4804d9[_0x3908c3(0x1d5)],![],_0x4804d9['packageId']);}catch(_0x415c54){await this[_0x3908c3(0x1ab)](_0x415c54)['catch'](_0x527c1a=>this['_systemLogger'][_0x3908c3(0x1bd)](_0x527c1a));}}}exports['RollbackService']=RollbackService;