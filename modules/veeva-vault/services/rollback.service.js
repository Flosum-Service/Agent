const a405_0x2ca3de=a405_0x4664;function a405_0x73b0(){const _0x3868f0=['/vpk__','Failure','7xjHpRB','Body','Status__c','execute','post','</a>','_packageImportService','retrieveAttachments','\x20:\x20','<a\x20href=','Save\x20log','_veevaService','createVpk','finishRollbackWithError','finishRollback','retrieveMetadataLog','Veeva\x20Rollback\x20(Deployment)','type','patch','\x20</a>','error','retrieveDeploymentResults','length','base64','827176ajqOyz','\x20of\x20branch\x20to\x20Organization\x20','_metadataLog','Create\x20zip\x20from\x20backup','_instanceUrl','Deployment_Result__c','text/plain','4AVWvPk','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Activity_Item__c','COMPLETED','filter','ZipCreatorRollback','Is_Error__c','_timeZone','(((.+)+)+)+$','TargetId__c','1214958JcaOvh','retrieve','MetadataLogDto','_salesforceService','map','Metadata_Log__c','values','./salesforce.service','Veeva_Step_Name__c','4RLxiab','name','/Attachment','\x27\x20AND\x20Name\x20=\x20\x27','Deployment','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','2666634yNLDUE','organizationId','../constants/flosum.constants','Create\x20Vpk\x20package','success','../classes/rollback/zip-creator.rollback','./package-import.service','saveDeploymentResults','saveLog','Date__c','MetadataLogStatus','toString','Activity_Type__c','../../../core','27454207PQEPGl','4143800gzMFRw','External_Deployment_Id__c','FlosumConstants','catch','formFlosumDeploymentResults','retrieveBackup','2123703lHNSgI','writeFile','Org__c','Save\x20Deployment\x20Results','Result__c','Branch__c','successfully','.zip','Component_Name__c','veeva-rollback','Type__c','Component_Type__c','Rollback\x20completed\x20','\x20>\x20','./veeva.service','__esModule','apply','fetchAttachmentsDetailsById','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','_systemLogger','createZip','../enums/status.enums','ENDPOINT_UPSERT_RECORD','24zgZtuU','defineProperty','packageComponentList','packageId','log','Branch','with\x20error','Metadata_Log__c/','_componentIds','../../shared/utils/fetch-attachments','_logger','errors','status','retrieveRecords','Deployment\x20Result','validate','\x20has\x20been\x20created.','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','FLOSUM_NAMESPACE','logError','../classes/errors/salesforce-dml-error','1731770VGSSXJ','../classes/retrievers/deployment-results/id.deployment-result.retriever','search','stepName','create','BACKUP_ZIP_NAME','__importDefault','DEPLOYED','_vpkService','VpkService','_tempFolder','Retrieve\x20Metadata\x20Log\x20info','_connectionSalesforce','Logger','RollbackService','_parentMetadataLogId','EXCEPTION','_metadataLogId','../../../constants','\x27\x0a\x20\x20\x20\x20','updateLog','IdDeploymentResultRetriever','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','insertMultipleRecords','deploymentAction'];a405_0x73b0=function(){return _0x3868f0;};return a405_0x73b0();}(function(_0x2d8bd6,_0x14941e){const _0x24d264=a405_0x4664,_0x11d77d=_0x2d8bd6();while(!![]){try{const _0x35864a=-parseInt(_0x24d264(0x143))/0x1+-parseInt(_0x24d264(0x14a))/0x2*(-parseInt(_0x24d264(0x154))/0x3)+parseInt(_0x24d264(0x15d))/0x4*(-parseInt(_0x24d264(0x110))/0x5)+parseInt(_0x24d264(0x163))/0x6*(-parseInt(_0x24d264(0x12b))/0x7)+parseInt(_0x24d264(0xfb))/0x8*(-parseInt(_0x24d264(0x178))/0x9)+-parseInt(_0x24d264(0x172))/0xa+parseInt(_0x24d264(0x171))/0xb;if(_0x35864a===_0x14941e)break;else _0x11d77d['push'](_0x11d77d['shift']());}catch(_0x28e625){_0x11d77d['push'](_0x11d77d['shift']());}}}(a405_0x73b0,0x8a137));function a405_0x4664(_0x4d779e,_0x39a220){const _0x139f09=a405_0x73b0();return a405_0x4664=function(_0x518145,_0x17d150){_0x518145=_0x518145-0xf7;let _0x73b044=_0x139f09[_0x518145];return _0x73b044;},a405_0x4664(_0x4d779e,_0x39a220);}const a405_0x17d150=(function(){let _0x48b0ea=!![];return function(_0x240f6d,_0x37c8c3){const _0x59b783=_0x48b0ea?function(){const _0x4ca3ad=a405_0x4664;if(_0x37c8c3){const _0x3d3ffa=_0x37c8c3[_0x4ca3ad(0x188)](_0x240f6d,arguments);return _0x37c8c3=null,_0x3d3ffa;}}:function(){};return _0x48b0ea=![],_0x59b783;};}()),a405_0x518145=a405_0x17d150(this,function(){const _0x1ef8fe=a405_0x4664;return a405_0x518145[_0x1ef8fe(0x16e)]()[_0x1ef8fe(0x112)](_0x1ef8fe(0x152))[_0x1ef8fe(0x16e)]()['constructor'](a405_0x518145)[_0x1ef8fe(0x112)](_0x1ef8fe(0x152));});a405_0x518145();'use strict';var __importDefault=this&&this[a405_0x2ca3de(0x116)]||function(_0x50eebe){const _0x269a9c=a405_0x2ca3de;return _0x50eebe&&_0x50eebe[_0x269a9c(0x187)]?_0x50eebe:{'default':_0x50eebe};};Object[a405_0x2ca3de(0xfc)](exports,a405_0x2ca3de(0x187),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a405_0x2ca3de(0x186)),salesforce_service_1=require(a405_0x2ca3de(0x15b)),package_import_service_1=require(a405_0x2ca3de(0x169)),id_deployment_result_retriever_1=require(a405_0x2ca3de(0x111)),flosum_constants_1=require(a405_0x2ca3de(0x165)),fetch_attachments_1=require(a405_0x2ca3de(0x104)),constants_1=require(a405_0x2ca3de(0x122)),zip_creator_rollback_1=require(a405_0x2ca3de(0x168)),shortid_1=__importDefault(require('shortid')),promises_1=require('fs/promises'),vpk_service_1=require('./vpk.service'),status_enums_1=require(a405_0x2ca3de(0xf9)),salesforce_dml_error_1=require(a405_0x2ca3de(0x10f)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a405_0x2ca3de(0x170));class RollbackService{constructor({connectionSalesforce:_0x394bf1,connectionVeeva:_0x1390e8,logger:_0x55bdf0,tempFolder:_0x509a3a,instanceUrl:_0x4ad18c,timeZone:_0x37cd34,metadataLogId:_0x4968f7,attachmentLogId:_0x3bd55d,parentMetadataLogId:_0x1d4eb3,componentIds:_0x271682}){const _0x519873=a405_0x2ca3de;this[_0x519873(0x11c)]=_0x394bf1,this['_connectionVeeva']=_0x1390e8,this[_0x519873(0x105)]=_0x55bdf0,this['_tempFolder']=_0x509a3a,this['_instanceUrl']=_0x4ad18c,this[_0x519873(0x151)]=_0x37cd34,this[_0x519873(0x121)]=_0x4968f7,this['_attachmentLogId']=_0x3bd55d,this[_0x519873(0x11f)]=_0x1d4eb3,this[_0x519873(0x103)]=_0x271682,this[_0x519873(0xf7)]=new core_1[(_0x519873(0x11d))](_0x519873(0x181)),this[_0x519873(0x136)]=new veeva_service_1['VeevaService']({'connection':_0x1390e8,'logger':_0x55bdf0}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':_0x394bf1}),this[_0x519873(0x131)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x519873(0x136)],'connection':_0x1390e8,'logger':_0x55bdf0,'saveLog':this[_0x519873(0x16b)]['bind'](this)}),this[_0x519873(0x118)]=new vpk_service_1[(_0x519873(0x119))]({'connection':_0x1390e8});}async[a405_0x2ca3de(0x16b)](_0x5d148c,_0xe40136){const _0x4ba9be=a405_0x2ca3de;this['_logger'][_0x4ba9be(0xff)](_0x4ba9be(0x135));const _0x14767e={'Body':Buffer['from'](_0x5d148c)[_0x4ba9be(0x16e)](_0x4ba9be(0x142)),'ContentType':_0x4ba9be(0x149),'ParentId':this[_0x4ba9be(0x121)],'Name':_0xe40136};await this[_0x4ba9be(0x11c)][_0x4ba9be(0x12f)](flosum_constants_1[_0x4ba9be(0x174)]['ENDPOINT_UPSERT_RECORD']+_0x4ba9be(0x15f),_0x14767e);}async[a405_0x2ca3de(0x13a)](){const _0x39ff64=a405_0x2ca3de;this['_logger'][_0x39ff64(0xff)](_0x39ff64(0x11b));const [_0x4272cd]=await this[_0x39ff64(0x157)][_0x39ff64(0x108)](_0x39ff64(0x14b)+constants_1[_0x39ff64(0x10d)]+_0x39ff64(0x126)+constants_1[_0x39ff64(0x10d)]+_0x39ff64(0x162)+constants_1[_0x39ff64(0x10d)]+_0x39ff64(0x10c)+constants_1[_0x39ff64(0x10d)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this['_metadataLogId']+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x39ff64(0x156))](_0x4272cd);}async[a405_0x2ca3de(0x140)](){const _0x124d90=a405_0x2ca3de;this['_logger'][_0x124d90(0xff)]('Retrieve\x20Deployment\x20Results');const _0xcfe471=await new id_deployment_result_retriever_1[(_0x124d90(0x125))]({'salesforceService':this[_0x124d90(0x157)],'value':this[_0x124d90(0x103)]})[_0x124d90(0x155)]();if(!_0xcfe471['length'])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0xcfe471;}async[a405_0x2ca3de(0x177)](){const _0x5ef991=a405_0x2ca3de;this[_0x5ef991(0x105)][_0x5ef991(0xff)]('Retrieve\x20Backup');const _0x67c402=await this[_0x5ef991(0x157)][_0x5ef991(0x108)](_0x5ef991(0x18a)+this[_0x5ef991(0x11f)]+_0x5ef991(0x160)+flosum_constants_1['FlosumConstants'][_0x5ef991(0x115)]+_0x5ef991(0x123)),_0x40fcfe=await(0x0,fetch_attachments_1[_0x5ef991(0x189)])(this[_0x5ef991(0x11c)],[_0x67c402[0x0]['Id']]),_0x2d1635=await(0x0,fetch_attachments_1[_0x5ef991(0x132)])(_0x40fcfe,this[_0x5ef991(0x11c)]);if(!_0x2d1635[_0x5ef991(0x141)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x2d1635[0x0][_0x5ef991(0x15a)][_0x5ef991(0x12c)];}async[a405_0x2ca3de(0xf8)](_0x1b43b7){const _0xc81d0f=a405_0x2ca3de;this[_0xc81d0f(0x105)][_0xc81d0f(0xff)](_0xc81d0f(0x146));const _0x51966f=await this[_0xc81d0f(0x177)](),_0x59fe17=await new zip_creator_rollback_1[(_0xc81d0f(0x14f))]({'rollbackName':this[_0xc81d0f(0x145)][_0xc81d0f(0x15e)],'backup':_0x51966f,'deploymentResults':_0x1b43b7})[_0xc81d0f(0x114)](),_0x5270b5=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0xc81d0f(0x17f);return await(0x0,promises_1['writeFile'])(_0x5270b5,_0x59fe17),_0x5270b5;}async[a405_0x2ca3de(0x137)](_0xd07c0c){const _0x19b857=a405_0x2ca3de;this[_0x19b857(0x105)]['log'](_0x19b857(0x166));const _0x47cb70=await this[_0x19b857(0x118)]['generate'](_0xd07c0c),_0x44bde1=this[_0x19b857(0x11a)]+_0x19b857(0x129)+_0xd07c0c['slice'](_0xd07c0c['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x19b857(0x179)])(_0x44bde1,_0x47cb70),await this[_0x19b857(0x118)][_0x19b857(0x10a)](_0x44bde1),_0x44bde1;}[a405_0x2ca3de(0x176)](_0x1f75d2){const _0x4c760e=a405_0x2ca3de;return this[_0x4c760e(0x105)][_0x4c760e(0xff)]('Form\x20Deployment\x20Results'),_0x1f75d2[_0x4c760e(0x158)](_0x5c6254=>{const _0x80253c=_0x4c760e;return this[_0x80253c(0x105)][_0x80253c(0xff)](_0x5c6254['type']+'.'+_0x5c6254[_0x80253c(0x15e)]+_0x80253c(0x133)+_0x5c6254[_0x80253c(0x107)]),{[constants_1[_0x80253c(0x10d)]+_0x80253c(0x182)]:_0x80253c(0x109),[constants_1[_0x80253c(0x10d)]+_0x80253c(0x12d)]:_0x5c6254['status']===status_enums_1['PackageComponentStatus'][_0x80253c(0x117)]?'Success':_0x80253c(0x12a),[constants_1[_0x80253c(0x10d)]+_0x80253c(0x17c)]:_0x5c6254[_0x80253c(0x128)],[constants_1['FLOSUM_NAMESPACE']+_0x80253c(0x180)]:_0x5c6254['name'],[constants_1[_0x80253c(0x10d)]+_0x80253c(0x183)]:_0x5c6254[_0x80253c(0x13c)],[constants_1[_0x80253c(0x10d)]+_0x80253c(0x15c)]:_0x5c6254[_0x80253c(0x113)],[constants_1[_0x80253c(0x10d)]+_0x80253c(0x17a)]:this[_0x80253c(0x145)][_0x80253c(0x164)],[constants_1[_0x80253c(0x10d)]+_0x80253c(0x159)]:this[_0x80253c(0x121)]};});}async[a405_0x2ca3de(0x16a)](_0x4fd069){const _0x5c6509=a405_0x2ca3de;this[_0x5c6509(0x105)][_0x5c6509(0xff)](_0x5c6509(0x17b));const _0x4683bf=await this[_0x5c6509(0x157)][_0x5c6509(0x127)](constants_1[_0x5c6509(0x10d)]+_0x5c6509(0x148),_0x4fd069),_0x26c6b7=_0x4683bf[_0x5c6509(0x14e)](_0x3501f1=>!_0x3501f1[_0x5c6509(0x167)])['map'](_0x598ef3=>_0x598ef3[_0x5c6509(0x106)])['flat']();if(_0x26c6b7[_0x5c6509(0x141)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x26c6b7);}async[a405_0x2ca3de(0x138)](_0x4dc2d9){const _0x54604b=a405_0x2ca3de;if(!this[_0x54604b(0x145)]){this['_systemLogger'][_0x54604b(0x13f)](_0x4dc2d9);return;}this[_0x54604b(0x105)][_0x54604b(0x10e)](_0x4dc2d9),await this['_logger'][_0x54604b(0x124)](),await this[_0x54604b(0x139)](![],!![],'');}async[a405_0x2ca3de(0x139)](_0xd3ef49,_0x3e4866,_0x29b57c){const _0x9059eb=a405_0x2ca3de,{id:_0x279bc0,organizationId:_0xb4d33e,branchId:_0x4fe9d2,organizationName:_0x3267d2}=this[_0x9059eb(0x145)],_0x580c50='<a\x20href='+this['_instanceUrl']+'/'+_0x279bc0+_0x9059eb(0x185)+_0x9059eb(0x13b)+_0x9059eb(0x13e),_0x4454d7=_0x9059eb(0x134)+this[_0x9059eb(0x147)]+'/'+_0xb4d33e+'\x20>'+_0x3267d2+_0x9059eb(0x130),_0x504230=_0x580c50+_0x9059eb(0x144)+_0x4454d7+_0x9059eb(0x10b),_0x45f627={[constants_1['FLOSUM_NAMESPACE']+'Action__c']:_0x504230,[constants_1[_0x9059eb(0x10d)]+_0x9059eb(0x16c)]:new Date(),[constants_1[_0x9059eb(0x10d)]+_0x9059eb(0x17d)]:_0x4fe9d2,[constants_1[_0x9059eb(0x10d)]+_0x9059eb(0x14c)]:_0x9059eb(0x100),[constants_1[_0x9059eb(0x10d)]+_0x9059eb(0x16f)]:_0x9059eb(0x161),[constants_1[_0x9059eb(0x10d)]+_0x9059eb(0x153)]:_0xb4d33e},_0x3eed37={[constants_1['FLOSUM_NAMESPACE']+_0x9059eb(0x150)]:!_0xd3ef49,[constants_1[_0x9059eb(0x10d)]+'Succeed__c']:_0xd3ef49,[constants_1[_0x9059eb(0x10d)]+_0x9059eb(0x12d)]:_0x3e4866?status_enums_1[_0x9059eb(0x16d)][_0x9059eb(0x120)]:status_enums_1[_0x9059eb(0x16d)][_0x9059eb(0x14d)],[constants_1[_0x9059eb(0x10d)]+'Job_Completed__c']:!![],[constants_1[_0x9059eb(0x10d)]+_0x9059eb(0x173)]:_0x29b57c};await this[_0x9059eb(0x11c)][_0x9059eb(0x13d)](flosum_constants_1[_0x9059eb(0x174)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x9059eb(0x10d)]+_0x9059eb(0x102)+this[_0x9059eb(0x121)],_0x3eed37),await this['_connectionSalesforce'][_0x9059eb(0x12f)](flosum_constants_1[_0x9059eb(0x174)][_0x9059eb(0xfa)]+'/'+constants_1[_0x9059eb(0x10d)]+'Log__c',_0x45f627),this[_0x9059eb(0x105)][_0x9059eb(0xff)](_0x9059eb(0x184)+(_0xd3ef49?_0x9059eb(0x17e):_0x9059eb(0x101))+'.'),await this[_0x9059eb(0x105)][_0x9059eb(0x124)]();}async[a405_0x2ca3de(0x12e)](){const _0x1798ad=a405_0x2ca3de;try{this['_metadataLog']=await this[_0x1798ad(0x13a)]();const _0x2dbbbf=await this[_0x1798ad(0x140)]();await this[_0x1798ad(0x105)][_0x1798ad(0x124)]();const _0x302768=await this[_0x1798ad(0xf8)](_0x2dbbbf),_0x4ce42f=await this[_0x1798ad(0x137)](_0x302768);await this[_0x1798ad(0x105)]['updateLog']();const _0x4f7c23=await this['_packageImportService']['import'](_0x4ce42f);await this[_0x1798ad(0x105)]['updateLog']();const _0x1422c5=this[_0x1798ad(0x176)](_0x4f7c23[_0x1798ad(0xfd)]);await this[_0x1798ad(0x16a)](_0x1422c5),await this[_0x1798ad(0x139)](_0x4f7c23['isDeployed'],![],_0x4f7c23[_0x1798ad(0xfe)]);}catch(_0x584508){await this[_0x1798ad(0x138)](_0x584508)[_0x1798ad(0x175)](_0x7446db=>this['_systemLogger'][_0x1798ad(0x13f)](_0x7446db));}}}exports[a405_0x2ca3de(0x11e)]=RollbackService;