const a361_0x4ce26f=a361_0x336e;(function(_0x36fd30,_0x22fad0){const _0x4da2d0=a361_0x336e,_0x42a659=_0x36fd30();while(!![]){try{const _0x216db2=parseInt(_0x4da2d0(0x1ee))/0x1+-parseInt(_0x4da2d0(0x1a2))/0x2+-parseInt(_0x4da2d0(0x1b3))/0x3+-parseInt(_0x4da2d0(0x1c2))/0x4+parseInt(_0x4da2d0(0x1b9))/0x5+parseInt(_0x4da2d0(0x1fa))/0x6+-parseInt(_0x4da2d0(0x1f3))/0x7;if(_0x216db2===_0x22fad0)break;else _0x42a659['push'](_0x42a659['shift']());}catch(_0x3a2a8a){_0x42a659['push'](_0x42a659['shift']());}}}(a361_0x4849,0xa433a));const a361_0x365776=(function(){let _0xe27301=!![];return function(_0x3c3a39,_0x452aa1){const _0x474133=_0xe27301?function(){const _0x5ea15c=a361_0x336e;if(_0x452aa1){const _0x5e1eda=_0x452aa1[_0x5ea15c(0x1d0)](_0x3c3a39,arguments);return _0x452aa1=null,_0x5e1eda;}}:function(){};return _0xe27301=![],_0x474133;};}()),a361_0x39bbe0=a361_0x365776(this,function(){const _0x29f96f=a361_0x336e;return a361_0x39bbe0[_0x29f96f(0x1c5)]()[_0x29f96f(0x1d1)](_0x29f96f(0x1ec))[_0x29f96f(0x1c5)]()[_0x29f96f(0x205)](a361_0x39bbe0)['search'](_0x29f96f(0x1ec));});a361_0x39bbe0();function a361_0x336e(_0x39ad15,_0x4508b8){const _0x2fc689=a361_0x4849();return a361_0x336e=function(_0x39bbe0,_0x365776){_0x39bbe0=_0x39bbe0-0x190;let _0x484912=_0x2fc689[_0x39bbe0];return _0x484912;},a361_0x336e(_0x39ad15,_0x4508b8);}'use strict';var __importDefault=this&&this[a361_0x4ce26f(0x1e1)]||function(_0x53aa19){const _0x528687=a361_0x4ce26f;return _0x53aa19&&_0x53aa19[_0x528687(0x19c)]?_0x53aa19:{'default':_0x53aa19};};Object[a361_0x4ce26f(0x198)](exports,a361_0x4ce26f(0x19c),{'value':!![]}),exports[a361_0x4ce26f(0x1c8)]=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a361_0x4ce26f(0x1d9)),package_import_service_1=require(a361_0x4ce26f(0x1d7)),id_deployment_result_retriever_1=require(a361_0x4ce26f(0x1ed)),flosum_constants_1=require(a361_0x4ce26f(0x1a5)),fetch_attachments_1=require(a361_0x4ce26f(0x199)),constants_1=require(a361_0x4ce26f(0x20d)),zip_creator_rollback_1=require(a361_0x4ce26f(0x197)),shortid_1=__importDefault(require(a361_0x4ce26f(0x1ff))),promises_1=require('fs/promises'),vpk_service_1=require(a361_0x4ce26f(0x216)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a361_0x4ce26f(0x1b0)),metadata_log_dto_1=require(a361_0x4ce26f(0x194)),core_1=require(a361_0x4ce26f(0x1f4));class RollbackService{constructor({connectionSalesforce:_0x466250,connectionVeeva:_0xcf5bef,logger:_0x3b5fe1,tempFolder:_0x16ff2a,instanceUrl:_0x34b1dc,timeZone:_0x350418,metadataLogId:_0x14e44a,attachmentLogId:_0x1047f7,parentMetadataLogId:_0x328d49,componentIds:_0x42e90f}){const _0xca93a5=a361_0x4ce26f;this[_0xca93a5(0x1c7)]=_0x466250,this[_0xca93a5(0x20c)]=_0xcf5bef,this[_0xca93a5(0x193)]=_0x3b5fe1,this[_0xca93a5(0x1e4)]=_0x16ff2a,this[_0xca93a5(0x1dd)]=_0x34b1dc,this[_0xca93a5(0x1a9)]=_0x350418,this[_0xca93a5(0x1c4)]=_0x14e44a,this['_attachmentLogId']=_0x1047f7,this[_0xca93a5(0x1de)]=_0x328d49,this['_componentIds']=_0x42e90f,this['_systemLogger']=new core_1[(_0xca93a5(0x1a8))](_0xca93a5(0x1bd)),this[_0xca93a5(0x1f9)]=new veeva_service_1[(_0xca93a5(0x1b7))]({'connection':_0xcf5bef,'logger':_0x3b5fe1}),this[_0xca93a5(0x1b5)]=new salesforce_service_1[(_0xca93a5(0x1dc))]({'connection':_0x466250}),this[_0xca93a5(0x214)]=new package_import_service_1[(_0xca93a5(0x1f6))]({'veevaService':this[_0xca93a5(0x1f9)],'connection':_0xcf5bef,'logger':_0x3b5fe1,'saveLog':this[_0xca93a5(0x203)]['bind'](this)}),this['_vpkService']=new vpk_service_1[(_0xca93a5(0x1b2))]({'connection':_0xcf5bef});}async[a361_0x4ce26f(0x203)](_0x2273a,_0x223b5f){const _0x3ccd14=a361_0x4ce26f;this[_0x3ccd14(0x193)]['log'](_0x3ccd14(0x1f2));const _0x1b9ab1={'Body':Buffer['from'](_0x2273a)[_0x3ccd14(0x1c5)](_0x3ccd14(0x1e5)),'ContentType':_0x3ccd14(0x1f5),'ParentId':this[_0x3ccd14(0x1c4)],'Name':_0x223b5f};await this[_0x3ccd14(0x1c7)][_0x3ccd14(0x1ae)](flosum_constants_1[_0x3ccd14(0x212)][_0x3ccd14(0x204)]+_0x3ccd14(0x1e8),_0x1b9ab1);}async[a361_0x4ce26f(0x1a3)](){const _0x419110=a361_0x4ce26f;this[_0x419110(0x193)][_0x419110(0x1eb)](_0x419110(0x1df));const [_0x5351d3]=await this['_salesforceService'][_0x419110(0x1ca)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x419110(0x1e3)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x419110(0x1e3)]+_0x419110(0x1cd)+constants_1[_0x419110(0x1e3)]+_0x419110(0x196)+constants_1['FLOSUM_NAMESPACE']+_0x419110(0x215)+this['_metadataLogId']+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1['MetadataLogDto'](_0x5351d3);}async[a361_0x4ce26f(0x1fb)](){const _0x1ded0d=a361_0x4ce26f;this[_0x1ded0d(0x193)][_0x1ded0d(0x1eb)](_0x1ded0d(0x1da));const _0x1cda99=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x1ded0d(0x1b5)],'value':this[_0x1ded0d(0x1d2)]})['retrieve']();if(!_0x1cda99[_0x1ded0d(0x1f8)])throw new Error(_0x1ded0d(0x1bf));return _0x1cda99;}async[a361_0x4ce26f(0x1b8)](){const _0x42b43b=a361_0x4ce26f;this[_0x42b43b(0x193)]['log'](_0x42b43b(0x1c6));const _0x3a3927=await this[_0x42b43b(0x1b5)][_0x42b43b(0x1ca)](_0x42b43b(0x1af)+this[_0x42b43b(0x1de)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0x42b43b(0x212)]['BACKUP_ZIP_NAME']+'\x27\x0a\x20\x20\x20\x20'),_0x27839b=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this['_connectionSalesforce'],[_0x3a3927[0x0]['Id']]),_0xefbd95=await(0x0,fetch_attachments_1[_0x42b43b(0x1f7)])(_0x27839b,this['_connectionSalesforce']);if(!_0xefbd95[_0x42b43b(0x1f8)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0xefbd95[0x0][_0x42b43b(0x213)][_0x42b43b(0x1a7)];}async[a361_0x4ce26f(0x1cc)](_0x4a53c2){const _0x3b7056=a361_0x4ce26f;this[_0x3b7056(0x193)]['log']('Create\x20zip\x20from\x20backup');const _0x5d4a87=await this[_0x3b7056(0x1b8)](),_0x172269=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this['_metadataLog'][_0x3b7056(0x1a6)],'backup':_0x5d4a87,'deploymentResults':_0x4a53c2})['create'](),_0x2f4fb0=this['_tempFolder']+'/'+(0x0,shortid_1[_0x3b7056(0x1be)])()+_0x3b7056(0x1bc);return await(0x0,promises_1[_0x3b7056(0x19a)])(_0x2f4fb0,_0x172269),_0x2f4fb0;}async['createVpk'](_0x161674){const _0x4efb1b=a361_0x4ce26f;this[_0x4efb1b(0x193)]['log']('Create\x20Vpk\x20package');const _0x2f0302=await this['_vpkService']['generate'](_0x161674),_0x4e7458=this[_0x4efb1b(0x1e4)]+'/vpk__'+_0x161674['slice'](_0x161674['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x4e7458,_0x2f0302),await this[_0x4efb1b(0x1a0)][_0x4efb1b(0x209)](_0x4e7458),_0x4e7458;}[a361_0x4ce26f(0x195)](_0x1aef25){const _0x5b606b=a361_0x4ce26f;return this[_0x5b606b(0x193)][_0x5b606b(0x1eb)](_0x5b606b(0x19f)),_0x1aef25['map'](_0x53ecec=>{const _0x5b5d5d=_0x5b606b;return this[_0x5b5d5d(0x193)][_0x5b5d5d(0x1eb)](_0x53ecec[_0x5b5d5d(0x1cb)]+'.'+_0x53ecec[_0x5b5d5d(0x1a6)]+_0x5b5d5d(0x1fc)+_0x53ecec[_0x5b5d5d(0x1c1)]),{[constants_1[_0x5b5d5d(0x1e3)]+_0x5b5d5d(0x191)]:_0x5b5d5d(0x1bb),[constants_1[_0x5b5d5d(0x1e3)]+'Status__c']:_0x53ecec[_0x5b5d5d(0x1c1)]===status_enums_1[_0x5b5d5d(0x202)][_0x5b5d5d(0x206)]?_0x5b5d5d(0x1ad):'Failure',[constants_1[_0x5b5d5d(0x1e3)]+'Result__c']:_0x53ecec['deploymentAction'],[constants_1[_0x5b5d5d(0x1e3)]+_0x5b5d5d(0x208)]:_0x53ecec[_0x5b5d5d(0x1a6)],[constants_1[_0x5b5d5d(0x1e3)]+_0x5b5d5d(0x1ce)]:_0x53ecec[_0x5b5d5d(0x1cb)],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Step_Name__c']:_0x53ecec[_0x5b5d5d(0x1d3)],[constants_1[_0x5b5d5d(0x1e3)]+_0x5b5d5d(0x1ab)]:this[_0x5b5d5d(0x1c0)]['organizationId'],[constants_1[_0x5b5d5d(0x1e3)]+_0x5b5d5d(0x1d5)]:this[_0x5b5d5d(0x1c4)]};});}async[a361_0x4ce26f(0x1d4)](_0x5d920a){const _0x27999f=a361_0x4ce26f;this['_logger'][_0x27999f(0x1eb)](_0x27999f(0x1ba));const _0xab8635=await this[_0x27999f(0x1b5)]['insertMultipleRecords'](constants_1[_0x27999f(0x1e3)]+'Deployment_Result__c',_0x5d920a),_0x1bcfae=_0xab8635['filter'](_0x57b0dc=>!_0x57b0dc['success'])[_0x27999f(0x1cf)](_0x2b6b3e=>_0x2b6b3e['errors'])[_0x27999f(0x200)]();if(_0x1bcfae[_0x27999f(0x1f8)])throw new salesforce_dml_error_1[(_0x27999f(0x20e))](_0x1bcfae);}async[a361_0x4ce26f(0x1b4)](_0x11ce4f){const _0x8042fb=a361_0x4ce26f;if(!this[_0x8042fb(0x1c0)]){this[_0x8042fb(0x20a)][_0x8042fb(0x1d8)](_0x11ce4f);return;}this[_0x8042fb(0x193)][_0x8042fb(0x1fe)](_0x11ce4f),await this[_0x8042fb(0x193)][_0x8042fb(0x210)](),await this[_0x8042fb(0x1ea)](![],!![],'');}async[a361_0x4ce26f(0x1ea)](_0x494ee5,_0x5ab275,_0x27fba1){const _0x1148cf=a361_0x4ce26f,{id:_0x526675,organizationId:_0x53ff76,branchId:_0x2636c0,organizationName:_0x167ac3}=this[_0x1148cf(0x1c0)],_0x3bdd4f=_0x1148cf(0x207)+this[_0x1148cf(0x1dd)]+'/'+_0x526675+_0x1148cf(0x19d)+'Veeva\x20Rollback\x20(Deployment)'+_0x1148cf(0x1a1),_0x507cff=_0x1148cf(0x207)+this['_instanceUrl']+'/'+_0x53ff76+'\x20>'+_0x167ac3+_0x1148cf(0x1e7),_0x348efe=_0x3bdd4f+_0x1148cf(0x211)+_0x507cff+_0x1148cf(0x1f1),_0x1b55dc={[constants_1['FLOSUM_NAMESPACE']+_0x1148cf(0x1ac)]:_0x348efe,[constants_1[_0x1148cf(0x1e3)]+_0x1148cf(0x190)]:new Date(),[constants_1[_0x1148cf(0x1e3)]+_0x1148cf(0x1fd)]:_0x2636c0,[constants_1[_0x1148cf(0x1e3)]+'Activity_Item__c']:_0x1148cf(0x19e),[constants_1[_0x1148cf(0x1e3)]+_0x1148cf(0x1d6)]:_0x1148cf(0x1b1),[constants_1[_0x1148cf(0x1e3)]+'TargetId__c']:_0x53ff76},_0x5c10e2={[constants_1[_0x1148cf(0x1e3)]+'Is_Error__c']:!_0x494ee5,[constants_1[_0x1148cf(0x1e3)]+_0x1148cf(0x1db)]:_0x494ee5,[constants_1[_0x1148cf(0x1e3)]+_0x1148cf(0x20f)]:_0x5ab275?status_enums_1['MetadataLogStatus'][_0x1148cf(0x1c3)]:status_enums_1[_0x1148cf(0x1e0)][_0x1148cf(0x1f0)],[constants_1[_0x1148cf(0x1e3)]+_0x1148cf(0x1e2)]:!![],[constants_1[_0x1148cf(0x1e3)]+_0x1148cf(0x1c9)]:_0x27fba1};await this[_0x1148cf(0x1c7)][_0x1148cf(0x217)](flosum_constants_1[_0x1148cf(0x212)][_0x1148cf(0x204)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c/'+this[_0x1148cf(0x1c4)],_0x5c10e2),await this[_0x1148cf(0x1c7)][_0x1148cf(0x1ae)](flosum_constants_1[_0x1148cf(0x212)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x1148cf(0x20b),_0x1b55dc),this[_0x1148cf(0x193)]['log'](_0x1148cf(0x1e9)+(_0x494ee5?_0x1148cf(0x1e6):_0x1148cf(0x201))+'.'),await this[_0x1148cf(0x193)][_0x1148cf(0x210)]();}async[a361_0x4ce26f(0x19b)](){const _0x4f4ec6=a361_0x4ce26f;try{this[_0x4f4ec6(0x1c0)]=await this[_0x4f4ec6(0x1a3)]();const _0x1f8483=await this[_0x4f4ec6(0x1fb)]();await this['_logger'][_0x4f4ec6(0x210)]();const _0x2d69c7=await this[_0x4f4ec6(0x1cc)](_0x1f8483),_0x2a6dcc=await this[_0x4f4ec6(0x1aa)](_0x2d69c7);await this[_0x4f4ec6(0x193)][_0x4f4ec6(0x210)]();const _0x57d301=await this[_0x4f4ec6(0x214)]['import'](_0x2a6dcc);await this[_0x4f4ec6(0x193)][_0x4f4ec6(0x210)]();const _0x5200bb=this['formFlosumDeploymentResults'](_0x57d301[_0x4f4ec6(0x1ef)]);await this['saveDeploymentResults'](_0x5200bb),await this[_0x4f4ec6(0x1ea)](_0x57d301[_0x4f4ec6(0x1b6)],![],_0x57d301[_0x4f4ec6(0x1a4)]);}catch(_0x4ac2a9){await this[_0x4f4ec6(0x1b4)](_0x4ac2a9)[_0x4f4ec6(0x192)](_0x2cf676=>this['_systemLogger'][_0x4f4ec6(0x1d8)](_0x2cf676));}}}exports[a361_0x4ce26f(0x1c8)]=RollbackService;function a361_0x4849(){const _0x2c023a=['\x20</a>','876566yXYWnq','retrieveMetadataLog','packageId','../constants/flosum.constants','name','Body','Logger','_timeZone','createVpk','Org__c','Action__c','Success','post','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','../classes/errors/salesforce-dml-error','Deployment','VpkService','2183541axaZwG','finishRollbackWithError','_salesforceService','isDeployed','VeevaService','retrieveBackup','6525265NwxbMs','Save\x20Deployment\x20Results','Deployment\x20Result','.zip','veeva-rollback','default','Cannot\x20find\x20Deployment\x20Results','_metadataLog','status','329988HQBtlJ','EXCEPTION','_metadataLogId','toString','Retrieve\x20Backup','_connectionSalesforce','RollbackService','Async_Request_Id__c','retrieveRecords','type','createZip','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Component_Type__c','map','apply','search','_componentIds','stepName','saveDeploymentResults','Metadata_Log__c','Activity_Type__c','./package-import.service','error','./salesforce.service','Retrieve\x20Deployment\x20Results','Succeed__c','SalesforceService','_instanceUrl','_parentMetadataLogId','Retrieve\x20Metadata\x20Log\x20info','MetadataLogStatus','__importDefault','Job_Completed__c','FLOSUM_NAMESPACE','_tempFolder','base64','successfully','</a>','/Attachment','Rollback\x20completed\x20','finishRollback','log','(((.+)+)+)+$','../classes/retrievers/deployment-results/id.deployment-result.retriever','1017643SywDTv','packageComponentList','COMPLETED','\x20has\x20been\x20created.','Save\x20log','8238811GNjNeL','../../../core','text/plain','PackageImportService','retrieveAttachments','length','_veevaService','4652844BKaNld','retrieveDeploymentResults','\x20:\x20','Branch__c','logError','shortid','flat','with\x20error','PackageComponentStatus','saveLog','ENDPOINT_UPSERT_RECORD','constructor','DEPLOYED','<a\x20href=','Component_Name__c','validate','_systemLogger','Log__c','_connectionVeeva','../../../constants','SalesforceDmlError','Status__c','updateLog','\x20of\x20branch\x20to\x20Organization\x20','FlosumConstants','values','_packageImportService','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','./vpk.service','patch','Date__c','Type__c','catch','_logger','../dtos/metadata-log.dto','formFlosumDeploymentResults','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','../classes/rollback/zip-creator.rollback','defineProperty','../../shared/utils/fetch-attachments','writeFile','execute','__esModule','\x20>\x20','Branch','Form\x20Deployment\x20Results','_vpkService'];a361_0x4849=function(){return _0x2c023a;};return a361_0x4849();}