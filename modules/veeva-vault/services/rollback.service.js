const a360_0x5018a1=a360_0x17ef;(function(_0x5de3f9,_0x582195){const _0x2f96dc=a360_0x17ef,_0x58425e=_0x5de3f9();while(!![]){try{const _0x2ea7f2=parseInt(_0x2f96dc(0x1b6))/0x1+-parseInt(_0x2f96dc(0x1ef))/0x2+parseInt(_0x2f96dc(0x1ac))/0x3*(-parseInt(_0x2f96dc(0x1ed))/0x4)+parseInt(_0x2f96dc(0x1d5))/0x5+parseInt(_0x2f96dc(0x1a1))/0x6*(parseInt(_0x2f96dc(0x1cd))/0x7)+parseInt(_0x2f96dc(0x19d))/0x8*(parseInt(_0x2f96dc(0x192))/0x9)+-parseInt(_0x2f96dc(0x1ca))/0xa;if(_0x2ea7f2===_0x582195)break;else _0x58425e['push'](_0x58425e['shift']());}catch(_0x30e257){_0x58425e['push'](_0x58425e['shift']());}}}(a360_0x5154,0xe66f7));const a360_0x154c15=(function(){let _0xab5264=!![];return function(_0x44ca85,_0x22e867){const _0x4d735f=_0xab5264?function(){const _0x3ec0e9=a360_0x17ef;if(_0x22e867){const _0x42eab7=_0x22e867[_0x3ec0e9(0x1ce)](_0x44ca85,arguments);return _0x22e867=null,_0x42eab7;}}:function(){};return _0xab5264=![],_0x4d735f;};}()),a360_0x21389b=a360_0x154c15(this,function(){const _0x438f1f=a360_0x17ef;return a360_0x21389b[_0x438f1f(0x1eb)]()[_0x438f1f(0x17e)](_0x438f1f(0x190))[_0x438f1f(0x1eb)]()[_0x438f1f(0x19c)](a360_0x21389b)[_0x438f1f(0x17e)]('(((.+)+)+)+$');});function a360_0x17ef(_0x5d6fbb,_0x1c6dae){const _0x188264=a360_0x5154();return a360_0x17ef=function(_0x21389b,_0x154c15){_0x21389b=_0x21389b-0x16d;let _0x515409=_0x188264[_0x21389b];return _0x515409;},a360_0x17ef(_0x5d6fbb,_0x1c6dae);}a360_0x21389b();'use strict';var __importDefault=this&&this['__importDefault']||function(_0xa2b797){const _0x14235b=a360_0x17ef;return _0xa2b797&&_0xa2b797[_0x14235b(0x1f6)]?_0xa2b797:{'default':_0xa2b797};};Object[a360_0x5018a1(0x1e8)](exports,a360_0x5018a1(0x1f6),{'value':!![]}),exports['RollbackService']=void 0x0;function a360_0x5154(){const _0x4f62f3=['_veevaService','TargetId__c','_systemLogger','packageComponentList','SalesforceDmlError','finishRollback','constructor','136JkZzse','_tempFolder','Create\x20Vpk\x20package','with\x20error','23538RKAtOT','PackageImportService','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','slice','../classes/rollback/zip-creator.rollback','catch','stepName','updateLog','createVpk','organizationId','retrieveRecords','51exPLtV','_timeZone','fs/promises','VeevaService','flat','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','veeva-rollback','_attachmentLogId','\x27\x0a\x20\x20\x20\x20','SalesforceService','1641388XDUuCa','execute','_metadataLogId','saveLog','deploymentAction','values','log','retrieve','BACKUP_ZIP_NAME','Status__c','validate','Body','Date__c','fetchAttachmentsDetailsById','Succeed__c','../classes/errors/salesforce-dml-error','Failure','Type__c','filter','../enums/status.enums','17912970huuGLe','generate','Is_Error__c','1757zFVkhs','apply','Metadata_Log__c/','bind','formFlosumDeploymentResults','map','\x20>\x20','error','54005PRNvBI','../../shared/utils/fetch-attachments','_componentIds','logError','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','retrieveDeploymentResults','Create\x20zip\x20from\x20backup','/Attachment','</a>','\x20of\x20branch\x20to\x20Organization\x20','length','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Component_Type__c','Success','_metadataLog','writeFile','from','patch','Branch','defineProperty','Cannot\x20find\x20Backup\x20Zip','retrieveBackup','toString','name','69076wYBHBg','_salesforceService','577584ypxMBQ','retrieveMetadataLog','finishRollbackWithError','Activity_Type__c','Form\x20Deployment\x20Results','MetadataLogStatus','../../../core','__esModule','../dtos/metadata-log.dto','Async_Request_Id__c','packageId','COMPLETED','Deployment_Result__c','../constants/flosum.constants','Retrieve\x20Deployment\x20Results','DEPLOYED','../classes/retrievers/deployment-results/id.deployment-result.retriever','retrieveAttachments','_logger','_parentMetadataLogId','RollbackService','_packageImportService','text/plain','FlosumConstants','saveDeploymentResults','./package-import.service','_connectionSalesforce','Deployment\x20Result','type','post','insertMultipleRecords','IdDeploymentResultRetriever','Component_Name__c','shortid','search','Job_Completed__c','Retrieve\x20Metadata\x20Log\x20info','.zip','status','_vpkService','Log__c','FLOSUM_NAMESPACE','Result__c','create','_instanceUrl','Branch__c','Cannot\x20find\x20Deployment\x20Results','createZip','Logger','ENDPOINT_UPSERT_RECORD','base64','lastIndexOf','(((.+)+)+)+$','\x27\x20AND\x20Name\x20=\x20\x27','360351BBvRVa','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../../../constants','_connectionVeeva'];a360_0x5154=function(){return _0x4f62f3;};return a360_0x5154();}const veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a360_0x5018a1(0x175)),id_deployment_result_retriever_1=require(a360_0x5018a1(0x1ff)),flosum_constants_1=require(a360_0x5018a1(0x1fc)),fetch_attachments_1=require(a360_0x5018a1(0x1d6)),constants_1=require(a360_0x5018a1(0x194)),zip_creator_rollback_1=require(a360_0x5018a1(0x1a5)),shortid_1=__importDefault(require(a360_0x5018a1(0x17d))),promises_1=require(a360_0x5018a1(0x1ae)),vpk_service_1=require('./vpk.service'),status_enums_1=require(a360_0x5018a1(0x1c9)),salesforce_dml_error_1=require(a360_0x5018a1(0x1c5)),metadata_log_dto_1=require(a360_0x5018a1(0x1f7)),core_1=require(a360_0x5018a1(0x1f5));class RollbackService{constructor({connectionSalesforce:_0x23d93f,connectionVeeva:_0x49d5f1,logger:_0x4750bf,tempFolder:_0x148aca,instanceUrl:_0x4b6b03,timeZone:_0x335274,metadataLogId:_0x1783b9,attachmentLogId:_0x46149c,parentMetadataLogId:_0x289890,componentIds:_0x16ad99}){const _0x38c5a0=a360_0x5018a1;this[_0x38c5a0(0x176)]=_0x23d93f,this[_0x38c5a0(0x195)]=_0x49d5f1,this[_0x38c5a0(0x16e)]=_0x4750bf,this[_0x38c5a0(0x19e)]=_0x148aca,this[_0x38c5a0(0x188)]=_0x4b6b03,this[_0x38c5a0(0x1ad)]=_0x335274,this[_0x38c5a0(0x1b8)]=_0x1783b9,this[_0x38c5a0(0x1b3)]=_0x46149c,this[_0x38c5a0(0x16f)]=_0x289890,this['_componentIds']=_0x16ad99,this[_0x38c5a0(0x198)]=new core_1[(_0x38c5a0(0x18c))](_0x38c5a0(0x1b2)),this[_0x38c5a0(0x196)]=new veeva_service_1[(_0x38c5a0(0x1af))]({'connection':_0x49d5f1,'logger':_0x4750bf}),this[_0x38c5a0(0x1ee)]=new salesforce_service_1[(_0x38c5a0(0x1b5))]({'connection':_0x23d93f}),this['_packageImportService']=new package_import_service_1[(_0x38c5a0(0x1a2))]({'veevaService':this[_0x38c5a0(0x196)],'connection':_0x49d5f1,'logger':_0x4750bf,'saveLog':this[_0x38c5a0(0x1b9)][_0x38c5a0(0x1d0)](this)}),this[_0x38c5a0(0x183)]=new vpk_service_1['VpkService']({'connection':_0x49d5f1});}async['saveLog'](_0x540138,_0x274572){const _0x37e83a=a360_0x5018a1;this[_0x37e83a(0x16e)]['log']('Save\x20log');const _0x1baeac={'Body':Buffer[_0x37e83a(0x1e5)](_0x540138)[_0x37e83a(0x1eb)](_0x37e83a(0x18e)),'ContentType':_0x37e83a(0x172),'ParentId':this['_metadataLogId'],'Name':_0x274572};await this[_0x37e83a(0x176)][_0x37e83a(0x179)](flosum_constants_1[_0x37e83a(0x173)][_0x37e83a(0x18d)]+_0x37e83a(0x1dc),_0x1baeac);}async[a360_0x5018a1(0x1f0)](){const _0x131244=a360_0x5018a1;this[_0x131244(0x16e)][_0x131244(0x1bc)](_0x131244(0x180));const [_0x28a51b]=await this['_salesforceService'][_0x131244(0x1ab)](_0x131244(0x193)+constants_1[_0x131244(0x185)]+_0x131244(0x1e0)+constants_1[_0x131244(0x185)]+_0x131244(0x1b1)+constants_1[_0x131244(0x185)]+_0x131244(0x1a3)+constants_1[_0x131244(0x185)]+_0x131244(0x1d9)+this[_0x131244(0x1b8)]+_0x131244(0x1b4));return new metadata_log_dto_1['MetadataLogDto'](_0x28a51b);}async[a360_0x5018a1(0x1da)](){const _0x279bfe=a360_0x5018a1;this[_0x279bfe(0x16e)][_0x279bfe(0x1bc)](_0x279bfe(0x1fd));const _0x4306e8=await new id_deployment_result_retriever_1[(_0x279bfe(0x17b))]({'salesforceService':this['_salesforceService'],'value':this[_0x279bfe(0x1d7)]})[_0x279bfe(0x1bd)]();if(!_0x4306e8[_0x279bfe(0x1df)])throw new Error(_0x279bfe(0x18a));return _0x4306e8;}async[a360_0x5018a1(0x1ea)](){const _0x229047=a360_0x5018a1;this[_0x229047(0x16e)][_0x229047(0x1bc)]('Retrieve\x20Backup');const _0xf72a52=await this[_0x229047(0x1ee)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x229047(0x16f)]+_0x229047(0x191)+flosum_constants_1[_0x229047(0x173)][_0x229047(0x1be)]+'\x27\x0a\x20\x20\x20\x20'),_0x43c9a0=await(0x0,fetch_attachments_1[_0x229047(0x1c3)])(this['_connectionSalesforce'],[_0xf72a52[0x0]['Id']]),_0x11a9a2=await(0x0,fetch_attachments_1[_0x229047(0x16d)])(_0x43c9a0,this[_0x229047(0x176)]);if(!_0x11a9a2[_0x229047(0x1df)])throw new Error(_0x229047(0x1e9));return _0x11a9a2[0x0][_0x229047(0x1bb)][_0x229047(0x1c1)];}async[a360_0x5018a1(0x18b)](_0x3941ad){const _0x203f30=a360_0x5018a1;this[_0x203f30(0x16e)]['log'](_0x203f30(0x1db));const _0x2e5f12=await this['retrieveBackup'](),_0x44ee3c=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x203f30(0x1e3)][_0x203f30(0x1ec)],'backup':_0x2e5f12,'deploymentResults':_0x3941ad})[_0x203f30(0x187)](),_0x381764=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0x203f30(0x181);return await(0x0,promises_1[_0x203f30(0x1e4)])(_0x381764,_0x44ee3c),_0x381764;}async[a360_0x5018a1(0x1a9)](_0x5c958a){const _0x286add=a360_0x5018a1;this[_0x286add(0x16e)][_0x286add(0x1bc)](_0x286add(0x19f));const _0x458367=await this['_vpkService'][_0x286add(0x1cb)](_0x5c958a),_0x30f403=this[_0x286add(0x19e)]+'/vpk__'+_0x5c958a[_0x286add(0x1a4)](_0x5c958a[_0x286add(0x18f)]('/')+0x1);return await(0x0,promises_1[_0x286add(0x1e4)])(_0x30f403,_0x458367),await this[_0x286add(0x183)][_0x286add(0x1c0)](_0x30f403),_0x30f403;}[a360_0x5018a1(0x1d1)](_0x1c6ef5){const _0x3407fb=a360_0x5018a1;return this[_0x3407fb(0x16e)][_0x3407fb(0x1bc)](_0x3407fb(0x1f3)),_0x1c6ef5[_0x3407fb(0x1d2)](_0xae0fb4=>{const _0x4726e9=_0x3407fb;return this['_logger'][_0x4726e9(0x1bc)](_0xae0fb4[_0x4726e9(0x178)]+'.'+_0xae0fb4['name']+'\x20:\x20'+_0xae0fb4[_0x4726e9(0x182)]),{[constants_1['FLOSUM_NAMESPACE']+_0x4726e9(0x1c7)]:_0x4726e9(0x177),[constants_1[_0x4726e9(0x185)]+'Status__c']:_0xae0fb4['status']===status_enums_1['PackageComponentStatus'][_0x4726e9(0x1fe)]?_0x4726e9(0x1e2):_0x4726e9(0x1c6),[constants_1[_0x4726e9(0x185)]+_0x4726e9(0x186)]:_0xae0fb4[_0x4726e9(0x1ba)],[constants_1[_0x4726e9(0x185)]+_0x4726e9(0x17c)]:_0xae0fb4[_0x4726e9(0x1ec)],[constants_1[_0x4726e9(0x185)]+_0x4726e9(0x1e1)]:_0xae0fb4[_0x4726e9(0x178)],[constants_1[_0x4726e9(0x185)]+'Veeva_Step_Name__c']:_0xae0fb4[_0x4726e9(0x1a7)],[constants_1[_0x4726e9(0x185)]+'Org__c']:this['_metadataLog'][_0x4726e9(0x1aa)],[constants_1[_0x4726e9(0x185)]+'Metadata_Log__c']:this[_0x4726e9(0x1b8)]};});}async[a360_0x5018a1(0x174)](_0x28b48f){const _0x25a63a=a360_0x5018a1;this[_0x25a63a(0x16e)][_0x25a63a(0x1bc)]('Save\x20Deployment\x20Results');const _0x2f4426=await this[_0x25a63a(0x1ee)][_0x25a63a(0x17a)](constants_1['FLOSUM_NAMESPACE']+_0x25a63a(0x1fb),_0x28b48f),_0xd96bac=_0x2f4426[_0x25a63a(0x1c8)](_0x2c5793=>!_0x2c5793['success'])[_0x25a63a(0x1d2)](_0x413786=>_0x413786['errors'])[_0x25a63a(0x1b0)]();if(_0xd96bac[_0x25a63a(0x1df)])throw new salesforce_dml_error_1[(_0x25a63a(0x19a))](_0xd96bac);}async[a360_0x5018a1(0x1f1)](_0x47fa8d){const _0x4070bb=a360_0x5018a1;if(!this[_0x4070bb(0x1e3)]){this['_systemLogger'][_0x4070bb(0x1d4)](_0x47fa8d);return;}this['_logger'][_0x4070bb(0x1d8)](_0x47fa8d),await this[_0x4070bb(0x16e)]['updateLog'](),await this[_0x4070bb(0x19b)](![],!![],'');}async[a360_0x5018a1(0x19b)](_0x15f2d2,_0x489a20,_0x89cc1e){const _0x52f2a0=a360_0x5018a1,{id:_0x5f2a38,organizationId:_0x5c215b,branchId:_0x349438,organizationName:_0x4e9df0}=this[_0x52f2a0(0x1e3)],_0x25e157='<a\x20href='+this['_instanceUrl']+'/'+_0x5f2a38+_0x52f2a0(0x1d3)+'Veeva\x20Rollback\x20(Deployment)'+'\x20</a>',_0x4e6595='<a\x20href='+this[_0x52f2a0(0x188)]+'/'+_0x5c215b+'\x20>'+_0x4e9df0+_0x52f2a0(0x1dd),_0x1a1f2a=_0x25e157+_0x52f2a0(0x1de)+_0x4e6595+'\x20has\x20been\x20created.',_0x1ecf86={[constants_1['FLOSUM_NAMESPACE']+'Action__c']:_0x1a1f2a,[constants_1['FLOSUM_NAMESPACE']+_0x52f2a0(0x1c2)]:new Date(),[constants_1[_0x52f2a0(0x185)]+_0x52f2a0(0x189)]:_0x349438,[constants_1['FLOSUM_NAMESPACE']+'Activity_Item__c']:_0x52f2a0(0x1e7),[constants_1[_0x52f2a0(0x185)]+_0x52f2a0(0x1f2)]:'Deployment',[constants_1[_0x52f2a0(0x185)]+_0x52f2a0(0x197)]:_0x5c215b},_0x27f92c={[constants_1[_0x52f2a0(0x185)]+_0x52f2a0(0x1cc)]:!_0x15f2d2,[constants_1[_0x52f2a0(0x185)]+_0x52f2a0(0x1c4)]:_0x15f2d2,[constants_1[_0x52f2a0(0x185)]+_0x52f2a0(0x1bf)]:_0x489a20?status_enums_1[_0x52f2a0(0x1f4)]['EXCEPTION']:status_enums_1[_0x52f2a0(0x1f4)][_0x52f2a0(0x1fa)],[constants_1['FLOSUM_NAMESPACE']+_0x52f2a0(0x17f)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x52f2a0(0x1f8)]:_0x89cc1e};await this[_0x52f2a0(0x176)][_0x52f2a0(0x1e6)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x52f2a0(0x1cf)+this[_0x52f2a0(0x1b8)],_0x27f92c),await this[_0x52f2a0(0x176)][_0x52f2a0(0x179)](flosum_constants_1[_0x52f2a0(0x173)][_0x52f2a0(0x18d)]+'/'+constants_1[_0x52f2a0(0x185)]+_0x52f2a0(0x184),_0x1ecf86),this[_0x52f2a0(0x16e)][_0x52f2a0(0x1bc)]('Rollback\x20completed\x20'+(_0x15f2d2?'successfully':_0x52f2a0(0x1a0))+'.'),await this[_0x52f2a0(0x16e)][_0x52f2a0(0x1a8)]();}async[a360_0x5018a1(0x1b7)](){const _0x31a700=a360_0x5018a1;try{this[_0x31a700(0x1e3)]=await this[_0x31a700(0x1f0)]();const _0x53369c=await this[_0x31a700(0x1da)]();await this[_0x31a700(0x16e)]['updateLog']();const _0x4e91fb=await this[_0x31a700(0x18b)](_0x53369c),_0x2b2945=await this[_0x31a700(0x1a9)](_0x4e91fb);await this[_0x31a700(0x16e)][_0x31a700(0x1a8)]();const _0x425e36=await this[_0x31a700(0x171)]['import'](_0x2b2945);await this[_0x31a700(0x16e)][_0x31a700(0x1a8)]();const _0x2f0e73=this[_0x31a700(0x1d1)](_0x425e36[_0x31a700(0x199)]);await this[_0x31a700(0x174)](_0x2f0e73),await this[_0x31a700(0x19b)](_0x425e36['isDeployed'],![],_0x425e36[_0x31a700(0x1f9)]);}catch(_0x5bf43e){await this[_0x31a700(0x1f1)](_0x5bf43e)[_0x31a700(0x1a6)](_0x17a44a=>this[_0x31a700(0x198)]['error'](_0x17a44a));}}}exports[a360_0x5018a1(0x170)]=RollbackService;