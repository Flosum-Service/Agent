const a377_0x4c0a78=a377_0x2b8c;(function(_0x417911,_0x521371){const _0x5a8f09=a377_0x2b8c,_0x3b3709=_0x417911();while(!![]){try{const _0x1f7e56=-parseInt(_0x5a8f09(0xfd))/0x1*(-parseInt(_0x5a8f09(0xaa))/0x2)+parseInt(_0x5a8f09(0x102))/0x3*(-parseInt(_0x5a8f09(0xa5))/0x4)+parseInt(_0x5a8f09(0xce))/0x5+-parseInt(_0x5a8f09(0xb1))/0x6+parseInt(_0x5a8f09(0x111))/0x7+-parseInt(_0x5a8f09(0xa0))/0x8*(parseInt(_0x5a8f09(0x11d))/0x9)+-parseInt(_0x5a8f09(0xc3))/0xa*(-parseInt(_0x5a8f09(0xb2))/0xb);if(_0x1f7e56===_0x521371)break;else _0x3b3709['push'](_0x3b3709['shift']());}catch(_0x45403b){_0x3b3709['push'](_0x3b3709['shift']());}}}(a377_0x37a4,0x304a5));const a377_0x4c9b90=(function(){let _0x5a0611=!![];return function(_0x900439,_0xafa6b9){const _0x263f39=_0x5a0611?function(){const _0x4eb5b7=a377_0x2b8c;if(_0xafa6b9){const _0x2550c0=_0xafa6b9[_0x4eb5b7(0xe1)](_0x900439,arguments);return _0xafa6b9=null,_0x2550c0;}}:function(){};return _0x5a0611=![],_0x263f39;};}()),a377_0x58682e=a377_0x4c9b90(this,function(){const _0x2aeee2=a377_0x2b8c;return a377_0x58682e[_0x2aeee2(0x11c)]()[_0x2aeee2(0x94)]('(((.+)+)+)+$')['toString']()[_0x2aeee2(0xeb)](a377_0x58682e)[_0x2aeee2(0x94)](_0x2aeee2(0xef));});a377_0x58682e();'use strict';function a377_0x37a4(){const _0x514401=['Is_Error__c','name','retrieveRecords','bind','./veeva.service','../../shared/utils/fetch-attachments','408342IuhENR','2736833cNWKaP','VeevaService','default','saveLog','catch','create','errors','logError','execute','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Activity_Type__c','Failure','isDeployed','flat','type','_salesforceService','post','10jtVAbu','IdDeploymentResultRetriever','_instanceUrl','createVpk','retrieveDeploymentResults','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','SalesforceService','retrieveBackup','\x20of\x20branch\x20to\x20Organization\x20','shortid','../classes/rollback/zip-creator.rollback','872840YwqyUq','ENDPOINT_UPSERT_RECORD','MetadataLogStatus','fetchAttachmentsDetailsById','EXCEPTION','FlosumConstants','Branch__c','../enums/status.enums','_componentIds','Retrieve\x20Metadata\x20Log\x20info','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','slice','retrieveAttachments','SalesforceDmlError','\x20>\x20','_tempFolder','status','Org__c','with\x20error','apply','error','BACKUP_ZIP_NAME','insertMultipleRecords','_logger','defineProperty','../constants/flosum.constants','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Component_Type__c','_connectionSalesforce','constructor','lastIndexOf','DEPLOYED','_systemLogger','(((.+)+)+)+$','_packageImportService','./vpk.service','saveDeploymentResults','finishRollback','Activity_Item__c','TargetId__c','Veeva_Step_Name__c','.zip','updateLog','_veevaService','../../../constants','Body','Result__c','199imrAOM','packageId','\x20</a>','../classes/retrievers/deployment-results/id.deployment-result.retriever','RollbackService','583305meGMQm','_metadataLogId','writeFile','Cannot\x20find\x20Deployment\x20Results','Deployment\x20Result','../classes/errors/salesforce-dml-error','_metadataLog','__esModule','length','Component_Name__c','_vpkService','Action__c','_attachmentLogId','Date__c','from','247807xJYkRT','</a>','Veeva\x20Rollback\x20(Deployment)','log','success','validate','<a\x20href=','retrieve','successfully','Status__c','./package-import.service','toString','9pNbsZJ','import','search','generate','map','FLOSUM_NAMESPACE','ZipCreatorRollback','base64','VpkService','finishRollbackWithError','Type__c','_parentMetadataLogId','/Attachment','veeva-rollback','3012664vgMdOx','Deployment','Success','Succeed__c','COMPLETED','4bZrnGV','createZip','filter','formFlosumDeploymentResults','Rollback\x20completed\x20','3800qUEsju'];a377_0x37a4=function(){return _0x514401;};return a377_0x37a4();}var __importDefault=this&&this['__importDefault']||function(_0x4b2281){const _0x1fbd46=a377_0x2b8c;return _0x4b2281&&_0x4b2281[_0x1fbd46(0x109)]?_0x4b2281:{'default':_0x4b2281};};Object[a377_0x4c0a78(0xe6)](exports,a377_0x4c0a78(0x109),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a377_0x4c0a78(0xaf)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a377_0x4c0a78(0x11b)),id_deployment_result_retriever_1=require(a377_0x4c0a78(0x100)),flosum_constants_1=require(a377_0x4c0a78(0xe7)),fetch_attachments_1=require(a377_0x4c0a78(0xb0)),constants_1=require(a377_0x4c0a78(0xfa)),zip_creator_rollback_1=require(a377_0x4c0a78(0xcd)),shortid_1=__importDefault(require(a377_0x4c0a78(0xcc))),promises_1=require('fs/promises'),vpk_service_1=require(a377_0x4c0a78(0xf1)),status_enums_1=require(a377_0x4c0a78(0xd5)),salesforce_dml_error_1=require(a377_0x4c0a78(0x107)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x3603d1,connectionVeeva:_0x103b2b,logger:_0x38f3a6,tempFolder:_0x42f5d0,instanceUrl:_0x3996db,timeZone:_0x5196cb,metadataLogId:_0x4f7e9f,attachmentLogId:_0x2f1165,parentMetadataLogId:_0x1bb3bf,componentIds:_0x54c482}){const _0x27fcc3=a377_0x4c0a78;this[_0x27fcc3(0xea)]=_0x3603d1,this['_connectionVeeva']=_0x103b2b,this[_0x27fcc3(0xe5)]=_0x38f3a6,this['_tempFolder']=_0x42f5d0,this[_0x27fcc3(0xc5)]=_0x3996db,this['_timeZone']=_0x5196cb,this['_metadataLogId']=_0x4f7e9f,this[_0x27fcc3(0x10e)]=_0x2f1165,this[_0x27fcc3(0x9d)]=_0x1bb3bf,this[_0x27fcc3(0xd6)]=_0x54c482,this['_systemLogger']=new core_1['Logger'](_0x27fcc3(0x9f)),this['_veevaService']=new veeva_service_1[(_0x27fcc3(0xb3))]({'connection':_0x103b2b,'logger':_0x38f3a6}),this[_0x27fcc3(0xc1)]=new salesforce_service_1[(_0x27fcc3(0xc9))]({'connection':_0x3603d1}),this[_0x27fcc3(0xf0)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x27fcc3(0xf9)],'connection':_0x103b2b,'logger':_0x38f3a6,'saveLog':this[_0x27fcc3(0xb5)][_0x27fcc3(0xae)](this)}),this['_vpkService']=new vpk_service_1[(_0x27fcc3(0x9a))]({'connection':_0x103b2b});}async[a377_0x4c0a78(0xb5)](_0xab9074,_0xf2cfc0){const _0x43cfed=a377_0x4c0a78;this[_0x43cfed(0xe5)][_0x43cfed(0x114)]('Save\x20log');const _0x1cfb63={'Body':Buffer[_0x43cfed(0x110)](_0xab9074)[_0x43cfed(0x11c)](_0x43cfed(0x99)),'ContentType':'text/plain','ParentId':this[_0x43cfed(0x103)],'Name':_0xf2cfc0};await this[_0x43cfed(0xea)][_0x43cfed(0xc2)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0x43cfed(0x9e),_0x1cfb63);}async['retrieveMetadataLog'](){const _0xcdec8d=a377_0x4c0a78;this['_logger']['log'](_0xcdec8d(0xd7));const [_0x5908e2]=await this[_0xcdec8d(0xc1)]['retrieveRecords'](_0xcdec8d(0xe8)+constants_1[_0xcdec8d(0x97)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0xcdec8d(0x97)]+_0xcdec8d(0xc8)+constants_1[_0xcdec8d(0x97)]+_0xcdec8d(0xbb)+constants_1[_0xcdec8d(0x97)]+_0xcdec8d(0xd8)+this[_0xcdec8d(0x103)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1['MetadataLogDto'](_0x5908e2);}async[a377_0x4c0a78(0xc7)](){const _0x2a02cf=a377_0x4c0a78;this['_logger'][_0x2a02cf(0x114)]('Retrieve\x20Deployment\x20Results');const _0x5ad097=await new id_deployment_result_retriever_1[(_0x2a02cf(0xc4))]({'salesforceService':this[_0x2a02cf(0xc1)],'value':this['_componentIds']})[_0x2a02cf(0x118)]();if(!_0x5ad097[_0x2a02cf(0x10a)])throw new Error(_0x2a02cf(0x105));return _0x5ad097;}async[a377_0x4c0a78(0xca)](){const _0x2f316f=a377_0x4c0a78;this[_0x2f316f(0xe5)][_0x2f316f(0x114)]('Retrieve\x20Backup');const _0x4601c0=await this[_0x2f316f(0xc1)][_0x2f316f(0xad)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x2f316f(0x9d)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0x2f316f(0xd3)][_0x2f316f(0xe3)]+'\x27\x0a\x20\x20\x20\x20'),_0x4db55f=await(0x0,fetch_attachments_1[_0x2f316f(0xd1)])(this[_0x2f316f(0xea)],[_0x4601c0[0x0]['Id']]),_0x1b2e1f=await(0x0,fetch_attachments_1[_0x2f316f(0xda)])(_0x4db55f,this[_0x2f316f(0xea)]);if(!_0x1b2e1f[_0x2f316f(0x10a)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x1b2e1f[0x0]['values'][_0x2f316f(0xfb)];}async[a377_0x4c0a78(0xa6)](_0x2f3ff9){const _0x3b2a0d=a377_0x4c0a78;this[_0x3b2a0d(0xe5)][_0x3b2a0d(0x114)]('Create\x20zip\x20from\x20backup');const _0x5d7c41=await this[_0x3b2a0d(0xca)](),_0x4660a9=await new zip_creator_rollback_1[(_0x3b2a0d(0x98))]({'rollbackName':this[_0x3b2a0d(0x108)]['name'],'backup':_0x5d7c41,'deploymentResults':_0x2f3ff9})[_0x3b2a0d(0xb7)](),_0x52850c=this[_0x3b2a0d(0xdd)]+'/'+(0x0,shortid_1[_0x3b2a0d(0xb4)])()+_0x3b2a0d(0xf7);return await(0x0,promises_1['writeFile'])(_0x52850c,_0x4660a9),_0x52850c;}async['createVpk'](_0x1409d3){const _0x8dba14=a377_0x4c0a78;this[_0x8dba14(0xe5)][_0x8dba14(0x114)]('Create\x20Vpk\x20package');const _0xd26a8a=await this[_0x8dba14(0x10c)][_0x8dba14(0x95)](_0x1409d3),_0x1d5df3=this[_0x8dba14(0xdd)]+'/vpk__'+_0x1409d3[_0x8dba14(0xd9)](_0x1409d3[_0x8dba14(0xec)]('/')+0x1);return await(0x0,promises_1[_0x8dba14(0x104)])(_0x1d5df3,_0xd26a8a),await this[_0x8dba14(0x10c)][_0x8dba14(0x116)](_0x1d5df3),_0x1d5df3;}[a377_0x4c0a78(0xa8)](_0xb30b97){const _0x369633=a377_0x4c0a78;return this['_logger'][_0x369633(0x114)]('Form\x20Deployment\x20Results'),_0xb30b97[_0x369633(0x96)](_0x4850ad=>{const _0xc7c28e=_0x369633;return this[_0xc7c28e(0xe5)][_0xc7c28e(0x114)](_0x4850ad[_0xc7c28e(0xc0)]+'.'+_0x4850ad['name']+'\x20:\x20'+_0x4850ad[_0xc7c28e(0xde)]),{[constants_1[_0xc7c28e(0x97)]+_0xc7c28e(0x9c)]:_0xc7c28e(0x106),[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x4850ad[_0xc7c28e(0xde)]===status_enums_1['PackageComponentStatus'][_0xc7c28e(0xed)]?_0xc7c28e(0xa2):_0xc7c28e(0xbd),[constants_1[_0xc7c28e(0x97)]+_0xc7c28e(0xfc)]:_0x4850ad['deploymentAction'],[constants_1[_0xc7c28e(0x97)]+_0xc7c28e(0x10b)]:_0x4850ad[_0xc7c28e(0xac)],[constants_1['FLOSUM_NAMESPACE']+_0xc7c28e(0xe9)]:_0x4850ad[_0xc7c28e(0xc0)],[constants_1[_0xc7c28e(0x97)]+_0xc7c28e(0xf6)]:_0x4850ad['stepName'],[constants_1[_0xc7c28e(0x97)]+_0xc7c28e(0xdf)]:this['_metadataLog']['organizationId'],[constants_1[_0xc7c28e(0x97)]+'Metadata_Log__c']:this[_0xc7c28e(0x103)]};});}async[a377_0x4c0a78(0xf2)](_0x579b07){const _0x5c8d08=a377_0x4c0a78;this[_0x5c8d08(0xe5)]['log']('Save\x20Deployment\x20Results');const _0x1d23fe=await this['_salesforceService'][_0x5c8d08(0xe4)](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x579b07),_0x4f2c42=_0x1d23fe[_0x5c8d08(0xa7)](_0x35a560=>!_0x35a560[_0x5c8d08(0x115)])[_0x5c8d08(0x96)](_0x23d7c7=>_0x23d7c7[_0x5c8d08(0xb8)])[_0x5c8d08(0xbf)]();if(_0x4f2c42[_0x5c8d08(0x10a)])throw new salesforce_dml_error_1[(_0x5c8d08(0xdb))](_0x4f2c42);}async[a377_0x4c0a78(0x9b)](_0x53136b){const _0x22900f=a377_0x4c0a78;if(!this[_0x22900f(0x108)]){this[_0x22900f(0xee)]['error'](_0x53136b);return;}this[_0x22900f(0xe5)][_0x22900f(0xb9)](_0x53136b),await this[_0x22900f(0xe5)][_0x22900f(0xf8)](),await this[_0x22900f(0xf3)](![],!![],'');}async[a377_0x4c0a78(0xf3)](_0x1d9543,_0x362f7a,_0x42de90){const _0x196b32=a377_0x4c0a78,{id:_0x440e05,organizationId:_0xe121fc,branchId:_0x5ce03e,organizationName:_0x51f3fd}=this[_0x196b32(0x108)],_0x1a1051=_0x196b32(0x117)+this[_0x196b32(0xc5)]+'/'+_0x440e05+_0x196b32(0xdc)+_0x196b32(0x113)+_0x196b32(0xff),_0x236621=_0x196b32(0x117)+this['_instanceUrl']+'/'+_0xe121fc+'\x20>'+_0x51f3fd+_0x196b32(0x112),_0x11c42a=_0x1a1051+_0x196b32(0xcb)+_0x236621+'\x20has\x20been\x20created.',_0x516ce7={[constants_1[_0x196b32(0x97)]+_0x196b32(0x10d)]:_0x11c42a,[constants_1[_0x196b32(0x97)]+_0x196b32(0x10f)]:new Date(),[constants_1[_0x196b32(0x97)]+_0x196b32(0xd4)]:_0x5ce03e,[constants_1[_0x196b32(0x97)]+_0x196b32(0xf4)]:'Branch',[constants_1[_0x196b32(0x97)]+_0x196b32(0xbc)]:_0x196b32(0xa1),[constants_1[_0x196b32(0x97)]+_0x196b32(0xf5)]:_0xe121fc},_0x5201c0={[constants_1[_0x196b32(0x97)]+_0x196b32(0xab)]:!_0x1d9543,[constants_1[_0x196b32(0x97)]+_0x196b32(0xa3)]:_0x1d9543,[constants_1[_0x196b32(0x97)]+_0x196b32(0x11a)]:_0x362f7a?status_enums_1[_0x196b32(0xd0)][_0x196b32(0xd2)]:status_enums_1['MetadataLogStatus'][_0x196b32(0xa4)],[constants_1['FLOSUM_NAMESPACE']+'Job_Completed__c']:!![],[constants_1[_0x196b32(0x97)]+'External_Deployment_Id__c']:_0x42de90};await this[_0x196b32(0xea)]['patch'](flosum_constants_1['FlosumConstants'][_0x196b32(0xcf)]+'/'+constants_1[_0x196b32(0x97)]+'Metadata_Log__c/'+this[_0x196b32(0x103)],_0x5201c0),await this['_connectionSalesforce'][_0x196b32(0xc2)](flosum_constants_1[_0x196b32(0xd3)][_0x196b32(0xcf)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0x516ce7),this['_logger'][_0x196b32(0x114)](_0x196b32(0xa9)+(_0x1d9543?_0x196b32(0x119):_0x196b32(0xe0))+'.'),await this[_0x196b32(0xe5)][_0x196b32(0xf8)]();}async[a377_0x4c0a78(0xba)](){const _0xae65bd=a377_0x4c0a78;try{this[_0xae65bd(0x108)]=await this['retrieveMetadataLog']();const _0x55f7a0=await this[_0xae65bd(0xc7)]();await this[_0xae65bd(0xe5)][_0xae65bd(0xf8)]();const _0x2dc77e=await this[_0xae65bd(0xa6)](_0x55f7a0),_0x321503=await this[_0xae65bd(0xc6)](_0x2dc77e);await this[_0xae65bd(0xe5)]['updateLog']();const _0x1255f8=await this['_packageImportService'][_0xae65bd(0x11e)](_0x321503);await this[_0xae65bd(0xe5)][_0xae65bd(0xf8)]();const _0x408e33=this[_0xae65bd(0xa8)](_0x1255f8['packageComponentList']);await this[_0xae65bd(0xf2)](_0x408e33),await this[_0xae65bd(0xf3)](_0x1255f8[_0xae65bd(0xbe)],![],_0x1255f8[_0xae65bd(0xfe)]);}catch(_0x20788d){await this[_0xae65bd(0x9b)](_0x20788d)[_0xae65bd(0xb6)](_0x5b20d5=>this['_systemLogger'][_0xae65bd(0xe2)](_0x5b20d5));}}}function a377_0x2b8c(_0x4aea89,_0x5ae71d){const _0x17c447=a377_0x37a4();return a377_0x2b8c=function(_0x58682e,_0x4c9b90){_0x58682e=_0x58682e-0x94;let _0x37a475=_0x17c447[_0x58682e];return _0x37a475;},a377_0x2b8c(_0x4aea89,_0x5ae71d);}exports[a377_0x4c0a78(0x101)]=RollbackService;