const a405_0x361dab=a405_0x42a9;(function(_0x349017,_0x20292e){const _0x2d5b4f=a405_0x42a9,_0x11276b=_0x349017();while(!![]){try{const _0x4b3871=-parseInt(_0x2d5b4f(0x107))/0x1*(parseInt(_0x2d5b4f(0xc8))/0x2)+parseInt(_0x2d5b4f(0xc4))/0x3+parseInt(_0x2d5b4f(0xf9))/0x4*(parseInt(_0x2d5b4f(0x94))/0x5)+-parseInt(_0x2d5b4f(0xac))/0x6*(-parseInt(_0x2d5b4f(0xd3))/0x7)+parseInt(_0x2d5b4f(0xf7))/0x8+parseInt(_0x2d5b4f(0xb0))/0x9+-parseInt(_0x2d5b4f(0x10d))/0xa*(parseInt(_0x2d5b4f(0x92))/0xb);if(_0x4b3871===_0x20292e)break;else _0x11276b['push'](_0x11276b['shift']());}catch(_0x161bdd){_0x11276b['push'](_0x11276b['shift']());}}}(a405_0x4049,0xa8d25));const a405_0x4c91c5=(function(){let _0x440013=!![];return function(_0x1fccb4,_0x2ece1c){const _0x5de2db=_0x440013?function(){const _0x27685d=a405_0x42a9;if(_0x2ece1c){const _0x734cd1=_0x2ece1c[_0x27685d(0xbc)](_0x1fccb4,arguments);return _0x2ece1c=null,_0x734cd1;}}:function(){};return _0x440013=![],_0x5de2db;};}()),a405_0x13e4d1=a405_0x4c91c5(this,function(){const _0xed926d=a405_0x42a9;return a405_0x13e4d1[_0xed926d(0xf5)]()['search'](_0xed926d(0x111))[_0xed926d(0xf5)]()[_0xed926d(0xbd)](a405_0x13e4d1)['search']('(((.+)+)+)+$');});a405_0x13e4d1();'use strict';var __importDefault=this&&this[a405_0x361dab(0x93)]||function(_0x28426f){return _0x28426f&&_0x28426f['__esModule']?_0x28426f:{'default':_0x28426f};};Object['defineProperty'](exports,a405_0x361dab(0x110),{'value':!![]}),exports[a405_0x361dab(0x101)]=void 0x0;function a405_0x42a9(_0x20bd99,_0x519857){const _0xf8995a=a405_0x4049();return a405_0x42a9=function(_0x13e4d1,_0x4c91c5){_0x13e4d1=_0x13e4d1-0x90;let _0x4049d8=_0xf8995a[_0x13e4d1];return _0x4049d8;},a405_0x42a9(_0x20bd99,_0x519857);}const veeva_service_1=require(a405_0x361dab(0x115)),salesforce_service_1=require(a405_0x361dab(0x9e)),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require(a405_0x361dab(0x125)),flosum_constants_1=require(a405_0x361dab(0xaf)),fetch_attachments_1=require(a405_0x361dab(0x95)),constants_1=require(a405_0x361dab(0xe4)),zip_creator_rollback_1=require(a405_0x361dab(0xa3)),shortid_1=__importDefault(require(a405_0x361dab(0x9a))),promises_1=require(a405_0x361dab(0xf6)),vpk_service_1=require(a405_0x361dab(0x113)),status_enums_1=require(a405_0x361dab(0xf0)),salesforce_dml_error_1=require(a405_0x361dab(0xea)),metadata_log_dto_1=require(a405_0x361dab(0x114)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x975c8c,connectionVeeva:_0x477f9b,logger:_0x11c5e6,tempFolder:_0x5009ac,instanceUrl:_0x14c6fb,timeZone:_0x273865,metadataLogId:_0x46a194,attachmentLogId:_0x5db3df,parentMetadataLogId:_0x59cff6,componentIds:_0x1b4c94}){const _0xcd4cd1=a405_0x361dab;this[_0xcd4cd1(0xe9)]=_0x975c8c,this[_0xcd4cd1(0xe1)]=_0x477f9b,this['_logger']=_0x11c5e6,this[_0xcd4cd1(0xb5)]=_0x5009ac,this[_0xcd4cd1(0xcb)]=_0x14c6fb,this[_0xcd4cd1(0xf4)]=_0x273865,this[_0xcd4cd1(0xe8)]=_0x46a194,this[_0xcd4cd1(0xab)]=_0x5db3df,this['_parentMetadataLogId']=_0x59cff6,this[_0xcd4cd1(0x96)]=_0x1b4c94,this[_0xcd4cd1(0x100)]=new core_1[(_0xcd4cd1(0xd4))](_0xcd4cd1(0x97)),this[_0xcd4cd1(0xe3)]=new veeva_service_1[(_0xcd4cd1(0xf1))]({'connection':_0x477f9b,'logger':_0x11c5e6}),this['_salesforceService']=new salesforce_service_1[(_0xcd4cd1(0xc3))]({'connection':_0x975c8c}),this['_packageImportService']=new package_import_service_1['PackageImportService']({'veevaService':this[_0xcd4cd1(0xe3)],'connection':_0x477f9b,'logger':_0x11c5e6,'saveLog':this[_0xcd4cd1(0xd9)][_0xcd4cd1(0x91)](this)}),this['_vpkService']=new vpk_service_1['VpkService']({'connection':_0x477f9b});}async[a405_0x361dab(0xd9)](_0x693a4e,_0x5ec938){const _0x143317=a405_0x361dab;this[_0x143317(0x123)][_0x143317(0xeb)](_0x143317(0x90));const _0xa3c1d0={'Body':Buffer[_0x143317(0xad)](_0x693a4e)['toString']('base64'),'ContentType':'text/plain','ParentId':this[_0x143317(0xe8)],'Name':_0x5ec938};await this[_0x143317(0xe9)][_0x143317(0xae)](flosum_constants_1[_0x143317(0xd2)][_0x143317(0xf3)]+'/Attachment',_0xa3c1d0);}async[a405_0x361dab(0x124)](){const _0x3683dc=a405_0x361dab;this['_logger'][_0x3683dc(0xeb)](_0x3683dc(0x11f));const [_0x500d37]=await this['_salesforceService']['retrieveRecords'](_0x3683dc(0xfa)+constants_1[_0x3683dc(0x9d)]+_0x3683dc(0xde)+constants_1[_0x3683dc(0x9d)]+_0x3683dc(0x104)+constants_1['FLOSUM_NAMESPACE']+_0x3683dc(0xce)+constants_1[_0x3683dc(0x9d)]+_0x3683dc(0xc7)+this['_metadataLogId']+_0x3683dc(0x11a));return new metadata_log_dto_1[(_0x3683dc(0xbf))](_0x500d37);}async[a405_0x361dab(0xd0)](){const _0x5a9b90=a405_0x361dab;this[_0x5a9b90(0x123)][_0x5a9b90(0xeb)]('Retrieve\x20Deployment\x20Results');const _0x5b16c0=await new id_deployment_result_retriever_1[(_0x5a9b90(0x11e))]({'salesforceService':this[_0x5a9b90(0xc6)],'value':this[_0x5a9b90(0x96)]})[_0x5a9b90(0x98)]();if(!_0x5b16c0[_0x5a9b90(0xca)])throw new Error(_0x5a9b90(0xb4));return _0x5b16c0;}async['retrieveBackup'](){const _0x3cba26=a405_0x361dab;this[_0x3cba26(0x123)][_0x3cba26(0xeb)](_0x3cba26(0xa4));const _0xf7190e=await this[_0x3cba26(0xc6)][_0x3cba26(0xa6)](_0x3cba26(0xb2)+this['_parentMetadataLogId']+_0x3cba26(0x10b)+flosum_constants_1[_0x3cba26(0xd2)][_0x3cba26(0xa2)]+_0x3cba26(0x11a)),_0x72cdac=await(0x0,fetch_attachments_1[_0x3cba26(0xff)])(this[_0x3cba26(0xe9)],[_0xf7190e[0x0]['Id']]),_0x1ddc89=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x72cdac,this[_0x3cba26(0xe9)]);if(!_0x1ddc89[_0x3cba26(0xca)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x1ddc89[0x0]['values']['Body'];}async[a405_0x361dab(0xc2)](_0x8ad80d){const _0x26baff=a405_0x361dab;this[_0x26baff(0x123)][_0x26baff(0xeb)](_0x26baff(0x11d));const _0xbf84fc=await this[_0x26baff(0xdd)](),_0x3ac2ab=await new zip_creator_rollback_1[(_0x26baff(0xb6))]({'rollbackName':this[_0x26baff(0xcd)][_0x26baff(0xcc)],'backup':_0xbf84fc,'deploymentResults':_0x8ad80d})['create'](),_0xd6f2a=this[_0x26baff(0xb5)]+'/'+(0x0,shortid_1[_0x26baff(0xef)])()+_0x26baff(0xdc);return await(0x0,promises_1['writeFile'])(_0xd6f2a,_0x3ac2ab),_0xd6f2a;}async[a405_0x361dab(0xa1)](_0x250b65){const _0x184198=a405_0x361dab;this[_0x184198(0x123)]['log'](_0x184198(0x10a));const _0x22e357=await this[_0x184198(0xe2)][_0x184198(0xe0)](_0x250b65),_0x445de1=this[_0x184198(0xb5)]+'/vpk__'+_0x250b65[_0x184198(0xd1)](_0x250b65[_0x184198(0x9b)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x445de1,_0x22e357),await this[_0x184198(0xe2)][_0x184198(0xdb)](_0x445de1),_0x445de1;}[a405_0x361dab(0xf2)](_0x33015e){const _0x39e65d=a405_0x361dab;return this['_logger']['log'](_0x39e65d(0xbe)),_0x33015e[_0x39e65d(0x9f)](_0x49e544=>{const _0x13b5cf=_0x39e65d;return this[_0x13b5cf(0x123)][_0x13b5cf(0xeb)](_0x49e544[_0x13b5cf(0x118)]+'.'+_0x49e544[_0x13b5cf(0xcc)]+_0x13b5cf(0xda)+_0x49e544[_0x13b5cf(0x102)]),{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:_0x13b5cf(0xa9),[constants_1[_0x13b5cf(0x9d)]+_0x13b5cf(0x108)]:_0x49e544[_0x13b5cf(0x102)]===status_enums_1[_0x13b5cf(0x11c)]['DEPLOYED']?_0x13b5cf(0x120):_0x13b5cf(0xba),[constants_1[_0x13b5cf(0x9d)]+_0x13b5cf(0xc9)]:_0x49e544['deploymentAction'],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x49e544[_0x13b5cf(0xcc)],[constants_1['FLOSUM_NAMESPACE']+_0x13b5cf(0xd8)]:_0x49e544[_0x13b5cf(0x118)],[constants_1[_0x13b5cf(0x9d)]+_0x13b5cf(0xf8)]:_0x49e544[_0x13b5cf(0x10f)],[constants_1[_0x13b5cf(0x9d)]+_0x13b5cf(0x103)]:this[_0x13b5cf(0xcd)]['organizationId'],[constants_1[_0x13b5cf(0x9d)]+_0x13b5cf(0xe5)]:this[_0x13b5cf(0xe8)]};});}async[a405_0x361dab(0xdf)](_0x1cf6e1){const _0x48578f=a405_0x361dab;this[_0x48578f(0x123)][_0x48578f(0xeb)](_0x48578f(0x122));const _0x190e09=await this[_0x48578f(0xc6)][_0x48578f(0xd5)](constants_1[_0x48578f(0x9d)]+'Deployment_Result__c',_0x1cf6e1),_0x4551b0=_0x190e09[_0x48578f(0xfe)](_0x25d0ea=>!_0x25d0ea['success'])['map'](_0xf060=>_0xf060[_0x48578f(0xb3)])[_0x48578f(0x11b)]();if(_0x4551b0[_0x48578f(0xca)])throw new salesforce_dml_error_1[(_0x48578f(0xfb))](_0x4551b0);}async['finishRollbackWithError'](_0x4855d2){const _0x1dee53=a405_0x361dab;if(!this[_0x1dee53(0xcd)]){this[_0x1dee53(0x100)][_0x1dee53(0x9c)](_0x4855d2);return;}this[_0x1dee53(0x123)][_0x1dee53(0xcf)](_0x4855d2),await this[_0x1dee53(0x123)][_0x1dee53(0xd6)](),await this['finishRollback'](![],!![],'');}async[a405_0x361dab(0x109)](_0x51d376,_0x457fa8,_0xed076d){const _0x458421=a405_0x361dab,{id:_0x2097da,organizationId:_0x5f517b,branchId:_0x1f348f,organizationName:_0x14e925}=this[_0x458421(0xcd)],_0x209e8b=_0x458421(0x99)+this[_0x458421(0xcb)]+'/'+_0x2097da+_0x458421(0x10e)+_0x458421(0xb9)+_0x458421(0xa5),_0x27bcc3='<a\x20href='+this[_0x458421(0xcb)]+'/'+_0x5f517b+'\x20>'+_0x14e925+_0x458421(0xfc),_0x40408c=_0x209e8b+_0x458421(0xc5)+_0x27bcc3+_0x458421(0xec),_0xc4cf1={[constants_1['FLOSUM_NAMESPACE']+_0x458421(0xc0)]:_0x40408c,[constants_1[_0x458421(0x9d)]+'Date__c']:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x458421(0x117)]:_0x1f348f,[constants_1[_0x458421(0x9d)]+'Activity_Item__c']:_0x458421(0x105),[constants_1[_0x458421(0x9d)]+_0x458421(0xe6)]:_0x458421(0xa8),[constants_1[_0x458421(0x9d)]+_0x458421(0x116)]:_0x5f517b},_0x413523={[constants_1[_0x458421(0x9d)]+_0x458421(0xed)]:!_0x51d376,[constants_1[_0x458421(0x9d)]+_0x458421(0xe7)]:_0x51d376,[constants_1[_0x458421(0x9d)]+_0x458421(0x108)]:_0x457fa8?status_enums_1[_0x458421(0xa0)]['EXCEPTION']:status_enums_1['MetadataLogStatus'][_0x458421(0x10c)],[constants_1[_0x458421(0x9d)]+_0x458421(0xb8)]:!![],[constants_1[_0x458421(0x9d)]+_0x458421(0xb1)]:_0xed076d};await this[_0x458421(0xe9)][_0x458421(0xaa)](flosum_constants_1[_0x458421(0xd2)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x458421(0x9d)]+_0x458421(0x119)+this['_metadataLogId'],_0x413523),await this[_0x458421(0xe9)][_0x458421(0xae)](flosum_constants_1[_0x458421(0xd2)][_0x458421(0xf3)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0xc4cf1),this[_0x458421(0x123)][_0x458421(0xeb)](_0x458421(0xa7)+(_0x51d376?_0x458421(0x121):_0x458421(0xbb))+'.'),await this[_0x458421(0x123)][_0x458421(0xd6)]();}async['execute'](){const _0xad89a=a405_0x361dab;try{this[_0xad89a(0xcd)]=await this[_0xad89a(0x124)]();const _0x4bce45=await this[_0xad89a(0xd0)]();await this[_0xad89a(0x123)][_0xad89a(0xd6)]();const _0x314b90=await this[_0xad89a(0xc2)](_0x4bce45),_0xc5018b=await this[_0xad89a(0xa1)](_0x314b90);await this[_0xad89a(0x123)][_0xad89a(0xd6)]();const _0x5c457f=await this[_0xad89a(0x106)][_0xad89a(0xfd)](_0xc5018b);await this[_0xad89a(0x123)][_0xad89a(0xd6)]();const _0x157664=this[_0xad89a(0xf2)](_0x5c457f[_0xad89a(0xee)]);await this[_0xad89a(0xdf)](_0x157664),await this[_0xad89a(0x109)](_0x5c457f[_0xad89a(0xc1)],![],_0x5c457f[_0xad89a(0xb7)]);}catch(_0x2aa397){await this[_0xad89a(0x112)](_0x2aa397)[_0xad89a(0xd7)](_0x58349e=>this[_0xad89a(0x100)]['error'](_0x58349e));}}}exports['RollbackService']=RollbackService;function a405_0x4049(){const _0x4c930e=['bind','1990681aEtadq','__importDefault','5wIyiwg','../../shared/utils/fetch-attachments','_componentIds','veeva-rollback','retrieve','<a\x20href=','shortid','lastIndexOf','error','FLOSUM_NAMESPACE','./salesforce.service','map','MetadataLogStatus','createVpk','BACKUP_ZIP_NAME','../classes/rollback/zip-creator.rollback','Retrieve\x20Backup','\x20</a>','retrieveRecords','Rollback\x20completed\x20','Deployment','Deployment\x20Result','patch','_attachmentLogId','2474034nHdusL','from','post','../constants/flosum.constants','11341971dVXPPr','External_Deployment_Id__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','errors','Cannot\x20find\x20Deployment\x20Results','_tempFolder','ZipCreatorRollback','packageId','Job_Completed__c','Veeva\x20Rollback\x20(Deployment)','Failure','with\x20error','apply','constructor','Form\x20Deployment\x20Results','MetadataLogDto','Action__c','isDeployed','createZip','SalesforceService','1930908fBVOUK','\x20of\x20branch\x20to\x20Organization\x20','_salesforceService','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','1628362OkQbsd','Result__c','length','_instanceUrl','name','_metadataLog','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','logError','retrieveDeploymentResults','slice','FlosumConstants','21GqyLGc','Logger','insertMultipleRecords','updateLog','catch','Component_Type__c','saveLog','\x20:\x20','validate','.zip','retrieveBackup','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','saveDeploymentResults','generate','_connectionVeeva','_vpkService','_veevaService','../../../constants','Metadata_Log__c','Activity_Type__c','Succeed__c','_metadataLogId','_connectionSalesforce','../classes/errors/salesforce-dml-error','log','\x20has\x20been\x20created.','Is_Error__c','packageComponentList','default','../enums/status.enums','VeevaService','formFlosumDeploymentResults','ENDPOINT_UPSERT_RECORD','_timeZone','toString','fs/promises','4992024pxPKuM','Veeva_Step_Name__c','3269224KNGikO','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','SalesforceDmlError','</a>','import','filter','fetchAttachmentsDetailsById','_systemLogger','RollbackService','status','Org__c','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Branch','_packageImportService','1eILZNV','Status__c','finishRollback','Create\x20Vpk\x20package','\x27\x20AND\x20Name\x20=\x20\x27','COMPLETED','170tRVAhl','\x20>\x20','stepName','__esModule','(((.+)+)+)+$','finishRollbackWithError','./vpk.service','../dtos/metadata-log.dto','./veeva.service','TargetId__c','Branch__c','type','Metadata_Log__c/','\x27\x0a\x20\x20\x20\x20','flat','PackageComponentStatus','Create\x20zip\x20from\x20backup','IdDeploymentResultRetriever','Retrieve\x20Metadata\x20Log\x20info','Success','successfully','Save\x20Deployment\x20Results','_logger','retrieveMetadataLog','../classes/retrievers/deployment-results/id.deployment-result.retriever','Save\x20log'];a405_0x4049=function(){return _0x4c930e;};return a405_0x4049();}