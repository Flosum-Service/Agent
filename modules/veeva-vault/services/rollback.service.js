function a404_0xe88a(){const _0x41c8b0=['Save\x20Deployment\x20Results','EXCEPTION','Deployment','deploymentAction','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','default','post','../../shared/utils/fetch-attachments','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','fs/promises','Result__c','length','values','import','_attachmentLogId','../enums/status.enums','FlosumConstants','retrieveDeploymentResults','_packageImportService','./veeva.service','_instanceUrl','208263jetaLg','/vpk__','_timeZone','./package-import.service','shortid','search','Form\x20Deployment\x20Results','updateLog','.zip','catch','Cannot\x20find\x20Deployment\x20Results','/Attachment','_systemLogger','retrieveRecords','<a\x20href=','Succeed__c','\x27\x20AND\x20Name\x20=\x20\x27','base64','177354TpRZJq','108AvOUiH','FLOSUM_NAMESPACE','lastIndexOf','error','</a>','ENDPOINT_UPSERT_RECORD','4MXtqvy','../../../constants','Deployment_Result__c','log','Is_Error__c','flat','_vpkService','378832MhxnoZ','Status__c','ZipCreatorRollback','../constants/flosum.constants','PackageImportService','SalesforceService','External_Deployment_Id__c','TargetId__c','createVpk','Metadata_Log__c/','_parentMetadataLogId','Log__c','VeevaService','Date__c','Create\x20zip\x20from\x20backup','./salesforce.service','retrieveAttachments','Branch','PackageComponentStatus','\x20>\x20','slice','_metadataLogId','packageId','_metadataLog','Deployment\x20Result','Failure','finishRollback','\x27\x0a\x20\x20\x20\x20','./vpk.service','successfully','96813hcAvoy','organizationId','_connectionSalesforce','4749760WHPTcp','errors','createZip','packageComponentList','../classes/rollback/zip-creator.rollback','__esModule','patch','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','map','validate','create','Retrieve\x20Metadata\x20Log\x20info','_componentIds','89481IlJBIR','toString','../classes/retrievers/deployment-results/id.deployment-result.retriever','SalesforceDmlError','Save\x20log','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','execute','\x20of\x20branch\x20to\x20Organization\x20','VpkService','apply','bind','fetchAttachmentsDetailsById','_salesforceService','Veeva\x20Rollback\x20(Deployment)','writeFile','\x20</a>','Action__c','872750BZFwiP','_connectionVeeva','RollbackService','status','_logger','Veeva_Step_Name__c','_tempFolder','text/plain','Body','Org__c','retrieveBackup','Success','Logger','_veevaService','veeva-rollback','defineProperty','Job_Completed__c','name','Create\x20Vpk\x20package','Rollback\x20completed\x20','from','stepName','\x20:\x20','with\x20error','Cannot\x20find\x20Backup\x20Zip','MetadataLogDto','../dtos/metadata-log.dto','retrieveMetadataLog','(((.+)+)+)+$','Branch__c','2vtBxNO','logError','finishRollbackWithError'];a404_0xe88a=function(){return _0x41c8b0;};return a404_0xe88a();}const a404_0x2cdde6=a404_0x2b1f;(function(_0x297e63,_0xeb4be0){const _0x259871=a404_0x2b1f,_0x37b3f6=_0x297e63();while(!![]){try{const _0x2c6bde=-parseInt(_0x259871(0x19f))/0x1*(-parseInt(_0x259871(0x187))/0x2)+-parseInt(_0x259871(0x1b1))/0x3+-parseInt(_0x259871(0x1b8))/0x4*(-parseInt(_0x259871(0x169))/0x5)+-parseInt(_0x259871(0x1b2))/0x6*(-parseInt(_0x259871(0x158))/0x7)+parseInt(_0x259871(0x1bf))/0x8+-parseInt(_0x259871(0x148))/0x9+-parseInt(_0x259871(0x14b))/0xa;if(_0x2c6bde===_0xeb4be0)break;else _0x37b3f6['push'](_0x37b3f6['shift']());}catch(_0x1cf2d7){_0x37b3f6['push'](_0x37b3f6['shift']());}}}(a404_0xe88a,0x1c2d2));const a404_0x3acd73=(function(){let _0x25d825=!![];return function(_0x302de7,_0x70571e){const _0x4554a3=_0x25d825?function(){const _0x4768b9=a404_0x2b1f;if(_0x70571e){const _0x200982=_0x70571e[_0x4768b9(0x161)](_0x302de7,arguments);return _0x70571e=null,_0x200982;}}:function(){};return _0x25d825=![],_0x4554a3;};}()),a404_0x34945d=a404_0x3acd73(this,function(){const _0x2775d3=a404_0x2b1f;return a404_0x34945d[_0x2775d3(0x159)]()['search'](_0x2775d3(0x185))[_0x2775d3(0x159)]()['constructor'](a404_0x34945d)[_0x2775d3(0x1a4)](_0x2775d3(0x185));});a404_0x34945d();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3080d0){const _0x306429=a404_0x2b1f;return _0x3080d0&&_0x3080d0[_0x306429(0x150)]?_0x3080d0:{'default':_0x3080d0};};Object[a404_0x2cdde6(0x178)](exports,'__esModule',{'value':!![]}),exports[a404_0x2cdde6(0x16b)]=void 0x0;function a404_0x2b1f(_0x3e9ce2,_0x410c49){const _0x9ff1cc=a404_0xe88a();return a404_0x2b1f=function(_0x34945d,_0x3acd73){_0x34945d=_0x34945d-0x143;let _0xe88a82=_0x9ff1cc[_0x34945d];return _0xe88a82;},a404_0x2b1f(_0x3e9ce2,_0x410c49);}const veeva_service_1=require(a404_0x2cdde6(0x19d)),salesforce_service_1=require(a404_0x2cdde6(0x1ce)),package_import_service_1=require(a404_0x2cdde6(0x1a2)),id_deployment_result_retriever_1=require(a404_0x2cdde6(0x15a)),flosum_constants_1=require(a404_0x2cdde6(0x1c2)),fetch_attachments_1=require(a404_0x2cdde6(0x191)),constants_1=require(a404_0x2cdde6(0x1b9)),zip_creator_rollback_1=require(a404_0x2cdde6(0x14f)),shortid_1=__importDefault(require(a404_0x2cdde6(0x1a3))),promises_1=require(a404_0x2cdde6(0x193)),vpk_service_1=require(a404_0x2cdde6(0x146)),status_enums_1=require(a404_0x2cdde6(0x199)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a404_0x2cdde6(0x183)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x3e3fd2,connectionVeeva:_0x377add,logger:_0x550475,tempFolder:_0x2b8ba1,instanceUrl:_0x4e133e,timeZone:_0x2cf05a,metadataLogId:_0x2ef9f2,attachmentLogId:_0x5378fc,parentMetadataLogId:_0x53ae22,componentIds:_0x5bca77}){const _0x236046=a404_0x2cdde6;this[_0x236046(0x14a)]=_0x3e3fd2,this[_0x236046(0x16a)]=_0x377add,this['_logger']=_0x550475,this[_0x236046(0x16f)]=_0x2b8ba1,this[_0x236046(0x19e)]=_0x4e133e,this[_0x236046(0x1a1)]=_0x2cf05a,this[_0x236046(0x1d4)]=_0x2ef9f2,this[_0x236046(0x198)]=_0x5378fc,this[_0x236046(0x1c9)]=_0x53ae22,this[_0x236046(0x157)]=_0x5bca77,this[_0x236046(0x1ab)]=new core_1[(_0x236046(0x175))](_0x236046(0x177)),this[_0x236046(0x176)]=new veeva_service_1[(_0x236046(0x1cb))]({'connection':_0x377add,'logger':_0x550475}),this[_0x236046(0x164)]=new salesforce_service_1[(_0x236046(0x1c4))]({'connection':_0x3e3fd2}),this[_0x236046(0x19c)]=new package_import_service_1[(_0x236046(0x1c3))]({'veevaService':this[_0x236046(0x176)],'connection':_0x377add,'logger':_0x550475,'saveLog':this['saveLog'][_0x236046(0x162)](this)}),this[_0x236046(0x1be)]=new vpk_service_1[(_0x236046(0x160))]({'connection':_0x377add});}async['saveLog'](_0x207afa,_0x2e059f){const _0x184629=a404_0x2cdde6;this['_logger']['log'](_0x184629(0x15c));const _0x593ff5={'Body':Buffer[_0x184629(0x17d)](_0x207afa)['toString'](_0x184629(0x1b0)),'ContentType':_0x184629(0x170),'ParentId':this[_0x184629(0x1d4)],'Name':_0x2e059f};await this[_0x184629(0x14a)][_0x184629(0x190)](flosum_constants_1[_0x184629(0x19a)][_0x184629(0x1b7)]+_0x184629(0x1aa),_0x593ff5);}async[a404_0x2cdde6(0x184)](){const _0x49be5e=a404_0x2cdde6;this[_0x49be5e(0x16d)]['log'](_0x49be5e(0x156));const [_0xeabff0]=await this[_0x49be5e(0x164)][_0x49be5e(0x1ac)](_0x49be5e(0x18e)+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x49be5e(0x1b3)]+_0x49be5e(0x192)+constants_1[_0x49be5e(0x1b3)]+_0x49be5e(0x15d)+constants_1[_0x49be5e(0x1b3)]+_0x49be5e(0x152)+this[_0x49be5e(0x1d4)]+_0x49be5e(0x145));return new metadata_log_dto_1[(_0x49be5e(0x182))](_0xeabff0);}async['retrieveDeploymentResults'](){const _0x432e58=a404_0x2cdde6;this[_0x432e58(0x16d)][_0x432e58(0x1bb)]('Retrieve\x20Deployment\x20Results');const _0x15b741=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x432e58(0x164)],'value':this[_0x432e58(0x157)]})['retrieve']();if(!_0x15b741[_0x432e58(0x195)])throw new Error(_0x432e58(0x1a9));return _0x15b741;}async[a404_0x2cdde6(0x173)](){const _0x526858=a404_0x2cdde6;this[_0x526858(0x16d)]['log']('Retrieve\x20Backup');const _0xb6d95b=await this[_0x526858(0x164)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x526858(0x1c9)]+_0x526858(0x1af)+flosum_constants_1[_0x526858(0x19a)]['BACKUP_ZIP_NAME']+'\x27\x0a\x20\x20\x20\x20'),_0x61d444=await(0x0,fetch_attachments_1[_0x526858(0x163)])(this[_0x526858(0x14a)],[_0xb6d95b[0x0]['Id']]),_0x4838de=await(0x0,fetch_attachments_1[_0x526858(0x1cf)])(_0x61d444,this[_0x526858(0x14a)]);if(!_0x4838de[_0x526858(0x195)])throw new Error(_0x526858(0x181));return _0x4838de[0x0][_0x526858(0x196)][_0x526858(0x171)];}async[a404_0x2cdde6(0x14d)](_0x40775a){const _0x1ce586=a404_0x2cdde6;this[_0x1ce586(0x16d)][_0x1ce586(0x1bb)](_0x1ce586(0x1cd));const _0x2d9172=await this['retrieveBackup'](),_0x426ce3=await new zip_creator_rollback_1[(_0x1ce586(0x1c1))]({'rollbackName':this['_metadataLog'][_0x1ce586(0x17a)],'backup':_0x2d9172,'deploymentResults':_0x40775a})[_0x1ce586(0x155)](),_0x3c180a=this[_0x1ce586(0x16f)]+'/'+(0x0,shortid_1[_0x1ce586(0x18f)])()+_0x1ce586(0x1a7);return await(0x0,promises_1[_0x1ce586(0x166)])(_0x3c180a,_0x426ce3),_0x3c180a;}async['createVpk'](_0x5d6c8e){const _0x51a7a2=a404_0x2cdde6;this[_0x51a7a2(0x16d)][_0x51a7a2(0x1bb)](_0x51a7a2(0x17b));const _0x3e3e2d=await this['_vpkService']['generate'](_0x5d6c8e),_0x47b995=this[_0x51a7a2(0x16f)]+_0x51a7a2(0x1a0)+_0x5d6c8e[_0x51a7a2(0x1d3)](_0x5d6c8e[_0x51a7a2(0x1b4)]('/')+0x1);return await(0x0,promises_1[_0x51a7a2(0x166)])(_0x47b995,_0x3e3e2d),await this[_0x51a7a2(0x1be)][_0x51a7a2(0x154)](_0x47b995),_0x47b995;}['formFlosumDeploymentResults'](_0x961fdf){const _0x4ef155=a404_0x2cdde6;return this['_logger']['log'](_0x4ef155(0x1a5)),_0x961fdf[_0x4ef155(0x153)](_0x1e2edf=>{const _0x11360f=_0x4ef155;return this[_0x11360f(0x16d)][_0x11360f(0x1bb)](_0x1e2edf['type']+'.'+_0x1e2edf[_0x11360f(0x17a)]+_0x11360f(0x17f)+_0x1e2edf[_0x11360f(0x16c)]),{[constants_1[_0x11360f(0x1b3)]+'Type__c']:_0x11360f(0x1d7),[constants_1[_0x11360f(0x1b3)]+_0x11360f(0x1c0)]:_0x1e2edf[_0x11360f(0x16c)]===status_enums_1[_0x11360f(0x1d1)]['DEPLOYED']?_0x11360f(0x174):_0x11360f(0x143),[constants_1[_0x11360f(0x1b3)]+_0x11360f(0x194)]:_0x1e2edf[_0x11360f(0x18d)],[constants_1[_0x11360f(0x1b3)]+'Component_Name__c']:_0x1e2edf[_0x11360f(0x17a)],[constants_1[_0x11360f(0x1b3)]+'Component_Type__c']:_0x1e2edf['type'],[constants_1[_0x11360f(0x1b3)]+_0x11360f(0x16e)]:_0x1e2edf[_0x11360f(0x17e)],[constants_1[_0x11360f(0x1b3)]+_0x11360f(0x172)]:this[_0x11360f(0x1d6)][_0x11360f(0x149)],[constants_1[_0x11360f(0x1b3)]+'Metadata_Log__c']:this[_0x11360f(0x1d4)]};});}async['saveDeploymentResults'](_0x11c6b9){const _0x9bb23=a404_0x2cdde6;this[_0x9bb23(0x16d)][_0x9bb23(0x1bb)](_0x9bb23(0x18a));const _0x3d3c57=await this[_0x9bb23(0x164)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+_0x9bb23(0x1ba),_0x11c6b9),_0x500198=_0x3d3c57['filter'](_0xb35bf8=>!_0xb35bf8['success'])['map'](_0x222c7a=>_0x222c7a[_0x9bb23(0x14c)])[_0x9bb23(0x1bd)]();if(_0x500198[_0x9bb23(0x195)])throw new salesforce_dml_error_1[(_0x9bb23(0x15b))](_0x500198);}async[a404_0x2cdde6(0x189)](_0x240e69){const _0x5d01f1=a404_0x2cdde6;if(!this['_metadataLog']){this[_0x5d01f1(0x1ab)][_0x5d01f1(0x1b5)](_0x240e69);return;}this[_0x5d01f1(0x16d)][_0x5d01f1(0x188)](_0x240e69),await this['_logger'][_0x5d01f1(0x1a6)](),await this['finishRollback'](![],!![],'');}async[a404_0x2cdde6(0x144)](_0xa0146,_0x2d683a,_0xe2b8c4){const _0x19fccc=a404_0x2cdde6,{id:_0x5d4a02,organizationId:_0x28ce44,branchId:_0x3517f0,organizationName:_0x4e3701}=this[_0x19fccc(0x1d6)],_0x547302=_0x19fccc(0x1ad)+this[_0x19fccc(0x19e)]+'/'+_0x5d4a02+_0x19fccc(0x1d2)+_0x19fccc(0x165)+_0x19fccc(0x167),_0x35f15e=_0x19fccc(0x1ad)+this[_0x19fccc(0x19e)]+'/'+_0x28ce44+'\x20>'+_0x4e3701+_0x19fccc(0x1b6),_0x4c5354=_0x547302+_0x19fccc(0x15f)+_0x35f15e+'\x20has\x20been\x20created.',_0x2c41aa={[constants_1[_0x19fccc(0x1b3)]+_0x19fccc(0x168)]:_0x4c5354,[constants_1['FLOSUM_NAMESPACE']+_0x19fccc(0x1cc)]:new Date(),[constants_1[_0x19fccc(0x1b3)]+_0x19fccc(0x186)]:_0x3517f0,[constants_1['FLOSUM_NAMESPACE']+'Activity_Item__c']:_0x19fccc(0x1d0),[constants_1[_0x19fccc(0x1b3)]+'Activity_Type__c']:_0x19fccc(0x18c),[constants_1['FLOSUM_NAMESPACE']+_0x19fccc(0x1c6)]:_0x28ce44},_0x59c076={[constants_1['FLOSUM_NAMESPACE']+_0x19fccc(0x1bc)]:!_0xa0146,[constants_1['FLOSUM_NAMESPACE']+_0x19fccc(0x1ae)]:_0xa0146,[constants_1[_0x19fccc(0x1b3)]+_0x19fccc(0x1c0)]:_0x2d683a?status_enums_1['MetadataLogStatus'][_0x19fccc(0x18b)]:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x19fccc(0x1b3)]+_0x19fccc(0x179)]:!![],[constants_1[_0x19fccc(0x1b3)]+_0x19fccc(0x1c5)]:_0xe2b8c4};await this['_connectionSalesforce'][_0x19fccc(0x151)](flosum_constants_1['FlosumConstants'][_0x19fccc(0x1b7)]+'/'+constants_1[_0x19fccc(0x1b3)]+_0x19fccc(0x1c8)+this[_0x19fccc(0x1d4)],_0x59c076),await this['_connectionSalesforce'][_0x19fccc(0x190)](flosum_constants_1['FlosumConstants'][_0x19fccc(0x1b7)]+'/'+constants_1[_0x19fccc(0x1b3)]+_0x19fccc(0x1ca),_0x2c41aa),this[_0x19fccc(0x16d)]['log'](_0x19fccc(0x17c)+(_0xa0146?_0x19fccc(0x147):_0x19fccc(0x180))+'.'),await this[_0x19fccc(0x16d)][_0x19fccc(0x1a6)]();}async[a404_0x2cdde6(0x15e)](){const _0x449516=a404_0x2cdde6;try{this[_0x449516(0x1d6)]=await this[_0x449516(0x184)]();const _0x54b308=await this[_0x449516(0x19b)]();await this[_0x449516(0x16d)][_0x449516(0x1a6)]();const _0x23fdac=await this[_0x449516(0x14d)](_0x54b308),_0x5517be=await this[_0x449516(0x1c7)](_0x23fdac);await this[_0x449516(0x16d)][_0x449516(0x1a6)]();const _0x123b5f=await this[_0x449516(0x19c)][_0x449516(0x197)](_0x5517be);await this['_logger'][_0x449516(0x1a6)]();const _0x17eded=this['formFlosumDeploymentResults'](_0x123b5f[_0x449516(0x14e)]);await this['saveDeploymentResults'](_0x17eded),await this[_0x449516(0x144)](_0x123b5f['isDeployed'],![],_0x123b5f[_0x449516(0x1d5)]);}catch(_0x551cfb){await this[_0x449516(0x189)](_0x551cfb)[_0x449516(0x1a8)](_0x4fde64=>this[_0x449516(0x1ab)][_0x449516(0x1b5)](_0x4fde64));}}}exports[a404_0x2cdde6(0x16b)]=RollbackService;