const a337_0x4f0277=a337_0x5900;(function(_0x48348b,_0x7b1c81){const _0x5aeef3=a337_0x5900,_0x4283ff=_0x48348b();while(!![]){try{const _0x26880e=-parseInt(_0x5aeef3(0x141))/0x1+-parseInt(_0x5aeef3(0x17b))/0x2+-parseInt(_0x5aeef3(0x142))/0x3+parseInt(_0x5aeef3(0x122))/0x4*(parseInt(_0x5aeef3(0x119))/0x5)+parseInt(_0x5aeef3(0x11f))/0x6+-parseInt(_0x5aeef3(0x158))/0x7+parseInt(_0x5aeef3(0x167))/0x8*(parseInt(_0x5aeef3(0x136))/0x9);if(_0x26880e===_0x7b1c81)break;else _0x4283ff['push'](_0x4283ff['shift']());}catch(_0x5dedef){_0x4283ff['push'](_0x4283ff['shift']());}}}(a337_0x23d7,0x638a1));const a337_0x3d6863=(function(){let _0x40bf07=!![];return function(_0xb1558a,_0x286c3){const _0x3e7441=_0x40bf07?function(){if(_0x286c3){const _0x2f2cd8=_0x286c3['apply'](_0xb1558a,arguments);return _0x286c3=null,_0x2f2cd8;}}:function(){};return _0x40bf07=![],_0x3e7441;};}()),a337_0x84c217=a337_0x3d6863(this,function(){const _0x1c9e40=a337_0x5900;return a337_0x84c217[_0x1c9e40(0xfc)]()[_0x1c9e40(0x13a)](_0x1c9e40(0x147))[_0x1c9e40(0xfc)]()[_0x1c9e40(0x132)](a337_0x84c217)[_0x1c9e40(0x13a)](_0x1c9e40(0x147));});function a337_0x23d7(){const _0x3e6e7a=['_componentIds','Deployment','success','insertMultipleRecords','Type__c','createVpk','4298035kwjdgb','patch','deploymentAction','/Attachment','log','Component_Name__c','status','stepName','BACKUP_ZIP_NAME','Is_Error__c','retrieveRecords','Branch__c','../classes/retrievers/deployment-results/id.deployment-result.retriever','generate','Deployment\x20Result','27200DIeNQB','error','MetadataLogDto','TargetId__c','../../../core','retrieveBackup','Metadata_Log__c','_systemLogger','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','retrieveDeploymentResults','Log__c','__esModule','<a\x20href=','post','_metadataLogId','map','RollbackService','</a>','_instanceUrl','catch','379924wunqKn','finishRollback','_metadataLog','Form\x20Deployment\x20Results','Status__c','./salesforce.service','_connectionVeeva','\x20:\x20','ENDPOINT_UPSERT_RECORD','FLOSUM_NAMESPACE','veeva-rollback','PackageImportService','saveLog','writeFile','Action__c','_salesforceService','Retrieve\x20Backup','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','../../shared/utils/fetch-attachments','../constants/flosum.constants','Date__c','\x20>\x20','../classes/errors/salesforce-dml-error','toString','with\x20error','finishRollbackWithError','./vpk.service','\x20of\x20branch\x20to\x20Organization\x20','Cannot\x20find\x20Deployment\x20Results','retrieveAttachments','DEPLOYED','fetchAttachmentsDetailsById','Logger','formFlosumDeploymentResults','length','retrieveMetadataLog','isDeployed','../dtos/metadata-log.dto','_connectionSalesforce','type','text/plain','Success','\x27\x20AND\x20Name\x20=\x20\x27','_vpkService','shortid','Result__c','successfully','\x20has\x20been\x20created.','saveDeploymentResults','updateLog','EXCEPTION','Deployment_Result__c','5xGGOUC','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','Activity_Item__c','values','import','VeevaService','2533500bAQlyx','base64','.zip','584088pckGPB','Job_Completed__c','_timeZone','validate','VpkService','filter','Cannot\x20find\x20Backup\x20Zip','_tempFolder','./veeva.service','name','bind','Failure','slice','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../classes/rollback/zip-creator.rollback','logError','constructor','Create\x20Vpk\x20package','ZipCreatorRollback','FlosumConstants','4527eEuWKK','IdDeploymentResultRetriever','_logger','/vpk__','search','errors','packageId','organizationId','from','Save\x20Deployment\x20Results','createZip','424832pZjQER','1925880Brmwgd','_veevaService','MetadataLogStatus','create','../../../constants','(((.+)+)+)+$','Activity_Type__c','Create\x20zip\x20from\x20backup','retrieve','SalesforceDmlError','SalesforceService','packageComponentList','../enums/status.enums','Org__c','Veeva\x20Rollback\x20(Deployment)','_packageImportService'];a337_0x23d7=function(){return _0x3e6e7a;};return a337_0x23d7();}a337_0x84c217();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3b3ed3){const _0x3b4f78=a337_0x5900;return _0x3b3ed3&&_0x3b3ed3[_0x3b4f78(0x172)]?_0x3b3ed3:{'default':_0x3b3ed3};};function a337_0x5900(_0x4a97ef,_0x4c7af1){const _0x5d702b=a337_0x23d7();return a337_0x5900=function(_0x84c217,_0x3d6863){_0x84c217=_0x84c217-0xe6;let _0x23d7e3=_0x5d702b[_0x84c217];return _0x23d7e3;},a337_0x5900(_0x4a97ef,_0x4c7af1);}Object['defineProperty'](exports,a337_0x4f0277(0x172),{'value':!![]}),exports[a337_0x4f0277(0x177)]=void 0x0;const veeva_service_1=require(a337_0x4f0277(0x12a)),salesforce_service_1=require(a337_0x4f0277(0xe9)),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require(a337_0x4f0277(0x164)),flosum_constants_1=require(a337_0x4f0277(0xf8)),fetch_attachments_1=require(a337_0x4f0277(0xf7)),constants_1=require(a337_0x4f0277(0x146)),zip_creator_rollback_1=require(a337_0x4f0277(0x130)),shortid_1=__importDefault(require(a337_0x4f0277(0x111))),promises_1=require('fs/promises'),vpk_service_1=require(a337_0x4f0277(0xff)),status_enums_1=require(a337_0x4f0277(0x14e)),salesforce_dml_error_1=require(a337_0x4f0277(0xfb)),metadata_log_dto_1=require(a337_0x4f0277(0x10a)),core_1=require(a337_0x4f0277(0x16b));class RollbackService{constructor({connectionSalesforce:_0x3b19a1,connectionVeeva:_0x2df473,logger:_0x2e1bdf,tempFolder:_0x3edfc6,instanceUrl:_0x307bcc,timeZone:_0x4ecf27,metadataLogId:_0x4381a1,attachmentLogId:_0x329e0f,parentMetadataLogId:_0x52f9ff,componentIds:_0x3d3ee9}){const _0x39eae5=a337_0x4f0277;this['_connectionSalesforce']=_0x3b19a1,this[_0x39eae5(0xea)]=_0x2df473,this[_0x39eae5(0x138)]=_0x2e1bdf,this[_0x39eae5(0x129)]=_0x3edfc6,this['_instanceUrl']=_0x307bcc,this[_0x39eae5(0x124)]=_0x4ecf27,this[_0x39eae5(0x175)]=_0x4381a1,this['_attachmentLogId']=_0x329e0f,this['_parentMetadataLogId']=_0x52f9ff,this[_0x39eae5(0x152)]=_0x3d3ee9,this[_0x39eae5(0x16e)]=new core_1[(_0x39eae5(0x105))](_0x39eae5(0xee)),this['_veevaService']=new veeva_service_1[(_0x39eae5(0x11e))]({'connection':_0x2df473,'logger':_0x2e1bdf}),this[_0x39eae5(0xf3)]=new salesforce_service_1[(_0x39eae5(0x14c))]({'connection':_0x3b19a1}),this[_0x39eae5(0x151)]=new package_import_service_1[(_0x39eae5(0xef))]({'veevaService':this[_0x39eae5(0x143)],'connection':_0x2df473,'logger':_0x2e1bdf,'saveLog':this[_0x39eae5(0xf0)][_0x39eae5(0x12c)](this)}),this[_0x39eae5(0x110)]=new vpk_service_1[(_0x39eae5(0x126))]({'connection':_0x2df473});}async[a337_0x4f0277(0xf0)](_0x4ad6ae,_0x59df4e){const _0x130d88=a337_0x4f0277;this[_0x130d88(0x138)]['log']('Save\x20log');const _0xb15418={'Body':Buffer[_0x130d88(0x13e)](_0x4ad6ae)[_0x130d88(0xfc)](_0x130d88(0x120)),'ContentType':_0x130d88(0x10d),'ParentId':this['_metadataLogId'],'Name':_0x59df4e};await this[_0x130d88(0x10b)][_0x130d88(0x174)](flosum_constants_1[_0x130d88(0x135)][_0x130d88(0xec)]+_0x130d88(0x15b),_0xb15418);}async['retrieveMetadataLog'](){const _0x388863=a337_0x4f0277;this[_0x388863(0x138)][_0x388863(0x15c)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x4d48e1]=await this['_salesforceService'][_0x388863(0x162)](_0x388863(0x16f)+constants_1[_0x388863(0xed)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x388863(0x12f)+constants_1[_0x388863(0xed)]+_0x388863(0xf6)+constants_1[_0x388863(0xed)]+_0x388863(0xf5)+this[_0x388863(0x175)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x388863(0x169))](_0x4d48e1);}async['retrieveDeploymentResults'](){const _0x448a40=a337_0x4f0277;this[_0x448a40(0x138)][_0x448a40(0x15c)]('Retrieve\x20Deployment\x20Results');const _0x133416=await new id_deployment_result_retriever_1[(_0x448a40(0x137))]({'salesforceService':this['_salesforceService'],'value':this[_0x448a40(0x152)]})[_0x448a40(0x14a)]();if(!_0x133416[_0x448a40(0x107)])throw new Error(_0x448a40(0x101));return _0x133416;}async[a337_0x4f0277(0x16c)](){const _0x108119=a337_0x4f0277;this['_logger'][_0x108119(0x15c)](_0x108119(0xf4));const _0x1d3648=await this['_salesforceService'][_0x108119(0x162)](_0x108119(0x11a)+this['_parentMetadataLogId']+_0x108119(0x10f)+flosum_constants_1['FlosumConstants'][_0x108119(0x160)]+'\x27\x0a\x20\x20\x20\x20'),_0x5d98be=await(0x0,fetch_attachments_1[_0x108119(0x104)])(this[_0x108119(0x10b)],[_0x1d3648[0x0]['Id']]),_0x3a625d=await(0x0,fetch_attachments_1[_0x108119(0x102)])(_0x5d98be,this[_0x108119(0x10b)]);if(!_0x3a625d[_0x108119(0x107)])throw new Error(_0x108119(0x128));return _0x3a625d[0x0][_0x108119(0x11c)]['Body'];}async[a337_0x4f0277(0x140)](_0x170024){const _0x40f8c6=a337_0x4f0277;this['_logger']['log'](_0x40f8c6(0x149));const _0x5d92ba=await this['retrieveBackup'](),_0x3e4e71=await new zip_creator_rollback_1[(_0x40f8c6(0x134))]({'rollbackName':this[_0x40f8c6(0xe6)]['name'],'backup':_0x5d92ba,'deploymentResults':_0x170024})[_0x40f8c6(0x145)](),_0xbf738a=this[_0x40f8c6(0x129)]+'/'+(0x0,shortid_1['default'])()+_0x40f8c6(0x121);return await(0x0,promises_1[_0x40f8c6(0xf1)])(_0xbf738a,_0x3e4e71),_0xbf738a;}async[a337_0x4f0277(0x157)](_0x6fbd16){const _0xce6d4c=a337_0x4f0277;this[_0xce6d4c(0x138)]['log'](_0xce6d4c(0x133));const _0x5f3e57=await this[_0xce6d4c(0x110)][_0xce6d4c(0x165)](_0x6fbd16),_0x4beec2=this[_0xce6d4c(0x129)]+_0xce6d4c(0x139)+_0x6fbd16[_0xce6d4c(0x12e)](_0x6fbd16['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0xce6d4c(0xf1)])(_0x4beec2,_0x5f3e57),await this[_0xce6d4c(0x110)][_0xce6d4c(0x125)](_0x4beec2),_0x4beec2;}[a337_0x4f0277(0x106)](_0x4ec861){const _0x293173=a337_0x4f0277;return this[_0x293173(0x138)][_0x293173(0x15c)](_0x293173(0xe7)),_0x4ec861[_0x293173(0x176)](_0x146349=>{const _0x20fe9c=_0x293173;return this['_logger'][_0x20fe9c(0x15c)](_0x146349[_0x20fe9c(0x10c)]+'.'+_0x146349[_0x20fe9c(0x12b)]+_0x20fe9c(0xeb)+_0x146349['status']),{[constants_1[_0x20fe9c(0xed)]+_0x20fe9c(0x156)]:_0x20fe9c(0x166),[constants_1['FLOSUM_NAMESPACE']+_0x20fe9c(0xe8)]:_0x146349[_0x20fe9c(0x15e)]===status_enums_1['PackageComponentStatus'][_0x20fe9c(0x103)]?_0x20fe9c(0x10e):_0x20fe9c(0x12d),[constants_1['FLOSUM_NAMESPACE']+_0x20fe9c(0x112)]:_0x146349[_0x20fe9c(0x15a)],[constants_1[_0x20fe9c(0xed)]+_0x20fe9c(0x15d)]:_0x146349['name'],[constants_1[_0x20fe9c(0xed)]+'Component_Type__c']:_0x146349['type'],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Step_Name__c']:_0x146349[_0x20fe9c(0x15f)],[constants_1[_0x20fe9c(0xed)]+_0x20fe9c(0x14f)]:this[_0x20fe9c(0xe6)][_0x20fe9c(0x13d)],[constants_1[_0x20fe9c(0xed)]+_0x20fe9c(0x16d)]:this[_0x20fe9c(0x175)]};});}async[a337_0x4f0277(0x115)](_0x338d64){const _0x13ecc6=a337_0x4f0277;this[_0x13ecc6(0x138)]['log'](_0x13ecc6(0x13f));const _0x25bba4=await this[_0x13ecc6(0xf3)][_0x13ecc6(0x155)](constants_1[_0x13ecc6(0xed)]+_0x13ecc6(0x118),_0x338d64),_0x58e97c=_0x25bba4[_0x13ecc6(0x127)](_0x2b2a37=>!_0x2b2a37[_0x13ecc6(0x154)])[_0x13ecc6(0x176)](_0xb2b68b=>_0xb2b68b[_0x13ecc6(0x13b)])['flat']();if(_0x58e97c[_0x13ecc6(0x107)])throw new salesforce_dml_error_1[(_0x13ecc6(0x14b))](_0x58e97c);}async['finishRollbackWithError'](_0x4c7dab){const _0x3b24e5=a337_0x4f0277;if(!this[_0x3b24e5(0xe6)]){this[_0x3b24e5(0x16e)]['error'](_0x4c7dab);return;}this[_0x3b24e5(0x138)][_0x3b24e5(0x131)](_0x4c7dab),await this[_0x3b24e5(0x138)][_0x3b24e5(0x116)](),await this['finishRollback'](![],!![],'');}async[a337_0x4f0277(0x17c)](_0x19e3a5,_0x459509,_0x10514b){const _0x1201aa=a337_0x4f0277,{id:_0x2999b8,organizationId:_0xb970ee,branchId:_0x17b156,organizationName:_0x487efc}=this[_0x1201aa(0xe6)],_0x1e106f=_0x1201aa(0x173)+this[_0x1201aa(0x179)]+'/'+_0x2999b8+_0x1201aa(0xfa)+_0x1201aa(0x150)+'\x20</a>',_0x27b404=_0x1201aa(0x173)+this[_0x1201aa(0x179)]+'/'+_0xb970ee+'\x20>'+_0x487efc+_0x1201aa(0x178),_0x346e29=_0x1e106f+_0x1201aa(0x100)+_0x27b404+_0x1201aa(0x114),_0x106ad3={[constants_1[_0x1201aa(0xed)]+_0x1201aa(0xf2)]:_0x346e29,[constants_1['FLOSUM_NAMESPACE']+_0x1201aa(0xf9)]:new Date(),[constants_1[_0x1201aa(0xed)]+_0x1201aa(0x163)]:_0x17b156,[constants_1[_0x1201aa(0xed)]+_0x1201aa(0x11b)]:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x1201aa(0x148)]:_0x1201aa(0x153),[constants_1[_0x1201aa(0xed)]+_0x1201aa(0x16a)]:_0xb970ee},_0x26a151={[constants_1[_0x1201aa(0xed)]+_0x1201aa(0x161)]:!_0x19e3a5,[constants_1[_0x1201aa(0xed)]+'Succeed__c']:_0x19e3a5,[constants_1[_0x1201aa(0xed)]+_0x1201aa(0xe8)]:_0x459509?status_enums_1['MetadataLogStatus'][_0x1201aa(0x117)]:status_enums_1[_0x1201aa(0x144)]['COMPLETED'],[constants_1[_0x1201aa(0xed)]+_0x1201aa(0x123)]:!![],[constants_1[_0x1201aa(0xed)]+'Async_Request_Id__c']:_0x10514b};await this[_0x1201aa(0x10b)][_0x1201aa(0x159)](flosum_constants_1[_0x1201aa(0x135)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x1201aa(0xed)]+'Metadata_Log__c/'+this[_0x1201aa(0x175)],_0x26a151),await this[_0x1201aa(0x10b)][_0x1201aa(0x174)](flosum_constants_1[_0x1201aa(0x135)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x1201aa(0xed)]+_0x1201aa(0x171),_0x106ad3),this[_0x1201aa(0x138)]['log']('Rollback\x20completed\x20'+(_0x19e3a5?_0x1201aa(0x113):_0x1201aa(0xfd))+'.'),await this[_0x1201aa(0x138)][_0x1201aa(0x116)]();}async['execute'](){const _0x35ad9c=a337_0x4f0277;try{this[_0x35ad9c(0xe6)]=await this[_0x35ad9c(0x108)]();const _0x1ce490=await this[_0x35ad9c(0x170)]();await this[_0x35ad9c(0x138)][_0x35ad9c(0x116)]();const _0x1fafaa=await this[_0x35ad9c(0x140)](_0x1ce490),_0x50e49f=await this[_0x35ad9c(0x157)](_0x1fafaa);await this[_0x35ad9c(0x138)][_0x35ad9c(0x116)]();const _0x1f2fdc=await this[_0x35ad9c(0x151)][_0x35ad9c(0x11d)](_0x50e49f);await this['_logger'][_0x35ad9c(0x116)]();const _0x33283e=this[_0x35ad9c(0x106)](_0x1f2fdc[_0x35ad9c(0x14d)]);await this[_0x35ad9c(0x115)](_0x33283e),await this[_0x35ad9c(0x17c)](_0x1f2fdc[_0x35ad9c(0x109)],![],_0x1f2fdc[_0x35ad9c(0x13c)]);}catch(_0x2bc960){await this[_0x35ad9c(0xfe)](_0x2bc960)[_0x35ad9c(0x17a)](_0x15c140=>this[_0x35ad9c(0x16e)][_0x35ad9c(0x168)](_0x15c140));}}}exports[a337_0x4f0277(0x177)]=RollbackService;