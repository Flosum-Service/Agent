const a337_0x399835=a337_0x11f6;(function(_0x4aeefc,_0x2b887b){const _0x4ca588=a337_0x11f6,_0xde511a=_0x4aeefc();while(!![]){try{const _0x132045=parseInt(_0x4ca588(0x14b))/0x1*(parseInt(_0x4ca588(0xf3))/0x2)+-parseInt(_0x4ca588(0x111))/0x3*(parseInt(_0x4ca588(0x123))/0x4)+parseInt(_0x4ca588(0xd3))/0x5*(-parseInt(_0x4ca588(0x146))/0x6)+-parseInt(_0x4ca588(0xd7))/0x7+parseInt(_0x4ca588(0xf8))/0x8+-parseInt(_0x4ca588(0xc5))/0x9*(parseInt(_0x4ca588(0x13a))/0xa)+parseInt(_0x4ca588(0x104))/0xb;if(_0x132045===_0x2b887b)break;else _0xde511a['push'](_0xde511a['shift']());}catch(_0x35ef41){_0xde511a['push'](_0xde511a['shift']());}}}(a337_0x331d,0xc72a6));const a337_0x4ada67=(function(){let _0x5730fe=!![];return function(_0x26183d,_0x2a22ed){const _0x51022d=_0x5730fe?function(){const _0x3ef0a6=a337_0x11f6;if(_0x2a22ed){const _0x46f156=_0x2a22ed[_0x3ef0a6(0xcc)](_0x26183d,arguments);return _0x2a22ed=null,_0x46f156;}}:function(){};return _0x5730fe=![],_0x51022d;};}()),a337_0x1377ee=a337_0x4ada67(this,function(){const _0x5024ef=a337_0x11f6;return a337_0x1377ee['toString']()['search'](_0x5024ef(0xd4))[_0x5024ef(0xc8)]()[_0x5024ef(0xff)](a337_0x1377ee)[_0x5024ef(0xec)](_0x5024ef(0xd4));});a337_0x1377ee();function a337_0x331d(){const _0x4f0b94=['updateLog','Logger','../classes/rollback/zip-creator.rollback','type','ENDPOINT_UPSERT_RECORD','_logger','Veeva_Step_Name__c','Activity_Type__c','SalesforceService','_packageImportService','Retrieve\x20Deployment\x20Results','slice','execute','search','saveLog','PackageImportService','_systemLogger','packageComponentList','Retrieve\x20Metadata\x20Log\x20info','create','36996MPbLxP','_connectionSalesforce','retrieveBackup','saveDeploymentResults','./vpk.service','8646288LNggvf','createVpk','shortid','../classes/errors/salesforce-dml-error','./salesforce.service','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Activity_Item__c','constructor','retrieve','_componentIds','validate','_tempFolder','16407809lTkCTh','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','__importDefault','fetchAttachmentsDetailsById','Date__c','\x20</a>','log','post','_vpkService','../../../core','<a\x20href=','ZipCreatorRollback','createZip','174324bOnmra','Async_Request_Id__c','./veeva.service','Deployment','/Attachment','successfully','import','formFlosumDeploymentResults','isDeployed','Log__c','../dtos/metadata-log.dto','map','Component_Name__c','organizationId','../../../constants','packageId','filter','Component_Type__c','44aIZiRG','Success','Metadata_Log__c','name','Job_Completed__c','_metadataLogId','FLOSUM_NAMESPACE','PackageComponentStatus','\x27\x0a\x20\x20\x20\x20','__esModule','finishRollback','FlosumConstants','retrieveMetadataLog','base64','Is_Error__c','\x20has\x20been\x20created.','Deployment\x20Result','Deployment_Result__c','IdDeploymentResultRetriever','retrieveRecords','_timeZone','Metadata_Log__c/','flat','1078930jJyPfC','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','\x20of\x20branch\x20to\x20Organization\x20','retrieveDeploymentResults','from','Body','_metadataLog','Org__c','_instanceUrl','_attachmentLogId','_connectionVeeva','_salesforceService','6ePJrsz','errors','VpkService','BACKUP_ZIP_NAME','error','28DiDbkQ','with\x20error','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Save\x20Deployment\x20Results','catch','Cannot\x20find\x20Deployment\x20Results','_veevaService','success','Form\x20Deployment\x20Results','writeFile','9ixupAj','Cannot\x20find\x20Backup\x20Zip','bind','toString','values','Type__c','Rollback\x20completed\x20','apply','Branch__c','text/plain','_parentMetadataLogId','\x20:\x20','../constants/flosum.constants','MetadataLogStatus','7035130HvhQZr','(((.+)+)+)+$','/vpk__','TargetId__c','843220GBxVHB','Create\x20Vpk\x20package','RollbackService','status','Failure','SalesforceDmlError','../classes/retrievers/deployment-results/id.deployment-result.retriever','VeevaService'];a337_0x331d=function(){return _0x4f0b94;};return a337_0x331d();}'use strict';var __importDefault=this&&this[a337_0x399835(0x106)]||function(_0x17db90){const _0x439930=a337_0x399835;return _0x17db90&&_0x17db90[_0x439930(0x12c)]?_0x17db90:{'default':_0x17db90};};Object['defineProperty'](exports,a337_0x399835(0x12c),{'value':!![]}),exports[a337_0x399835(0xd9)]=void 0x0;function a337_0x11f6(_0x25751c,_0x3b3bbe){const _0x40110c=a337_0x331d();return a337_0x11f6=function(_0x1377ee,_0x4ada67){_0x1377ee=_0x1377ee-0xbd;let _0x331d27=_0x40110c[_0x1377ee];return _0x331d27;},a337_0x11f6(_0x25751c,_0x3b3bbe);}const veeva_service_1=require(a337_0x399835(0x113)),salesforce_service_1=require(a337_0x399835(0xfc)),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require(a337_0x399835(0xdd)),flosum_constants_1=require(a337_0x399835(0xd1)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a337_0x399835(0x11f)),zip_creator_rollback_1=require(a337_0x399835(0xe1)),shortid_1=__importDefault(require(a337_0x399835(0xfa))),promises_1=require('fs/promises'),vpk_service_1=require(a337_0x399835(0xf7)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a337_0x399835(0xfb)),metadata_log_dto_1=require(a337_0x399835(0x11b)),core_1=require(a337_0x399835(0x10d));class RollbackService{constructor({connectionSalesforce:_0x29dc41,connectionVeeva:_0x532485,logger:_0x2cf8df,tempFolder:_0x2cd4df,instanceUrl:_0x4083ec,timeZone:_0x3eaec8,metadataLogId:_0x5b580f,attachmentLogId:_0x1900c0,parentMetadataLogId:_0x24c922,componentIds:_0x21517f}){const _0x5e5195=a337_0x399835;this[_0x5e5195(0xf4)]=_0x29dc41,this[_0x5e5195(0x144)]=_0x532485,this[_0x5e5195(0xe4)]=_0x2cf8df,this[_0x5e5195(0x103)]=_0x2cd4df,this[_0x5e5195(0x142)]=_0x4083ec,this[_0x5e5195(0x137)]=_0x3eaec8,this[_0x5e5195(0x128)]=_0x5b580f,this[_0x5e5195(0x143)]=_0x1900c0,this['_parentMetadataLogId']=_0x24c922,this[_0x5e5195(0x101)]=_0x21517f,this[_0x5e5195(0xef)]=new core_1[(_0x5e5195(0xe0))]('veeva-rollback'),this[_0x5e5195(0xc1)]=new veeva_service_1[(_0x5e5195(0xde))]({'connection':_0x532485,'logger':_0x2cf8df}),this[_0x5e5195(0x145)]=new salesforce_service_1[(_0x5e5195(0xe7))]({'connection':_0x29dc41}),this['_packageImportService']=new package_import_service_1[(_0x5e5195(0xee))]({'veevaService':this[_0x5e5195(0xc1)],'connection':_0x532485,'logger':_0x2cf8df,'saveLog':this[_0x5e5195(0xed)][_0x5e5195(0xc7)](this)}),this[_0x5e5195(0x10c)]=new vpk_service_1[(_0x5e5195(0x148))]({'connection':_0x532485});}async[a337_0x399835(0xed)](_0x5d6d76,_0x1280a9){const _0x5e9944=a337_0x399835;this[_0x5e9944(0xe4)]['log']('Save\x20log');const _0x2376cb={'Body':Buffer[_0x5e9944(0x13e)](_0x5d6d76)[_0x5e9944(0xc8)](_0x5e9944(0x130)),'ContentType':_0x5e9944(0xce),'ParentId':this[_0x5e9944(0x128)],'Name':_0x1280a9};await this['_connectionSalesforce'][_0x5e9944(0x10b)](flosum_constants_1[_0x5e9944(0x12e)][_0x5e9944(0xe3)]+_0x5e9944(0x115),_0x2376cb);}async[a337_0x399835(0x12f)](){const _0x29845c=a337_0x399835;this[_0x29845c(0xe4)][_0x29845c(0x10a)](_0x29845c(0xf1));const [_0xf191b9]=await this['_salesforceService']['retrieveRecords'](_0x29845c(0xbd)+constants_1[_0x29845c(0x129)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x29845c(0x129)]+_0x29845c(0xfd)+constants_1[_0x29845c(0x129)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x29845c(0x129)]+_0x29845c(0x105)+this[_0x29845c(0x128)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1['MetadataLogDto'](_0xf191b9);}async[a337_0x399835(0x13d)](){const _0x24f42d=a337_0x399835;this[_0x24f42d(0xe4)]['log'](_0x24f42d(0xe9));const _0x56c033=await new id_deployment_result_retriever_1[(_0x24f42d(0x135))]({'salesforceService':this[_0x24f42d(0x145)],'value':this[_0x24f42d(0x101)]})[_0x24f42d(0x100)]();if(!_0x56c033['length'])throw new Error(_0x24f42d(0xc0));return _0x56c033;}async['retrieveBackup'](){const _0x3903d9=a337_0x399835;this[_0x3903d9(0xe4)]['log']('Retrieve\x20Backup');const _0x39d989=await this['_salesforceService'][_0x3903d9(0x136)](_0x3903d9(0x13b)+this[_0x3903d9(0xcf)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0x3903d9(0x12e)][_0x3903d9(0x149)]+_0x3903d9(0x12b)),_0xabf5ed=await(0x0,fetch_attachments_1[_0x3903d9(0x107)])(this['_connectionSalesforce'],[_0x39d989[0x0]['Id']]),_0x1434e7=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0xabf5ed,this[_0x3903d9(0xf4)]);if(!_0x1434e7['length'])throw new Error(_0x3903d9(0xc6));return _0x1434e7[0x0][_0x3903d9(0xc9)][_0x3903d9(0x13f)];}async['createZip'](_0x3d8066){const _0x4a9122=a337_0x399835;this[_0x4a9122(0xe4)][_0x4a9122(0x10a)]('Create\x20zip\x20from\x20backup');const _0x3b7f40=await this[_0x4a9122(0xf5)](),_0x2e6675=await new zip_creator_rollback_1[(_0x4a9122(0x10f))]({'rollbackName':this['_metadataLog'][_0x4a9122(0x126)],'backup':_0x3b7f40,'deploymentResults':_0x3d8066})[_0x4a9122(0xf2)](),_0x354241=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+'.zip';return await(0x0,promises_1['writeFile'])(_0x354241,_0x2e6675),_0x354241;}async['createVpk'](_0x7269f3){const _0x5b12a4=a337_0x399835;this[_0x5b12a4(0xe4)][_0x5b12a4(0x10a)](_0x5b12a4(0xd8));const _0x10e76e=await this[_0x5b12a4(0x10c)]['generate'](_0x7269f3),_0x4e9111=this[_0x5b12a4(0x103)]+_0x5b12a4(0xd5)+_0x7269f3[_0x5b12a4(0xea)](_0x7269f3['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x5b12a4(0xc4)])(_0x4e9111,_0x10e76e),await this[_0x5b12a4(0x10c)][_0x5b12a4(0x102)](_0x4e9111),_0x4e9111;}[a337_0x399835(0x118)](_0x39b942){const _0xcbe456=a337_0x399835;return this['_logger'][_0xcbe456(0x10a)](_0xcbe456(0xc3)),_0x39b942[_0xcbe456(0x11c)](_0x18dbc7=>{const _0x6b9ec3=_0xcbe456;return this['_logger'][_0x6b9ec3(0x10a)](_0x18dbc7[_0x6b9ec3(0xe2)]+'.'+_0x18dbc7['name']+_0x6b9ec3(0xd0)+_0x18dbc7[_0x6b9ec3(0xda)]),{[constants_1[_0x6b9ec3(0x129)]+_0x6b9ec3(0xca)]:_0x6b9ec3(0x133),[constants_1[_0x6b9ec3(0x129)]+'Status__c']:_0x18dbc7[_0x6b9ec3(0xda)]===status_enums_1[_0x6b9ec3(0x12a)]['DEPLOYED']?_0x6b9ec3(0x124):_0x6b9ec3(0xdb),[constants_1[_0x6b9ec3(0x129)]+'Result__c']:_0x18dbc7['deploymentAction'],[constants_1[_0x6b9ec3(0x129)]+_0x6b9ec3(0x11d)]:_0x18dbc7['name'],[constants_1['FLOSUM_NAMESPACE']+_0x6b9ec3(0x122)]:_0x18dbc7[_0x6b9ec3(0xe2)],[constants_1[_0x6b9ec3(0x129)]+_0x6b9ec3(0xe5)]:_0x18dbc7['stepName'],[constants_1['FLOSUM_NAMESPACE']+_0x6b9ec3(0x141)]:this[_0x6b9ec3(0x140)][_0x6b9ec3(0x11e)],[constants_1[_0x6b9ec3(0x129)]+_0x6b9ec3(0x125)]:this['_metadataLogId']};});}async[a337_0x399835(0xf6)](_0x366880){const _0x53c294=a337_0x399835;this['_logger'][_0x53c294(0x10a)](_0x53c294(0xbe));const _0x4d06f5=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x53c294(0x129)]+_0x53c294(0x134),_0x366880),_0x59b043=_0x4d06f5[_0x53c294(0x121)](_0x5ac5f3=>!_0x5ac5f3[_0x53c294(0xc2)])[_0x53c294(0x11c)](_0x46b34e=>_0x46b34e[_0x53c294(0x147)])[_0x53c294(0x139)]();if(_0x59b043['length'])throw new salesforce_dml_error_1[(_0x53c294(0xdc))](_0x59b043);}async['finishRollbackWithError'](_0x179385){const _0x39e0d6=a337_0x399835;if(!this[_0x39e0d6(0x140)]){this['_systemLogger'][_0x39e0d6(0x14a)](_0x179385);return;}this['_logger']['logError'](_0x179385),await this[_0x39e0d6(0xe4)][_0x39e0d6(0xdf)](),await this[_0x39e0d6(0x12d)](![],!![],'');}async['finishRollback'](_0x40533e,_0x2bdcdb,_0x2c6340){const _0x32147c=a337_0x399835,{id:_0x26dc13,organizationId:_0x394042,branchId:_0x3d03f6,organizationName:_0x580c06}=this[_0x32147c(0x140)],_0x3928be=_0x32147c(0x10e)+this[_0x32147c(0x142)]+'/'+_0x26dc13+'\x20>\x20'+'Veeva\x20Rollback\x20(Deployment)'+_0x32147c(0x109),_0x2ef9fe=_0x32147c(0x10e)+this['_instanceUrl']+'/'+_0x394042+'\x20>'+_0x580c06+'</a>',_0x5dd8cb=_0x3928be+_0x32147c(0x13c)+_0x2ef9fe+_0x32147c(0x132),_0x20e0fe={[constants_1[_0x32147c(0x129)]+'Action__c']:_0x5dd8cb,[constants_1['FLOSUM_NAMESPACE']+_0x32147c(0x108)]:new Date(),[constants_1[_0x32147c(0x129)]+_0x32147c(0xcd)]:_0x3d03f6,[constants_1[_0x32147c(0x129)]+_0x32147c(0xfe)]:'Branch',[constants_1[_0x32147c(0x129)]+_0x32147c(0xe6)]:_0x32147c(0x114),[constants_1[_0x32147c(0x129)]+_0x32147c(0xd6)]:_0x394042},_0xed0da2={[constants_1[_0x32147c(0x129)]+_0x32147c(0x131)]:!_0x40533e,[constants_1[_0x32147c(0x129)]+'Succeed__c']:_0x40533e,[constants_1[_0x32147c(0x129)]+'Status__c']:_0x2bdcdb?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x32147c(0xd2)]['COMPLETED'],[constants_1[_0x32147c(0x129)]+_0x32147c(0x127)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x32147c(0x112)]:_0x2c6340};await this[_0x32147c(0xf4)]['patch'](flosum_constants_1['FlosumConstants'][_0x32147c(0xe3)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x32147c(0x138)+this[_0x32147c(0x128)],_0xed0da2),await this[_0x32147c(0xf4)][_0x32147c(0x10b)](flosum_constants_1[_0x32147c(0x12e)][_0x32147c(0xe3)]+'/'+constants_1[_0x32147c(0x129)]+_0x32147c(0x11a),_0x20e0fe),this[_0x32147c(0xe4)][_0x32147c(0x10a)](_0x32147c(0xcb)+(_0x40533e?_0x32147c(0x116):_0x32147c(0x14c))+'.'),await this[_0x32147c(0xe4)][_0x32147c(0xdf)]();}async[a337_0x399835(0xeb)](){const _0x2abb12=a337_0x399835;try{this['_metadataLog']=await this[_0x2abb12(0x12f)]();const _0x50730e=await this[_0x2abb12(0x13d)]();await this[_0x2abb12(0xe4)][_0x2abb12(0xdf)]();const _0x15be1e=await this[_0x2abb12(0x110)](_0x50730e),_0x2ac94c=await this[_0x2abb12(0xf9)](_0x15be1e);await this[_0x2abb12(0xe4)][_0x2abb12(0xdf)]();const _0x4fd413=await this[_0x2abb12(0xe8)][_0x2abb12(0x117)](_0x2ac94c);await this['_logger'][_0x2abb12(0xdf)]();const _0x4a0b74=this[_0x2abb12(0x118)](_0x4fd413[_0x2abb12(0xf0)]);await this['saveDeploymentResults'](_0x4a0b74),await this[_0x2abb12(0x12d)](_0x4fd413[_0x2abb12(0x119)],![],_0x4fd413[_0x2abb12(0x120)]);}catch(_0x5a3a56){await this['finishRollbackWithError'](_0x5a3a56)[_0x2abb12(0xbf)](_0x492c0e=>this[_0x2abb12(0xef)][_0x2abb12(0x14a)](_0x492c0e));}}}exports['RollbackService']=RollbackService;