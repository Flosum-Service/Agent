function a405_0x170d(){const _0x399ed5=['../classes/errors/salesforce-dml-error','length','_timeZone','TargetId__c','shortid','Rollback\x20completed\x20','Metadata_Log__c/','External_Deployment_Id__c','Job_Completed__c','Deployment\x20Result','createVpk','PackageImportService','2FIqzmh','fs/promises','Org__c','post','ENDPOINT_UPSERT_RECORD','_attachmentLogId','default','\x20:\x20','Succeed__c','2631695WLBmPS','_vpkService','Date__c','_connectionVeeva','Veeva_Step_Name__c','_componentIds','_packageImportService','saveLog','retrieveDeploymentResults','map','Cannot\x20find\x20Backup\x20Zip','packageId','Activity_Item__c','with\x20error','\x20has\x20been\x20created.','Deployment_Result__c','1451364qfVeKy','Branch__c','from','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','base64','type','./salesforce.service','defineProperty','MetadataLogStatus','95150CozGdk','Save\x20Deployment\x20Results','values','\x20>\x20','Component_Name__c','35024SlDsGV','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','toString','validate','packageComponentList','2030jgCEom','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','constructor','Retrieve\x20Metadata\x20Log\x20info','Action__c','/Attachment','Component_Type__c','Retrieve\x20Deployment\x20Results','<a\x20href=','6JttGvk','Is_Error__c','Create\x20Vpk\x20package','catch','patch','\x27\x20AND\x20Name\x20=\x20\x27','apply','Veeva\x20Rollback\x20(Deployment)','Failure','_instanceUrl','../classes/rollback/zip-creator.rollback','create','log','filter','Branch','import','__importDefault','createZip','_metadataLog','retrieveAttachments','../../../core','retrieve','Type__c','logError','__esModule','953984jQhTxT','search','(((.+)+)+)+$','formFlosumDeploymentResults','./vpk.service','finishRollbackWithError','/vpk__','updateLog','Activity_Type__c','427YOaaKV','Cannot\x20find\x20Deployment\x20Results','Body','FlosumConstants','FLOSUM_NAMESPACE','error','.zip','writeFile','_veevaService','Success','_logger','saveDeploymentResults','ZipCreatorRollback','3329802iLotcc','Metadata_Log__c','Logger','generate','_tempFolder','Deployment','PackageComponentStatus','327989DJbiFo','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','isDeployed','../enums/status.enums','RollbackService','../classes/retrievers/deployment-results/id.deployment-result.retriever','retrieveRecords','veeva-rollback','\x20of\x20branch\x20to\x20Organization\x20','_connectionSalesforce','_metadataLogId','retrieveBackup','VpkService','_parentMetadataLogId','name','insertMultipleRecords','finishRollback','execute','IdDeploymentResultRetriever','SalesforceService','\x20</a>','slice','BACKUP_ZIP_NAME','\x27\x0a\x20\x20\x20\x20','SalesforceDmlError','Status__c','deploymentAction','text/plain','_salesforceService','</a>','../../shared/utils/fetch-attachments','_systemLogger','./package-import.service'];a405_0x170d=function(){return _0x399ed5;};return a405_0x170d();}const a405_0x6d0f6=a405_0x3829;(function(_0x2e4c46,_0x16c88e){const _0x4aac1e=a405_0x3829,_0x56f6fe=_0x2e4c46();while(!![]){try{const _0x4c41f2=-parseInt(_0x4aac1e(0x1cc))/0x1+-parseInt(_0x4aac1e(0x1f9))/0x2*(parseInt(_0x4aac1e(0x212))/0x3)+-parseInt(_0x4aac1e(0x1af))/0x4+parseInt(_0x4aac1e(0x202))/0x5*(-parseInt(_0x4aac1e(0x22e))/0x6)+-parseInt(_0x4aac1e(0x1b8))/0x7*(parseInt(_0x4aac1e(0x220))/0x8)+parseInt(_0x4aac1e(0x1c5))/0x9+-parseInt(_0x4aac1e(0x225))/0xa*(-parseInt(_0x4aac1e(0x21b))/0xb);if(_0x4c41f2===_0x16c88e)break;else _0x56f6fe['push'](_0x56f6fe['shift']());}catch(_0x3df1f2){_0x56f6fe['push'](_0x56f6fe['shift']());}}}(a405_0x170d,0x44e92));const a405_0x583bab=(function(){let _0x239d4b=!![];return function(_0x1339b0,_0x1fedea){const _0x5eff86=_0x239d4b?function(){const _0x20ecf2=a405_0x3829;if(_0x1fedea){const _0x5bf706=_0x1fedea[_0x20ecf2(0x234)](_0x1339b0,arguments);return _0x1fedea=null,_0x5bf706;}}:function(){};return _0x239d4b=![],_0x5eff86;};}()),a405_0x149a56=a405_0x583bab(this,function(){const _0x4b5f84=a405_0x3829;return a405_0x149a56[_0x4b5f84(0x222)]()[_0x4b5f84(0x1b0)](_0x4b5f84(0x1b1))[_0x4b5f84(0x222)]()[_0x4b5f84(0x227)](a405_0x149a56)[_0x4b5f84(0x1b0)](_0x4b5f84(0x1b1));});a405_0x149a56();'use strict';var __importDefault=this&&this[a405_0x6d0f6(0x1a6)]||function(_0xbc273c){const _0x2b386b=a405_0x6d0f6;return _0xbc273c&&_0xbc273c[_0x2b386b(0x1ae)]?_0xbc273c:{'default':_0xbc273c};};Object[a405_0x6d0f6(0x219)](exports,a405_0x6d0f6(0x1ae),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a405_0x6d0f6(0x218)),package_import_service_1=require(a405_0x6d0f6(0x1ec)),id_deployment_result_retriever_1=require(a405_0x6d0f6(0x1d1)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a405_0x6d0f6(0x1ea)),constants_1=require('../../../constants'),zip_creator_rollback_1=require(a405_0x6d0f6(0x238)),shortid_1=__importDefault(require(a405_0x6d0f6(0x1f1))),promises_1=require(a405_0x6d0f6(0x1fa)),vpk_service_1=require(a405_0x6d0f6(0x1b3)),status_enums_1=require(a405_0x6d0f6(0x1cf)),salesforce_dml_error_1=require(a405_0x6d0f6(0x1ed)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a405_0x6d0f6(0x1aa));class RollbackService{constructor({connectionSalesforce:_0x595776,connectionVeeva:_0x3f02a3,logger:_0x34b2d8,tempFolder:_0x1566c5,instanceUrl:_0x1ab8e2,timeZone:_0x334240,metadataLogId:_0x491692,attachmentLogId:_0x4a7cb4,parentMetadataLogId:_0x52b131,componentIds:_0x5948f4}){const _0x590447=a405_0x6d0f6;this[_0x590447(0x1d5)]=_0x595776,this[_0x590447(0x205)]=_0x3f02a3,this['_logger']=_0x34b2d8,this[_0x590447(0x1c9)]=_0x1566c5,this[_0x590447(0x237)]=_0x1ab8e2,this[_0x590447(0x1ef)]=_0x334240,this[_0x590447(0x1d6)]=_0x491692,this[_0x590447(0x1fe)]=_0x4a7cb4,this[_0x590447(0x1d9)]=_0x52b131,this[_0x590447(0x207)]=_0x5948f4,this[_0x590447(0x1eb)]=new core_1[(_0x590447(0x1c7))](_0x590447(0x1d3)),this[_0x590447(0x1c0)]=new veeva_service_1['VeevaService']({'connection':_0x3f02a3,'logger':_0x34b2d8}),this[_0x590447(0x1e8)]=new salesforce_service_1[(_0x590447(0x1df))]({'connection':_0x595776}),this[_0x590447(0x208)]=new package_import_service_1[(_0x590447(0x1f8))]({'veevaService':this[_0x590447(0x1c0)],'connection':_0x3f02a3,'logger':_0x34b2d8,'saveLog':this['saveLog']['bind'](this)}),this[_0x590447(0x203)]=new vpk_service_1[(_0x590447(0x1d8))]({'connection':_0x3f02a3});}async[a405_0x6d0f6(0x209)](_0x58042a,_0x2f12ff){const _0x4add2c=a405_0x6d0f6;this[_0x4add2c(0x1c2)][_0x4add2c(0x1a2)]('Save\x20log');const _0x3d06e1={'Body':Buffer[_0x4add2c(0x214)](_0x58042a)[_0x4add2c(0x222)](_0x4add2c(0x216)),'ContentType':_0x4add2c(0x1e7),'ParentId':this[_0x4add2c(0x1d6)],'Name':_0x2f12ff};await this[_0x4add2c(0x1d5)][_0x4add2c(0x1fc)](flosum_constants_1['FlosumConstants'][_0x4add2c(0x1fd)]+_0x4add2c(0x22a),_0x3d06e1);}async['retrieveMetadataLog'](){const _0x21358f=a405_0x6d0f6;this[_0x21358f(0x1c2)][_0x21358f(0x1a2)](_0x21358f(0x228));const [_0x26aa92]=await this[_0x21358f(0x1e8)][_0x21358f(0x1d2)](_0x21358f(0x221)+constants_1[_0x21358f(0x1bc)]+_0x21358f(0x1cd)+constants_1[_0x21358f(0x1bc)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x21358f(0x1bc)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1['FLOSUM_NAMESPACE']+_0x21358f(0x215)+this['_metadataLogId']+_0x21358f(0x1e3));return new metadata_log_dto_1['MetadataLogDto'](_0x26aa92);}async[a405_0x6d0f6(0x20a)](){const _0x32a5b1=a405_0x6d0f6;this[_0x32a5b1(0x1c2)][_0x32a5b1(0x1a2)](_0x32a5b1(0x22c));const _0x26d482=await new id_deployment_result_retriever_1[(_0x32a5b1(0x1de))]({'salesforceService':this[_0x32a5b1(0x1e8)],'value':this[_0x32a5b1(0x207)]})[_0x32a5b1(0x1ab)]();if(!_0x26d482['length'])throw new Error(_0x32a5b1(0x1b9));return _0x26d482;}async[a405_0x6d0f6(0x1d7)](){const _0x139a40=a405_0x6d0f6;this[_0x139a40(0x1c2)][_0x139a40(0x1a2)]('Retrieve\x20Backup');const _0x220ac9=await this['_salesforceService']['retrieveRecords'](_0x139a40(0x226)+this[_0x139a40(0x1d9)]+_0x139a40(0x233)+flosum_constants_1[_0x139a40(0x1bb)][_0x139a40(0x1e2)]+_0x139a40(0x1e3)),_0x4e232b=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x139a40(0x1d5)],[_0x220ac9[0x0]['Id']]),_0x51bc79=await(0x0,fetch_attachments_1[_0x139a40(0x1a9)])(_0x4e232b,this[_0x139a40(0x1d5)]);if(!_0x51bc79[_0x139a40(0x1ee)])throw new Error(_0x139a40(0x20c));return _0x51bc79[0x0][_0x139a40(0x21d)][_0x139a40(0x1ba)];}async['createZip'](_0x323ba6){const _0x524ab1=a405_0x6d0f6;this[_0x524ab1(0x1c2)]['log']('Create\x20zip\x20from\x20backup');const _0x473b00=await this[_0x524ab1(0x1d7)](),_0x1b79f5=await new zip_creator_rollback_1[(_0x524ab1(0x1c4))]({'rollbackName':this[_0x524ab1(0x1a8)]['name'],'backup':_0x473b00,'deploymentResults':_0x323ba6})[_0x524ab1(0x1a1)](),_0x4f4bc4=this[_0x524ab1(0x1c9)]+'/'+(0x0,shortid_1[_0x524ab1(0x1ff)])()+_0x524ab1(0x1be);return await(0x0,promises_1[_0x524ab1(0x1bf)])(_0x4f4bc4,_0x1b79f5),_0x4f4bc4;}async[a405_0x6d0f6(0x1f7)](_0x5147be){const _0x22b9c9=a405_0x6d0f6;this[_0x22b9c9(0x1c2)][_0x22b9c9(0x1a2)](_0x22b9c9(0x230));const _0x206f03=await this[_0x22b9c9(0x203)][_0x22b9c9(0x1c8)](_0x5147be),_0x322e28=this[_0x22b9c9(0x1c9)]+_0x22b9c9(0x1b5)+_0x5147be[_0x22b9c9(0x1e1)](_0x5147be['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x22b9c9(0x1bf)])(_0x322e28,_0x206f03),await this[_0x22b9c9(0x203)][_0x22b9c9(0x223)](_0x322e28),_0x322e28;}['formFlosumDeploymentResults'](_0x318972){const _0x11a3ab=a405_0x6d0f6;return this[_0x11a3ab(0x1c2)]['log']('Form\x20Deployment\x20Results'),_0x318972[_0x11a3ab(0x20b)](_0x3fde2d=>{const _0x5d06fd=_0x11a3ab;return this[_0x5d06fd(0x1c2)][_0x5d06fd(0x1a2)](_0x3fde2d[_0x5d06fd(0x217)]+'.'+_0x3fde2d[_0x5d06fd(0x1da)]+_0x5d06fd(0x200)+_0x3fde2d['status']),{[constants_1[_0x5d06fd(0x1bc)]+_0x5d06fd(0x1ac)]:_0x5d06fd(0x1f6),[constants_1[_0x5d06fd(0x1bc)]+_0x5d06fd(0x1e5)]:_0x3fde2d['status']===status_enums_1[_0x5d06fd(0x1cb)]['DEPLOYED']?_0x5d06fd(0x1c1):_0x5d06fd(0x236),[constants_1['FLOSUM_NAMESPACE']+'Result__c']:_0x3fde2d[_0x5d06fd(0x1e6)],[constants_1[_0x5d06fd(0x1bc)]+_0x5d06fd(0x21f)]:_0x3fde2d[_0x5d06fd(0x1da)],[constants_1[_0x5d06fd(0x1bc)]+_0x5d06fd(0x22b)]:_0x3fde2d[_0x5d06fd(0x217)],[constants_1[_0x5d06fd(0x1bc)]+_0x5d06fd(0x206)]:_0x3fde2d['stepName'],[constants_1[_0x5d06fd(0x1bc)]+_0x5d06fd(0x1fb)]:this[_0x5d06fd(0x1a8)]['organizationId'],[constants_1['FLOSUM_NAMESPACE']+_0x5d06fd(0x1c6)]:this[_0x5d06fd(0x1d6)]};});}async['saveDeploymentResults'](_0x361080){const _0x46ceb2=a405_0x6d0f6;this['_logger']['log'](_0x46ceb2(0x21c));const _0x1f3fe3=await this[_0x46ceb2(0x1e8)][_0x46ceb2(0x1db)](constants_1[_0x46ceb2(0x1bc)]+_0x46ceb2(0x211),_0x361080),_0x5c1b22=_0x1f3fe3[_0x46ceb2(0x1a3)](_0x24ca73=>!_0x24ca73['success'])[_0x46ceb2(0x20b)](_0x237287=>_0x237287['errors'])['flat']();if(_0x5c1b22['length'])throw new salesforce_dml_error_1[(_0x46ceb2(0x1e4))](_0x5c1b22);}async['finishRollbackWithError'](_0x1fad8a){const _0x3823db=a405_0x6d0f6;if(!this[_0x3823db(0x1a8)]){this[_0x3823db(0x1eb)][_0x3823db(0x1bd)](_0x1fad8a);return;}this['_logger'][_0x3823db(0x1ad)](_0x1fad8a),await this[_0x3823db(0x1c2)][_0x3823db(0x1b6)](),await this[_0x3823db(0x1dc)](![],!![],'');}async['finishRollback'](_0x2f5761,_0x2f29fd,_0x4e5de0){const _0x48baa7=a405_0x6d0f6,{id:_0x3af5c3,organizationId:_0x45481c,branchId:_0x182d0b,organizationName:_0x57fd36}=this[_0x48baa7(0x1a8)],_0x4e844f=_0x48baa7(0x22d)+this['_instanceUrl']+'/'+_0x3af5c3+_0x48baa7(0x21e)+_0x48baa7(0x235)+_0x48baa7(0x1e0),_0x3ebbe0='<a\x20href='+this[_0x48baa7(0x237)]+'/'+_0x45481c+'\x20>'+_0x57fd36+_0x48baa7(0x1e9),_0x15f24e=_0x4e844f+_0x48baa7(0x1d4)+_0x3ebbe0+_0x48baa7(0x210),_0x5a59ac={[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x229)]:_0x15f24e,[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x204)]:new Date(),[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x213)]:_0x182d0b,[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x20e)]:_0x48baa7(0x1a4),[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x1b7)]:_0x48baa7(0x1ca),[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x1f0)]:_0x45481c},_0x2ee143={[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x22f)]:!_0x2f5761,[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x201)]:_0x2f5761,[constants_1[_0x48baa7(0x1bc)]+'Status__c']:_0x2f29fd?status_enums_1[_0x48baa7(0x21a)]['EXCEPTION']:status_enums_1[_0x48baa7(0x21a)]['COMPLETED'],[constants_1['FLOSUM_NAMESPACE']+_0x48baa7(0x1f5)]:!![],[constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x1f4)]:_0x4e5de0};await this[_0x48baa7(0x1d5)][_0x48baa7(0x232)](flosum_constants_1[_0x48baa7(0x1bb)][_0x48baa7(0x1fd)]+'/'+constants_1[_0x48baa7(0x1bc)]+_0x48baa7(0x1f3)+this['_metadataLogId'],_0x2ee143),await this['_connectionSalesforce'][_0x48baa7(0x1fc)](flosum_constants_1[_0x48baa7(0x1bb)][_0x48baa7(0x1fd)]+'/'+constants_1[_0x48baa7(0x1bc)]+'Log__c',_0x5a59ac),this[_0x48baa7(0x1c2)][_0x48baa7(0x1a2)](_0x48baa7(0x1f2)+(_0x2f5761?'successfully':_0x48baa7(0x20f))+'.'),await this[_0x48baa7(0x1c2)]['updateLog']();}async[a405_0x6d0f6(0x1dd)](){const _0x1a8aeb=a405_0x6d0f6;try{this[_0x1a8aeb(0x1a8)]=await this['retrieveMetadataLog']();const _0x37607e=await this[_0x1a8aeb(0x20a)]();await this[_0x1a8aeb(0x1c2)]['updateLog']();const _0x4dd757=await this[_0x1a8aeb(0x1a7)](_0x37607e),_0x49b42a=await this[_0x1a8aeb(0x1f7)](_0x4dd757);await this[_0x1a8aeb(0x1c2)]['updateLog']();const _0x34671d=await this[_0x1a8aeb(0x208)][_0x1a8aeb(0x1a5)](_0x49b42a);await this[_0x1a8aeb(0x1c2)][_0x1a8aeb(0x1b6)]();const _0x866b7d=this[_0x1a8aeb(0x1b2)](_0x34671d[_0x1a8aeb(0x224)]);await this[_0x1a8aeb(0x1c3)](_0x866b7d),await this[_0x1a8aeb(0x1dc)](_0x34671d[_0x1a8aeb(0x1ce)],![],_0x34671d[_0x1a8aeb(0x20d)]);}catch(_0x955ddd){await this[_0x1a8aeb(0x1b4)](_0x955ddd)[_0x1a8aeb(0x231)](_0x154a71=>this[_0x1a8aeb(0x1eb)][_0x1a8aeb(0x1bd)](_0x154a71));}}}function a405_0x3829(_0x3dc99a,_0xc6bb10){const _0x582f69=a405_0x170d();return a405_0x3829=function(_0x149a56,_0x583bab){_0x149a56=_0x149a56-0x1a1;let _0x170d11=_0x582f69[_0x149a56];return _0x170d11;},a405_0x3829(_0x3dc99a,_0xc6bb10);}exports[a405_0x6d0f6(0x1d0)]=RollbackService;