function a361_0x3b2f(){const _0x3b7455=['IdDeploymentResultRetriever','map','Retrieve\x20Metadata\x20Log\x20info','generate','flat','/Attachment','SalesforceDmlError','post','\x20:\x20','__esModule','retrieveMetadataLog','./vpk.service','Type__c','Status__c','./salesforce.service','\x20has\x20been\x20created.','_veevaService','./package-import.service','__importDefault','patch','length','organizationId','errors','VpkService','_systemLogger','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','import','98NXAqXO','140gNxxnn','EXCEPTION','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','MetadataLogDto','successfully','Org__c','values','Retrieve\x20Deployment\x20Results','Veeva\x20Rollback\x20(Deployment)','Activity_Type__c','createVpk','Retrieve\x20Backup','../enums/status.enums','create','bind','deploymentAction','22SyIWwB','../classes/retrievers/deployment-results/id.deployment-result.retriever','finishRollback','ENDPOINT_UPSERT_RECORD','5218368VCxyYK','Save\x20log','_salesforceService','slice','2643650Dkpkeq','veeva-rollback','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','MetadataLogStatus','fetchAttachmentsDetailsById','execute','../constants/flosum.constants','finishRollbackWithError','../../shared/utils/fetch-attachments','saveDeploymentResults','../dtos/metadata-log.dto','filter','\x27\x0a\x20\x20\x20\x20','writeFile','SalesforceService','Deployment','_metadataLog','name','toString','_connectionSalesforce','_tempFolder','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../classes/errors/salesforce-dml-error','validate','\x20>\x20','\x20of\x20branch\x20to\x20Organization\x20','(((.+)+)+)+$','Result__c','232074InsoLe','saveLog','<a\x20href=','_metadataLogId','_vpkService','with\x20error','error','Cannot\x20find\x20Backup\x20Zip','Cannot\x20find\x20Deployment\x20Results','Veeva_Step_Name__c','PackageImportService','_parentMetadataLogId','_componentIds','71164pWkckr','retrieveBackup','logError','Create\x20zip\x20from\x20backup','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','_logger','updateLog','7712990KnLWVT','Log__c','_instanceUrl','stepName','FlosumConstants','Activity_Item__c','Succeed__c','Async_Request_Id__c','constructor','apply','_packageImportService','ZipCreatorRollback','formFlosumDeploymentResults','Success','default','200PRgiHa','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Branch','success','Date__c','retrieveRecords','495624IjSzDV','Branch__c','RollbackService','../../../core','log','Rollback\x20completed\x20','Failure','15sUQdxW','shortid','TargetId__c','5938pnOnfK','Body','lastIndexOf','./veeva.service','FLOSUM_NAMESPACE','Create\x20Vpk\x20package','search','createZip'];a361_0x3b2f=function(){return _0x3b7455;};return a361_0x3b2f();}const a361_0x11ff9d=a361_0x4506;(function(_0x5a712b,_0x2decb5){const _0x5d4a17=a361_0x4506,_0x18e69b=_0x5a712b();while(!![]){try{const _0x338316=parseInt(_0x5d4a17(0x1cf))/0x1*(-parseInt(_0x5d4a17(0x1f3))/0x2)+parseInt(_0x5d4a17(0x1cc))/0x3*(parseInt(_0x5d4a17(0x1a9))/0x4)+parseInt(_0x5d4a17(0x20b))/0x5+parseInt(_0x5d4a17(0x1c5))/0x6*(parseInt(_0x5d4a17(0x1f2))/0x7)+parseInt(_0x5d4a17(0x1bf))/0x8*(parseInt(_0x5d4a17(0x19c))/0x9)+-parseInt(_0x5d4a17(0x1b0))/0xa*(parseInt(_0x5d4a17(0x203))/0xb)+parseInt(_0x5d4a17(0x207))/0xc;if(_0x338316===_0x2decb5)break;else _0x18e69b['push'](_0x18e69b['shift']());}catch(_0x5f3ed2){_0x18e69b['push'](_0x18e69b['shift']());}}}(a361_0x3b2f,0xda9a5));function a361_0x4506(_0x270aa1,_0x325fee){const _0x539b77=a361_0x3b2f();return a361_0x4506=function(_0x35ba7d,_0x56b66f){_0x35ba7d=_0x35ba7d-0x195;let _0x3b2fd7=_0x539b77[_0x35ba7d];return _0x3b2fd7;},a361_0x4506(_0x270aa1,_0x325fee);}const a361_0x56b66f=(function(){let _0x2744a5=!![];return function(_0x5eff98,_0x3c2dfd){const _0x4c41cb=_0x2744a5?function(){const _0x4bfff4=a361_0x4506;if(_0x3c2dfd){const _0x510002=_0x3c2dfd[_0x4bfff4(0x1b9)](_0x5eff98,arguments);return _0x3c2dfd=null,_0x510002;}}:function(){};return _0x2744a5=![],_0x4c41cb;};}()),a361_0x35ba7d=a361_0x56b66f(this,function(){const _0x268370=a361_0x4506;return a361_0x35ba7d[_0x268370(0x21d)]()[_0x268370(0x1d5)]('(((.+)+)+)+$')[_0x268370(0x21d)]()[_0x268370(0x1b8)](a361_0x35ba7d)['search'](_0x268370(0x19a));});a361_0x35ba7d();'use strict';var __importDefault=this&&this[a361_0x11ff9d(0x1e9)]||function(_0x269866){const _0x1a7c14=a361_0x11ff9d;return _0x269866&&_0x269866[_0x1a7c14(0x1e0)]?_0x269866:{'default':_0x269866};};Object['defineProperty'](exports,a361_0x11ff9d(0x1e0),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a361_0x11ff9d(0x1d2)),salesforce_service_1=require(a361_0x11ff9d(0x1e5)),package_import_service_1=require(a361_0x11ff9d(0x1e8)),id_deployment_result_retriever_1=require(a361_0x11ff9d(0x204)),flosum_constants_1=require(a361_0x11ff9d(0x211)),fetch_attachments_1=require(a361_0x11ff9d(0x213)),constants_1=require('../../../constants'),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a361_0x11ff9d(0x1cd))),promises_1=require('fs/promises'),vpk_service_1=require(a361_0x11ff9d(0x1e2)),status_enums_1=require(a361_0x11ff9d(0x1ff)),salesforce_dml_error_1=require(a361_0x11ff9d(0x196)),metadata_log_dto_1=require(a361_0x11ff9d(0x215)),core_1=require(a361_0x11ff9d(0x1c8));class RollbackService{constructor({connectionSalesforce:_0x259ede,connectionVeeva:_0x272a6e,logger:_0x312483,tempFolder:_0x194f7e,instanceUrl:_0x3e1750,timeZone:_0x2c242b,metadataLogId:_0x390867,attachmentLogId:_0x19c8fc,parentMetadataLogId:_0x172b87,componentIds:_0x162f66}){const _0x161a3b=a361_0x11ff9d;this[_0x161a3b(0x21e)]=_0x259ede,this['_connectionVeeva']=_0x272a6e,this[_0x161a3b(0x1ae)]=_0x312483,this[_0x161a3b(0x21f)]=_0x194f7e,this['_instanceUrl']=_0x3e1750,this['_timeZone']=_0x2c242b,this['_metadataLogId']=_0x390867,this['_attachmentLogId']=_0x19c8fc,this[_0x161a3b(0x1a7)]=_0x172b87,this[_0x161a3b(0x1a8)]=_0x162f66,this[_0x161a3b(0x1ef)]=new core_1['Logger'](_0x161a3b(0x20c)),this[_0x161a3b(0x1e7)]=new veeva_service_1['VeevaService']({'connection':_0x272a6e,'logger':_0x312483}),this[_0x161a3b(0x209)]=new salesforce_service_1[(_0x161a3b(0x219))]({'connection':_0x259ede}),this[_0x161a3b(0x1ba)]=new package_import_service_1[(_0x161a3b(0x1a6))]({'veevaService':this[_0x161a3b(0x1e7)],'connection':_0x272a6e,'logger':_0x312483,'saveLog':this[_0x161a3b(0x19d)][_0x161a3b(0x201)](this)}),this[_0x161a3b(0x1a0)]=new vpk_service_1[(_0x161a3b(0x1ee))]({'connection':_0x272a6e});}async[a361_0x11ff9d(0x19d)](_0x42de9b,_0x244096){const _0x1ab2c7=a361_0x11ff9d;this[_0x1ab2c7(0x1ae)][_0x1ab2c7(0x1c9)](_0x1ab2c7(0x208));const _0x4e4878={'Body':Buffer['from'](_0x42de9b)['toString']('base64'),'ContentType':'text/plain','ParentId':this[_0x1ab2c7(0x19f)],'Name':_0x244096};await this['_connectionSalesforce'][_0x1ab2c7(0x1de)](flosum_constants_1[_0x1ab2c7(0x1b4)][_0x1ab2c7(0x206)]+_0x1ab2c7(0x1dc),_0x4e4878);}async[a361_0x11ff9d(0x1e1)](){const _0x29d7ed=a361_0x11ff9d;this[_0x29d7ed(0x1ae)][_0x29d7ed(0x1c9)](_0x29d7ed(0x1d9));const [_0xd794d]=await this[_0x29d7ed(0x209)][_0x29d7ed(0x1c4)](_0x29d7ed(0x20d)+constants_1[_0x29d7ed(0x1d3)]+_0x29d7ed(0x195)+constants_1[_0x29d7ed(0x1d3)]+_0x29d7ed(0x1c0)+constants_1[_0x29d7ed(0x1d3)]+_0x29d7ed(0x1f5)+constants_1[_0x29d7ed(0x1d3)]+_0x29d7ed(0x1ad)+this[_0x29d7ed(0x19f)]+_0x29d7ed(0x217));return new metadata_log_dto_1[(_0x29d7ed(0x1f6))](_0xd794d);}async['retrieveDeploymentResults'](){const _0xd3b41e=a361_0x11ff9d;this['_logger']['log'](_0xd3b41e(0x1fa));const _0x2b1800=await new id_deployment_result_retriever_1[(_0xd3b41e(0x1d7))]({'salesforceService':this[_0xd3b41e(0x209)],'value':this[_0xd3b41e(0x1a8)]})['retrieve']();if(!_0x2b1800['length'])throw new Error(_0xd3b41e(0x1a4));return _0x2b1800;}async['retrieveBackup'](){const _0xd22481=a361_0x11ff9d;this[_0xd22481(0x1ae)]['log'](_0xd22481(0x1fe));const _0x5621c2=await this[_0xd22481(0x209)]['retrieveRecords'](_0xd22481(0x1f0)+this['_parentMetadataLogId']+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0xd22481(0x1b4)]['BACKUP_ZIP_NAME']+_0xd22481(0x217)),_0x3d115b=await(0x0,fetch_attachments_1[_0xd22481(0x20f)])(this['_connectionSalesforce'],[_0x5621c2[0x0]['Id']]),_0x59f128=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x3d115b,this['_connectionSalesforce']);if(!_0x59f128[_0xd22481(0x1eb)])throw new Error(_0xd22481(0x1a3));return _0x59f128[0x0][_0xd22481(0x1f9)][_0xd22481(0x1d0)];}async[a361_0x11ff9d(0x1d6)](_0x34ef2b){const _0xf459b6=a361_0x11ff9d;this['_logger'][_0xf459b6(0x1c9)](_0xf459b6(0x1ac));const _0x2d9e0e=await this[_0xf459b6(0x1aa)](),_0x5af4dc=await new zip_creator_rollback_1[(_0xf459b6(0x1bb))]({'rollbackName':this[_0xf459b6(0x21b)]['name'],'backup':_0x2d9e0e,'deploymentResults':_0x34ef2b})[_0xf459b6(0x200)](),_0x4c111a=this[_0xf459b6(0x21f)]+'/'+(0x0,shortid_1[_0xf459b6(0x1be)])()+'.zip';return await(0x0,promises_1[_0xf459b6(0x218)])(_0x4c111a,_0x5af4dc),_0x4c111a;}async['createVpk'](_0x474a2a){const _0x3fc2f9=a361_0x11ff9d;this[_0x3fc2f9(0x1ae)]['log'](_0x3fc2f9(0x1d4));const _0x15bb38=await this[_0x3fc2f9(0x1a0)][_0x3fc2f9(0x1da)](_0x474a2a),_0x4ce858=this[_0x3fc2f9(0x21f)]+'/vpk__'+_0x474a2a[_0x3fc2f9(0x20a)](_0x474a2a[_0x3fc2f9(0x1d1)]('/')+0x1);return await(0x0,promises_1[_0x3fc2f9(0x218)])(_0x4ce858,_0x15bb38),await this['_vpkService'][_0x3fc2f9(0x197)](_0x4ce858),_0x4ce858;}['formFlosumDeploymentResults'](_0x5422a4){const _0x3dda4b=a361_0x11ff9d;return this[_0x3dda4b(0x1ae)][_0x3dda4b(0x1c9)]('Form\x20Deployment\x20Results'),_0x5422a4[_0x3dda4b(0x1d8)](_0x3d7a73=>{const _0x70cebf=_0x3dda4b;return this['_logger']['log'](_0x3d7a73['type']+'.'+_0x3d7a73[_0x70cebf(0x21c)]+_0x70cebf(0x1df)+_0x3d7a73['status']),{[constants_1[_0x70cebf(0x1d3)]+_0x70cebf(0x1e3)]:'Deployment\x20Result',[constants_1[_0x70cebf(0x1d3)]+'Status__c']:_0x3d7a73['status']===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x70cebf(0x1bd):_0x70cebf(0x1cb),[constants_1[_0x70cebf(0x1d3)]+_0x70cebf(0x19b)]:_0x3d7a73[_0x70cebf(0x202)],[constants_1[_0x70cebf(0x1d3)]+'Component_Name__c']:_0x3d7a73[_0x70cebf(0x21c)],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x3d7a73['type'],[constants_1['FLOSUM_NAMESPACE']+_0x70cebf(0x1a5)]:_0x3d7a73[_0x70cebf(0x1b3)],[constants_1[_0x70cebf(0x1d3)]+_0x70cebf(0x1f8)]:this[_0x70cebf(0x21b)][_0x70cebf(0x1ec)],[constants_1[_0x70cebf(0x1d3)]+'Metadata_Log__c']:this[_0x70cebf(0x19f)]};});}async[a361_0x11ff9d(0x214)](_0x360e42){const _0x2ae22a=a361_0x11ff9d;this[_0x2ae22a(0x1ae)][_0x2ae22a(0x1c9)]('Save\x20Deployment\x20Results');const _0x4df642=await this[_0x2ae22a(0x209)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x360e42),_0x4be013=_0x4df642[_0x2ae22a(0x216)](_0x252c31=>!_0x252c31[_0x2ae22a(0x1c2)])[_0x2ae22a(0x1d8)](_0x3f2602=>_0x3f2602[_0x2ae22a(0x1ed)])[_0x2ae22a(0x1db)]();if(_0x4be013[_0x2ae22a(0x1eb)])throw new salesforce_dml_error_1[(_0x2ae22a(0x1dd))](_0x4be013);}async[a361_0x11ff9d(0x212)](_0x25311c){const _0x272fb9=a361_0x11ff9d;if(!this[_0x272fb9(0x21b)]){this[_0x272fb9(0x1ef)][_0x272fb9(0x1a2)](_0x25311c);return;}this[_0x272fb9(0x1ae)][_0x272fb9(0x1ab)](_0x25311c),await this[_0x272fb9(0x1ae)]['updateLog'](),await this[_0x272fb9(0x205)](![],!![],'');}async[a361_0x11ff9d(0x205)](_0x3c8462,_0x287ff2,_0x5269c4){const _0x4c70c2=a361_0x11ff9d,{id:_0x283be0,organizationId:_0x3973b4,branchId:_0x2d5785,organizationName:_0x3e3c06}=this[_0x4c70c2(0x21b)],_0x4b569d=_0x4c70c2(0x19e)+this[_0x4c70c2(0x1b2)]+'/'+_0x283be0+_0x4c70c2(0x198)+_0x4c70c2(0x1fb)+'\x20</a>',_0x430b04=_0x4c70c2(0x19e)+this['_instanceUrl']+'/'+_0x3973b4+'\x20>'+_0x3e3c06+'</a>',_0x41325e=_0x4b569d+_0x4c70c2(0x199)+_0x430b04+_0x4c70c2(0x1e6),_0x25ab86={[constants_1[_0x4c70c2(0x1d3)]+'Action__c']:_0x41325e,[constants_1[_0x4c70c2(0x1d3)]+_0x4c70c2(0x1c3)]:new Date(),[constants_1[_0x4c70c2(0x1d3)]+_0x4c70c2(0x1c6)]:_0x2d5785,[constants_1[_0x4c70c2(0x1d3)]+_0x4c70c2(0x1b5)]:_0x4c70c2(0x1c1),[constants_1['FLOSUM_NAMESPACE']+_0x4c70c2(0x1fc)]:_0x4c70c2(0x21a),[constants_1[_0x4c70c2(0x1d3)]+_0x4c70c2(0x1ce)]:_0x3973b4},_0x5684b5={[constants_1[_0x4c70c2(0x1d3)]+'Is_Error__c']:!_0x3c8462,[constants_1[_0x4c70c2(0x1d3)]+_0x4c70c2(0x1b6)]:_0x3c8462,[constants_1[_0x4c70c2(0x1d3)]+_0x4c70c2(0x1e4)]:_0x287ff2?status_enums_1[_0x4c70c2(0x20e)][_0x4c70c2(0x1f4)]:status_enums_1[_0x4c70c2(0x20e)]['COMPLETED'],[constants_1[_0x4c70c2(0x1d3)]+'Job_Completed__c']:!![],[constants_1[_0x4c70c2(0x1d3)]+_0x4c70c2(0x1b7)]:_0x5269c4};await this['_connectionSalesforce'][_0x4c70c2(0x1ea)](flosum_constants_1[_0x4c70c2(0x1b4)][_0x4c70c2(0x206)]+'/'+constants_1[_0x4c70c2(0x1d3)]+'Metadata_Log__c/'+this[_0x4c70c2(0x19f)],_0x5684b5),await this[_0x4c70c2(0x21e)][_0x4c70c2(0x1de)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x4c70c2(0x1d3)]+_0x4c70c2(0x1b1),_0x25ab86),this['_logger']['log'](_0x4c70c2(0x1ca)+(_0x3c8462?_0x4c70c2(0x1f7):_0x4c70c2(0x1a1))+'.'),await this[_0x4c70c2(0x1ae)][_0x4c70c2(0x1af)]();}async[a361_0x11ff9d(0x210)](){const _0x10a0d9=a361_0x11ff9d;try{this[_0x10a0d9(0x21b)]=await this[_0x10a0d9(0x1e1)]();const _0x2e13c7=await this['retrieveDeploymentResults']();await this[_0x10a0d9(0x1ae)][_0x10a0d9(0x1af)]();const _0x5e81af=await this[_0x10a0d9(0x1d6)](_0x2e13c7),_0x375846=await this[_0x10a0d9(0x1fd)](_0x5e81af);await this['_logger']['updateLog']();const _0x377749=await this[_0x10a0d9(0x1ba)][_0x10a0d9(0x1f1)](_0x375846);await this[_0x10a0d9(0x1ae)][_0x10a0d9(0x1af)]();const _0x56238e=this[_0x10a0d9(0x1bc)](_0x377749['packageComponentList']);await this[_0x10a0d9(0x214)](_0x56238e),await this[_0x10a0d9(0x205)](_0x377749['isDeployed'],![],_0x377749['packageId']);}catch(_0x507433){await this['finishRollbackWithError'](_0x507433)['catch'](_0x541000=>this[_0x10a0d9(0x1ef)][_0x10a0d9(0x1a2)](_0x541000));}}}exports[a361_0x11ff9d(0x1c7)]=RollbackService;