const a361_0xe23e57=a361_0x46ba;function a361_0x46ba(_0x8e4d2d,_0x57c9ef){const _0x1f4d61=a361_0x1586();return a361_0x46ba=function(_0x34e94c,_0x27072b){_0x34e94c=_0x34e94c-0x1c1;let _0x15868c=_0x1f4d61[_0x34e94c];return _0x15868c;},a361_0x46ba(_0x8e4d2d,_0x57c9ef);}(function(_0x4391e4,_0x290f4c){const _0x4606c8=a361_0x46ba,_0x171df8=_0x4391e4();while(!![]){try{const _0x34f5c9=-parseInt(_0x4606c8(0x1ef))/0x1*(-parseInt(_0x4606c8(0x226))/0x2)+parseInt(_0x4606c8(0x20d))/0x3+-parseInt(_0x4606c8(0x219))/0x4+parseInt(_0x4606c8(0x23e))/0x5*(parseInt(_0x4606c8(0x201))/0x6)+parseInt(_0x4606c8(0x1c1))/0x7*(parseInt(_0x4606c8(0x1c9))/0x8)+parseInt(_0x4606c8(0x22f))/0x9*(-parseInt(_0x4606c8(0x1d9))/0xa)+-parseInt(_0x4606c8(0x204))/0xb;if(_0x34f5c9===_0x290f4c)break;else _0x171df8['push'](_0x171df8['shift']());}catch(_0xb57a35){_0x171df8['push'](_0x171df8['shift']());}}}(a361_0x1586,0x38660));const a361_0x27072b=(function(){let _0x2fd07f=!![];return function(_0x4690ea,_0x5ba094){const _0x4296c2=_0x2fd07f?function(){if(_0x5ba094){const _0x48ba8c=_0x5ba094['apply'](_0x4690ea,arguments);return _0x5ba094=null,_0x48ba8c;}}:function(){};return _0x2fd07f=![],_0x4296c2;};}()),a361_0x34e94c=a361_0x27072b(this,function(){const _0x5e7059=a361_0x46ba;return a361_0x34e94c['toString']()[_0x5e7059(0x1d8)](_0x5e7059(0x235))['toString']()[_0x5e7059(0x20b)](a361_0x34e94c)[_0x5e7059(0x1d8)](_0x5e7059(0x235));});a361_0x34e94c();'use strict';var __importDefault=this&&this[a361_0xe23e57(0x1e9)]||function(_0x2aacc2){return _0x2aacc2&&_0x2aacc2['__esModule']?_0x2aacc2:{'default':_0x2aacc2};};function a361_0x1586(){const _0x185ef8=['PackageImportService','(((.+)+)+)+$','VpkService','Type__c','with\x20error','/Attachment','\x20>\x20','Cannot\x20find\x20Deployment\x20Results','TargetId__c','defineProperty','95510dEgJQI','Is_Error__c','../classes/errors/salesforce-dml-error','_timeZone','Retrieve\x20Metadata\x20Log\x20info','retrieveRecords','saveDeploymentResults','packageComponentList','Org__c','\x27\x20AND\x20Name\x20=\x20\x27','1114043lqiSJS','Save\x20Deployment\x20Results','../constants/flosum.constants','lastIndexOf','../../../constants','Success','_packageImportService','_parentMetadataLogId','8Kpeyxx','Failure','status','from','External_Deployment_Id__c','retrieve','\x20has\x20been\x20created.','__esModule','Branch','_metadataLog','name','retrieveDeploymentResults','\x20</a>','../enums/status.enums','.zip','search','10qmnnEq','VeevaService','import','Save\x20log','ENDPOINT_UPSERT_RECORD','_connectionSalesforce','Body','_salesforceService','Cannot\x20find\x20Backup\x20Zip','EXCEPTION','Create\x20Vpk\x20package','saveLog','execute','base64','Metadata_Log__c','FlosumConstants','__importDefault','finishRollbackWithError','map','catch','text/plain','SalesforceService','240035fyFmKQ','retrieveAttachments','Retrieve\x20Backup','COMPLETED','log','Veeva\x20Rollback\x20(Deployment)','retrieveMetadataLog','Status__c','Metadata_Log__c/','updateLog','_veevaService','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','isDeployed','<a\x20href=','length','SalesforceDmlError','Logger','type','6LdMFiS','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_tempFolder','803352MquMVM','/vpk__','filter','\x20:\x20','flat','finishRollback','post','constructor','MetadataLogDto','1055214NBgCik','_instanceUrl','Action__c','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','_logger','Branch__c','validate','Deployment\x20Result','IdDeploymentResultRetriever','../dtos/metadata-log.dto','./package-import.service','Form\x20Deployment\x20Results','1348972iKmtKc','Result__c','slice','_systemLogger','ZipCreatorRollback','_metadataLogId','deploymentAction','_componentIds','./salesforce.service','fs/promises','../classes/rollback/zip-creator.rollback','./vpk.service','Activity_Item__c','2CBURdc','createZip','Rollback\x20completed\x20','veeva-rollback','./veeva.service','logError','formFlosumDeploymentResults','writeFile','error','1158669giWeWq','FLOSUM_NAMESPACE','Deployment_Result__c','DEPLOYED','retrieveBackup'];a361_0x1586=function(){return _0x185ef8;};return a361_0x1586();}Object[a361_0xe23e57(0x23d)](exports,a361_0xe23e57(0x1d0),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a361_0xe23e57(0x22a)),salesforce_service_1=require(a361_0xe23e57(0x221)),package_import_service_1=require(a361_0xe23e57(0x217)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a361_0xe23e57(0x1c3)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a361_0xe23e57(0x1c5)),zip_creator_rollback_1=require(a361_0xe23e57(0x223)),shortid_1=__importDefault(require('shortid')),promises_1=require(a361_0xe23e57(0x222)),vpk_service_1=require(a361_0xe23e57(0x224)),status_enums_1=require(a361_0xe23e57(0x1d6)),salesforce_dml_error_1=require(a361_0xe23e57(0x240)),metadata_log_dto_1=require(a361_0xe23e57(0x216)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0xd451d,connectionVeeva:_0x4a6d9a,logger:_0x2bfcad,tempFolder:_0x3e662f,instanceUrl:_0x4b4238,timeZone:_0x53cf66,metadataLogId:_0x14363e,attachmentLogId:_0x148b47,parentMetadataLogId:_0x596018,componentIds:_0x57a81d}){const _0xb5913c=a361_0xe23e57;this[_0xb5913c(0x1de)]=_0xd451d,this['_connectionVeeva']=_0x4a6d9a,this['_logger']=_0x2bfcad,this[_0xb5913c(0x203)]=_0x3e662f,this[_0xb5913c(0x20e)]=_0x4b4238,this[_0xb5913c(0x241)]=_0x53cf66,this['_metadataLogId']=_0x14363e,this['_attachmentLogId']=_0x148b47,this[_0xb5913c(0x1c8)]=_0x596018,this[_0xb5913c(0x220)]=_0x57a81d,this[_0xb5913c(0x21c)]=new core_1[(_0xb5913c(0x1ff))](_0xb5913c(0x229)),this[_0xb5913c(0x1f9)]=new veeva_service_1[(_0xb5913c(0x1da))]({'connection':_0x4a6d9a,'logger':_0x2bfcad}),this[_0xb5913c(0x1e0)]=new salesforce_service_1[(_0xb5913c(0x1ee))]({'connection':_0xd451d}),this['_packageImportService']=new package_import_service_1[(_0xb5913c(0x234))]({'veevaService':this[_0xb5913c(0x1f9)],'connection':_0x4a6d9a,'logger':_0x2bfcad,'saveLog':this[_0xb5913c(0x1e4)]['bind'](this)}),this['_vpkService']=new vpk_service_1[(_0xb5913c(0x236))]({'connection':_0x4a6d9a});}async[a361_0xe23e57(0x1e4)](_0x490652,_0x38c3ed){const _0x4dea88=a361_0xe23e57;this[_0x4dea88(0x211)][_0x4dea88(0x1f3)](_0x4dea88(0x1dc));const _0x575cff={'Body':Buffer[_0x4dea88(0x1cc)](_0x490652)['toString'](_0x4dea88(0x1e6)),'ContentType':_0x4dea88(0x1ed),'ParentId':this[_0x4dea88(0x21e)],'Name':_0x38c3ed};await this[_0x4dea88(0x1de)]['post'](flosum_constants_1[_0x4dea88(0x1e8)]['ENDPOINT_UPSERT_RECORD']+_0x4dea88(0x239),_0x575cff);}async[a361_0xe23e57(0x1f5)](){const _0x2cfb34=a361_0xe23e57;this[_0x2cfb34(0x211)][_0x2cfb34(0x1f3)](_0x2cfb34(0x242));const [_0x5b1be8]=await this[_0x2cfb34(0x1e0)]['retrieveRecords'](_0x2cfb34(0x202)+constants_1[_0x2cfb34(0x230)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x2cfb34(0x230)]+_0x2cfb34(0x1fa)+constants_1['FLOSUM_NAMESPACE']+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x2cfb34(0x230)]+_0x2cfb34(0x210)+this[_0x2cfb34(0x21e)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x2cfb34(0x20c))](_0x5b1be8);}async['retrieveDeploymentResults'](){const _0x5edc42=a361_0xe23e57;this['_logger']['log']('Retrieve\x20Deployment\x20Results');const _0xbdb12e=await new id_deployment_result_retriever_1[(_0x5edc42(0x215))]({'salesforceService':this[_0x5edc42(0x1e0)],'value':this[_0x5edc42(0x220)]})[_0x5edc42(0x1ce)]();if(!_0xbdb12e[_0x5edc42(0x1fd)])throw new Error(_0x5edc42(0x23b));return _0xbdb12e;}async[a361_0xe23e57(0x233)](){const _0x439348=a361_0xe23e57;this[_0x439348(0x211)][_0x439348(0x1f3)](_0x439348(0x1f1));const _0x4cc9ab=await this[_0x439348(0x1e0)][_0x439348(0x243)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x439348(0x1c8)]+_0x439348(0x247)+flosum_constants_1[_0x439348(0x1e8)]['BACKUP_ZIP_NAME']+'\x27\x0a\x20\x20\x20\x20'),_0x19b4a3=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x439348(0x1de)],[_0x4cc9ab[0x0]['Id']]),_0x5f44bd=await(0x0,fetch_attachments_1[_0x439348(0x1f0)])(_0x19b4a3,this['_connectionSalesforce']);if(!_0x5f44bd[_0x439348(0x1fd)])throw new Error(_0x439348(0x1e1));return _0x5f44bd[0x0]['values'][_0x439348(0x1df)];}async[a361_0xe23e57(0x227)](_0x214735){const _0x4f1a22=a361_0xe23e57;this[_0x4f1a22(0x211)]['log']('Create\x20zip\x20from\x20backup');const _0x4b14b1=await this['retrieveBackup'](),_0x3d0e46=await new zip_creator_rollback_1[(_0x4f1a22(0x21d))]({'rollbackName':this['_metadataLog']['name'],'backup':_0x4b14b1,'deploymentResults':_0x214735})['create'](),_0x23f915=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0x4f1a22(0x1d7);return await(0x0,promises_1[_0x4f1a22(0x22d)])(_0x23f915,_0x3d0e46),_0x23f915;}async['createVpk'](_0x2093f4){const _0x137c74=a361_0xe23e57;this[_0x137c74(0x211)][_0x137c74(0x1f3)](_0x137c74(0x1e3));const _0x3c2bdc=await this['_vpkService']['generate'](_0x2093f4),_0x18f577=this[_0x137c74(0x203)]+_0x137c74(0x205)+_0x2093f4[_0x137c74(0x21b)](_0x2093f4[_0x137c74(0x1c4)]('/')+0x1);return await(0x0,promises_1[_0x137c74(0x22d)])(_0x18f577,_0x3c2bdc),await this['_vpkService'][_0x137c74(0x213)](_0x18f577),_0x18f577;}[a361_0xe23e57(0x22c)](_0x3b5e2a){const _0x1cd4a4=a361_0xe23e57;return this[_0x1cd4a4(0x211)][_0x1cd4a4(0x1f3)](_0x1cd4a4(0x218)),_0x3b5e2a[_0x1cd4a4(0x1eb)](_0x3c151c=>{const _0x39aada=_0x1cd4a4;return this[_0x39aada(0x211)]['log'](_0x3c151c[_0x39aada(0x200)]+'.'+_0x3c151c[_0x39aada(0x1d3)]+_0x39aada(0x207)+_0x3c151c[_0x39aada(0x1cb)]),{[constants_1[_0x39aada(0x230)]+_0x39aada(0x237)]:_0x39aada(0x214),[constants_1[_0x39aada(0x230)]+_0x39aada(0x1f6)]:_0x3c151c['status']===status_enums_1['PackageComponentStatus'][_0x39aada(0x232)]?_0x39aada(0x1c6):_0x39aada(0x1ca),[constants_1['FLOSUM_NAMESPACE']+_0x39aada(0x21a)]:_0x3c151c[_0x39aada(0x21f)],[constants_1[_0x39aada(0x230)]+'Component_Name__c']:_0x3c151c[_0x39aada(0x1d3)],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x3c151c[_0x39aada(0x200)],[constants_1[_0x39aada(0x230)]+'Veeva_Step_Name__c']:_0x3c151c['stepName'],[constants_1['FLOSUM_NAMESPACE']+_0x39aada(0x246)]:this[_0x39aada(0x1d2)]['organizationId'],[constants_1[_0x39aada(0x230)]+_0x39aada(0x1e7)]:this['_metadataLogId']};});}async[a361_0xe23e57(0x244)](_0xe5be15){const _0x190e24=a361_0xe23e57;this[_0x190e24(0x211)][_0x190e24(0x1f3)](_0x190e24(0x1c2));const _0x25e99d=await this['_salesforceService']['insertMultipleRecords'](constants_1[_0x190e24(0x230)]+_0x190e24(0x231),_0xe5be15),_0x213b73=_0x25e99d[_0x190e24(0x206)](_0x16ed7f=>!_0x16ed7f['success'])['map'](_0x528176=>_0x528176['errors'])[_0x190e24(0x208)]();if(_0x213b73[_0x190e24(0x1fd)])throw new salesforce_dml_error_1[(_0x190e24(0x1fe))](_0x213b73);}async[a361_0xe23e57(0x1ea)](_0x2384d1){const _0x3bd313=a361_0xe23e57;if(!this[_0x3bd313(0x1d2)]){this[_0x3bd313(0x21c)][_0x3bd313(0x22e)](_0x2384d1);return;}this['_logger'][_0x3bd313(0x22b)](_0x2384d1),await this[_0x3bd313(0x211)][_0x3bd313(0x1f8)](),await this['finishRollback'](![],!![],'');}async[a361_0xe23e57(0x209)](_0x14600e,_0x1872cb,_0x57ed76){const _0x38abce=a361_0xe23e57,{id:_0x7f4372,organizationId:_0x36470b,branchId:_0x4d4d91,organizationName:_0x1d6cbc}=this[_0x38abce(0x1d2)],_0x15fd77=_0x38abce(0x1fc)+this[_0x38abce(0x20e)]+'/'+_0x7f4372+_0x38abce(0x23a)+_0x38abce(0x1f4)+_0x38abce(0x1d5),_0x26cc5c=_0x38abce(0x1fc)+this[_0x38abce(0x20e)]+'/'+_0x36470b+'\x20>'+_0x1d6cbc+'</a>',_0x57b473=_0x15fd77+'\x20of\x20branch\x20to\x20Organization\x20'+_0x26cc5c+_0x38abce(0x1cf),_0xcd11cd={[constants_1[_0x38abce(0x230)]+_0x38abce(0x20f)]:_0x57b473,[constants_1[_0x38abce(0x230)]+'Date__c']:new Date(),[constants_1[_0x38abce(0x230)]+_0x38abce(0x212)]:_0x4d4d91,[constants_1['FLOSUM_NAMESPACE']+_0x38abce(0x225)]:_0x38abce(0x1d1),[constants_1[_0x38abce(0x230)]+'Activity_Type__c']:'Deployment',[constants_1['FLOSUM_NAMESPACE']+_0x38abce(0x23c)]:_0x36470b},_0x5ec997={[constants_1[_0x38abce(0x230)]+_0x38abce(0x23f)]:!_0x14600e,[constants_1[_0x38abce(0x230)]+'Succeed__c']:_0x14600e,[constants_1['FLOSUM_NAMESPACE']+_0x38abce(0x1f6)]:_0x1872cb?status_enums_1['MetadataLogStatus'][_0x38abce(0x1e2)]:status_enums_1['MetadataLogStatus'][_0x38abce(0x1f2)],[constants_1[_0x38abce(0x230)]+'Job_Completed__c']:!![],[constants_1[_0x38abce(0x230)]+_0x38abce(0x1cd)]:_0x57ed76};await this['_connectionSalesforce']['patch'](flosum_constants_1[_0x38abce(0x1e8)][_0x38abce(0x1dd)]+'/'+constants_1[_0x38abce(0x230)]+_0x38abce(0x1f7)+this['_metadataLogId'],_0x5ec997),await this[_0x38abce(0x1de)][_0x38abce(0x20a)](flosum_constants_1[_0x38abce(0x1e8)][_0x38abce(0x1dd)]+'/'+constants_1[_0x38abce(0x230)]+'Log__c',_0xcd11cd),this['_logger'][_0x38abce(0x1f3)](_0x38abce(0x228)+(_0x14600e?'successfully':_0x38abce(0x238))+'.'),await this[_0x38abce(0x211)][_0x38abce(0x1f8)]();}async[a361_0xe23e57(0x1e5)](){const _0x2c1d16=a361_0xe23e57;try{this[_0x2c1d16(0x1d2)]=await this[_0x2c1d16(0x1f5)]();const _0x55f26f=await this[_0x2c1d16(0x1d4)]();await this[_0x2c1d16(0x211)][_0x2c1d16(0x1f8)]();const _0x64206f=await this[_0x2c1d16(0x227)](_0x55f26f),_0x302372=await this['createVpk'](_0x64206f);await this['_logger'][_0x2c1d16(0x1f8)]();const _0x45e75a=await this[_0x2c1d16(0x1c7)][_0x2c1d16(0x1db)](_0x302372);await this[_0x2c1d16(0x211)][_0x2c1d16(0x1f8)]();const _0x3c866d=this[_0x2c1d16(0x22c)](_0x45e75a[_0x2c1d16(0x245)]);await this['saveDeploymentResults'](_0x3c866d),await this['finishRollback'](_0x45e75a[_0x2c1d16(0x1fb)],![],_0x45e75a['packageId']);}catch(_0x35a290){await this[_0x2c1d16(0x1ea)](_0x35a290)[_0x2c1d16(0x1ec)](_0x37da3c=>this['_systemLogger'][_0x2c1d16(0x22e)](_0x37da3c));}}}exports['RollbackService']=RollbackService;