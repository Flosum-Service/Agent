const a393_0x23853c=a393_0x2a00;(function(_0x201d3c,_0x51273a){const _0x5371e0=a393_0x2a00,_0x1fc552=_0x201d3c();while(!![]){try{const _0x106417=-parseInt(_0x5371e0(0x1c0))/0x1*(parseInt(_0x5371e0(0x220))/0x2)+parseInt(_0x5371e0(0x226))/0x3+parseInt(_0x5371e0(0x23e))/0x4+-parseInt(_0x5371e0(0x20e))/0x5+parseInt(_0x5371e0(0x22c))/0x6*(-parseInt(_0x5371e0(0x224))/0x7)+parseInt(_0x5371e0(0x21d))/0x8*(parseInt(_0x5371e0(0x232))/0x9)+parseInt(_0x5371e0(0x241))/0xa;if(_0x106417===_0x51273a)break;else _0x1fc552['push'](_0x1fc552['shift']());}catch(_0x14185c){_0x1fc552['push'](_0x1fc552['shift']());}}}(a393_0x4fb1,0x1c010));const a393_0x6fbf6a=(function(){let _0x1472fe=!![];return function(_0x2cbaa3,_0xc53ace){const _0x1113d6=_0x1472fe?function(){const _0x297de3=a393_0x2a00;if(_0xc53ace){const _0x2d568f=_0xc53ace[_0x297de3(0x1d1)](_0x2cbaa3,arguments);return _0xc53ace=null,_0x2d568f;}}:function(){};return _0x1472fe=![],_0x1113d6;};}()),a393_0x326638=a393_0x6fbf6a(this,function(){const _0x208cb7=a393_0x2a00;return a393_0x326638[_0x208cb7(0x215)]()[_0x208cb7(0x1fa)](_0x208cb7(0x208))[_0x208cb7(0x215)]()[_0x208cb7(0x200)](a393_0x326638)[_0x208cb7(0x1fa)](_0x208cb7(0x208));});a393_0x326638();function a393_0x2a00(_0x55ff31,_0x44750f){const _0x54aee8=a393_0x4fb1();return a393_0x2a00=function(_0x326638,_0x6fbf6a){_0x326638=_0x326638-0x1ba;let _0x4fb156=_0x54aee8[_0x326638];return _0x4fb156;},a393_0x2a00(_0x55ff31,_0x44750f);}'use strict';var __importDefault=this&&this[a393_0x23853c(0x206)]||function(_0x31e1ce){return _0x31e1ce&&_0x31e1ce['__esModule']?_0x31e1ce:{'default':_0x31e1ce};};function a393_0x4fb1(){const _0x4ed6fd=['constructor','VpkService','Deployment_Result__c','\x20>\x20','retrieveBackup','text/plain','__importDefault','Form\x20Deployment\x20Results','(((.+)+)+)+$','Component_Type__c','MetadataLogDto','Save\x20Deployment\x20Results','name','COMPLETED','608535KPHmaI','Veeva\x20Rollback\x20(Deployment)','createVpk','../dtos/metadata-log.dto','FLOSUM_NAMESPACE','bind','_componentIds','toString','Logger','_tempFolder','error','retrieveDeploymentResults','length','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_packageImportService','154072cbAfJt','DEPLOYED','deploymentAction','187600qApaQk','Create\x20zip\x20from\x20backup','filter','packageId','4438aUlqMA','../../../core','481731yXKbKb','logError','SalesforceService','Body','defineProperty','type','24BOWaia','_connectionVeeva','Branch__c','Metadata_Log__c/','TargetId__c','RollbackService','9EYfcXs','./vpk.service','Metadata_Log__c','Failure','\x27\x0a\x20\x20\x20\x20','_vpkService','Status__c','fetchAttachmentsDetailsById','./package-import.service','Veeva_Step_Name__c','Type__c','insertMultipleRecords','818612EpoYNB','.zip','_parentMetadataLogId','420580JzfvFg','./veeva.service','/Attachment','organizationId','Save\x20log','Cannot\x20find\x20Backup\x20Zip','retrieveMetadataLog','_logger','shortid','writeFile','_metadataLogId','Log__c','2RUxAye','Cannot\x20find\x20Deployment\x20Results','errors','_systemLogger','finishRollbackWithError','FlosumConstants','_instanceUrl','VeevaService','_connectionSalesforce','formFlosumDeploymentResults','retrieveAttachments','flat','packageComponentList','_salesforceService','ZipCreatorRollback','log','finishRollback','apply','createZip','../classes/errors/salesforce-dml-error','../enums/status.enums','ENDPOINT_UPSERT_RECORD','/vpk__','post','Branch','Activity_Type__c','./salesforce.service','Org__c','success','stepName','../classes/retrievers/deployment-results/id.deployment-result.retriever','map','generate','Activity_Item__c','</a>','catch','Succeed__c','saveDeploymentResults','_veevaService','saveLog','<a\x20href=','Is_Error__c','External_Deployment_Id__c','BACKUP_ZIP_NAME','__esModule','\x20</a>','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Success','SalesforceDmlError','MetadataLogStatus','create','_attachmentLogId','Job_Completed__c','../constants/flosum.constants','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','_metadataLog','status','Result__c','search','Date__c','updateLog','base64','IdDeploymentResultRetriever','Action__c'];a393_0x4fb1=function(){return _0x4ed6fd;};return a393_0x4fb1();}Object[a393_0x23853c(0x22a)](exports,a393_0x23853c(0x1ec),{'value':!![]}),exports[a393_0x23853c(0x231)]=void 0x0;const veeva_service_1=require(a393_0x23853c(0x242)),salesforce_service_1=require(a393_0x23853c(0x1da)),package_import_service_1=require(a393_0x23853c(0x23a)),id_deployment_result_retriever_1=require(a393_0x23853c(0x1de)),flosum_constants_1=require(a393_0x23853c(0x1f5)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require('../../../constants'),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a393_0x23853c(0x1bc))),promises_1=require('fs/promises'),vpk_service_1=require(a393_0x23853c(0x233)),status_enums_1=require(a393_0x23853c(0x1d4)),salesforce_dml_error_1=require(a393_0x23853c(0x1d3)),metadata_log_dto_1=require(a393_0x23853c(0x211)),core_1=require(a393_0x23853c(0x225));class RollbackService{constructor({connectionSalesforce:_0x4ed52d,connectionVeeva:_0x4674b1,logger:_0x2cbaf1,tempFolder:_0x4ad2dd,instanceUrl:_0x1500c7,timeZone:_0x1bed65,metadataLogId:_0x37c6f4,attachmentLogId:_0x1aaadb,parentMetadataLogId:_0x42eb1b,componentIds:_0x2ac117}){const _0x42e0c5=a393_0x23853c;this['_connectionSalesforce']=_0x4ed52d,this[_0x42e0c5(0x22d)]=_0x4674b1,this[_0x42e0c5(0x1bb)]=_0x2cbaf1,this[_0x42e0c5(0x217)]=_0x4ad2dd,this[_0x42e0c5(0x1c6)]=_0x1500c7,this['_timeZone']=_0x1bed65,this[_0x42e0c5(0x1be)]=_0x37c6f4,this[_0x42e0c5(0x1f3)]=_0x1aaadb,this[_0x42e0c5(0x240)]=_0x42eb1b,this[_0x42e0c5(0x214)]=_0x2ac117,this[_0x42e0c5(0x1c3)]=new core_1[(_0x42e0c5(0x216))]('veeva-rollback'),this[_0x42e0c5(0x1e6)]=new veeva_service_1[(_0x42e0c5(0x1c7))]({'connection':_0x4674b1,'logger':_0x2cbaf1}),this[_0x42e0c5(0x1cd)]=new salesforce_service_1[(_0x42e0c5(0x228))]({'connection':_0x4ed52d}),this[_0x42e0c5(0x21c)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x42e0c5(0x1e6)],'connection':_0x4674b1,'logger':_0x2cbaf1,'saveLog':this[_0x42e0c5(0x1e7)][_0x42e0c5(0x213)](this)}),this['_vpkService']=new vpk_service_1[(_0x42e0c5(0x201))]({'connection':_0x4674b1});}async['saveLog'](_0x18c721,_0x1fa526){const _0x1c3bd1=a393_0x23853c;this[_0x1c3bd1(0x1bb)][_0x1c3bd1(0x1cf)](_0x1c3bd1(0x245));const _0x393f33={'Body':Buffer['from'](_0x18c721)['toString'](_0x1c3bd1(0x1fd)),'ContentType':_0x1c3bd1(0x205),'ParentId':this[_0x1c3bd1(0x1be)],'Name':_0x1fa526};await this[_0x1c3bd1(0x1c8)][_0x1c3bd1(0x1d7)](flosum_constants_1[_0x1c3bd1(0x1c5)]['ENDPOINT_UPSERT_RECORD']+_0x1c3bd1(0x243),_0x393f33);}async[a393_0x23853c(0x1ba)](){const _0x504ff0=a393_0x23853c;this[_0x504ff0(0x1bb)][_0x504ff0(0x1cf)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x459fc1]=await this[_0x504ff0(0x1cd)]['retrieveRecords'](_0x504ff0(0x1ee)+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x504ff0(0x212)]+_0x504ff0(0x21b)+constants_1[_0x504ff0(0x212)]+_0x504ff0(0x1f6)+constants_1[_0x504ff0(0x212)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this['_metadataLogId']+_0x504ff0(0x236));return new metadata_log_dto_1[(_0x504ff0(0x20a))](_0x459fc1);}async[a393_0x23853c(0x219)](){const _0x121e5a=a393_0x23853c;this[_0x121e5a(0x1bb)]['log']('Retrieve\x20Deployment\x20Results');const _0x3df858=await new id_deployment_result_retriever_1[(_0x121e5a(0x1fe))]({'salesforceService':this[_0x121e5a(0x1cd)],'value':this[_0x121e5a(0x214)]})['retrieve']();if(!_0x3df858[_0x121e5a(0x21a)])throw new Error(_0x121e5a(0x1c1));return _0x3df858;}async[a393_0x23853c(0x204)](){const _0x123be6=a393_0x23853c;this['_logger'][_0x123be6(0x1cf)]('Retrieve\x20Backup');const _0x8ed29a=await this[_0x123be6(0x1cd)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x123be6(0x240)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1['FlosumConstants'][_0x123be6(0x1eb)]+_0x123be6(0x236)),_0x220c48=await(0x0,fetch_attachments_1[_0x123be6(0x239)])(this[_0x123be6(0x1c8)],[_0x8ed29a[0x0]['Id']]),_0x174e4d=await(0x0,fetch_attachments_1[_0x123be6(0x1ca)])(_0x220c48,this[_0x123be6(0x1c8)]);if(!_0x174e4d[_0x123be6(0x21a)])throw new Error(_0x123be6(0x246));return _0x174e4d[0x0]['values'][_0x123be6(0x229)];}async[a393_0x23853c(0x1d2)](_0x3a84b1){const _0x302f0c=a393_0x23853c;this[_0x302f0c(0x1bb)][_0x302f0c(0x1cf)](_0x302f0c(0x221));const _0x32e67e=await this[_0x302f0c(0x204)](),_0x571af8=await new zip_creator_rollback_1[(_0x302f0c(0x1ce))]({'rollbackName':this[_0x302f0c(0x1f7)][_0x302f0c(0x20c)],'backup':_0x32e67e,'deploymentResults':_0x3a84b1})[_0x302f0c(0x1f2)](),_0x287818=this[_0x302f0c(0x217)]+'/'+(0x0,shortid_1['default'])()+_0x302f0c(0x23f);return await(0x0,promises_1[_0x302f0c(0x1bd)])(_0x287818,_0x571af8),_0x287818;}async['createVpk'](_0x488e35){const _0x245cf5=a393_0x23853c;this[_0x245cf5(0x1bb)][_0x245cf5(0x1cf)]('Create\x20Vpk\x20package');const _0x1ce973=await this[_0x245cf5(0x237)][_0x245cf5(0x1e0)](_0x488e35),_0x7f2c6d=this['_tempFolder']+_0x245cf5(0x1d6)+_0x488e35['slice'](_0x488e35['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x7f2c6d,_0x1ce973),await this['_vpkService']['validate'](_0x7f2c6d),_0x7f2c6d;}[a393_0x23853c(0x1c9)](_0x361cd0){const _0x39fa9a=a393_0x23853c;return this[_0x39fa9a(0x1bb)][_0x39fa9a(0x1cf)](_0x39fa9a(0x207)),_0x361cd0[_0x39fa9a(0x1df)](_0xa7adc0=>{const _0x163c13=_0x39fa9a;return this[_0x163c13(0x1bb)]['log'](_0xa7adc0[_0x163c13(0x22b)]+'.'+_0xa7adc0['name']+'\x20:\x20'+_0xa7adc0[_0x163c13(0x1f8)]),{[constants_1[_0x163c13(0x212)]+_0x163c13(0x23c)]:'Deployment\x20Result',[constants_1[_0x163c13(0x212)]+_0x163c13(0x238)]:_0xa7adc0[_0x163c13(0x1f8)]===status_enums_1['PackageComponentStatus'][_0x163c13(0x21e)]?_0x163c13(0x1ef):_0x163c13(0x235),[constants_1[_0x163c13(0x212)]+_0x163c13(0x1f9)]:_0xa7adc0[_0x163c13(0x21f)],[constants_1[_0x163c13(0x212)]+'Component_Name__c']:_0xa7adc0['name'],[constants_1[_0x163c13(0x212)]+_0x163c13(0x209)]:_0xa7adc0[_0x163c13(0x22b)],[constants_1[_0x163c13(0x212)]+_0x163c13(0x23b)]:_0xa7adc0[_0x163c13(0x1dd)],[constants_1[_0x163c13(0x212)]+_0x163c13(0x1db)]:this[_0x163c13(0x1f7)][_0x163c13(0x244)],[constants_1[_0x163c13(0x212)]+_0x163c13(0x234)]:this['_metadataLogId']};});}async[a393_0x23853c(0x1e5)](_0x586fc3){const _0xf01534=a393_0x23853c;this[_0xf01534(0x1bb)]['log'](_0xf01534(0x20b));const _0x2ab427=await this[_0xf01534(0x1cd)][_0xf01534(0x23d)](constants_1['FLOSUM_NAMESPACE']+_0xf01534(0x202),_0x586fc3),_0x5d74a0=_0x2ab427[_0xf01534(0x222)](_0x3f6a16=>!_0x3f6a16[_0xf01534(0x1dc)])[_0xf01534(0x1df)](_0x54df44=>_0x54df44[_0xf01534(0x1c2)])[_0xf01534(0x1cb)]();if(_0x5d74a0[_0xf01534(0x21a)])throw new salesforce_dml_error_1[(_0xf01534(0x1f0))](_0x5d74a0);}async[a393_0x23853c(0x1c4)](_0x2f4683){const _0x2d92bf=a393_0x23853c;if(!this[_0x2d92bf(0x1f7)]){this[_0x2d92bf(0x1c3)]['error'](_0x2f4683);return;}this[_0x2d92bf(0x1bb)][_0x2d92bf(0x227)](_0x2f4683),await this[_0x2d92bf(0x1bb)][_0x2d92bf(0x1fc)](),await this[_0x2d92bf(0x1d0)](![],!![],'');}async['finishRollback'](_0x1cf602,_0xcd3abe,_0x50e6cf){const _0x329af9=a393_0x23853c,{id:_0x2a3ae0,organizationId:_0x407085,branchId:_0x5506c3,organizationName:_0x3cd32b}=this['_metadataLog'],_0xc023eb='<a\x20href='+this[_0x329af9(0x1c6)]+'/'+_0x2a3ae0+_0x329af9(0x203)+_0x329af9(0x20f)+_0x329af9(0x1ed),_0x36c9b2=_0x329af9(0x1e8)+this[_0x329af9(0x1c6)]+'/'+_0x407085+'\x20>'+_0x3cd32b+_0x329af9(0x1e2),_0x49cd4a=_0xc023eb+'\x20of\x20branch\x20to\x20Organization\x20'+_0x36c9b2+'\x20has\x20been\x20created.',_0x428782={[constants_1['FLOSUM_NAMESPACE']+_0x329af9(0x1ff)]:_0x49cd4a,[constants_1[_0x329af9(0x212)]+_0x329af9(0x1fb)]:new Date(),[constants_1[_0x329af9(0x212)]+_0x329af9(0x22e)]:_0x5506c3,[constants_1[_0x329af9(0x212)]+_0x329af9(0x1e1)]:_0x329af9(0x1d8),[constants_1['FLOSUM_NAMESPACE']+_0x329af9(0x1d9)]:'Deployment',[constants_1['FLOSUM_NAMESPACE']+_0x329af9(0x230)]:_0x407085},_0x7e4e6f={[constants_1[_0x329af9(0x212)]+_0x329af9(0x1e9)]:!_0x1cf602,[constants_1[_0x329af9(0x212)]+_0x329af9(0x1e4)]:_0x1cf602,[constants_1[_0x329af9(0x212)]+_0x329af9(0x238)]:_0xcd3abe?status_enums_1[_0x329af9(0x1f1)]['EXCEPTION']:status_enums_1[_0x329af9(0x1f1)][_0x329af9(0x20d)],[constants_1['FLOSUM_NAMESPACE']+_0x329af9(0x1f4)]:!![],[constants_1[_0x329af9(0x212)]+_0x329af9(0x1ea)]:_0x50e6cf};await this[_0x329af9(0x1c8)]['patch'](flosum_constants_1[_0x329af9(0x1c5)][_0x329af9(0x1d5)]+'/'+constants_1[_0x329af9(0x212)]+_0x329af9(0x22f)+this['_metadataLogId'],_0x7e4e6f),await this[_0x329af9(0x1c8)][_0x329af9(0x1d7)](flosum_constants_1[_0x329af9(0x1c5)][_0x329af9(0x1d5)]+'/'+constants_1[_0x329af9(0x212)]+_0x329af9(0x1bf),_0x428782),this[_0x329af9(0x1bb)][_0x329af9(0x1cf)]('Rollback\x20completed\x20'+(_0x1cf602?'successfully':'with\x20error')+'.'),await this[_0x329af9(0x1bb)][_0x329af9(0x1fc)]();}async['execute'](){const _0x99220c=a393_0x23853c;try{this[_0x99220c(0x1f7)]=await this['retrieveMetadataLog']();const _0x1a3ae4=await this[_0x99220c(0x219)]();await this[_0x99220c(0x1bb)][_0x99220c(0x1fc)]();const _0x4b0d41=await this[_0x99220c(0x1d2)](_0x1a3ae4),_0x1a65d3=await this[_0x99220c(0x210)](_0x4b0d41);await this[_0x99220c(0x1bb)][_0x99220c(0x1fc)]();const _0x33fc8e=await this[_0x99220c(0x21c)]['import'](_0x1a65d3);await this[_0x99220c(0x1bb)][_0x99220c(0x1fc)]();const _0x203868=this[_0x99220c(0x1c9)](_0x33fc8e[_0x99220c(0x1cc)]);await this[_0x99220c(0x1e5)](_0x203868),await this['finishRollback'](_0x33fc8e['isDeployed'],![],_0x33fc8e[_0x99220c(0x223)]);}catch(_0x2c71f3){await this[_0x99220c(0x1c4)](_0x2c71f3)[_0x99220c(0x1e3)](_0x39270b=>this[_0x99220c(0x1c3)][_0x99220c(0x218)](_0x39270b));}}}exports[a393_0x23853c(0x231)]=RollbackService;