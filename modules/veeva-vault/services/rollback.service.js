const a361_0x450bf9=a361_0x3a87;(function(_0x4b595e,_0x2ab928){const _0x58d345=a361_0x3a87,_0x4c5712=_0x4b595e();while(!![]){try{const _0x3562d9=parseInt(_0x58d345(0x14b))/0x1*(-parseInt(_0x58d345(0x194))/0x2)+-parseInt(_0x58d345(0x16d))/0x3*(-parseInt(_0x58d345(0x1b2))/0x4)+parseInt(_0x58d345(0x199))/0x5*(-parseInt(_0x58d345(0x191))/0x6)+-parseInt(_0x58d345(0x136))/0x7+-parseInt(_0x58d345(0x1bb))/0x8*(parseInt(_0x58d345(0x15f))/0x9)+parseInt(_0x58d345(0x183))/0xa*(parseInt(_0x58d345(0x160))/0xb)+-parseInt(_0x58d345(0x15c))/0xc*(-parseInt(_0x58d345(0x1af))/0xd);if(_0x3562d9===_0x2ab928)break;else _0x4c5712['push'](_0x4c5712['shift']());}catch(_0x236444){_0x4c5712['push'](_0x4c5712['shift']());}}}(a361_0x1d44,0xbe950));const a361_0x396905=(function(){let _0x4c6a9b=!![];return function(_0x106a37,_0x140501){const _0x5203b9=_0x4c6a9b?function(){if(_0x140501){const _0x136832=_0x140501['apply'](_0x106a37,arguments);return _0x140501=null,_0x136832;}}:function(){};return _0x4c6a9b=![],_0x5203b9;};}()),a361_0x38f846=a361_0x396905(this,function(){const _0xe0913=a361_0x3a87;return a361_0x38f846[_0xe0913(0x1bc)]()['search'](_0xe0913(0x1b7))[_0xe0913(0x1bc)]()[_0xe0913(0x179)](a361_0x38f846)['search']('(((.+)+)+)+$');});function a361_0x3a87(_0x562d7d,_0x14c732){const _0x50493e=a361_0x1d44();return a361_0x3a87=function(_0x38f846,_0x396905){_0x38f846=_0x38f846-0x12d;let _0x1d441f=_0x50493e[_0x38f846];return _0x1d441f;},a361_0x3a87(_0x562d7d,_0x14c732);}a361_0x38f846();'use strict';var __importDefault=this&&this[a361_0x450bf9(0x1a7)]||function(_0x5495cd){const _0x36455b=a361_0x450bf9;return _0x5495cd&&_0x5495cd[_0x36455b(0x13a)]?_0x5495cd:{'default':_0x5495cd};};Object['defineProperty'](exports,a361_0x450bf9(0x13a),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a361_0x450bf9(0x180)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a361_0x450bf9(0x152)),id_deployment_result_retriever_1=require(a361_0x450bf9(0x132)),flosum_constants_1=require(a361_0x450bf9(0x19b)),fetch_attachments_1=require(a361_0x450bf9(0x18d)),constants_1=require(a361_0x450bf9(0x176)),zip_creator_rollback_1=require(a361_0x450bf9(0x1a5)),shortid_1=__importDefault(require('shortid')),promises_1=require(a361_0x450bf9(0x18c)),vpk_service_1=require(a361_0x450bf9(0x17f)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a361_0x450bf9(0x150)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x4ecb56,connectionVeeva:_0x36c5eb,logger:_0x59735a,tempFolder:_0x13cc51,instanceUrl:_0x548121,timeZone:_0x54d9a6,metadataLogId:_0x4922dc,attachmentLogId:_0x55e452,parentMetadataLogId:_0x1cad22,componentIds:_0x3d2aba}){const _0x26cd1d=a361_0x450bf9;this[_0x26cd1d(0x1c0)]=_0x4ecb56,this[_0x26cd1d(0x162)]=_0x36c5eb,this[_0x26cd1d(0x16a)]=_0x59735a,this[_0x26cd1d(0x178)]=_0x13cc51,this[_0x26cd1d(0x18f)]=_0x548121,this[_0x26cd1d(0x166)]=_0x54d9a6,this[_0x26cd1d(0x1be)]=_0x4922dc,this[_0x26cd1d(0x16f)]=_0x55e452,this['_parentMetadataLogId']=_0x1cad22,this[_0x26cd1d(0x158)]=_0x3d2aba,this[_0x26cd1d(0x15d)]=new core_1['Logger'](_0x26cd1d(0x1a9)),this[_0x26cd1d(0x18a)]=new veeva_service_1[(_0x26cd1d(0x19e))]({'connection':_0x36c5eb,'logger':_0x59735a}),this[_0x26cd1d(0x17a)]=new salesforce_service_1[(_0x26cd1d(0x130))]({'connection':_0x4ecb56}),this['_packageImportService']=new package_import_service_1[(_0x26cd1d(0x17c))]({'veevaService':this[_0x26cd1d(0x18a)],'connection':_0x36c5eb,'logger':_0x59735a,'saveLog':this[_0x26cd1d(0x196)][_0x26cd1d(0x170)](this)}),this['_vpkService']=new vpk_service_1['VpkService']({'connection':_0x36c5eb});}async[a361_0x450bf9(0x196)](_0x26d6de,_0x48c338){const _0x1da9fe=a361_0x450bf9;this[_0x1da9fe(0x16a)]['log'](_0x1da9fe(0x15b));const _0x21ee20={'Body':Buffer[_0x1da9fe(0x188)](_0x26d6de)['toString'](_0x1da9fe(0x154)),'ContentType':'text/plain','ParentId':this[_0x1da9fe(0x1be)],'Name':_0x48c338};await this[_0x1da9fe(0x1c0)][_0x1da9fe(0x165)](flosum_constants_1['FlosumConstants'][_0x1da9fe(0x1ae)]+_0x1da9fe(0x17e),_0x21ee20);}async['retrieveMetadataLog'](){const _0x553400=a361_0x450bf9;this[_0x553400(0x16a)][_0x553400(0x187)](_0x553400(0x156));const [_0x41f71e]=await this[_0x553400(0x17a)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x553400(0x1b9)]+_0x553400(0x15e)+constants_1['FLOSUM_NAMESPACE']+_0x553400(0x1a4)+constants_1[_0x553400(0x1b9)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this['_metadataLogId']+_0x553400(0x177));return new metadata_log_dto_1[(_0x553400(0x12e))](_0x41f71e);}async[a361_0x450bf9(0x15a)](){const _0x204520=a361_0x450bf9;this['_logger'][_0x204520(0x187)](_0x204520(0x149));const _0x4df307=await new id_deployment_result_retriever_1[(_0x204520(0x145))]({'salesforceService':this[_0x204520(0x17a)],'value':this[_0x204520(0x158)]})['retrieve']();if(!_0x4df307[_0x204520(0x1b0)])throw new Error(_0x204520(0x16c));return _0x4df307;}async['retrieveBackup'](){const _0x2c4bdd=a361_0x450bf9;this['_logger'][_0x2c4bdd(0x187)](_0x2c4bdd(0x1b3));const _0x2b1328=await this[_0x2c4bdd(0x17a)]['retrieveRecords'](_0x2c4bdd(0x172)+this[_0x2c4bdd(0x174)]+_0x2c4bdd(0x1b8)+flosum_constants_1[_0x2c4bdd(0x181)][_0x2c4bdd(0x14c)]+_0x2c4bdd(0x177)),_0xad6f09=await(0x0,fetch_attachments_1[_0x2c4bdd(0x190)])(this[_0x2c4bdd(0x1c0)],[_0x2b1328[0x0]['Id']]),_0x306490=await(0x0,fetch_attachments_1[_0x2c4bdd(0x1a1)])(_0xad6f09,this['_connectionSalesforce']);if(!_0x306490[_0x2c4bdd(0x1b0)])throw new Error(_0x2c4bdd(0x1ad));return _0x306490[0x0][_0x2c4bdd(0x1a6)][_0x2c4bdd(0x18b)];}async[a361_0x450bf9(0x133)](_0x366a42){const _0x5882a5=a361_0x450bf9;this[_0x5882a5(0x16a)][_0x5882a5(0x187)](_0x5882a5(0x139));const _0x358e73=await this[_0x5882a5(0x161)](),_0x2046ed=await new zip_creator_rollback_1[(_0x5882a5(0x189))]({'rollbackName':this[_0x5882a5(0x167)][_0x5882a5(0x1bd)],'backup':_0x358e73,'deploymentResults':_0x366a42})[_0x5882a5(0x153)](),_0x29d782=this[_0x5882a5(0x178)]+'/'+(0x0,shortid_1[_0x5882a5(0x182)])()+_0x5882a5(0x151);return await(0x0,promises_1[_0x5882a5(0x175)])(_0x29d782,_0x2046ed),_0x29d782;}async['createVpk'](_0xa2cdd0){const _0x45386c=a361_0x450bf9;this[_0x45386c(0x16a)][_0x45386c(0x187)](_0x45386c(0x13d));const _0x3cd03b=await this[_0x45386c(0x144)][_0x45386c(0x17b)](_0xa2cdd0),_0x3bd467=this['_tempFolder']+_0x45386c(0x1ab)+_0xa2cdd0[_0x45386c(0x146)](_0xa2cdd0[_0x45386c(0x185)]('/')+0x1);return await(0x0,promises_1[_0x45386c(0x175)])(_0x3bd467,_0x3cd03b),await this['_vpkService'][_0x45386c(0x13b)](_0x3bd467),_0x3bd467;}[a361_0x450bf9(0x173)](_0x312133){const _0x1893b6=a361_0x450bf9;return this[_0x1893b6(0x16a)][_0x1893b6(0x187)](_0x1893b6(0x193)),_0x312133[_0x1893b6(0x1aa)](_0x3cd954=>{const _0x4d6a5f=_0x1893b6;return this[_0x4d6a5f(0x16a)][_0x4d6a5f(0x187)](_0x3cd954[_0x4d6a5f(0x13c)]+'.'+_0x3cd954[_0x4d6a5f(0x1bd)]+_0x4d6a5f(0x19f)+_0x3cd954[_0x4d6a5f(0x1b6)]),{[constants_1[_0x4d6a5f(0x1b9)]+'Type__c']:_0x4d6a5f(0x1a2),[constants_1[_0x4d6a5f(0x1b9)]+_0x4d6a5f(0x13e)]:_0x3cd954[_0x4d6a5f(0x1b6)]===status_enums_1[_0x4d6a5f(0x140)]['DEPLOYED']?_0x4d6a5f(0x169):_0x4d6a5f(0x14a),[constants_1[_0x4d6a5f(0x1b9)]+'Result__c']:_0x3cd954['deploymentAction'],[constants_1['FLOSUM_NAMESPACE']+_0x4d6a5f(0x14e)]:_0x3cd954['name'],[constants_1[_0x4d6a5f(0x1b9)]+_0x4d6a5f(0x19a)]:_0x3cd954[_0x4d6a5f(0x13c)],[constants_1['FLOSUM_NAMESPACE']+_0x4d6a5f(0x1a3)]:_0x3cd954[_0x4d6a5f(0x135)],[constants_1[_0x4d6a5f(0x1b9)]+_0x4d6a5f(0x147)]:this[_0x4d6a5f(0x167)]['organizationId'],[constants_1[_0x4d6a5f(0x1b9)]+_0x4d6a5f(0x137)]:this[_0x4d6a5f(0x1be)]};});}async[a361_0x450bf9(0x1b1)](_0x32e06d){const _0x129109=a361_0x450bf9;this[_0x129109(0x16a)][_0x129109(0x187)]('Save\x20Deployment\x20Results');const _0x85ce0e=await this[_0x129109(0x17a)][_0x129109(0x195)](constants_1['FLOSUM_NAMESPACE']+_0x129109(0x171),_0x32e06d),_0x380a4f=_0x85ce0e[_0x129109(0x13f)](_0x2ed4ff=>!_0x2ed4ff[_0x129109(0x184)])[_0x129109(0x1aa)](_0x33dd68=>_0x33dd68[_0x129109(0x138)])['flat']();if(_0x380a4f[_0x129109(0x1b0)])throw new salesforce_dml_error_1[(_0x129109(0x163))](_0x380a4f);}async[a361_0x450bf9(0x164)](_0x76c35d){const _0x4b9690=a361_0x450bf9;if(!this[_0x4b9690(0x167)]){this['_systemLogger'][_0x4b9690(0x1b4)](_0x76c35d);return;}this[_0x4b9690(0x16a)]['logError'](_0x76c35d),await this['_logger'][_0x4b9690(0x14f)](),await this['finishRollback'](![],!![],'');}async[a361_0x450bf9(0x157)](_0x133922,_0x2cfec5,_0x4cdb63){const _0x3a6aea=a361_0x450bf9,{id:_0x32b174,organizationId:_0x599420,branchId:_0x3eea45,organizationName:_0x1bbc58}=this[_0x3a6aea(0x167)],_0x55be36='<a\x20href='+this['_instanceUrl']+'/'+_0x32b174+_0x3a6aea(0x14d)+_0x3a6aea(0x134)+_0x3a6aea(0x142),_0x332dfb='<a\x20href='+this[_0x3a6aea(0x18f)]+'/'+_0x599420+'\x20>'+_0x1bbc58+_0x3a6aea(0x159),_0x40ed64=_0x55be36+'\x20of\x20branch\x20to\x20Organization\x20'+_0x332dfb+_0x3a6aea(0x186),_0x170ee4={[constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x18e)]:_0x40ed64,[constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x19c)]:new Date(),[constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x12f)]:_0x3eea45,[constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x12d)]:'Branch',[constants_1[_0x3a6aea(0x1b9)]+'Activity_Type__c']:'Deployment',[constants_1['FLOSUM_NAMESPACE']+_0x3a6aea(0x1ba)]:_0x599420},_0x24ee3c={[constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x198)]:!_0x133922,[constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x19d)]:_0x133922,[constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x13e)]:_0x2cfec5?status_enums_1[_0x3a6aea(0x1bf)][_0x3a6aea(0x1a8)]:status_enums_1[_0x3a6aea(0x1bf)][_0x3a6aea(0x1a0)],[constants_1[_0x3a6aea(0x1b9)]+'Job_Completed__c']:!![],[constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x197)]:_0x4cdb63};await this['_connectionSalesforce'][_0x3a6aea(0x168)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x16e)+this[_0x3a6aea(0x1be)],_0x24ee3c),await this[_0x3a6aea(0x1c0)][_0x3a6aea(0x165)](flosum_constants_1[_0x3a6aea(0x181)][_0x3a6aea(0x1ae)]+'/'+constants_1[_0x3a6aea(0x1b9)]+_0x3a6aea(0x155),_0x170ee4),this[_0x3a6aea(0x16a)][_0x3a6aea(0x187)](_0x3a6aea(0x148)+(_0x133922?_0x3a6aea(0x1ac):'with\x20error')+'.'),await this[_0x3a6aea(0x16a)]['updateLog']();}async['execute'](){const _0x1c75cd=a361_0x450bf9;try{this[_0x1c75cd(0x167)]=await this[_0x1c75cd(0x192)]();const _0x94b97e=await this['retrieveDeploymentResults']();await this[_0x1c75cd(0x16a)][_0x1c75cd(0x14f)]();const _0x33bacc=await this[_0x1c75cd(0x133)](_0x94b97e),_0x4ff9a9=await this['createVpk'](_0x33bacc);await this[_0x1c75cd(0x16a)][_0x1c75cd(0x14f)]();const _0x3dfa06=await this[_0x1c75cd(0x143)][_0x1c75cd(0x17d)](_0x4ff9a9);await this[_0x1c75cd(0x16a)]['updateLog']();const _0x40d729=this[_0x1c75cd(0x173)](_0x3dfa06[_0x1c75cd(0x16b)]);await this[_0x1c75cd(0x1b1)](_0x40d729),await this[_0x1c75cd(0x157)](_0x3dfa06[_0x1c75cd(0x131)],![],_0x3dfa06[_0x1c75cd(0x1b5)]);}catch(_0x99f2e5){await this[_0x1c75cd(0x164)](_0x99f2e5)[_0x1c75cd(0x141)](_0x3cd0e7=>this[_0x1c75cd(0x15d)][_0x1c75cd(0x1b4)](_0x3cd0e7));}}}function a361_0x1d44(){const _0x353e51=['\x27\x20AND\x20Name\x20=\x20\x27','FLOSUM_NAMESPACE','TargetId__c','32aAFnVB','toString','name','_metadataLogId','MetadataLogStatus','_connectionSalesforce','Activity_Item__c','MetadataLogDto','Branch__c','SalesforceService','isDeployed','../classes/retrievers/deployment-results/id.deployment-result.retriever','createZip','Veeva\x20Rollback\x20(Deployment)','stepName','6776672ffPZGz','Metadata_Log__c','errors','Create\x20zip\x20from\x20backup','__esModule','validate','type','Create\x20Vpk\x20package','Status__c','filter','PackageComponentStatus','catch','\x20</a>','_packageImportService','_vpkService','IdDeploymentResultRetriever','slice','Org__c','Rollback\x20completed\x20','Retrieve\x20Deployment\x20Results','Failure','1178ybJXnt','BACKUP_ZIP_NAME','\x20>\x20','Component_Name__c','updateLog','../dtos/metadata-log.dto','.zip','./package-import.service','create','base64','Log__c','Retrieve\x20Metadata\x20Log\x20info','finishRollback','_componentIds','</a>','retrieveDeploymentResults','Save\x20log','540leYLRn','_systemLogger','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','2874780eWYbNp','11ABWWSv','retrieveBackup','_connectionVeeva','SalesforceDmlError','finishRollbackWithError','post','_timeZone','_metadataLog','patch','Success','_logger','packageComponentList','Cannot\x20find\x20Deployment\x20Results','33099LQjaVx','Metadata_Log__c/','_attachmentLogId','bind','Deployment_Result__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','formFlosumDeploymentResults','_parentMetadataLogId','writeFile','../../../constants','\x27\x0a\x20\x20\x20\x20','_tempFolder','constructor','_salesforceService','generate','PackageImportService','import','/Attachment','./vpk.service','./veeva.service','FlosumConstants','default','5362750jKDqLJ','success','lastIndexOf','\x20has\x20been\x20created.','log','from','ZipCreatorRollback','_veevaService','Body','fs/promises','../../shared/utils/fetch-attachments','Action__c','_instanceUrl','fetchAttachmentsDetailsById','163110XzMItK','retrieveMetadataLog','Form\x20Deployment\x20Results','1486UkiBJq','insertMultipleRecords','saveLog','External_Deployment_Id__c','Is_Error__c','115GxPjyg','Component_Type__c','../constants/flosum.constants','Date__c','Succeed__c','VeevaService','\x20:\x20','COMPLETED','retrieveAttachments','Deployment\x20Result','Veeva_Step_Name__c','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','../classes/rollback/zip-creator.rollback','values','__importDefault','EXCEPTION','veeva-rollback','map','/vpk__','successfully','Cannot\x20find\x20Backup\x20Zip','ENDPOINT_UPSERT_RECORD','888303ywDZBp','length','saveDeploymentResults','332SHbZQm','Retrieve\x20Backup','error','packageId','status','(((.+)+)+)+$'];a361_0x1d44=function(){return _0x353e51;};return a361_0x1d44();}exports['RollbackService']=RollbackService;