const a404_0xf7c4a9=a404_0x3c0f;(function(_0x51d1f3,_0x3014c0){const _0x3a98f3=a404_0x3c0f,_0x2f7fd3=_0x51d1f3();while(!![]){try{const _0x4353d3=-parseInt(_0x3a98f3(0x1a6))/0x1*(-parseInt(_0x3a98f3(0x149))/0x2)+parseInt(_0x3a98f3(0x180))/0x3*(-parseInt(_0x3a98f3(0x157))/0x4)+parseInt(_0x3a98f3(0x140))/0x5*(-parseInt(_0x3a98f3(0x13b))/0x6)+-parseInt(_0x3a98f3(0x1b3))/0x7*(-parseInt(_0x3a98f3(0x18d))/0x8)+parseInt(_0x3a98f3(0x142))/0x9*(parseInt(_0x3a98f3(0x16f))/0xa)+parseInt(_0x3a98f3(0x186))/0xb+-parseInt(_0x3a98f3(0x164))/0xc;if(_0x4353d3===_0x3014c0)break;else _0x2f7fd3['push'](_0x2f7fd3['shift']());}catch(_0x529437){_0x2f7fd3['push'](_0x2f7fd3['shift']());}}}(a404_0x3a05,0x9cfb5));const a404_0x3e7c55=(function(){let _0xb018=!![];return function(_0xbc7272,_0xae271){const _0x525ef9=_0xb018?function(){const _0x5af4a9=a404_0x3c0f;if(_0xae271){const _0x382db2=_0xae271[_0x5af4a9(0x13f)](_0xbc7272,arguments);return _0xae271=null,_0x382db2;}}:function(){};return _0xb018=![],_0x525ef9;};}()),a404_0x5dcf8f=a404_0x3e7c55(this,function(){const _0x1636ea=a404_0x3c0f;return a404_0x5dcf8f['toString']()[_0x1636ea(0x1c0)](_0x1636ea(0x17c))[_0x1636ea(0x15f)]()[_0x1636ea(0x190)](a404_0x5dcf8f)[_0x1636ea(0x1c0)](_0x1636ea(0x17c));});a404_0x5dcf8f();'use strict';var __importDefault=this&&this[a404_0xf7c4a9(0x16c)]||function(_0x554ac9){const _0x4874e7=a404_0xf7c4a9;return _0x554ac9&&_0x554ac9[_0x4874e7(0x156)]?_0x554ac9:{'default':_0x554ac9};};Object['defineProperty'](exports,a404_0xf7c4a9(0x156),{'value':!![]}),exports['RollbackService']=void 0x0;function a404_0x3c0f(_0x40e6fa,_0x3b13d7){const _0x52f23c=a404_0x3a05();return a404_0x3c0f=function(_0x5dcf8f,_0x3e7c55){_0x5dcf8f=_0x5dcf8f-0x12e;let _0x3a0509=_0x52f23c[_0x5dcf8f];return _0x3a0509;},a404_0x3c0f(_0x40e6fa,_0x3b13d7);}function a404_0x3a05(){const _0x33a4d9=['_componentIds','RollbackService','_timeZone','Veeva\x20Rollback\x20(Deployment)','saveLog','Metadata_Log__c/','Create\x20Vpk\x20package','Success','EXCEPTION','map','execute','veeva-rollback','5899qnvjnD','text/plain','isDeployed','Failure','Cannot\x20find\x20Backup\x20Zip','_metadataLog','ZipCreatorRollback','values','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','BACKUP_ZIP_NAME','_veevaService','Org__c','Component_Type__c','410613nyEfRG','Is_Error__c','_instanceUrl','/vpk__','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Form\x20Deployment\x20Results','DEPLOYED','<a\x20href=','finishRollbackWithError','_salesforceService','\x27\x20AND\x20Name\x20=\x20\x27','retrieveBackup','Save\x20log','search','VpkService','Log__c','fetchAttachmentsDetailsById','Job_Completed__c','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_vpkService','./package-import.service','./salesforce.service','retrieve','.zip','_connectionSalesforce','retrieveRecords','\x20:\x20','Rollback\x20completed\x20','16938DYgmNI','_systemLogger','success','</a>','apply','1270lVcTDT','packageId','46071RADWIl','createVpk','fs/promises','status','_packageImportService','../classes/retrievers/deployment-results/id.deployment-result.retriever','Veeva_Step_Name__c','142FhLuby','_metadataLogId','Create\x20zip\x20from\x20backup','Deployment','retrieveDeploymentResults','from','validate','_parentMetadataLogId','generate','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','errors','_connectionVeeva','Activity_Item__c','__esModule','368CDDTWF','../../shared/utils/fetch-attachments','MetadataLogStatus','Cannot\x20find\x20Deployment\x20Results','_attachmentLogId','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','successfully','Branch__c','toString','retrieveMetadataLog','patch','FLOSUM_NAMESPACE','../../../core','12057360wKSPIo','type','formFlosumDeploymentResults','length','finishRollback','\x20</a>','../../../constants','\x20of\x20branch\x20to\x20Organization\x20','__importDefault','Action__c','saveDeploymentResults','2040isEbdU','post','writeFile','log','TargetId__c','../classes/rollback/zip-creator.rollback','_logger','deploymentAction','PackageImportService','Type__c','slice','SalesforceService','Retrieve\x20Metadata\x20Log\x20info','(((.+)+)+)+$','name','_tempFolder','../classes/errors/salesforce-dml-error','11724MzeBnY','updateLog','base64','Body','insertMultipleRecords','FlosumConstants','11938003PyYZme','Metadata_Log__c','\x20>\x20','catch','Retrieve\x20Deployment\x20Results','bind','flat','24jHWJvO','shortid','Save\x20Deployment\x20Results','constructor','\x20has\x20been\x20created.','with\x20error','VeevaService','../enums/status.enums','Succeed__c','import','Branch','ENDPOINT_UPSERT_RECORD','\x27\x0a\x20\x20\x20\x20'];a404_0x3a05=function(){return _0x33a4d9;};return a404_0x3a05();}const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a404_0xf7c4a9(0x134)),package_import_service_1=require(a404_0xf7c4a9(0x133)),id_deployment_result_retriever_1=require(a404_0xf7c4a9(0x147)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a404_0xf7c4a9(0x158)),constants_1=require(a404_0xf7c4a9(0x16a)),zip_creator_rollback_1=require(a404_0xf7c4a9(0x174)),shortid_1=__importDefault(require(a404_0xf7c4a9(0x18e))),promises_1=require(a404_0xf7c4a9(0x144)),vpk_service_1=require('./vpk.service'),status_enums_1=require(a404_0xf7c4a9(0x194)),salesforce_dml_error_1=require(a404_0xf7c4a9(0x17f)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a404_0xf7c4a9(0x163));class RollbackService{constructor({connectionSalesforce:_0x3c710b,connectionVeeva:_0x24963d,logger:_0x4c8118,tempFolder:_0x2a5dae,instanceUrl:_0xcc1476,timeZone:_0x4fcf80,metadataLogId:_0x13000a,attachmentLogId:_0x2bb73d,parentMetadataLogId:_0x8ce149,componentIds:_0x50f37e}){const _0xf664c1=a404_0xf7c4a9;this[_0xf664c1(0x137)]=_0x3c710b,this[_0xf664c1(0x154)]=_0x24963d,this[_0xf664c1(0x175)]=_0x4c8118,this[_0xf664c1(0x17e)]=_0x2a5dae,this[_0xf664c1(0x1b5)]=_0xcc1476,this[_0xf664c1(0x19c)]=_0x4fcf80,this[_0xf664c1(0x14a)]=_0x13000a,this[_0xf664c1(0x15b)]=_0x2bb73d,this[_0xf664c1(0x150)]=_0x8ce149,this[_0xf664c1(0x19a)]=_0x50f37e,this[_0xf664c1(0x13c)]=new core_1['Logger'](_0xf664c1(0x1a5)),this[_0xf664c1(0x1b0)]=new veeva_service_1[(_0xf664c1(0x193))]({'connection':_0x24963d,'logger':_0x4c8118}),this[_0xf664c1(0x1bc)]=new salesforce_service_1[(_0xf664c1(0x17a))]({'connection':_0x3c710b}),this['_packageImportService']=new package_import_service_1[(_0xf664c1(0x177))]({'veevaService':this['_veevaService'],'connection':_0x24963d,'logger':_0x4c8118,'saveLog':this[_0xf664c1(0x19e)][_0xf664c1(0x18b)](this)}),this[_0xf664c1(0x132)]=new vpk_service_1[(_0xf664c1(0x1c1))]({'connection':_0x24963d});}async[a404_0xf7c4a9(0x19e)](_0x38b1e8,_0x3743df){const _0x5ce79=a404_0xf7c4a9;this[_0x5ce79(0x175)][_0x5ce79(0x172)](_0x5ce79(0x1bf));const _0x5017b8={'Body':Buffer[_0x5ce79(0x14e)](_0x38b1e8)[_0x5ce79(0x15f)](_0x5ce79(0x182)),'ContentType':_0x5ce79(0x1a7),'ParentId':this[_0x5ce79(0x14a)],'Name':_0x3743df};await this[_0x5ce79(0x137)][_0x5ce79(0x170)](flosum_constants_1[_0x5ce79(0x185)]['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x5017b8);}async[a404_0xf7c4a9(0x160)](){const _0x2dfe47=a404_0xf7c4a9;this[_0x2dfe47(0x175)][_0x2dfe47(0x172)](_0x2dfe47(0x17b));const [_0x45cc1a]=await this['_salesforceService'][_0x2dfe47(0x138)](_0x2dfe47(0x1ae)+constants_1[_0x2dfe47(0x162)]+_0x2dfe47(0x15c)+constants_1['FLOSUM_NAMESPACE']+_0x2dfe47(0x131)+constants_1[_0x2dfe47(0x162)]+_0x2dfe47(0x1b7)+constants_1[_0x2dfe47(0x162)]+_0x2dfe47(0x152)+this['_metadataLogId']+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1['MetadataLogDto'](_0x45cc1a);}async['retrieveDeploymentResults'](){const _0x44133a=a404_0xf7c4a9;this[_0x44133a(0x175)]['log'](_0x44133a(0x18a));const _0x597419=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x44133a(0x1bc)],'value':this['_componentIds']})[_0x44133a(0x135)]();if(!_0x597419[_0x44133a(0x167)])throw new Error(_0x44133a(0x15a));return _0x597419;}async[a404_0xf7c4a9(0x1be)](){const _0x19d407=a404_0xf7c4a9;this[_0x19d407(0x175)][_0x19d407(0x172)]('Retrieve\x20Backup');const _0x41f068=await this['_salesforceService'][_0x19d407(0x138)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x19d407(0x150)]+_0x19d407(0x1bd)+flosum_constants_1['FlosumConstants'][_0x19d407(0x1af)]+_0x19d407(0x199)),_0x2c9173=await(0x0,fetch_attachments_1[_0x19d407(0x12f)])(this['_connectionSalesforce'],[_0x41f068[0x0]['Id']]),_0x302a29=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x2c9173,this[_0x19d407(0x137)]);if(!_0x302a29[_0x19d407(0x167)])throw new Error(_0x19d407(0x1aa));return _0x302a29[0x0][_0x19d407(0x1ad)][_0x19d407(0x183)];}async['createZip'](_0x1f6148){const _0xca3b23=a404_0xf7c4a9;this[_0xca3b23(0x175)][_0xca3b23(0x172)](_0xca3b23(0x14b));const _0x46298f=await this[_0xca3b23(0x1be)](),_0x2f153b=await new zip_creator_rollback_1[(_0xca3b23(0x1ac))]({'rollbackName':this[_0xca3b23(0x1ab)][_0xca3b23(0x17d)],'backup':_0x46298f,'deploymentResults':_0x1f6148})['create'](),_0x3027cb=this[_0xca3b23(0x17e)]+'/'+(0x0,shortid_1['default'])()+_0xca3b23(0x136);return await(0x0,promises_1[_0xca3b23(0x171)])(_0x3027cb,_0x2f153b),_0x3027cb;}async[a404_0xf7c4a9(0x143)](_0x27abed){const _0x3fafd4=a404_0xf7c4a9;this[_0x3fafd4(0x175)][_0x3fafd4(0x172)](_0x3fafd4(0x1a0));const _0x38c004=await this['_vpkService'][_0x3fafd4(0x151)](_0x27abed),_0x34bf64=this[_0x3fafd4(0x17e)]+_0x3fafd4(0x1b6)+_0x27abed[_0x3fafd4(0x179)](_0x27abed['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x3fafd4(0x171)])(_0x34bf64,_0x38c004),await this[_0x3fafd4(0x132)][_0x3fafd4(0x14f)](_0x34bf64),_0x34bf64;}['formFlosumDeploymentResults'](_0x487539){const _0x8daa76=a404_0xf7c4a9;return this[_0x8daa76(0x175)][_0x8daa76(0x172)](_0x8daa76(0x1b8)),_0x487539[_0x8daa76(0x1a3)](_0x2aac0c=>{const _0x13403f=_0x8daa76;return this[_0x13403f(0x175)][_0x13403f(0x172)](_0x2aac0c['type']+'.'+_0x2aac0c[_0x13403f(0x17d)]+_0x13403f(0x139)+_0x2aac0c[_0x13403f(0x145)]),{[constants_1[_0x13403f(0x162)]+_0x13403f(0x178)]:'Deployment\x20Result',[constants_1[_0x13403f(0x162)]+'Status__c']:_0x2aac0c['status']===status_enums_1['PackageComponentStatus'][_0x13403f(0x1b9)]?_0x13403f(0x1a1):_0x13403f(0x1a9),[constants_1[_0x13403f(0x162)]+'Result__c']:_0x2aac0c[_0x13403f(0x176)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x2aac0c[_0x13403f(0x17d)],[constants_1[_0x13403f(0x162)]+_0x13403f(0x1b2)]:_0x2aac0c[_0x13403f(0x165)],[constants_1[_0x13403f(0x162)]+_0x13403f(0x148)]:_0x2aac0c['stepName'],[constants_1[_0x13403f(0x162)]+_0x13403f(0x1b1)]:this['_metadataLog']['organizationId'],[constants_1[_0x13403f(0x162)]+_0x13403f(0x187)]:this[_0x13403f(0x14a)]};});}async[a404_0xf7c4a9(0x16e)](_0x1196a0){const _0x23ac8b=a404_0xf7c4a9;this[_0x23ac8b(0x175)]['log'](_0x23ac8b(0x18f));const _0xa754b6=await this[_0x23ac8b(0x1bc)][_0x23ac8b(0x184)](constants_1[_0x23ac8b(0x162)]+'Deployment_Result__c',_0x1196a0),_0xaf684b=_0xa754b6['filter'](_0x462736=>!_0x462736[_0x23ac8b(0x13d)])[_0x23ac8b(0x1a3)](_0x41fa6d=>_0x41fa6d[_0x23ac8b(0x153)])[_0x23ac8b(0x18c)]();if(_0xaf684b[_0x23ac8b(0x167)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0xaf684b);}async[a404_0xf7c4a9(0x1bb)](_0x10189f){const _0x35cf0c=a404_0xf7c4a9;if(!this['_metadataLog']){this[_0x35cf0c(0x13c)]['error'](_0x10189f);return;}this[_0x35cf0c(0x175)]['logError'](_0x10189f),await this[_0x35cf0c(0x175)][_0x35cf0c(0x181)](),await this[_0x35cf0c(0x168)](![],!![],'');}async[a404_0xf7c4a9(0x168)](_0x169eec,_0x45242f,_0x40aa08){const _0xb9b87e=a404_0xf7c4a9,{id:_0x4bafb1,organizationId:_0x3f15e7,branchId:_0x73829b,organizationName:_0x318781}=this[_0xb9b87e(0x1ab)],_0x209e5c=_0xb9b87e(0x1ba)+this['_instanceUrl']+'/'+_0x4bafb1+_0xb9b87e(0x188)+_0xb9b87e(0x19d)+_0xb9b87e(0x169),_0x973881=_0xb9b87e(0x1ba)+this[_0xb9b87e(0x1b5)]+'/'+_0x3f15e7+'\x20>'+_0x318781+_0xb9b87e(0x13e),_0x3b91cb=_0x209e5c+_0xb9b87e(0x16b)+_0x973881+_0xb9b87e(0x191),_0x318796={[constants_1[_0xb9b87e(0x162)]+_0xb9b87e(0x16d)]:_0x3b91cb,[constants_1[_0xb9b87e(0x162)]+'Date__c']:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0xb9b87e(0x15e)]:_0x73829b,[constants_1[_0xb9b87e(0x162)]+_0xb9b87e(0x155)]:_0xb9b87e(0x197),[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0xb9b87e(0x14c),[constants_1[_0xb9b87e(0x162)]+_0xb9b87e(0x173)]:_0x3f15e7},_0x5b51a9={[constants_1[_0xb9b87e(0x162)]+_0xb9b87e(0x1b4)]:!_0x169eec,[constants_1[_0xb9b87e(0x162)]+_0xb9b87e(0x195)]:_0x169eec,[constants_1[_0xb9b87e(0x162)]+'Status__c']:_0x45242f?status_enums_1['MetadataLogStatus'][_0xb9b87e(0x1a2)]:status_enums_1[_0xb9b87e(0x159)]['COMPLETED'],[constants_1[_0xb9b87e(0x162)]+_0xb9b87e(0x130)]:!![],[constants_1[_0xb9b87e(0x162)]+'External_Deployment_Id__c']:_0x40aa08};await this[_0xb9b87e(0x137)][_0xb9b87e(0x161)](flosum_constants_1[_0xb9b87e(0x185)][_0xb9b87e(0x198)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0xb9b87e(0x19f)+this['_metadataLogId'],_0x5b51a9),await this[_0xb9b87e(0x137)]['post'](flosum_constants_1[_0xb9b87e(0x185)][_0xb9b87e(0x198)]+'/'+constants_1[_0xb9b87e(0x162)]+_0xb9b87e(0x12e),_0x318796),this[_0xb9b87e(0x175)][_0xb9b87e(0x172)](_0xb9b87e(0x13a)+(_0x169eec?_0xb9b87e(0x15d):_0xb9b87e(0x192))+'.'),await this[_0xb9b87e(0x175)][_0xb9b87e(0x181)]();}async[a404_0xf7c4a9(0x1a4)](){const _0x3be520=a404_0xf7c4a9;try{this[_0x3be520(0x1ab)]=await this[_0x3be520(0x160)]();const _0x277e0e=await this[_0x3be520(0x14d)]();await this[_0x3be520(0x175)][_0x3be520(0x181)]();const _0x477e55=await this['createZip'](_0x277e0e),_0x7af122=await this['createVpk'](_0x477e55);await this[_0x3be520(0x175)]['updateLog']();const _0x32f3c1=await this[_0x3be520(0x146)][_0x3be520(0x196)](_0x7af122);await this[_0x3be520(0x175)][_0x3be520(0x181)]();const _0x9ba4af=this[_0x3be520(0x166)](_0x32f3c1['packageComponentList']);await this[_0x3be520(0x16e)](_0x9ba4af),await this[_0x3be520(0x168)](_0x32f3c1[_0x3be520(0x1a8)],![],_0x32f3c1[_0x3be520(0x141)]);}catch(_0x38c5e5){await this[_0x3be520(0x1bb)](_0x38c5e5)[_0x3be520(0x189)](_0x2eff4=>this[_0x3be520(0x13c)]['error'](_0x2eff4));}}}exports[a404_0xf7c4a9(0x19b)]=RollbackService;