const a376_0x161ffc=a376_0x4c47;(function(_0x1e177a,_0x26a884){const _0x13d22e=a376_0x4c47,_0x8d50e4=_0x1e177a();while(!![]){try{const _0x5d6b8d=parseInt(_0x13d22e(0xd3))/0x1+parseInt(_0x13d22e(0x100))/0x2*(parseInt(_0x13d22e(0x144))/0x3)+parseInt(_0x13d22e(0x11f))/0x4+parseInt(_0x13d22e(0x12f))/0x5+-parseInt(_0x13d22e(0x132))/0x6*(-parseInt(_0x13d22e(0x12a))/0x7)+parseInt(_0x13d22e(0xf8))/0x8*(-parseInt(_0x13d22e(0xf2))/0x9)+-parseInt(_0x13d22e(0xf5))/0xa*(parseInt(_0x13d22e(0x10b))/0xb);if(_0x5d6b8d===_0x26a884)break;else _0x8d50e4['push'](_0x8d50e4['shift']());}catch(_0x2e6e1f){_0x8d50e4['push'](_0x8d50e4['shift']());}}}(a376_0x5000,0xe5aa9));function a376_0x4c47(_0x31c3f3,_0x5d026d){const _0x3c17c1=a376_0x5000();return a376_0x4c47=function(_0x83b8b2,_0xeb235c){_0x83b8b2=_0x83b8b2-0xc6;let _0x50005e=_0x3c17c1[_0x83b8b2];return _0x50005e;},a376_0x4c47(_0x31c3f3,_0x5d026d);}const a376_0xeb235c=(function(){let _0x272097=!![];return function(_0x2e42a5,_0x42b169){const _0x21682d=_0x272097?function(){const _0x1a0b32=a376_0x4c47;if(_0x42b169){const _0x23420f=_0x42b169[_0x1a0b32(0x10c)](_0x2e42a5,arguments);return _0x42b169=null,_0x23420f;}}:function(){};return _0x272097=![],_0x21682d;};}()),a376_0x83b8b2=a376_0xeb235c(this,function(){const _0x4c5594=a376_0x4c47;return a376_0x83b8b2[_0x4c5594(0x112)]()[_0x4c5594(0x133)](_0x4c5594(0x102))[_0x4c5594(0x112)]()[_0x4c5594(0xfb)](a376_0x83b8b2)['search']('(((.+)+)+)+$');});a376_0x83b8b2();'use strict';var __importDefault=this&&this[a376_0x161ffc(0x12e)]||function(_0x541f96){return _0x541f96&&_0x541f96['__esModule']?_0x541f96:{'default':_0x541f96};};Object[a376_0x161ffc(0x14a)](exports,'__esModule',{'value':!![]}),exports[a376_0x161ffc(0x10d)]=void 0x0;const veeva_service_1=require(a376_0x161ffc(0x109)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a376_0x161ffc(0x128)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a376_0x161ffc(0xe1)),constants_1=require(a376_0x161ffc(0xea)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require('shortid')),promises_1=require(a376_0x161ffc(0xce)),vpk_service_1=require(a376_0x161ffc(0xf6)),status_enums_1=require(a376_0x161ffc(0x13b)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x3ed673,connectionVeeva:_0x1b49f4,logger:_0xc4187f,tempFolder:_0xe8e207,instanceUrl:_0x47ebf3,timeZone:_0x3580e9,metadataLogId:_0x5720a4,attachmentLogId:_0x18eb23,parentMetadataLogId:_0x245a55,componentIds:_0x2f2507}){const _0xb3b747=a376_0x161ffc;this[_0xb3b747(0x139)]=_0x3ed673,this[_0xb3b747(0xed)]=_0x1b49f4,this[_0xb3b747(0x12b)]=_0xc4187f,this[_0xb3b747(0xee)]=_0xe8e207,this[_0xb3b747(0xf7)]=_0x47ebf3,this[_0xb3b747(0xde)]=_0x3580e9,this[_0xb3b747(0x120)]=_0x5720a4,this[_0xb3b747(0xc8)]=_0x18eb23,this[_0xb3b747(0xd9)]=_0x245a55,this['_componentIds']=_0x2f2507,this[_0xb3b747(0x155)]=new core_1[(_0xb3b747(0x13a))](_0xb3b747(0x14e)),this[_0xb3b747(0xdb)]=new veeva_service_1[(_0xb3b747(0x11b))]({'connection':_0x1b49f4,'logger':_0xc4187f}),this['_salesforceService']=new salesforce_service_1[(_0xb3b747(0x122))]({'connection':_0x3ed673}),this[_0xb3b747(0x119)]=new package_import_service_1[(_0xb3b747(0x127))]({'veevaService':this[_0xb3b747(0xdb)],'connection':_0x1b49f4,'logger':_0xc4187f,'saveLog':this['saveLog']['bind'](this)}),this[_0xb3b747(0xca)]=new vpk_service_1[(_0xb3b747(0xff))]({'connection':_0x1b49f4});}async['saveLog'](_0x49d957,_0x6387c9){const _0xa98670=a376_0x161ffc;this['_logger']['log'](_0xa98670(0xda));const _0x89477a={'Body':Buffer['from'](_0x49d957)['toString'](_0xa98670(0xe2)),'ContentType':_0xa98670(0x14f),'ParentId':this['_metadataLogId'],'Name':_0x6387c9};await this[_0xa98670(0x139)][_0xa98670(0x13e)](flosum_constants_1[_0xa98670(0xe8)][_0xa98670(0x129)]+_0xa98670(0x14d),_0x89477a);}async['retrieveMetadataLog'](){const _0x34de3b=a376_0x161ffc;this[_0x34de3b(0x12b)][_0x34de3b(0xef)]('Retrieve\x20Metadata\x20Log\x20info');const [_0xc8880b]=await this[_0x34de3b(0x142)][_0x34de3b(0xf0)](_0x34de3b(0x140)+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x34de3b(0xcf)]+_0x34de3b(0x106)+constants_1['FLOSUM_NAMESPACE']+_0x34de3b(0x148)+constants_1[_0x34de3b(0xcf)]+_0x34de3b(0xcb)+this[_0x34de3b(0x120)]+_0x34de3b(0x11a));return new metadata_log_dto_1[(_0x34de3b(0x13f))](_0xc8880b);}async['retrieveDeploymentResults'](){const _0x47c35e=a376_0x161ffc;this['_logger'][_0x47c35e(0xef)](_0x47c35e(0x14b));const _0xe7a5b=await new id_deployment_result_retriever_1[(_0x47c35e(0xcd))]({'salesforceService':this[_0x47c35e(0x142)],'value':this[_0x47c35e(0x12c)]})['retrieve']();if(!_0xe7a5b[_0x47c35e(0x147)])throw new Error(_0x47c35e(0xd1));return _0xe7a5b;}async['retrieveBackup'](){const _0x102d85=a376_0x161ffc;this[_0x102d85(0x12b)]['log'](_0x102d85(0x11e));const _0x32468e=await this[_0x102d85(0x142)][_0x102d85(0xf0)](_0x102d85(0x137)+this[_0x102d85(0xd9)]+_0x102d85(0xe3)+flosum_constants_1[_0x102d85(0xe8)][_0x102d85(0x115)]+_0x102d85(0x11a)),_0x31fc3f=await(0x0,fetch_attachments_1[_0x102d85(0x110)])(this[_0x102d85(0x139)],[_0x32468e[0x0]['Id']]),_0x37123b=await(0x0,fetch_attachments_1[_0x102d85(0xe7)])(_0x31fc3f,this[_0x102d85(0x139)]);if(!_0x37123b[_0x102d85(0x147)])throw new Error(_0x102d85(0xd6));return _0x37123b[0x0][_0x102d85(0xdc)][_0x102d85(0x12d)];}async['createZip'](_0x7e0be7){const _0x529a6a=a376_0x161ffc;this['_logger']['log'](_0x529a6a(0xe6));const _0x13952b=await this[_0x529a6a(0x104)](),_0x3dbd3b=await new zip_creator_rollback_1[(_0x529a6a(0x113))]({'rollbackName':this[_0x529a6a(0xd7)][_0x529a6a(0x154)],'backup':_0x13952b,'deploymentResults':_0x7e0be7})[_0x529a6a(0x105)](),_0x38c059=this[_0x529a6a(0xee)]+'/'+(0x0,shortid_1[_0x529a6a(0x126)])()+_0x529a6a(0xcc);return await(0x0,promises_1[_0x529a6a(0x149)])(_0x38c059,_0x3dbd3b),_0x38c059;}async[a376_0x161ffc(0x123)](_0x232a61){const _0x465ad5=a376_0x161ffc;this[_0x465ad5(0x12b)][_0x465ad5(0xef)](_0x465ad5(0x11c));const _0x2ed8ab=await this[_0x465ad5(0xca)]['generate'](_0x232a61),_0xbe4c16=this['_tempFolder']+_0x465ad5(0xdd)+_0x232a61[_0x465ad5(0x156)](_0x232a61['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x465ad5(0x149)])(_0xbe4c16,_0x2ed8ab),await this[_0x465ad5(0xca)][_0x465ad5(0x14c)](_0xbe4c16),_0xbe4c16;}[a376_0x161ffc(0xd2)](_0x45d526){const _0x57d7a0=a376_0x161ffc;return this['_logger'][_0x57d7a0(0xef)](_0x57d7a0(0x130)),_0x45d526['map'](_0x5d2992=>{const _0x468352=_0x57d7a0;return this[_0x468352(0x12b)][_0x468352(0xef)](_0x5d2992[_0x468352(0xe9)]+'.'+_0x5d2992['name']+'\x20:\x20'+_0x5d2992[_0x468352(0xc7)]),{[constants_1[_0x468352(0xcf)]+_0x468352(0x146)]:_0x468352(0xec),[constants_1[_0x468352(0xcf)]+'Status__c']:_0x5d2992[_0x468352(0xc7)]===status_enums_1[_0x468352(0x116)]['DEPLOYED']?_0x468352(0x111):_0x468352(0x136),[constants_1[_0x468352(0xcf)]+_0x468352(0x10a)]:_0x5d2992[_0x468352(0xdf)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x5d2992[_0x468352(0x154)],[constants_1['FLOSUM_NAMESPACE']+_0x468352(0x13c)]:_0x5d2992[_0x468352(0xe9)],[constants_1[_0x468352(0xcf)]+_0x468352(0xf9)]:_0x5d2992['stepName'],[constants_1[_0x468352(0xcf)]+_0x468352(0x125)]:this[_0x468352(0xd7)][_0x468352(0x134)],[constants_1[_0x468352(0xcf)]+_0x468352(0xfd)]:this['_metadataLogId']};});}async[a376_0x161ffc(0xd4)](_0x56bea4){const _0x12b2bc=a376_0x161ffc;this[_0x12b2bc(0x12b)][_0x12b2bc(0xef)](_0x12b2bc(0x141));const _0x42258f=await this[_0x12b2bc(0x142)][_0x12b2bc(0x153)](constants_1['FLOSUM_NAMESPACE']+_0x12b2bc(0x151),_0x56bea4),_0x3b4a78=_0x42258f[_0x12b2bc(0x13d)](_0x3e36c=>!_0x3e36c[_0x12b2bc(0xd5)])[_0x12b2bc(0x103)](_0x429188=>_0x429188[_0x12b2bc(0x124)])['flat']();if(_0x3b4a78['length'])throw new salesforce_dml_error_1[(_0x12b2bc(0x11d))](_0x3b4a78);}async['finishRollbackWithError'](_0xf517f6){const _0x244646=a376_0x161ffc;if(!this[_0x244646(0xd7)]){this[_0x244646(0x155)]['error'](_0xf517f6);return;}this[_0x244646(0x12b)][_0x244646(0x117)](_0xf517f6),await this['_logger'][_0x244646(0xfe)](),await this[_0x244646(0xfc)](![],!![],'');}async[a376_0x161ffc(0xfc)](_0x177223,_0xee6420,_0x28c07e){const _0x929f46=a376_0x161ffc,{id:_0x43be27,organizationId:_0x1f341f,branchId:_0x5960d7,organizationName:_0x44b345}=this[_0x929f46(0xd7)],_0x43c131=_0x929f46(0x10e)+this[_0x929f46(0xf7)]+'/'+_0x43be27+_0x929f46(0xf3)+_0x929f46(0xfa)+_0x929f46(0x107),_0x594304=_0x929f46(0x10e)+this[_0x929f46(0xf7)]+'/'+_0x1f341f+'\x20>'+_0x44b345+_0x929f46(0x131),_0x70aa88=_0x43c131+_0x929f46(0xe0)+_0x594304+'\x20has\x20been\x20created.',_0x31cbfa={[constants_1[_0x929f46(0xcf)]+_0x929f46(0x138)]:_0x70aa88,[constants_1[_0x929f46(0xcf)]+_0x929f46(0xd8)]:new Date(),[constants_1[_0x929f46(0xcf)]+'Branch__c']:_0x5960d7,[constants_1[_0x929f46(0xcf)]+'Activity_Item__c']:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x929f46(0xc6)]:_0x929f46(0x108),[constants_1[_0x929f46(0xcf)]+_0x929f46(0xf4)]:_0x1f341f},_0x164396={[constants_1[_0x929f46(0xcf)]+_0x929f46(0x10f)]:!_0x177223,[constants_1[_0x929f46(0xcf)]+_0x929f46(0x121)]:_0x177223,[constants_1[_0x929f46(0xcf)]+_0x929f46(0x135)]:_0xee6420?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x929f46(0xcf)]+_0x929f46(0x145)]:!![],[constants_1[_0x929f46(0xcf)]+_0x929f46(0xf1)]:_0x28c07e};await this[_0x929f46(0x139)]['patch'](flosum_constants_1[_0x929f46(0xe8)][_0x929f46(0x129)]+'/'+constants_1[_0x929f46(0xcf)]+_0x929f46(0xe4)+this['_metadataLogId'],_0x164396),await this[_0x929f46(0x139)]['post'](flosum_constants_1['FlosumConstants'][_0x929f46(0x129)]+'/'+constants_1[_0x929f46(0xcf)]+_0x929f46(0x150),_0x31cbfa),this[_0x929f46(0x12b)][_0x929f46(0xef)]('Rollback\x20completed\x20'+(_0x177223?'successfully':'with\x20error')+'.'),await this[_0x929f46(0x12b)][_0x929f46(0xfe)]();}async['execute'](){const _0x4c04c9=a376_0x161ffc;try{this[_0x4c04c9(0xd7)]=await this[_0x4c04c9(0xd0)]();const _0x3fd857=await this[_0x4c04c9(0xc9)]();await this[_0x4c04c9(0x12b)][_0x4c04c9(0xfe)]();const _0x3472e1=await this[_0x4c04c9(0xeb)](_0x3fd857),_0x7e671a=await this[_0x4c04c9(0x123)](_0x3472e1);await this['_logger'][_0x4c04c9(0xfe)]();const _0x325eec=await this[_0x4c04c9(0x119)][_0x4c04c9(0x101)](_0x7e671a);await this[_0x4c04c9(0x12b)][_0x4c04c9(0xfe)]();const _0x595cff=this[_0x4c04c9(0xd2)](_0x325eec[_0x4c04c9(0xe5)]);await this[_0x4c04c9(0xd4)](_0x595cff),await this[_0x4c04c9(0xfc)](_0x325eec[_0x4c04c9(0x114)],![],_0x325eec[_0x4c04c9(0x118)]);}catch(_0xff26e4){await this['finishRollbackWithError'](_0xff26e4)[_0x4c04c9(0x152)](_0x18be91=>this[_0x4c04c9(0x155)][_0x4c04c9(0x143)](_0x18be91));}}}exports[a376_0x161ffc(0x10d)]=RollbackService;function a376_0x5000(){const _0x30ac41=['\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','Action__c','_connectionSalesforce','Logger','../enums/status.enums','Component_Type__c','filter','post','MetadataLogDto','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Save\x20Deployment\x20Results','_salesforceService','error','21CrZwGO','Job_Completed__c','Type__c','length','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','writeFile','defineProperty','Retrieve\x20Deployment\x20Results','validate','/Attachment','veeva-rollback','text/plain','Log__c','Deployment_Result__c','catch','insertMultipleRecords','name','_systemLogger','slice','Activity_Type__c','status','_attachmentLogId','retrieveDeploymentResults','_vpkService','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','.zip','IdDeploymentResultRetriever','fs/promises','FLOSUM_NAMESPACE','retrieveMetadataLog','Cannot\x20find\x20Deployment\x20Results','formFlosumDeploymentResults','1123480pHVPXy','saveDeploymentResults','success','Cannot\x20find\x20Backup\x20Zip','_metadataLog','Date__c','_parentMetadataLogId','Save\x20log','_veevaService','values','/vpk__','_timeZone','deploymentAction','\x20of\x20branch\x20to\x20Organization\x20','../../shared/utils/fetch-attachments','base64','\x27\x20AND\x20Name\x20=\x20\x27','Metadata_Log__c/','packageComponentList','Create\x20zip\x20from\x20backup','retrieveAttachments','FlosumConstants','type','../../../constants','createZip','Deployment\x20Result','_connectionVeeva','_tempFolder','log','retrieveRecords','External_Deployment_Id__c','27jJJOSB','\x20>\x20','TargetId__c','10MiajMx','./vpk.service','_instanceUrl','1945552LofWcA','Veeva_Step_Name__c','Veeva\x20Rollback\x20(Deployment)','constructor','finishRollback','Metadata_Log__c','updateLog','VpkService','284086kDSObg','import','(((.+)+)+)+$','map','retrieveBackup','create','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x20</a>','Deployment','./veeva.service','Result__c','37663131EMniWQ','apply','RollbackService','<a\x20href=','Is_Error__c','fetchAttachmentsDetailsById','Success','toString','ZipCreatorRollback','isDeployed','BACKUP_ZIP_NAME','PackageComponentStatus','logError','packageId','_packageImportService','\x27\x0a\x20\x20\x20\x20','VeevaService','Create\x20Vpk\x20package','SalesforceDmlError','Retrieve\x20Backup','2439116Uamcur','_metadataLogId','Succeed__c','SalesforceService','createVpk','errors','Org__c','default','PackageImportService','./package-import.service','ENDPOINT_UPSERT_RECORD','105nnlzAM','_logger','_componentIds','Body','__importDefault','3527855lzBAkS','Form\x20Deployment\x20Results','</a>','664434yrbPUy','search','organizationId','Status__c','Failure'];a376_0x5000=function(){return _0x30ac41;};return a376_0x5000();}