const a337_0x497f00=a337_0x64eb;(function(_0x3b0b80,_0x3230fe){const _0x1417d8=a337_0x64eb,_0x7df8d9=_0x3b0b80();while(!![]){try{const _0x1a7d8f=-parseInt(_0x1417d8(0x1ac))/0x1*(parseInt(_0x1417d8(0x222))/0x2)+parseInt(_0x1417d8(0x1ec))/0x3+-parseInt(_0x1417d8(0x1a3))/0x4*(parseInt(_0x1417d8(0x203))/0x5)+parseInt(_0x1417d8(0x1e8))/0x6+-parseInt(_0x1417d8(0x197))/0x7+parseInt(_0x1417d8(0x1f2))/0x8*(-parseInt(_0x1417d8(0x1a2))/0x9)+-parseInt(_0x1417d8(0x224))/0xa*(-parseInt(_0x1417d8(0x1c0))/0xb);if(_0x1a7d8f===_0x3230fe)break;else _0x7df8d9['push'](_0x7df8d9['shift']());}catch(_0x413cef){_0x7df8d9['push'](_0x7df8d9['shift']());}}}(a337_0x2b7a,0x5ca54));const a337_0x419d88=(function(){let _0x52265f=!![];return function(_0x21ccd1,_0x3d0f4){const _0x30e1dd=_0x52265f?function(){const _0x541873=a337_0x64eb;if(_0x3d0f4){const _0x364d63=_0x3d0f4[_0x541873(0x1c1)](_0x21ccd1,arguments);return _0x3d0f4=null,_0x364d63;}}:function(){};return _0x52265f=![],_0x30e1dd;};}()),a337_0x215863=a337_0x419d88(this,function(){const _0x25ee8c=a337_0x64eb;return a337_0x215863[_0x25ee8c(0x191)]()['search'](_0x25ee8c(0x1fa))['toString']()[_0x25ee8c(0x1e0)](a337_0x215863)['search']('(((.+)+)+)+$');});a337_0x215863();'use strict';var __importDefault=this&&this[a337_0x497f00(0x1a0)]||function(_0x80c404){const _0x1c23ca=a337_0x497f00;return _0x80c404&&_0x80c404[_0x1c23ca(0x1ce)]?_0x80c404:{'default':_0x80c404};};function a337_0x64eb(_0x2def62,_0x4c6af2){const _0x2ce1a3=a337_0x2b7a();return a337_0x64eb=function(_0x215863,_0x419d88){_0x215863=_0x215863-0x191;let _0x2b7a31=_0x2ce1a3[_0x215863];return _0x2b7a31;},a337_0x64eb(_0x2def62,_0x4c6af2);}Object[a337_0x497f00(0x1dd)](exports,a337_0x497f00(0x1ce),{'value':!![]}),exports[a337_0x497f00(0x1ca)]=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a337_0x497f00(0x1f7)),package_import_service_1=require(a337_0x497f00(0x1d6)),id_deployment_result_retriever_1=require(a337_0x497f00(0x1f8)),flosum_constants_1=require(a337_0x497f00(0x1d7)),fetch_attachments_1=require(a337_0x497f00(0x1d4)),constants_1=require(a337_0x497f00(0x1d1)),zip_creator_rollback_1=require(a337_0x497f00(0x1c8)),shortid_1=__importDefault(require('shortid')),promises_1=require('fs/promises'),vpk_service_1=require(a337_0x497f00(0x210)),status_enums_1=require(a337_0x497f00(0x1e4)),salesforce_dml_error_1=require(a337_0x497f00(0x212)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a337_0x497f00(0x1c2));class RollbackService{constructor({connectionSalesforce:_0x335990,connectionVeeva:_0x3c8353,logger:_0x142ecd,tempFolder:_0x399635,instanceUrl:_0x3f155a,timeZone:_0x479ea1,metadataLogId:_0x3a6357,attachmentLogId:_0x4ae371,parentMetadataLogId:_0x3f43ab,componentIds:_0x403265}){const _0x822d5a=a337_0x497f00;this[_0x822d5a(0x21e)]=_0x335990,this['_connectionVeeva']=_0x3c8353,this['_logger']=_0x142ecd,this['_tempFolder']=_0x399635,this[_0x822d5a(0x20a)]=_0x3f155a,this[_0x822d5a(0x1de)]=_0x479ea1,this[_0x822d5a(0x200)]=_0x3a6357,this[_0x822d5a(0x195)]=_0x4ae371,this[_0x822d5a(0x1dc)]=_0x3f43ab,this[_0x822d5a(0x1fd)]=_0x403265,this[_0x822d5a(0x1f6)]=new core_1['Logger'](_0x822d5a(0x1d5)),this['_veevaService']=new veeva_service_1[(_0x822d5a(0x1db))]({'connection':_0x3c8353,'logger':_0x142ecd}),this['_salesforceService']=new salesforce_service_1[(_0x822d5a(0x1be))]({'connection':_0x335990}),this['_packageImportService']=new package_import_service_1[(_0x822d5a(0x217))]({'veevaService':this[_0x822d5a(0x20e)],'connection':_0x3c8353,'logger':_0x142ecd,'saveLog':this['saveLog'][_0x822d5a(0x1c9)](this)}),this[_0x822d5a(0x1cb)]=new vpk_service_1[(_0x822d5a(0x21b))]({'connection':_0x3c8353});}async[a337_0x497f00(0x1c3)](_0x453707,_0x8822d6){const _0x16e741=a337_0x497f00;this[_0x16e741(0x1f0)][_0x16e741(0x1a9)](_0x16e741(0x1c6));const _0x42185d={'Body':Buffer[_0x16e741(0x196)](_0x453707)['toString']('base64'),'ContentType':_0x16e741(0x213),'ParentId':this['_metadataLogId'],'Name':_0x8822d6};await this[_0x16e741(0x21e)][_0x16e741(0x1da)](flosum_constants_1[_0x16e741(0x1ea)][_0x16e741(0x194)]+'/Attachment',_0x42185d);}async[a337_0x497f00(0x1f9)](){const _0x3613a4=a337_0x497f00;this['_logger'][_0x3613a4(0x1a9)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x27ecfb]=await this[_0x3613a4(0x223)][_0x3613a4(0x207)](_0x3613a4(0x1a4)+constants_1[_0x3613a4(0x1ff)]+_0x3613a4(0x219)+constants_1[_0x3613a4(0x1ff)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x3613a4(0x1ff)]+_0x3613a4(0x218)+constants_1[_0x3613a4(0x1ff)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x3613a4(0x200)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1['MetadataLogDto'](_0x27ecfb);}async[a337_0x497f00(0x1cf)](){const _0x591d44=a337_0x497f00;this[_0x591d44(0x1f0)][_0x591d44(0x1a9)]('Retrieve\x20Deployment\x20Results');const _0x2c4096=await new id_deployment_result_retriever_1[(_0x591d44(0x1b0))]({'salesforceService':this[_0x591d44(0x223)],'value':this['_componentIds']})[_0x591d44(0x19c)]();if(!_0x2c4096[_0x591d44(0x19b)])throw new Error(_0x591d44(0x202));return _0x2c4096;}async[a337_0x497f00(0x19d)](){const _0x27ef04=a337_0x497f00;this[_0x27ef04(0x1f0)][_0x27ef04(0x1a9)](_0x27ef04(0x1e7));const _0x3c2d5b=await this[_0x27ef04(0x223)][_0x27ef04(0x207)](_0x27ef04(0x1ba)+this[_0x27ef04(0x1dc)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1['FlosumConstants'][_0x27ef04(0x1b5)]+_0x27ef04(0x20d)),_0x42db89=await(0x0,fetch_attachments_1[_0x27ef04(0x1d3)])(this[_0x27ef04(0x21e)],[_0x3c2d5b[0x0]['Id']]),_0x5c9e6d=await(0x0,fetch_attachments_1[_0x27ef04(0x1d8)])(_0x42db89,this[_0x27ef04(0x21e)]);if(!_0x5c9e6d['length'])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x5c9e6d[0x0][_0x27ef04(0x1d0)][_0x27ef04(0x1c4)];}async[a337_0x497f00(0x1a6)](_0x5d0e1a){const _0x2dfb63=a337_0x497f00;this[_0x2dfb63(0x1f0)][_0x2dfb63(0x1a9)]('Create\x20zip\x20from\x20backup');const _0x434ab5=await this[_0x2dfb63(0x19d)](),_0x185ba7=await new zip_creator_rollback_1[(_0x2dfb63(0x1d9))]({'rollbackName':this['_metadataLog'][_0x2dfb63(0x1e9)],'backup':_0x434ab5,'deploymentResults':_0x5d0e1a})[_0x2dfb63(0x21c)](),_0x8ac964=this[_0x2dfb63(0x193)]+'/'+(0x0,shortid_1[_0x2dfb63(0x216)])()+_0x2dfb63(0x19f);return await(0x0,promises_1['writeFile'])(_0x8ac964,_0x185ba7),_0x8ac964;}async[a337_0x497f00(0x1e5)](_0x58311d){const _0x366fb6=a337_0x497f00;this['_logger'][_0x366fb6(0x1a9)](_0x366fb6(0x1cd));const _0x2a6906=await this[_0x366fb6(0x1cb)][_0x366fb6(0x1f5)](_0x58311d),_0x4f23ab=this['_tempFolder']+'/vpk__'+_0x58311d[_0x366fb6(0x1a5)](_0x58311d[_0x366fb6(0x1bb)]('/')+0x1);return await(0x0,promises_1[_0x366fb6(0x20c)])(_0x4f23ab,_0x2a6906),await this['_vpkService'][_0x366fb6(0x221)](_0x4f23ab),_0x4f23ab;}[a337_0x497f00(0x192)](_0x4e3194){return this['_logger']['log']('Form\x20Deployment\x20Results'),_0x4e3194['map'](_0x4cc917=>{const _0xf36fca=a337_0x64eb;return this[_0xf36fca(0x1f0)][_0xf36fca(0x1a9)](_0x4cc917[_0xf36fca(0x20f)]+'.'+_0x4cc917[_0xf36fca(0x1e9)]+_0xf36fca(0x19e)+_0x4cc917[_0xf36fca(0x21a)]),{[constants_1['FLOSUM_NAMESPACE']+_0xf36fca(0x1c5)]:_0xf36fca(0x1b9),[constants_1[_0xf36fca(0x1ff)]+_0xf36fca(0x1ee)]:_0x4cc917[_0xf36fca(0x21a)]===status_enums_1[_0xf36fca(0x1bd)][_0xf36fca(0x1eb)]?_0xf36fca(0x1fc):_0xf36fca(0x201),[constants_1['FLOSUM_NAMESPACE']+_0xf36fca(0x1fb)]:_0x4cc917[_0xf36fca(0x1ab)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x4cc917[_0xf36fca(0x1e9)],[constants_1[_0xf36fca(0x1ff)]+_0xf36fca(0x1e3)]:_0x4cc917[_0xf36fca(0x20f)],[constants_1[_0xf36fca(0x1ff)]+_0xf36fca(0x1bc)]:_0x4cc917[_0xf36fca(0x1ed)],[constants_1['FLOSUM_NAMESPACE']+_0xf36fca(0x215)]:this[_0xf36fca(0x1d2)][_0xf36fca(0x1fe)],[constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c']:this['_metadataLogId']};});}async['saveDeploymentResults'](_0x2c673b){const _0x5ad290=a337_0x497f00;this[_0x5ad290(0x1f0)][_0x5ad290(0x1a9)](_0x5ad290(0x1bf));const _0x406ef4=await this[_0x5ad290(0x223)][_0x5ad290(0x1a1)](constants_1[_0x5ad290(0x1ff)]+_0x5ad290(0x1b1),_0x2c673b),_0x171514=_0x406ef4[_0x5ad290(0x204)](_0x129d00=>!_0x129d00[_0x5ad290(0x1b2)])[_0x5ad290(0x225)](_0x51b908=>_0x51b908[_0x5ad290(0x1b6)])['flat']();if(_0x171514['length'])throw new salesforce_dml_error_1[(_0x5ad290(0x1b8))](_0x171514);}async['finishRollbackWithError'](_0x30328d){const _0x166db2=a337_0x497f00;if(!this[_0x166db2(0x1d2)]){this[_0x166db2(0x1f6)][_0x166db2(0x1b7)](_0x30328d);return;}this['_logger'][_0x166db2(0x209)](_0x30328d),await this[_0x166db2(0x1f0)][_0x166db2(0x1f1)](),await this[_0x166db2(0x1aa)](![],!![],'');}async[a337_0x497f00(0x1aa)](_0x138f32,_0x5944f1,_0x16a75d){const _0x4a76ad=a337_0x497f00,{id:_0x2daef8,organizationId:_0x629f00,branchId:_0x41cdcd,organizationName:_0x3588be}=this[_0x4a76ad(0x1d2)],_0x4592ff=_0x4a76ad(0x1f3)+this['_instanceUrl']+'/'+_0x2daef8+_0x4a76ad(0x1a8)+_0x4a76ad(0x1e2)+_0x4a76ad(0x1e6),_0x4219e0=_0x4a76ad(0x1f3)+this['_instanceUrl']+'/'+_0x629f00+'\x20>'+_0x3588be+_0x4a76ad(0x199),_0x41ae28=_0x4592ff+_0x4a76ad(0x1ad)+_0x4219e0+'\x20has\x20been\x20created.',_0x1abd5c={[constants_1[_0x4a76ad(0x1ff)]+_0x4a76ad(0x1cc)]:_0x41ae28,[constants_1[_0x4a76ad(0x1ff)]+_0x4a76ad(0x1b4)]:new Date(),[constants_1[_0x4a76ad(0x1ff)]+_0x4a76ad(0x19a)]:_0x41cdcd,[constants_1[_0x4a76ad(0x1ff)]+_0x4a76ad(0x208)]:'Branch',[constants_1[_0x4a76ad(0x1ff)]+_0x4a76ad(0x205)]:_0x4a76ad(0x1af),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:_0x629f00},_0x5ef7a3={[constants_1[_0x4a76ad(0x1ff)]+_0x4a76ad(0x21d)]:!_0x138f32,[constants_1['FLOSUM_NAMESPACE']+_0x4a76ad(0x206)]:_0x138f32,[constants_1[_0x4a76ad(0x1ff)]+'Status__c']:_0x5944f1?status_enums_1[_0x4a76ad(0x21f)]['EXCEPTION']:status_enums_1[_0x4a76ad(0x21f)][_0x4a76ad(0x1e1)],[constants_1['FLOSUM_NAMESPACE']+_0x4a76ad(0x1ef)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x4a76ad(0x1c7)]:_0x16a75d};await this[_0x4a76ad(0x21e)][_0x4a76ad(0x1ae)](flosum_constants_1[_0x4a76ad(0x1ea)][_0x4a76ad(0x194)]+'/'+constants_1[_0x4a76ad(0x1ff)]+'Metadata_Log__c/'+this[_0x4a76ad(0x200)],_0x5ef7a3),await this[_0x4a76ad(0x21e)][_0x4a76ad(0x1da)](flosum_constants_1[_0x4a76ad(0x1ea)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x4a76ad(0x1ff)]+'Log__c',_0x1abd5c),this[_0x4a76ad(0x1f0)][_0x4a76ad(0x1a9)]('Rollback\x20completed\x20'+(_0x138f32?_0x4a76ad(0x1a7):_0x4a76ad(0x20b))+'.'),await this[_0x4a76ad(0x1f0)][_0x4a76ad(0x1f1)]();}async[a337_0x497f00(0x214)](){const _0x15e0f7=a337_0x497f00;try{this[_0x15e0f7(0x1d2)]=await this[_0x15e0f7(0x1f9)]();const _0x1658e7=await this['retrieveDeploymentResults']();await this['_logger'][_0x15e0f7(0x1f1)]();const _0x111f11=await this['createZip'](_0x1658e7),_0xe23ec3=await this['createVpk'](_0x111f11);await this[_0x15e0f7(0x1f0)][_0x15e0f7(0x1f1)]();const _0x1ba521=await this[_0x15e0f7(0x1b3)][_0x15e0f7(0x211)](_0xe23ec3);await this['_logger'][_0x15e0f7(0x1f1)]();const _0x2219c6=this['formFlosumDeploymentResults'](_0x1ba521[_0x15e0f7(0x198)]);await this[_0x15e0f7(0x220)](_0x2219c6),await this[_0x15e0f7(0x1aa)](_0x1ba521[_0x15e0f7(0x1df)],![],_0x1ba521[_0x15e0f7(0x1f4)]);}catch(_0x35e7a5){await this['finishRollbackWithError'](_0x35e7a5)['catch'](_0x386957=>this[_0x15e0f7(0x1f6)]['error'](_0x386957));}}}function a337_0x2b7a(){const _0x2d076a=['retrieveRecords','Activity_Item__c','logError','_instanceUrl','with\x20error','writeFile','\x27\x0a\x20\x20\x20\x20','_veevaService','type','./vpk.service','import','../classes/errors/salesforce-dml-error','text/plain','execute','Org__c','default','PackageImportService','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','status','VpkService','create','Is_Error__c','_connectionSalesforce','MetadataLogStatus','saveDeploymentResults','validate','2126OLLQsC','_salesforceService','10LKzYsq','map','toString','formFlosumDeploymentResults','_tempFolder','ENDPOINT_UPSERT_RECORD','_attachmentLogId','from','404075aoTCGJ','packageComponentList','</a>','Branch__c','length','retrieve','retrieveBackup','\x20:\x20','.zip','__importDefault','insertMultipleRecords','63yaVUFl','487304dbfrIY','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','slice','createZip','successfully','\x20>\x20','log','finishRollback','deploymentAction','577exuExo','\x20of\x20branch\x20to\x20Organization\x20','patch','Deployment','IdDeploymentResultRetriever','Deployment_Result__c','success','_packageImportService','Date__c','BACKUP_ZIP_NAME','errors','error','SalesforceDmlError','Deployment\x20Result','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','lastIndexOf','Veeva_Step_Name__c','PackageComponentStatus','SalesforceService','Save\x20Deployment\x20Results','13439701NYPKwi','apply','../../../core','saveLog','Body','Type__c','Save\x20log','Async_Request_Id__c','../classes/rollback/zip-creator.rollback','bind','RollbackService','_vpkService','Action__c','Create\x20Vpk\x20package','__esModule','retrieveDeploymentResults','values','../../../constants','_metadataLog','fetchAttachmentsDetailsById','../../shared/utils/fetch-attachments','veeva-rollback','./package-import.service','../constants/flosum.constants','retrieveAttachments','ZipCreatorRollback','post','VeevaService','_parentMetadataLogId','defineProperty','_timeZone','isDeployed','constructor','COMPLETED','Veeva\x20Rollback\x20(Deployment)','Component_Type__c','../enums/status.enums','createVpk','\x20</a>','Retrieve\x20Backup','950442vidQXn','name','FlosumConstants','DEPLOYED','354987qOInEJ','stepName','Status__c','Job_Completed__c','_logger','updateLog','233512oSnshK','<a\x20href=','packageId','generate','_systemLogger','./salesforce.service','../classes/retrievers/deployment-results/id.deployment-result.retriever','retrieveMetadataLog','(((.+)+)+)+$','Result__c','Success','_componentIds','organizationId','FLOSUM_NAMESPACE','_metadataLogId','Failure','Cannot\x20find\x20Deployment\x20Results','10njKCkf','filter','Activity_Type__c','Succeed__c'];a337_0x2b7a=function(){return _0x2d076a;};return a337_0x2b7a();}exports['RollbackService']=RollbackService;