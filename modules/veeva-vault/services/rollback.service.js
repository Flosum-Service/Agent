const a405_0x468fd0=a405_0x2831;function a405_0x2831(_0x32251c,_0xd03108){const _0xa66a9f=a405_0x5d47();return a405_0x2831=function(_0x44424c,_0x2c519f){_0x44424c=_0x44424c-0x134;let _0x5d47ac=_0xa66a9f[_0x44424c];return _0x5d47ac;},a405_0x2831(_0x32251c,_0xd03108);}function a405_0x5d47(){const _0x87c97c=['Activity_Item__c','FLOSUM_NAMESPACE','veeva-rollback','/vpk__','\x20>\x20','</a>','catch','SalesforceService','packageId','_metadataLog','../classes/errors/salesforce-dml-error','Branch','1379lCrBrn','retrieveBackup','retrieve','fetchAttachmentsDetailsById','filter','../constants/flosum.constants','Deployment_Result__c','type','2933372jcwkCP','search','finishRollback','toString','Metadata_Log__c','Save\x20log','lastIndexOf','_tempFolder','Cannot\x20find\x20Backup\x20Zip','bind','status','text/plain','16838Kjmmst','post','Retrieve\x20Backup','1165253gsCxns','with\x20error','error','Result__c','External_Deployment_Id__c','retrieveDeploymentResults','__importDefault','RollbackService','retrieveAttachments','_logger','../dtos/metadata-log.dto','ZipCreatorRollback','Log__c','_connectionSalesforce','updateLog','flat','_salesforceService','./vpk.service','<a\x20href=','Body','2494134AtFTuS','errors','Date__c','successfully','Create\x20zip\x20from\x20backup','__esModule','../classes/retrievers/deployment-results/id.deployment-result.retriever','Job_Completed__c','_packageImportService','16512zQZZES','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','execute','_timeZone','length','finishRollbackWithError','shortid','./veeva.service','./package-import.service','Metadata_Log__c/','../../../constants','16CKPlKX','import','_veevaService','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','2388035KRJfKL','isDeployed','_parentMetadataLogId','TargetId__c','values','map','Save\x20Deployment\x20Results','apply','packageComponentList','SalesforceDmlError','./salesforce.service','saveDeploymentResults','PackageImportService','Form\x20Deployment\x20Results','Org__c','Action__c','create','Type__c','_systemLogger','organizationId','Success','log','MetadataLogStatus','Branch__c','\x20has\x20been\x20created.','.zip','_metadataLogId','_instanceUrl','Is_Error__c','Activity_Type__c','name','insertMultipleRecords','Logger','fs/promises','Deployment\x20Result','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','patch','88EEDqdg','IdDeploymentResultRetriever','default','retrieveRecords','Status__c','formFlosumDeploymentResults','stepName','BACKUP_ZIP_NAME','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','FlosumConstants','436840WcMVhh','retrieveMetadataLog','writeFile','_vpkService','ENDPOINT_UPSERT_RECORD','defineProperty','/Attachment','Deployment','\x27\x20AND\x20Name\x20=\x20\x27','saveLog','Retrieve\x20Deployment\x20Results','createZip','validate','381HVMxzc','../../shared/utils/fetch-attachments','\x27\x0a\x20\x20\x20\x20'];a405_0x5d47=function(){return _0x87c97c;};return a405_0x5d47();}(function(_0x386234,_0x2fadcc){const _0x329959=a405_0x2831,_0x533279=_0x386234();while(!![]){try{const _0x3fe4c0=parseInt(_0x329959(0x1bf))/0x1+parseInt(_0x329959(0x1bc))/0x2*(-parseInt(_0x329959(0x199))/0x3)+-parseInt(_0x329959(0x1b0))/0x4+parseInt(_0x329959(0x15d))/0x5+parseInt(_0x329959(0x14e))/0x6*(parseInt(_0x329959(0x1a8))/0x7)+parseInt(_0x329959(0x159))/0x8*(parseInt(_0x329959(0x145))/0x9)+parseInt(_0x329959(0x18c))/0xa*(-parseInt(_0x329959(0x182))/0xb);if(_0x3fe4c0===_0x2fadcc)break;else _0x533279['push'](_0x533279['shift']());}catch(_0x4c4a61){_0x533279['push'](_0x533279['shift']());}}}(a405_0x5d47,0x8f5dc));const a405_0x2c519f=(function(){let _0x2b89a3=!![];return function(_0xe8e8e4,_0xec7c88){const _0x28572f=_0x2b89a3?function(){const _0x5efbf4=a405_0x2831;if(_0xec7c88){const _0x4eb2d8=_0xec7c88[_0x5efbf4(0x164)](_0xe8e8e4,arguments);return _0xec7c88=null,_0x4eb2d8;}}:function(){};return _0x2b89a3=![],_0x28572f;};}()),a405_0x44424c=a405_0x2c519f(this,function(){const _0xbd5b9d=a405_0x2831;return a405_0x44424c[_0xbd5b9d(0x1b3)]()[_0xbd5b9d(0x1b1)]('(((.+)+)+)+$')[_0xbd5b9d(0x1b3)]()['constructor'](a405_0x44424c)[_0xbd5b9d(0x1b1)]('(((.+)+)+)+$');});a405_0x44424c();'use strict';var __importDefault=this&&this[a405_0x468fd0(0x137)]||function(_0x16b752){const _0x238b0a=a405_0x468fd0;return _0x16b752&&_0x16b752[_0x238b0a(0x14a)]?_0x16b752:{'default':_0x16b752};};Object[a405_0x468fd0(0x191)](exports,a405_0x468fd0(0x14a),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a405_0x468fd0(0x155)),salesforce_service_1=require(a405_0x468fd0(0x167)),package_import_service_1=require(a405_0x468fd0(0x156)),id_deployment_result_retriever_1=require(a405_0x468fd0(0x14b)),flosum_constants_1=require(a405_0x468fd0(0x1ad)),fetch_attachments_1=require(a405_0x468fd0(0x19a)),constants_1=require(a405_0x468fd0(0x158)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a405_0x468fd0(0x154))),promises_1=require(a405_0x468fd0(0x17e)),vpk_service_1=require(a405_0x468fd0(0x142)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a405_0x468fd0(0x1a6)),metadata_log_dto_1=require(a405_0x468fd0(0x13b)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x21bc88,connectionVeeva:_0x86b3d,logger:_0x5bb03f,tempFolder:_0x176837,instanceUrl:_0x2ebed7,timeZone:_0x271e6f,metadataLogId:_0x279e3d,attachmentLogId:_0x3a844d,parentMetadataLogId:_0x142c4d,componentIds:_0x11b452}){const _0x9f33e6=a405_0x468fd0;this['_connectionSalesforce']=_0x21bc88,this['_connectionVeeva']=_0x86b3d,this[_0x9f33e6(0x13a)]=_0x5bb03f,this['_tempFolder']=_0x176837,this['_instanceUrl']=_0x2ebed7,this[_0x9f33e6(0x151)]=_0x271e6f,this[_0x9f33e6(0x177)]=_0x279e3d,this['_attachmentLogId']=_0x3a844d,this[_0x9f33e6(0x15f)]=_0x142c4d,this['_componentIds']=_0x11b452,this[_0x9f33e6(0x16f)]=new core_1[(_0x9f33e6(0x17d))](_0x9f33e6(0x19e)),this[_0x9f33e6(0x15b)]=new veeva_service_1['VeevaService']({'connection':_0x86b3d,'logger':_0x5bb03f}),this[_0x9f33e6(0x141)]=new salesforce_service_1[(_0x9f33e6(0x1a3))]({'connection':_0x21bc88}),this[_0x9f33e6(0x14d)]=new package_import_service_1[(_0x9f33e6(0x169))]({'veevaService':this[_0x9f33e6(0x15b)],'connection':_0x86b3d,'logger':_0x5bb03f,'saveLog':this[_0x9f33e6(0x195)][_0x9f33e6(0x1b9)](this)}),this[_0x9f33e6(0x18f)]=new vpk_service_1['VpkService']({'connection':_0x86b3d});}async['saveLog'](_0x52ac62,_0x4559fb){const _0x30409f=a405_0x468fd0;this['_logger']['log'](_0x30409f(0x1b5));const _0x116fd6={'Body':Buffer['from'](_0x52ac62)[_0x30409f(0x1b3)]('base64'),'ContentType':_0x30409f(0x1bb),'ParentId':this[_0x30409f(0x177)],'Name':_0x4559fb};await this[_0x30409f(0x13e)][_0x30409f(0x1bd)](flosum_constants_1[_0x30409f(0x18b)][_0x30409f(0x190)]+_0x30409f(0x192),_0x116fd6);}async[a405_0x468fd0(0x18d)](){const _0x139d18=a405_0x468fd0;this[_0x139d18(0x13a)][_0x139d18(0x172)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x77630f]=await this[_0x139d18(0x141)][_0x139d18(0x185)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x139d18(0x19d)]+_0x139d18(0x14f)+constants_1[_0x139d18(0x19d)]+_0x139d18(0x18a)+constants_1[_0x139d18(0x19d)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x139d18(0x19d)]+_0x139d18(0x15c)+this['_metadataLogId']+_0x139d18(0x19b));return new metadata_log_dto_1['MetadataLogDto'](_0x77630f);}async[a405_0x468fd0(0x136)](){const _0x369ca9=a405_0x468fd0;this['_logger'][_0x369ca9(0x172)](_0x369ca9(0x196));const _0x47cf4e=await new id_deployment_result_retriever_1[(_0x369ca9(0x183))]({'salesforceService':this[_0x369ca9(0x141)],'value':this['_componentIds']})[_0x369ca9(0x1aa)]();if(!_0x47cf4e[_0x369ca9(0x152)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x47cf4e;}async[a405_0x468fd0(0x1a9)](){const _0x382a52=a405_0x468fd0;this[_0x382a52(0x13a)][_0x382a52(0x172)](_0x382a52(0x1be));const _0x523efd=await this[_0x382a52(0x141)][_0x382a52(0x185)](_0x382a52(0x180)+this[_0x382a52(0x15f)]+_0x382a52(0x194)+flosum_constants_1[_0x382a52(0x18b)][_0x382a52(0x189)]+'\x27\x0a\x20\x20\x20\x20'),_0x5bdcdd=await(0x0,fetch_attachments_1[_0x382a52(0x1ab)])(this['_connectionSalesforce'],[_0x523efd[0x0]['Id']]),_0x383f1d=await(0x0,fetch_attachments_1[_0x382a52(0x139)])(_0x5bdcdd,this[_0x382a52(0x13e)]);if(!_0x383f1d[_0x382a52(0x152)])throw new Error(_0x382a52(0x1b8));return _0x383f1d[0x0][_0x382a52(0x161)][_0x382a52(0x144)];}async[a405_0x468fd0(0x197)](_0x3e2793){const _0x3cd882=a405_0x468fd0;this[_0x3cd882(0x13a)][_0x3cd882(0x172)](_0x3cd882(0x149));const _0x306725=await this[_0x3cd882(0x1a9)](),_0x5afdde=await new zip_creator_rollback_1[(_0x3cd882(0x13c))]({'rollbackName':this['_metadataLog']['name'],'backup':_0x306725,'deploymentResults':_0x3e2793})[_0x3cd882(0x16d)](),_0x1fe5c6=this[_0x3cd882(0x1b7)]+'/'+(0x0,shortid_1[_0x3cd882(0x184)])()+_0x3cd882(0x176);return await(0x0,promises_1[_0x3cd882(0x18e)])(_0x1fe5c6,_0x5afdde),_0x1fe5c6;}async['createVpk'](_0x31ab66){const _0x248fa2=a405_0x468fd0;this[_0x248fa2(0x13a)]['log']('Create\x20Vpk\x20package');const _0x1bdb00=await this[_0x248fa2(0x18f)]['generate'](_0x31ab66),_0x45269e=this[_0x248fa2(0x1b7)]+_0x248fa2(0x19f)+_0x31ab66['slice'](_0x31ab66[_0x248fa2(0x1b6)]('/')+0x1);return await(0x0,promises_1[_0x248fa2(0x18e)])(_0x45269e,_0x1bdb00),await this[_0x248fa2(0x18f)][_0x248fa2(0x198)](_0x45269e),_0x45269e;}[a405_0x468fd0(0x187)](_0x3e3d86){const _0xcaa0e=a405_0x468fd0;return this[_0xcaa0e(0x13a)][_0xcaa0e(0x172)](_0xcaa0e(0x16a)),_0x3e3d86[_0xcaa0e(0x162)](_0x36fc65=>{const _0x5e0643=_0xcaa0e;return this[_0x5e0643(0x13a)]['log'](_0x36fc65[_0x5e0643(0x1af)]+'.'+_0x36fc65[_0x5e0643(0x17b)]+'\x20:\x20'+_0x36fc65['status']),{[constants_1[_0x5e0643(0x19d)]+_0x5e0643(0x16e)]:_0x5e0643(0x17f),[constants_1[_0x5e0643(0x19d)]+_0x5e0643(0x186)]:_0x36fc65[_0x5e0643(0x1ba)]===status_enums_1['PackageComponentStatus']['DEPLOYED']?_0x5e0643(0x171):'Failure',[constants_1['FLOSUM_NAMESPACE']+_0x5e0643(0x134)]:_0x36fc65['deploymentAction'],[constants_1[_0x5e0643(0x19d)]+'Component_Name__c']:_0x36fc65[_0x5e0643(0x17b)],[constants_1[_0x5e0643(0x19d)]+'Component_Type__c']:_0x36fc65[_0x5e0643(0x1af)],[constants_1[_0x5e0643(0x19d)]+'Veeva_Step_Name__c']:_0x36fc65[_0x5e0643(0x188)],[constants_1[_0x5e0643(0x19d)]+_0x5e0643(0x16b)]:this['_metadataLog'][_0x5e0643(0x170)],[constants_1[_0x5e0643(0x19d)]+_0x5e0643(0x1b4)]:this['_metadataLogId']};});}async[a405_0x468fd0(0x168)](_0x55c13e){const _0x3acce7=a405_0x468fd0;this['_logger']['log'](_0x3acce7(0x163));const _0x165b60=await this['_salesforceService'][_0x3acce7(0x17c)](constants_1[_0x3acce7(0x19d)]+_0x3acce7(0x1ae),_0x55c13e),_0x3fdc0a=_0x165b60[_0x3acce7(0x1ac)](_0x4b22b8=>!_0x4b22b8['success'])['map'](_0x471cc1=>_0x471cc1[_0x3acce7(0x146)])[_0x3acce7(0x140)]();if(_0x3fdc0a['length'])throw new salesforce_dml_error_1[(_0x3acce7(0x166))](_0x3fdc0a);}async[a405_0x468fd0(0x153)](_0x160562){const _0x2f2086=a405_0x468fd0;if(!this[_0x2f2086(0x1a5)]){this['_systemLogger'][_0x2f2086(0x1c1)](_0x160562);return;}this['_logger']['logError'](_0x160562),await this[_0x2f2086(0x13a)]['updateLog'](),await this[_0x2f2086(0x1b2)](![],!![],'');}async[a405_0x468fd0(0x1b2)](_0x98db92,_0x293858,_0x4ae741){const _0x4bd328=a405_0x468fd0,{id:_0x38ed70,organizationId:_0x294460,branchId:_0x1952ff,organizationName:_0xa3f419}=this['_metadataLog'],_0x27752c=_0x4bd328(0x143)+this[_0x4bd328(0x178)]+'/'+_0x38ed70+_0x4bd328(0x1a0)+'Veeva\x20Rollback\x20(Deployment)'+'\x20</a>',_0x527a49=_0x4bd328(0x143)+this[_0x4bd328(0x178)]+'/'+_0x294460+'\x20>'+_0xa3f419+_0x4bd328(0x1a1),_0x3d7479=_0x27752c+'\x20of\x20branch\x20to\x20Organization\x20'+_0x527a49+_0x4bd328(0x175),_0x4dadb5={[constants_1['FLOSUM_NAMESPACE']+_0x4bd328(0x16c)]:_0x3d7479,[constants_1['FLOSUM_NAMESPACE']+_0x4bd328(0x147)]:new Date(),[constants_1[_0x4bd328(0x19d)]+_0x4bd328(0x174)]:_0x1952ff,[constants_1[_0x4bd328(0x19d)]+_0x4bd328(0x19c)]:_0x4bd328(0x1a7),[constants_1['FLOSUM_NAMESPACE']+_0x4bd328(0x17a)]:_0x4bd328(0x193),[constants_1[_0x4bd328(0x19d)]+_0x4bd328(0x160)]:_0x294460},_0x3e22ec={[constants_1[_0x4bd328(0x19d)]+_0x4bd328(0x179)]:!_0x98db92,[constants_1[_0x4bd328(0x19d)]+'Succeed__c']:_0x98db92,[constants_1[_0x4bd328(0x19d)]+_0x4bd328(0x186)]:_0x293858?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x4bd328(0x173)]['COMPLETED'],[constants_1[_0x4bd328(0x19d)]+_0x4bd328(0x14c)]:!![],[constants_1[_0x4bd328(0x19d)]+_0x4bd328(0x135)]:_0x4ae741};await this[_0x4bd328(0x13e)][_0x4bd328(0x181)](flosum_constants_1[_0x4bd328(0x18b)][_0x4bd328(0x190)]+'/'+constants_1[_0x4bd328(0x19d)]+_0x4bd328(0x157)+this[_0x4bd328(0x177)],_0x3e22ec),await this[_0x4bd328(0x13e)][_0x4bd328(0x1bd)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x4bd328(0x13d),_0x4dadb5),this[_0x4bd328(0x13a)][_0x4bd328(0x172)]('Rollback\x20completed\x20'+(_0x98db92?_0x4bd328(0x148):_0x4bd328(0x1c0))+'.'),await this[_0x4bd328(0x13a)][_0x4bd328(0x13f)]();}async[a405_0x468fd0(0x150)](){const _0x520cb3=a405_0x468fd0;try{this[_0x520cb3(0x1a5)]=await this[_0x520cb3(0x18d)]();const _0x7255f6=await this[_0x520cb3(0x136)]();await this[_0x520cb3(0x13a)]['updateLog']();const _0x9d6c74=await this[_0x520cb3(0x197)](_0x7255f6),_0x3c6833=await this['createVpk'](_0x9d6c74);await this['_logger'][_0x520cb3(0x13f)]();const _0x16ed27=await this[_0x520cb3(0x14d)][_0x520cb3(0x15a)](_0x3c6833);await this[_0x520cb3(0x13a)][_0x520cb3(0x13f)]();const _0x15ae9a=this[_0x520cb3(0x187)](_0x16ed27[_0x520cb3(0x165)]);await this[_0x520cb3(0x168)](_0x15ae9a),await this[_0x520cb3(0x1b2)](_0x16ed27[_0x520cb3(0x15e)],![],_0x16ed27[_0x520cb3(0x1a4)]);}catch(_0x3bbc6e){await this[_0x520cb3(0x153)](_0x3bbc6e)[_0x520cb3(0x1a2)](_0x2a4d53=>this[_0x520cb3(0x16f)][_0x520cb3(0x1c1)](_0x2a4d53));}}}exports[a405_0x468fd0(0x138)]=RollbackService;