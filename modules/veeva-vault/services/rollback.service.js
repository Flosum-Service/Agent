const a337_0x290a3f=a337_0x4fb9;function a337_0x40e4(){const _0x48f500=['default','_metadataLogId','../../shared/utils/fetch-attachments','map','19770Llrlnd','PackageImportService','EXCEPTION','Retrieve\x20Deployment\x20Results','../classes/retrievers/deployment-results/id.deployment-result.retriever','Create\x20Vpk\x20package','./vpk.service','6bIEKqi','createZip','Deployment','Save\x20log','../constants/flosum.constants','Status__c','Result__c','defineProperty','6753810KizNQv','updateLog','retrieveDeploymentResults','__importDefault','retrieveAttachments','__esModule','name','COMPLETED','../classes/rollback/zip-creator.rollback','success','Success','MetadataLogStatus','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','create','PackageComponentStatus','Is_Error__c','8bZVOnX','MetadataLogDto','Veeva\x20Rollback\x20(Deployment)','3410813KXbhpL','retrieve','Activity_Item__c','_veevaService','saveDeploymentResults','packageId','../enums/status.enums','Component_Type__c','fetchAttachmentsDetailsById','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','insertMultipleRecords','VpkService','Failure','.zip','shortid','Retrieve\x20Metadata\x20Log\x20info','8684829TadBpa','../dtos/metadata-log.dto','_timeZone','Deployment\x20Result','Job_Completed__c','veeva-rollback','Log__c','(((.+)+)+)+$','createVpk','\x20has\x20been\x20created.','../classes/errors/salesforce-dml-error','</a>','logError','generate','writeFile','Metadata_Log__c','apply','retrieveRecords','import','./veeva.service','IdDeploymentResultRetriever','./package-import.service','lastIndexOf','SalesforceService','Body','<a\x20href=','Branch__c','saveLog','DEPLOYED','Save\x20Deployment\x20Results','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','filter','type','Type__c','_instanceUrl','toString','_connectionSalesforce','FLOSUM_NAMESPACE','TargetId__c','values','Cannot\x20find\x20Backup\x20Zip','FlosumConstants','_vpkService','retrieveMetadataLog','base64','_parentMetadataLogId','search','3122226IxNFFr','with\x20error','1PzlhTO','deploymentAction','_metadataLog','_componentIds','_systemLogger','./salesforce.service','\x27\x0a\x20\x20\x20\x20','catch','_connectionVeeva','successfully','finishRollback','/Attachment','\x20:\x20','slice','487932pHxryO','../../../core','validate','flat','858815VBWzvl','log','Rollback\x20completed\x20','Metadata_Log__c/','post','\x20>\x20','_tempFolder','length','../../../constants','formFlosumDeploymentResults','error','ENDPOINT_UPSERT_RECORD','\x27\x20AND\x20Name\x20=\x20\x27','_packageImportService','_salesforceService','status','_logger','Create\x20zip\x20from\x20backup','Logger','bind','stepName','Cannot\x20find\x20Deployment\x20Results'];a337_0x40e4=function(){return _0x48f500;};return a337_0x40e4();}(function(_0x8289af,_0x438efa){const _0x27d27c=a337_0x4fb9,_0x22e9a8=_0x8289af();while(!![]){try{const _0x5171df=parseInt(_0x27d27c(0x271))/0x1*(parseInt(_0x27d27c(0x20d))/0x2)+parseInt(_0x27d27c(0x26f))/0x3+-parseInt(_0x27d27c(0x27f))/0x4+parseInt(_0x27d27c(0x1f3))/0x5*(-parseInt(_0x27d27c(0x214))/0x6)+-parseInt(_0x27d27c(0x230))/0x7+-parseInt(_0x27d27c(0x22d))/0x8*(-parseInt(_0x27d27c(0x240))/0x9)+-parseInt(_0x27d27c(0x21c))/0xa;if(_0x5171df===_0x438efa)break;else _0x22e9a8['push'](_0x22e9a8['shift']());}catch(_0x4386f7){_0x22e9a8['push'](_0x22e9a8['shift']());}}}(a337_0x40e4,0x88876));const a337_0x3065d2=(function(){let _0x1a6b01=!![];return function(_0x2f5cba,_0x19f0d9){const _0x3c973f=_0x1a6b01?function(){const _0x5079e7=a337_0x4fb9;if(_0x19f0d9){const _0x4b210b=_0x19f0d9[_0x5079e7(0x250)](_0x2f5cba,arguments);return _0x19f0d9=null,_0x4b210b;}}:function(){};return _0x1a6b01=![],_0x3c973f;};}()),a337_0xc0ed6a=a337_0x3065d2(this,function(){const _0x3a1a67=a337_0x4fb9;return a337_0xc0ed6a[_0x3a1a67(0x263)]()['search']('(((.+)+)+)+$')[_0x3a1a67(0x263)]()['constructor'](a337_0xc0ed6a)[_0x3a1a67(0x26e)](_0x3a1a67(0x247));});a337_0xc0ed6a();'use strict';var __importDefault=this&&this[a337_0x290a3f(0x21f)]||function(_0x295e27){const _0x5af2b1=a337_0x290a3f;return _0x295e27&&_0x295e27[_0x5af2b1(0x221)]?_0x295e27:{'default':_0x295e27};};Object[a337_0x290a3f(0x21b)](exports,a337_0x290a3f(0x221),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a337_0x290a3f(0x253)),salesforce_service_1=require(a337_0x290a3f(0x276)),package_import_service_1=require(a337_0x290a3f(0x255)),id_deployment_result_retriever_1=require(a337_0x290a3f(0x211)),flosum_constants_1=require(a337_0x290a3f(0x218)),fetch_attachments_1=require(a337_0x290a3f(0x20b)),constants_1=require(a337_0x290a3f(0x1fb)),zip_creator_rollback_1=require(a337_0x290a3f(0x224)),shortid_1=__importDefault(require(a337_0x290a3f(0x23e))),promises_1=require('fs/promises'),vpk_service_1=require(a337_0x290a3f(0x213)),status_enums_1=require(a337_0x290a3f(0x236)),salesforce_dml_error_1=require(a337_0x290a3f(0x24a)),metadata_log_dto_1=require(a337_0x290a3f(0x241)),core_1=require(a337_0x290a3f(0x280));class RollbackService{constructor({connectionSalesforce:_0x3d6d22,connectionVeeva:_0x54bdb2,logger:_0x20ad0a,tempFolder:_0x4d38e2,instanceUrl:_0x3794b8,timeZone:_0x1f07f1,metadataLogId:_0x452bc7,attachmentLogId:_0x575b17,parentMetadataLogId:_0x53f995,componentIds:_0x366916}){const _0x43a0c2=a337_0x290a3f;this['_connectionSalesforce']=_0x3d6d22,this[_0x43a0c2(0x279)]=_0x54bdb2,this['_logger']=_0x20ad0a,this[_0x43a0c2(0x1f9)]=_0x4d38e2,this[_0x43a0c2(0x262)]=_0x3794b8,this[_0x43a0c2(0x242)]=_0x1f07f1,this[_0x43a0c2(0x20a)]=_0x452bc7,this['_attachmentLogId']=_0x575b17,this[_0x43a0c2(0x26d)]=_0x53f995,this[_0x43a0c2(0x274)]=_0x366916,this['_systemLogger']=new core_1[(_0x43a0c2(0x205))](_0x43a0c2(0x245)),this[_0x43a0c2(0x233)]=new veeva_service_1['VeevaService']({'connection':_0x54bdb2,'logger':_0x20ad0a}),this['_salesforceService']=new salesforce_service_1[(_0x43a0c2(0x257))]({'connection':_0x3d6d22}),this[_0x43a0c2(0x200)]=new package_import_service_1[(_0x43a0c2(0x20e))]({'veevaService':this[_0x43a0c2(0x233)],'connection':_0x54bdb2,'logger':_0x20ad0a,'saveLog':this[_0x43a0c2(0x25b)][_0x43a0c2(0x206)](this)}),this[_0x43a0c2(0x26a)]=new vpk_service_1[(_0x43a0c2(0x23b))]({'connection':_0x54bdb2});}async['saveLog'](_0x959a7e,_0x26d5dd){const _0x2affc6=a337_0x290a3f;this[_0x2affc6(0x203)]['log'](_0x2affc6(0x217));const _0x3287a9={'Body':Buffer['from'](_0x959a7e)[_0x2affc6(0x263)](_0x2affc6(0x26c)),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x26d5dd};await this[_0x2affc6(0x264)][_0x2affc6(0x1f7)](flosum_constants_1[_0x2affc6(0x269)][_0x2affc6(0x1fe)]+_0x2affc6(0x27c),_0x3287a9);}async[a337_0x290a3f(0x26b)](){const _0x79053=a337_0x290a3f;this[_0x79053(0x203)][_0x79053(0x1f4)](_0x79053(0x23f));const [_0x4c2e07]=await this[_0x79053(0x201)]['retrieveRecords'](_0x79053(0x228)+constants_1['FLOSUM_NAMESPACE']+_0x79053(0x239)+constants_1[_0x79053(0x265)]+_0x79053(0x229)+constants_1[_0x79053(0x265)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1['FLOSUM_NAMESPACE']+_0x79053(0x25e)+this[_0x79053(0x20a)]+_0x79053(0x277));return new metadata_log_dto_1[(_0x79053(0x22e))](_0x4c2e07);}async[a337_0x290a3f(0x21e)](){const _0x26943e=a337_0x290a3f;this[_0x26943e(0x203)][_0x26943e(0x1f4)](_0x26943e(0x210));const _0x2f0d8d=await new id_deployment_result_retriever_1[(_0x26943e(0x254))]({'salesforceService':this['_salesforceService'],'value':this[_0x26943e(0x274)]})[_0x26943e(0x231)]();if(!_0x2f0d8d[_0x26943e(0x1fa)])throw new Error(_0x26943e(0x208));return _0x2f0d8d;}async['retrieveBackup'](){const _0x2674ec=a337_0x290a3f;this[_0x2674ec(0x203)][_0x2674ec(0x1f4)]('Retrieve\x20Backup');const _0x171d6e=await this[_0x2674ec(0x201)][_0x2674ec(0x251)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x2674ec(0x26d)]+_0x2674ec(0x1ff)+flosum_constants_1[_0x2674ec(0x269)]['BACKUP_ZIP_NAME']+'\x27\x0a\x20\x20\x20\x20'),_0x11c508=await(0x0,fetch_attachments_1[_0x2674ec(0x238)])(this[_0x2674ec(0x264)],[_0x171d6e[0x0]['Id']]),_0x520cd6=await(0x0,fetch_attachments_1[_0x2674ec(0x220)])(_0x11c508,this[_0x2674ec(0x264)]);if(!_0x520cd6[_0x2674ec(0x1fa)])throw new Error(_0x2674ec(0x268));return _0x520cd6[0x0][_0x2674ec(0x267)][_0x2674ec(0x258)];}async[a337_0x290a3f(0x215)](_0x3431df){const _0x38e47b=a337_0x290a3f;this[_0x38e47b(0x203)][_0x38e47b(0x1f4)](_0x38e47b(0x204));const _0xb9c2d0=await this['retrieveBackup'](),_0x1c3a41=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this['_metadataLog'][_0x38e47b(0x222)],'backup':_0xb9c2d0,'deploymentResults':_0x3431df})[_0x38e47b(0x22a)](),_0x29ffe6=this[_0x38e47b(0x1f9)]+'/'+(0x0,shortid_1[_0x38e47b(0x209)])()+_0x38e47b(0x23d);return await(0x0,promises_1[_0x38e47b(0x24e)])(_0x29ffe6,_0x1c3a41),_0x29ffe6;}async[a337_0x290a3f(0x248)](_0x41e576){const _0x378b62=a337_0x290a3f;this[_0x378b62(0x203)][_0x378b62(0x1f4)](_0x378b62(0x212));const _0x3c3b46=await this['_vpkService'][_0x378b62(0x24d)](_0x41e576),_0x35e272=this[_0x378b62(0x1f9)]+'/vpk__'+_0x41e576[_0x378b62(0x27e)](_0x41e576[_0x378b62(0x256)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x35e272,_0x3c3b46),await this[_0x378b62(0x26a)][_0x378b62(0x281)](_0x35e272),_0x35e272;}['formFlosumDeploymentResults'](_0x1ca83d){const _0x2e069a=a337_0x290a3f;return this['_logger'][_0x2e069a(0x1f4)]('Form\x20Deployment\x20Results'),_0x1ca83d[_0x2e069a(0x20c)](_0x152b19=>{const _0xafca91=_0x2e069a;return this['_logger']['log'](_0x152b19[_0xafca91(0x260)]+'.'+_0x152b19[_0xafca91(0x222)]+_0xafca91(0x27d)+_0x152b19[_0xafca91(0x202)]),{[constants_1[_0xafca91(0x265)]+_0xafca91(0x261)]:_0xafca91(0x243),[constants_1['FLOSUM_NAMESPACE']+_0xafca91(0x219)]:_0x152b19[_0xafca91(0x202)]===status_enums_1[_0xafca91(0x22b)][_0xafca91(0x25c)]?_0xafca91(0x226):_0xafca91(0x23c),[constants_1[_0xafca91(0x265)]+_0xafca91(0x21a)]:_0x152b19[_0xafca91(0x272)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x152b19[_0xafca91(0x222)],[constants_1[_0xafca91(0x265)]+_0xafca91(0x237)]:_0x152b19['type'],[constants_1[_0xafca91(0x265)]+'Veeva_Step_Name__c']:_0x152b19[_0xafca91(0x207)],[constants_1[_0xafca91(0x265)]+'Org__c']:this[_0xafca91(0x273)]['organizationId'],[constants_1['FLOSUM_NAMESPACE']+_0xafca91(0x24f)]:this['_metadataLogId']};});}async[a337_0x290a3f(0x234)](_0x15ee7f){const _0x17b333=a337_0x290a3f;this[_0x17b333(0x203)][_0x17b333(0x1f4)](_0x17b333(0x25d));const _0x3e4057=await this[_0x17b333(0x201)][_0x17b333(0x23a)](constants_1[_0x17b333(0x265)]+'Deployment_Result__c',_0x15ee7f),_0x4373b4=_0x3e4057[_0x17b333(0x25f)](_0x25c189=>!_0x25c189[_0x17b333(0x225)])[_0x17b333(0x20c)](_0x14f7cc=>_0x14f7cc['errors'])[_0x17b333(0x1f2)]();if(_0x4373b4[_0x17b333(0x1fa)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x4373b4);}async['finishRollbackWithError'](_0xdfd9cc){const _0x2668d9=a337_0x290a3f;if(!this[_0x2668d9(0x273)]){this[_0x2668d9(0x275)]['error'](_0xdfd9cc);return;}this['_logger'][_0x2668d9(0x24c)](_0xdfd9cc),await this[_0x2668d9(0x203)][_0x2668d9(0x21d)](),await this[_0x2668d9(0x27b)](![],!![],'');}async[a337_0x290a3f(0x27b)](_0x5cc1ef,_0x53f3e4,_0x42e57a){const _0x1c13d5=a337_0x290a3f,{id:_0x954829,organizationId:_0x206bfb,branchId:_0x4516bf,organizationName:_0x512689}=this['_metadataLog'],_0x57638f='<a\x20href='+this['_instanceUrl']+'/'+_0x954829+_0x1c13d5(0x1f8)+_0x1c13d5(0x22f)+'\x20</a>',_0x4acd65=_0x1c13d5(0x259)+this[_0x1c13d5(0x262)]+'/'+_0x206bfb+'\x20>'+_0x512689+_0x1c13d5(0x24b),_0x351b79=_0x57638f+'\x20of\x20branch\x20to\x20Organization\x20'+_0x4acd65+_0x1c13d5(0x249),_0x541f2f={[constants_1[_0x1c13d5(0x265)]+'Action__c']:_0x351b79,[constants_1[_0x1c13d5(0x265)]+'Date__c']:new Date(),[constants_1[_0x1c13d5(0x265)]+_0x1c13d5(0x25a)]:_0x4516bf,[constants_1['FLOSUM_NAMESPACE']+_0x1c13d5(0x232)]:'Branch',[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0x1c13d5(0x216),[constants_1['FLOSUM_NAMESPACE']+_0x1c13d5(0x266)]:_0x206bfb},_0x46918d={[constants_1[_0x1c13d5(0x265)]+_0x1c13d5(0x22c)]:!_0x5cc1ef,[constants_1[_0x1c13d5(0x265)]+'Succeed__c']:_0x5cc1ef,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x53f3e4?status_enums_1[_0x1c13d5(0x227)][_0x1c13d5(0x20f)]:status_enums_1[_0x1c13d5(0x227)][_0x1c13d5(0x223)],[constants_1[_0x1c13d5(0x265)]+_0x1c13d5(0x244)]:!![],[constants_1['FLOSUM_NAMESPACE']+'Async_Request_Id__c']:_0x42e57a};await this[_0x1c13d5(0x264)]['patch'](flosum_constants_1[_0x1c13d5(0x269)][_0x1c13d5(0x1fe)]+'/'+constants_1[_0x1c13d5(0x265)]+_0x1c13d5(0x1f6)+this[_0x1c13d5(0x20a)],_0x46918d),await this['_connectionSalesforce'][_0x1c13d5(0x1f7)](flosum_constants_1[_0x1c13d5(0x269)][_0x1c13d5(0x1fe)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x1c13d5(0x246),_0x541f2f),this[_0x1c13d5(0x203)][_0x1c13d5(0x1f4)](_0x1c13d5(0x1f5)+(_0x5cc1ef?_0x1c13d5(0x27a):_0x1c13d5(0x270))+'.'),await this[_0x1c13d5(0x203)]['updateLog']();}async['execute'](){const _0x1c7856=a337_0x290a3f;try{this[_0x1c7856(0x273)]=await this[_0x1c7856(0x26b)]();const _0x3c95af=await this[_0x1c7856(0x21e)]();await this[_0x1c7856(0x203)][_0x1c7856(0x21d)]();const _0x2b04fb=await this[_0x1c7856(0x215)](_0x3c95af),_0x4de575=await this[_0x1c7856(0x248)](_0x2b04fb);await this['_logger']['updateLog']();const _0x532cda=await this[_0x1c7856(0x200)][_0x1c7856(0x252)](_0x4de575);await this[_0x1c7856(0x203)][_0x1c7856(0x21d)]();const _0x621008=this[_0x1c7856(0x1fc)](_0x532cda['packageComponentList']);await this[_0x1c7856(0x234)](_0x621008),await this['finishRollback'](_0x532cda['isDeployed'],![],_0x532cda[_0x1c7856(0x235)]);}catch(_0x478287){await this['finishRollbackWithError'](_0x478287)[_0x1c7856(0x278)](_0x12be00=>this[_0x1c7856(0x275)][_0x1c7856(0x1fd)](_0x12be00));}}}function a337_0x4fb9(_0x4fee0e,_0xba6b1d){const _0x3852ab=a337_0x40e4();return a337_0x4fb9=function(_0xc0ed6a,_0x3065d2){_0xc0ed6a=_0xc0ed6a-0x1f2;let _0x40e496=_0x3852ab[_0xc0ed6a];return _0x40e496;},a337_0x4fb9(_0x4fee0e,_0xba6b1d);}exports['RollbackService']=RollbackService;