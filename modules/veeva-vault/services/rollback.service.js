const a405_0x18d777=a405_0x39fa;(function(_0x8f0708,_0x242574){const _0x20e714=a405_0x39fa,_0x6c2873=_0x8f0708();while(!![]){try{const _0x2ffa30=-parseInt(_0x20e714(0x1a7))/0x1*(-parseInt(_0x20e714(0x214))/0x2)+parseInt(_0x20e714(0x1b1))/0x3*(-parseInt(_0x20e714(0x22e))/0x4)+parseInt(_0x20e714(0x1e7))/0x5+-parseInt(_0x20e714(0x20b))/0x6*(parseInt(_0x20e714(0x1f4))/0x7)+-parseInt(_0x20e714(0x20c))/0x8*(parseInt(_0x20e714(0x1b2))/0x9)+parseInt(_0x20e714(0x1cc))/0xa*(parseInt(_0x20e714(0x1c9))/0xb)+parseInt(_0x20e714(0x1dc))/0xc*(parseInt(_0x20e714(0x1e8))/0xd);if(_0x2ffa30===_0x242574)break;else _0x6c2873['push'](_0x6c2873['shift']());}catch(_0x15fe99){_0x6c2873['push'](_0x6c2873['shift']());}}}(a405_0x17a2,0x9b00c));const a405_0x379cf8=(function(){let _0x93b20e=!![];return function(_0x45e65d,_0x44241b){const _0x20297d=_0x93b20e?function(){const _0x50f7c4=a405_0x39fa;if(_0x44241b){const _0x37987f=_0x44241b[_0x50f7c4(0x21a)](_0x45e65d,arguments);return _0x44241b=null,_0x37987f;}}:function(){};return _0x93b20e=![],_0x20297d;};}()),a405_0x14e8d8=a405_0x379cf8(this,function(){const _0x3933fb=a405_0x39fa;return a405_0x14e8d8[_0x3933fb(0x1f6)]()[_0x3933fb(0x1bf)](_0x3933fb(0x1f9))[_0x3933fb(0x1f6)]()[_0x3933fb(0x1d7)](a405_0x14e8d8)[_0x3933fb(0x1bf)](_0x3933fb(0x1f9));});a405_0x14e8d8();'use strict';var __importDefault=this&&this[a405_0x18d777(0x1ef)]||function(_0x3422eb){const _0x318ec2=a405_0x18d777;return _0x3422eb&&_0x3422eb[_0x318ec2(0x1a8)]?_0x3422eb:{'default':_0x3422eb};};Object['defineProperty'](exports,a405_0x18d777(0x1a8),{'value':!![]}),exports[a405_0x18d777(0x1a3)]=void 0x0;function a405_0x17a2(){const _0x491f05=['lastIndexOf','IdDeploymentResultRetriever','success','flat','4152585zLNOVw','26VhVcNf','Activity_Item__c','_connectionVeeva','Action__c','_vpkService','Body','slice','__importDefault','../classes/retrievers/deployment-results/id.deployment-result.retriever','_metadataLog','_timeZone','./vpk.service','529613ZMtfkj','_packageImportService','toString','error','DEPLOYED','(((.+)+)+)+$','retrieveBackup','../enums/status.enums','retrieveMetadataLog','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','createVpk','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','SalesforceDmlError','create','_systemLogger','COMPLETED','formFlosumDeploymentResults','Type__c','packageComponentList','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','./veeva.service','generate','Save\x20Deployment\x20Results','54xiWvCE','632872AvfZBh','_componentIds','_attachmentLogId','from','length','_veevaService','base64','updateLog','28tKDrjX','filter','Veeva\x20Rollback\x20(Deployment)','Activity_Type__c','catch','FLOSUM_NAMESPACE','apply','Org__c','stepName','Component_Type__c','logError','BACKUP_ZIP_NAME','_parentMetadataLogId','Component_Name__c','Status__c','type','Metadata_Log__c/','_salesforceService','Retrieve\x20Backup','finishRollbackWithError','MetadataLogStatus','Deployment_Result__c','status','_instanceUrl','Job_Completed__c','map','748qqENxd','retrieveDeploymentResults','veeva-rollback','../dtos/metadata-log.dto','Branch','./package-import.service','Result__c','organizationId','RollbackService','Rollback\x20completed\x20','_logger','Cannot\x20find\x20Backup\x20Zip','9247GlpTQa','__esModule','createZip','\x27\x20AND\x20Name\x20=\x20\x27','shortid','Cannot\x20find\x20Deployment\x20Results','Deployment','isDeployed','packageId','ZipCreatorRollback','123wGipOX','108TIWoEr','../constants/flosum.constants','</a>','SalesforceService','MetadataLogDto','\x20>\x20','Retrieve\x20Deployment\x20Results','retrieveRecords','Metadata_Log__c','Succeed__c','writeFile','PackageImportService','../classes/rollback/zip-creator.rollback','search','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','bind','\x27\x0a\x20\x20\x20\x20','Deployment\x20Result','default','patch','retrieveAttachments','name','Logger','1436039xXNbdn','VpkService','Save\x20log','10FHCEat','finishRollback','successfully','_connectionSalesforce','validate','_metadataLogId','Create\x20Vpk\x20package','log','<a\x20href=','Is_Error__c','Date__c','constructor','PackageComponentStatus','execute','.zip','ENDPOINT_UPSERT_RECORD','7093644btZOlJ','fs/promises','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_tempFolder','saveLog','FlosumConstants','../classes/errors/salesforce-dml-error'];a405_0x17a2=function(){return _0x491f05;};return a405_0x17a2();}function a405_0x39fa(_0x122101,_0x178e1a){const _0x21ce87=a405_0x17a2();return a405_0x39fa=function(_0x14e8d8,_0x379cf8){_0x14e8d8=_0x14e8d8-0x19e;let _0x17a2c6=_0x21ce87[_0x14e8d8];return _0x17a2c6;},a405_0x39fa(_0x122101,_0x178e1a);}const veeva_service_1=require(a405_0x18d777(0x208)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a405_0x18d777(0x1a0)),id_deployment_result_retriever_1=require(a405_0x18d777(0x1f0)),flosum_constants_1=require(a405_0x18d777(0x1b3)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require('../../../constants'),zip_creator_rollback_1=require(a405_0x18d777(0x1be)),shortid_1=__importDefault(require(a405_0x18d777(0x1ab))),promises_1=require(a405_0x18d777(0x1dd)),vpk_service_1=require(a405_0x18d777(0x1f3)),status_enums_1=require(a405_0x18d777(0x1fb)),salesforce_dml_error_1=require(a405_0x18d777(0x1e2)),metadata_log_dto_1=require(a405_0x18d777(0x19e)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x1457f0,connectionVeeva:_0x1d1019,logger:_0x1d1ca7,tempFolder:_0x36f40a,instanceUrl:_0x33101a,timeZone:_0x24c865,metadataLogId:_0x2e93f9,attachmentLogId:_0x4a1099,parentMetadataLogId:_0x278a41,componentIds:_0x134eaf}){const _0x7c4714=a405_0x18d777;this[_0x7c4714(0x1cf)]=_0x1457f0,this[_0x7c4714(0x1ea)]=_0x1d1019,this[_0x7c4714(0x1a5)]=_0x1d1ca7,this[_0x7c4714(0x1df)]=_0x36f40a,this[_0x7c4714(0x22b)]=_0x33101a,this[_0x7c4714(0x1f2)]=_0x24c865,this[_0x7c4714(0x1d1)]=_0x2e93f9,this[_0x7c4714(0x20e)]=_0x4a1099,this[_0x7c4714(0x220)]=_0x278a41,this[_0x7c4714(0x20d)]=_0x134eaf,this[_0x7c4714(0x202)]=new core_1[(_0x7c4714(0x1c8))](_0x7c4714(0x230)),this['_veevaService']=new veeva_service_1['VeevaService']({'connection':_0x1d1019,'logger':_0x1d1ca7}),this[_0x7c4714(0x225)]=new salesforce_service_1[(_0x7c4714(0x1b5))]({'connection':_0x1457f0}),this[_0x7c4714(0x1f5)]=new package_import_service_1[(_0x7c4714(0x1bd))]({'veevaService':this[_0x7c4714(0x211)],'connection':_0x1d1019,'logger':_0x1d1ca7,'saveLog':this[_0x7c4714(0x1e0)][_0x7c4714(0x1c1)](this)}),this[_0x7c4714(0x1ec)]=new vpk_service_1[(_0x7c4714(0x1ca))]({'connection':_0x1d1019});}async[a405_0x18d777(0x1e0)](_0x337d6e,_0x336ac4){const _0x43479b=a405_0x18d777;this['_logger']['log'](_0x43479b(0x1cb));const _0x466046={'Body':Buffer[_0x43479b(0x20f)](_0x337d6e)[_0x43479b(0x1f6)](_0x43479b(0x212)),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x336ac4};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x43479b(0x1e1)][_0x43479b(0x1db)]+'/Attachment',_0x466046);}async[a405_0x18d777(0x1fc)](){const _0x225d33=a405_0x18d777;this[_0x225d33(0x1a5)][_0x225d33(0x1d3)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x45d888]=await this[_0x225d33(0x225)][_0x225d33(0x1b9)](_0x225d33(0x1ff)+constants_1['FLOSUM_NAMESPACE']+_0x225d33(0x1de)+constants_1['FLOSUM_NAMESPACE']+_0x225d33(0x1fd)+constants_1[_0x225d33(0x219)]+_0x225d33(0x207)+constants_1[_0x225d33(0x219)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x225d33(0x1d1)]+_0x225d33(0x1c2));return new metadata_log_dto_1[(_0x225d33(0x1b6))](_0x45d888);}async[a405_0x18d777(0x22f)](){const _0x568151=a405_0x18d777;this[_0x568151(0x1a5)]['log'](_0x568151(0x1b8));const _0x2845fa=await new id_deployment_result_retriever_1[(_0x568151(0x1e4))]({'salesforceService':this['_salesforceService'],'value':this['_componentIds']})['retrieve']();if(!_0x2845fa['length'])throw new Error(_0x568151(0x1ac));return _0x2845fa;}async[a405_0x18d777(0x1fa)](){const _0x4a5f64=a405_0x18d777;this[_0x4a5f64(0x1a5)][_0x4a5f64(0x1d3)](_0x4a5f64(0x226));const _0x2acd55=await this[_0x4a5f64(0x225)][_0x4a5f64(0x1b9)](_0x4a5f64(0x1c0)+this[_0x4a5f64(0x220)]+_0x4a5f64(0x1aa)+flosum_constants_1[_0x4a5f64(0x1e1)][_0x4a5f64(0x21f)]+'\x27\x0a\x20\x20\x20\x20'),_0x3b94aa=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x4a5f64(0x1cf)],[_0x2acd55[0x0]['Id']]),_0x3541b3=await(0x0,fetch_attachments_1[_0x4a5f64(0x1c6)])(_0x3b94aa,this['_connectionSalesforce']);if(!_0x3541b3[_0x4a5f64(0x210)])throw new Error(_0x4a5f64(0x1a6));return _0x3541b3[0x0]['values'][_0x4a5f64(0x1ed)];}async['createZip'](_0x5ff3f7){const _0x5da167=a405_0x18d777;this['_logger'][_0x5da167(0x1d3)]('Create\x20zip\x20from\x20backup');const _0x1ee798=await this[_0x5da167(0x1fa)](),_0x1e3d94=await new zip_creator_rollback_1[(_0x5da167(0x1b0))]({'rollbackName':this[_0x5da167(0x1f1)][_0x5da167(0x1c7)],'backup':_0x1ee798,'deploymentResults':_0x5ff3f7})[_0x5da167(0x201)](),_0xf1a84=this[_0x5da167(0x1df)]+'/'+(0x0,shortid_1[_0x5da167(0x1c4)])()+_0x5da167(0x1da);return await(0x0,promises_1[_0x5da167(0x1bc)])(_0xf1a84,_0x1e3d94),_0xf1a84;}async[a405_0x18d777(0x1fe)](_0x4a9ea9){const _0x4921ad=a405_0x18d777;this[_0x4921ad(0x1a5)][_0x4921ad(0x1d3)](_0x4921ad(0x1d2));const _0x18c6ef=await this['_vpkService'][_0x4921ad(0x209)](_0x4a9ea9),_0xbd8ba6=this[_0x4921ad(0x1df)]+'/vpk__'+_0x4a9ea9[_0x4921ad(0x1ee)](_0x4a9ea9[_0x4921ad(0x1e3)]('/')+0x1);return await(0x0,promises_1[_0x4921ad(0x1bc)])(_0xbd8ba6,_0x18c6ef),await this['_vpkService'][_0x4921ad(0x1d0)](_0xbd8ba6),_0xbd8ba6;}[a405_0x18d777(0x204)](_0x3ab2b3){const _0x24f674=a405_0x18d777;return this[_0x24f674(0x1a5)][_0x24f674(0x1d3)]('Form\x20Deployment\x20Results'),_0x3ab2b3['map'](_0x3fc133=>{const _0x229f95=_0x24f674;return this[_0x229f95(0x1a5)]['log'](_0x3fc133[_0x229f95(0x223)]+'.'+_0x3fc133['name']+'\x20:\x20'+_0x3fc133[_0x229f95(0x22a)]),{[constants_1[_0x229f95(0x219)]+_0x229f95(0x205)]:_0x229f95(0x1c3),[constants_1[_0x229f95(0x219)]+'Status__c']:_0x3fc133[_0x229f95(0x22a)]===status_enums_1[_0x229f95(0x1d8)][_0x229f95(0x1f8)]?'Success':'Failure',[constants_1[_0x229f95(0x219)]+_0x229f95(0x1a1)]:_0x3fc133['deploymentAction'],[constants_1['FLOSUM_NAMESPACE']+_0x229f95(0x221)]:_0x3fc133[_0x229f95(0x1c7)],[constants_1[_0x229f95(0x219)]+_0x229f95(0x21d)]:_0x3fc133[_0x229f95(0x223)],[constants_1[_0x229f95(0x219)]+'Veeva_Step_Name__c']:_0x3fc133[_0x229f95(0x21c)],[constants_1[_0x229f95(0x219)]+_0x229f95(0x21b)]:this[_0x229f95(0x1f1)][_0x229f95(0x1a2)],[constants_1[_0x229f95(0x219)]+_0x229f95(0x1ba)]:this[_0x229f95(0x1d1)]};});}async['saveDeploymentResults'](_0x49d531){const _0x43dc21=a405_0x18d777;this[_0x43dc21(0x1a5)]['log'](_0x43dc21(0x20a));const _0x14bd34=await this[_0x43dc21(0x225)]['insertMultipleRecords'](constants_1[_0x43dc21(0x219)]+_0x43dc21(0x229),_0x49d531),_0x4c8b3b=_0x14bd34[_0x43dc21(0x215)](_0x3c4f14=>!_0x3c4f14[_0x43dc21(0x1e5)])[_0x43dc21(0x22d)](_0xb42304=>_0xb42304['errors'])[_0x43dc21(0x1e6)]();if(_0x4c8b3b['length'])throw new salesforce_dml_error_1[(_0x43dc21(0x200))](_0x4c8b3b);}async['finishRollbackWithError'](_0xcaf1df){const _0x50cb7e=a405_0x18d777;if(!this['_metadataLog']){this['_systemLogger'][_0x50cb7e(0x1f7)](_0xcaf1df);return;}this['_logger'][_0x50cb7e(0x21e)](_0xcaf1df),await this['_logger'][_0x50cb7e(0x213)](),await this['finishRollback'](![],!![],'');}async[a405_0x18d777(0x1cd)](_0x2d493b,_0x4853e6,_0x4275b2){const _0x5a1d78=a405_0x18d777,{id:_0x170151,organizationId:_0x4b9af0,branchId:_0x6b15ee,organizationName:_0x7e76d9}=this[_0x5a1d78(0x1f1)],_0x57a5fd=_0x5a1d78(0x1d4)+this['_instanceUrl']+'/'+_0x170151+_0x5a1d78(0x1b7)+_0x5a1d78(0x216)+'\x20</a>',_0x5b3d05=_0x5a1d78(0x1d4)+this[_0x5a1d78(0x22b)]+'/'+_0x4b9af0+'\x20>'+_0x7e76d9+_0x5a1d78(0x1b4),_0x3e5f29=_0x57a5fd+'\x20of\x20branch\x20to\x20Organization\x20'+_0x5b3d05+'\x20has\x20been\x20created.',_0x2f708d={[constants_1['FLOSUM_NAMESPACE']+_0x5a1d78(0x1eb)]:_0x3e5f29,[constants_1[_0x5a1d78(0x219)]+_0x5a1d78(0x1d6)]:new Date(),[constants_1[_0x5a1d78(0x219)]+'Branch__c']:_0x6b15ee,[constants_1['FLOSUM_NAMESPACE']+_0x5a1d78(0x1e9)]:_0x5a1d78(0x19f),[constants_1[_0x5a1d78(0x219)]+_0x5a1d78(0x217)]:_0x5a1d78(0x1ad),[constants_1[_0x5a1d78(0x219)]+'TargetId__c']:_0x4b9af0},_0x375854={[constants_1['FLOSUM_NAMESPACE']+_0x5a1d78(0x1d5)]:!_0x2d493b,[constants_1[_0x5a1d78(0x219)]+_0x5a1d78(0x1bb)]:_0x2d493b,[constants_1[_0x5a1d78(0x219)]+_0x5a1d78(0x222)]:_0x4853e6?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x5a1d78(0x228)][_0x5a1d78(0x203)],[constants_1[_0x5a1d78(0x219)]+_0x5a1d78(0x22c)]:!![],[constants_1['FLOSUM_NAMESPACE']+'External_Deployment_Id__c']:_0x4275b2};await this[_0x5a1d78(0x1cf)][_0x5a1d78(0x1c5)](flosum_constants_1['FlosumConstants'][_0x5a1d78(0x1db)]+'/'+constants_1[_0x5a1d78(0x219)]+_0x5a1d78(0x224)+this['_metadataLogId'],_0x375854),await this[_0x5a1d78(0x1cf)]['post'](flosum_constants_1['FlosumConstants'][_0x5a1d78(0x1db)]+'/'+constants_1[_0x5a1d78(0x219)]+'Log__c',_0x2f708d),this[_0x5a1d78(0x1a5)][_0x5a1d78(0x1d3)](_0x5a1d78(0x1a4)+(_0x2d493b?_0x5a1d78(0x1ce):'with\x20error')+'.'),await this[_0x5a1d78(0x1a5)][_0x5a1d78(0x213)]();}async[a405_0x18d777(0x1d9)](){const _0x35b966=a405_0x18d777;try{this[_0x35b966(0x1f1)]=await this[_0x35b966(0x1fc)]();const _0x7d235d=await this[_0x35b966(0x22f)]();await this[_0x35b966(0x1a5)]['updateLog']();const _0xfa0805=await this[_0x35b966(0x1a9)](_0x7d235d),_0x515237=await this['createVpk'](_0xfa0805);await this[_0x35b966(0x1a5)][_0x35b966(0x213)]();const _0x34b3af=await this[_0x35b966(0x1f5)]['import'](_0x515237);await this[_0x35b966(0x1a5)]['updateLog']();const _0x2a61dc=this[_0x35b966(0x204)](_0x34b3af[_0x35b966(0x206)]);await this['saveDeploymentResults'](_0x2a61dc),await this[_0x35b966(0x1cd)](_0x34b3af[_0x35b966(0x1ae)],![],_0x34b3af[_0x35b966(0x1af)]);}catch(_0x58794d){await this[_0x35b966(0x227)](_0x58794d)[_0x35b966(0x218)](_0x3ab51b=>this[_0x35b966(0x202)][_0x35b966(0x1f7)](_0x3ab51b));}}}exports[a405_0x18d777(0x1a3)]=RollbackService;