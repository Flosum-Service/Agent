const a337_0x54caf0=a337_0x1115;(function(_0x5ec973,_0x2e2498){const _0x506f4f=a337_0x1115,_0x21fc18=_0x5ec973();while(!![]){try{const _0x504340=parseInt(_0x506f4f(0x155))/0x1+parseInt(_0x506f4f(0x154))/0x2*(parseInt(_0x506f4f(0x127))/0x3)+-parseInt(_0x506f4f(0x117))/0x4+parseInt(_0x506f4f(0x130))/0x5+parseInt(_0x506f4f(0x13a))/0x6+parseInt(_0x506f4f(0xde))/0x7+parseInt(_0x506f4f(0x114))/0x8*(-parseInt(_0x506f4f(0x152))/0x9);if(_0x504340===_0x2e2498)break;else _0x21fc18['push'](_0x21fc18['shift']());}catch(_0x316135){_0x21fc18['push'](_0x21fc18['shift']());}}}(a337_0x5607,0x61e1f));const a337_0x5a8ff7=(function(){let _0x105452=!![];return function(_0x1a694f,_0x1ab76b){const _0x987976=_0x105452?function(){if(_0x1ab76b){const _0x11e7fe=_0x1ab76b['apply'](_0x1a694f,arguments);return _0x1ab76b=null,_0x11e7fe;}}:function(){};return _0x105452=![],_0x987976;};}()),a337_0x232fbf=a337_0x5a8ff7(this,function(){const _0x3e0f3d=a337_0x1115;return a337_0x232fbf['toString']()['search'](_0x3e0f3d(0x122))[_0x3e0f3d(0x103)]()[_0x3e0f3d(0x11a)](a337_0x232fbf)[_0x3e0f3d(0xeb)](_0x3e0f3d(0x122));});a337_0x232fbf();'use strict';function a337_0x5607(){const _0x288ea1=['868782tKZaMC','\x20</a>','Succeed__c','Form\x20Deployment\x20Results','map','Create\x20Vpk\x20package','Status__c','VpkService','retrieveBackup','defineProperty','Type__c','COMPLETED','formFlosumDeploymentResults','createZip','Save\x20Deployment\x20Results','bind','../enums/status.enums','ENDPOINT_UPSERT_RECORD','EXCEPTION','Failure','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Deployment\x20Result','\x20>\x20','SalesforceService','9xuILJQ','_tempFolder','74QRAEhP','206345UbxZMC','_instanceUrl','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','_systemLogger','filter','ZipCreatorRollback','MetadataLogDto','updateLog','Action__c','TargetId__c','_veevaService','values','saveLog','patch','/vpk__','_packageImportService','retrieveAttachments','base64','_logger','_connectionSalesforce','Metadata_Log__c/','type','lastIndexOf','execute','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_metadataLog','5046699YUeIXJ','Result__c','./vpk.service','./package-import.service','../../../core','from','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','organizationId','__importDefault','Metadata_Log__c','Branch','retrieveMetadataLog','packageComponentList','search','default','log','\x20of\x20branch\x20to\x20Organization\x20','with\x20error','MetadataLogStatus','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Deployment_Result__c','../classes/rollback/zip-creator.rollback','Retrieve\x20Metadata\x20Log\x20info','\x27\x0a\x20\x20\x20\x20','Retrieve\x20Deployment\x20Results','error','finishRollback','../../../constants','../../shared/utils/fetch-attachments','Branch__c','_salesforceService','Success','_timeZone','finishRollbackWithError','fetchAttachmentsDetailsById','deploymentAction','Job_Completed__c','toString','retrieveRecords','stepName','Veeva_Step_Name__c','text/plain','createVpk','_metadataLogId','/Attachment','packageId','FlosumConstants','_vpkService','Date__c','isDeployed','Rollback\x20completed\x20','retrieve','flat','DEPLOYED','7529784bhhFrC','./salesforce.service','fs/promises','2206016bgtlye','shortid','retrieveDeploymentResults','constructor','post','status','_parentMetadataLogId','_connectionVeeva','Org__c','../dtos/metadata-log.dto','catch','(((.+)+)+)+$','RollbackService','\x20:\x20','generate','length','36504RGBYvN','../classes/errors/salesforce-dml-error','Deployment','.zip','writeFile','name','<a\x20href=','</a>','create','1856695zpLmHK','FLOSUM_NAMESPACE','successfully','errors','Logger','insertMultipleRecords','saveDeploymentResults','_componentIds','import','../classes/retrievers/deployment-results/id.deployment-result.retriever'];a337_0x5607=function(){return _0x288ea1;};return a337_0x5607();}var __importDefault=this&&this[a337_0x54caf0(0xe6)]||function(_0x4911c3){return _0x4911c3&&_0x4911c3['__esModule']?_0x4911c3:{'default':_0x4911c3};};Object[a337_0x54caf0(0x143)](exports,'__esModule',{'value':!![]}),exports[a337_0x54caf0(0x123)]=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a337_0x54caf0(0x115)),package_import_service_1=require(a337_0x54caf0(0xe1)),id_deployment_result_retriever_1=require(a337_0x54caf0(0x139)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a337_0x54caf0(0xfa)),constants_1=require(a337_0x54caf0(0xf9)),zip_creator_rollback_1=require(a337_0x54caf0(0xf3)),shortid_1=__importDefault(require(a337_0x54caf0(0x118))),promises_1=require(a337_0x54caf0(0x116)),vpk_service_1=require(a337_0x54caf0(0xe0)),status_enums_1=require(a337_0x54caf0(0x14a)),salesforce_dml_error_1=require(a337_0x54caf0(0x128)),metadata_log_dto_1=require(a337_0x54caf0(0x120)),core_1=require(a337_0x54caf0(0xe2));class RollbackService{constructor({connectionSalesforce:_0x5aa75a,connectionVeeva:_0x5b2f45,logger:_0x5b8ad8,tempFolder:_0x5ccb54,instanceUrl:_0x171a28,timeZone:_0x4231f0,metadataLogId:_0x3827fb,attachmentLogId:_0xc1fa86,parentMetadataLogId:_0x1f2081,componentIds:_0x5dfac9}){const _0x4a4f86=a337_0x54caf0;this['_connectionSalesforce']=_0x5aa75a,this[_0x4a4f86(0x11e)]=_0x5b2f45,this[_0x4a4f86(0x167)]=_0x5b8ad8,this[_0x4a4f86(0x153)]=_0x5ccb54,this[_0x4a4f86(0x156)]=_0x171a28,this[_0x4a4f86(0xfe)]=_0x4231f0,this['_metadataLogId']=_0x3827fb,this['_attachmentLogId']=_0xc1fa86,this[_0x4a4f86(0x11d)]=_0x1f2081,this[_0x4a4f86(0x137)]=_0x5dfac9,this[_0x4a4f86(0x158)]=new core_1[(_0x4a4f86(0x134))]('veeva-rollback'),this[_0x4a4f86(0x15f)]=new veeva_service_1['VeevaService']({'connection':_0x5b2f45,'logger':_0x5b8ad8}),this[_0x4a4f86(0xfc)]=new salesforce_service_1[(_0x4a4f86(0x151))]({'connection':_0x5aa75a}),this[_0x4a4f86(0x164)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x4a4f86(0x15f)],'connection':_0x5b2f45,'logger':_0x5b8ad8,'saveLog':this['saveLog'][_0x4a4f86(0x149)](this)}),this[_0x4a4f86(0x10d)]=new vpk_service_1[(_0x4a4f86(0x141))]({'connection':_0x5b2f45});}async[a337_0x54caf0(0x161)](_0x27a804,_0x683496){const _0x2a8cab=a337_0x54caf0;this['_logger'][_0x2a8cab(0xed)]('Save\x20log');const _0x59303e={'Body':Buffer[_0x2a8cab(0xe3)](_0x27a804)['toString'](_0x2a8cab(0x166)),'ContentType':_0x2a8cab(0x107),'ParentId':this[_0x2a8cab(0x109)],'Name':_0x683496};await this[_0x2a8cab(0x168)][_0x2a8cab(0x11b)](flosum_constants_1[_0x2a8cab(0x10c)][_0x2a8cab(0x14b)]+_0x2a8cab(0x10a),_0x59303e);}async[a337_0x54caf0(0xe9)](){const _0x2f98e3=a337_0x54caf0;this[_0x2f98e3(0x167)][_0x2f98e3(0xed)](_0x2f98e3(0xf4));const [_0x3cda0b]=await this[_0x2f98e3(0xfc)][_0x2f98e3(0x104)](_0x2f98e3(0x14e)+constants_1['FLOSUM_NAMESPACE']+_0x2f98e3(0xf1)+constants_1['FLOSUM_NAMESPACE']+_0x2f98e3(0xdc)+constants_1[_0x2f98e3(0x131)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x2f98e3(0x131)]+_0x2f98e3(0x157)+this[_0x2f98e3(0x109)]+_0x2f98e3(0xf5));return new metadata_log_dto_1[(_0x2f98e3(0x15b))](_0x3cda0b);}async[a337_0x54caf0(0x119)](){const _0xd36e24=a337_0x54caf0;this[_0xd36e24(0x167)][_0xd36e24(0xed)](_0xd36e24(0xf6));const _0x1f3f61=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0xd36e24(0xfc)],'value':this[_0xd36e24(0x137)]})[_0xd36e24(0x111)]();if(!_0x1f3f61[_0xd36e24(0x126)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x1f3f61;}async[a337_0x54caf0(0x142)](){const _0x238919=a337_0x54caf0;this['_logger']['log']('Retrieve\x20Backup');const _0x42a423=await this['_salesforceService'][_0x238919(0x104)](_0x238919(0xe4)+this['_parentMetadataLogId']+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0x238919(0x10c)]['BACKUP_ZIP_NAME']+_0x238919(0xf5)),_0x33edff=await(0x0,fetch_attachments_1[_0x238919(0x100)])(this['_connectionSalesforce'],[_0x42a423[0x0]['Id']]),_0x19cb99=await(0x0,fetch_attachments_1[_0x238919(0x165)])(_0x33edff,this[_0x238919(0x168)]);if(!_0x19cb99['length'])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x19cb99[0x0][_0x238919(0x160)]['Body'];}async['createZip'](_0x96659b){const _0x21db7b=a337_0x54caf0;this['_logger'][_0x21db7b(0xed)]('Create\x20zip\x20from\x20backup');const _0x465cc9=await this[_0x21db7b(0x142)](),_0x4219be=await new zip_creator_rollback_1[(_0x21db7b(0x15a))]({'rollbackName':this[_0x21db7b(0xdd)][_0x21db7b(0x12c)],'backup':_0x465cc9,'deploymentResults':_0x96659b})[_0x21db7b(0x12f)](),_0x364906=this['_tempFolder']+'/'+(0x0,shortid_1[_0x21db7b(0xec)])()+_0x21db7b(0x12a);return await(0x0,promises_1[_0x21db7b(0x12b)])(_0x364906,_0x4219be),_0x364906;}async[a337_0x54caf0(0x108)](_0x4af577){const _0x23be4c=a337_0x54caf0;this['_logger'][_0x23be4c(0xed)](_0x23be4c(0x13f));const _0x5c0a57=await this['_vpkService'][_0x23be4c(0x125)](_0x4af577),_0x11c9b4=this['_tempFolder']+_0x23be4c(0x163)+_0x4af577['slice'](_0x4af577[_0x23be4c(0xda)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x11c9b4,_0x5c0a57),await this['_vpkService']['validate'](_0x11c9b4),_0x11c9b4;}['formFlosumDeploymentResults'](_0x4fce64){const _0x12c487=a337_0x54caf0;return this[_0x12c487(0x167)][_0x12c487(0xed)](_0x12c487(0x13d)),_0x4fce64[_0x12c487(0x13e)](_0x4946c4=>{const _0x533bea=_0x12c487;return this['_logger'][_0x533bea(0xed)](_0x4946c4[_0x533bea(0x16a)]+'.'+_0x4946c4[_0x533bea(0x12c)]+_0x533bea(0x124)+_0x4946c4[_0x533bea(0x11c)]),{[constants_1['FLOSUM_NAMESPACE']+_0x533bea(0x144)]:_0x533bea(0x14f),[constants_1[_0x533bea(0x131)]+'Status__c']:_0x4946c4['status']===status_enums_1['PackageComponentStatus'][_0x533bea(0x113)]?_0x533bea(0xfd):_0x533bea(0x14d),[constants_1[_0x533bea(0x131)]+_0x533bea(0xdf)]:_0x4946c4[_0x533bea(0x101)],[constants_1[_0x533bea(0x131)]+'Component_Name__c']:_0x4946c4[_0x533bea(0x12c)],[constants_1[_0x533bea(0x131)]+'Component_Type__c']:_0x4946c4[_0x533bea(0x16a)],[constants_1[_0x533bea(0x131)]+_0x533bea(0x106)]:_0x4946c4[_0x533bea(0x105)],[constants_1[_0x533bea(0x131)]+_0x533bea(0x11f)]:this[_0x533bea(0xdd)][_0x533bea(0xe5)],[constants_1[_0x533bea(0x131)]+_0x533bea(0xe7)]:this['_metadataLogId']};});}async[a337_0x54caf0(0x136)](_0x3f65e9){const _0x39f0db=a337_0x54caf0;this[_0x39f0db(0x167)]['log'](_0x39f0db(0x148));const _0x11d15b=await this[_0x39f0db(0xfc)][_0x39f0db(0x135)](constants_1[_0x39f0db(0x131)]+_0x39f0db(0xf2),_0x3f65e9),_0x458ef0=_0x11d15b[_0x39f0db(0x159)](_0x328724=>!_0x328724['success'])[_0x39f0db(0x13e)](_0x37a532=>_0x37a532[_0x39f0db(0x133)])[_0x39f0db(0x112)]();if(_0x458ef0['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x458ef0);}async[a337_0x54caf0(0xff)](_0x2d58fa){const _0x293de5=a337_0x54caf0;if(!this[_0x293de5(0xdd)]){this[_0x293de5(0x158)][_0x293de5(0xf7)](_0x2d58fa);return;}this[_0x293de5(0x167)]['logError'](_0x2d58fa),await this[_0x293de5(0x167)][_0x293de5(0x15c)](),await this[_0x293de5(0xf8)](![],!![],'');}async[a337_0x54caf0(0xf8)](_0x635bba,_0x41b514,_0x24cd0a){const _0x28403b=a337_0x54caf0,{id:_0x10e844,organizationId:_0x23bb01,branchId:_0x14f932,organizationName:_0x306feb}=this[_0x28403b(0xdd)],_0x4a6261='<a\x20href='+this['_instanceUrl']+'/'+_0x10e844+_0x28403b(0x150)+'Veeva\x20Rollback\x20(Deployment)'+_0x28403b(0x13b),_0x35a483=_0x28403b(0x12d)+this[_0x28403b(0x156)]+'/'+_0x23bb01+'\x20>'+_0x306feb+_0x28403b(0x12e),_0x48dc8a=_0x4a6261+_0x28403b(0xee)+_0x35a483+'\x20has\x20been\x20created.',_0x16da83={[constants_1[_0x28403b(0x131)]+_0x28403b(0x15d)]:_0x48dc8a,[constants_1[_0x28403b(0x131)]+_0x28403b(0x10e)]:new Date(),[constants_1[_0x28403b(0x131)]+_0x28403b(0xfb)]:_0x14f932,[constants_1[_0x28403b(0x131)]+'Activity_Item__c']:_0x28403b(0xe8),[constants_1[_0x28403b(0x131)]+'Activity_Type__c']:_0x28403b(0x129),[constants_1[_0x28403b(0x131)]+_0x28403b(0x15e)]:_0x23bb01},_0x2bdeb9={[constants_1['FLOSUM_NAMESPACE']+'Is_Error__c']:!_0x635bba,[constants_1[_0x28403b(0x131)]+_0x28403b(0x13c)]:_0x635bba,[constants_1[_0x28403b(0x131)]+_0x28403b(0x140)]:_0x41b514?status_enums_1['MetadataLogStatus'][_0x28403b(0x14c)]:status_enums_1[_0x28403b(0xf0)][_0x28403b(0x145)],[constants_1['FLOSUM_NAMESPACE']+_0x28403b(0x102)]:!![],[constants_1[_0x28403b(0x131)]+'Async_Request_Id__c']:_0x24cd0a};await this[_0x28403b(0x168)][_0x28403b(0x162)](flosum_constants_1[_0x28403b(0x10c)][_0x28403b(0x14b)]+'/'+constants_1[_0x28403b(0x131)]+_0x28403b(0x169)+this[_0x28403b(0x109)],_0x2bdeb9),await this[_0x28403b(0x168)][_0x28403b(0x11b)](flosum_constants_1[_0x28403b(0x10c)][_0x28403b(0x14b)]+'/'+constants_1[_0x28403b(0x131)]+'Log__c',_0x16da83),this[_0x28403b(0x167)][_0x28403b(0xed)](_0x28403b(0x110)+(_0x635bba?_0x28403b(0x132):_0x28403b(0xef))+'.'),await this[_0x28403b(0x167)]['updateLog']();}async[a337_0x54caf0(0xdb)](){const _0x5674d9=a337_0x54caf0;try{this[_0x5674d9(0xdd)]=await this[_0x5674d9(0xe9)]();const _0x4555de=await this[_0x5674d9(0x119)]();await this[_0x5674d9(0x167)]['updateLog']();const _0x12d333=await this[_0x5674d9(0x147)](_0x4555de),_0x203ed1=await this[_0x5674d9(0x108)](_0x12d333);await this['_logger'][_0x5674d9(0x15c)]();const _0x376632=await this[_0x5674d9(0x164)][_0x5674d9(0x138)](_0x203ed1);await this[_0x5674d9(0x167)][_0x5674d9(0x15c)]();const _0x101453=this[_0x5674d9(0x146)](_0x376632[_0x5674d9(0xea)]);await this[_0x5674d9(0x136)](_0x101453),await this[_0x5674d9(0xf8)](_0x376632[_0x5674d9(0x10f)],![],_0x376632[_0x5674d9(0x10b)]);}catch(_0x2384fa){await this[_0x5674d9(0xff)](_0x2384fa)[_0x5674d9(0x121)](_0x5cccb3=>this[_0x5674d9(0x158)][_0x5674d9(0xf7)](_0x5cccb3));}}}function a337_0x1115(_0x1533fa,_0x239f97){const _0x4f3398=a337_0x5607();return a337_0x1115=function(_0x232fbf,_0x5a8ff7){_0x232fbf=_0x232fbf-0xda;let _0x560742=_0x4f3398[_0x232fbf];return _0x560742;},a337_0x1115(_0x1533fa,_0x239f97);}exports[a337_0x54caf0(0x123)]=RollbackService;