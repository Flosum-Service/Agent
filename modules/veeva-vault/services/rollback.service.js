const a392_0x47188d=a392_0x1434;(function(_0x5be1fc,_0x12f1f7){const _0x5f1732=a392_0x1434,_0x461bd9=_0x5be1fc();while(!![]){try{const _0x1d3b35=parseInt(_0x5f1732(0xce))/0x1+-parseInt(_0x5f1732(0xcd))/0x2+-parseInt(_0x5f1732(0x102))/0x3*(-parseInt(_0x5f1732(0xa4))/0x4)+parseInt(_0x5f1732(0x84))/0x5+-parseInt(_0x5f1732(0xdb))/0x6+parseInt(_0x5f1732(0xd9))/0x7+-parseInt(_0x5f1732(0x85))/0x8;if(_0x1d3b35===_0x12f1f7)break;else _0x461bd9['push'](_0x461bd9['shift']());}catch(_0x561f77){_0x461bd9['push'](_0x461bd9['shift']());}}}(a392_0x4c00,0x2f07b));const a392_0x14d682=(function(){let _0x1ea5cd=!![];return function(_0x45f1c1,_0x298bd5){const _0x33f36d=_0x1ea5cd?function(){const _0x3cf467=a392_0x1434;if(_0x298bd5){const _0x357699=_0x298bd5[_0x3cf467(0x9e)](_0x45f1c1,arguments);return _0x298bd5=null,_0x357699;}}:function(){};return _0x1ea5cd=![],_0x33f36d;};}()),a392_0x24a41c=a392_0x14d682(this,function(){const _0x30391d=a392_0x1434;return a392_0x24a41c[_0x30391d(0xbb)]()[_0x30391d(0xf2)](_0x30391d(0x108))[_0x30391d(0xbb)]()[_0x30391d(0xf1)](a392_0x24a41c)['search']('(((.+)+)+)+$');});a392_0x24a41c();function a392_0x1434(_0x297cd8,_0x60070a){const _0x5c3e01=a392_0x4c00();return a392_0x1434=function(_0x24a41c,_0x14d682){_0x24a41c=_0x24a41c-0x79;let _0x4c0048=_0x5c3e01[_0x24a41c];return _0x4c0048;},a392_0x1434(_0x297cd8,_0x60070a);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x803d31){const _0x3276cd=a392_0x1434;return _0x803d31&&_0x803d31[_0x3276cd(0xc3)]?_0x803d31:{'default':_0x803d31};};Object[a392_0x47188d(0xb4)](exports,a392_0x47188d(0xc3),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require(a392_0x47188d(0x99)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a392_0x47188d(0xa0)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a392_0x47188d(0x9c)),zip_creator_rollback_1=require(a392_0x47188d(0x82)),shortid_1=__importDefault(require(a392_0x47188d(0x7a))),promises_1=require(a392_0x47188d(0xc8)),vpk_service_1=require(a392_0x47188d(0xdf)),status_enums_1=require(a392_0x47188d(0xcb)),salesforce_dml_error_1=require(a392_0x47188d(0xee)),metadata_log_dto_1=require(a392_0x47188d(0x10e)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x1035d3,connectionVeeva:_0x2ef61e,logger:_0x101f15,tempFolder:_0x9f5efb,instanceUrl:_0x13855c,timeZone:_0x42d7ad,metadataLogId:_0x4f0b82,attachmentLogId:_0xe771f9,parentMetadataLogId:_0x588e5c,componentIds:_0x2db2f0}){const _0x131e53=a392_0x47188d;this[_0x131e53(0xac)]=_0x1035d3,this[_0x131e53(0xfb)]=_0x2ef61e,this[_0x131e53(0xd8)]=_0x101f15,this[_0x131e53(0x97)]=_0x9f5efb,this[_0x131e53(0x92)]=_0x13855c,this[_0x131e53(0xa7)]=_0x42d7ad,this[_0x131e53(0x90)]=_0x4f0b82,this[_0x131e53(0x109)]=_0xe771f9,this[_0x131e53(0xb2)]=_0x588e5c,this[_0x131e53(0xe9)]=_0x2db2f0,this[_0x131e53(0x7b)]=new core_1['Logger'](_0x131e53(0xff)),this[_0x131e53(0x80)]=new veeva_service_1[(_0x131e53(0xb7))]({'connection':_0x2ef61e,'logger':_0x101f15}),this[_0x131e53(0xd4)]=new salesforce_service_1[(_0x131e53(0xd0))]({'connection':_0x1035d3}),this[_0x131e53(0xe8)]=new package_import_service_1['PackageImportService']({'veevaService':this['_veevaService'],'connection':_0x2ef61e,'logger':_0x101f15,'saveLog':this['saveLog'][_0x131e53(0xef)](this)}),this['_vpkService']=new vpk_service_1[(_0x131e53(0xba))]({'connection':_0x2ef61e});}async[a392_0x47188d(0xcf)](_0x13c79c,_0x31c2be){const _0x5feda3=a392_0x47188d;this[_0x5feda3(0xd8)][_0x5feda3(0xc7)]('Save\x20log');const _0x3b611d={'Body':Buffer[_0x5feda3(0xb9)](_0x13c79c)['toString'](_0x5feda3(0x8b)),'ContentType':_0x5feda3(0x98),'ParentId':this[_0x5feda3(0x90)],'Name':_0x31c2be};await this[_0x5feda3(0xac)][_0x5feda3(0x81)](flosum_constants_1['FlosumConstants'][_0x5feda3(0x88)]+_0x5feda3(0xe4),_0x3b611d);}async[a392_0x47188d(0x89)](){const _0xe6bcda=a392_0x47188d;this['_logger']['log'](_0xe6bcda(0x103));const [_0x228ec9]=await this[_0xe6bcda(0xd4)][_0xe6bcda(0xe5)](_0xe6bcda(0xb6)+constants_1['FLOSUM_NAMESPACE']+_0xe6bcda(0xbf)+constants_1[_0xe6bcda(0xad)]+_0xe6bcda(0xaa)+constants_1[_0xe6bcda(0xad)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1['FLOSUM_NAMESPACE']+_0xe6bcda(0x100)+this[_0xe6bcda(0x90)]+_0xe6bcda(0x9a));return new metadata_log_dto_1[(_0xe6bcda(0xd7))](_0x228ec9);}async[a392_0x47188d(0xda)](){const _0x300ef4=a392_0x47188d;this['_logger'][_0x300ef4(0xc7)](_0x300ef4(0x96));const _0x387367=await new id_deployment_result_retriever_1[(_0x300ef4(0xae))]({'salesforceService':this['_salesforceService'],'value':this[_0x300ef4(0xe9)]})[_0x300ef4(0x8e)]();if(!_0x387367[_0x300ef4(0x87)])throw new Error(_0x300ef4(0xc5));return _0x387367;}async[a392_0x47188d(0x10d)](){const _0x204eb3=a392_0x47188d;this['_logger'][_0x204eb3(0xc7)]('Retrieve\x20Backup');const _0x107916=await this['_salesforceService']['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x204eb3(0xb2)]+_0x204eb3(0xea)+flosum_constants_1[_0x204eb3(0xf4)][_0x204eb3(0xe1)]+_0x204eb3(0x9a)),_0x56a45e=await(0x0,fetch_attachments_1[_0x204eb3(0x91)])(this[_0x204eb3(0xac)],[_0x107916[0x0]['Id']]),_0x274c07=await(0x0,fetch_attachments_1[_0x204eb3(0xfc)])(_0x56a45e,this['_connectionSalesforce']);if(!_0x274c07[_0x204eb3(0x87)])throw new Error(_0x204eb3(0xe7));return _0x274c07[0x0][_0x204eb3(0x10a)][_0x204eb3(0x93)];}async[a392_0x47188d(0xc6)](_0xfc39a6){const _0x136938=a392_0x47188d;this[_0x136938(0xd8)][_0x136938(0xc7)]('Create\x20zip\x20from\x20backup');const _0x1950eb=await this[_0x136938(0x10d)](),_0x3a20f4=await new zip_creator_rollback_1[(_0x136938(0xfe))]({'rollbackName':this[_0x136938(0x9d)][_0x136938(0xd5)],'backup':_0x1950eb,'deploymentResults':_0xfc39a6})[_0x136938(0xbc)](),_0x311160=this[_0x136938(0x97)]+'/'+(0x0,shortid_1[_0x136938(0xd2)])()+_0x136938(0xbe);return await(0x0,promises_1[_0x136938(0xb1)])(_0x311160,_0x3a20f4),_0x311160;}async[a392_0x47188d(0x9f)](_0x473564){const _0x55381b=a392_0x47188d;this[_0x55381b(0xd8)][_0x55381b(0xc7)](_0x55381b(0x101));const _0x1f6e62=await this['_vpkService']['generate'](_0x473564),_0x39526c=this['_tempFolder']+_0x55381b(0xf8)+_0x473564[_0x55381b(0xa2)](_0x473564[_0x55381b(0xed)]('/')+0x1);return await(0x0,promises_1[_0x55381b(0xb1)])(_0x39526c,_0x1f6e62),await this[_0x55381b(0x7d)][_0x55381b(0xbd)](_0x39526c),_0x39526c;}[a392_0x47188d(0xeb)](_0x36cb73){const _0x27431a=a392_0x47188d;return this[_0x27431a(0xd8)][_0x27431a(0xc7)](_0x27431a(0x8c)),_0x36cb73[_0x27431a(0xfa)](_0x4ac4c6=>{const _0x5d42d9=_0x27431a;return this[_0x5d42d9(0xd8)][_0x5d42d9(0xc7)](_0x4ac4c6[_0x5d42d9(0x79)]+'.'+_0x4ac4c6['name']+_0x5d42d9(0x7f)+_0x4ac4c6[_0x5d42d9(0x8a)]),{[constants_1['FLOSUM_NAMESPACE']+_0x5d42d9(0x107)]:_0x5d42d9(0xc1),[constants_1['FLOSUM_NAMESPACE']+_0x5d42d9(0x104)]:_0x4ac4c6[_0x5d42d9(0x8a)]===status_enums_1[_0x5d42d9(0xf3)][_0x5d42d9(0x10c)]?_0x5d42d9(0x9b):_0x5d42d9(0xe0),[constants_1[_0x5d42d9(0xad)]+_0x5d42d9(0x94)]:_0x4ac4c6[_0x5d42d9(0x8f)],[constants_1[_0x5d42d9(0xad)]+_0x5d42d9(0x7c)]:_0x4ac4c6[_0x5d42d9(0xd5)],[constants_1[_0x5d42d9(0xad)]+_0x5d42d9(0x106)]:_0x4ac4c6[_0x5d42d9(0x79)],[constants_1[_0x5d42d9(0xad)]+_0x5d42d9(0xec)]:_0x4ac4c6[_0x5d42d9(0x105)],[constants_1[_0x5d42d9(0xad)]+_0x5d42d9(0xf6)]:this[_0x5d42d9(0x9d)][_0x5d42d9(0xf5)],[constants_1[_0x5d42d9(0xad)]+_0x5d42d9(0x10b)]:this['_metadataLogId']};});}async[a392_0x47188d(0xdc)](_0x44fbf3){const _0x423f0e=a392_0x47188d;this[_0x423f0e(0xd8)][_0x423f0e(0xc7)](_0x423f0e(0xca));const _0x53c15d=await this[_0x423f0e(0xd4)][_0x423f0e(0xb0)](constants_1[_0x423f0e(0xad)]+_0x423f0e(0xa1),_0x44fbf3),_0x4def64=_0x53c15d[_0x423f0e(0xc4)](_0x1c83dc=>!_0x1c83dc[_0x423f0e(0xc0)])['map'](_0x309b55=>_0x309b55['errors'])[_0x423f0e(0xf7)]();if(_0x4def64['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x4def64);}async[a392_0x47188d(0xc9)](_0x5a417c){const _0x40992=a392_0x47188d;if(!this[_0x40992(0x9d)]){this[_0x40992(0x7b)][_0x40992(0xd6)](_0x5a417c);return;}this['_logger']['logError'](_0x5a417c),await this[_0x40992(0xd8)][_0x40992(0x8d)](),await this[_0x40992(0xb5)](![],!![],'');}async[a392_0x47188d(0xb5)](_0x15e3e4,_0x370f38,_0x33c2cd){const _0x59be3b=a392_0x47188d,{id:_0x2cfeae,organizationId:_0x5e0618,branchId:_0x2390cd,organizationName:_0x364d65}=this[_0x59be3b(0x9d)],_0x1a5de5=_0x59be3b(0xf9)+this[_0x59be3b(0x92)]+'/'+_0x2cfeae+'\x20>\x20'+_0x59be3b(0xa6)+'\x20</a>',_0x13646a=_0x59be3b(0xf9)+this[_0x59be3b(0x92)]+'/'+_0x5e0618+'\x20>'+_0x364d65+_0x59be3b(0xdd),_0x32b32b=_0x1a5de5+_0x59be3b(0x95)+_0x13646a+'\x20has\x20been\x20created.',_0x22e9e2={[constants_1[_0x59be3b(0xad)]+'Action__c']:_0x32b32b,[constants_1['FLOSUM_NAMESPACE']+_0x59be3b(0xb3)]:new Date(),[constants_1[_0x59be3b(0xad)]+_0x59be3b(0xa8)]:_0x2390cd,[constants_1['FLOSUM_NAMESPACE']+'Activity_Item__c']:_0x59be3b(0xfd),[constants_1[_0x59be3b(0xad)]+_0x59be3b(0xb8)]:_0x59be3b(0x83),[constants_1[_0x59be3b(0xad)]+'TargetId__c']:_0x5e0618},_0x544855={[constants_1[_0x59be3b(0xad)]+_0x59be3b(0xe3)]:!_0x15e3e4,[constants_1[_0x59be3b(0xad)]+_0x59be3b(0xcc)]:_0x15e3e4,[constants_1[_0x59be3b(0xad)]+_0x59be3b(0x104)]:_0x370f38?status_enums_1[_0x59be3b(0xc2)]['EXCEPTION']:status_enums_1['MetadataLogStatus'][_0x59be3b(0xaf)],[constants_1[_0x59be3b(0xad)]+'Job_Completed__c']:!![],[constants_1['FLOSUM_NAMESPACE']+_0x59be3b(0x86)]:_0x33c2cd};await this[_0x59be3b(0xac)]['patch'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x59be3b(0xad)]+'Metadata_Log__c/'+this[_0x59be3b(0x90)],_0x544855),await this[_0x59be3b(0xac)]['post'](flosum_constants_1[_0x59be3b(0xf4)][_0x59be3b(0x88)]+'/'+constants_1[_0x59be3b(0xad)]+_0x59be3b(0xf0),_0x22e9e2),this[_0x59be3b(0xd8)][_0x59be3b(0xc7)](_0x59be3b(0x7e)+(_0x15e3e4?_0x59be3b(0xd1):_0x59be3b(0xa3))+'.'),await this[_0x59be3b(0xd8)][_0x59be3b(0x8d)]();}async[a392_0x47188d(0xa5)](){const _0x56a8ec=a392_0x47188d;try{this[_0x56a8ec(0x9d)]=await this[_0x56a8ec(0x89)]();const _0x9b3e3b=await this[_0x56a8ec(0xda)]();await this['_logger'][_0x56a8ec(0x8d)]();const _0xcee9cb=await this[_0x56a8ec(0xc6)](_0x9b3e3b),_0x14b0bc=await this['createVpk'](_0xcee9cb);await this[_0x56a8ec(0xd8)]['updateLog']();const _0xc9dcaf=await this[_0x56a8ec(0xe8)][_0x56a8ec(0xde)](_0x14b0bc);await this['_logger'][_0x56a8ec(0x8d)]();const _0x239b7b=this[_0x56a8ec(0xeb)](_0xc9dcaf[_0x56a8ec(0xa9)]);await this['saveDeploymentResults'](_0x239b7b),await this[_0x56a8ec(0xb5)](_0xc9dcaf[_0x56a8ec(0xe2)],![],_0xc9dcaf[_0x56a8ec(0xab)]);}catch(_0x52d3fd){await this['finishRollbackWithError'](_0x52d3fd)[_0x56a8ec(0xe6)](_0x33a649=>this['_systemLogger'][_0x56a8ec(0xd6)](_0x33a649));}}}exports[a392_0x47188d(0xd3)]=RollbackService;function a392_0x4c00(){const _0x389b93=['_systemLogger','Component_Name__c','_vpkService','Rollback\x20completed\x20','\x20:\x20','_veevaService','post','../classes/rollback/zip-creator.rollback','Deployment','1473165VpMCYD','2358728YrMGgm','External_Deployment_Id__c','length','ENDPOINT_UPSERT_RECORD','retrieveMetadataLog','status','base64','Form\x20Deployment\x20Results','updateLog','retrieve','deploymentAction','_metadataLogId','fetchAttachmentsDetailsById','_instanceUrl','Body','Result__c','\x20of\x20branch\x20to\x20Organization\x20','Retrieve\x20Deployment\x20Results','_tempFolder','text/plain','./veeva.service','\x27\x0a\x20\x20\x20\x20','Success','../../../constants','_metadataLog','apply','createVpk','../constants/flosum.constants','Deployment_Result__c','slice','with\x20error','2092rmFoAT','execute','Veeva\x20Rollback\x20(Deployment)','_timeZone','Branch__c','packageComponentList','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','packageId','_connectionSalesforce','FLOSUM_NAMESPACE','IdDeploymentResultRetriever','COMPLETED','insertMultipleRecords','writeFile','_parentMetadataLogId','Date__c','defineProperty','finishRollback','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','VeevaService','Activity_Type__c','from','VpkService','toString','create','validate','.zip','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','success','Deployment\x20Result','MetadataLogStatus','__esModule','filter','Cannot\x20find\x20Deployment\x20Results','createZip','log','fs/promises','finishRollbackWithError','Save\x20Deployment\x20Results','../enums/status.enums','Succeed__c','100756zkZiJR','287227HawVuS','saveLog','SalesforceService','successfully','default','RollbackService','_salesforceService','name','error','MetadataLogDto','_logger','617477iOlAMx','retrieveDeploymentResults','862338RmBgeq','saveDeploymentResults','</a>','import','./vpk.service','Failure','BACKUP_ZIP_NAME','isDeployed','Is_Error__c','/Attachment','retrieveRecords','catch','Cannot\x20find\x20Backup\x20Zip','_packageImportService','_componentIds','\x27\x20AND\x20Name\x20=\x20\x27','formFlosumDeploymentResults','Veeva_Step_Name__c','lastIndexOf','../classes/errors/salesforce-dml-error','bind','Log__c','constructor','search','PackageComponentStatus','FlosumConstants','organizationId','Org__c','flat','/vpk__','<a\x20href=','map','_connectionVeeva','retrieveAttachments','Branch','ZipCreatorRollback','veeva-rollback','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Create\x20Vpk\x20package','66kcIXCP','Retrieve\x20Metadata\x20Log\x20info','Status__c','stepName','Component_Type__c','Type__c','(((.+)+)+)+$','_attachmentLogId','values','Metadata_Log__c','DEPLOYED','retrieveBackup','../dtos/metadata-log.dto','type','shortid'];a392_0x4c00=function(){return _0x389b93;};return a392_0x4c00();}