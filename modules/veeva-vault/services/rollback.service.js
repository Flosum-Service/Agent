const a404_0x53e702=a404_0x3975;function a404_0x1551(){const _0x4e362d=['1245804lVhrNU','(((.+)+)+)+$','./package-import.service','Save\x20Deployment\x20Results','retrieveDeploymentResults','Org__c','EXCEPTION','External_Deployment_Id__c','Retrieve\x20Backup','execute','_instanceUrl','_packageImportService','\x27\x20AND\x20Name\x20=\x20\x27','generate','FLOSUM_NAMESPACE','\x20>\x20','base64','SalesforceDmlError','defineProperty','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','PackageImportService','Cannot\x20find\x20Deployment\x20Results','_parentMetadataLogId','flat','Save\x20log','toString','VpkService','<a\x20href=','Metadata_Log__c','packageComponentList','_vpkService','saveDeploymentResults','../classes/rollback/zip-creator.rollback','text/plain','_metadataLogId','4587952AvGPAl','packageId','Retrieve\x20Deployment\x20Results','retrieveAttachments','TargetId__c','slice','../../../constants','_tempFolder','Status__c','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','finishRollback','with\x20error','_connectionVeeva','_timeZone','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','bind','retrieveBackup','5634xlGNYv','updateLog','Deployment_Result__c','_attachmentLogId','error','\x20</a>','../classes/errors/salesforce-dml-error','log','Succeed__c','Job_Completed__c','Veeva_Step_Name__c','type','Log__c','SalesforceService','VeevaService','../classes/retrievers/deployment-results/id.deployment-result.retriever','\x20:\x20','createZip','default','Branch','RollbackService','./salesforce.service','_metadataLog','25061841sbexgE','_connectionSalesforce','ENDPOINT_UPSERT_RECORD','Create\x20zip\x20from\x20backup','MetadataLogDto','../dtos/metadata-log.dto','status','Retrieve\x20Metadata\x20Log\x20info','MetadataLogStatus','insertMultipleRecords','\x20of\x20branch\x20to\x20Organization\x20','create','saveLog','13006TnXuIA','organizationId','fs/promises','Failure','Component_Type__c','retrieveMetadataLog','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','success','Deployment\x20Result','search','successfully','BACKUP_ZIP_NAME','veeva-rollback','__importDefault','1373268eiNXHj','Success','writeFile','Action__c','name','_salesforceService','Cannot\x20find\x20Backup\x20Zip','PackageComponentStatus','FlosumConstants','../constants/flosum.constants','Create\x20Vpk\x20package','_componentIds','Branch__c','COMPLETED','finishRollbackWithError','errors','Veeva\x20Rollback\x20(Deployment)','Form\x20Deployment\x20Results','formFlosumDeploymentResults','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','values','Metadata_Log__c/','createVpk','</a>','2291145HQFrus','from','_systemLogger','Type__c','\x20has\x20been\x20created.','patch','\x27\x0a\x20\x20\x20\x20','Activity_Type__c','length','../enums/status.enums','../../shared/utils/fetch-attachments','stepName','.zip','744942VaZHaB','6fLihzC','_logger'];a404_0x1551=function(){return _0x4e362d;};return a404_0x1551();}function a404_0x3975(_0x228270,_0x50e0aa){const _0x6003f4=a404_0x1551();return a404_0x3975=function(_0x288655,_0x1b2c7f){_0x288655=_0x288655-0xb2;let _0x15511c=_0x6003f4[_0x288655];return _0x15511c;},a404_0x3975(_0x228270,_0x50e0aa);}(function(_0x4f8364,_0x5cbc38){const _0x2e4113=a404_0x3975,_0x14f32c=_0x4f8364();while(!![]){try{const _0x18bde2=parseInt(_0x2e4113(0xfa))/0x1+-parseInt(_0x2e4113(0xfd))/0x2*(parseInt(_0x2e4113(0xfb))/0x3)+parseInt(_0x2e4113(0xd5))/0x4+-parseInt(_0x2e4113(0xed))/0x5+-parseInt(_0x2e4113(0x131))/0x6*(parseInt(_0x2e4113(0xc7))/0x7)+parseInt(_0x2e4113(0x120))/0x8+parseInt(_0x2e4113(0xba))/0x9;if(_0x18bde2===_0x5cbc38)break;else _0x14f32c['push'](_0x14f32c['shift']());}catch(_0x485aa9){_0x14f32c['push'](_0x14f32c['shift']());}}}(a404_0x1551,0xf394b));const a404_0x1b2c7f=(function(){let _0x521f02=!![];return function(_0x2b81d9,_0x5b01b8){const _0x53e59f=_0x521f02?function(){if(_0x5b01b8){const _0xb4716b=_0x5b01b8['apply'](_0x2b81d9,arguments);return _0x5b01b8=null,_0xb4716b;}}:function(){};return _0x521f02=![],_0x53e59f;};}()),a404_0x288655=a404_0x1b2c7f(this,function(){const _0x3e437b=a404_0x3975;return a404_0x288655['toString']()[_0x3e437b(0xd0)](_0x3e437b(0xfe))[_0x3e437b(0x116)]()['constructor'](a404_0x288655)[_0x3e437b(0xd0)](_0x3e437b(0xfe));});a404_0x288655();'use strict';var __importDefault=this&&this[a404_0x53e702(0xd4)]||function(_0x2eb8e0){return _0x2eb8e0&&_0x2eb8e0['__esModule']?_0x2eb8e0:{'default':_0x2eb8e0};};Object[a404_0x53e702(0x10f)](exports,'__esModule',{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a404_0x53e702(0xb8)),package_import_service_1=require(a404_0x53e702(0xff)),id_deployment_result_retriever_1=require(a404_0x53e702(0xb2)),flosum_constants_1=require(a404_0x53e702(0xde)),fetch_attachments_1=require(a404_0x53e702(0xf7)),constants_1=require(a404_0x53e702(0x126)),zip_creator_rollback_1=require(a404_0x53e702(0x11d)),shortid_1=__importDefault(require('shortid')),promises_1=require(a404_0x53e702(0xc9)),vpk_service_1=require('./vpk.service'),status_enums_1=require(a404_0x53e702(0xf6)),salesforce_dml_error_1=require(a404_0x53e702(0x137)),metadata_log_dto_1=require(a404_0x53e702(0xbf)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x26b26d,connectionVeeva:_0x46f270,logger:_0x23f770,tempFolder:_0xb6ea02,instanceUrl:_0x35d830,timeZone:_0x153b3e,metadataLogId:_0x15bbd5,attachmentLogId:_0x477668,parentMetadataLogId:_0x7fee35,componentIds:_0x3ce7c3}){const _0x248b84=a404_0x53e702;this[_0x248b84(0xbb)]=_0x26b26d,this[_0x248b84(0x12c)]=_0x46f270,this[_0x248b84(0xfc)]=_0x23f770,this[_0x248b84(0x127)]=_0xb6ea02,this['_instanceUrl']=_0x35d830,this[_0x248b84(0x12d)]=_0x153b3e,this[_0x248b84(0x11f)]=_0x15bbd5,this[_0x248b84(0x134)]=_0x477668,this['_parentMetadataLogId']=_0x7fee35,this[_0x248b84(0xe0)]=_0x3ce7c3,this[_0x248b84(0xef)]=new core_1['Logger'](_0x248b84(0xd3)),this['_veevaService']=new veeva_service_1[(_0x248b84(0x13f))]({'connection':_0x46f270,'logger':_0x23f770}),this[_0x248b84(0xda)]=new salesforce_service_1[(_0x248b84(0x13e))]({'connection':_0x26b26d}),this[_0x248b84(0x108)]=new package_import_service_1[(_0x248b84(0x111))]({'veevaService':this['_veevaService'],'connection':_0x46f270,'logger':_0x23f770,'saveLog':this[_0x248b84(0xc6)][_0x248b84(0x12f)](this)}),this['_vpkService']=new vpk_service_1[(_0x248b84(0x117))]({'connection':_0x46f270});}async[a404_0x53e702(0xc6)](_0x4d2c49,_0x41e1d2){const _0x392547=a404_0x53e702;this['_logger'][_0x392547(0x138)](_0x392547(0x115));const _0x57e142={'Body':Buffer[_0x392547(0xee)](_0x4d2c49)[_0x392547(0x116)](_0x392547(0x10d)),'ContentType':_0x392547(0x11e),'ParentId':this[_0x392547(0x11f)],'Name':_0x41e1d2};await this[_0x392547(0xbb)]['post'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x57e142);}async[a404_0x53e702(0xcc)](){const _0x45a287=a404_0x53e702;this[_0x45a287(0xfc)][_0x45a287(0x138)](_0x45a287(0xc1));const [_0x1a00dc]=await this[_0x45a287(0xda)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x45a287(0xcd)+constants_1['FLOSUM_NAMESPACE']+_0x45a287(0xe8)+constants_1[_0x45a287(0x10b)]+_0x45a287(0x129)+constants_1[_0x45a287(0x10b)]+_0x45a287(0x12e)+this['_metadataLogId']+_0x45a287(0xf3));return new metadata_log_dto_1[(_0x45a287(0xbe))](_0x1a00dc);}async[a404_0x53e702(0x101)](){const _0xc5265e=a404_0x53e702;this[_0xc5265e(0xfc)][_0xc5265e(0x138)](_0xc5265e(0x122));const _0x43465e=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this['_salesforceService'],'value':this[_0xc5265e(0xe0)]})['retrieve']();if(!_0x43465e[_0xc5265e(0xf5)])throw new Error(_0xc5265e(0x112));return _0x43465e;}async[a404_0x53e702(0x130)](){const _0x18cc0b=a404_0x53e702;this[_0x18cc0b(0xfc)][_0x18cc0b(0x138)](_0x18cc0b(0x105));const _0x1394ff=await this[_0x18cc0b(0xda)]['retrieveRecords'](_0x18cc0b(0x110)+this[_0x18cc0b(0x113)]+_0x18cc0b(0x109)+flosum_constants_1[_0x18cc0b(0xdd)][_0x18cc0b(0xd2)]+_0x18cc0b(0xf3)),_0x2f6749=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x18cc0b(0xbb)],[_0x1394ff[0x0]['Id']]),_0x5417a4=await(0x0,fetch_attachments_1[_0x18cc0b(0x123)])(_0x2f6749,this[_0x18cc0b(0xbb)]);if(!_0x5417a4[_0x18cc0b(0xf5)])throw new Error(_0x18cc0b(0xdb));return _0x5417a4[0x0][_0x18cc0b(0xe9)]['Body'];}async[a404_0x53e702(0xb4)](_0x40c45b){const _0xb1ce71=a404_0x53e702;this['_logger']['log'](_0xb1ce71(0xbd));const _0x54cba8=await this[_0xb1ce71(0x130)](),_0x7a347c=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0xb1ce71(0xb9)][_0xb1ce71(0xd9)],'backup':_0x54cba8,'deploymentResults':_0x40c45b})[_0xb1ce71(0xc5)](),_0x2d8800=this[_0xb1ce71(0x127)]+'/'+(0x0,shortid_1[_0xb1ce71(0xb5)])()+_0xb1ce71(0xf9);return await(0x0,promises_1[_0xb1ce71(0xd7)])(_0x2d8800,_0x7a347c),_0x2d8800;}async[a404_0x53e702(0xeb)](_0x21158){const _0x840924=a404_0x53e702;this[_0x840924(0xfc)][_0x840924(0x138)](_0x840924(0xdf));const _0x4e2d3f=await this['_vpkService'][_0x840924(0x10a)](_0x21158),_0x47a4bc=this['_tempFolder']+'/vpk__'+_0x21158[_0x840924(0x125)](_0x21158['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x840924(0xd7)])(_0x47a4bc,_0x4e2d3f),await this[_0x840924(0x11b)]['validate'](_0x47a4bc),_0x47a4bc;}[a404_0x53e702(0xe7)](_0x54a788){const _0x3a0ec6=a404_0x53e702;return this[_0x3a0ec6(0xfc)][_0x3a0ec6(0x138)](_0x3a0ec6(0xe6)),_0x54a788['map'](_0x53c1b3=>{const _0x1e8ad1=_0x3a0ec6;return this[_0x1e8ad1(0xfc)][_0x1e8ad1(0x138)](_0x53c1b3['type']+'.'+_0x53c1b3['name']+_0x1e8ad1(0xb3)+_0x53c1b3[_0x1e8ad1(0xc0)]),{[constants_1[_0x1e8ad1(0x10b)]+_0x1e8ad1(0xf0)]:_0x1e8ad1(0xcf),[constants_1[_0x1e8ad1(0x10b)]+_0x1e8ad1(0x128)]:_0x53c1b3[_0x1e8ad1(0xc0)]===status_enums_1[_0x1e8ad1(0xdc)]['DEPLOYED']?_0x1e8ad1(0xd6):_0x1e8ad1(0xca),[constants_1[_0x1e8ad1(0x10b)]+'Result__c']:_0x53c1b3['deploymentAction'],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x53c1b3[_0x1e8ad1(0xd9)],[constants_1[_0x1e8ad1(0x10b)]+_0x1e8ad1(0xcb)]:_0x53c1b3[_0x1e8ad1(0x13c)],[constants_1[_0x1e8ad1(0x10b)]+_0x1e8ad1(0x13b)]:_0x53c1b3[_0x1e8ad1(0xf8)],[constants_1[_0x1e8ad1(0x10b)]+_0x1e8ad1(0x102)]:this[_0x1e8ad1(0xb9)][_0x1e8ad1(0xc8)],[constants_1[_0x1e8ad1(0x10b)]+_0x1e8ad1(0x119)]:this[_0x1e8ad1(0x11f)]};});}async[a404_0x53e702(0x11c)](_0x48131e){const _0x38fe96=a404_0x53e702;this['_logger'][_0x38fe96(0x138)](_0x38fe96(0x100));const _0x10c298=await this[_0x38fe96(0xda)][_0x38fe96(0xc3)](constants_1[_0x38fe96(0x10b)]+_0x38fe96(0x133),_0x48131e),_0x112264=_0x10c298['filter'](_0x3cc4f1=>!_0x3cc4f1[_0x38fe96(0xce)])['map'](_0x7f6a78=>_0x7f6a78[_0x38fe96(0xe4)])[_0x38fe96(0x114)]();if(_0x112264[_0x38fe96(0xf5)])throw new salesforce_dml_error_1[(_0x38fe96(0x10e))](_0x112264);}async['finishRollbackWithError'](_0x4d9115){const _0x81003a=a404_0x53e702;if(!this[_0x81003a(0xb9)]){this['_systemLogger'][_0x81003a(0x135)](_0x4d9115);return;}this['_logger']['logError'](_0x4d9115),await this[_0x81003a(0xfc)][_0x81003a(0x132)](),await this[_0x81003a(0x12a)](![],!![],'');}async[a404_0x53e702(0x12a)](_0x47f445,_0x20b55f,_0x1e5f8d){const _0x35a49d=a404_0x53e702,{id:_0x225a40,organizationId:_0x3a53d5,branchId:_0xbacaa3,organizationName:_0x165c24}=this[_0x35a49d(0xb9)],_0x259872=_0x35a49d(0x118)+this[_0x35a49d(0x107)]+'/'+_0x225a40+_0x35a49d(0x10c)+_0x35a49d(0xe5)+_0x35a49d(0x136),_0x5e8454=_0x35a49d(0x118)+this[_0x35a49d(0x107)]+'/'+_0x3a53d5+'\x20>'+_0x165c24+_0x35a49d(0xec),_0x52ca7e=_0x259872+_0x35a49d(0xc4)+_0x5e8454+_0x35a49d(0xf1),_0x38c7f1={[constants_1[_0x35a49d(0x10b)]+_0x35a49d(0xd8)]:_0x52ca7e,[constants_1[_0x35a49d(0x10b)]+'Date__c']:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x35a49d(0xe1)]:_0xbacaa3,[constants_1[_0x35a49d(0x10b)]+'Activity_Item__c']:_0x35a49d(0xb6),[constants_1[_0x35a49d(0x10b)]+_0x35a49d(0xf4)]:'Deployment',[constants_1[_0x35a49d(0x10b)]+_0x35a49d(0x124)]:_0x3a53d5},_0x1660b2={[constants_1[_0x35a49d(0x10b)]+'Is_Error__c']:!_0x47f445,[constants_1[_0x35a49d(0x10b)]+_0x35a49d(0x139)]:_0x47f445,[constants_1[_0x35a49d(0x10b)]+_0x35a49d(0x128)]:_0x20b55f?status_enums_1[_0x35a49d(0xc2)][_0x35a49d(0x103)]:status_enums_1['MetadataLogStatus'][_0x35a49d(0xe2)],[constants_1[_0x35a49d(0x10b)]+_0x35a49d(0x13a)]:!![],[constants_1[_0x35a49d(0x10b)]+_0x35a49d(0x104)]:_0x1e5f8d};await this[_0x35a49d(0xbb)][_0x35a49d(0xf2)](flosum_constants_1['FlosumConstants'][_0x35a49d(0xbc)]+'/'+constants_1[_0x35a49d(0x10b)]+_0x35a49d(0xea)+this[_0x35a49d(0x11f)],_0x1660b2),await this[_0x35a49d(0xbb)]['post'](flosum_constants_1[_0x35a49d(0xdd)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x35a49d(0x10b)]+_0x35a49d(0x13d),_0x38c7f1),this[_0x35a49d(0xfc)]['log']('Rollback\x20completed\x20'+(_0x47f445?_0x35a49d(0xd1):_0x35a49d(0x12b))+'.'),await this[_0x35a49d(0xfc)][_0x35a49d(0x132)]();}async[a404_0x53e702(0x106)](){const _0x3c722a=a404_0x53e702;try{this[_0x3c722a(0xb9)]=await this['retrieveMetadataLog']();const _0x3c3125=await this[_0x3c722a(0x101)]();await this[_0x3c722a(0xfc)][_0x3c722a(0x132)]();const _0x540f6c=await this['createZip'](_0x3c3125),_0x355f0d=await this[_0x3c722a(0xeb)](_0x540f6c);await this[_0x3c722a(0xfc)][_0x3c722a(0x132)]();const _0x2fd2cc=await this[_0x3c722a(0x108)]['import'](_0x355f0d);await this['_logger'][_0x3c722a(0x132)]();const _0x363121=this[_0x3c722a(0xe7)](_0x2fd2cc[_0x3c722a(0x11a)]);await this['saveDeploymentResults'](_0x363121),await this[_0x3c722a(0x12a)](_0x2fd2cc['isDeployed'],![],_0x2fd2cc[_0x3c722a(0x121)]);}catch(_0x3f36bd){await this[_0x3c722a(0xe3)](_0x3f36bd)['catch'](_0x253c7d=>this[_0x3c722a(0xef)][_0x3c722a(0x135)](_0x253c7d));}}}exports[a404_0x53e702(0xb7)]=RollbackService;