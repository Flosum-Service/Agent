const a377_0x1b3d2d=a377_0x36da;(function(_0xb583da,_0x47a35f){const _0x2e805f=a377_0x36da,_0x1dba40=_0xb583da();while(!![]){try{const _0x47ac7e=-parseInt(_0x2e805f(0x1a2))/0x1+-parseInt(_0x2e805f(0x1bf))/0x2*(parseInt(_0x2e805f(0x156))/0x3)+-parseInt(_0x2e805f(0x151))/0x4+parseInt(_0x2e805f(0x14a))/0x5*(parseInt(_0x2e805f(0x1aa))/0x6)+parseInt(_0x2e805f(0x170))/0x7+-parseInt(_0x2e805f(0x18a))/0x8*(parseInt(_0x2e805f(0x16b))/0x9)+parseInt(_0x2e805f(0x19c))/0xa;if(_0x47ac7e===_0x47a35f)break;else _0x1dba40['push'](_0x1dba40['shift']());}catch(_0x46cf34){_0x1dba40['push'](_0x1dba40['shift']());}}}(a377_0x3dab,0xe5aec));const a377_0x452e7d=(function(){let _0x478bee=!![];return function(_0x9dd2ee,_0x16f21){const _0x145134=_0x478bee?function(){const _0x3fa04f=a377_0x36da;if(_0x16f21){const _0x296208=_0x16f21[_0x3fa04f(0x1af)](_0x9dd2ee,arguments);return _0x16f21=null,_0x296208;}}:function(){};return _0x478bee=![],_0x145134;};}()),a377_0x50e24a=a377_0x452e7d(this,function(){const _0x43292f=a377_0x36da;return a377_0x50e24a[_0x43292f(0x1ba)]()['search']('(((.+)+)+)+$')[_0x43292f(0x1ba)]()[_0x43292f(0x192)](a377_0x50e24a)[_0x43292f(0x12d)](_0x43292f(0x174));});a377_0x50e24a();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x5e7e87){const _0x1272df=a377_0x36da;return _0x5e7e87&&_0x5e7e87[_0x1272df(0x140)]?_0x5e7e87:{'default':_0x5e7e87};};function a377_0x3dab(){const _0x29d65b=['Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','VeevaService','finishRollback','COMPLETED','bind','error','Branch','Retrieve\x20Deployment\x20Results','./salesforce.service','../classes/retrievers/deployment-results/id.deployment-result.retriever','72rcbrMw','updateLog','_metadataLogId','Create\x20zip\x20from\x20backup','_vpkService','Type__c','createZip','SalesforceDmlError','constructor','from','Component_Type__c','fetchAttachmentsDetailsById','Retrieve\x20Metadata\x20Log\x20info','../classes/rollback/zip-creator.rollback','Status__c','map','lastIndexOf','\x27\x0a\x20\x20\x20\x20','37654070ITBcNz','\x20:\x20','TargetId__c','finishRollbackWithError','organizationId','External_Deployment_Id__c','380191SlFKlF','Action__c','with\x20error','packageComponentList','execute','values','\x27\x20AND\x20Name\x20=\x20\x27','_logger','66orPXAk','FlosumConstants','veeva-rollback','../../shared/utils/fetch-attachments','retrieveDeploymentResults','apply','Date__c','type','text/plain','Save\x20log','_connectionSalesforce','_salesforceService','Create\x20Vpk\x20package','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','PackageComponentStatus','Rollback\x20completed\x20','toString','Form\x20Deployment\x20Results','Deployment','logError','.zip','22lAHeet','Logger','Component_Name__c','createVpk','search','Cannot\x20find\x20Deployment\x20Results','patch','retrieveBackup','Retrieve\x20Backup','retrieveMetadataLog','length','successfully','MetadataLogStatus','Log__c','Veeva_Step_Name__c','filter','ENDPOINT_UPSERT_RECORD','EXCEPTION','Veeva\x20Rollback\x20(Deployment)','\x20of\x20branch\x20to\x20Organization\x20','success','<a\x20href=','base64','__esModule','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','saveLog','retrieve','VpkService','saveDeploymentResults','deploymentAction','ZipCreatorRollback','defineProperty','isDeployed','250655usSUNH','create','../../../constants','_componentIds','_systemLogger','Metadata_Log__c','Branch__c','1911912npybrI','_packageImportService','slice','Result__c','insertMultipleRecords','333933UAoRcs','../dtos/metadata-log.dto','_metadataLog','Succeed__c','log','catch','../../../core','_instanceUrl','../enums/status.enums','Activity_Item__c','retrieveRecords','Failure','status','FLOSUM_NAMESPACE','./vpk.service','name','BACKUP_ZIP_NAME','_attachmentLogId','Metadata_Log__c/','./veeva.service','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','1679148uZSuHE','MetadataLogDto','RollbackService','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_veevaService','2699690QlTGAP','formFlosumDeploymentResults','Activity_Type__c','post','(((.+)+)+)+$','_timeZone','../constants/flosum.constants','Save\x20Deployment\x20Results','\x20has\x20been\x20created.','_connectionVeeva','DEPLOYED','_tempFolder','_parentMetadataLogId','writeFile','default'];a377_0x3dab=function(){return _0x29d65b;};return a377_0x3dab();}Object[a377_0x1b3d2d(0x148)](exports,a377_0x1b3d2d(0x140),{'value':!![]}),exports[a377_0x1b3d2d(0x16d)]=void 0x0;const veeva_service_1=require(a377_0x1b3d2d(0x169)),salesforce_service_1=require(a377_0x1b3d2d(0x188)),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require(a377_0x1b3d2d(0x189)),flosum_constants_1=require(a377_0x1b3d2d(0x176)),fetch_attachments_1=require(a377_0x1b3d2d(0x1ad)),constants_1=require(a377_0x1b3d2d(0x14c)),zip_creator_rollback_1=require(a377_0x1b3d2d(0x197)),shortid_1=__importDefault(require('shortid')),promises_1=require('fs/promises'),vpk_service_1=require(a377_0x1b3d2d(0x164)),status_enums_1=require(a377_0x1b3d2d(0x15e)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a377_0x1b3d2d(0x157)),core_1=require(a377_0x1b3d2d(0x15c));function a377_0x36da(_0x205f1d,_0x31af8b){const _0x21f7f7=a377_0x3dab();return a377_0x36da=function(_0x50e24a,_0x452e7d){_0x50e24a=_0x50e24a-0x12b;let _0x3dab8f=_0x21f7f7[_0x50e24a];return _0x3dab8f;},a377_0x36da(_0x205f1d,_0x31af8b);}class RollbackService{constructor({connectionSalesforce:_0x433a5d,connectionVeeva:_0x1cf401,logger:_0x28c815,tempFolder:_0xfacdfd,instanceUrl:_0x1f74d7,timeZone:_0x25ff0c,metadataLogId:_0x444d4b,attachmentLogId:_0x4cea9e,parentMetadataLogId:_0x5f1c43,componentIds:_0x51425c}){const _0x49b6f3=a377_0x1b3d2d;this['_connectionSalesforce']=_0x433a5d,this[_0x49b6f3(0x179)]=_0x1cf401,this[_0x49b6f3(0x1a9)]=_0x28c815,this[_0x49b6f3(0x17b)]=_0xfacdfd,this[_0x49b6f3(0x15d)]=_0x1f74d7,this[_0x49b6f3(0x175)]=_0x25ff0c,this['_metadataLogId']=_0x444d4b,this[_0x49b6f3(0x167)]=_0x4cea9e,this[_0x49b6f3(0x17c)]=_0x5f1c43,this[_0x49b6f3(0x14d)]=_0x51425c,this[_0x49b6f3(0x14e)]=new core_1[(_0x49b6f3(0x1c0))](_0x49b6f3(0x1ac)),this[_0x49b6f3(0x16f)]=new veeva_service_1[(_0x49b6f3(0x181))]({'connection':_0x1cf401,'logger':_0x28c815}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':_0x433a5d}),this[_0x49b6f3(0x152)]=new package_import_service_1['PackageImportService']({'veevaService':this['_veevaService'],'connection':_0x1cf401,'logger':_0x28c815,'saveLog':this[_0x49b6f3(0x142)][_0x49b6f3(0x184)](this)}),this[_0x49b6f3(0x18e)]=new vpk_service_1[(_0x49b6f3(0x144))]({'connection':_0x1cf401});}async['saveLog'](_0x5774d1,_0x2d5a84){const _0xf691d7=a377_0x1b3d2d;this['_logger'][_0xf691d7(0x15a)](_0xf691d7(0x1b3));const _0x278e20={'Body':Buffer[_0xf691d7(0x193)](_0x5774d1)[_0xf691d7(0x1ba)](_0xf691d7(0x13f)),'ContentType':_0xf691d7(0x1b2),'ParentId':this['_metadataLogId'],'Name':_0x2d5a84};await this[_0xf691d7(0x1b4)][_0xf691d7(0x173)](flosum_constants_1[_0xf691d7(0x1ab)][_0xf691d7(0x139)]+'/Attachment',_0x278e20);}async[a377_0x1b3d2d(0x132)](){const _0x3f9a5c=a377_0x1b3d2d;this[_0x3f9a5c(0x1a9)][_0x3f9a5c(0x15a)](_0x3f9a5c(0x196));const [_0x2eb0aa]=await this[_0x3f9a5c(0x1b5)][_0x3f9a5c(0x160)](_0x3f9a5c(0x16e)+constants_1[_0x3f9a5c(0x163)]+_0x3f9a5c(0x16a)+constants_1[_0x3f9a5c(0x163)]+_0x3f9a5c(0x1b7)+constants_1['FLOSUM_NAMESPACE']+_0x3f9a5c(0x17f)+constants_1['FLOSUM_NAMESPACE']+_0x3f9a5c(0x180)+this['_metadataLogId']+_0x3f9a5c(0x19b));return new metadata_log_dto_1[(_0x3f9a5c(0x16c))](_0x2eb0aa);}async[a377_0x1b3d2d(0x1ae)](){const _0x208e38=a377_0x1b3d2d;this[_0x208e38(0x1a9)][_0x208e38(0x15a)](_0x208e38(0x187));const _0x16656d=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x208e38(0x1b5)],'value':this[_0x208e38(0x14d)]})[_0x208e38(0x143)]();if(!_0x16656d[_0x208e38(0x133)])throw new Error(_0x208e38(0x12e));return _0x16656d;}async[a377_0x1b3d2d(0x130)](){const _0x2bd00c=a377_0x1b3d2d;this[_0x2bd00c(0x1a9)]['log'](_0x2bd00c(0x131));const _0x5befa9=await this['_salesforceService'][_0x2bd00c(0x160)](_0x2bd00c(0x141)+this[_0x2bd00c(0x17c)]+_0x2bd00c(0x1a8)+flosum_constants_1[_0x2bd00c(0x1ab)][_0x2bd00c(0x166)]+_0x2bd00c(0x19b)),_0x29ae0d=await(0x0,fetch_attachments_1[_0x2bd00c(0x195)])(this[_0x2bd00c(0x1b4)],[_0x5befa9[0x0]['Id']]),_0x39ed50=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x29ae0d,this[_0x2bd00c(0x1b4)]);if(!_0x39ed50[_0x2bd00c(0x133)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x39ed50[0x0][_0x2bd00c(0x1a7)]['Body'];}async[a377_0x1b3d2d(0x190)](_0x51a4af){const _0x836a9c=a377_0x1b3d2d;this['_logger'][_0x836a9c(0x15a)](_0x836a9c(0x18d));const _0x30c664=await this[_0x836a9c(0x130)](),_0x2c8ce3=await new zip_creator_rollback_1[(_0x836a9c(0x147))]({'rollbackName':this[_0x836a9c(0x158)][_0x836a9c(0x165)],'backup':_0x30c664,'deploymentResults':_0x51a4af})[_0x836a9c(0x14b)](),_0x267877=this[_0x836a9c(0x17b)]+'/'+(0x0,shortid_1[_0x836a9c(0x17e)])()+_0x836a9c(0x1be);return await(0x0,promises_1[_0x836a9c(0x17d)])(_0x267877,_0x2c8ce3),_0x267877;}async[a377_0x1b3d2d(0x12c)](_0x355d3d){const _0x162cd7=a377_0x1b3d2d;this[_0x162cd7(0x1a9)][_0x162cd7(0x15a)](_0x162cd7(0x1b6));const _0x16cae1=await this[_0x162cd7(0x18e)]['generate'](_0x355d3d),_0x55096a=this[_0x162cd7(0x17b)]+'/vpk__'+_0x355d3d[_0x162cd7(0x153)](_0x355d3d[_0x162cd7(0x19a)]('/')+0x1);return await(0x0,promises_1[_0x162cd7(0x17d)])(_0x55096a,_0x16cae1),await this[_0x162cd7(0x18e)]['validate'](_0x55096a),_0x55096a;}[a377_0x1b3d2d(0x171)](_0x651321){const _0x4db553=a377_0x1b3d2d;return this[_0x4db553(0x1a9)][_0x4db553(0x15a)](_0x4db553(0x1bb)),_0x651321[_0x4db553(0x199)](_0x392ad7=>{const _0x210622=_0x4db553;return this[_0x210622(0x1a9)][_0x210622(0x15a)](_0x392ad7[_0x210622(0x1b1)]+'.'+_0x392ad7[_0x210622(0x165)]+_0x210622(0x19d)+_0x392ad7[_0x210622(0x162)]),{[constants_1[_0x210622(0x163)]+_0x210622(0x18f)]:'Deployment\x20Result',[constants_1[_0x210622(0x163)]+'Status__c']:_0x392ad7[_0x210622(0x162)]===status_enums_1[_0x210622(0x1b8)][_0x210622(0x17a)]?'Success':_0x210622(0x161),[constants_1[_0x210622(0x163)]+_0x210622(0x154)]:_0x392ad7[_0x210622(0x146)],[constants_1[_0x210622(0x163)]+_0x210622(0x12b)]:_0x392ad7['name'],[constants_1[_0x210622(0x163)]+_0x210622(0x194)]:_0x392ad7['type'],[constants_1[_0x210622(0x163)]+_0x210622(0x137)]:_0x392ad7['stepName'],[constants_1[_0x210622(0x163)]+'Org__c']:this['_metadataLog'][_0x210622(0x1a0)],[constants_1['FLOSUM_NAMESPACE']+_0x210622(0x14f)]:this[_0x210622(0x18c)]};});}async[a377_0x1b3d2d(0x145)](_0x4235d0){const _0x1d8135=a377_0x1b3d2d;this['_logger'][_0x1d8135(0x15a)](_0x1d8135(0x177));const _0x4ede9e=await this[_0x1d8135(0x1b5)][_0x1d8135(0x155)](constants_1[_0x1d8135(0x163)]+'Deployment_Result__c',_0x4235d0),_0x3d3399=_0x4ede9e[_0x1d8135(0x138)](_0x2778d6=>!_0x2778d6[_0x1d8135(0x13d)])[_0x1d8135(0x199)](_0x182858=>_0x182858['errors'])['flat']();if(_0x3d3399[_0x1d8135(0x133)])throw new salesforce_dml_error_1[(_0x1d8135(0x191))](_0x3d3399);}async['finishRollbackWithError'](_0x525908){const _0x14b3b7=a377_0x1b3d2d;if(!this['_metadataLog']){this[_0x14b3b7(0x14e)]['error'](_0x525908);return;}this[_0x14b3b7(0x1a9)][_0x14b3b7(0x1bd)](_0x525908),await this[_0x14b3b7(0x1a9)][_0x14b3b7(0x18b)](),await this[_0x14b3b7(0x182)](![],!![],'');}async[a377_0x1b3d2d(0x182)](_0x50e5a6,_0x1cda71,_0x1994d2){const _0x32b278=a377_0x1b3d2d,{id:_0x430ffe,organizationId:_0x4bb468,branchId:_0x328c6d,organizationName:_0x4bb6df}=this['_metadataLog'],_0x50315e=_0x32b278(0x13e)+this['_instanceUrl']+'/'+_0x430ffe+'\x20>\x20'+_0x32b278(0x13b)+'\x20</a>',_0x1c8442=_0x32b278(0x13e)+this[_0x32b278(0x15d)]+'/'+_0x4bb468+'\x20>'+_0x4bb6df+'</a>',_0x5c3a31=_0x50315e+_0x32b278(0x13c)+_0x1c8442+_0x32b278(0x178),_0x276a43={[constants_1['FLOSUM_NAMESPACE']+_0x32b278(0x1a3)]:_0x5c3a31,[constants_1['FLOSUM_NAMESPACE']+_0x32b278(0x1b0)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x32b278(0x150)]:_0x328c6d,[constants_1[_0x32b278(0x163)]+_0x32b278(0x15f)]:_0x32b278(0x186),[constants_1['FLOSUM_NAMESPACE']+_0x32b278(0x172)]:_0x32b278(0x1bc),[constants_1['FLOSUM_NAMESPACE']+_0x32b278(0x19e)]:_0x4bb468},_0x2cc898={[constants_1[_0x32b278(0x163)]+'Is_Error__c']:!_0x50e5a6,[constants_1[_0x32b278(0x163)]+_0x32b278(0x159)]:_0x50e5a6,[constants_1[_0x32b278(0x163)]+_0x32b278(0x198)]:_0x1cda71?status_enums_1[_0x32b278(0x135)][_0x32b278(0x13a)]:status_enums_1[_0x32b278(0x135)][_0x32b278(0x183)],[constants_1['FLOSUM_NAMESPACE']+'Job_Completed__c']:!![],[constants_1[_0x32b278(0x163)]+_0x32b278(0x1a1)]:_0x1994d2};await this[_0x32b278(0x1b4)][_0x32b278(0x12f)](flosum_constants_1[_0x32b278(0x1ab)][_0x32b278(0x139)]+'/'+constants_1[_0x32b278(0x163)]+_0x32b278(0x168)+this[_0x32b278(0x18c)],_0x2cc898),await this[_0x32b278(0x1b4)][_0x32b278(0x173)](flosum_constants_1[_0x32b278(0x1ab)][_0x32b278(0x139)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x32b278(0x136),_0x276a43),this[_0x32b278(0x1a9)][_0x32b278(0x15a)](_0x32b278(0x1b9)+(_0x50e5a6?_0x32b278(0x134):_0x32b278(0x1a4))+'.'),await this[_0x32b278(0x1a9)][_0x32b278(0x18b)]();}async[a377_0x1b3d2d(0x1a6)](){const _0x34f143=a377_0x1b3d2d;try{this[_0x34f143(0x158)]=await this['retrieveMetadataLog']();const _0x2eb9be=await this[_0x34f143(0x1ae)]();await this[_0x34f143(0x1a9)][_0x34f143(0x18b)]();const _0xf8dd10=await this['createZip'](_0x2eb9be),_0x41563c=await this['createVpk'](_0xf8dd10);await this[_0x34f143(0x1a9)][_0x34f143(0x18b)]();const _0x5ee88c=await this[_0x34f143(0x152)]['import'](_0x41563c);await this[_0x34f143(0x1a9)]['updateLog']();const _0x18b2cf=this['formFlosumDeploymentResults'](_0x5ee88c[_0x34f143(0x1a5)]);await this[_0x34f143(0x145)](_0x18b2cf),await this[_0x34f143(0x182)](_0x5ee88c[_0x34f143(0x149)],![],_0x5ee88c['packageId']);}catch(_0x20cdc4){await this[_0x34f143(0x19f)](_0x20cdc4)[_0x34f143(0x15b)](_0x57a3dd=>this[_0x34f143(0x14e)][_0x34f143(0x185)](_0x57a3dd));}}}exports[a377_0x1b3d2d(0x16d)]=RollbackService;