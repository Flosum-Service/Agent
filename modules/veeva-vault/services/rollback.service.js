const a393_0x3ef687=a393_0x1587;(function(_0x566280,_0x1c92d9){const _0x368edd=a393_0x1587,_0x245e3a=_0x566280();while(!![]){try{const _0x4adc55=-parseInt(_0x368edd(0x1d8))/0x1*(-parseInt(_0x368edd(0x1f5))/0x2)+parseInt(_0x368edd(0x195))/0x3*(parseInt(_0x368edd(0x18e))/0x4)+-parseInt(_0x368edd(0x1c5))/0x5+parseInt(_0x368edd(0x1f7))/0x6+-parseInt(_0x368edd(0x1b1))/0x7+-parseInt(_0x368edd(0x17d))/0x8+-parseInt(_0x368edd(0x1a8))/0x9;if(_0x4adc55===_0x1c92d9)break;else _0x245e3a['push'](_0x245e3a['shift']());}catch(_0x2cdbd9){_0x245e3a['push'](_0x245e3a['shift']());}}}(a393_0x3000,0x94b9e));const a393_0x4c40ec=(function(){let _0x792456=!![];return function(_0x1475fc,_0x33412a){const _0x3b92a2=_0x792456?function(){const _0x1dc580=a393_0x1587;if(_0x33412a){const _0x477d79=_0x33412a[_0x1dc580(0x1ca)](_0x1475fc,arguments);return _0x33412a=null,_0x477d79;}}:function(){};return _0x792456=![],_0x3b92a2;};}()),a393_0x28133f=a393_0x4c40ec(this,function(){const _0x340f55=a393_0x1587;return a393_0x28133f[_0x340f55(0x1a7)]()['search'](_0x340f55(0x1dc))['toString']()[_0x340f55(0x1d0)](a393_0x28133f)['search'](_0x340f55(0x1dc));});a393_0x28133f();function a393_0x1587(_0xae9ad,_0x18b802){const _0x2a98e5=a393_0x3000();return a393_0x1587=function(_0x28133f,_0x4c40ec){_0x28133f=_0x28133f-0x179;let _0x300044=_0x2a98e5[_0x28133f];return _0x300044;},a393_0x1587(_0xae9ad,_0x18b802);}'use strict';var __importDefault=this&&this[a393_0x3ef687(0x1ed)]||function(_0x4002b5){const _0x3939e4=a393_0x3ef687;return _0x4002b5&&_0x4002b5[_0x3939e4(0x1b7)]?_0x4002b5:{'default':_0x4002b5};};function a393_0x3000(){const _0x34a736=['FlosumConstants','bind','organizationId','405qbXhQn','IdDeploymentResultRetriever','VpkService','type','Success','_connectionSalesforce','updateLog','saveDeploymentResults','../../shared/utils/fetch-attachments','success','_metadataLogId','generate','../../../core','_componentIds','.zip','retrieveAttachments','slice','Branch__c','toString','1585773ZXxzoe','_parentMetadataLogId','retrieveBackup','_connectionVeeva','shortid','ENDPOINT_UPSERT_RECORD','Type__c','/vpk__','../classes/retrievers/deployment-results/id.deployment-result.retriever','4762639PcTItB','create','Result__c','/Attachment','Create\x20zip\x20from\x20backup','createZip','__esModule','packageComponentList','../enums/status.enums','Is_Error__c','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Rollback\x20completed\x20','retrieveRecords','successfully','from','Failure','./vpk.service','Create\x20Vpk\x20package','with\x20error','EXCEPTION','2785510ULDYSf','</a>','_instanceUrl','\x20has\x20been\x20created.','_logger','apply','status','base64','Activity_Type__c','log','\x27\x20AND\x20Name\x20=\x20\x27','constructor','\x27\x0a\x20\x20\x20\x20','_veevaService','finishRollbackWithError','catch','fetchAttachmentsDetailsById','Log__c','validate','2mDzvDO','text/plain','insertMultipleRecords','flat','(((.+)+)+)+$','Retrieve\x20Deployment\x20Results','isDeployed','../../../constants','fs/promises','Retrieve\x20Metadata\x20Log\x20info','veeva-rollback','lastIndexOf','Save\x20Deployment\x20Results','Component_Name__c','\x20>\x20','_tempFolder','_systemLogger','Cannot\x20find\x20Deployment\x20Results','\x20of\x20branch\x20to\x20Organization\x20','logError','stepName','__importDefault','DEPLOYED','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','map','formFlosumDeploymentResults','_metadataLog','Status__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','1156086ELRTYg','import','6519612rfjtuf','<a\x20href=','Body','Succeed__c','Job_Completed__c','ZipCreatorRollback','name','packageId','post','error','Date__c','finishRollback','MetadataLogDto','errors','saveLog','Deployment','Veeva\x20Rollback\x20(Deployment)','_salesforceService','deploymentAction','Veeva_Step_Name__c','retrieveDeploymentResults','External_Deployment_Id__c','3047080ZoQVRa','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','FLOSUM_NAMESPACE','createVpk','_vpkService','length','_attachmentLogId','retrieveMetadataLog','Retrieve\x20Backup','\x20</a>','MetadataLogStatus','COMPLETED','Component_Type__c','../classes/errors/salesforce-dml-error','default','writeFile','Save\x20log','4772tibpDa','filter','RollbackService','PackageComponentStatus'];a393_0x3000=function(){return _0x34a736;};return a393_0x3000();}Object['defineProperty'](exports,a393_0x3ef687(0x1b7),{'value':!![]}),exports[a393_0x3ef687(0x190)]=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require(a393_0x3ef687(0x1b0)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a393_0x3ef687(0x19d)),constants_1=require(a393_0x3ef687(0x1df)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a393_0x3ef687(0x1ac))),promises_1=require(a393_0x3ef687(0x1e0)),vpk_service_1=require(a393_0x3ef687(0x1c1)),status_enums_1=require(a393_0x3ef687(0x1b9)),salesforce_dml_error_1=require(a393_0x3ef687(0x18a)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a393_0x3ef687(0x1a1));class RollbackService{constructor({connectionSalesforce:_0x911056,connectionVeeva:_0x5b3a32,logger:_0x252e38,tempFolder:_0x385139,instanceUrl:_0x2f09b3,timeZone:_0x1d57cb,metadataLogId:_0x12aa13,attachmentLogId:_0x3d25a9,parentMetadataLogId:_0x353ee1,componentIds:_0x4e5563}){const _0xe588e4=a393_0x3ef687;this[_0xe588e4(0x19a)]=_0x911056,this[_0xe588e4(0x1ab)]=_0x5b3a32,this[_0xe588e4(0x1c9)]=_0x252e38,this[_0xe588e4(0x1e7)]=_0x385139,this[_0xe588e4(0x1c7)]=_0x2f09b3,this['_timeZone']=_0x1d57cb,this['_metadataLogId']=_0x12aa13,this[_0xe588e4(0x183)]=_0x3d25a9,this[_0xe588e4(0x1a9)]=_0x353ee1,this[_0xe588e4(0x1a2)]=_0x4e5563,this[_0xe588e4(0x1e8)]=new core_1['Logger'](_0xe588e4(0x1e2)),this[_0xe588e4(0x1d2)]=new veeva_service_1['VeevaService']({'connection':_0x5b3a32,'logger':_0x252e38}),this[_0xe588e4(0x208)]=new salesforce_service_1['SalesforceService']({'connection':_0x911056}),this['_packageImportService']=new package_import_service_1['PackageImportService']({'veevaService':this[_0xe588e4(0x1d2)],'connection':_0x5b3a32,'logger':_0x252e38,'saveLog':this[_0xe588e4(0x205)][_0xe588e4(0x193)](this)}),this[_0xe588e4(0x181)]=new vpk_service_1[(_0xe588e4(0x197))]({'connection':_0x5b3a32});}async['saveLog'](_0x2043e3,_0xc78da7){const _0x5ee8c4=a393_0x3ef687;this[_0x5ee8c4(0x1c9)][_0x5ee8c4(0x1ce)](_0x5ee8c4(0x18d));const _0x2e0051={'Body':Buffer[_0x5ee8c4(0x1bf)](_0x2043e3)[_0x5ee8c4(0x1a7)](_0x5ee8c4(0x1cc)),'ContentType':_0x5ee8c4(0x1d9),'ParentId':this[_0x5ee8c4(0x19f)],'Name':_0xc78da7};await this[_0x5ee8c4(0x19a)][_0x5ee8c4(0x1ff)](flosum_constants_1[_0x5ee8c4(0x192)]['ENDPOINT_UPSERT_RECORD']+_0x5ee8c4(0x1b4),_0x2e0051);}async[a393_0x3ef687(0x184)](){const _0x2d5709=a393_0x3ef687;this[_0x2d5709(0x1c9)][_0x2d5709(0x1ce)](_0x2d5709(0x1e1));const [_0x500e02]=await this[_0x2d5709(0x208)][_0x2d5709(0x1bd)](_0x2d5709(0x17e)+constants_1[_0x2d5709(0x17f)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x2d5709(0x17f)]+_0x2d5709(0x1ef)+constants_1['FLOSUM_NAMESPACE']+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1['FLOSUM_NAMESPACE']+_0x2d5709(0x1bb)+this[_0x2d5709(0x19f)]+_0x2d5709(0x1d1));return new metadata_log_dto_1[(_0x2d5709(0x203))](_0x500e02);}async[a393_0x3ef687(0x17b)](){const _0x2e7a4d=a393_0x3ef687;this[_0x2e7a4d(0x1c9)][_0x2e7a4d(0x1ce)](_0x2e7a4d(0x1dd));const _0x3d010a=await new id_deployment_result_retriever_1[(_0x2e7a4d(0x196))]({'salesforceService':this['_salesforceService'],'value':this[_0x2e7a4d(0x1a2)]})['retrieve']();if(!_0x3d010a[_0x2e7a4d(0x182)])throw new Error(_0x2e7a4d(0x1e9));return _0x3d010a;}async[a393_0x3ef687(0x1aa)](){const _0x214ef0=a393_0x3ef687;this[_0x214ef0(0x1c9)]['log'](_0x214ef0(0x185));const _0x4f8130=await this['_salesforceService']['retrieveRecords'](_0x214ef0(0x1f4)+this['_parentMetadataLogId']+_0x214ef0(0x1cf)+flosum_constants_1[_0x214ef0(0x192)]['BACKUP_ZIP_NAME']+_0x214ef0(0x1d1)),_0x354f74=await(0x0,fetch_attachments_1[_0x214ef0(0x1d5)])(this[_0x214ef0(0x19a)],[_0x4f8130[0x0]['Id']]),_0x20150b=await(0x0,fetch_attachments_1[_0x214ef0(0x1a4)])(_0x354f74,this[_0x214ef0(0x19a)]);if(!_0x20150b[_0x214ef0(0x182)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x20150b[0x0]['values'][_0x214ef0(0x1f9)];}async[a393_0x3ef687(0x1b6)](_0x473348){const _0x1a91f6=a393_0x3ef687;this[_0x1a91f6(0x1c9)][_0x1a91f6(0x1ce)](_0x1a91f6(0x1b5));const _0x195150=await this['retrieveBackup'](),_0x1b8937=await new zip_creator_rollback_1[(_0x1a91f6(0x1fc))]({'rollbackName':this[_0x1a91f6(0x1f2)]['name'],'backup':_0x195150,'deploymentResults':_0x473348})[_0x1a91f6(0x1b2)](),_0x1aa4bc=this['_tempFolder']+'/'+(0x0,shortid_1[_0x1a91f6(0x18b)])()+_0x1a91f6(0x1a3);return await(0x0,promises_1[_0x1a91f6(0x18c)])(_0x1aa4bc,_0x1b8937),_0x1aa4bc;}async[a393_0x3ef687(0x180)](_0x33b0fe){const _0x1c12a6=a393_0x3ef687;this[_0x1c12a6(0x1c9)]['log'](_0x1c12a6(0x1c2));const _0x5c69bf=await this['_vpkService'][_0x1c12a6(0x1a0)](_0x33b0fe),_0x23948c=this['_tempFolder']+_0x1c12a6(0x1af)+_0x33b0fe[_0x1c12a6(0x1a5)](_0x33b0fe[_0x1c12a6(0x1e3)]('/')+0x1);return await(0x0,promises_1[_0x1c12a6(0x18c)])(_0x23948c,_0x5c69bf),await this['_vpkService'][_0x1c12a6(0x1d7)](_0x23948c),_0x23948c;}[a393_0x3ef687(0x1f1)](_0x50b7f2){const _0xda199b=a393_0x3ef687;return this[_0xda199b(0x1c9)]['log']('Form\x20Deployment\x20Results'),_0x50b7f2[_0xda199b(0x1f0)](_0x419f50=>{const _0x3d4e16=_0xda199b;return this[_0x3d4e16(0x1c9)][_0x3d4e16(0x1ce)](_0x419f50[_0x3d4e16(0x198)]+'.'+_0x419f50[_0x3d4e16(0x1fd)]+'\x20:\x20'+_0x419f50[_0x3d4e16(0x1cb)]),{[constants_1[_0x3d4e16(0x17f)]+_0x3d4e16(0x1ae)]:'Deployment\x20Result',[constants_1[_0x3d4e16(0x17f)]+_0x3d4e16(0x1f3)]:_0x419f50[_0x3d4e16(0x1cb)]===status_enums_1[_0x3d4e16(0x191)][_0x3d4e16(0x1ee)]?_0x3d4e16(0x199):_0x3d4e16(0x1c0),[constants_1[_0x3d4e16(0x17f)]+_0x3d4e16(0x1b3)]:_0x419f50[_0x3d4e16(0x179)],[constants_1[_0x3d4e16(0x17f)]+_0x3d4e16(0x1e5)]:_0x419f50[_0x3d4e16(0x1fd)],[constants_1['FLOSUM_NAMESPACE']+_0x3d4e16(0x189)]:_0x419f50[_0x3d4e16(0x198)],[constants_1['FLOSUM_NAMESPACE']+_0x3d4e16(0x17a)]:_0x419f50[_0x3d4e16(0x1ec)],[constants_1[_0x3d4e16(0x17f)]+'Org__c']:this['_metadataLog'][_0x3d4e16(0x194)],[constants_1[_0x3d4e16(0x17f)]+'Metadata_Log__c']:this[_0x3d4e16(0x19f)]};});}async[a393_0x3ef687(0x19c)](_0x379586){const _0x2dca42=a393_0x3ef687;this['_logger']['log'](_0x2dca42(0x1e4));const _0x12e21c=await this[_0x2dca42(0x208)][_0x2dca42(0x1da)](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x379586),_0x3bff6e=_0x12e21c[_0x2dca42(0x18f)](_0x174479=>!_0x174479[_0x2dca42(0x19e)])['map'](_0x1d4b21=>_0x1d4b21[_0x2dca42(0x204)])[_0x2dca42(0x1db)]();if(_0x3bff6e['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x3bff6e);}async[a393_0x3ef687(0x1d3)](_0x20fc6d){const _0x162bc9=a393_0x3ef687;if(!this[_0x162bc9(0x1f2)]){this[_0x162bc9(0x1e8)][_0x162bc9(0x200)](_0x20fc6d);return;}this['_logger'][_0x162bc9(0x1eb)](_0x20fc6d),await this['_logger'][_0x162bc9(0x19b)](),await this[_0x162bc9(0x202)](![],!![],'');}async[a393_0x3ef687(0x202)](_0x214658,_0x1009e4,_0x529fd0){const _0x365b39=a393_0x3ef687,{id:_0xea9328,organizationId:_0xa7ddd1,branchId:_0x42cbdd,organizationName:_0x191ba6}=this['_metadataLog'],_0x1435f9=_0x365b39(0x1f8)+this['_instanceUrl']+'/'+_0xea9328+_0x365b39(0x1e6)+_0x365b39(0x207)+_0x365b39(0x186),_0x5ac0e0=_0x365b39(0x1f8)+this['_instanceUrl']+'/'+_0xa7ddd1+'\x20>'+_0x191ba6+_0x365b39(0x1c6),_0x25b5fb=_0x1435f9+_0x365b39(0x1ea)+_0x5ac0e0+_0x365b39(0x1c8),_0x2b568a={[constants_1['FLOSUM_NAMESPACE']+'Action__c']:_0x25b5fb,[constants_1['FLOSUM_NAMESPACE']+_0x365b39(0x201)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x365b39(0x1a6)]:_0x42cbdd,[constants_1[_0x365b39(0x17f)]+'Activity_Item__c']:'Branch',[constants_1['FLOSUM_NAMESPACE']+_0x365b39(0x1cd)]:_0x365b39(0x206),[constants_1[_0x365b39(0x17f)]+'TargetId__c']:_0xa7ddd1},_0x6edcf9={[constants_1[_0x365b39(0x17f)]+_0x365b39(0x1ba)]:!_0x214658,[constants_1['FLOSUM_NAMESPACE']+_0x365b39(0x1fa)]:_0x214658,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x1009e4?status_enums_1[_0x365b39(0x187)][_0x365b39(0x1c4)]:status_enums_1[_0x365b39(0x187)][_0x365b39(0x188)],[constants_1[_0x365b39(0x17f)]+_0x365b39(0x1fb)]:!![],[constants_1[_0x365b39(0x17f)]+_0x365b39(0x17c)]:_0x529fd0};await this[_0x365b39(0x19a)]['patch'](flosum_constants_1[_0x365b39(0x192)][_0x365b39(0x1ad)]+'/'+constants_1[_0x365b39(0x17f)]+'Metadata_Log__c/'+this[_0x365b39(0x19f)],_0x6edcf9),await this['_connectionSalesforce'][_0x365b39(0x1ff)](flosum_constants_1[_0x365b39(0x192)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1['FLOSUM_NAMESPACE']+_0x365b39(0x1d6),_0x2b568a),this[_0x365b39(0x1c9)][_0x365b39(0x1ce)](_0x365b39(0x1bc)+(_0x214658?_0x365b39(0x1be):_0x365b39(0x1c3))+'.'),await this['_logger']['updateLog']();}async['execute'](){const _0xbbac8a=a393_0x3ef687;try{this['_metadataLog']=await this['retrieveMetadataLog']();const _0xd54ce3=await this[_0xbbac8a(0x17b)]();await this['_logger'][_0xbbac8a(0x19b)]();const _0x5e91ce=await this[_0xbbac8a(0x1b6)](_0xd54ce3),_0x10a87a=await this[_0xbbac8a(0x180)](_0x5e91ce);await this[_0xbbac8a(0x1c9)][_0xbbac8a(0x19b)]();const _0x210a50=await this['_packageImportService'][_0xbbac8a(0x1f6)](_0x10a87a);await this['_logger'][_0xbbac8a(0x19b)]();const _0x149e59=this[_0xbbac8a(0x1f1)](_0x210a50[_0xbbac8a(0x1b8)]);await this[_0xbbac8a(0x19c)](_0x149e59),await this['finishRollback'](_0x210a50[_0xbbac8a(0x1de)],![],_0x210a50[_0xbbac8a(0x1fe)]);}catch(_0x91deee){await this['finishRollbackWithError'](_0x91deee)[_0xbbac8a(0x1d4)](_0x3d9219=>this[_0xbbac8a(0x1e8)]['error'](_0x3d9219));}}}exports[a393_0x3ef687(0x190)]=RollbackService;