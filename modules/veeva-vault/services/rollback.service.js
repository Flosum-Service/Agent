const a360_0x2ea306=a360_0x4374;(function(_0x440a53,_0x4c8e67){const _0x4077a7=a360_0x4374,_0x1588d6=_0x440a53();while(!![]){try{const _0x4dfbe8=parseInt(_0x4077a7(0x217))/0x1*(parseInt(_0x4077a7(0x214))/0x2)+parseInt(_0x4077a7(0x1f0))/0x3*(parseInt(_0x4077a7(0x1e7))/0x4)+parseInt(_0x4077a7(0x249))/0x5+parseInt(_0x4077a7(0x248))/0x6+-parseInt(_0x4077a7(0x1ec))/0x7+-parseInt(_0x4077a7(0x24f))/0x8+-parseInt(_0x4077a7(0x1ee))/0x9*(parseInt(_0x4077a7(0x23a))/0xa);if(_0x4dfbe8===_0x4c8e67)break;else _0x1588d6['push'](_0x1588d6['shift']());}catch(_0x8d6865){_0x1588d6['push'](_0x1588d6['shift']());}}}(a360_0x1d82,0x9fa6b));const a360_0x29dc18=(function(){let _0x384949=!![];return function(_0x534a9d,_0x4b30e6){const _0x3e294f=_0x384949?function(){const _0x5b5868=a360_0x4374;if(_0x4b30e6){const _0x4f8721=_0x4b30e6[_0x5b5868(0x1d5)](_0x534a9d,arguments);return _0x4b30e6=null,_0x4f8721;}}:function(){};return _0x384949=![],_0x3e294f;};}()),a360_0x2e55fe=a360_0x29dc18(this,function(){const _0x3a6491=a360_0x4374;return a360_0x2e55fe['toString']()['search'](_0x3a6491(0x230))[_0x3a6491(0x1de)]()[_0x3a6491(0x1f7)](a360_0x2e55fe)[_0x3a6491(0x1cf)](_0x3a6491(0x230));});a360_0x2e55fe();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x570bb9){const _0x1678a6=a360_0x4374;return _0x570bb9&&_0x570bb9[_0x1678a6(0x255)]?_0x570bb9:{'default':_0x570bb9};};Object['defineProperty'](exports,a360_0x2ea306(0x255),{'value':!![]}),exports[a360_0x2ea306(0x20e)]=void 0x0;const veeva_service_1=require(a360_0x2ea306(0x1ce)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a360_0x2ea306(0x1d9)),id_deployment_result_retriever_1=require(a360_0x2ea306(0x1e2)),flosum_constants_1=require(a360_0x2ea306(0x257)),fetch_attachments_1=require(a360_0x2ea306(0x226)),constants_1=require(a360_0x2ea306(0x207)),zip_creator_rollback_1=require(a360_0x2ea306(0x22f)),shortid_1=__importDefault(require(a360_0x2ea306(0x240))),promises_1=require(a360_0x2ea306(0x23c)),vpk_service_1=require(a360_0x2ea306(0x24d)),status_enums_1=require(a360_0x2ea306(0x22e)),salesforce_dml_error_1=require(a360_0x2ea306(0x21b)),metadata_log_dto_1=require(a360_0x2ea306(0x1f9)),core_1=require(a360_0x2ea306(0x215));function a360_0x1d82(){const _0x35b67f=['264038aOEtYK','../../../core','_attachmentLogId','2BAtFJD','_packageImportService','\x20of\x20branch\x20to\x20Organization\x20','_tempFolder','../classes/errors/salesforce-dml-error','_systemLogger','import','from','map','FlosumConstants','Metadata_Log__c/','retrieve','Job_Completed__c','with\x20error','/Attachment','../../shared/utils/fetch-attachments','COMPLETED','bind','catch','Success','_logger','insertMultipleRecords','Rollback\x20completed\x20','../enums/status.enums','../classes/rollback/zip-creator.rollback','(((.+)+)+)+$','name','updateLog','Activity_Item__c','retrieveRecords','\x20</a>','fetchAttachmentsDetailsById','_vpkService','VeevaService','Component_Type__c','10dZKWnO','Result__c','fs/promises','Logger','FLOSUM_NAMESPACE','Org__c','shortid','Form\x20Deployment\x20Results','Is_Error__c','Save\x20log','Failure','Status__c','createZip','SalesforceDmlError','7570302OmKJnj','2558375oTQFgl','<a\x20href=','Action__c','\x20>\x20','./vpk.service','success','7452432GztoGe','slice','retrieveAttachments','error','Create\x20zip\x20from\x20backup','deploymentAction','__esModule','veeva-rollback','../constants/flosum.constants','retrieveBackup','default','text/plain','finishRollbackWithError','patch','Component_Name__c','./veeva.service','search','_metadataLog','\x27\x20AND\x20Name\x20=\x20\x27','post','Veeva\x20Rollback\x20(Deployment)','_metadataLogId','apply','_veevaService','Cannot\x20find\x20Deployment\x20Results','status','./package-import.service','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Type__c','_instanceUrl','toString','/vpk__','\x27\x0a\x20\x20\x20\x20','SalesforceService','../classes/retrievers/deployment-results/id.deployment-result.retriever','log','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','MetadataLogStatus','type','28vlsIAX','_componentIds','ZipCreatorRollback','saveLog','Body','4713051FOAQJQ','Async_Request_Id__c','2511234eiIwoi','Retrieve\x20Backup','214446MTdNJp','Branch','saveDeploymentResults','packageComponentList','PackageComponentStatus','validate','_connectionSalesforce','constructor','Retrieve\x20Deployment\x20Results','../dtos/metadata-log.dto','organizationId','length','Activity_Type__c','formFlosumDeploymentResults','packageId','_parentMetadataLogId','filter','writeFile','Date__c','ENDPOINT_UPSERT_RECORD','\x20has\x20been\x20created.','EXCEPTION','PackageImportService','../../../constants','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','errors','logError','values','finishRollback','stepName','RollbackService','_salesforceService','base64','retrieveMetadataLog','Save\x20Deployment\x20Results','VpkService'];a360_0x1d82=function(){return _0x35b67f;};return a360_0x1d82();}function a360_0x4374(_0x82290d,_0x210ad8){const _0x334949=a360_0x1d82();return a360_0x4374=function(_0x2e55fe,_0x29dc18){_0x2e55fe=_0x2e55fe-0x1cb;let _0x1d8265=_0x334949[_0x2e55fe];return _0x1d8265;},a360_0x4374(_0x82290d,_0x210ad8);}class RollbackService{constructor({connectionSalesforce:_0x1d8734,connectionVeeva:_0x38014a,logger:_0x563bc9,tempFolder:_0x5a6c5c,instanceUrl:_0x388133,timeZone:_0x3f1a44,metadataLogId:_0x352654,attachmentLogId:_0x559e45,parentMetadataLogId:_0x2a5574,componentIds:_0x537bf2}){const _0x4f146e=a360_0x2ea306;this['_connectionSalesforce']=_0x1d8734,this['_connectionVeeva']=_0x38014a,this[_0x4f146e(0x22b)]=_0x563bc9,this[_0x4f146e(0x21a)]=_0x5a6c5c,this[_0x4f146e(0x1dd)]=_0x388133,this['_timeZone']=_0x3f1a44,this[_0x4f146e(0x1d4)]=_0x352654,this[_0x4f146e(0x216)]=_0x559e45,this[_0x4f146e(0x1ff)]=_0x2a5574,this['_componentIds']=_0x537bf2,this[_0x4f146e(0x21c)]=new core_1[(_0x4f146e(0x23d))](_0x4f146e(0x256)),this[_0x4f146e(0x1d6)]=new veeva_service_1[(_0x4f146e(0x238))]({'connection':_0x38014a,'logger':_0x563bc9}),this[_0x4f146e(0x20f)]=new salesforce_service_1[(_0x4f146e(0x1e1))]({'connection':_0x1d8734}),this[_0x4f146e(0x218)]=new package_import_service_1[(_0x4f146e(0x206))]({'veevaService':this[_0x4f146e(0x1d6)],'connection':_0x38014a,'logger':_0x563bc9,'saveLog':this[_0x4f146e(0x1ea)][_0x4f146e(0x228)](this)}),this[_0x4f146e(0x237)]=new vpk_service_1[(_0x4f146e(0x213))]({'connection':_0x38014a});}async[a360_0x2ea306(0x1ea)](_0x2c92ab,_0x293c1c){const _0x476b10=a360_0x2ea306;this[_0x476b10(0x22b)][_0x476b10(0x1e3)](_0x476b10(0x243));const _0x550ebc={'Body':Buffer[_0x476b10(0x21e)](_0x2c92ab)[_0x476b10(0x1de)](_0x476b10(0x210)),'ContentType':_0x476b10(0x25a),'ParentId':this[_0x476b10(0x1d4)],'Name':_0x293c1c};await this[_0x476b10(0x1f6)]['post'](flosum_constants_1['FlosumConstants'][_0x476b10(0x203)]+_0x476b10(0x225),_0x550ebc);}async['retrieveMetadataLog'](){const _0xcd345e=a360_0x2ea306;this[_0xcd345e(0x22b)][_0xcd345e(0x1e3)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x3906ff]=await this[_0xcd345e(0x20f)][_0xcd345e(0x234)](_0xcd345e(0x1db)+constants_1[_0xcd345e(0x23e)]+_0xcd345e(0x1da)+constants_1[_0xcd345e(0x23e)]+_0xcd345e(0x1e4)+constants_1['FLOSUM_NAMESPACE']+_0xcd345e(0x208)+constants_1['FLOSUM_NAMESPACE']+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0xcd345e(0x1d4)]+_0xcd345e(0x1e0));return new metadata_log_dto_1['MetadataLogDto'](_0x3906ff);}async['retrieveDeploymentResults'](){const _0x21a6f4=a360_0x2ea306;this['_logger']['log'](_0x21a6f4(0x1f8));const _0x2059cf=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x21a6f4(0x20f)],'value':this[_0x21a6f4(0x1e8)]})[_0x21a6f4(0x222)]();if(!_0x2059cf[_0x21a6f4(0x1fb)])throw new Error(_0x21a6f4(0x1d7));return _0x2059cf;}async['retrieveBackup'](){const _0x5d7f8b=a360_0x2ea306;this[_0x5d7f8b(0x22b)]['log'](_0x5d7f8b(0x1ef));const _0x3b02b3=await this[_0x5d7f8b(0x20f)]['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this['_parentMetadataLogId']+_0x5d7f8b(0x1d1)+flosum_constants_1[_0x5d7f8b(0x220)]['BACKUP_ZIP_NAME']+_0x5d7f8b(0x1e0)),_0x2814e1=await(0x0,fetch_attachments_1[_0x5d7f8b(0x236)])(this[_0x5d7f8b(0x1f6)],[_0x3b02b3[0x0]['Id']]),_0x1d8787=await(0x0,fetch_attachments_1[_0x5d7f8b(0x251)])(_0x2814e1,this['_connectionSalesforce']);if(!_0x1d8787[_0x5d7f8b(0x1fb)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x1d8787[0x0][_0x5d7f8b(0x20b)][_0x5d7f8b(0x1eb)];}async['createZip'](_0x4025a3){const _0x378d96=a360_0x2ea306;this[_0x378d96(0x22b)][_0x378d96(0x1e3)](_0x378d96(0x253));const _0x12912f=await this[_0x378d96(0x258)](),_0x1798d1=await new zip_creator_rollback_1[(_0x378d96(0x1e9))]({'rollbackName':this[_0x378d96(0x1d0)]['name'],'backup':_0x12912f,'deploymentResults':_0x4025a3})['create'](),_0x4974fc=this['_tempFolder']+'/'+(0x0,shortid_1[_0x378d96(0x259)])()+'.zip';return await(0x0,promises_1[_0x378d96(0x201)])(_0x4974fc,_0x1798d1),_0x4974fc;}async['createVpk'](_0x1f3bbb){const _0xc83ed1=a360_0x2ea306;this[_0xc83ed1(0x22b)][_0xc83ed1(0x1e3)]('Create\x20Vpk\x20package');const _0x1113bb=await this[_0xc83ed1(0x237)]['generate'](_0x1f3bbb),_0x4b7f26=this['_tempFolder']+_0xc83ed1(0x1df)+_0x1f3bbb[_0xc83ed1(0x250)](_0x1f3bbb['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0xc83ed1(0x201)])(_0x4b7f26,_0x1113bb),await this['_vpkService'][_0xc83ed1(0x1f5)](_0x4b7f26),_0x4b7f26;}[a360_0x2ea306(0x1fd)](_0x300ee5){const _0x2ebd80=a360_0x2ea306;return this[_0x2ebd80(0x22b)][_0x2ebd80(0x1e3)](_0x2ebd80(0x241)),_0x300ee5[_0x2ebd80(0x21f)](_0x61f51e=>{const _0x20f9ff=_0x2ebd80;return this[_0x20f9ff(0x22b)][_0x20f9ff(0x1e3)](_0x61f51e[_0x20f9ff(0x1e6)]+'.'+_0x61f51e['name']+'\x20:\x20'+_0x61f51e[_0x20f9ff(0x1d8)]),{[constants_1[_0x20f9ff(0x23e)]+_0x20f9ff(0x1dc)]:'Deployment\x20Result',[constants_1[_0x20f9ff(0x23e)]+_0x20f9ff(0x245)]:_0x61f51e['status']===status_enums_1[_0x20f9ff(0x1f4)]['DEPLOYED']?_0x20f9ff(0x22a):_0x20f9ff(0x244),[constants_1[_0x20f9ff(0x23e)]+_0x20f9ff(0x23b)]:_0x61f51e[_0x20f9ff(0x254)],[constants_1[_0x20f9ff(0x23e)]+_0x20f9ff(0x1cd)]:_0x61f51e[_0x20f9ff(0x231)],[constants_1[_0x20f9ff(0x23e)]+_0x20f9ff(0x239)]:_0x61f51e[_0x20f9ff(0x1e6)],[constants_1[_0x20f9ff(0x23e)]+'Veeva_Step_Name__c']:_0x61f51e[_0x20f9ff(0x20d)],[constants_1[_0x20f9ff(0x23e)]+_0x20f9ff(0x23f)]:this[_0x20f9ff(0x1d0)][_0x20f9ff(0x1fa)],[constants_1[_0x20f9ff(0x23e)]+'Metadata_Log__c']:this['_metadataLogId']};});}async[a360_0x2ea306(0x1f2)](_0x32ce3d){const _0x47aca1=a360_0x2ea306;this[_0x47aca1(0x22b)][_0x47aca1(0x1e3)](_0x47aca1(0x212));const _0x5eb081=await this[_0x47aca1(0x20f)][_0x47aca1(0x22c)](constants_1[_0x47aca1(0x23e)]+'Deployment_Result__c',_0x32ce3d),_0x17c737=_0x5eb081[_0x47aca1(0x200)](_0x254719=>!_0x254719[_0x47aca1(0x24e)])[_0x47aca1(0x21f)](_0x1b9238=>_0x1b9238[_0x47aca1(0x209)])['flat']();if(_0x17c737['length'])throw new salesforce_dml_error_1[(_0x47aca1(0x247))](_0x17c737);}async['finishRollbackWithError'](_0x1867c1){const _0x33821d=a360_0x2ea306;if(!this['_metadataLog']){this[_0x33821d(0x21c)][_0x33821d(0x252)](_0x1867c1);return;}this['_logger'][_0x33821d(0x20a)](_0x1867c1),await this[_0x33821d(0x22b)][_0x33821d(0x232)](),await this[_0x33821d(0x20c)](![],!![],'');}async[a360_0x2ea306(0x20c)](_0x41c774,_0x54021e,_0x3f40d3){const _0x5e349d=a360_0x2ea306,{id:_0x175db5,organizationId:_0x4c9b23,branchId:_0x1a89a2,organizationName:_0x28f860}=this[_0x5e349d(0x1d0)],_0x3f72e6=_0x5e349d(0x24a)+this['_instanceUrl']+'/'+_0x175db5+_0x5e349d(0x24c)+_0x5e349d(0x1d3)+_0x5e349d(0x235),_0x10c802=_0x5e349d(0x24a)+this[_0x5e349d(0x1dd)]+'/'+_0x4c9b23+'\x20>'+_0x28f860+'</a>',_0x15df42=_0x3f72e6+_0x5e349d(0x219)+_0x10c802+_0x5e349d(0x204),_0x1297b9={[constants_1[_0x5e349d(0x23e)]+_0x5e349d(0x24b)]:_0x15df42,[constants_1[_0x5e349d(0x23e)]+_0x5e349d(0x202)]:new Date(),[constants_1[_0x5e349d(0x23e)]+'Branch__c']:_0x1a89a2,[constants_1[_0x5e349d(0x23e)]+_0x5e349d(0x233)]:_0x5e349d(0x1f1),[constants_1['FLOSUM_NAMESPACE']+_0x5e349d(0x1fc)]:'Deployment',[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:_0x4c9b23},_0x383905={[constants_1[_0x5e349d(0x23e)]+_0x5e349d(0x242)]:!_0x41c774,[constants_1[_0x5e349d(0x23e)]+'Succeed__c']:_0x41c774,[constants_1['FLOSUM_NAMESPACE']+_0x5e349d(0x245)]:_0x54021e?status_enums_1['MetadataLogStatus'][_0x5e349d(0x205)]:status_enums_1[_0x5e349d(0x1e5)][_0x5e349d(0x227)],[constants_1[_0x5e349d(0x23e)]+_0x5e349d(0x223)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x5e349d(0x1ed)]:_0x3f40d3};await this[_0x5e349d(0x1f6)][_0x5e349d(0x1cc)](flosum_constants_1[_0x5e349d(0x220)][_0x5e349d(0x203)]+'/'+constants_1[_0x5e349d(0x23e)]+_0x5e349d(0x221)+this['_metadataLogId'],_0x383905),await this[_0x5e349d(0x1f6)][_0x5e349d(0x1d2)](flosum_constants_1[_0x5e349d(0x220)][_0x5e349d(0x203)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0x1297b9),this[_0x5e349d(0x22b)][_0x5e349d(0x1e3)](_0x5e349d(0x22d)+(_0x41c774?'successfully':_0x5e349d(0x224))+'.'),await this[_0x5e349d(0x22b)][_0x5e349d(0x232)]();}async['execute'](){const _0x42db3d=a360_0x2ea306;try{this[_0x42db3d(0x1d0)]=await this[_0x42db3d(0x211)]();const _0x4f8b18=await this['retrieveDeploymentResults']();await this[_0x42db3d(0x22b)][_0x42db3d(0x232)]();const _0x13e003=await this[_0x42db3d(0x246)](_0x4f8b18),_0x14cd0b=await this['createVpk'](_0x13e003);await this[_0x42db3d(0x22b)][_0x42db3d(0x232)]();const _0x37dda8=await this['_packageImportService'][_0x42db3d(0x21d)](_0x14cd0b);await this[_0x42db3d(0x22b)][_0x42db3d(0x232)]();const _0x434107=this[_0x42db3d(0x1fd)](_0x37dda8[_0x42db3d(0x1f3)]);await this[_0x42db3d(0x1f2)](_0x434107),await this[_0x42db3d(0x20c)](_0x37dda8['isDeployed'],![],_0x37dda8[_0x42db3d(0x1fe)]);}catch(_0x367d0d){await this[_0x42db3d(0x1cb)](_0x367d0d)[_0x42db3d(0x229)](_0xde22a=>this[_0x42db3d(0x21c)][_0x42db3d(0x252)](_0xde22a));}}}exports[a360_0x2ea306(0x20e)]=RollbackService;