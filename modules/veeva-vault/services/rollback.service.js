const a405_0x49a450=a405_0x423d;function a405_0x164f(){const _0x3aab35=['(((.+)+)+)+$','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','\x27\x0a\x20\x20\x20\x20','\x20:\x20','Logger','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','<a\x20href=','retrieveMetadataLog','\x27\x20AND\x20Name\x20=\x20\x27','slice','packageId','name','./salesforce.service','Deployment\x20Result','Retrieve\x20Backup','_parentMetadataLogId','finishRollbackWithError','createZip','../enums/status.enums','SalesforceService','base64','Is_Error__c','Deployment','RollbackService','../classes/errors/salesforce-dml-error','MetadataLogDto','4271703seEwPO','default','updateLog','\x20of\x20branch\x20to\x20Organization\x20','from','ZipCreatorRollback','isDeployed','\x20>\x20','saveDeploymentResults','Metadata_Log__c','map','Form\x20Deployment\x20Results','Org__c','_salesforceService','../dtos/metadata-log.dto','retrieveAttachments','4zfayeb','_metadataLogId','finishRollback','810599IZumPL','Retrieve\x20Deployment\x20Results','VeevaService','\x20</a>','16388622XsAJxB','retrieveRecords','2VcmlST','_connectionSalesforce','.zip','values','/vpk__','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Create\x20Vpk\x20package','status','success','Create\x20zip\x20from\x20backup','Save\x20log','EXCEPTION','/Attachment','deploymentAction','Result__c','apply','BACKUP_ZIP_NAME','../../../core','Component_Type__c','retrieve','__importDefault','_connectionVeeva','retrieveBackup','Component_Name__c','COMPLETED','Deployment_Result__c','Type__c','_metadataLog','writeFile','_tempFolder','1256UctgcY','__esModule','6946420RSYFXC','TargetId__c','40565590fhahWL','_systemLogger','errors','logError','MetadataLogStatus','_vpkService','../../shared/utils/fetch-attachments','insertMultipleRecords','PackageImportService','Job_Completed__c','_componentIds','length','_timeZone','shortid','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','error','_logger','Log__c','Status__c','Cannot\x20find\x20Backup\x20Zip','3186714FNJvtk','Action__c','filter','./vpk.service','../classes/retrievers/deployment-results/id.deployment-result.retriever','_attachmentLogId','constructor','post','PackageComponentStatus','Rollback\x20completed\x20','log','Failure','VpkService','FLOSUM_NAMESPACE','IdDeploymentResultRetriever','validate','SalesforceDmlError','bind','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','createVpk','_instanceUrl','with\x20error','Retrieve\x20Metadata\x20Log\x20info','search','46858QaZIDy','./package-import.service','ENDPOINT_UPSERT_RECORD','successfully','defineProperty','Activity_Item__c','catch','Body','execute','External_Deployment_Id__c','_packageImportService','Success','</a>','stepName','Date__c','fs/promises','saveLog','_veevaService','FlosumConstants','lastIndexOf','retrieveDeploymentResults','text/plain','type','Veeva_Step_Name__c'];a405_0x164f=function(){return _0x3aab35;};return a405_0x164f();}(function(_0x5bbfee,_0x5c2b79){const _0x5236d9=a405_0x423d,_0xdc6f20=_0x5bbfee();while(!![]){try{const _0x5b85de=parseInt(_0x5236d9(0xb1))/0x1*(-parseInt(_0x5236d9(0xb7))/0x2)+parseInt(_0x5236d9(0x9e))/0x3*(parseInt(_0x5236d9(0xae))/0x4)+-parseInt(_0x5236d9(0xd7))/0x5+parseInt(_0x5236d9(0xed))/0x6+parseInt(_0x5236d9(0x105))/0x7*(-parseInt(_0x5236d9(0xd5))/0x8)+-parseInt(_0x5236d9(0xb5))/0x9+parseInt(_0x5236d9(0xd9))/0xa;if(_0x5b85de===_0x5c2b79)break;else _0xdc6f20['push'](_0xdc6f20['shift']());}catch(_0x5844ed){_0xdc6f20['push'](_0xdc6f20['shift']());}}}(a405_0x164f,0xe5704));const a405_0x3f7cf6=(function(){let _0x4e58b1=!![];return function(_0x1badbf,_0x46e069){const _0x12272b=_0x4e58b1?function(){const _0x75cee0=a405_0x423d;if(_0x46e069){const _0x18f60f=_0x46e069[_0x75cee0(0xc6)](_0x1badbf,arguments);return _0x46e069=null,_0x18f60f;}}:function(){};return _0x4e58b1=![],_0x12272b;};}()),a405_0x5eae1d=a405_0x3f7cf6(this,function(){const _0x1ed517=a405_0x423d;return a405_0x5eae1d['toString']()[_0x1ed517(0x104)](_0x1ed517(0x11d))['toString']()[_0x1ed517(0xf3)](a405_0x5eae1d)['search'](_0x1ed517(0x11d));});a405_0x5eae1d();'use strict';function a405_0x423d(_0x3f1e82,_0x115544){const _0x2f8d42=a405_0x164f();return a405_0x423d=function(_0x5eae1d,_0x3f7cf6){_0x5eae1d=_0x5eae1d-0x97;let _0x164fd0=_0x2f8d42[_0x5eae1d];return _0x164fd0;},a405_0x423d(_0x3f1e82,_0x115544);}var __importDefault=this&&this[a405_0x49a450(0xcb)]||function(_0x57148a){return _0x57148a&&_0x57148a['__esModule']?_0x57148a:{'default':_0x57148a};};Object[a405_0x49a450(0x109)](exports,a405_0x49a450(0xd6),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a405_0x49a450(0x129)),package_import_service_1=require(a405_0x49a450(0x106)),id_deployment_result_retriever_1=require(a405_0x49a450(0xf1)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a405_0x49a450(0xdf)),constants_1=require('../../../constants'),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a405_0x49a450(0xe6))),promises_1=require(a405_0x49a450(0x114)),vpk_service_1=require(a405_0x49a450(0xf0)),status_enums_1=require(a405_0x49a450(0x12f)),salesforce_dml_error_1=require(a405_0x49a450(0x9c)),metadata_log_dto_1=require(a405_0x49a450(0xac)),core_1=require(a405_0x49a450(0xc8));class RollbackService{constructor({connectionSalesforce:_0x516f56,connectionVeeva:_0x5a944,logger:_0x409cf2,tempFolder:_0x26c6f3,instanceUrl:_0x45c208,timeZone:_0x2914d8,metadataLogId:_0x1275d5,attachmentLogId:_0xf5b377,parentMetadataLogId:_0x39ddf8,componentIds:_0x11f8a4}){const _0x32bef2=a405_0x49a450;this[_0x32bef2(0xb8)]=_0x516f56,this[_0x32bef2(0xcc)]=_0x5a944,this[_0x32bef2(0xe9)]=_0x409cf2,this['_tempFolder']=_0x26c6f3,this[_0x32bef2(0x101)]=_0x45c208,this[_0x32bef2(0xe5)]=_0x2914d8,this[_0x32bef2(0xaf)]=_0x1275d5,this[_0x32bef2(0xf2)]=_0xf5b377,this[_0x32bef2(0x12c)]=_0x39ddf8,this[_0x32bef2(0xe3)]=_0x11f8a4,this[_0x32bef2(0xda)]=new core_1[(_0x32bef2(0x121))]('veeva-rollback'),this['_veevaService']=new veeva_service_1[(_0x32bef2(0xb3))]({'connection':_0x5a944,'logger':_0x409cf2}),this[_0x32bef2(0xab)]=new salesforce_service_1[(_0x32bef2(0x97))]({'connection':_0x516f56}),this['_packageImportService']=new package_import_service_1[(_0x32bef2(0xe1))]({'veevaService':this[_0x32bef2(0x116)],'connection':_0x5a944,'logger':_0x409cf2,'saveLog':this[_0x32bef2(0x115)][_0x32bef2(0xfe)](this)}),this[_0x32bef2(0xde)]=new vpk_service_1[(_0x32bef2(0xf9))]({'connection':_0x5a944});}async['saveLog'](_0x2dc4bb,_0x4b15fa){const _0x53318=a405_0x49a450;this[_0x53318(0xe9)][_0x53318(0xf7)](_0x53318(0xc1));const _0x2aa0b5={'Body':Buffer[_0x53318(0xa2)](_0x2dc4bb)['toString'](_0x53318(0x98)),'ContentType':_0x53318(0x11a),'ParentId':this[_0x53318(0xaf)],'Name':_0x4b15fa};await this[_0x53318(0xb8)][_0x53318(0xf4)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0x53318(0xc3),_0x2aa0b5);}async[a405_0x49a450(0x124)](){const _0x1478b5=a405_0x49a450;this[_0x1478b5(0xe9)]['log'](_0x1478b5(0x103));const [_0x3c1e47]=await this[_0x1478b5(0xab)][_0x1478b5(0xb6)](_0x1478b5(0xff)+constants_1[_0x1478b5(0xfa)]+_0x1478b5(0xbc)+constants_1[_0x1478b5(0xfa)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x1478b5(0xfa)]+_0x1478b5(0xe7)+constants_1[_0x1478b5(0xfa)]+_0x1478b5(0x11e)+this[_0x1478b5(0xaf)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x1478b5(0x9d))](_0x3c1e47);}async[a405_0x49a450(0x119)](){const _0x2a7b66=a405_0x49a450;this[_0x2a7b66(0xe9)]['log'](_0x2a7b66(0xb2));const _0x339aff=await new id_deployment_result_retriever_1[(_0x2a7b66(0xfb))]({'salesforceService':this[_0x2a7b66(0xab)],'value':this[_0x2a7b66(0xe3)]})[_0x2a7b66(0xca)]();if(!_0x339aff[_0x2a7b66(0xe4)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x339aff;}async[a405_0x49a450(0xcd)](){const _0x5c80d0=a405_0x49a450;this[_0x5c80d0(0xe9)][_0x5c80d0(0xf7)](_0x5c80d0(0x12b));const _0x5427fd=await this[_0x5c80d0(0xab)][_0x5c80d0(0xb6)](_0x5c80d0(0x122)+this[_0x5c80d0(0x12c)]+_0x5c80d0(0x125)+flosum_constants_1[_0x5c80d0(0x117)][_0x5c80d0(0xc7)]+_0x5c80d0(0x11f)),_0x4a014c=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x5c80d0(0xb8)],[_0x5427fd[0x0]['Id']]),_0x3bc5c0=await(0x0,fetch_attachments_1[_0x5c80d0(0xad)])(_0x4a014c,this[_0x5c80d0(0xb8)]);if(!_0x3bc5c0['length'])throw new Error(_0x5c80d0(0xec));return _0x3bc5c0[0x0][_0x5c80d0(0xba)][_0x5c80d0(0x10c)];}async[a405_0x49a450(0x12e)](_0x165847){const _0x406627=a405_0x49a450;this[_0x406627(0xe9)][_0x406627(0xf7)](_0x406627(0xc0));const _0x7f14e0=await this[_0x406627(0xcd)](),_0x55399d=await new zip_creator_rollback_1[(_0x406627(0xa3))]({'rollbackName':this[_0x406627(0xd2)]['name'],'backup':_0x7f14e0,'deploymentResults':_0x165847})['create'](),_0x2fa3a8=this[_0x406627(0xd4)]+'/'+(0x0,shortid_1[_0x406627(0x9f)])()+_0x406627(0xb9);return await(0x0,promises_1[_0x406627(0xd3)])(_0x2fa3a8,_0x55399d),_0x2fa3a8;}async[a405_0x49a450(0x100)](_0x5ab1f5){const _0x3d4be4=a405_0x49a450;this[_0x3d4be4(0xe9)][_0x3d4be4(0xf7)](_0x3d4be4(0xbd));const _0xa71af4=await this['_vpkService']['generate'](_0x5ab1f5),_0x1e0c4c=this[_0x3d4be4(0xd4)]+_0x3d4be4(0xbb)+_0x5ab1f5[_0x3d4be4(0x126)](_0x5ab1f5[_0x3d4be4(0x118)]('/')+0x1);return await(0x0,promises_1[_0x3d4be4(0xd3)])(_0x1e0c4c,_0xa71af4),await this[_0x3d4be4(0xde)][_0x3d4be4(0xfc)](_0x1e0c4c),_0x1e0c4c;}['formFlosumDeploymentResults'](_0x5acdfe){const _0x311473=a405_0x49a450;return this[_0x311473(0xe9)][_0x311473(0xf7)](_0x311473(0xa9)),_0x5acdfe['map'](_0x274263=>{const _0x3eb76d=_0x311473;return this[_0x3eb76d(0xe9)][_0x3eb76d(0xf7)](_0x274263[_0x3eb76d(0x11b)]+'.'+_0x274263[_0x3eb76d(0x128)]+_0x3eb76d(0x120)+_0x274263['status']),{[constants_1[_0x3eb76d(0xfa)]+_0x3eb76d(0xd1)]:_0x3eb76d(0x12a),[constants_1[_0x3eb76d(0xfa)]+_0x3eb76d(0xeb)]:_0x274263[_0x3eb76d(0xbe)]===status_enums_1[_0x3eb76d(0xf5)]['DEPLOYED']?_0x3eb76d(0x110):_0x3eb76d(0xf8),[constants_1[_0x3eb76d(0xfa)]+_0x3eb76d(0xc5)]:_0x274263[_0x3eb76d(0xc4)],[constants_1['FLOSUM_NAMESPACE']+_0x3eb76d(0xce)]:_0x274263['name'],[constants_1[_0x3eb76d(0xfa)]+_0x3eb76d(0xc9)]:_0x274263[_0x3eb76d(0x11b)],[constants_1[_0x3eb76d(0xfa)]+_0x3eb76d(0x11c)]:_0x274263[_0x3eb76d(0x112)],[constants_1[_0x3eb76d(0xfa)]+_0x3eb76d(0xaa)]:this[_0x3eb76d(0xd2)]['organizationId'],[constants_1[_0x3eb76d(0xfa)]+_0x3eb76d(0xa7)]:this['_metadataLogId']};});}async[a405_0x49a450(0xa6)](_0x1ced64){const _0x41f7ce=a405_0x49a450;this[_0x41f7ce(0xe9)]['log']('Save\x20Deployment\x20Results');const _0x45b09e=await this['_salesforceService'][_0x41f7ce(0xe0)](constants_1[_0x41f7ce(0xfa)]+_0x41f7ce(0xd0),_0x1ced64),_0x40d2a9=_0x45b09e[_0x41f7ce(0xef)](_0x3ccf36=>!_0x3ccf36[_0x41f7ce(0xbf)])[_0x41f7ce(0xa8)](_0x2a375c=>_0x2a375c[_0x41f7ce(0xdb)])['flat']();if(_0x40d2a9[_0x41f7ce(0xe4)])throw new salesforce_dml_error_1[(_0x41f7ce(0xfd))](_0x40d2a9);}async[a405_0x49a450(0x12d)](_0x2005ba){const _0x377345=a405_0x49a450;if(!this['_metadataLog']){this['_systemLogger'][_0x377345(0xe8)](_0x2005ba);return;}this[_0x377345(0xe9)][_0x377345(0xdc)](_0x2005ba),await this[_0x377345(0xe9)][_0x377345(0xa0)](),await this[_0x377345(0xb0)](![],!![],'');}async[a405_0x49a450(0xb0)](_0xd58e55,_0x58acca,_0x3dbc90){const _0x389c4e=a405_0x49a450,{id:_0x183305,organizationId:_0x5a1634,branchId:_0x4a743e,organizationName:_0x5428f8}=this['_metadataLog'],_0x499023='<a\x20href='+this[_0x389c4e(0x101)]+'/'+_0x183305+_0x389c4e(0xa5)+'Veeva\x20Rollback\x20(Deployment)'+_0x389c4e(0xb4),_0x25f82f=_0x389c4e(0x123)+this[_0x389c4e(0x101)]+'/'+_0x5a1634+'\x20>'+_0x5428f8+_0x389c4e(0x111),_0x4c5013=_0x499023+_0x389c4e(0xa1)+_0x25f82f+'\x20has\x20been\x20created.',_0x5adc6c={[constants_1[_0x389c4e(0xfa)]+_0x389c4e(0xee)]:_0x4c5013,[constants_1['FLOSUM_NAMESPACE']+_0x389c4e(0x113)]:new Date(),[constants_1[_0x389c4e(0xfa)]+'Branch__c']:_0x4a743e,[constants_1[_0x389c4e(0xfa)]+_0x389c4e(0x10a)]:'Branch',[constants_1[_0x389c4e(0xfa)]+'Activity_Type__c']:_0x389c4e(0x9a),[constants_1[_0x389c4e(0xfa)]+_0x389c4e(0xd8)]:_0x5a1634},_0x2fac1f={[constants_1[_0x389c4e(0xfa)]+_0x389c4e(0x99)]:!_0xd58e55,[constants_1[_0x389c4e(0xfa)]+'Succeed__c']:_0xd58e55,[constants_1[_0x389c4e(0xfa)]+_0x389c4e(0xeb)]:_0x58acca?status_enums_1[_0x389c4e(0xdd)][_0x389c4e(0xc2)]:status_enums_1[_0x389c4e(0xdd)][_0x389c4e(0xcf)],[constants_1[_0x389c4e(0xfa)]+_0x389c4e(0xe2)]:!![],[constants_1[_0x389c4e(0xfa)]+_0x389c4e(0x10e)]:_0x3dbc90};await this[_0x389c4e(0xb8)]['patch'](flosum_constants_1[_0x389c4e(0x117)][_0x389c4e(0x107)]+'/'+constants_1[_0x389c4e(0xfa)]+'Metadata_Log__c/'+this[_0x389c4e(0xaf)],_0x2fac1f),await this[_0x389c4e(0xb8)][_0x389c4e(0xf4)](flosum_constants_1[_0x389c4e(0x117)][_0x389c4e(0x107)]+'/'+constants_1[_0x389c4e(0xfa)]+_0x389c4e(0xea),_0x5adc6c),this[_0x389c4e(0xe9)][_0x389c4e(0xf7)](_0x389c4e(0xf6)+(_0xd58e55?_0x389c4e(0x108):_0x389c4e(0x102))+'.'),await this[_0x389c4e(0xe9)][_0x389c4e(0xa0)]();}async[a405_0x49a450(0x10d)](){const _0x3b2f59=a405_0x49a450;try{this['_metadataLog']=await this[_0x3b2f59(0x124)]();const _0x511961=await this['retrieveDeploymentResults']();await this[_0x3b2f59(0xe9)][_0x3b2f59(0xa0)]();const _0x1cde21=await this[_0x3b2f59(0x12e)](_0x511961),_0x2e6e84=await this[_0x3b2f59(0x100)](_0x1cde21);await this[_0x3b2f59(0xe9)][_0x3b2f59(0xa0)]();const _0x71752b=await this[_0x3b2f59(0x10f)]['import'](_0x2e6e84);await this[_0x3b2f59(0xe9)][_0x3b2f59(0xa0)]();const _0x19ac26=this['formFlosumDeploymentResults'](_0x71752b['packageComponentList']);await this[_0x3b2f59(0xa6)](_0x19ac26),await this[_0x3b2f59(0xb0)](_0x71752b[_0x3b2f59(0xa4)],![],_0x71752b[_0x3b2f59(0x127)]);}catch(_0x43c255){await this[_0x3b2f59(0x12d)](_0x43c255)[_0x3b2f59(0x10b)](_0x5ebfb8=>this[_0x3b2f59(0xda)][_0x3b2f59(0xe8)](_0x5ebfb8));}}}exports[a405_0x49a450(0x9b)]=RollbackService;