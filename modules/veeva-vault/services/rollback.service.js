const a360_0x4dea19=a360_0x3b42;(function(_0xf027b9,_0x5382b2){const _0x5d1a63=a360_0x3b42,_0x80fbc2=_0xf027b9();while(!![]){try{const _0x1a141d=parseInt(_0x5d1a63(0x1d1))/0x1*(parseInt(_0x5d1a63(0x1c3))/0x2)+parseInt(_0x5d1a63(0x1fa))/0x3*(parseInt(_0x5d1a63(0x1fe))/0x4)+-parseInt(_0x5d1a63(0x197))/0x5*(-parseInt(_0x5d1a63(0x1ba))/0x6)+-parseInt(_0x5d1a63(0x199))/0x7+parseInt(_0x5d1a63(0x1a6))/0x8+-parseInt(_0x5d1a63(0x1b6))/0x9*(-parseInt(_0x5d1a63(0x1e9))/0xa)+-parseInt(_0x5d1a63(0x1f9))/0xb;if(_0x1a141d===_0x5382b2)break;else _0x80fbc2['push'](_0x80fbc2['shift']());}catch(_0x138894){_0x80fbc2['push'](_0x80fbc2['shift']());}}}(a360_0x53d9,0x7e134));const a360_0x121c0b=(function(){let _0x187e9d=!![];return function(_0x582fff,_0x1153f5){const _0xf8f118=_0x187e9d?function(){const _0x19dc6a=a360_0x3b42;if(_0x1153f5){const _0x2357a9=_0x1153f5[_0x19dc6a(0x1bb)](_0x582fff,arguments);return _0x1153f5=null,_0x2357a9;}}:function(){};return _0x187e9d=![],_0xf8f118;};}()),a360_0xb357cb=a360_0x121c0b(this,function(){const _0xc50255=a360_0x3b42;return a360_0xb357cb[_0xc50255(0x1ee)]()[_0xc50255(0x18b)](_0xc50255(0x1f5))[_0xc50255(0x1ee)]()['constructor'](a360_0xb357cb)[_0xc50255(0x18b)](_0xc50255(0x1f5));});a360_0xb357cb();function a360_0x53d9(){const _0xf3ba15=['with\x20error','bind','FlosumConstants','name','map','validate','Logger','../classes/errors/salesforce-dml-error','Veeva\x20Rollback\x20(Deployment)','_salesforceService','7931632rgatrw','log','Component_Type__c','MetadataLogDto','updateLog','catch','\x20</a>','retrieveAttachments','ENDPOINT_UPSERT_RECORD','post','FLOSUM_NAMESPACE','./salesforce.service','Retrieve\x20Backup','../classes/retrievers/deployment-results/id.deployment-result.retriever','_vpkService','../classes/rollback/zip-creator.rollback','67986HiesLq','insertMultipleRecords','saveLog','stepName','1278egEgem','apply','packageId','errors','DEPLOYED','PackageImportService','length','type','success','8474LpNomZ','Veeva_Step_Name__c','createVpk','../enums/status.enums','generate','../../../constants','_tempFolder','fs/promises','Log__c','createZip','finishRollbackWithError','flat','error','text/plain','158aVGOYa','default','formFlosumDeploymentResults','Succeed__c','Date__c','IdDeploymentResultRetriever','SalesforceDmlError','Status__c','_instanceUrl','ZipCreatorRollback','Is_Error__c','_metadataLogId','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','fetchAttachmentsDetailsById','SalesforceService','COMPLETED','_connectionSalesforce','./vpk.service','EXCEPTION','Failure','retrieveBackup','RollbackService','_timeZone','from','1060RyWZbL','\x27\x0a\x20\x20\x20\x20','VpkService','_systemLogger','../constants/flosum.constants','toString','Activity_Item__c','_packageImportService','Rollback\x20completed\x20','create','defineProperty','TargetId__c','(((.+)+)+)+$','.zip','logError','Action__c','25923535mSjLgz','1197915BeyANf','../../../core','</a>','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','4gzhNfl','Activity_Type__c','Type__c','retrieveRecords','Org__c','Retrieve\x20Metadata\x20Log\x20info','Deployment','writeFile','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_metadataLog','status','Metadata_Log__c','slice','__importDefault','BACKUP_ZIP_NAME','retrieveMetadataLog','base64','./package-import.service','values','../../shared/utils/fetch-attachments','Cannot\x20find\x20Backup\x20Zip','_veevaService','/vpk__','Create\x20Vpk\x20package','shortid','search','retrieveDeploymentResults','Success','\x20:\x20','saveDeploymentResults','Branch','_parentMetadataLogId','\x20has\x20been\x20created.','__esModule','_logger','<a\x20href=','execute','21310PSRnUr','Job_Completed__c','6269522zpYuYU','deploymentAction','finishRollback'];a360_0x53d9=function(){return _0xf3ba15;};return a360_0x53d9();}'use strict';var __importDefault=this&&this[a360_0x4dea19(0x20b)]||function(_0x401218){const _0x172df5=a360_0x4dea19;return _0x401218&&_0x401218[_0x172df5(0x193)]?_0x401218:{'default':_0x401218};};function a360_0x3b42(_0x1ba067,_0x26ebf2){const _0x5b7a73=a360_0x53d9();return a360_0x3b42=function(_0xb357cb,_0x121c0b){_0xb357cb=_0xb357cb-0x187;let _0x53d91f=_0x5b7a73[_0xb357cb];return _0x53d91f;},a360_0x3b42(_0x1ba067,_0x26ebf2);}Object[a360_0x4dea19(0x1f3)](exports,a360_0x4dea19(0x193),{'value':!![]}),exports['RollbackService']=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a360_0x4dea19(0x1b1)),package_import_service_1=require(a360_0x4dea19(0x20f)),id_deployment_result_retriever_1=require(a360_0x4dea19(0x1b3)),flosum_constants_1=require(a360_0x4dea19(0x1ed)),fetch_attachments_1=require(a360_0x4dea19(0x211)),constants_1=require(a360_0x4dea19(0x1c8)),zip_creator_rollback_1=require(a360_0x4dea19(0x1b5)),shortid_1=__importDefault(require(a360_0x4dea19(0x18a))),promises_1=require(a360_0x4dea19(0x1ca)),vpk_service_1=require(a360_0x4dea19(0x1e2)),status_enums_1=require(a360_0x4dea19(0x1c6)),salesforce_dml_error_1=require(a360_0x4dea19(0x1a3)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a360_0x4dea19(0x1fb));class RollbackService{constructor({connectionSalesforce:_0x275fe9,connectionVeeva:_0xb2624c,logger:_0x1677d2,tempFolder:_0x4e2cd9,instanceUrl:_0xdc2e4d,timeZone:_0x5b3dea,metadataLogId:_0x32ba8b,attachmentLogId:_0x5e7e9a,parentMetadataLogId:_0x470e34,componentIds:_0x21f2c6}){const _0x218f89=a360_0x4dea19;this[_0x218f89(0x1e1)]=_0x275fe9,this['_connectionVeeva']=_0xb2624c,this[_0x218f89(0x194)]=_0x1677d2,this[_0x218f89(0x1c9)]=_0x4e2cd9,this[_0x218f89(0x1d9)]=_0xdc2e4d,this[_0x218f89(0x1e7)]=_0x5b3dea,this[_0x218f89(0x1dc)]=_0x32ba8b,this['_attachmentLogId']=_0x5e7e9a,this[_0x218f89(0x191)]=_0x470e34,this['_componentIds']=_0x21f2c6,this[_0x218f89(0x1ec)]=new core_1[(_0x218f89(0x1a2))]('veeva-rollback'),this[_0x218f89(0x187)]=new veeva_service_1['VeevaService']({'connection':_0xb2624c,'logger':_0x1677d2}),this['_salesforceService']=new salesforce_service_1[(_0x218f89(0x1df))]({'connection':_0x275fe9}),this[_0x218f89(0x1f0)]=new package_import_service_1[(_0x218f89(0x1bf))]({'veevaService':this['_veevaService'],'connection':_0xb2624c,'logger':_0x1677d2,'saveLog':this[_0x218f89(0x1b8)][_0x218f89(0x19d)](this)}),this[_0x218f89(0x1b4)]=new vpk_service_1[(_0x218f89(0x1eb))]({'connection':_0xb2624c});}async[a360_0x4dea19(0x1b8)](_0x207b85,_0x40dace){const _0x4e9e80=a360_0x4dea19;this['_logger'][_0x4e9e80(0x1a7)]('Save\x20log');const _0x543e7d={'Body':Buffer[_0x4e9e80(0x1e8)](_0x207b85)[_0x4e9e80(0x1ee)](_0x4e9e80(0x20e)),'ContentType':_0x4e9e80(0x1d0),'ParentId':this[_0x4e9e80(0x1dc)],'Name':_0x40dace};await this[_0x4e9e80(0x1e1)][_0x4e9e80(0x1af)](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+'/Attachment',_0x543e7d);}async[a360_0x4dea19(0x20d)](){const _0x297925=a360_0x4dea19;this[_0x297925(0x194)][_0x297925(0x1a7)](_0x297925(0x203));const [_0x10226b]=await this[_0x297925(0x1a5)][_0x297925(0x201)](_0x297925(0x1fd)+constants_1['FLOSUM_NAMESPACE']+_0x297925(0x206)+constants_1['FLOSUM_NAMESPACE']+_0x297925(0x1dd)+constants_1[_0x297925(0x1b0)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x297925(0x1b0)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x297925(0x1dc)]+_0x297925(0x1ea));return new metadata_log_dto_1[(_0x297925(0x1a9))](_0x10226b);}async[a360_0x4dea19(0x18c)](){const _0x4f9785=a360_0x4dea19;this['_logger'][_0x4f9785(0x1a7)]('Retrieve\x20Deployment\x20Results');const _0x5849a7=await new id_deployment_result_retriever_1[(_0x4f9785(0x1d6))]({'salesforceService':this[_0x4f9785(0x1a5)],'value':this['_componentIds']})['retrieve']();if(!_0x5849a7[_0x4f9785(0x1c0)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x5849a7;}async[a360_0x4dea19(0x1e5)](){const _0x109a40=a360_0x4dea19;this[_0x109a40(0x194)][_0x109a40(0x1a7)](_0x109a40(0x1b2));const _0x1c9cd4=await this[_0x109a40(0x1a5)][_0x109a40(0x201)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this['_parentMetadataLogId']+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1['FlosumConstants'][_0x109a40(0x20c)]+'\x27\x0a\x20\x20\x20\x20'),_0x375cda=await(0x0,fetch_attachments_1[_0x109a40(0x1de)])(this[_0x109a40(0x1e1)],[_0x1c9cd4[0x0]['Id']]),_0x53c2e7=await(0x0,fetch_attachments_1[_0x109a40(0x1ad)])(_0x375cda,this[_0x109a40(0x1e1)]);if(!_0x53c2e7[_0x109a40(0x1c0)])throw new Error(_0x109a40(0x212));return _0x53c2e7[0x0][_0x109a40(0x210)]['Body'];}async[a360_0x4dea19(0x1cc)](_0x3eb209){const _0x51ca0c=a360_0x4dea19;this[_0x51ca0c(0x194)]['log']('Create\x20zip\x20from\x20backup');const _0x3b918a=await this[_0x51ca0c(0x1e5)](),_0x5ef9cc=await new zip_creator_rollback_1[(_0x51ca0c(0x1da))]({'rollbackName':this[_0x51ca0c(0x207)][_0x51ca0c(0x19f)],'backup':_0x3b918a,'deploymentResults':_0x3eb209})[_0x51ca0c(0x1f2)](),_0x193c5c=this[_0x51ca0c(0x1c9)]+'/'+(0x0,shortid_1[_0x51ca0c(0x1d2)])()+_0x51ca0c(0x1f6);return await(0x0,promises_1['writeFile'])(_0x193c5c,_0x5ef9cc),_0x193c5c;}async[a360_0x4dea19(0x1c5)](_0x127aba){const _0x1d30bf=a360_0x4dea19;this[_0x1d30bf(0x194)][_0x1d30bf(0x1a7)](_0x1d30bf(0x189));const _0x4cd29c=await this['_vpkService'][_0x1d30bf(0x1c7)](_0x127aba),_0x201463=this['_tempFolder']+_0x1d30bf(0x188)+_0x127aba[_0x1d30bf(0x20a)](_0x127aba['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x1d30bf(0x205)])(_0x201463,_0x4cd29c),await this[_0x1d30bf(0x1b4)][_0x1d30bf(0x1a1)](_0x201463),_0x201463;}['formFlosumDeploymentResults'](_0xe26e15){const _0xff2668=a360_0x4dea19;return this[_0xff2668(0x194)][_0xff2668(0x1a7)]('Form\x20Deployment\x20Results'),_0xe26e15[_0xff2668(0x1a0)](_0x4ec24f=>{const _0x3a34c9=_0xff2668;return this[_0x3a34c9(0x194)][_0x3a34c9(0x1a7)](_0x4ec24f[_0x3a34c9(0x1c1)]+'.'+_0x4ec24f[_0x3a34c9(0x19f)]+_0x3a34c9(0x18e)+_0x4ec24f[_0x3a34c9(0x208)]),{[constants_1[_0x3a34c9(0x1b0)]+_0x3a34c9(0x200)]:'Deployment\x20Result',[constants_1[_0x3a34c9(0x1b0)]+_0x3a34c9(0x1d8)]:_0x4ec24f['status']===status_enums_1['PackageComponentStatus'][_0x3a34c9(0x1be)]?_0x3a34c9(0x18d):_0x3a34c9(0x1e4),[constants_1[_0x3a34c9(0x1b0)]+'Result__c']:_0x4ec24f[_0x3a34c9(0x19a)],[constants_1[_0x3a34c9(0x1b0)]+'Component_Name__c']:_0x4ec24f[_0x3a34c9(0x19f)],[constants_1[_0x3a34c9(0x1b0)]+_0x3a34c9(0x1a8)]:_0x4ec24f[_0x3a34c9(0x1c1)],[constants_1[_0x3a34c9(0x1b0)]+_0x3a34c9(0x1c4)]:_0x4ec24f[_0x3a34c9(0x1b9)],[constants_1[_0x3a34c9(0x1b0)]+_0x3a34c9(0x202)]:this[_0x3a34c9(0x207)]['organizationId'],[constants_1[_0x3a34c9(0x1b0)]+_0x3a34c9(0x209)]:this[_0x3a34c9(0x1dc)]};});}async[a360_0x4dea19(0x18f)](_0x3a4a84){const _0x58700b=a360_0x4dea19;this[_0x58700b(0x194)]['log']('Save\x20Deployment\x20Results');const _0x91daf3=await this[_0x58700b(0x1a5)][_0x58700b(0x1b7)](constants_1[_0x58700b(0x1b0)]+'Deployment_Result__c',_0x3a4a84),_0x49205e=_0x91daf3['filter'](_0x17f38d=>!_0x17f38d[_0x58700b(0x1c2)])[_0x58700b(0x1a0)](_0x5e17e2=>_0x5e17e2[_0x58700b(0x1bd)])[_0x58700b(0x1ce)]();if(_0x49205e[_0x58700b(0x1c0)])throw new salesforce_dml_error_1[(_0x58700b(0x1d7))](_0x49205e);}async[a360_0x4dea19(0x1cd)](_0x282a20){const _0x16be91=a360_0x4dea19;if(!this[_0x16be91(0x207)]){this[_0x16be91(0x1ec)][_0x16be91(0x1cf)](_0x282a20);return;}this[_0x16be91(0x194)][_0x16be91(0x1f7)](_0x282a20),await this[_0x16be91(0x194)][_0x16be91(0x1aa)](),await this[_0x16be91(0x19b)](![],!![],'');}async[a360_0x4dea19(0x19b)](_0x20f5bb,_0x133131,_0x58decb){const _0x20403d=a360_0x4dea19,{id:_0x507317,organizationId:_0x52dca9,branchId:_0x5319bd,organizationName:_0x107aa3}=this['_metadataLog'],_0x565136='<a\x20href='+this['_instanceUrl']+'/'+_0x507317+'\x20>\x20'+_0x20403d(0x1a4)+_0x20403d(0x1ac),_0x35867=_0x20403d(0x195)+this[_0x20403d(0x1d9)]+'/'+_0x52dca9+'\x20>'+_0x107aa3+_0x20403d(0x1fc),_0x2265a7=_0x565136+'\x20of\x20branch\x20to\x20Organization\x20'+_0x35867+_0x20403d(0x192),_0x253f8d={[constants_1[_0x20403d(0x1b0)]+_0x20403d(0x1f8)]:_0x2265a7,[constants_1[_0x20403d(0x1b0)]+_0x20403d(0x1d5)]:new Date(),[constants_1[_0x20403d(0x1b0)]+'Branch__c']:_0x5319bd,[constants_1[_0x20403d(0x1b0)]+_0x20403d(0x1ef)]:_0x20403d(0x190),[constants_1[_0x20403d(0x1b0)]+_0x20403d(0x1ff)]:_0x20403d(0x204),[constants_1[_0x20403d(0x1b0)]+_0x20403d(0x1f4)]:_0x52dca9},_0x343dca={[constants_1[_0x20403d(0x1b0)]+_0x20403d(0x1db)]:!_0x20f5bb,[constants_1[_0x20403d(0x1b0)]+_0x20403d(0x1d4)]:_0x20f5bb,[constants_1[_0x20403d(0x1b0)]+'Status__c']:_0x133131?status_enums_1['MetadataLogStatus'][_0x20403d(0x1e3)]:status_enums_1['MetadataLogStatus'][_0x20403d(0x1e0)],[constants_1[_0x20403d(0x1b0)]+_0x20403d(0x198)]:!![],[constants_1['FLOSUM_NAMESPACE']+'Async_Request_Id__c']:_0x58decb};await this[_0x20403d(0x1e1)]['patch'](flosum_constants_1['FlosumConstants'][_0x20403d(0x1ae)]+'/'+constants_1[_0x20403d(0x1b0)]+'Metadata_Log__c/'+this[_0x20403d(0x1dc)],_0x343dca),await this[_0x20403d(0x1e1)][_0x20403d(0x1af)](flosum_constants_1[_0x20403d(0x19e)][_0x20403d(0x1ae)]+'/'+constants_1[_0x20403d(0x1b0)]+_0x20403d(0x1cb),_0x253f8d),this['_logger'][_0x20403d(0x1a7)](_0x20403d(0x1f1)+(_0x20f5bb?'successfully':_0x20403d(0x19c))+'.'),await this['_logger'][_0x20403d(0x1aa)]();}async[a360_0x4dea19(0x196)](){const _0x1a9a0d=a360_0x4dea19;try{this[_0x1a9a0d(0x207)]=await this[_0x1a9a0d(0x20d)]();const _0x42024e=await this[_0x1a9a0d(0x18c)]();await this['_logger']['updateLog']();const _0x4117d8=await this['createZip'](_0x42024e),_0x5770d9=await this[_0x1a9a0d(0x1c5)](_0x4117d8);await this[_0x1a9a0d(0x194)][_0x1a9a0d(0x1aa)]();const _0x595bd6=await this[_0x1a9a0d(0x1f0)]['import'](_0x5770d9);await this[_0x1a9a0d(0x194)][_0x1a9a0d(0x1aa)]();const _0x4e0ebe=this[_0x1a9a0d(0x1d3)](_0x595bd6['packageComponentList']);await this['saveDeploymentResults'](_0x4e0ebe),await this[_0x1a9a0d(0x19b)](_0x595bd6['isDeployed'],![],_0x595bd6[_0x1a9a0d(0x1bc)]);}catch(_0x11d60f){await this[_0x1a9a0d(0x1cd)](_0x11d60f)[_0x1a9a0d(0x1ab)](_0x3f6126=>this[_0x1a9a0d(0x1ec)]['error'](_0x3f6126));}}}exports[a360_0x4dea19(0x1e6)]=RollbackService;