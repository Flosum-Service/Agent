const a361_0x536b2e=a361_0x37b7;(function(_0x4d220a,_0x2abec9){const _0x13e47d=a361_0x37b7,_0x54a2ff=_0x4d220a();while(!![]){try{const _0x152a67=parseInt(_0x13e47d(0x241))/0x1*(parseInt(_0x13e47d(0x1e3))/0x2)+parseInt(_0x13e47d(0x25e))/0x3+parseInt(_0x13e47d(0x23e))/0x4*(-parseInt(_0x13e47d(0x242))/0x5)+-parseInt(_0x13e47d(0x1ef))/0x6+parseInt(_0x13e47d(0x279))/0x7+parseInt(_0x13e47d(0x203))/0x8*(-parseInt(_0x13e47d(0x1ff))/0x9)+-parseInt(_0x13e47d(0x1f9))/0xa*(parseInt(_0x13e47d(0x219))/0xb);if(_0x152a67===_0x2abec9)break;else _0x54a2ff['push'](_0x54a2ff['shift']());}catch(_0x579578){_0x54a2ff['push'](_0x54a2ff['shift']());}}}(a361_0x457b,0xdd176));const a361_0x4e75a3=(function(){let _0x2a5b64=!![];return function(_0x2e5d52,_0x39daa4){const _0x5238b4=_0x2a5b64?function(){const _0xe26a36=a361_0x37b7;if(_0x39daa4){const _0x380c05=_0x39daa4[_0xe26a36(0x25f)](_0x2e5d52,arguments);return _0x39daa4=null,_0x380c05;}}:function(){};return _0x2a5b64=![],_0x5238b4;};}()),a361_0x4ad52d=a361_0x4e75a3(this,function(){const _0xba0d84=a361_0x37b7;return a361_0x4ad52d[_0xba0d84(0x20d)]()[_0xba0d84(0x255)](_0xba0d84(0x225))[_0xba0d84(0x20d)]()['constructor'](a361_0x4ad52d)['search'](_0xba0d84(0x225));});function a361_0x37b7(_0x41145c,_0x4d174c){const _0x326923=a361_0x457b();return a361_0x37b7=function(_0x4ad52d,_0x4e75a3){_0x4ad52d=_0x4ad52d-0x1e1;let _0x457b96=_0x326923[_0x4ad52d];return _0x457b96;},a361_0x37b7(_0x41145c,_0x4d174c);}a361_0x4ad52d();'use strict';var __importDefault=this&&this[a361_0x536b2e(0x21e)]||function(_0xd8ba2e){const _0x3db967=a361_0x536b2e;return _0xd8ba2e&&_0xd8ba2e[_0x3db967(0x21d)]?_0xd8ba2e:{'default':_0xd8ba2e};};Object[a361_0x536b2e(0x210)](exports,a361_0x536b2e(0x21d),{'value':!![]}),exports[a361_0x536b2e(0x23b)]=void 0x0;const veeva_service_1=require(a361_0x536b2e(0x257)),salesforce_service_1=require(a361_0x536b2e(0x261)),package_import_service_1=require(a361_0x536b2e(0x1ed)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a361_0x536b2e(0x230)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a361_0x536b2e(0x22e)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a361_0x536b2e(0x222))),promises_1=require('fs/promises'),vpk_service_1=require(a361_0x536b2e(0x20e)),status_enums_1=require(a361_0x536b2e(0x24f)),salesforce_dml_error_1=require(a361_0x536b2e(0x244)),metadata_log_dto_1=require(a361_0x536b2e(0x227)),core_1=require(a361_0x536b2e(0x236));class RollbackService{constructor({connectionSalesforce:_0x316500,connectionVeeva:_0x15afc0,logger:_0x184ec9,tempFolder:_0x255a93,instanceUrl:_0x207b93,timeZone:_0x2d5074,metadataLogId:_0x14df14,attachmentLogId:_0x2cea4a,parentMetadataLogId:_0xb022c0,componentIds:_0x29bba9}){const _0x27481a=a361_0x536b2e;this[_0x27481a(0x274)]=_0x316500,this['_connectionVeeva']=_0x15afc0,this[_0x27481a(0x22b)]=_0x184ec9,this[_0x27481a(0x251)]=_0x255a93,this['_instanceUrl']=_0x207b93,this[_0x27481a(0x26e)]=_0x2d5074,this[_0x27481a(0x248)]=_0x14df14,this[_0x27481a(0x273)]=_0x2cea4a,this[_0x27481a(0x1e9)]=_0xb022c0,this[_0x27481a(0x253)]=_0x29bba9,this[_0x27481a(0x20b)]=new core_1[(_0x27481a(0x224))](_0x27481a(0x1e1)),this[_0x27481a(0x218)]=new veeva_service_1['VeevaService']({'connection':_0x15afc0,'logger':_0x184ec9}),this[_0x27481a(0x21c)]=new salesforce_service_1[(_0x27481a(0x278))]({'connection':_0x316500}),this[_0x27481a(0x24d)]=new package_import_service_1[(_0x27481a(0x22c))]({'veevaService':this[_0x27481a(0x218)],'connection':_0x15afc0,'logger':_0x184ec9,'saveLog':this['saveLog'][_0x27481a(0x267)](this)}),this['_vpkService']=new vpk_service_1[(_0x27481a(0x265))]({'connection':_0x15afc0});}async[a361_0x536b2e(0x249)](_0x15f3d5,_0x1209af){const _0x3e0994=a361_0x536b2e;this[_0x3e0994(0x22b)][_0x3e0994(0x1f4)](_0x3e0994(0x25c));const _0x5911c6={'Body':Buffer[_0x3e0994(0x1f0)](_0x15f3d5)[_0x3e0994(0x20d)](_0x3e0994(0x204)),'ContentType':_0x3e0994(0x235),'ParentId':this[_0x3e0994(0x248)],'Name':_0x1209af};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x3e0994(0x233)][_0x3e0994(0x1f6)]+_0x3e0994(0x24a),_0x5911c6);}async[a361_0x536b2e(0x231)](){const _0x3056ae=a361_0x536b2e;this[_0x3056ae(0x22b)][_0x3056ae(0x1f4)](_0x3056ae(0x234));const [_0xdcfa46]=await this[_0x3056ae(0x21c)]['retrieveRecords'](_0x3056ae(0x207)+constants_1[_0x3056ae(0x1e4)]+_0x3056ae(0x259)+constants_1[_0x3056ae(0x1e4)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x3056ae(0x232)+constants_1[_0x3056ae(0x1e4)]+_0x3056ae(0x277)+this[_0x3056ae(0x248)]+_0x3056ae(0x211));return new metadata_log_dto_1['MetadataLogDto'](_0xdcfa46);}async[a361_0x536b2e(0x24e)](){const _0x1814c0=a361_0x536b2e;this[_0x1814c0(0x22b)][_0x1814c0(0x1f4)]('Retrieve\x20Deployment\x20Results');const _0x1a8c2e=await new id_deployment_result_retriever_1[(_0x1814c0(0x1eb))]({'salesforceService':this[_0x1814c0(0x21c)],'value':this[_0x1814c0(0x253)]})[_0x1814c0(0x263)]();if(!_0x1a8c2e['length'])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x1a8c2e;}async['retrieveBackup'](){const _0x4d1194=a361_0x536b2e;this[_0x4d1194(0x22b)][_0x4d1194(0x1f4)](_0x4d1194(0x264));const _0xe898ad=await this[_0x4d1194(0x21c)][_0x4d1194(0x272)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x4d1194(0x1e9)]+_0x4d1194(0x228)+flosum_constants_1['FlosumConstants'][_0x4d1194(0x23f)]+_0x4d1194(0x211)),_0x15d1ff=await(0x0,fetch_attachments_1[_0x4d1194(0x1e7)])(this[_0x4d1194(0x274)],[_0xe898ad[0x0]['Id']]),_0x1f0da9=await(0x0,fetch_attachments_1[_0x4d1194(0x1fe)])(_0x15d1ff,this[_0x4d1194(0x274)]);if(!_0x1f0da9[_0x4d1194(0x25d)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x1f0da9[0x0][_0x4d1194(0x20c)]['Body'];}async[a361_0x536b2e(0x214)](_0x12b56e){const _0x2d04f7=a361_0x536b2e;this['_logger'][_0x2d04f7(0x1f4)]('Create\x20zip\x20from\x20backup');const _0x160e14=await this[_0x2d04f7(0x256)](),_0x4af5f0=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x2d04f7(0x26f)][_0x2d04f7(0x25b)],'backup':_0x160e14,'deploymentResults':_0x12b56e})[_0x2d04f7(0x26c)](),_0x36245e=this['_tempFolder']+'/'+(0x0,shortid_1[_0x2d04f7(0x213)])()+_0x2d04f7(0x252);return await(0x0,promises_1[_0x2d04f7(0x1e2)])(_0x36245e,_0x4af5f0),_0x36245e;}async[a361_0x536b2e(0x245)](_0x20aefc){const _0x4694a9=a361_0x536b2e;this[_0x4694a9(0x22b)]['log'](_0x4694a9(0x205));const _0x29e2dd=await this[_0x4694a9(0x1e6)][_0x4694a9(0x238)](_0x20aefc),_0x1dc1f7=this[_0x4694a9(0x251)]+_0x4694a9(0x21a)+_0x20aefc[_0x4694a9(0x262)](_0x20aefc[_0x4694a9(0x247)]('/')+0x1);return await(0x0,promises_1[_0x4694a9(0x1e2)])(_0x1dc1f7,_0x29e2dd),await this['_vpkService'][_0x4694a9(0x1ec)](_0x1dc1f7),_0x1dc1f7;}[a361_0x536b2e(0x215)](_0x38176a){const _0x3b027f=a361_0x536b2e;return this[_0x3b027f(0x22b)][_0x3b027f(0x1f4)](_0x3b027f(0x266)),_0x38176a[_0x3b027f(0x268)](_0x58d490=>{const _0x489cfb=_0x3b027f;return this[_0x489cfb(0x22b)][_0x489cfb(0x1f4)](_0x58d490['type']+'.'+_0x58d490[_0x489cfb(0x25b)]+'\x20:\x20'+_0x58d490[_0x489cfb(0x22a)]),{[constants_1[_0x489cfb(0x1e4)]+_0x489cfb(0x1fa)]:_0x489cfb(0x1ee),[constants_1['FLOSUM_NAMESPACE']+_0x489cfb(0x275)]:_0x58d490[_0x489cfb(0x22a)]===status_enums_1[_0x489cfb(0x1f8)][_0x489cfb(0x21f)]?_0x489cfb(0x21b):_0x489cfb(0x26a),[constants_1[_0x489cfb(0x1e4)]+'Result__c']:_0x58d490[_0x489cfb(0x276)],[constants_1['FLOSUM_NAMESPACE']+_0x489cfb(0x271)]:_0x58d490[_0x489cfb(0x25b)],[constants_1[_0x489cfb(0x1e4)]+_0x489cfb(0x202)]:_0x58d490[_0x489cfb(0x1fd)],[constants_1[_0x489cfb(0x1e4)]+_0x489cfb(0x1f1)]:_0x58d490['stepName'],[constants_1['FLOSUM_NAMESPACE']+_0x489cfb(0x240)]:this[_0x489cfb(0x26f)][_0x489cfb(0x220)],[constants_1['FLOSUM_NAMESPACE']+_0x489cfb(0x260)]:this[_0x489cfb(0x248)]};});}async[a361_0x536b2e(0x1f3)](_0x340bcc){const _0x1bc42d=a361_0x536b2e;this['_logger'][_0x1bc42d(0x1f4)](_0x1bc42d(0x24b));const _0x87af32=await this[_0x1bc42d(0x21c)][_0x1bc42d(0x243)](constants_1[_0x1bc42d(0x1e4)]+_0x1bc42d(0x250),_0x340bcc),_0x8b7f5=_0x87af32[_0x1bc42d(0x1e5)](_0xd314b1=>!_0xd314b1[_0x1bc42d(0x23d)])['map'](_0x368499=>_0x368499[_0x1bc42d(0x209)])[_0x1bc42d(0x20a)]();if(_0x8b7f5[_0x1bc42d(0x25d)])throw new salesforce_dml_error_1[(_0x1bc42d(0x258))](_0x8b7f5);}async['finishRollbackWithError'](_0x2be21d){const _0xb01649=a361_0x536b2e;if(!this[_0xb01649(0x26f)]){this['_systemLogger'][_0xb01649(0x208)](_0x2be21d);return;}this[_0xb01649(0x22b)][_0xb01649(0x212)](_0x2be21d),await this[_0xb01649(0x22b)][_0xb01649(0x25a)](),await this['finishRollback'](![],!![],'');}async[a361_0x536b2e(0x23c)](_0x462512,_0x203aae,_0x1ad627){const _0x1c4683=a361_0x536b2e,{id:_0x16a969,organizationId:_0x4a2ba3,branchId:_0x17ca4d,organizationName:_0x11e869}=this[_0x1c4683(0x26f)],_0x497663=_0x1c4683(0x1fc)+this[_0x1c4683(0x22f)]+'/'+_0x16a969+'\x20>\x20'+_0x1c4683(0x22d)+'\x20</a>',_0x45818e=_0x1c4683(0x1fc)+this[_0x1c4683(0x22f)]+'/'+_0x4a2ba3+'\x20>'+_0x11e869+_0x1c4683(0x200),_0x253673=_0x497663+_0x1c4683(0x221)+_0x45818e+_0x1c4683(0x237),_0x4969f3={[constants_1['FLOSUM_NAMESPACE']+_0x1c4683(0x270)]:_0x253673,[constants_1['FLOSUM_NAMESPACE']+_0x1c4683(0x1f2)]:new Date(),[constants_1[_0x1c4683(0x1e4)]+'Branch__c']:_0x17ca4d,[constants_1[_0x1c4683(0x1e4)]+_0x1c4683(0x206)]:_0x1c4683(0x223),[constants_1[_0x1c4683(0x1e4)]+'Activity_Type__c']:_0x1c4683(0x269),[constants_1[_0x1c4683(0x1e4)]+_0x1c4683(0x27b)]:_0x4a2ba3},_0x14e33e={[constants_1[_0x1c4683(0x1e4)]+_0x1c4683(0x254)]:!_0x462512,[constants_1[_0x1c4683(0x1e4)]+_0x1c4683(0x23a)]:_0x462512,[constants_1['FLOSUM_NAMESPACE']+'Status__c']:_0x203aae?status_enums_1[_0x1c4683(0x26d)][_0x1c4683(0x1e8)]:status_enums_1['MetadataLogStatus'][_0x1c4683(0x26b)],[constants_1[_0x1c4683(0x1e4)]+_0x1c4683(0x246)]:!![],[constants_1[_0x1c4683(0x1e4)]+_0x1c4683(0x1f7)]:_0x1ad627};await this[_0x1c4683(0x274)][_0x1c4683(0x24c)](flosum_constants_1[_0x1c4683(0x233)][_0x1c4683(0x1f6)]+'/'+constants_1[_0x1c4683(0x1e4)]+_0x1c4683(0x226)+this[_0x1c4683(0x248)],_0x14e33e),await this['_connectionSalesforce'][_0x1c4683(0x1fb)](flosum_constants_1[_0x1c4683(0x233)][_0x1c4683(0x1f6)]+'/'+constants_1[_0x1c4683(0x1e4)]+_0x1c4683(0x229),_0x4969f3),this[_0x1c4683(0x22b)][_0x1c4683(0x1f4)](_0x1c4683(0x20f)+(_0x462512?_0x1c4683(0x201):_0x1c4683(0x1f5))+'.'),await this[_0x1c4683(0x22b)][_0x1c4683(0x25a)]();}async[a361_0x536b2e(0x239)](){const _0xfe9850=a361_0x536b2e;try{this[_0xfe9850(0x26f)]=await this['retrieveMetadataLog']();const _0x3e4390=await this[_0xfe9850(0x24e)]();await this[_0xfe9850(0x22b)]['updateLog']();const _0x5491df=await this[_0xfe9850(0x214)](_0x3e4390),_0x5b9e01=await this[_0xfe9850(0x245)](_0x5491df);await this[_0xfe9850(0x22b)]['updateLog']();const _0x4ee995=await this[_0xfe9850(0x24d)][_0xfe9850(0x1ea)](_0x5b9e01);await this['_logger'][_0xfe9850(0x25a)]();const _0x9c5e55=this[_0xfe9850(0x215)](_0x4ee995[_0xfe9850(0x27a)]);await this['saveDeploymentResults'](_0x9c5e55),await this['finishRollback'](_0x4ee995['isDeployed'],![],_0x4ee995[_0xfe9850(0x216)]);}catch(_0x567cbb){await this['finishRollbackWithError'](_0x567cbb)[_0xfe9850(0x217)](_0x4a64fe=>this[_0xfe9850(0x20b)][_0xfe9850(0x208)](_0x4a64fe));}}}function a361_0x457b(){const _0x30f55b=['finishRollback','success','2648AHNOIm','BACKUP_ZIP_NAME','Org__c','272164mlvyJJ','795gNJltv','insertMultipleRecords','../classes/errors/salesforce-dml-error','createVpk','Job_Completed__c','lastIndexOf','_metadataLogId','saveLog','/Attachment','Save\x20Deployment\x20Results','patch','_packageImportService','retrieveDeploymentResults','../enums/status.enums','Deployment_Result__c','_tempFolder','.zip','_componentIds','Is_Error__c','search','retrieveBackup','./veeva.service','SalesforceDmlError','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','updateLog','name','Save\x20log','length','4963986NihcaX','apply','Metadata_Log__c','./salesforce.service','slice','retrieve','Retrieve\x20Backup','VpkService','Form\x20Deployment\x20Results','bind','map','Deployment','Failure','COMPLETED','create','MetadataLogStatus','_timeZone','_metadataLog','Action__c','Component_Name__c','retrieveRecords','_attachmentLogId','_connectionSalesforce','Status__c','deploymentAction','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','SalesforceService','10707445eZoaMt','packageComponentList','TargetId__c','veeva-rollback','writeFile','10amclpE','FLOSUM_NAMESPACE','filter','_vpkService','fetchAttachmentsDetailsById','EXCEPTION','_parentMetadataLogId','import','IdDeploymentResultRetriever','validate','./package-import.service','Deployment\x20Result','2012778FbhWyM','from','Veeva_Step_Name__c','Date__c','saveDeploymentResults','log','with\x20error','ENDPOINT_UPSERT_RECORD','External_Deployment_Id__c','PackageComponentStatus','15378830OBUmAR','Type__c','post','<a\x20href=','type','retrieveAttachments','452979ftrCuz','</a>','successfully','Component_Type__c','264OfIcXn','base64','Create\x20Vpk\x20package','Activity_Item__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','error','errors','flat','_systemLogger','values','toString','./vpk.service','Rollback\x20completed\x20','defineProperty','\x27\x0a\x20\x20\x20\x20','logError','default','createZip','formFlosumDeploymentResults','packageId','catch','_veevaService','11FtWCAs','/vpk__','Success','_salesforceService','__esModule','__importDefault','DEPLOYED','organizationId','\x20of\x20branch\x20to\x20Organization\x20','shortid','Branch','Logger','(((.+)+)+)+$','Metadata_Log__c/','../dtos/metadata-log.dto','\x27\x20AND\x20Name\x20=\x20\x27','Log__c','status','_logger','PackageImportService','Veeva\x20Rollback\x20(Deployment)','../../../constants','_instanceUrl','../constants/flosum.constants','retrieveMetadataLog','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','FlosumConstants','Retrieve\x20Metadata\x20Log\x20info','text/plain','../../../core','\x20has\x20been\x20created.','generate','execute','Succeed__c','RollbackService'];a361_0x457b=function(){return _0x30f55b;};return a361_0x457b();}exports[a361_0x536b2e(0x23b)]=RollbackService;