const a404_0x2c9b7b=a404_0x5136;function a404_0x5136(_0x468fab,_0x2de80a){const _0xbbd0fb=a404_0x4afa();return a404_0x5136=function(_0x139def,_0x20a2de){_0x139def=_0x139def-0x15d;let _0x4afa78=_0xbbd0fb[_0x139def];return _0x4afa78;},a404_0x5136(_0x468fab,_0x2de80a);}(function(_0xc1b3af,_0x5dab5e){const _0x15225a=a404_0x5136,_0xc53b91=_0xc1b3af();while(!![]){try{const _0xaf3667=parseInt(_0x15225a(0x17f))/0x1*(parseInt(_0x15225a(0x1b0))/0x2)+-parseInt(_0x15225a(0x1a3))/0x3+parseInt(_0x15225a(0x18e))/0x4+parseInt(_0x15225a(0x1c5))/0x5+parseInt(_0x15225a(0x16f))/0x6+-parseInt(_0x15225a(0x177))/0x7+parseInt(_0x15225a(0x19b))/0x8*(parseInt(_0x15225a(0x1e0))/0x9);if(_0xaf3667===_0x5dab5e)break;else _0xc53b91['push'](_0xc53b91['shift']());}catch(_0x5d60d8){_0xc53b91['push'](_0xc53b91['shift']());}}}(a404_0x4afa,0xc2dc4));const a404_0x20a2de=(function(){let _0x4ad683=!![];return function(_0x5a528f,_0x78f5f3){const _0x3c13e1=_0x4ad683?function(){if(_0x78f5f3){const _0x555a79=_0x78f5f3['apply'](_0x5a528f,arguments);return _0x78f5f3=null,_0x555a79;}}:function(){};return _0x4ad683=![],_0x3c13e1;};}()),a404_0x139def=a404_0x20a2de(this,function(){const _0x1e0d3b=a404_0x5136;return a404_0x139def[_0x1e0d3b(0x1e6)]()[_0x1e0d3b(0x189)](_0x1e0d3b(0x1a8))[_0x1e0d3b(0x1e6)]()['constructor'](a404_0x139def)[_0x1e0d3b(0x189)](_0x1e0d3b(0x1a8));});a404_0x139def();'use strict';var __importDefault=this&&this[a404_0x2c9b7b(0x1a1)]||function(_0x410579){const _0x31e38e=a404_0x2c9b7b;return _0x410579&&_0x410579[_0x31e38e(0x1aa)]?_0x410579:{'default':_0x410579};};Object[a404_0x2c9b7b(0x1ae)](exports,a404_0x2c9b7b(0x1aa),{'value':!![]}),exports[a404_0x2c9b7b(0x195)]=void 0x0;const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a404_0x2c9b7b(0x1bb)),package_import_service_1=require(a404_0x2c9b7b(0x1e2)),id_deployment_result_retriever_1=require(a404_0x2c9b7b(0x17e)),flosum_constants_1=require(a404_0x2c9b7b(0x163)),fetch_attachments_1=require(a404_0x2c9b7b(0x1d6)),constants_1=require(a404_0x2c9b7b(0x1a4)),zip_creator_rollback_1=require(a404_0x2c9b7b(0x16d)),shortid_1=__importDefault(require('shortid')),promises_1=require('fs/promises'),vpk_service_1=require(a404_0x2c9b7b(0x1b6)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a404_0x2c9b7b(0x1cb)),metadata_log_dto_1=require(a404_0x2c9b7b(0x1dd)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x5540e5,connectionVeeva:_0x49fe1e,logger:_0x5a32b6,tempFolder:_0x3b81b0,instanceUrl:_0x18cf60,timeZone:_0x2e5357,metadataLogId:_0x3581d0,attachmentLogId:_0x51add9,parentMetadataLogId:_0x511b20,componentIds:_0x29ef62}){const _0x1be5a7=a404_0x2c9b7b;this[_0x1be5a7(0x1e7)]=_0x5540e5,this['_connectionVeeva']=_0x49fe1e,this['_logger']=_0x5a32b6,this['_tempFolder']=_0x3b81b0,this['_instanceUrl']=_0x18cf60,this[_0x1be5a7(0x1d4)]=_0x2e5357,this[_0x1be5a7(0x19f)]=_0x3581d0,this[_0x1be5a7(0x194)]=_0x51add9,this['_parentMetadataLogId']=_0x511b20,this[_0x1be5a7(0x15d)]=_0x29ef62,this[_0x1be5a7(0x1b8)]=new core_1[(_0x1be5a7(0x1b7))](_0x1be5a7(0x1b3)),this['_veevaService']=new veeva_service_1[(_0x1be5a7(0x192))]({'connection':_0x49fe1e,'logger':_0x5a32b6}),this[_0x1be5a7(0x187)]=new salesforce_service_1[(_0x1be5a7(0x169))]({'connection':_0x5540e5}),this[_0x1be5a7(0x179)]=new package_import_service_1[(_0x1be5a7(0x19c))]({'veevaService':this[_0x1be5a7(0x1c3)],'connection':_0x49fe1e,'logger':_0x5a32b6,'saveLog':this[_0x1be5a7(0x164)]['bind'](this)}),this['_vpkService']=new vpk_service_1[(_0x1be5a7(0x18c))]({'connection':_0x49fe1e});}async['saveLog'](_0x4a12e6,_0x4b7404){const _0x5a9044=a404_0x2c9b7b;this[_0x5a9044(0x160)][_0x5a9044(0x178)](_0x5a9044(0x1e3));const _0x566275={'Body':Buffer[_0x5a9044(0x161)](_0x4a12e6)[_0x5a9044(0x1e6)]('base64'),'ContentType':_0x5a9044(0x183),'ParentId':this[_0x5a9044(0x19f)],'Name':_0x4b7404};await this[_0x5a9044(0x1e7)]['post'](flosum_constants_1[_0x5a9044(0x165)][_0x5a9044(0x1ba)]+_0x5a9044(0x1cf),_0x566275);}async[a404_0x2c9b7b(0x1df)](){const _0x383d6b=a404_0x2c9b7b;this[_0x383d6b(0x160)][_0x383d6b(0x178)](_0x383d6b(0x1a7));const [_0x29ba2e]=await this[_0x383d6b(0x187)][_0x383d6b(0x185)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x383d6b(0x1a0)+constants_1[_0x383d6b(0x18b)]+_0x383d6b(0x190)+constants_1[_0x383d6b(0x18b)]+_0x383d6b(0x1c8)+constants_1[_0x383d6b(0x18b)]+_0x383d6b(0x1d3)+this['_metadataLogId']+_0x383d6b(0x162));return new metadata_log_dto_1[(_0x383d6b(0x1af))](_0x29ba2e);}async[a404_0x2c9b7b(0x1d8)](){const _0x594763=a404_0x2c9b7b;this[_0x594763(0x160)]['log']('Retrieve\x20Deployment\x20Results');const _0x5adbc4=await new id_deployment_result_retriever_1[(_0x594763(0x16b))]({'salesforceService':this['_salesforceService'],'value':this['_componentIds']})['retrieve']();if(!_0x5adbc4[_0x594763(0x1a6)])throw new Error(_0x594763(0x15e));return _0x5adbc4;}async[a404_0x2c9b7b(0x1bd)](){const _0x11daf6=a404_0x2c9b7b;this['_logger'][_0x11daf6(0x178)](_0x11daf6(0x196));const _0x2f7d2f=await this[_0x11daf6(0x187)]['retrieveRecords'](_0x11daf6(0x1ad)+this[_0x11daf6(0x19a)]+_0x11daf6(0x1dc)+flosum_constants_1[_0x11daf6(0x165)][_0x11daf6(0x1d0)]+_0x11daf6(0x162)),_0x24b6c3=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x11daf6(0x1e7)],[_0x2f7d2f[0x0]['Id']]),_0x2e98b3=await(0x0,fetch_attachments_1[_0x11daf6(0x1c1)])(_0x24b6c3,this['_connectionSalesforce']);if(!_0x2e98b3[_0x11daf6(0x1a6)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x2e98b3[0x0][_0x11daf6(0x175)]['Body'];}async[a404_0x2c9b7b(0x191)](_0x59645f){const _0x4f906e=a404_0x2c9b7b;this[_0x4f906e(0x160)][_0x4f906e(0x178)]('Create\x20zip\x20from\x20backup');const _0x4dea7e=await this['retrieveBackup'](),_0x3c5796=await new zip_creator_rollback_1[(_0x4f906e(0x19e))]({'rollbackName':this[_0x4f906e(0x167)]['name'],'backup':_0x4dea7e,'deploymentResults':_0x59645f})[_0x4f906e(0x1e1)](),_0x96792=this[_0x4f906e(0x16c)]+'/'+(0x0,shortid_1[_0x4f906e(0x1ac)])()+_0x4f906e(0x1ce);return await(0x0,promises_1[_0x4f906e(0x1e9)])(_0x96792,_0x3c5796),_0x96792;}async[a404_0x2c9b7b(0x181)](_0x3164e9){const _0x2c62e5=a404_0x2c9b7b;this[_0x2c62e5(0x160)]['log'](_0x2c62e5(0x176));const _0x512657=await this['_vpkService'][_0x2c62e5(0x172)](_0x3164e9),_0x418bcb=this[_0x2c62e5(0x16c)]+_0x2c62e5(0x1a2)+_0x3164e9[_0x2c62e5(0x188)](_0x3164e9['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x2c62e5(0x1e9)])(_0x418bcb,_0x512657),await this[_0x2c62e5(0x16e)]['validate'](_0x418bcb),_0x418bcb;}[a404_0x2c9b7b(0x193)](_0x2460ff){const _0x4f91f5=a404_0x2c9b7b;return this['_logger']['log'](_0x4f91f5(0x17d)),_0x2460ff['map'](_0x397e55=>{const _0x1e819d=_0x4f91f5;return this['_logger'][_0x1e819d(0x178)](_0x397e55[_0x1e819d(0x1c4)]+'.'+_0x397e55['name']+_0x1e819d(0x1bf)+_0x397e55[_0x1e819d(0x1b5)]),{[constants_1[_0x1e819d(0x18b)]+_0x1e819d(0x18a)]:_0x1e819d(0x182),[constants_1[_0x1e819d(0x18b)]+_0x1e819d(0x198)]:_0x397e55[_0x1e819d(0x1b5)]===status_enums_1['PackageComponentStatus'][_0x1e819d(0x1c6)]?_0x1e819d(0x16a):_0x1e819d(0x1c7),[constants_1[_0x1e819d(0x18b)]+'Result__c']:_0x397e55[_0x1e819d(0x166)],[constants_1[_0x1e819d(0x18b)]+_0x1e819d(0x1cd)]:_0x397e55[_0x1e819d(0x1da)],[constants_1['FLOSUM_NAMESPACE']+'Component_Type__c']:_0x397e55[_0x1e819d(0x1c4)],[constants_1['FLOSUM_NAMESPACE']+'Veeva_Step_Name__c']:_0x397e55[_0x1e819d(0x1b4)],[constants_1[_0x1e819d(0x18b)]+_0x1e819d(0x18d)]:this[_0x1e819d(0x167)]['organizationId'],[constants_1[_0x1e819d(0x18b)]+_0x1e819d(0x173)]:this[_0x1e819d(0x19f)]};});}async['saveDeploymentResults'](_0x70285){const _0x513250=a404_0x2c9b7b;this[_0x513250(0x160)]['log'](_0x513250(0x184));const _0x42dd26=await this[_0x513250(0x187)]['insertMultipleRecords'](constants_1[_0x513250(0x18b)]+_0x513250(0x171),_0x70285),_0x43300c=_0x42dd26[_0x513250(0x174)](_0x10208f=>!_0x10208f[_0x513250(0x1d9)])[_0x513250(0x199)](_0x27293c=>_0x27293c['errors'])[_0x513250(0x1e4)]();if(_0x43300c['length'])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x43300c);}async[a404_0x2c9b7b(0x1be)](_0x5a1e24){const _0x53f53c=a404_0x2c9b7b;if(!this[_0x53f53c(0x167)]){this['_systemLogger']['error'](_0x5a1e24);return;}this[_0x53f53c(0x160)][_0x53f53c(0x168)](_0x5a1e24),await this[_0x53f53c(0x160)][_0x53f53c(0x1d7)](),await this[_0x53f53c(0x1b2)](![],!![],'');}async[a404_0x2c9b7b(0x1b2)](_0x12376f,_0x4c8b5a,_0x5f70a3){const _0x1ae9b3=a404_0x2c9b7b,{id:_0x150394,organizationId:_0x3ea5cc,branchId:_0x35faf3,organizationName:_0x303c57}=this[_0x1ae9b3(0x167)],_0x45088d=_0x1ae9b3(0x1d1)+this[_0x1ae9b3(0x1ea)]+'/'+_0x150394+_0x1ae9b3(0x180)+_0x1ae9b3(0x1c0)+_0x1ae9b3(0x1ca),_0x2ad372=_0x1ae9b3(0x1d1)+this[_0x1ae9b3(0x1ea)]+'/'+_0x3ea5cc+'\x20>'+_0x303c57+_0x1ae9b3(0x18f),_0x4b3181=_0x45088d+_0x1ae9b3(0x15f)+_0x2ad372+'\x20has\x20been\x20created.',_0xc719cb={[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x1cc)]:_0x4b3181,[constants_1[_0x1ae9b3(0x18b)]+'Date__c']:new Date(),[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x1a9)]:_0x35faf3,[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x170)]:_0x1ae9b3(0x17a),[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x1b1)]:_0x1ae9b3(0x1c2),[constants_1['FLOSUM_NAMESPACE']+_0x1ae9b3(0x1d5)]:_0x3ea5cc},_0x23fbb2={[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x1db)]:!_0x12376f,[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x17b)]:_0x12376f,[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x198)]:_0x4c8b5a?status_enums_1['MetadataLogStatus'][_0x1ae9b3(0x1a5)]:status_enums_1['MetadataLogStatus']['COMPLETED'],[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x1bc)]:!![],[constants_1[_0x1ae9b3(0x18b)]+_0x1ae9b3(0x1e5)]:_0x5f70a3};await this[_0x1ae9b3(0x1e7)][_0x1ae9b3(0x197)](flosum_constants_1[_0x1ae9b3(0x165)][_0x1ae9b3(0x1ba)]+'/'+constants_1[_0x1ae9b3(0x18b)]+'Metadata_Log__c/'+this[_0x1ae9b3(0x19f)],_0x23fbb2),await this[_0x1ae9b3(0x1e7)][_0x1ae9b3(0x1e8)](flosum_constants_1[_0x1ae9b3(0x165)][_0x1ae9b3(0x1ba)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0xc719cb),this[_0x1ae9b3(0x160)]['log'](_0x1ae9b3(0x1c9)+(_0x12376f?_0x1ae9b3(0x1b9):'with\x20error')+'.'),await this[_0x1ae9b3(0x160)][_0x1ae9b3(0x1d7)]();}async['execute'](){const _0x4f08f3=a404_0x2c9b7b;try{this[_0x4f08f3(0x167)]=await this[_0x4f08f3(0x1df)]();const _0x2a2a59=await this[_0x4f08f3(0x1d8)]();await this['_logger'][_0x4f08f3(0x1d7)]();const _0x48df02=await this[_0x4f08f3(0x191)](_0x2a2a59),_0x489de4=await this[_0x4f08f3(0x181)](_0x48df02);await this[_0x4f08f3(0x160)][_0x4f08f3(0x1d7)]();const _0x5c55f4=await this[_0x4f08f3(0x179)][_0x4f08f3(0x17c)](_0x489de4);await this['_logger'][_0x4f08f3(0x1d7)]();const _0x5c3020=this[_0x4f08f3(0x193)](_0x5c55f4['packageComponentList']);await this[_0x4f08f3(0x1d2)](_0x5c3020),await this['finishRollback'](_0x5c55f4[_0x4f08f3(0x1ab)],![],_0x5c55f4[_0x4f08f3(0x186)]);}catch(_0x2c82de){await this['finishRollbackWithError'](_0x2c82de)[_0x4f08f3(0x19d)](_0xa00490=>this[_0x4f08f3(0x1b8)][_0x4f08f3(0x1de)](_0xa00490));}}}exports[a404_0x2c9b7b(0x195)]=RollbackService;function a404_0x4afa(){const _0x17cda5=['saveLog','FlosumConstants','deploymentAction','_metadataLog','logError','SalesforceService','Success','IdDeploymentResultRetriever','_tempFolder','../classes/rollback/zip-creator.rollback','_vpkService','1309680oDCYWi','Activity_Item__c','Deployment_Result__c','generate','Metadata_Log__c','filter','values','Create\x20Vpk\x20package','4399164nZRCNB','log','_packageImportService','Branch','Succeed__c','import','Form\x20Deployment\x20Results','../classes/retrievers/deployment-results/id.deployment-result.retriever','322951NYiTRf','\x20>\x20','createVpk','Deployment\x20Result','text/plain','Save\x20Deployment\x20Results','retrieveRecords','packageId','_salesforceService','slice','search','Type__c','FLOSUM_NAMESPACE','VpkService','Org__c','597824OwIMWb','</a>','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','createZip','VeevaService','formFlosumDeploymentResults','_attachmentLogId','RollbackService','Retrieve\x20Backup','patch','Status__c','map','_parentMetadataLogId','24pmxUBY','PackageImportService','catch','ZipCreatorRollback','_metadataLogId','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','__importDefault','/vpk__','4317777cMrNZy','../../../constants','EXCEPTION','length','Retrieve\x20Metadata\x20Log\x20info','(((.+)+)+)+$','Branch__c','__esModule','isDeployed','default','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','defineProperty','MetadataLogDto','8Vmlwbj','Activity_Type__c','finishRollback','veeva-rollback','stepName','status','./vpk.service','Logger','_systemLogger','successfully','ENDPOINT_UPSERT_RECORD','./salesforce.service','Job_Completed__c','retrieveBackup','finishRollbackWithError','\x20:\x20','Veeva\x20Rollback\x20(Deployment)','retrieveAttachments','Deployment','_veevaService','type','1451960RhdZOT','DEPLOYED','Failure','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Rollback\x20completed\x20','\x20</a>','../classes/errors/salesforce-dml-error','Action__c','Component_Name__c','.zip','/Attachment','BACKUP_ZIP_NAME','<a\x20href=','saveDeploymentResults','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','_timeZone','TargetId__c','../../shared/utils/fetch-attachments','updateLog','retrieveDeploymentResults','success','name','Is_Error__c','\x27\x20AND\x20Name\x20=\x20\x27','../dtos/metadata-log.dto','error','retrieveMetadataLog','2747781HtzShu','create','./package-import.service','Save\x20log','flat','External_Deployment_Id__c','toString','_connectionSalesforce','post','writeFile','_instanceUrl','_componentIds','Cannot\x20find\x20Deployment\x20Results','\x20of\x20branch\x20to\x20Organization\x20','_logger','from','\x27\x0a\x20\x20\x20\x20','../constants/flosum.constants'];a404_0x4afa=function(){return _0x17cda5;};return a404_0x4afa();}