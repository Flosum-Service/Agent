function a361_0x1a45(){const _0x26af49=['veeva-rollback','finishRollback','updateLog','Date__c','validate','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x27\x20AND\x20Name\x20=\x20\x27','map','27cBmfyF','3651339YmgjHd','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','_timeZone','Async_Request_Id__c','DEPLOYED','Rollback\x20completed\x20','../enums/status.enums','Activity_Item__c','./package-import.service','finishRollbackWithError','FlosumConstants','from','retrieve','filter','COMPLETED','_vpkService','862664PIWLZn','_tempFolder','stepName','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','Logger','_instanceUrl','_metadataLogId','retrieveMetadataLog','_connectionSalesforce','115170SiwHwX','205995PqopBn','Branch__c','length','../classes/rollback/zip-creator.rollback','saveLog','Retrieve\x20Metadata\x20Log\x20info','Is_Error__c','../../shared/utils/fetch-attachments','\x20:\x20','Veeva\x20Rollback\x20(Deployment)','TargetId__c','logError','Deployment\x20Result','1lxLvlS','Form\x20Deployment\x20Results','\x27\x0a\x20\x20\x20\x20','PackageImportService','Retrieve\x20Backup','deploymentAction','BACKUP_ZIP_NAME','../classes/errors/salesforce-dml-error','log','Success','.zip','with\x20error','_metadataLog','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Status__c','values','\x20</a>','__esModule','createZip','Create\x20zip\x20from\x20backup','createVpk','success','_veevaService','Failure','2513gmdDLm','_componentIds','patch','slice','FLOSUM_NAMESPACE','136dmyasc','Activity_Type__c','./salesforce.service','error','_salesforceService','_attachmentLogId','Branch','/Attachment','import','_systemLogger','flat','Org__c','name','Component_Type__c','ENDPOINT_UPSERT_RECORD','IdDeploymentResultRetriever','(((.+)+)+)+$','catch','bind','retrieveBackup','execute','18983349HQjqYQ','VpkService','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../classes/retrievers/deployment-results/id.deployment-result.retriever','__importDefault','SalesforceDmlError','isDeployed','successfully','organizationId','Component_Name__c','retrieveDeploymentResults','PackageComponentStatus','post','Metadata_Log__c','_packageImportService','12238808hqUWKX','formFlosumDeploymentResults','base64','./veeva.service','Result__c','retrieveAttachments','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Log__c','../../../core','Action__c','Cannot\x20find\x20Backup\x20Zip','ZipCreatorRollback','Succeed__c','MetadataLogDto','search','fetchAttachmentsDetailsById','RollbackService','Veeva_Step_Name__c','Job_Completed__c','MetadataLogStatus','Body','_logger','../../../constants','toString','retrieveRecords','26046FWLDSY','\x20has\x20been\x20created.','generate','Create\x20Vpk\x20package','constructor','saveDeploymentResults','_parentMetadataLogId','Cannot\x20find\x20Deployment\x20Results','status'];a361_0x1a45=function(){return _0x26af49;};return a361_0x1a45();}const a361_0x4e6abb=a361_0x3fb9;(function(_0x160c5f,_0x587c04){const _0x7142a6=a361_0x3fb9,_0x19dc41=_0x160c5f();while(!![]){try{const _0x47c49a=parseInt(_0x7142a6(0x15d))/0x1*(-parseInt(_0x7142a6(0x146))/0x2)+parseInt(_0x7142a6(0x136))/0x3+parseInt(_0x7142a6(0xe7))/0x4*(parseInt(_0x7142a6(0x150))/0x5)+parseInt(_0x7142a6(0x124))/0x6*(-parseInt(_0x7142a6(0xe2))/0x7)+-parseInt(_0x7142a6(0x10b))/0x8+parseInt(_0x7142a6(0x135))/0x9*(-parseInt(_0x7142a6(0x14f))/0xa)+parseInt(_0x7142a6(0xfc))/0xb;if(_0x47c49a===_0x587c04)break;else _0x19dc41['push'](_0x19dc41['shift']());}catch(_0x301988){_0x19dc41['push'](_0x19dc41['shift']());}}}(a361_0x1a45,0xc0bed));const a361_0x6ce7d9=(function(){let _0x278b1e=!![];return function(_0xc2575f,_0xa9d240){const _0x40fedb=_0x278b1e?function(){if(_0xa9d240){const _0x3189cd=_0xa9d240['apply'](_0xc2575f,arguments);return _0xa9d240=null,_0x3189cd;}}:function(){};return _0x278b1e=![],_0x40fedb;};}()),a361_0x93d84a=a361_0x6ce7d9(this,function(){const _0x336010=a361_0x3fb9;return a361_0x93d84a['toString']()['search'](_0x336010(0xf7))[_0x336010(0x122)]()[_0x336010(0x128)](a361_0x93d84a)[_0x336010(0x119)](_0x336010(0xf7));});a361_0x93d84a();'use strict';var __importDefault=this&&this[a361_0x4e6abb(0x100)]||function(_0x427012){const _0x382f08=a361_0x4e6abb;return _0x427012&&_0x427012[_0x382f08(0xdb)]?_0x427012:{'default':_0x427012};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a361_0x4e6abb(0x11b)]=void 0x0;const veeva_service_1=require(a361_0x4e6abb(0x10e)),salesforce_service_1=require(a361_0x4e6abb(0xe9)),package_import_service_1=require(a361_0x4e6abb(0x13e)),id_deployment_result_retriever_1=require(a361_0x4e6abb(0xff)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a361_0x4e6abb(0x157)),constants_1=require(a361_0x4e6abb(0x121)),zip_creator_rollback_1=require(a361_0x4e6abb(0x153)),shortid_1=__importDefault(require('shortid')),promises_1=require('fs/promises'),vpk_service_1=require('./vpk.service'),status_enums_1=require(a361_0x4e6abb(0x13c)),salesforce_dml_error_1=require(a361_0x4e6abb(0xd1)),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a361_0x4e6abb(0x113));function a361_0x3fb9(_0x13b696,_0x3c2bc7){const _0x5be6ee=a361_0x1a45();return a361_0x3fb9=function(_0x93d84a,_0x6ce7d9){_0x93d84a=_0x93d84a-0xd1;let _0x1a4548=_0x5be6ee[_0x93d84a];return _0x1a4548;},a361_0x3fb9(_0x13b696,_0x3c2bc7);}class RollbackService{constructor({connectionSalesforce:_0x42205d,connectionVeeva:_0x40f847,logger:_0x1b6ef0,tempFolder:_0xa82666,instanceUrl:_0x5bd493,timeZone:_0x3618ec,metadataLogId:_0x3bb5cd,attachmentLogId:_0x17a4be,parentMetadataLogId:_0x4b4a32,componentIds:_0x373bd8}){const _0x1cdfee=a361_0x4e6abb;this['_connectionSalesforce']=_0x42205d,this['_connectionVeeva']=_0x40f847,this[_0x1cdfee(0x120)]=_0x1b6ef0,this['_tempFolder']=_0xa82666,this[_0x1cdfee(0x14b)]=_0x5bd493,this[_0x1cdfee(0x138)]=_0x3618ec,this[_0x1cdfee(0x14c)]=_0x3bb5cd,this[_0x1cdfee(0xec)]=_0x17a4be,this[_0x1cdfee(0x12a)]=_0x4b4a32,this[_0x1cdfee(0xe3)]=_0x373bd8,this[_0x1cdfee(0xf0)]=new core_1[(_0x1cdfee(0x14a))](_0x1cdfee(0x12d)),this[_0x1cdfee(0xe0)]=new veeva_service_1['VeevaService']({'connection':_0x40f847,'logger':_0x1b6ef0}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':_0x42205d}),this[_0x1cdfee(0x10a)]=new package_import_service_1[(_0x1cdfee(0x160))]({'veevaService':this[_0x1cdfee(0xe0)],'connection':_0x40f847,'logger':_0x1b6ef0,'saveLog':this[_0x1cdfee(0x154)][_0x1cdfee(0xf9)](this)}),this[_0x1cdfee(0x145)]=new vpk_service_1[(_0x1cdfee(0xfd))]({'connection':_0x40f847});}async[a361_0x4e6abb(0x154)](_0x207e51,_0x5bc74a){const _0x1bd1fa=a361_0x4e6abb;this[_0x1bd1fa(0x120)]['log']('Save\x20log');const _0xdfa57b={'Body':Buffer[_0x1bd1fa(0x141)](_0x207e51)[_0x1bd1fa(0x122)](_0x1bd1fa(0x10d)),'ContentType':'text/plain','ParentId':this[_0x1bd1fa(0x14c)],'Name':_0x5bc74a};await this['_connectionSalesforce'][_0x1bd1fa(0x108)](flosum_constants_1[_0x1bd1fa(0x140)][_0x1bd1fa(0xf5)]+_0x1bd1fa(0xee),_0xdfa57b);}async[a361_0x4e6abb(0x14d)](){const _0x309744=a361_0x4e6abb;this[_0x309744(0x120)]['log'](_0x309744(0x155));const [_0x499289]=await this[_0x309744(0xeb)][_0x309744(0x123)](_0x309744(0x132)+constants_1[_0x309744(0xe6)]+_0x309744(0xfe)+constants_1[_0x309744(0xe6)]+_0x309744(0xd7)+constants_1[_0x309744(0xe6)]+_0x309744(0x111)+constants_1[_0x309744(0xe6)]+_0x309744(0x137)+this[_0x309744(0x14c)]+_0x309744(0x15f));return new metadata_log_dto_1[(_0x309744(0x118))](_0x499289);}async[a361_0x4e6abb(0x106)](){const _0x293a32=a361_0x4e6abb;this[_0x293a32(0x120)][_0x293a32(0xd2)]('Retrieve\x20Deployment\x20Results');const _0x51e9a1=await new id_deployment_result_retriever_1[(_0x293a32(0xf6))]({'salesforceService':this[_0x293a32(0xeb)],'value':this['_componentIds']})[_0x293a32(0x142)]();if(!_0x51e9a1[_0x293a32(0x152)])throw new Error(_0x293a32(0x12b));return _0x51e9a1;}async[a361_0x4e6abb(0xfa)](){const _0x449001=a361_0x4e6abb;this[_0x449001(0x120)][_0x449001(0xd2)](_0x449001(0x161));const _0x1a64be=await this[_0x449001(0xeb)][_0x449001(0x123)](_0x449001(0x149)+this[_0x449001(0x12a)]+_0x449001(0x133)+flosum_constants_1[_0x449001(0x140)][_0x449001(0x163)]+'\x27\x0a\x20\x20\x20\x20'),_0x40c544=await(0x0,fetch_attachments_1[_0x449001(0x11a)])(this[_0x449001(0x14e)],[_0x1a64be[0x0]['Id']]),_0x10bdd6=await(0x0,fetch_attachments_1[_0x449001(0x110)])(_0x40c544,this[_0x449001(0x14e)]);if(!_0x10bdd6['length'])throw new Error(_0x449001(0x115));return _0x10bdd6[0x0][_0x449001(0xd9)][_0x449001(0x11f)];}async[a361_0x4e6abb(0xdc)](_0x3acb21){const _0x5d92d6=a361_0x4e6abb;this[_0x5d92d6(0x120)][_0x5d92d6(0xd2)](_0x5d92d6(0xdd));const _0x3818e1=await this[_0x5d92d6(0xfa)](),_0x4a37d7=await new zip_creator_rollback_1[(_0x5d92d6(0x116))]({'rollbackName':this[_0x5d92d6(0xd6)][_0x5d92d6(0xf3)],'backup':_0x3818e1,'deploymentResults':_0x3acb21})['create'](),_0x38eb67=this[_0x5d92d6(0x147)]+'/'+(0x0,shortid_1['default'])()+_0x5d92d6(0xd4);return await(0x0,promises_1['writeFile'])(_0x38eb67,_0x4a37d7),_0x38eb67;}async[a361_0x4e6abb(0xde)](_0x41f689){const _0x4a3f0b=a361_0x4e6abb;this[_0x4a3f0b(0x120)][_0x4a3f0b(0xd2)](_0x4a3f0b(0x127));const _0x983698=await this[_0x4a3f0b(0x145)][_0x4a3f0b(0x126)](_0x41f689),_0x462f99=this[_0x4a3f0b(0x147)]+'/vpk__'+_0x41f689[_0x4a3f0b(0xe5)](_0x41f689['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x462f99,_0x983698),await this['_vpkService'][_0x4a3f0b(0x131)](_0x462f99),_0x462f99;}[a361_0x4e6abb(0x10c)](_0x33f340){const _0x54ed74=a361_0x4e6abb;return this[_0x54ed74(0x120)][_0x54ed74(0xd2)](_0x54ed74(0x15e)),_0x33f340['map'](_0x5e4eb2=>{const _0x466fc1=_0x54ed74;return this[_0x466fc1(0x120)][_0x466fc1(0xd2)](_0x5e4eb2['type']+'.'+_0x5e4eb2[_0x466fc1(0xf3)]+_0x466fc1(0x158)+_0x5e4eb2[_0x466fc1(0x12c)]),{[constants_1[_0x466fc1(0xe6)]+'Type__c']:_0x466fc1(0x15c),[constants_1[_0x466fc1(0xe6)]+_0x466fc1(0xd8)]:_0x5e4eb2[_0x466fc1(0x12c)]===status_enums_1[_0x466fc1(0x107)][_0x466fc1(0x13a)]?_0x466fc1(0xd3):_0x466fc1(0xe1),[constants_1[_0x466fc1(0xe6)]+_0x466fc1(0x10f)]:_0x5e4eb2[_0x466fc1(0x162)],[constants_1['FLOSUM_NAMESPACE']+_0x466fc1(0x105)]:_0x5e4eb2[_0x466fc1(0xf3)],[constants_1[_0x466fc1(0xe6)]+_0x466fc1(0xf4)]:_0x5e4eb2['type'],[constants_1[_0x466fc1(0xe6)]+_0x466fc1(0x11c)]:_0x5e4eb2[_0x466fc1(0x148)],[constants_1[_0x466fc1(0xe6)]+_0x466fc1(0xf2)]:this[_0x466fc1(0xd6)][_0x466fc1(0x104)],[constants_1[_0x466fc1(0xe6)]+_0x466fc1(0x109)]:this[_0x466fc1(0x14c)]};});}async[a361_0x4e6abb(0x129)](_0x342927){const _0xae439e=a361_0x4e6abb;this[_0xae439e(0x120)]['log']('Save\x20Deployment\x20Results');const _0x259dd6=await this[_0xae439e(0xeb)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0x342927),_0x50675d=_0x259dd6[_0xae439e(0x143)](_0x28860f=>!_0x28860f[_0xae439e(0xdf)])[_0xae439e(0x134)](_0x104ba1=>_0x104ba1['errors'])[_0xae439e(0xf1)]();if(_0x50675d[_0xae439e(0x152)])throw new salesforce_dml_error_1[(_0xae439e(0x101))](_0x50675d);}async[a361_0x4e6abb(0x13f)](_0xec96f9){const _0x251e97=a361_0x4e6abb;if(!this[_0x251e97(0xd6)]){this[_0x251e97(0xf0)][_0x251e97(0xea)](_0xec96f9);return;}this[_0x251e97(0x120)][_0x251e97(0x15b)](_0xec96f9),await this['_logger'][_0x251e97(0x12f)](),await this[_0x251e97(0x12e)](![],!![],'');}async[a361_0x4e6abb(0x12e)](_0x5a9947,_0xcf5c8f,_0x4ba0a8){const _0x4fb724=a361_0x4e6abb,{id:_0x244b46,organizationId:_0x327696,branchId:_0x42edb1,organizationName:_0x24b4c7}=this['_metadataLog'],_0x1c6177='<a\x20href='+this[_0x4fb724(0x14b)]+'/'+_0x244b46+'\x20>\x20'+_0x4fb724(0x159)+_0x4fb724(0xda),_0x153f2f='<a\x20href='+this[_0x4fb724(0x14b)]+'/'+_0x327696+'\x20>'+_0x24b4c7+'</a>',_0x2b9b47=_0x1c6177+'\x20of\x20branch\x20to\x20Organization\x20'+_0x153f2f+_0x4fb724(0x125),_0x56e17e={[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x114)]:_0x2b9b47,[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x130)]:new Date(),[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x151)]:_0x42edb1,[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x13d)]:_0x4fb724(0xed),[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0xe8)]:'Deployment',[constants_1['FLOSUM_NAMESPACE']+_0x4fb724(0x15a)]:_0x327696},_0x1b27fd={[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x156)]:!_0x5a9947,[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x117)]:_0x5a9947,[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0xd8)]:_0xcf5c8f?status_enums_1[_0x4fb724(0x11e)]['EXCEPTION']:status_enums_1[_0x4fb724(0x11e)][_0x4fb724(0x144)],[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x11d)]:!![],[constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x139)]:_0x4ba0a8};await this[_0x4fb724(0x14e)][_0x4fb724(0xe4)](flosum_constants_1[_0x4fb724(0x140)][_0x4fb724(0xf5)]+'/'+constants_1[_0x4fb724(0xe6)]+'Metadata_Log__c/'+this[_0x4fb724(0x14c)],_0x1b27fd),await this[_0x4fb724(0x14e)]['post'](flosum_constants_1['FlosumConstants'][_0x4fb724(0xf5)]+'/'+constants_1[_0x4fb724(0xe6)]+_0x4fb724(0x112),_0x56e17e),this['_logger'][_0x4fb724(0xd2)](_0x4fb724(0x13b)+(_0x5a9947?_0x4fb724(0x103):_0x4fb724(0xd5))+'.'),await this[_0x4fb724(0x120)]['updateLog']();}async[a361_0x4e6abb(0xfb)](){const _0x2a69a7=a361_0x4e6abb;try{this['_metadataLog']=await this['retrieveMetadataLog']();const _0xebbdcb=await this['retrieveDeploymentResults']();await this[_0x2a69a7(0x120)][_0x2a69a7(0x12f)]();const _0x471e41=await this[_0x2a69a7(0xdc)](_0xebbdcb),_0x5d4d69=await this[_0x2a69a7(0xde)](_0x471e41);await this[_0x2a69a7(0x120)]['updateLog']();const _0x49ae1d=await this['_packageImportService'][_0x2a69a7(0xef)](_0x5d4d69);await this[_0x2a69a7(0x120)]['updateLog']();const _0x348fc2=this[_0x2a69a7(0x10c)](_0x49ae1d['packageComponentList']);await this[_0x2a69a7(0x129)](_0x348fc2),await this[_0x2a69a7(0x12e)](_0x49ae1d[_0x2a69a7(0x102)],![],_0x49ae1d['packageId']);}catch(_0x282a6e){await this[_0x2a69a7(0x13f)](_0x282a6e)[_0x2a69a7(0xf8)](_0x497e7d=>this[_0x2a69a7(0xf0)]['error'](_0x497e7d));}}}exports[a361_0x4e6abb(0x11b)]=RollbackService;