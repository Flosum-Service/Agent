const a376_0x105b66=a376_0x502b;(function(_0x59dd9e,_0x3d156a){const _0x22c285=a376_0x502b,_0x9d790e=_0x59dd9e();while(!![]){try{const _0x1bc7a8=parseInt(_0x22c285(0x1e6))/0x1+parseInt(_0x22c285(0x1be))/0x2*(parseInt(_0x22c285(0x1b5))/0x3)+parseInt(_0x22c285(0x1dc))/0x4+parseInt(_0x22c285(0x1c6))/0x5*(-parseInt(_0x22c285(0x1a6))/0x6)+parseInt(_0x22c285(0x1ac))/0x7+parseInt(_0x22c285(0x1b4))/0x8+-parseInt(_0x22c285(0x1a4))/0x9*(parseInt(_0x22c285(0x19f))/0xa);if(_0x1bc7a8===_0x3d156a)break;else _0x9d790e['push'](_0x9d790e['shift']());}catch(_0x34ba66){_0x9d790e['push'](_0x9d790e['shift']());}}}(a376_0x51fd,0xd5f3a));const a376_0x1f9218=(function(){let _0x220800=!![];return function(_0x186841,_0x284b86){const _0x4519bd=_0x220800?function(){const _0x3e33ba=a376_0x502b;if(_0x284b86){const _0x2caeea=_0x284b86[_0x3e33ba(0x173)](_0x186841,arguments);return _0x284b86=null,_0x2caeea;}}:function(){};return _0x220800=![],_0x4519bd;};}()),a376_0x2f6e79=a376_0x1f9218(this,function(){const _0x47456d=a376_0x502b;return a376_0x2f6e79[_0x47456d(0x1d1)]()[_0x47456d(0x193)](_0x47456d(0x1bc))['toString']()['constructor'](a376_0x2f6e79)[_0x47456d(0x193)](_0x47456d(0x1bc));});function a376_0x502b(_0x10e8df,_0x51c2c8){const _0x5b8554=a376_0x51fd();return a376_0x502b=function(_0x2f6e79,_0x1f9218){_0x2f6e79=_0x2f6e79-0x16b;let _0x51fd24=_0x5b8554[_0x2f6e79];return _0x51fd24;},a376_0x502b(_0x10e8df,_0x51c2c8);}a376_0x2f6e79();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x48b3cd){return _0x48b3cd&&_0x48b3cd['__esModule']?_0x48b3cd:{'default':_0x48b3cd};};function a376_0x51fd(){const _0x3d62ca=['import','FlosumConstants','Status__c','retrieveRecords','\x20</a>','ENDPOINT_UPSERT_RECORD','_connectionVeeva','VeevaService','search','Action__c','Save\x20log','_salesforceService','SalesforceService','\x20has\x20been\x20created.','deploymentAction','values','stepName','execute','Log__c','../../../constants','3150qSNUSu','PackageImportService','/vpk__','RollbackService','../classes/rollback/zip-creator.rollback','67941KEjyZj','retrieve','24zZcMiG','Deployment_Result__c','Save\x20Deployment\x20Results','Activity_Item__c','_metadataLogId','FLOSUM_NAMESPACE','11621834PZXFJG','\x27\x20AND\x20Name\x20=\x20\x27','map','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','_systemLogger','_tempFolder','<a\x20href=','_packageImportService','6362496hTQIBi','37623OKoBuh','organizationId','.zip','./veeva.service','Org__c','Failure','filter','(((.+)+)+)+$','Success','58FlXozt','</a>','MetadataLogStatus','default','Create\x20zip\x20from\x20backup','../enums/status.enums','../dtos/metadata-log.dto','../../../core','306795FTJulV','SalesforceDmlError','packageComponentList','_instanceUrl','updateLog','_timeZone','name','Logger','validate','COMPLETED','Veeva\x20Rollback\x20(Deployment)','toString','BACKUP_ZIP_NAME','Is_Error__c','type','Succeed__c','error','Rollback\x20completed\x20','errors','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','createZip','retrieveBackup','1872588JqSUje','length','finishRollbackWithError','logError','from','Metadata_Log__c/','post','text/plain','_metadataLog','insertMultipleRecords','212307hRKrDT','Cannot\x20find\x20Backup\x20Zip','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Branch__c','retrieveAttachments','\x27\x0a\x20\x20\x20\x20','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','./package-import.service','External_Deployment_Id__c','retrieveDeploymentResults','/Attachment','MetadataLogDto','DEPLOYED','with\x20error','./salesforce.service','_parentMetadataLogId','fs/promises','_vpkService','__esModule','writeFile','Retrieve\x20Metadata\x20Log\x20info','packageId','saveLog','veeva-rollback','\x20>\x20','Result__c','Form\x20Deployment\x20Results','Job_Completed__c','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Create\x20Vpk\x20package','_attachmentLogId','Metadata_Log__c','_componentIds','\x20of\x20branch\x20to\x20Organization\x20','log','apply','Retrieve\x20Backup','createVpk','bind','EXCEPTION','finishRollback','_logger','fetchAttachmentsDetailsById','./vpk.service','flat','Veeva_Step_Name__c','create','Body','Deployment','defineProperty','Activity_Type__c','formFlosumDeploymentResults','_veevaService','_connectionSalesforce','Type__c','slice','PackageComponentStatus','base64','patch'];a376_0x51fd=function(){return _0x3d62ca;};return a376_0x51fd();}Object[a376_0x105b66(0x181)](exports,a376_0x105b66(0x1f8),{'value':!![]}),exports[a376_0x105b66(0x1a2)]=void 0x0;const veeva_service_1=require(a376_0x105b66(0x1b8)),salesforce_service_1=require(a376_0x105b66(0x1f4)),package_import_service_1=require(a376_0x105b66(0x1ed)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require(a376_0x105b66(0x19e)),zip_creator_rollback_1=require(a376_0x105b66(0x1a3)),shortid_1=__importDefault(require('shortid')),promises_1=require(a376_0x105b66(0x1f6)),vpk_service_1=require(a376_0x105b66(0x17b)),status_enums_1=require(a376_0x105b66(0x1c3)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a376_0x105b66(0x1c4)),core_1=require(a376_0x105b66(0x1c5));class RollbackService{constructor({connectionSalesforce:_0x468067,connectionVeeva:_0x3e9d5b,logger:_0x7e3873,tempFolder:_0x2af70d,instanceUrl:_0x269858,timeZone:_0x59cef5,metadataLogId:_0x5dff7b,attachmentLogId:_0x1974ad,parentMetadataLogId:_0x45c9fa,componentIds:_0x1e2078}){const _0xe59d9b=a376_0x105b66;this[_0xe59d9b(0x185)]=_0x468067,this[_0xe59d9b(0x191)]=_0x3e9d5b,this[_0xe59d9b(0x179)]=_0x7e3873,this['_tempFolder']=_0x2af70d,this[_0xe59d9b(0x1c9)]=_0x269858,this[_0xe59d9b(0x1cb)]=_0x59cef5,this['_metadataLogId']=_0x5dff7b,this[_0xe59d9b(0x16e)]=_0x1974ad,this[_0xe59d9b(0x1f5)]=_0x45c9fa,this[_0xe59d9b(0x170)]=_0x1e2078,this['_systemLogger']=new core_1[(_0xe59d9b(0x1cd))](_0xe59d9b(0x1fd)),this[_0xe59d9b(0x184)]=new veeva_service_1[(_0xe59d9b(0x192))]({'connection':_0x3e9d5b,'logger':_0x7e3873}),this[_0xe59d9b(0x196)]=new salesforce_service_1[(_0xe59d9b(0x197))]({'connection':_0x468067}),this['_packageImportService']=new package_import_service_1[(_0xe59d9b(0x1a0))]({'veevaService':this[_0xe59d9b(0x184)],'connection':_0x3e9d5b,'logger':_0x7e3873,'saveLog':this[_0xe59d9b(0x1fc)][_0xe59d9b(0x176)](this)}),this[_0xe59d9b(0x1f7)]=new vpk_service_1['VpkService']({'connection':_0x3e9d5b});}async['saveLog'](_0x2f8eaa,_0x180d12){const _0x660fe0=a376_0x105b66;this[_0x660fe0(0x179)][_0x660fe0(0x172)](_0x660fe0(0x195));const _0x45fd61={'Body':Buffer[_0x660fe0(0x1e0)](_0x2f8eaa)[_0x660fe0(0x1d1)](_0x660fe0(0x189)),'ContentType':_0x660fe0(0x1e3),'ParentId':this[_0x660fe0(0x1aa)],'Name':_0x180d12};await this[_0x660fe0(0x185)][_0x660fe0(0x1e2)](flosum_constants_1[_0x660fe0(0x18c)]['ENDPOINT_UPSERT_RECORD']+_0x660fe0(0x1f0),_0x45fd61);}async['retrieveMetadataLog'](){const _0x32ac08=a376_0x105b66;this[_0x32ac08(0x179)]['log'](_0x32ac08(0x1fa));const [_0x496127]=await this[_0x32ac08(0x196)][_0x32ac08(0x18e)](_0x32ac08(0x1d9)+constants_1[_0x32ac08(0x1ab)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x32ac08(0x1ab)]+_0x32ac08(0x1ec)+constants_1[_0x32ac08(0x1ab)]+_0x32ac08(0x1e8)+constants_1[_0x32ac08(0x1ab)]+_0x32ac08(0x16c)+this[_0x32ac08(0x1aa)]+_0x32ac08(0x1eb));return new metadata_log_dto_1[(_0x32ac08(0x1f1))](_0x496127);}async[a376_0x105b66(0x1ef)](){const _0x55c8bd=a376_0x105b66;this[_0x55c8bd(0x179)][_0x55c8bd(0x172)]('Retrieve\x20Deployment\x20Results');const _0x213622=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this[_0x55c8bd(0x196)],'value':this[_0x55c8bd(0x170)]})[_0x55c8bd(0x1a5)]();if(!_0x213622[_0x55c8bd(0x1dd)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x213622;}async[a376_0x105b66(0x1db)](){const _0x5251f9=a376_0x105b66;this[_0x5251f9(0x179)][_0x5251f9(0x172)](_0x5251f9(0x174));const _0xa2f38b=await this[_0x5251f9(0x196)][_0x5251f9(0x18e)](_0x5251f9(0x1af)+this[_0x5251f9(0x1f5)]+_0x5251f9(0x1ad)+flosum_constants_1[_0x5251f9(0x18c)][_0x5251f9(0x1d2)]+_0x5251f9(0x1eb)),_0x2082be=await(0x0,fetch_attachments_1[_0x5251f9(0x17a)])(this[_0x5251f9(0x185)],[_0xa2f38b[0x0]['Id']]),_0x2d8e02=await(0x0,fetch_attachments_1[_0x5251f9(0x1ea)])(_0x2082be,this[_0x5251f9(0x185)]);if(!_0x2d8e02[_0x5251f9(0x1dd)])throw new Error(_0x5251f9(0x1e7));return _0x2d8e02[0x0][_0x5251f9(0x19a)][_0x5251f9(0x17f)];}async[a376_0x105b66(0x1da)](_0x30952b){const _0x129033=a376_0x105b66;this['_logger'][_0x129033(0x172)](_0x129033(0x1c2));const _0x21d136=await this['retrieveBackup'](),_0xef2c54=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this[_0x129033(0x1e4)][_0x129033(0x1cc)],'backup':_0x21d136,'deploymentResults':_0x30952b})[_0x129033(0x17e)](),_0xf36d2f=this[_0x129033(0x1b1)]+'/'+(0x0,shortid_1[_0x129033(0x1c1)])()+_0x129033(0x1b7);return await(0x0,promises_1[_0x129033(0x1f9)])(_0xf36d2f,_0xef2c54),_0xf36d2f;}async[a376_0x105b66(0x175)](_0xee2600){const _0x13f858=a376_0x105b66;this[_0x13f858(0x179)][_0x13f858(0x172)](_0x13f858(0x16d));const _0x1b220a=await this[_0x13f858(0x1f7)]['generate'](_0xee2600),_0x1fc1f9=this[_0x13f858(0x1b1)]+_0x13f858(0x1a1)+_0xee2600[_0x13f858(0x187)](_0xee2600['lastIndexOf']('/')+0x1);return await(0x0,promises_1[_0x13f858(0x1f9)])(_0x1fc1f9,_0x1b220a),await this[_0x13f858(0x1f7)][_0x13f858(0x1ce)](_0x1fc1f9),_0x1fc1f9;}['formFlosumDeploymentResults'](_0x24dcb0){const _0x5e4d59=a376_0x105b66;return this[_0x5e4d59(0x179)][_0x5e4d59(0x172)](_0x5e4d59(0x200)),_0x24dcb0[_0x5e4d59(0x1ae)](_0x1e2d0b=>{const _0x306099=_0x5e4d59;return this['_logger']['log'](_0x1e2d0b[_0x306099(0x1d4)]+'.'+_0x1e2d0b[_0x306099(0x1cc)]+'\x20:\x20'+_0x1e2d0b['status']),{[constants_1['FLOSUM_NAMESPACE']+_0x306099(0x186)]:'Deployment\x20Result',[constants_1[_0x306099(0x1ab)]+_0x306099(0x18d)]:_0x1e2d0b['status']===status_enums_1[_0x306099(0x188)][_0x306099(0x1f2)]?_0x306099(0x1bd):_0x306099(0x1ba),[constants_1['FLOSUM_NAMESPACE']+_0x306099(0x1ff)]:_0x1e2d0b[_0x306099(0x199)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x1e2d0b[_0x306099(0x1cc)],[constants_1[_0x306099(0x1ab)]+'Component_Type__c']:_0x1e2d0b[_0x306099(0x1d4)],[constants_1[_0x306099(0x1ab)]+_0x306099(0x17d)]:_0x1e2d0b[_0x306099(0x19b)],[constants_1[_0x306099(0x1ab)]+_0x306099(0x1b9)]:this[_0x306099(0x1e4)][_0x306099(0x1b6)],[constants_1['FLOSUM_NAMESPACE']+_0x306099(0x16f)]:this['_metadataLogId']};});}async['saveDeploymentResults'](_0x35583a){const _0x5a21e5=a376_0x105b66;this[_0x5a21e5(0x179)][_0x5a21e5(0x172)](_0x5a21e5(0x1a8));const _0x2cfb9f=await this[_0x5a21e5(0x196)][_0x5a21e5(0x1e5)](constants_1[_0x5a21e5(0x1ab)]+_0x5a21e5(0x1a7),_0x35583a),_0x497f46=_0x2cfb9f[_0x5a21e5(0x1bb)](_0x12ce31=>!_0x12ce31['success'])['map'](_0x5ea5db=>_0x5ea5db[_0x5a21e5(0x1d8)])[_0x5a21e5(0x17c)]();if(_0x497f46['length'])throw new salesforce_dml_error_1[(_0x5a21e5(0x1c7))](_0x497f46);}async[a376_0x105b66(0x1de)](_0x5960fa){const _0x3dabf6=a376_0x105b66;if(!this['_metadataLog']){this[_0x3dabf6(0x1b0)][_0x3dabf6(0x1d6)](_0x5960fa);return;}this[_0x3dabf6(0x179)][_0x3dabf6(0x1df)](_0x5960fa),await this[_0x3dabf6(0x179)][_0x3dabf6(0x1ca)](),await this[_0x3dabf6(0x178)](![],!![],'');}async['finishRollback'](_0x22071e,_0x4b71fd,_0x338255){const _0x21d64a=a376_0x105b66,{id:_0x322537,organizationId:_0x25c667,branchId:_0x45bbd2,organizationName:_0x30066d}=this[_0x21d64a(0x1e4)],_0x487246=_0x21d64a(0x1b2)+this[_0x21d64a(0x1c9)]+'/'+_0x322537+_0x21d64a(0x1fe)+_0x21d64a(0x1d0)+_0x21d64a(0x18f),_0x3f520a=_0x21d64a(0x1b2)+this['_instanceUrl']+'/'+_0x25c667+'\x20>'+_0x30066d+_0x21d64a(0x1bf),_0x296f3a=_0x487246+_0x21d64a(0x171)+_0x3f520a+_0x21d64a(0x198),_0x5dfd64={[constants_1['FLOSUM_NAMESPACE']+_0x21d64a(0x194)]:_0x296f3a,[constants_1[_0x21d64a(0x1ab)]+'Date__c']:new Date(),[constants_1[_0x21d64a(0x1ab)]+_0x21d64a(0x1e9)]:_0x45bbd2,[constants_1['FLOSUM_NAMESPACE']+_0x21d64a(0x1a9)]:'Branch',[constants_1[_0x21d64a(0x1ab)]+_0x21d64a(0x182)]:_0x21d64a(0x180),[constants_1[_0x21d64a(0x1ab)]+'TargetId__c']:_0x25c667},_0x307ff5={[constants_1[_0x21d64a(0x1ab)]+_0x21d64a(0x1d3)]:!_0x22071e,[constants_1['FLOSUM_NAMESPACE']+_0x21d64a(0x1d5)]:_0x22071e,[constants_1['FLOSUM_NAMESPACE']+_0x21d64a(0x18d)]:_0x4b71fd?status_enums_1[_0x21d64a(0x1c0)][_0x21d64a(0x177)]:status_enums_1[_0x21d64a(0x1c0)][_0x21d64a(0x1cf)],[constants_1[_0x21d64a(0x1ab)]+_0x21d64a(0x16b)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x21d64a(0x1ee)]:_0x338255};await this['_connectionSalesforce'][_0x21d64a(0x18a)](flosum_constants_1[_0x21d64a(0x18c)][_0x21d64a(0x190)]+'/'+constants_1[_0x21d64a(0x1ab)]+_0x21d64a(0x1e1)+this[_0x21d64a(0x1aa)],_0x307ff5),await this[_0x21d64a(0x185)][_0x21d64a(0x1e2)](flosum_constants_1[_0x21d64a(0x18c)][_0x21d64a(0x190)]+'/'+constants_1[_0x21d64a(0x1ab)]+_0x21d64a(0x19d),_0x5dfd64),this['_logger'][_0x21d64a(0x172)](_0x21d64a(0x1d7)+(_0x22071e?'successfully':_0x21d64a(0x1f3))+'.'),await this[_0x21d64a(0x179)][_0x21d64a(0x1ca)]();}async[a376_0x105b66(0x19c)](){const _0x361176=a376_0x105b66;try{this[_0x361176(0x1e4)]=await this['retrieveMetadataLog']();const _0x5536e4=await this[_0x361176(0x1ef)]();await this[_0x361176(0x179)][_0x361176(0x1ca)]();const _0x2ff088=await this[_0x361176(0x1da)](_0x5536e4),_0x209a5b=await this[_0x361176(0x175)](_0x2ff088);await this[_0x361176(0x179)][_0x361176(0x1ca)]();const _0x5c2eac=await this[_0x361176(0x1b3)][_0x361176(0x18b)](_0x209a5b);await this[_0x361176(0x179)][_0x361176(0x1ca)]();const _0x2f0cde=this[_0x361176(0x183)](_0x5c2eac[_0x361176(0x1c8)]);await this['saveDeploymentResults'](_0x2f0cde),await this['finishRollback'](_0x5c2eac['isDeployed'],![],_0x5c2eac[_0x361176(0x1fb)]);}catch(_0x5d6675){await this[_0x361176(0x1de)](_0x5d6675)['catch'](_0x59dabc=>this[_0x361176(0x1b0)][_0x361176(0x1d6)](_0x59dabc));}}}exports[a376_0x105b66(0x1a2)]=RollbackService;