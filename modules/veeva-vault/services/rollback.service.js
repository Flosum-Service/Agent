const a361_0x527c96=a361_0x51fa;(function(_0x20b282,_0x9ac5bd){const _0x9480ed=a361_0x51fa,_0x3d2e77=_0x20b282();while(!![]){try{const _0xe4c810=-parseInt(_0x9480ed(0x159))/0x1+parseInt(_0x9480ed(0x133))/0x2*(-parseInt(_0x9480ed(0x113))/0x3)+parseInt(_0x9480ed(0xe0))/0x4+parseInt(_0x9480ed(0x128))/0x5*(parseInt(_0x9480ed(0x14a))/0x6)+parseInt(_0x9480ed(0xed))/0x7*(-parseInt(_0x9480ed(0xdc))/0x8)+-parseInt(_0x9480ed(0x13c))/0x9+-parseInt(_0x9480ed(0x15e))/0xa*(-parseInt(_0x9480ed(0xdd))/0xb);if(_0xe4c810===_0x9ac5bd)break;else _0x3d2e77['push'](_0x3d2e77['shift']());}catch(_0x11a0bc){_0x3d2e77['push'](_0x3d2e77['shift']());}}}(a361_0x1121,0xa6784));const a361_0x5c78a9=(function(){let _0x2b6775=!![];return function(_0x45de5d,_0x41a046){const _0x576b18=_0x2b6775?function(){const _0x416653=a361_0x51fa;if(_0x41a046){const _0x3d7952=_0x41a046[_0x416653(0x12b)](_0x45de5d,arguments);return _0x41a046=null,_0x3d7952;}}:function(){};return _0x2b6775=![],_0x576b18;};}()),a361_0x3fe3bb=a361_0x5c78a9(this,function(){const _0x6c4ffc=a361_0x51fa;return a361_0x3fe3bb['toString']()[_0x6c4ffc(0xde)](_0x6c4ffc(0xd9))['toString']()[_0x6c4ffc(0x154)](a361_0x3fe3bb)['search'](_0x6c4ffc(0xd9));});a361_0x3fe3bb();function a361_0x51fa(_0x2e4f62,_0x385a91){const _0x19258f=a361_0x1121();return a361_0x51fa=function(_0x3fe3bb,_0x5c78a9){_0x3fe3bb=_0x3fe3bb-0xd7;let _0x112176=_0x19258f[_0x3fe3bb];return _0x112176;},a361_0x51fa(_0x2e4f62,_0x385a91);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2ef953){const _0x59797c=a361_0x51fa;return _0x2ef953&&_0x2ef953[_0x59797c(0x148)]?_0x2ef953:{'default':_0x2ef953};};Object[a361_0x527c96(0x117)](exports,a361_0x527c96(0x148),{'value':!![]}),exports[a361_0x527c96(0x12c)]=void 0x0;const veeva_service_1=require(a361_0x527c96(0xdf)),salesforce_service_1=require(a361_0x527c96(0x119)),package_import_service_1=require(a361_0x527c96(0x136)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),constants_1=require('../../../constants'),zip_creator_rollback_1=require(a361_0x527c96(0x108)),shortid_1=__importDefault(require(a361_0x527c96(0x105))),promises_1=require(a361_0x527c96(0xe8)),vpk_service_1=require(a361_0x527c96(0x15c)),status_enums_1=require(a361_0x527c96(0x11d)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a361_0x527c96(0xfc)),core_1=require(a361_0x527c96(0x11a));function a361_0x1121(){const _0x313229=['\x20>\x20','<a\x20href=','__esModule','_salesforceService','404874ufBOpa','post','formFlosumDeploymentResults','MetadataLogStatus','with\x20error','Body','\x20</a>','logError','createZip','length','constructor','retrieveBackup','_connectionVeeva','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','finishRollback','1289341fcqhSi','Deployment_Result__c','values','./vpk.service','\x27\x20AND\x20Name\x20=\x20\x27','10sSsIsO','type','Deployment\x20Result','_connectionSalesforce','ZipCreatorRollback','log','PackageComponentStatus','retrieveMetadataLog','catch','(((.+)+)+)+$','lastIndexOf','finishRollbackWithError','376cvguij','43588908fJMXoH','search','./veeva.service','1590812uMpBgU','Save\x20log','VpkService','name','ENDPOINT_UPSERT_RECORD','Org__c','toString','Result__c','fs/promises','_vpkService','Job_Completed__c','Date__c','_componentIds','174027ZEiMBz','Status__c','Metadata_Log__c','organizationId','Is_Error__c','BACKUP_ZIP_NAME','\x20:\x20','_parentMetadataLogId','execute','status','.zip','VeevaService','MetadataLogDto','_systemLogger','_packageImportService','../dtos/metadata-log.dto','retrieveDeploymentResults','updateLog','Retrieve\x20Metadata\x20Log\x20info','SalesforceDmlError','Veeva_Step_Name__c','/Attachment','base64','stepName','shortid','filter','errors','../classes/rollback/zip-creator.rollback','Branch','flat','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Component_Type__c','Retrieve\x20Deployment\x20Results','saveDeploymentResults','\x20of\x20branch\x20to\x20Organization\x20','bind','FLOSUM_NAMESPACE','packageId','861LPDkUJ','Activity_Type__c','_instanceUrl','slice','defineProperty','deploymentAction','./salesforce.service','../../../core','successfully','Success','../enums/status.enums','_logger','\x20has\x20been\x20created.','DEPLOYED','map','/vpk__','insertMultipleRecords','COMPLETED','writeFile','Component_Name__c','FlosumConstants','5NwGjsP','create','retrieveRecords','apply','RollbackService','_metadataLogId','EXCEPTION','IdDeploymentResultRetriever','packageComponentList','</a>','_attachmentLogId','4678rItklZ','success','patch','./package-import.service','createVpk','from','isDeployed','Save\x20Deployment\x20Results','Create\x20zip\x20from\x20backup','5551641rxvNzx','retrieveAttachments','_veevaService','Failure','saveLog','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','_tempFolder','_metadataLog','default'];a361_0x1121=function(){return _0x313229;};return a361_0x1121();}class RollbackService{constructor({connectionSalesforce:_0x5e505f,connectionVeeva:_0x2fb73a,logger:_0x3d1df7,tempFolder:_0x3d44a7,instanceUrl:_0x395460,timeZone:_0x3cce32,metadataLogId:_0x5bdf53,attachmentLogId:_0x5e3fde,parentMetadataLogId:_0x2d3b33,componentIds:_0x280111}){const _0x28d8dd=a361_0x527c96;this[_0x28d8dd(0x161)]=_0x5e505f,this[_0x28d8dd(0x156)]=_0x2fb73a,this['_logger']=_0x3d1df7,this[_0x28d8dd(0x143)]=_0x3d44a7,this['_instanceUrl']=_0x395460,this['_timeZone']=_0x3cce32,this['_metadataLogId']=_0x5bdf53,this[_0x28d8dd(0x132)]=_0x5e3fde,this[_0x28d8dd(0xf4)]=_0x2d3b33,this['_componentIds']=_0x280111,this[_0x28d8dd(0xfa)]=new core_1['Logger']('veeva-rollback'),this[_0x28d8dd(0x13e)]=new veeva_service_1[(_0x28d8dd(0xf8))]({'connection':_0x2fb73a,'logger':_0x3d1df7}),this[_0x28d8dd(0x149)]=new salesforce_service_1['SalesforceService']({'connection':_0x5e505f}),this[_0x28d8dd(0xfb)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x28d8dd(0x13e)],'connection':_0x2fb73a,'logger':_0x3d1df7,'saveLog':this[_0x28d8dd(0x140)][_0x28d8dd(0x110)](this)}),this[_0x28d8dd(0xe9)]=new vpk_service_1[(_0x28d8dd(0xe2))]({'connection':_0x2fb73a});}async[a361_0x527c96(0x140)](_0x896703,_0x238f6a){const _0x282fde=a361_0x527c96;this[_0x282fde(0x11e)][_0x282fde(0x163)](_0x282fde(0xe1));const _0x3dfa75={'Body':Buffer[_0x282fde(0x138)](_0x896703)[_0x282fde(0xe6)](_0x282fde(0x103)),'ContentType':'text/plain','ParentId':this[_0x282fde(0x12d)],'Name':_0x238f6a};await this[_0x282fde(0x161)][_0x282fde(0x14b)](flosum_constants_1[_0x282fde(0x127)][_0x282fde(0xe4)]+_0x282fde(0x102),_0x3dfa75);}async[a361_0x527c96(0xd7)](){const _0x50637f=a361_0x527c96;this[_0x50637f(0x11e)]['log'](_0x50637f(0xff));const [_0x1d4de4]=await this[_0x50637f(0x149)]['retrieveRecords'](_0x50637f(0x10b)+constants_1[_0x50637f(0x111)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x50637f(0x142)+constants_1['FLOSUM_NAMESPACE']+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1['FLOSUM_NAMESPACE']+_0x50637f(0x157)+this[_0x50637f(0x12d)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x50637f(0xf9))](_0x1d4de4);}async[a361_0x527c96(0xfd)](){const _0x55382a=a361_0x527c96;this[_0x55382a(0x11e)][_0x55382a(0x163)](_0x55382a(0x10d));const _0x189774=await new id_deployment_result_retriever_1[(_0x55382a(0x12f))]({'salesforceService':this[_0x55382a(0x149)],'value':this[_0x55382a(0xec)]})['retrieve']();if(!_0x189774[_0x55382a(0x153)])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x189774;}async[a361_0x527c96(0x155)](){const _0x4c4fa7=a361_0x527c96;this[_0x4c4fa7(0x11e)][_0x4c4fa7(0x163)]('Retrieve\x20Backup');const _0x5215fe=await this['_salesforceService'][_0x4c4fa7(0x12a)](_0x4c4fa7(0x141)+this[_0x4c4fa7(0xf4)]+_0x4c4fa7(0x15d)+flosum_constants_1[_0x4c4fa7(0x127)][_0x4c4fa7(0xf2)]+'\x27\x0a\x20\x20\x20\x20'),_0x197e46=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x4c4fa7(0x161)],[_0x5215fe[0x0]['Id']]),_0x14ecaf=await(0x0,fetch_attachments_1[_0x4c4fa7(0x13d)])(_0x197e46,this[_0x4c4fa7(0x161)]);if(!_0x14ecaf[_0x4c4fa7(0x153)])throw new Error('Cannot\x20find\x20Backup\x20Zip');return _0x14ecaf[0x0][_0x4c4fa7(0x15b)][_0x4c4fa7(0x14f)];}async[a361_0x527c96(0x152)](_0x2e6c57){const _0x1cfd4b=a361_0x527c96;this['_logger']['log'](_0x1cfd4b(0x13b));const _0x46d2c6=await this[_0x1cfd4b(0x155)](),_0x40b966=await new zip_creator_rollback_1[(_0x1cfd4b(0x162))]({'rollbackName':this['_metadataLog'][_0x1cfd4b(0xe3)],'backup':_0x46d2c6,'deploymentResults':_0x2e6c57})[_0x1cfd4b(0x129)](),_0x3aa054=this[_0x1cfd4b(0x143)]+'/'+(0x0,shortid_1[_0x1cfd4b(0x145)])()+_0x1cfd4b(0xf7);return await(0x0,promises_1['writeFile'])(_0x3aa054,_0x40b966),_0x3aa054;}async[a361_0x527c96(0x137)](_0x516596){const _0x567bc0=a361_0x527c96;this['_logger'][_0x567bc0(0x163)]('Create\x20Vpk\x20package');const _0x14fcc1=await this[_0x567bc0(0xe9)]['generate'](_0x516596),_0x5c7828=this[_0x567bc0(0x143)]+_0x567bc0(0x122)+_0x516596[_0x567bc0(0x116)](_0x516596[_0x567bc0(0xda)]('/')+0x1);return await(0x0,promises_1[_0x567bc0(0x125)])(_0x5c7828,_0x14fcc1),await this[_0x567bc0(0xe9)]['validate'](_0x5c7828),_0x5c7828;}[a361_0x527c96(0x14c)](_0xf1ba49){const _0x4693c7=a361_0x527c96;return this['_logger'][_0x4693c7(0x163)]('Form\x20Deployment\x20Results'),_0xf1ba49['map'](_0xe241a4=>{const _0x466a94=_0x4693c7;return this[_0x466a94(0x11e)]['log'](_0xe241a4[_0x466a94(0x15f)]+'.'+_0xe241a4[_0x466a94(0xe3)]+_0x466a94(0xf3)+_0xe241a4[_0x466a94(0xf6)]),{[constants_1[_0x466a94(0x111)]+'Type__c']:_0x466a94(0x160),[constants_1[_0x466a94(0x111)]+_0x466a94(0xee)]:_0xe241a4[_0x466a94(0xf6)]===status_enums_1[_0x466a94(0x164)][_0x466a94(0x120)]?_0x466a94(0x11c):_0x466a94(0x13f),[constants_1[_0x466a94(0x111)]+_0x466a94(0xe7)]:_0xe241a4[_0x466a94(0x118)],[constants_1[_0x466a94(0x111)]+_0x466a94(0x126)]:_0xe241a4[_0x466a94(0xe3)],[constants_1[_0x466a94(0x111)]+_0x466a94(0x10c)]:_0xe241a4[_0x466a94(0x15f)],[constants_1['FLOSUM_NAMESPACE']+_0x466a94(0x101)]:_0xe241a4[_0x466a94(0x104)],[constants_1['FLOSUM_NAMESPACE']+_0x466a94(0xe5)]:this[_0x466a94(0x144)][_0x466a94(0xf0)],[constants_1[_0x466a94(0x111)]+_0x466a94(0xef)]:this[_0x466a94(0x12d)]};});}async[a361_0x527c96(0x10e)](_0x4fea5c){const _0x4dc540=a361_0x527c96;this[_0x4dc540(0x11e)][_0x4dc540(0x163)](_0x4dc540(0x13a));const _0x1f5d40=await this[_0x4dc540(0x149)][_0x4dc540(0x123)](constants_1[_0x4dc540(0x111)]+_0x4dc540(0x15a),_0x4fea5c),_0xd5458b=_0x1f5d40[_0x4dc540(0x106)](_0x2375b6=>!_0x2375b6[_0x4dc540(0x134)])[_0x4dc540(0x121)](_0xbc1bda=>_0xbc1bda[_0x4dc540(0x107)])[_0x4dc540(0x10a)]();if(_0xd5458b[_0x4dc540(0x153)])throw new salesforce_dml_error_1[(_0x4dc540(0x100))](_0xd5458b);}async['finishRollbackWithError'](_0x133528){const _0x527006=a361_0x527c96;if(!this[_0x527006(0x144)]){this[_0x527006(0xfa)]['error'](_0x133528);return;}this[_0x527006(0x11e)][_0x527006(0x151)](_0x133528),await this[_0x527006(0x11e)][_0x527006(0xfe)](),await this[_0x527006(0x158)](![],!![],'');}async[a361_0x527c96(0x158)](_0x4b4e4b,_0x58f5d1,_0x149cad){const _0x110c30=a361_0x527c96,{id:_0x347933,organizationId:_0x2fc3bf,branchId:_0x302718,organizationName:_0x473585}=this[_0x110c30(0x144)],_0x29ccef=_0x110c30(0x147)+this[_0x110c30(0x115)]+'/'+_0x347933+_0x110c30(0x146)+'Veeva\x20Rollback\x20(Deployment)'+_0x110c30(0x150),_0x15485b=_0x110c30(0x147)+this[_0x110c30(0x115)]+'/'+_0x2fc3bf+'\x20>'+_0x473585+_0x110c30(0x131),_0x3e50b5=_0x29ccef+_0x110c30(0x10f)+_0x15485b+_0x110c30(0x11f),_0x4e5327={[constants_1[_0x110c30(0x111)]+'Action__c']:_0x3e50b5,[constants_1[_0x110c30(0x111)]+_0x110c30(0xeb)]:new Date(),[constants_1[_0x110c30(0x111)]+'Branch__c']:_0x302718,[constants_1['FLOSUM_NAMESPACE']+'Activity_Item__c']:_0x110c30(0x109),[constants_1[_0x110c30(0x111)]+_0x110c30(0x114)]:'Deployment',[constants_1[_0x110c30(0x111)]+'TargetId__c']:_0x2fc3bf},_0x2c9c4a={[constants_1['FLOSUM_NAMESPACE']+_0x110c30(0xf1)]:!_0x4b4e4b,[constants_1[_0x110c30(0x111)]+'Succeed__c']:_0x4b4e4b,[constants_1[_0x110c30(0x111)]+'Status__c']:_0x58f5d1?status_enums_1[_0x110c30(0x14d)][_0x110c30(0x12e)]:status_enums_1[_0x110c30(0x14d)][_0x110c30(0x124)],[constants_1[_0x110c30(0x111)]+_0x110c30(0xea)]:!![],[constants_1[_0x110c30(0x111)]+'External_Deployment_Id__c']:_0x149cad};await this[_0x110c30(0x161)][_0x110c30(0x135)](flosum_constants_1[_0x110c30(0x127)][_0x110c30(0xe4)]+'/'+constants_1[_0x110c30(0x111)]+'Metadata_Log__c/'+this['_metadataLogId'],_0x2c9c4a),await this[_0x110c30(0x161)]['post'](flosum_constants_1[_0x110c30(0x127)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x110c30(0x111)]+'Log__c',_0x4e5327),this[_0x110c30(0x11e)][_0x110c30(0x163)]('Rollback\x20completed\x20'+(_0x4b4e4b?_0x110c30(0x11b):_0x110c30(0x14e))+'.'),await this[_0x110c30(0x11e)]['updateLog']();}async[a361_0x527c96(0xf5)](){const _0x5dd5dc=a361_0x527c96;try{this['_metadataLog']=await this['retrieveMetadataLog']();const _0x3b0587=await this['retrieveDeploymentResults']();await this[_0x5dd5dc(0x11e)][_0x5dd5dc(0xfe)]();const _0x50cf3a=await this[_0x5dd5dc(0x152)](_0x3b0587),_0x1e660f=await this[_0x5dd5dc(0x137)](_0x50cf3a);await this['_logger'][_0x5dd5dc(0xfe)]();const _0x5f1a43=await this[_0x5dd5dc(0xfb)]['import'](_0x1e660f);await this['_logger'][_0x5dd5dc(0xfe)]();const _0x17e7f7=this[_0x5dd5dc(0x14c)](_0x5f1a43[_0x5dd5dc(0x130)]);await this[_0x5dd5dc(0x10e)](_0x17e7f7),await this['finishRollback'](_0x5f1a43[_0x5dd5dc(0x139)],![],_0x5f1a43[_0x5dd5dc(0x112)]);}catch(_0x1027b3){await this[_0x5dd5dc(0xdb)](_0x1027b3)[_0x5dd5dc(0xd8)](_0x4a244c=>this['_systemLogger']['error'](_0x4a244c));}}}exports[a361_0x527c96(0x12c)]=RollbackService;