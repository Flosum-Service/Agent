const a405_0x4bf174=a405_0x4fb0;function a405_0x3609(){const _0x274b25=['RollbackService','4755249kHqYIc','Component_Type__c','_systemLogger','lastIndexOf','External_Deployment_Id__c','constructor','Retrieve\x20Backup','Cannot\x20find\x20Backup\x20Zip','MetadataLogDto','/Attachment','search','catch','_logger','isDeployed','base64','./veeva.service','Success','Deployment','\x27\x0a\x20\x20\x20\x20','../classes/errors/salesforce-dml-error','_veevaService','Action__c','_packageImportService','retrieve','70029SGcYUq','apply','Retrieve\x20Deployment\x20Results','_vpkService','formFlosumDeploymentResults','successfully','./vpk.service','saveLog','length','_salesforceService','error','with\x20error','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','import','defineProperty','execute','stepName','7KgCHIH','Date__c','retrieveMetadataLog','fetchAttachmentsDetailsById','\x20has\x20been\x20created.','\x20:\x20','type','FLOSUM_NAMESPACE','createVpk','saveDeploymentResults','../../../core','_instanceUrl','_tempFolder','finishRollbackWithError','deploymentAction','Metadata_Log__c','Activity_Item__c','writeFile','FlosumConstants','map','Status__c','../../shared/utils/fetch-attachments','patch','../classes/retrievers/deployment-results/id.deployment-result.retriever','validate','Create\x20Vpk\x20package','./package-import.service','_connectionSalesforce','__importDefault','createZip','(((.+)+)+)+$','packageId','values','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','VeevaService','../classes/rollback/zip-creator.rollback','BACKUP_ZIP_NAME','Metadata_Log__c/','6TdoDlw','\x20of\x20branch\x20to\x20Organization\x20','COMPLETED','</a>','Cannot\x20find\x20Deployment\x20Results','status','success','Veeva\x20Rollback\x20(Deployment)','../constants/flosum.constants','EXCEPTION','DEPLOYED','../enums/status.enums','__esModule','Branch__c','.zip','retrieveBackup','_connectionVeeva','Veeva_Step_Name__c','MetadataLogStatus','1031760nBWSjY','flat','retrieveDeploymentResults','insertMultipleRecords','slice','post','../../../constants','96085syGKDL','_parentMetadataLogId','./salesforce.service','packageComponentList','Logger','107782oAAbgd','updateLog','fs/promises','43945mDSwKy','retrieveRecords','Retrieve\x20Metadata\x20Log\x20info','Rollback\x20completed\x20','Org__c','SalesforceDmlError','toString','VpkService','ENDPOINT_UPSERT_RECORD','_componentIds','Succeed__c','veeva-rollback','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','log','_metadataLogId','name','create','\x27\x20AND\x20Name\x20=\x20\x27','Deployment\x20Result','organizationId','Save\x20Deployment\x20Results','Deployment_Result__c','generate','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','2fTQwDq','1010AgtUkt','Is_Error__c','../dtos/metadata-log.dto','errors','IdDeploymentResultRetriever','_attachmentLogId','<a\x20href=','_metadataLog','423592ceruJm','Failure','Type__c','filter','finishRollback','Body'];a405_0x3609=function(){return _0x274b25;};return a405_0x3609();}(function(_0xe64ec3,_0x50c8fc){const _0x3a4fcf=a405_0x4fb0,_0x276756=_0xe64ec3();while(!![]){try{const _0x4dcaa2=parseInt(_0x3a4fcf(0x213))/0x1*(parseInt(_0x3a4fcf(0x22e))/0x2)+parseInt(_0x3a4fcf(0x1bc))/0x3+-parseInt(_0x3a4fcf(0x207))/0x4+parseInt(_0x3a4fcf(0x216))/0x5*(parseInt(_0x3a4fcf(0x1f4))/0x6)+-parseInt(_0x3a4fcf(0x1ce))/0x7*(-parseInt(_0x3a4fcf(0x19d))/0x8)+-parseInt(_0x3a4fcf(0x1a4))/0x9+parseInt(_0x3a4fcf(0x22f))/0xa*(parseInt(_0x3a4fcf(0x20e))/0xb);if(_0x4dcaa2===_0x50c8fc)break;else _0x276756['push'](_0x276756['shift']());}catch(_0x3a8045){_0x276756['push'](_0x276756['shift']());}}}(a405_0x3609,0x4681d));function a405_0x4fb0(_0x4bca56,_0x540cab){const _0x3ec6cb=a405_0x3609();return a405_0x4fb0=function(_0x5c03e8,_0xbaf998){_0x5c03e8=_0x5c03e8-0x199;let _0x3609ed=_0x3ec6cb[_0x5c03e8];return _0x3609ed;},a405_0x4fb0(_0x4bca56,_0x540cab);}const a405_0xbaf998=(function(){let _0x3dbc55=!![];return function(_0x478b19,_0x1cf496){const _0x4a8599=_0x3dbc55?function(){const _0x3b42ef=a405_0x4fb0;if(_0x1cf496){const _0x247cf9=_0x1cf496[_0x3b42ef(0x1bd)](_0x478b19,arguments);return _0x1cf496=null,_0x247cf9;}}:function(){};return _0x3dbc55=![],_0x4a8599;};}()),a405_0x5c03e8=a405_0xbaf998(this,function(){const _0x53258e=a405_0x4fb0;return a405_0x5c03e8[_0x53258e(0x21c)]()['search'](_0x53258e(0x1ec))[_0x53258e(0x21c)]()[_0x53258e(0x1a9)](a405_0x5c03e8)[_0x53258e(0x1ae)](_0x53258e(0x1ec));});a405_0x5c03e8();'use strict';var __importDefault=this&&this[a405_0x4bf174(0x1ea)]||function(_0x5c57a2){const _0x1d8791=a405_0x4bf174;return _0x5c57a2&&_0x5c57a2[_0x1d8791(0x200)]?_0x5c57a2:{'default':_0x5c57a2};};Object[a405_0x4bf174(0x1cb)](exports,'__esModule',{'value':!![]}),exports[a405_0x4bf174(0x1a3)]=void 0x0;const veeva_service_1=require(a405_0x4bf174(0x1b3)),salesforce_service_1=require(a405_0x4bf174(0x210)),package_import_service_1=require(a405_0x4bf174(0x1e8)),id_deployment_result_retriever_1=require(a405_0x4bf174(0x1e5)),flosum_constants_1=require(a405_0x4bf174(0x1fc)),fetch_attachments_1=require(a405_0x4bf174(0x1e3)),constants_1=require(a405_0x4bf174(0x20d)),zip_creator_rollback_1=require(a405_0x4bf174(0x1f1)),shortid_1=__importDefault(require('shortid')),promises_1=require(a405_0x4bf174(0x215)),vpk_service_1=require(a405_0x4bf174(0x1c2)),status_enums_1=require(a405_0x4bf174(0x1ff)),salesforce_dml_error_1=require(a405_0x4bf174(0x1b7)),metadata_log_dto_1=require(a405_0x4bf174(0x231)),core_1=require(a405_0x4bf174(0x1d8));class RollbackService{constructor({connectionSalesforce:_0x2df113,connectionVeeva:_0x68e5e1,logger:_0xb5f0fa,tempFolder:_0x2e0e1e,instanceUrl:_0x1b9239,timeZone:_0x35303c,metadataLogId:_0x542d85,attachmentLogId:_0x39bb7d,parentMetadataLogId:_0x7bdad8,componentIds:_0x5a42b8}){const _0x2036af=a405_0x4bf174;this['_connectionSalesforce']=_0x2df113,this[_0x2036af(0x204)]=_0x68e5e1,this[_0x2036af(0x1b0)]=_0xb5f0fa,this[_0x2036af(0x1da)]=_0x2e0e1e,this[_0x2036af(0x1d9)]=_0x1b9239,this['_timeZone']=_0x35303c,this[_0x2036af(0x224)]=_0x542d85,this[_0x2036af(0x19a)]=_0x39bb7d,this[_0x2036af(0x20f)]=_0x7bdad8,this[_0x2036af(0x21f)]=_0x5a42b8,this[_0x2036af(0x1a6)]=new core_1[(_0x2036af(0x212))](_0x2036af(0x221)),this[_0x2036af(0x1b8)]=new veeva_service_1[(_0x2036af(0x1f0))]({'connection':_0x68e5e1,'logger':_0xb5f0fa}),this['_salesforceService']=new salesforce_service_1['SalesforceService']({'connection':_0x2df113}),this[_0x2036af(0x1ba)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x2036af(0x1b8)],'connection':_0x68e5e1,'logger':_0xb5f0fa,'saveLog':this[_0x2036af(0x1c3)]['bind'](this)}),this[_0x2036af(0x1bf)]=new vpk_service_1[(_0x2036af(0x21d))]({'connection':_0x68e5e1});}async[a405_0x4bf174(0x1c3)](_0x2e5bc7,_0x561e45){const _0x1a63ab=a405_0x4bf174;this[_0x1a63ab(0x1b0)][_0x1a63ab(0x223)]('Save\x20log');const _0x2038e1={'Body':Buffer['from'](_0x2e5bc7)[_0x1a63ab(0x21c)](_0x1a63ab(0x1b2)),'ContentType':'text/plain','ParentId':this['_metadataLogId'],'Name':_0x561e45};await this['_connectionSalesforce'][_0x1a63ab(0x20c)](flosum_constants_1['FlosumConstants'][_0x1a63ab(0x21e)]+_0x1a63ab(0x1ad),_0x2038e1);}async['retrieveMetadataLog'](){const _0x47f489=a405_0x4bf174;this['_logger'][_0x47f489(0x223)](_0x47f489(0x218));const [_0x38f8d1]=await this[_0x47f489(0x1c5)][_0x47f489(0x217)](_0x47f489(0x1c9)+constants_1[_0x47f489(0x1d5)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x47f489(0x1d5)]+_0x47f489(0x222)+constants_1[_0x47f489(0x1d5)]+_0x47f489(0x1c8)+constants_1[_0x47f489(0x1d5)]+_0x47f489(0x1ef)+this['_metadataLogId']+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x47f489(0x1ac))](_0x38f8d1);}async[a405_0x4bf174(0x209)](){const _0x2fafef=a405_0x4bf174;this[_0x2fafef(0x1b0)][_0x2fafef(0x223)](_0x2fafef(0x1be));const _0x183dce=await new id_deployment_result_retriever_1[(_0x2fafef(0x199))]({'salesforceService':this[_0x2fafef(0x1c5)],'value':this[_0x2fafef(0x21f)]})[_0x2fafef(0x1bb)]();if(!_0x183dce['length'])throw new Error(_0x2fafef(0x1f8));return _0x183dce;}async[a405_0x4bf174(0x203)](){const _0x101cb9=a405_0x4bf174;this['_logger']['log'](_0x101cb9(0x1aa));const _0x1ccaa0=await this[_0x101cb9(0x1c5)][_0x101cb9(0x217)](_0x101cb9(0x22d)+this[_0x101cb9(0x20f)]+_0x101cb9(0x227)+flosum_constants_1[_0x101cb9(0x1e0)][_0x101cb9(0x1f2)]+_0x101cb9(0x1b6)),_0x1ebf85=await(0x0,fetch_attachments_1[_0x101cb9(0x1d1)])(this[_0x101cb9(0x1e9)],[_0x1ccaa0[0x0]['Id']]),_0xa8f9d6=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x1ebf85,this[_0x101cb9(0x1e9)]);if(!_0xa8f9d6[_0x101cb9(0x1c4)])throw new Error(_0x101cb9(0x1ab));return _0xa8f9d6[0x0][_0x101cb9(0x1ee)][_0x101cb9(0x1a2)];}async[a405_0x4bf174(0x1eb)](_0x1e7125){const _0x401fce=a405_0x4bf174;this[_0x401fce(0x1b0)][_0x401fce(0x223)]('Create\x20zip\x20from\x20backup');const _0xd6e7d9=await this[_0x401fce(0x203)](),_0x5cb806=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this['_metadataLog'][_0x401fce(0x225)],'backup':_0xd6e7d9,'deploymentResults':_0x1e7125})[_0x401fce(0x226)](),_0x321b85=this['_tempFolder']+'/'+(0x0,shortid_1['default'])()+_0x401fce(0x202);return await(0x0,promises_1['writeFile'])(_0x321b85,_0x5cb806),_0x321b85;}async[a405_0x4bf174(0x1d6)](_0x3fdbcd){const _0x41e1dd=a405_0x4bf174;this[_0x41e1dd(0x1b0)][_0x41e1dd(0x223)](_0x41e1dd(0x1e7));const _0x2e833c=await this['_vpkService'][_0x41e1dd(0x22c)](_0x3fdbcd),_0x348c6c=this[_0x41e1dd(0x1da)]+'/vpk__'+_0x3fdbcd[_0x41e1dd(0x20b)](_0x3fdbcd[_0x41e1dd(0x1a7)]('/')+0x1);return await(0x0,promises_1[_0x41e1dd(0x1df)])(_0x348c6c,_0x2e833c),await this['_vpkService'][_0x41e1dd(0x1e6)](_0x348c6c),_0x348c6c;}['formFlosumDeploymentResults'](_0x1c0627){const _0x29d951=a405_0x4bf174;return this[_0x29d951(0x1b0)][_0x29d951(0x223)]('Form\x20Deployment\x20Results'),_0x1c0627['map'](_0x55e693=>{const _0xd88fdb=_0x29d951;return this[_0xd88fdb(0x1b0)]['log'](_0x55e693[_0xd88fdb(0x1d4)]+'.'+_0x55e693[_0xd88fdb(0x225)]+_0xd88fdb(0x1d3)+_0x55e693[_0xd88fdb(0x1f9)]),{[constants_1[_0xd88fdb(0x1d5)]+_0xd88fdb(0x19f)]:_0xd88fdb(0x228),[constants_1[_0xd88fdb(0x1d5)]+'Status__c']:_0x55e693[_0xd88fdb(0x1f9)]===status_enums_1['PackageComponentStatus'][_0xd88fdb(0x1fe)]?_0xd88fdb(0x1b4):_0xd88fdb(0x19e),[constants_1[_0xd88fdb(0x1d5)]+'Result__c']:_0x55e693[_0xd88fdb(0x1dc)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x55e693[_0xd88fdb(0x225)],[constants_1[_0xd88fdb(0x1d5)]+_0xd88fdb(0x1a5)]:_0x55e693[_0xd88fdb(0x1d4)],[constants_1[_0xd88fdb(0x1d5)]+_0xd88fdb(0x205)]:_0x55e693[_0xd88fdb(0x1cd)],[constants_1[_0xd88fdb(0x1d5)]+_0xd88fdb(0x21a)]:this['_metadataLog'][_0xd88fdb(0x229)],[constants_1[_0xd88fdb(0x1d5)]+_0xd88fdb(0x1dd)]:this[_0xd88fdb(0x224)]};});}async[a405_0x4bf174(0x1d7)](_0x3ac0bd){const _0x34f639=a405_0x4bf174;this[_0x34f639(0x1b0)][_0x34f639(0x223)](_0x34f639(0x22a));const _0x3551cb=await this[_0x34f639(0x1c5)][_0x34f639(0x20a)](constants_1[_0x34f639(0x1d5)]+_0x34f639(0x22b),_0x3ac0bd),_0x222506=_0x3551cb[_0x34f639(0x1a0)](_0x1b92cb=>!_0x1b92cb[_0x34f639(0x1fa)])[_0x34f639(0x1e1)](_0x486b1b=>_0x486b1b[_0x34f639(0x232)])[_0x34f639(0x208)]();if(_0x222506[_0x34f639(0x1c4)])throw new salesforce_dml_error_1[(_0x34f639(0x21b))](_0x222506);}async[a405_0x4bf174(0x1db)](_0x1b6b80){const _0x90e59f=a405_0x4bf174;if(!this['_metadataLog']){this[_0x90e59f(0x1a6)][_0x90e59f(0x1c6)](_0x1b6b80);return;}this[_0x90e59f(0x1b0)]['logError'](_0x1b6b80),await this[_0x90e59f(0x1b0)]['updateLog'](),await this[_0x90e59f(0x1a1)](![],!![],'');}async[a405_0x4bf174(0x1a1)](_0x3a6d96,_0x24639b,_0x124ade){const _0x336ec8=a405_0x4bf174,{id:_0x201758,organizationId:_0x200f2d,branchId:_0x4a1b47,organizationName:_0x501308}=this[_0x336ec8(0x19c)],_0x1d474c='<a\x20href='+this['_instanceUrl']+'/'+_0x201758+'\x20>\x20'+_0x336ec8(0x1fb)+'\x20</a>',_0x5062ca=_0x336ec8(0x19b)+this['_instanceUrl']+'/'+_0x200f2d+'\x20>'+_0x501308+_0x336ec8(0x1f7),_0x5aa6cc=_0x1d474c+_0x336ec8(0x1f5)+_0x5062ca+_0x336ec8(0x1d2),_0x2316a2={[constants_1[_0x336ec8(0x1d5)]+_0x336ec8(0x1b9)]:_0x5aa6cc,[constants_1[_0x336ec8(0x1d5)]+_0x336ec8(0x1cf)]:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x336ec8(0x201)]:_0x4a1b47,[constants_1[_0x336ec8(0x1d5)]+_0x336ec8(0x1de)]:'Branch',[constants_1[_0x336ec8(0x1d5)]+'Activity_Type__c']:_0x336ec8(0x1b5),[constants_1['FLOSUM_NAMESPACE']+'TargetId__c']:_0x200f2d},_0x1089ad={[constants_1[_0x336ec8(0x1d5)]+_0x336ec8(0x230)]:!_0x3a6d96,[constants_1[_0x336ec8(0x1d5)]+_0x336ec8(0x220)]:_0x3a6d96,[constants_1[_0x336ec8(0x1d5)]+_0x336ec8(0x1e2)]:_0x24639b?status_enums_1[_0x336ec8(0x206)][_0x336ec8(0x1fd)]:status_enums_1[_0x336ec8(0x206)][_0x336ec8(0x1f6)],[constants_1[_0x336ec8(0x1d5)]+'Job_Completed__c']:!![],[constants_1[_0x336ec8(0x1d5)]+_0x336ec8(0x1a8)]:_0x124ade};await this[_0x336ec8(0x1e9)][_0x336ec8(0x1e4)](flosum_constants_1['FlosumConstants'][_0x336ec8(0x21e)]+'/'+constants_1[_0x336ec8(0x1d5)]+_0x336ec8(0x1f3)+this['_metadataLogId'],_0x1089ad),await this[_0x336ec8(0x1e9)][_0x336ec8(0x20c)](flosum_constants_1[_0x336ec8(0x1e0)][_0x336ec8(0x21e)]+'/'+constants_1[_0x336ec8(0x1d5)]+'Log__c',_0x2316a2),this[_0x336ec8(0x1b0)]['log'](_0x336ec8(0x219)+(_0x3a6d96?_0x336ec8(0x1c1):_0x336ec8(0x1c7))+'.'),await this[_0x336ec8(0x1b0)][_0x336ec8(0x214)]();}async[a405_0x4bf174(0x1cc)](){const _0xf48efc=a405_0x4bf174;try{this[_0xf48efc(0x19c)]=await this[_0xf48efc(0x1d0)]();const _0x3c36d2=await this['retrieveDeploymentResults']();await this[_0xf48efc(0x1b0)][_0xf48efc(0x214)]();const _0x2d3396=await this[_0xf48efc(0x1eb)](_0x3c36d2),_0x3bbca3=await this[_0xf48efc(0x1d6)](_0x2d3396);await this[_0xf48efc(0x1b0)]['updateLog']();const _0x8bbbaf=await this['_packageImportService'][_0xf48efc(0x1ca)](_0x3bbca3);await this[_0xf48efc(0x1b0)][_0xf48efc(0x214)]();const _0x2dee03=this[_0xf48efc(0x1c0)](_0x8bbbaf[_0xf48efc(0x211)]);await this[_0xf48efc(0x1d7)](_0x2dee03),await this[_0xf48efc(0x1a1)](_0x8bbbaf[_0xf48efc(0x1b1)],![],_0x8bbbaf[_0xf48efc(0x1ed)]);}catch(_0x167c20){await this[_0xf48efc(0x1db)](_0x167c20)[_0xf48efc(0x1af)](_0x330908=>this['_systemLogger']['error'](_0x330908));}}}exports[a405_0x4bf174(0x1a3)]=RollbackService;