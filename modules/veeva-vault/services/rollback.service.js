const a361_0x1625ee=a361_0x5938;(function(_0xcc79ed,_0x4bae72){const _0x3e55f9=a361_0x5938,_0x28225b=_0xcc79ed();while(!![]){try{const _0x2d0e5e=-parseInt(_0x3e55f9(0x20f))/0x1*(-parseInt(_0x3e55f9(0x223))/0x2)+parseInt(_0x3e55f9(0x23a))/0x3+-parseInt(_0x3e55f9(0x206))/0x4+parseInt(_0x3e55f9(0x21f))/0x5*(parseInt(_0x3e55f9(0x1cd))/0x6)+parseInt(_0x3e55f9(0x214))/0x7+parseInt(_0x3e55f9(0x247))/0x8+-parseInt(_0x3e55f9(0x21c))/0x9;if(_0x2d0e5e===_0x4bae72)break;else _0x28225b['push'](_0x28225b['shift']());}catch(_0x2c31ba){_0x28225b['push'](_0x28225b['shift']());}}}(a361_0x4f2c,0xb92dd));const a361_0x2a44c1=(function(){let _0x2873ce=!![];return function(_0x50bbcc,_0x2ae986){const _0x18abc2=_0x2873ce?function(){const _0x2c1bb8=a361_0x5938;if(_0x2ae986){const _0x3b1631=_0x2ae986[_0x2c1bb8(0x22e)](_0x50bbcc,arguments);return _0x2ae986=null,_0x3b1631;}}:function(){};return _0x2873ce=![],_0x18abc2;};}()),a361_0x598f9a=a361_0x2a44c1(this,function(){const _0xb24c2b=a361_0x5938;return a361_0x598f9a[_0xb24c2b(0x1db)]()[_0xb24c2b(0x23d)]('(((.+)+)+)+$')[_0xb24c2b(0x1db)]()[_0xb24c2b(0x1c9)](a361_0x598f9a)[_0xb24c2b(0x23d)](_0xb24c2b(0x23b));});a361_0x598f9a();'use strict';var __importDefault=this&&this[a361_0x1625ee(0x1fe)]||function(_0x4527fa){const _0x20ea15=a361_0x1625ee;return _0x4527fa&&_0x4527fa[_0x20ea15(0x238)]?_0x4527fa:{'default':_0x4527fa};};function a361_0x5938(_0x4fd961,_0x56566c){const _0x577d84=a361_0x4f2c();return a361_0x5938=function(_0x598f9a,_0x2a44c1){_0x598f9a=_0x598f9a-0x1ba;let _0x4f2c6d=_0x577d84[_0x598f9a];return _0x4f2c6d;},a361_0x5938(_0x4fd961,_0x56566c);}Object[a361_0x1625ee(0x22a)](exports,a361_0x1625ee(0x238),{'value':!![]}),exports[a361_0x1625ee(0x22c)]=void 0x0;const veeva_service_1=require(a361_0x1625ee(0x23c)),salesforce_service_1=require(a361_0x1625ee(0x1ce)),package_import_service_1=require('./package-import.service'),id_deployment_result_retriever_1=require(a361_0x1625ee(0x1ea)),flosum_constants_1=require(a361_0x1625ee(0x207)),fetch_attachments_1=require(a361_0x1625ee(0x248)),constants_1=require('../../../constants'),zip_creator_rollback_1=require(a361_0x1625ee(0x1e5)),shortid_1=__importDefault(require(a361_0x1625ee(0x1f9))),promises_1=require(a361_0x1625ee(0x1f4)),vpk_service_1=require('./vpk.service'),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a361_0x1625ee(0x1cb)),metadata_log_dto_1=require(a361_0x1625ee(0x24b)),core_1=require(a361_0x1625ee(0x226));function a361_0x4f2c(){const _0x1a0e7a=['fs/promises','createVpk','status','success','\x20has\x20been\x20created.','shortid','<a\x20href=','finishRollbackWithError','patch','default','__importDefault','Retrieve\x20Deployment\x20Results','bind','_packageImportService','isDeployed','Retrieve\x20Metadata\x20Log\x20info','PackageComponentStatus','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','1844460llPZdB','../constants/flosum.constants','error','fetchAttachmentsDetailsById','catch','.zip','finishRollback','Logger','_vpkService','268736yIZSBa','Retrieve\x20Backup','Succeed__c','Component_Type__c','_metadataLog','952406iFBAWZ','Status__c','Veeva_Step_Name__c','\x27\x20AND\x20Name\x20=\x20\x27','retrieve','Deployment\x20Result','formFlosumDeploymentResults','ENDPOINT_UPSERT_RECORD','21466746SGQklz','SalesforceService','flat','65FalGSH','\x20</a>','_salesforceService','/Attachment','2XcDkdu','MetadataLogStatus','_componentIds','../../../core','Save\x20Deployment\x20Results','VpkService','Org__c','defineProperty','retrieveBackup','RollbackService','TargetId__c','apply','retrieveRecords','_metadataLogId','\x27\x0a\x20\x20\x20\x20','slice','Log__c','filter','Job_Completed__c','name','generate','__esModule','values','2770599caCUnm','(((.+)+)+)+$','./veeva.service','search','stepName','Failure','_tempFolder','PackageImportService','updateLog','saveDeploymentResults','retrieveDeploymentResults','_attachmentLogId','Action__c','9561288czDTjw','../../shared/utils/fetch-attachments','VeevaService','FLOSUM_NAMESPACE','../dtos/metadata-log.dto','_systemLogger','_connectionSalesforce','Cannot\x20find\x20Backup\x20Zip','Metadata_Log__c','Body','Async_Request_Id__c','length','Veeva\x20Rollback\x20(Deployment)','writeFile','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','log','errors','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','Type__c','Cannot\x20find\x20Deployment\x20Results','constructor','with\x20error','../classes/errors/salesforce-dml-error','lastIndexOf','499068aIkawh','./salesforce.service','saveLog','Date__c','\x20of\x20branch\x20to\x20Organization\x20','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','Metadata_Log__c/','deploymentAction','Deployment_Result__c','post','Success','text/plain','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','type','toString','Rollback\x20completed\x20','\x20:\x20','base64','_parentMetadataLogId','BACKUP_ZIP_NAME','packageComponentList','IdDeploymentResultRetriever','SalesforceDmlError','create','../classes/rollback/zip-creator.rollback','Form\x20Deployment\x20Results','_timeZone','createZip','Create\x20zip\x20from\x20backup','../classes/retrievers/deployment-results/id.deployment-result.retriever','Result__c','packageId','_instanceUrl','_logger','retrieveMetadataLog','MetadataLogDto','FlosumConstants','insertMultipleRecords','</a>'];a361_0x4f2c=function(){return _0x1a0e7a;};return a361_0x4f2c();}class RollbackService{constructor({connectionSalesforce:_0x37b822,connectionVeeva:_0x50e72d,logger:_0x2f4ba2,tempFolder:_0x245a79,instanceUrl:_0x4a3928,timeZone:_0x2d8408,metadataLogId:_0xe24d99,attachmentLogId:_0x15d8d8,parentMetadataLogId:_0x4d7644,componentIds:_0x3bbba7}){const _0x443c46=a361_0x1625ee;this[_0x443c46(0x1bb)]=_0x37b822,this['_connectionVeeva']=_0x50e72d,this['_logger']=_0x2f4ba2,this[_0x443c46(0x240)]=_0x245a79,this['_instanceUrl']=_0x4a3928,this[_0x443c46(0x1e7)]=_0x2d8408,this['_metadataLogId']=_0xe24d99,this[_0x443c46(0x245)]=_0x15d8d8,this['_parentMetadataLogId']=_0x4d7644,this[_0x443c46(0x225)]=_0x3bbba7,this['_systemLogger']=new core_1[(_0x443c46(0x20d))]('veeva-rollback'),this['_veevaService']=new veeva_service_1[(_0x443c46(0x249))]({'connection':_0x50e72d,'logger':_0x2f4ba2}),this['_salesforceService']=new salesforce_service_1[(_0x443c46(0x21d))]({'connection':_0x37b822}),this['_packageImportService']=new package_import_service_1[(_0x443c46(0x241))]({'veevaService':this['_veevaService'],'connection':_0x50e72d,'logger':_0x2f4ba2,'saveLog':this[_0x443c46(0x1cf)][_0x443c46(0x200)](this)}),this['_vpkService']=new vpk_service_1[(_0x443c46(0x228))]({'connection':_0x50e72d});}async[a361_0x1625ee(0x1cf)](_0x1ae46a,_0x19be8f){const _0x3729d1=a361_0x1625ee;this[_0x3729d1(0x1ee)][_0x3729d1(0x1c4)]('Save\x20log');const _0x40a668={'Body':Buffer['from'](_0x1ae46a)[_0x3729d1(0x1db)](_0x3729d1(0x1de)),'ContentType':_0x3729d1(0x1d8),'ParentId':this[_0x3729d1(0x230)],'Name':_0x19be8f};await this['_connectionSalesforce']['post'](flosum_constants_1[_0x3729d1(0x1f1)][_0x3729d1(0x21b)]+_0x3729d1(0x222),_0x40a668);}async[a361_0x1625ee(0x1ef)](){const _0x2aab39=a361_0x1625ee;this[_0x2aab39(0x1ee)][_0x2aab39(0x1c4)](_0x2aab39(0x203));const [_0x16e517]=await this[_0x2aab39(0x221)]['retrieveRecords'](_0x2aab39(0x1d9)+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x2aab39(0x205)+constants_1[_0x2aab39(0x24a)]+_0x2aab39(0x1c3)+constants_1['FLOSUM_NAMESPACE']+_0x2aab39(0x1d2)+this[_0x2aab39(0x230)]+_0x2aab39(0x231));return new metadata_log_dto_1[(_0x2aab39(0x1f0))](_0x16e517);}async[a361_0x1625ee(0x244)](){const _0x5e7ce2=a361_0x1625ee;this['_logger'][_0x5e7ce2(0x1c4)](_0x5e7ce2(0x1ff));const _0x3e7db9=await new id_deployment_result_retriever_1[(_0x5e7ce2(0x1e2))]({'salesforceService':this[_0x5e7ce2(0x221)],'value':this[_0x5e7ce2(0x225)]})[_0x5e7ce2(0x218)]();if(!_0x3e7db9['length'])throw new Error(_0x5e7ce2(0x1c8));return _0x3e7db9;}async[a361_0x1625ee(0x22b)](){const _0x908a47=a361_0x1625ee;this[_0x908a47(0x1ee)][_0x908a47(0x1c4)](_0x908a47(0x210));const _0x14e3a8=await this[_0x908a47(0x221)][_0x908a47(0x22f)](_0x908a47(0x1c6)+this[_0x908a47(0x1df)]+_0x908a47(0x217)+flosum_constants_1[_0x908a47(0x1f1)][_0x908a47(0x1e0)]+_0x908a47(0x231)),_0x42830d=await(0x0,fetch_attachments_1[_0x908a47(0x209)])(this[_0x908a47(0x1bb)],[_0x14e3a8[0x0]['Id']]),_0x3c13f4=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x42830d,this[_0x908a47(0x1bb)]);if(!_0x3c13f4[_0x908a47(0x1c0)])throw new Error(_0x908a47(0x1bc));return _0x3c13f4[0x0][_0x908a47(0x239)][_0x908a47(0x1be)];}async[a361_0x1625ee(0x1e8)](_0x515456){const _0x2dae03=a361_0x1625ee;this[_0x2dae03(0x1ee)][_0x2dae03(0x1c4)](_0x2dae03(0x1e9));const _0x94ac4e=await this[_0x2dae03(0x22b)](),_0x358ae9=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this['_metadataLog'][_0x2dae03(0x236)],'backup':_0x94ac4e,'deploymentResults':_0x515456})[_0x2dae03(0x1e4)](),_0x835002=this[_0x2dae03(0x240)]+'/'+(0x0,shortid_1[_0x2dae03(0x1fd)])()+_0x2dae03(0x20b);return await(0x0,promises_1[_0x2dae03(0x1c2)])(_0x835002,_0x358ae9),_0x835002;}async[a361_0x1625ee(0x1f5)](_0x139317){const _0x3ea5e3=a361_0x1625ee;this[_0x3ea5e3(0x1ee)][_0x3ea5e3(0x1c4)]('Create\x20Vpk\x20package');const _0x1e13b9=await this[_0x3ea5e3(0x20e)][_0x3ea5e3(0x237)](_0x139317),_0x497b47=this['_tempFolder']+'/vpk__'+_0x139317[_0x3ea5e3(0x232)](_0x139317[_0x3ea5e3(0x1cc)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x497b47,_0x1e13b9),await this[_0x3ea5e3(0x20e)]['validate'](_0x497b47),_0x497b47;}[a361_0x1625ee(0x21a)](_0x21b757){const _0x2e06a1=a361_0x1625ee;return this[_0x2e06a1(0x1ee)][_0x2e06a1(0x1c4)](_0x2e06a1(0x1e6)),_0x21b757['map'](_0x160ee2=>{const _0x4f4939=_0x2e06a1;return this[_0x4f4939(0x1ee)][_0x4f4939(0x1c4)](_0x160ee2['type']+'.'+_0x160ee2[_0x4f4939(0x236)]+_0x4f4939(0x1dd)+_0x160ee2[_0x4f4939(0x1f6)]),{[constants_1[_0x4f4939(0x24a)]+_0x4f4939(0x1c7)]:_0x4f4939(0x219),[constants_1[_0x4f4939(0x24a)]+_0x4f4939(0x215)]:_0x160ee2[_0x4f4939(0x1f6)]===status_enums_1[_0x4f4939(0x204)]['DEPLOYED']?_0x4f4939(0x1d7):_0x4f4939(0x23f),[constants_1[_0x4f4939(0x24a)]+_0x4f4939(0x1eb)]:_0x160ee2[_0x4f4939(0x1d4)],[constants_1[_0x4f4939(0x24a)]+'Component_Name__c']:_0x160ee2[_0x4f4939(0x236)],[constants_1[_0x4f4939(0x24a)]+_0x4f4939(0x212)]:_0x160ee2[_0x4f4939(0x1da)],[constants_1[_0x4f4939(0x24a)]+_0x4f4939(0x216)]:_0x160ee2[_0x4f4939(0x23e)],[constants_1[_0x4f4939(0x24a)]+_0x4f4939(0x229)]:this[_0x4f4939(0x213)]['organizationId'],[constants_1[_0x4f4939(0x24a)]+_0x4f4939(0x1bd)]:this[_0x4f4939(0x230)]};});}async[a361_0x1625ee(0x243)](_0x536237){const _0x96249d=a361_0x1625ee;this['_logger'][_0x96249d(0x1c4)](_0x96249d(0x227));const _0x3084e9=await this[_0x96249d(0x221)][_0x96249d(0x1f2)](constants_1[_0x96249d(0x24a)]+_0x96249d(0x1d5),_0x536237),_0x24200e=_0x3084e9[_0x96249d(0x234)](_0x258c1f=>!_0x258c1f[_0x96249d(0x1f7)])['map'](_0x388e7e=>_0x388e7e[_0x96249d(0x1c5)])[_0x96249d(0x21e)]();if(_0x24200e['length'])throw new salesforce_dml_error_1[(_0x96249d(0x1e3))](_0x24200e);}async[a361_0x1625ee(0x1fb)](_0x24379f){const _0x5ba98f=a361_0x1625ee;if(!this['_metadataLog']){this['_systemLogger'][_0x5ba98f(0x208)](_0x24379f);return;}this[_0x5ba98f(0x1ee)]['logError'](_0x24379f),await this['_logger'][_0x5ba98f(0x242)](),await this[_0x5ba98f(0x20c)](![],!![],'');}async[a361_0x1625ee(0x20c)](_0x37a16f,_0x148203,_0x5f54cc){const _0x33e367=a361_0x1625ee,{id:_0x319893,organizationId:_0x746a3e,branchId:_0x30878f,organizationName:_0x2e7e5d}=this[_0x33e367(0x213)],_0x42359f=_0x33e367(0x1fa)+this[_0x33e367(0x1ed)]+'/'+_0x319893+'\x20>\x20'+_0x33e367(0x1c1)+_0x33e367(0x220),_0xa77d4=_0x33e367(0x1fa)+this[_0x33e367(0x1ed)]+'/'+_0x746a3e+'\x20>'+_0x2e7e5d+_0x33e367(0x1f3),_0x5c8fa8=_0x42359f+_0x33e367(0x1d1)+_0xa77d4+_0x33e367(0x1f8),_0x4b25cb={[constants_1[_0x33e367(0x24a)]+_0x33e367(0x246)]:_0x5c8fa8,[constants_1['FLOSUM_NAMESPACE']+_0x33e367(0x1d0)]:new Date(),[constants_1[_0x33e367(0x24a)]+'Branch__c']:_0x30878f,[constants_1[_0x33e367(0x24a)]+'Activity_Item__c']:'Branch',[constants_1[_0x33e367(0x24a)]+'Activity_Type__c']:'Deployment',[constants_1[_0x33e367(0x24a)]+_0x33e367(0x22d)]:_0x746a3e},_0x4f78d9={[constants_1[_0x33e367(0x24a)]+'Is_Error__c']:!_0x37a16f,[constants_1['FLOSUM_NAMESPACE']+_0x33e367(0x211)]:_0x37a16f,[constants_1[_0x33e367(0x24a)]+_0x33e367(0x215)]:_0x148203?status_enums_1['MetadataLogStatus']['EXCEPTION']:status_enums_1[_0x33e367(0x224)]['COMPLETED'],[constants_1[_0x33e367(0x24a)]+_0x33e367(0x235)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x33e367(0x1bf)]:_0x5f54cc};await this[_0x33e367(0x1bb)][_0x33e367(0x1fc)](flosum_constants_1[_0x33e367(0x1f1)][_0x33e367(0x21b)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x33e367(0x1d3)+this[_0x33e367(0x230)],_0x4f78d9),await this[_0x33e367(0x1bb)][_0x33e367(0x1d6)](flosum_constants_1[_0x33e367(0x1f1)][_0x33e367(0x21b)]+'/'+constants_1[_0x33e367(0x24a)]+_0x33e367(0x233),_0x4b25cb),this['_logger']['log'](_0x33e367(0x1dc)+(_0x37a16f?'successfully':_0x33e367(0x1ca))+'.'),await this[_0x33e367(0x1ee)]['updateLog']();}async['execute'](){const _0x145874=a361_0x1625ee;try{this[_0x145874(0x213)]=await this['retrieveMetadataLog']();const _0x462925=await this[_0x145874(0x244)]();await this[_0x145874(0x1ee)][_0x145874(0x242)]();const _0x224061=await this[_0x145874(0x1e8)](_0x462925),_0x21a5b4=await this[_0x145874(0x1f5)](_0x224061);await this[_0x145874(0x1ee)]['updateLog']();const _0x25c99c=await this[_0x145874(0x201)]['import'](_0x21a5b4);await this[_0x145874(0x1ee)][_0x145874(0x242)]();const _0x1b3300=this['formFlosumDeploymentResults'](_0x25c99c[_0x145874(0x1e1)]);await this['saveDeploymentResults'](_0x1b3300),await this[_0x145874(0x20c)](_0x25c99c[_0x145874(0x202)],![],_0x25c99c[_0x145874(0x1ec)]);}catch(_0x536d59){await this[_0x145874(0x1fb)](_0x536d59)[_0x145874(0x20a)](_0x33a828=>this[_0x145874(0x1ba)]['error'](_0x33a828));}}}exports[a361_0x1625ee(0x22c)]=RollbackService;