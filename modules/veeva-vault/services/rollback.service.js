function a405_0x27ca(){const _0x4efadb=['__importDefault','2902110mrsTEu','\x20of\x20branch\x20to\x20Organization\x20','../../../constants','patch','packageId','45PIDbTb','COMPLETED','Veeva\x20Rollback\x20(Deployment)','_attachmentLogId','retrieveMetadataLog','Failure','_salesforceService','finishRollback','../enums/status.enums','insertMultipleRecords','createVpk','Retrieve\x20Backup','shortid','Activity_Type__c','Retrieve\x20Deployment\x20Results','SalesforceDmlError','saveLog','isDeployed','ZipCreatorRollback','success','post','PackageComponentStatus','saveDeploymentResults','../classes/rollback/zip-creator.rollback','defineProperty','Logger','Is_Error__c','type','VpkService','status','6709cQqtRY','log','<a\x20href=','values','Deployment\x20Result','Deployment_Result__c','Retrieve\x20Metadata\x20Log\x20info','error','IdDeploymentResultRetriever','Create\x20zip\x20from\x20backup','Success','retrieveAttachments','\x20</a>','/Attachment','Deployment','\x27\x20AND\x20Name\x20=\x20\x27','308NwlpOO','create','Veeva_Step_Name__c','./salesforce.service','./veeva.service','Component_Type__c','retrieveRecords','Metadata_Log__c/','(((.+)+)+)+$','TargetId__c','veeva-rollback','catch','search','Create\x20Vpk\x20package','/vpk__','\x27\x0a\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','Branch__c','../dtos/metadata-log.dto','apply','VeevaService','Component_Name__c','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','flat','Body','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','3117340PWsJeQ','129672sDidzp','../classes/retrievers/deployment-results/id.deployment-result.retriever','\x20:\x20','constructor','Org__c','logError','default','execute','\x20has\x20been\x20created.','import','packageComponentList','MetadataLogStatus','</a>','filter','RollbackService','lastIndexOf','retrieve','10bYTgeB','generate','_packageImportService','length','_metadataLogId','_instanceUrl','DEPLOYED','organizationId','FlosumConstants','25123296ASyRdU','retrieveBackup','map','External_Deployment_Id__c','./package-import.service','deploymentAction','Cannot\x20find\x20Backup\x20Zip','_parentMetadataLogId','retrieveDeploymentResults','\x20>\x20','base64','_timeZone','updateLog','../constants/flosum.constants','Branch','from','_tempFolder','../../shared/utils/fetch-attachments','finishRollbackWithError','SalesforceService','Form\x20Deployment\x20Results','validate','slice','1685pcdXdq','_logger','_systemLogger','_connectionVeeva','_componentIds','Status__c','_veevaService','EXCEPTION','FLOSUM_NAMESPACE','MetadataLogDto','_metadataLog','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','7146pqExFQ','__esModule','_vpkService','3133660cnxHwN','with\x20error','24PAEcpj','successfully','ENDPOINT_UPSERT_RECORD','Type__c','toString','formFlosumDeploymentResults','stepName','createZip','name','_connectionSalesforce','Job_Completed__c'];a405_0x27ca=function(){return _0x4efadb;};return a405_0x27ca();}const a405_0x7eccef=a405_0x32d9;(function(_0x4b5a8e,_0x4f2ab5){const _0x59ab6c=a405_0x32d9,_0x396077=_0x4b5a8e();while(!![]){try{const _0x5b4548=parseInt(_0x59ab6c(0x1b0))/0x1*(parseInt(_0x59ab6c(0x1ec))/0x2)+-parseInt(_0x59ab6c(0x229))/0x3+-parseInt(_0x59ab6c(0x1da))/0x4+-parseInt(_0x59ab6c(0x20c))/0x5*(-parseInt(_0x59ab6c(0x218))/0x6)+-parseInt(_0x59ab6c(0x1c0))/0x7*(parseInt(_0x59ab6c(0x1db))/0x8)+parseInt(_0x59ab6c(0x192))/0x9*(-parseInt(_0x59ab6c(0x21b))/0xa)+parseInt(_0x59ab6c(0x1f5))/0xb*(parseInt(_0x59ab6c(0x21d))/0xc);if(_0x5b4548===_0x4f2ab5)break;else _0x396077['push'](_0x396077['shift']());}catch(_0x5d0504){_0x396077['push'](_0x396077['shift']());}}}(a405_0x27ca,0xee4b5));const a405_0x241ac2=(function(){let _0x4948cc=!![];return function(_0x220748,_0x3a77bd){const _0x35f80c=_0x4948cc?function(){const _0x1cd995=a405_0x32d9;if(_0x3a77bd){const _0x399d07=_0x3a77bd[_0x1cd995(0x1d3)](_0x220748,arguments);return _0x3a77bd=null,_0x399d07;}}:function(){};return _0x4948cc=![],_0x35f80c;};}()),a405_0x55490c=a405_0x241ac2(this,function(){const _0x2956ef=a405_0x32d9;return a405_0x55490c[_0x2956ef(0x221)]()[_0x2956ef(0x1cc)](_0x2956ef(0x1c8))[_0x2956ef(0x221)]()[_0x2956ef(0x1de)](a405_0x55490c)[_0x2956ef(0x1cc)]('(((.+)+)+)+$');});a405_0x55490c();'use strict';var __importDefault=this&&this[a405_0x7eccef(0x228)]||function(_0x8f686e){const _0x19548a=a405_0x7eccef;return _0x8f686e&&_0x8f686e[_0x19548a(0x219)]?_0x8f686e:{'default':_0x8f686e};};Object[a405_0x7eccef(0x1aa)](exports,a405_0x7eccef(0x219),{'value':!![]}),exports[a405_0x7eccef(0x1e9)]=void 0x0;const veeva_service_1=require(a405_0x7eccef(0x1c4)),salesforce_service_1=require(a405_0x7eccef(0x1c3)),package_import_service_1=require(a405_0x7eccef(0x1f9)),id_deployment_result_retriever_1=require(a405_0x7eccef(0x1dc)),flosum_constants_1=require(a405_0x7eccef(0x202)),fetch_attachments_1=require(a405_0x7eccef(0x206)),constants_1=require(a405_0x7eccef(0x18f)),zip_creator_rollback_1=require(a405_0x7eccef(0x1a9)),shortid_1=__importDefault(require(a405_0x7eccef(0x19e))),promises_1=require('fs/promises'),vpk_service_1=require('./vpk.service'),status_enums_1=require(a405_0x7eccef(0x19a)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a405_0x7eccef(0x1d2)),core_1=require('../../../core');class RollbackService{constructor({connectionSalesforce:_0x4974e4,connectionVeeva:_0x3c95f7,logger:_0x2b2318,tempFolder:_0x7597ce,instanceUrl:_0x48a8df,timeZone:_0x4aea5e,metadataLogId:_0x27bcac,attachmentLogId:_0x35fac9,parentMetadataLogId:_0x144e7c,componentIds:_0x4bfb67}){const _0x289398=a405_0x7eccef;this[_0x289398(0x226)]=_0x4974e4,this[_0x289398(0x20f)]=_0x3c95f7,this[_0x289398(0x20d)]=_0x2b2318,this['_tempFolder']=_0x7597ce,this[_0x289398(0x1f1)]=_0x48a8df,this[_0x289398(0x200)]=_0x4aea5e,this[_0x289398(0x1f0)]=_0x27bcac,this[_0x289398(0x195)]=_0x35fac9,this[_0x289398(0x1fc)]=_0x144e7c,this[_0x289398(0x210)]=_0x4bfb67,this[_0x289398(0x20e)]=new core_1[(_0x289398(0x1ab))](_0x289398(0x1ca)),this[_0x289398(0x212)]=new veeva_service_1[(_0x289398(0x1d4))]({'connection':_0x3c95f7,'logger':_0x2b2318}),this[_0x289398(0x198)]=new salesforce_service_1[(_0x289398(0x208))]({'connection':_0x4974e4}),this[_0x289398(0x1ee)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x289398(0x212)],'connection':_0x3c95f7,'logger':_0x2b2318,'saveLog':this[_0x289398(0x1a2)]['bind'](this)}),this[_0x289398(0x21a)]=new vpk_service_1[(_0x289398(0x1ae))]({'connection':_0x3c95f7});}async[a405_0x7eccef(0x1a2)](_0x9fda2f,_0x4e120b){const _0x29bda7=a405_0x7eccef;this[_0x29bda7(0x20d)][_0x29bda7(0x1b1)]('Save\x20log');const _0x569131={'Body':Buffer[_0x29bda7(0x204)](_0x9fda2f)[_0x29bda7(0x221)](_0x29bda7(0x1ff)),'ContentType':'text/plain','ParentId':this[_0x29bda7(0x1f0)],'Name':_0x4e120b};await this[_0x29bda7(0x226)]['post'](flosum_constants_1['FlosumConstants'][_0x29bda7(0x21f)]+_0x29bda7(0x1bd),_0x569131);}async[a405_0x7eccef(0x196)](){const _0x14b264=a405_0x7eccef;this[_0x14b264(0x20d)][_0x14b264(0x1b1)](_0x14b264(0x1b6));const [_0x5bb018]=await this[_0x14b264(0x198)][_0x14b264(0x1c6)](_0x14b264(0x1d6)+constants_1[_0x14b264(0x214)]+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x14b264(0x214)]+_0x14b264(0x1d9)+constants_1['FLOSUM_NAMESPACE']+_0x14b264(0x217)+constants_1[_0x14b264(0x214)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x14b264(0x1f0)]+_0x14b264(0x1cf));return new metadata_log_dto_1[(_0x14b264(0x215))](_0x5bb018);}async[a405_0x7eccef(0x1fd)](){const _0x542c83=a405_0x7eccef;this['_logger'][_0x542c83(0x1b1)](_0x542c83(0x1a0));const _0x57f7d9=await new id_deployment_result_retriever_1[(_0x542c83(0x1b8))]({'salesforceService':this[_0x542c83(0x198)],'value':this[_0x542c83(0x210)]})[_0x542c83(0x1eb)]();if(!_0x57f7d9['length'])throw new Error('Cannot\x20find\x20Deployment\x20Results');return _0x57f7d9;}async['retrieveBackup'](){const _0x5831fe=a405_0x7eccef;this[_0x5831fe(0x20d)]['log'](_0x5831fe(0x19d));const _0x2cc9be=await this[_0x5831fe(0x198)][_0x5831fe(0x1c6)](_0x5831fe(0x1d0)+this['_parentMetadataLogId']+_0x5831fe(0x1bf)+flosum_constants_1[_0x5831fe(0x1f4)]['BACKUP_ZIP_NAME']+_0x5831fe(0x1cf)),_0x2533ee=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(this[_0x5831fe(0x226)],[_0x2cc9be[0x0]['Id']]),_0x16efef=await(0x0,fetch_attachments_1[_0x5831fe(0x1bb)])(_0x2533ee,this[_0x5831fe(0x226)]);if(!_0x16efef[_0x5831fe(0x1ef)])throw new Error(_0x5831fe(0x1fb));return _0x16efef[0x0][_0x5831fe(0x1b3)][_0x5831fe(0x1d8)];}async[a405_0x7eccef(0x224)](_0x24b2bc){const _0xbe8238=a405_0x7eccef;this[_0xbe8238(0x20d)]['log'](_0xbe8238(0x1b9));const _0x597d70=await this[_0xbe8238(0x1f6)](),_0x117dc6=await new zip_creator_rollback_1[(_0xbe8238(0x1a4))]({'rollbackName':this[_0xbe8238(0x216)][_0xbe8238(0x225)],'backup':_0x597d70,'deploymentResults':_0x24b2bc})[_0xbe8238(0x1c1)](),_0x3ab7d9=this[_0xbe8238(0x205)]+'/'+(0x0,shortid_1[_0xbe8238(0x1e1)])()+'.zip';return await(0x0,promises_1['writeFile'])(_0x3ab7d9,_0x117dc6),_0x3ab7d9;}async[a405_0x7eccef(0x19c)](_0x40e976){const _0x429a86=a405_0x7eccef;this[_0x429a86(0x20d)][_0x429a86(0x1b1)](_0x429a86(0x1cd));const _0x2a5657=await this[_0x429a86(0x21a)][_0x429a86(0x1ed)](_0x40e976),_0x3ebb1f=this[_0x429a86(0x205)]+_0x429a86(0x1ce)+_0x40e976[_0x429a86(0x20b)](_0x40e976[_0x429a86(0x1ea)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x3ebb1f,_0x2a5657),await this['_vpkService'][_0x429a86(0x20a)](_0x3ebb1f),_0x3ebb1f;}[a405_0x7eccef(0x222)](_0x30e8ba){const _0x100aa7=a405_0x7eccef;return this[_0x100aa7(0x20d)][_0x100aa7(0x1b1)](_0x100aa7(0x209)),_0x30e8ba[_0x100aa7(0x1f7)](_0x1721b6=>{const _0x430ffe=_0x100aa7;return this[_0x430ffe(0x20d)][_0x430ffe(0x1b1)](_0x1721b6[_0x430ffe(0x1ad)]+'.'+_0x1721b6[_0x430ffe(0x225)]+_0x430ffe(0x1dd)+_0x1721b6['status']),{[constants_1[_0x430ffe(0x214)]+_0x430ffe(0x220)]:_0x430ffe(0x1b4),[constants_1['FLOSUM_NAMESPACE']+_0x430ffe(0x211)]:_0x1721b6[_0x430ffe(0x1af)]===status_enums_1[_0x430ffe(0x1a7)][_0x430ffe(0x1f2)]?_0x430ffe(0x1ba):_0x430ffe(0x197),[constants_1[_0x430ffe(0x214)]+'Result__c']:_0x1721b6[_0x430ffe(0x1fa)],[constants_1[_0x430ffe(0x214)]+_0x430ffe(0x1d5)]:_0x1721b6['name'],[constants_1[_0x430ffe(0x214)]+_0x430ffe(0x1c5)]:_0x1721b6[_0x430ffe(0x1ad)],[constants_1[_0x430ffe(0x214)]+_0x430ffe(0x1c2)]:_0x1721b6[_0x430ffe(0x223)],[constants_1[_0x430ffe(0x214)]+_0x430ffe(0x1df)]:this['_metadataLog'][_0x430ffe(0x1f3)],[constants_1[_0x430ffe(0x214)]+'Metadata_Log__c']:this[_0x430ffe(0x1f0)]};});}async[a405_0x7eccef(0x1a8)](_0x47a114){const _0x22c5f6=a405_0x7eccef;this['_logger']['log']('Save\x20Deployment\x20Results');const _0x32b3fb=await this[_0x22c5f6(0x198)][_0x22c5f6(0x19b)](constants_1['FLOSUM_NAMESPACE']+_0x22c5f6(0x1b5),_0x47a114),_0x5de69c=_0x32b3fb[_0x22c5f6(0x1e8)](_0x480803=>!_0x480803[_0x22c5f6(0x1a5)])[_0x22c5f6(0x1f7)](_0xf1b82d=>_0xf1b82d['errors'])[_0x22c5f6(0x1d7)]();if(_0x5de69c[_0x22c5f6(0x1ef)])throw new salesforce_dml_error_1[(_0x22c5f6(0x1a1))](_0x5de69c);}async[a405_0x7eccef(0x207)](_0x573459){const _0x269948=a405_0x7eccef;if(!this[_0x269948(0x216)]){this[_0x269948(0x20e)][_0x269948(0x1b7)](_0x573459);return;}this[_0x269948(0x20d)][_0x269948(0x1e0)](_0x573459),await this[_0x269948(0x20d)][_0x269948(0x201)](),await this['finishRollback'](![],!![],'');}async[a405_0x7eccef(0x199)](_0x5be4c4,_0x3224ad,_0x5285f0){const _0x4b3bfd=a405_0x7eccef,{id:_0xea35a0,organizationId:_0x49bc70,branchId:_0x30597c,organizationName:_0xadf393}=this[_0x4b3bfd(0x216)],_0x30deb0=_0x4b3bfd(0x1b2)+this['_instanceUrl']+'/'+_0xea35a0+_0x4b3bfd(0x1fe)+_0x4b3bfd(0x194)+_0x4b3bfd(0x1bc),_0xa33dc2='<a\x20href='+this[_0x4b3bfd(0x1f1)]+'/'+_0x49bc70+'\x20>'+_0xadf393+_0x4b3bfd(0x1e7),_0x5c57a6=_0x30deb0+_0x4b3bfd(0x18e)+_0xa33dc2+_0x4b3bfd(0x1e3),_0x3d6878={[constants_1[_0x4b3bfd(0x214)]+'Action__c']:_0x5c57a6,[constants_1[_0x4b3bfd(0x214)]+'Date__c']:new Date(),[constants_1[_0x4b3bfd(0x214)]+_0x4b3bfd(0x1d1)]:_0x30597c,[constants_1[_0x4b3bfd(0x214)]+'Activity_Item__c']:_0x4b3bfd(0x203),[constants_1[_0x4b3bfd(0x214)]+_0x4b3bfd(0x19f)]:_0x4b3bfd(0x1be),[constants_1['FLOSUM_NAMESPACE']+_0x4b3bfd(0x1c9)]:_0x49bc70},_0x5ccd1b={[constants_1[_0x4b3bfd(0x214)]+_0x4b3bfd(0x1ac)]:!_0x5be4c4,[constants_1[_0x4b3bfd(0x214)]+'Succeed__c']:_0x5be4c4,[constants_1[_0x4b3bfd(0x214)]+_0x4b3bfd(0x211)]:_0x3224ad?status_enums_1[_0x4b3bfd(0x1e6)][_0x4b3bfd(0x213)]:status_enums_1['MetadataLogStatus'][_0x4b3bfd(0x193)],[constants_1['FLOSUM_NAMESPACE']+_0x4b3bfd(0x227)]:!![],[constants_1[_0x4b3bfd(0x214)]+_0x4b3bfd(0x1f8)]:_0x5285f0};await this['_connectionSalesforce'][_0x4b3bfd(0x190)](flosum_constants_1[_0x4b3bfd(0x1f4)][_0x4b3bfd(0x21f)]+'/'+constants_1[_0x4b3bfd(0x214)]+_0x4b3bfd(0x1c7)+this['_metadataLogId'],_0x5ccd1b),await this[_0x4b3bfd(0x226)][_0x4b3bfd(0x1a6)](flosum_constants_1[_0x4b3bfd(0x1f4)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x4b3bfd(0x214)]+'Log__c',_0x3d6878),this['_logger'][_0x4b3bfd(0x1b1)]('Rollback\x20completed\x20'+(_0x5be4c4?_0x4b3bfd(0x21e):_0x4b3bfd(0x21c))+'.'),await this[_0x4b3bfd(0x20d)][_0x4b3bfd(0x201)]();}async[a405_0x7eccef(0x1e2)](){const _0x336c48=a405_0x7eccef;try{this[_0x336c48(0x216)]=await this['retrieveMetadataLog']();const _0x19d19b=await this[_0x336c48(0x1fd)]();await this[_0x336c48(0x20d)][_0x336c48(0x201)]();const _0x27c89c=await this[_0x336c48(0x224)](_0x19d19b),_0x19df29=await this[_0x336c48(0x19c)](_0x27c89c);await this[_0x336c48(0x20d)]['updateLog']();const _0x254d3b=await this[_0x336c48(0x1ee)][_0x336c48(0x1e4)](_0x19df29);await this[_0x336c48(0x20d)][_0x336c48(0x201)]();const _0x283d38=this[_0x336c48(0x222)](_0x254d3b[_0x336c48(0x1e5)]);await this[_0x336c48(0x1a8)](_0x283d38),await this[_0x336c48(0x199)](_0x254d3b[_0x336c48(0x1a3)],![],_0x254d3b[_0x336c48(0x191)]);}catch(_0x33029b){await this[_0x336c48(0x207)](_0x33029b)[_0x336c48(0x1cb)](_0xb8b37d=>this[_0x336c48(0x20e)][_0x336c48(0x1b7)](_0xb8b37d));}}}function a405_0x32d9(_0x22688e,_0x488baf){const _0x2a9249=a405_0x27ca();return a405_0x32d9=function(_0x55490c,_0x241ac2){_0x55490c=_0x55490c-0x18e;let _0x27ca63=_0x2a9249[_0x55490c];return _0x27ca63;},a405_0x32d9(_0x22688e,_0x488baf);}exports[a405_0x7eccef(0x1e9)]=RollbackService;