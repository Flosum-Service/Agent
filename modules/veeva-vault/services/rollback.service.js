const a392_0x49d105=a392_0x1f64;(function(_0x26170f,_0x12afcf){const _0x54d36c=a392_0x1f64,_0x4080c6=_0x26170f();while(!![]){try{const _0x54b27e=-parseInt(_0x54d36c(0x158))/0x1*(-parseInt(_0x54d36c(0x1ce))/0x2)+parseInt(_0x54d36c(0x1ba))/0x3*(parseInt(_0x54d36c(0x17f))/0x4)+-parseInt(_0x54d36c(0x1c0))/0x5*(parseInt(_0x54d36c(0x184))/0x6)+parseInt(_0x54d36c(0x142))/0x7+-parseInt(_0x54d36c(0x17e))/0x8*(-parseInt(_0x54d36c(0x1be))/0x9)+-parseInt(_0x54d36c(0x197))/0xa+-parseInt(_0x54d36c(0x1ad))/0xb;if(_0x54b27e===_0x12afcf)break;else _0x4080c6['push'](_0x4080c6['shift']());}catch(_0x5e7809){_0x4080c6['push'](_0x4080c6['shift']());}}}(a392_0x3ce6,0x3d2a9));function a392_0x3ce6(){const _0x2acb04=['Job_Completed__c','Activity_Type__c','</a>','generate','Action__c','../classes/retrievers/deployment-results/id.deployment-result.retriever','text/plain','372QgfDvs','Retrieve\x20Metadata\x20Log\x20info','/Attachment','Component_Name__c','createVpk','catch','Type__c','import','slice','1359344chqoRc','Metadata_Log__c/','veeva-rollback','SalesforceService','organizationId','../../shared/utils/fetch-attachments','post','(((.+)+)+)+$','from','_parentMetadataLogId','VeevaService','DEPLOYED','Rollback\x20completed\x20','_systemLogger','./vpk.service','Save\x20Deployment\x20Results','createZip','Cannot\x20find\x20Backup\x20Zip','Create\x20Vpk\x20package','updateLog','packageComponentList','saveLog','61MwoUFR','Branch__c','/vpk__','<a\x20href=','\x27\x20AND\x20Name\x20=\x20\x27','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x27\x0a\x20\x20\x20\x20','../../../core','filter','Result__c','Is_Error__c','status','External_Deployment_Id__c','fetchAttachmentsDetailsById','shortid','_tempFolder','VpkService','EXCEPTION','MetadataLogDto','Success','\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27','FlosumConstants','patch','base64','defineProperty','log','search','_logger','create','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','retrieveMetadataLog','Retrieve\x20Deployment\x20Results','BACKUP_ZIP_NAME','logError','Veeva\x20Rollback\x20(Deployment)','Log__c','lastIndexOf','_connectionVeeva','416mazLOf','8ftObKT','\x20has\x20been\x20created.','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','length','COMPLETED','2124UktCSy','toString','_vpkService','Branch','__esModule','ZipCreatorRollback','MetadataLogStatus','map','_packageImportService','TargetId__c','formFlosumDeploymentResults','../classes/rollback/zip-creator.rollback','name','values','PackageImportService','retrieveBackup','_salesforceService','_instanceUrl','Component_Type__c','617090waoVjc','./veeva.service','finishRollbackWithError','retrieveAttachments','\x20:\x20','\x20>\x20','ENDPOINT_UPSERT_RECORD','Create\x20zip\x20from\x20backup','_veevaService','../enums/status.enums','success','Form\x20Deployment\x20Results','Save\x20log','_metadataLog','errors','Status__c','../../../constants','Deployment_Result__c','finishRollback','__importDefault','SalesforceDmlError','Logger','1187626bPhjiW','error','FLOSUM_NAMESPACE','writeFile','RollbackService','Date__c','_connectionSalesforce','./package-import.service','Succeed__c','Metadata_Log__c','./salesforce.service','../constants/flosum.constants','Cannot\x20find\x20Deployment\x20Results','150990sDCkHj','with\x20error','saveDeploymentResults','Veeva_Step_Name__c','85230EYmnix','retrieveDeploymentResults','5345NUbJhY','_timeZone','Body','Deployment','PackageComponentStatus','_metadataLogId','type'];a392_0x3ce6=function(){return _0x2acb04;};return a392_0x3ce6();}const a392_0x5ca840=(function(){let _0x1d867a=!![];return function(_0x371131,_0x9f3957){const _0x44993d=_0x1d867a?function(){if(_0x9f3957){const _0x5cd1ea=_0x9f3957['apply'](_0x371131,arguments);return _0x9f3957=null,_0x5cd1ea;}}:function(){};return _0x1d867a=![],_0x44993d;};}()),a392_0x4ab913=a392_0x5ca840(this,function(){const _0x59e3ea=a392_0x1f64;return a392_0x4ab913[_0x59e3ea(0x185)]()['search'](_0x59e3ea(0x149))[_0x59e3ea(0x185)]()['constructor'](a392_0x4ab913)[_0x59e3ea(0x172)](_0x59e3ea(0x149));});function a392_0x1f64(_0x8cc8ce,_0x46fe02){const _0x2868e4=a392_0x3ce6();return a392_0x1f64=function(_0x4ab913,_0x5ca840){_0x4ab913=_0x4ab913-0x13f;let _0x3ce67b=_0x2868e4[_0x4ab913];return _0x3ce67b;},a392_0x1f64(_0x8cc8ce,_0x46fe02);}a392_0x4ab913();'use strict';var __importDefault=this&&this[a392_0x49d105(0x1aa)]||function(_0x58cc99){const _0x3e17b5=a392_0x49d105;return _0x58cc99&&_0x58cc99[_0x3e17b5(0x188)]?_0x58cc99:{'default':_0x58cc99};};Object[a392_0x49d105(0x170)](exports,a392_0x49d105(0x188),{'value':!![]}),exports[a392_0x49d105(0x1b1)]=void 0x0;const veeva_service_1=require(a392_0x49d105(0x198)),salesforce_service_1=require(a392_0x49d105(0x1b7)),package_import_service_1=require(a392_0x49d105(0x1b4)),id_deployment_result_retriever_1=require(a392_0x49d105(0x1cc)),flosum_constants_1=require(a392_0x49d105(0x1b8)),fetch_attachments_1=require(a392_0x49d105(0x147)),constants_1=require(a392_0x49d105(0x1a7)),zip_creator_rollback_1=require(a392_0x49d105(0x18f)),shortid_1=__importDefault(require(a392_0x49d105(0x166))),promises_1=require('fs/promises'),vpk_service_1=require(a392_0x49d105(0x150)),status_enums_1=require(a392_0x49d105(0x1a0)),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require('../dtos/metadata-log.dto'),core_1=require(a392_0x49d105(0x15f));class RollbackService{constructor({connectionSalesforce:_0x3cf7d8,connectionVeeva:_0x1e0109,logger:_0x3c2ff0,tempFolder:_0x1970ce,instanceUrl:_0x309f7f,timeZone:_0x390de4,metadataLogId:_0x2dc242,attachmentLogId:_0x506533,parentMetadataLogId:_0x4dab23,componentIds:_0x698907}){const _0x21456d=a392_0x49d105;this[_0x21456d(0x1b3)]=_0x3cf7d8,this[_0x21456d(0x17d)]=_0x1e0109,this[_0x21456d(0x173)]=_0x3c2ff0,this[_0x21456d(0x167)]=_0x1970ce,this[_0x21456d(0x195)]=_0x309f7f,this[_0x21456d(0x1c1)]=_0x390de4,this[_0x21456d(0x1c5)]=_0x2dc242,this['_attachmentLogId']=_0x506533,this[_0x21456d(0x14b)]=_0x4dab23,this['_componentIds']=_0x698907,this[_0x21456d(0x14f)]=new core_1[(_0x21456d(0x1ac))](_0x21456d(0x144)),this[_0x21456d(0x19f)]=new veeva_service_1[(_0x21456d(0x14c))]({'connection':_0x1e0109,'logger':_0x3c2ff0}),this[_0x21456d(0x194)]=new salesforce_service_1[(_0x21456d(0x145))]({'connection':_0x3cf7d8}),this['_packageImportService']=new package_import_service_1[(_0x21456d(0x192))]({'veevaService':this[_0x21456d(0x19f)],'connection':_0x1e0109,'logger':_0x3c2ff0,'saveLog':this['saveLog']['bind'](this)}),this['_vpkService']=new vpk_service_1[(_0x21456d(0x168))]({'connection':_0x1e0109});}async[a392_0x49d105(0x157)](_0x4f684a,_0x2d9c20){const _0x59676b=a392_0x49d105;this[_0x59676b(0x173)][_0x59676b(0x171)](_0x59676b(0x1a3));const _0x15d0cb={'Body':Buffer[_0x59676b(0x14a)](_0x4f684a)['toString'](_0x59676b(0x16f)),'ContentType':_0x59676b(0x1cd),'ParentId':this['_metadataLogId'],'Name':_0x2d9c20};await this['_connectionSalesforce'][_0x59676b(0x148)](flosum_constants_1[_0x59676b(0x16d)][_0x59676b(0x19d)]+_0x59676b(0x1d0),_0x15d0cb);}async[a392_0x49d105(0x176)](){const _0x4d65ec=a392_0x49d105;this[_0x4d65ec(0x173)][_0x4d65ec(0x171)](_0x4d65ec(0x1cf));const [_0x17beea]=await this[_0x4d65ec(0x194)]['retrieveRecords'](_0x4d65ec(0x15d)+constants_1[_0x4d65ec(0x1af)]+_0x4d65ec(0x181)+constants_1[_0x4d65ec(0x1af)]+'Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x4d65ec(0x1af)]+_0x4d65ec(0x175)+constants_1[_0x4d65ec(0x1af)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x4d65ec(0x1c5)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x4d65ec(0x16a))](_0x17beea);}async[a392_0x49d105(0x1bf)](){const _0x484386=a392_0x49d105;this['_logger'][_0x484386(0x171)](_0x484386(0x177));const _0xc4138=await new id_deployment_result_retriever_1['IdDeploymentResultRetriever']({'salesforceService':this['_salesforceService'],'value':this['_componentIds']})['retrieve']();if(!_0xc4138[_0x484386(0x182)])throw new Error(_0x484386(0x1b9));return _0xc4138;}async[a392_0x49d105(0x193)](){const _0x3462cc=a392_0x49d105;this[_0x3462cc(0x173)]['log']('Retrieve\x20Backup');const _0x481efd=await this[_0x3462cc(0x194)]['retrieveRecords'](_0x3462cc(0x16c)+this[_0x3462cc(0x14b)]+_0x3462cc(0x15c)+flosum_constants_1[_0x3462cc(0x16d)][_0x3462cc(0x178)]+_0x3462cc(0x15e)),_0x4ccd3f=await(0x0,fetch_attachments_1[_0x3462cc(0x165)])(this[_0x3462cc(0x1b3)],[_0x481efd[0x0]['Id']]),_0x396d4a=await(0x0,fetch_attachments_1[_0x3462cc(0x19a)])(_0x4ccd3f,this['_connectionSalesforce']);if(!_0x396d4a[_0x3462cc(0x182)])throw new Error(_0x3462cc(0x153));return _0x396d4a[0x0][_0x3462cc(0x191)][_0x3462cc(0x1c2)];}async[a392_0x49d105(0x152)](_0x4e0a6a){const _0x1f38ed=a392_0x49d105;this[_0x1f38ed(0x173)][_0x1f38ed(0x171)](_0x1f38ed(0x19e));const _0x29175=await this[_0x1f38ed(0x193)](),_0x4a5262=await new zip_creator_rollback_1[(_0x1f38ed(0x189))]({'rollbackName':this[_0x1f38ed(0x1a4)][_0x1f38ed(0x190)],'backup':_0x29175,'deploymentResults':_0x4e0a6a})[_0x1f38ed(0x174)](),_0x51ca04=this[_0x1f38ed(0x167)]+'/'+(0x0,shortid_1['default'])()+'.zip';return await(0x0,promises_1['writeFile'])(_0x51ca04,_0x4a5262),_0x51ca04;}async[a392_0x49d105(0x1d2)](_0x3c684d){const _0x29a487=a392_0x49d105;this[_0x29a487(0x173)][_0x29a487(0x171)](_0x29a487(0x154));const _0x1f9838=await this[_0x29a487(0x186)][_0x29a487(0x1ca)](_0x3c684d),_0x47378e=this[_0x29a487(0x167)]+_0x29a487(0x15a)+_0x3c684d[_0x29a487(0x141)](_0x3c684d[_0x29a487(0x17c)]('/')+0x1);return await(0x0,promises_1[_0x29a487(0x1b0)])(_0x47378e,_0x1f9838),await this[_0x29a487(0x186)]['validate'](_0x47378e),_0x47378e;}[a392_0x49d105(0x18e)](_0x19fffe){const _0xd933e7=a392_0x49d105;return this['_logger'][_0xd933e7(0x171)](_0xd933e7(0x1a2)),_0x19fffe['map'](_0x1f6892=>{const _0x244981=_0xd933e7;return this[_0x244981(0x173)]['log'](_0x1f6892[_0x244981(0x1c6)]+'.'+_0x1f6892[_0x244981(0x190)]+_0x244981(0x19b)+_0x1f6892[_0x244981(0x163)]),{[constants_1[_0x244981(0x1af)]+_0x244981(0x13f)]:'Deployment\x20Result',[constants_1[_0x244981(0x1af)]+_0x244981(0x1a6)]:_0x1f6892[_0x244981(0x163)]===status_enums_1[_0x244981(0x1c4)][_0x244981(0x14d)]?_0x244981(0x16b):'Failure',[constants_1['FLOSUM_NAMESPACE']+_0x244981(0x161)]:_0x1f6892['deploymentAction'],[constants_1[_0x244981(0x1af)]+_0x244981(0x1d1)]:_0x1f6892[_0x244981(0x190)],[constants_1['FLOSUM_NAMESPACE']+_0x244981(0x196)]:_0x1f6892[_0x244981(0x1c6)],[constants_1['FLOSUM_NAMESPACE']+_0x244981(0x1bd)]:_0x1f6892['stepName'],[constants_1[_0x244981(0x1af)]+'Org__c']:this[_0x244981(0x1a4)][_0x244981(0x146)],[constants_1[_0x244981(0x1af)]+_0x244981(0x1b6)]:this[_0x244981(0x1c5)]};});}async[a392_0x49d105(0x1bc)](_0x201a8e){const _0x44e987=a392_0x49d105;this[_0x44e987(0x173)]['log'](_0x44e987(0x151));const _0x496f6b=await this[_0x44e987(0x194)]['insertMultipleRecords'](constants_1[_0x44e987(0x1af)]+_0x44e987(0x1a8),_0x201a8e),_0x2faaa7=_0x496f6b[_0x44e987(0x160)](_0x1f31c0=>!_0x1f31c0[_0x44e987(0x1a1)])[_0x44e987(0x18b)](_0xac71dd=>_0xac71dd[_0x44e987(0x1a5)])['flat']();if(_0x2faaa7['length'])throw new salesforce_dml_error_1[(_0x44e987(0x1ab))](_0x2faaa7);}async[a392_0x49d105(0x199)](_0x4e2ba0){const _0xa0b6ef=a392_0x49d105;if(!this[_0xa0b6ef(0x1a4)]){this[_0xa0b6ef(0x14f)]['error'](_0x4e2ba0);return;}this[_0xa0b6ef(0x173)][_0xa0b6ef(0x179)](_0x4e2ba0),await this[_0xa0b6ef(0x173)]['updateLog'](),await this[_0xa0b6ef(0x1a9)](![],!![],'');}async['finishRollback'](_0x3c52c1,_0x11cc39,_0x554a87){const _0x406757=a392_0x49d105,{id:_0xfa70f,organizationId:_0x37a158,branchId:_0x1af8ee,organizationName:_0xe5ece1}=this[_0x406757(0x1a4)],_0x11f7a3=_0x406757(0x15b)+this[_0x406757(0x195)]+'/'+_0xfa70f+_0x406757(0x19c)+_0x406757(0x17a)+'\x20</a>',_0x309377=_0x406757(0x15b)+this[_0x406757(0x195)]+'/'+_0x37a158+'\x20>'+_0xe5ece1+_0x406757(0x1c9),_0x4f4e16=_0x11f7a3+'\x20of\x20branch\x20to\x20Organization\x20'+_0x309377+_0x406757(0x180),_0x27cd03={[constants_1[_0x406757(0x1af)]+_0x406757(0x1cb)]:_0x4f4e16,[constants_1[_0x406757(0x1af)]+_0x406757(0x1b2)]:new Date(),[constants_1[_0x406757(0x1af)]+_0x406757(0x159)]:_0x1af8ee,[constants_1['FLOSUM_NAMESPACE']+'Activity_Item__c']:_0x406757(0x187),[constants_1[_0x406757(0x1af)]+_0x406757(0x1c8)]:_0x406757(0x1c3),[constants_1[_0x406757(0x1af)]+_0x406757(0x18d)]:_0x37a158},_0x5d37de={[constants_1[_0x406757(0x1af)]+_0x406757(0x162)]:!_0x3c52c1,[constants_1[_0x406757(0x1af)]+_0x406757(0x1b5)]:_0x3c52c1,[constants_1[_0x406757(0x1af)]+_0x406757(0x1a6)]:_0x11cc39?status_enums_1[_0x406757(0x18a)][_0x406757(0x169)]:status_enums_1[_0x406757(0x18a)][_0x406757(0x183)],[constants_1[_0x406757(0x1af)]+_0x406757(0x1c7)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x406757(0x164)]:_0x554a87};await this[_0x406757(0x1b3)][_0x406757(0x16e)](flosum_constants_1[_0x406757(0x16d)][_0x406757(0x19d)]+'/'+constants_1[_0x406757(0x1af)]+_0x406757(0x143)+this[_0x406757(0x1c5)],_0x5d37de),await this[_0x406757(0x1b3)][_0x406757(0x148)](flosum_constants_1[_0x406757(0x16d)][_0x406757(0x19d)]+'/'+constants_1[_0x406757(0x1af)]+_0x406757(0x17b),_0x27cd03),this[_0x406757(0x173)]['log'](_0x406757(0x14e)+(_0x3c52c1?'successfully':_0x406757(0x1bb))+'.'),await this[_0x406757(0x173)]['updateLog']();}async['execute'](){const _0x3ffdd4=a392_0x49d105;try{this[_0x3ffdd4(0x1a4)]=await this[_0x3ffdd4(0x176)]();const _0x3d8da6=await this['retrieveDeploymentResults']();await this[_0x3ffdd4(0x173)]['updateLog']();const _0x1ad079=await this[_0x3ffdd4(0x152)](_0x3d8da6),_0x1cebe7=await this[_0x3ffdd4(0x1d2)](_0x1ad079);await this[_0x3ffdd4(0x173)][_0x3ffdd4(0x155)]();const _0x3aee8e=await this[_0x3ffdd4(0x18c)][_0x3ffdd4(0x140)](_0x1cebe7);await this[_0x3ffdd4(0x173)]['updateLog']();const _0x2121ac=this['formFlosumDeploymentResults'](_0x3aee8e[_0x3ffdd4(0x156)]);await this['saveDeploymentResults'](_0x2121ac),await this[_0x3ffdd4(0x1a9)](_0x3aee8e['isDeployed'],![],_0x3aee8e['packageId']);}catch(_0x303aab){await this[_0x3ffdd4(0x199)](_0x303aab)[_0x3ffdd4(0x1d3)](_0x1b2d07=>this[_0x3ffdd4(0x14f)][_0x3ffdd4(0x1ae)](_0x1b2d07));}}}exports[a392_0x49d105(0x1b1)]=RollbackService;