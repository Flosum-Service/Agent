const a361_0x2ae901=a361_0x19d9;(function(_0x2041fa,_0x1b2521){const _0xab07b0=a361_0x19d9,_0x1ae6a7=_0x2041fa();while(!![]){try{const _0x4ad8d3=parseInt(_0xab07b0(0x127))/0x1*(-parseInt(_0xab07b0(0xff))/0x2)+-parseInt(_0xab07b0(0x100))/0x3*(parseInt(_0xab07b0(0x152))/0x4)+parseInt(_0xab07b0(0x187))/0x5+parseInt(_0xab07b0(0x14e))/0x6+parseInt(_0xab07b0(0x126))/0x7*(-parseInt(_0xab07b0(0x180))/0x8)+parseInt(_0xab07b0(0x17e))/0x9+parseInt(_0xab07b0(0x172))/0xa;if(_0x4ad8d3===_0x1b2521)break;else _0x1ae6a7['push'](_0x1ae6a7['shift']());}catch(_0x1edef1){_0x1ae6a7['push'](_0x1ae6a7['shift']());}}}(a361_0x58d0,0x2e7e0));const a361_0x1bdc2c=(function(){let _0x4e94e0=!![];return function(_0x525964,_0x167ea7){const _0x246fba=_0x4e94e0?function(){if(_0x167ea7){const _0x4ed6c6=_0x167ea7['apply'](_0x525964,arguments);return _0x167ea7=null,_0x4ed6c6;}}:function(){};return _0x4e94e0=![],_0x246fba;};}()),a361_0x4f61e0=a361_0x1bdc2c(this,function(){const _0x2ca4fd=a361_0x19d9;return a361_0x4f61e0[_0x2ca4fd(0x102)]()[_0x2ca4fd(0x11d)]('(((.+)+)+)+$')[_0x2ca4fd(0x102)]()[_0x2ca4fd(0x14d)](a361_0x4f61e0)[_0x2ca4fd(0x11d)]('(((.+)+)+)+$');});function a361_0x19d9(_0x346503,_0x651975){const _0x2d0063=a361_0x58d0();return a361_0x19d9=function(_0x4f61e0,_0x1bdc2c){_0x4f61e0=_0x4f61e0-0xf6;let _0x58d088=_0x2d0063[_0x4f61e0];return _0x58d088;},a361_0x19d9(_0x346503,_0x651975);}a361_0x4f61e0();'use strict';var __importDefault=this&&this[a361_0x2ae901(0x17a)]||function(_0x3aaff3){const _0x4dc033=a361_0x2ae901;return _0x3aaff3&&_0x3aaff3[_0x4dc033(0x12c)]?_0x3aaff3:{'default':_0x3aaff3};};Object[a361_0x2ae901(0x14f)](exports,a361_0x2ae901(0x12c),{'value':!![]}),exports[a361_0x2ae901(0x12d)]=void 0x0;function a361_0x58d0(){const _0x38b7fc=['from','retrieveBackup','_metadataLogId','\x20</a>','PackageComponentStatus','shortid','../../../core','1752401ydlJoM','2153wfWcUt','VeevaService','packageId','Save\x20Deployment\x20Results','Status__c','__esModule','RollbackService','../classes/retrievers/deployment-results/id.deployment-result.retriever','VpkService','fetchAttachmentsDetailsById','COMPLETED','Component_Type__c','Save\x20log','_connectionVeeva','DEPLOYED','External_Deployment_Id__c','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','map','Result__c','retrieveAttachments','_timeZone','Date__c','IdDeploymentResultRetriever','writeFile','create','Activity_Item__c','bind','execute','../classes/errors/salesforce-dml-error','values','SalesforceService','packageComponentList','base64','formFlosumDeploymentResults','ENDPOINT_UPSERT_RECORD','Cannot\x20find\x20Deployment\x20Results','Create\x20zip\x20from\x20backup','error','constructor','2190858vzzhuf','defineProperty','errors','catch','283412ZlIsum','log','finishRollback','Action__c','retrieveRecords','TargetId__c','status','Metadata_Log__c','_tempFolder','./veeva.service','fs/promises','../../../constants','Deployment\x20Result','\x20of\x20branch\x20to\x20Organization\x20','lastIndexOf','flat','Success','_componentIds','_veevaService','saveLog','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','retrieveMetadataLog','PackageImportService','_connectionSalesforce','_packageImportService','createZip','Branch__c','length','Veeva_Step_Name__c','insertMultipleRecords','BACKUP_ZIP_NAME','generate','482440RBsfgf','_systemLogger','\x27\x0a\x20\x20\x20\x20','Veeva\x20Rollback\x20(Deployment)','name','/vpk__','FLOSUM_NAMESPACE','../../shared/utils/fetch-attachments','__importDefault','Succeed__c','MetadataLogStatus','Job_Completed__c','3165471NAEStB','Retrieve\x20Backup','8WUzreW','Create\x20Vpk\x20package','\x20has\x20been\x20created.','retrieve','veeva-rollback','updateLog','Is_Error__c','228945GrjbOx','default','EXCEPTION','<a\x20href=','../enums/status.enums','Logger','_parentMetadataLogId','Org__c','Component_Name__c','ZipCreatorRollback','.zip','278OqsCYd','3OkmQfv','_vpkService','toString','\x27\x20AND\x20Name\x20=\x20\x27','slice','Body','Failure','createVpk','successfully','FlosumConstants','_metadataLog','success','Form\x20Deployment\x20Results','_logger','saveDeploymentResults','Cannot\x20find\x20Backup\x20Zip','isDeployed','type','stepName','text/plain','../dtos/metadata-log.dto','</a>','_salesforceService','\x20>\x20','deploymentAction','/Attachment','../constants/flosum.constants','./package-import.service','\x20:\x20','search','Deployment'];a361_0x58d0=function(){return _0x38b7fc;};return a361_0x58d0();}const veeva_service_1=require(a361_0x2ae901(0x15b)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a361_0x2ae901(0x11b)),id_deployment_result_retriever_1=require(a361_0x2ae901(0x12e)),flosum_constants_1=require(a361_0x2ae901(0x11a)),fetch_attachments_1=require(a361_0x2ae901(0x179)),constants_1=require(a361_0x2ae901(0x15d)),zip_creator_rollback_1=require('../classes/rollback/zip-creator.rollback'),shortid_1=__importDefault(require(a361_0x2ae901(0x124))),promises_1=require(a361_0x2ae901(0x15c)),vpk_service_1=require('./vpk.service'),status_enums_1=require(a361_0x2ae901(0xf8)),salesforce_dml_error_1=require(a361_0x2ae901(0x143)),metadata_log_dto_1=require(a361_0x2ae901(0x114)),core_1=require(a361_0x2ae901(0x125));class RollbackService{constructor({connectionSalesforce:_0x46e26d,connectionVeeva:_0x495111,logger:_0x1fff60,tempFolder:_0x198a07,instanceUrl:_0x2e3098,timeZone:_0x42cee8,metadataLogId:_0x530807,attachmentLogId:_0x53805d,parentMetadataLogId:_0xb60371,componentIds:_0x3cea9f}){const _0x3eb22c=a361_0x2ae901;this[_0x3eb22c(0x169)]=_0x46e26d,this[_0x3eb22c(0x134)]=_0x495111,this[_0x3eb22c(0x10d)]=_0x1fff60,this['_tempFolder']=_0x198a07,this['_instanceUrl']=_0x2e3098,this[_0x3eb22c(0x13b)]=_0x42cee8,this[_0x3eb22c(0x121)]=_0x530807,this['_attachmentLogId']=_0x53805d,this[_0x3eb22c(0xfa)]=_0xb60371,this[_0x3eb22c(0x163)]=_0x3cea9f,this[_0x3eb22c(0x173)]=new core_1[(_0x3eb22c(0xf9))](_0x3eb22c(0x184)),this['_veevaService']=new veeva_service_1[(_0x3eb22c(0x128))]({'connection':_0x495111,'logger':_0x1fff60}),this['_salesforceService']=new salesforce_service_1[(_0x3eb22c(0x145))]({'connection':_0x46e26d}),this[_0x3eb22c(0x16a)]=new package_import_service_1[(_0x3eb22c(0x168))]({'veevaService':this[_0x3eb22c(0x164)],'connection':_0x495111,'logger':_0x1fff60,'saveLog':this['saveLog'][_0x3eb22c(0x141)](this)}),this[_0x3eb22c(0x101)]=new vpk_service_1[(_0x3eb22c(0x12f))]({'connection':_0x495111});}async[a361_0x2ae901(0x165)](_0x53f4e2,_0x1d6d3e){const _0x5900a7=a361_0x2ae901;this[_0x5900a7(0x10d)]['log'](_0x5900a7(0x133));const _0x20b3f7={'Body':Buffer[_0x5900a7(0x11f)](_0x53f4e2)[_0x5900a7(0x102)](_0x5900a7(0x147)),'ContentType':_0x5900a7(0x113),'ParentId':this[_0x5900a7(0x121)],'Name':_0x1d6d3e};await this['_connectionSalesforce']['post'](flosum_constants_1['FlosumConstants']['ENDPOINT_UPSERT_RECORD']+_0x5900a7(0x119),_0x20b3f7);}async[a361_0x2ae901(0x167)](){const _0x4be343=a361_0x2ae901;this[_0x4be343(0x10d)][_0x4be343(0x153)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x5180fc]=await this[_0x4be343(0x116)][_0x4be343(0x156)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+'Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x4be343(0x178)]+_0x4be343(0x166)+constants_1[_0x4be343(0x178)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x4be343(0x178)]+_0x4be343(0x137)+this[_0x4be343(0x121)]+_0x4be343(0x174));return new metadata_log_dto_1['MetadataLogDto'](_0x5180fc);}async['retrieveDeploymentResults'](){const _0x5d84be=a361_0x2ae901;this[_0x5d84be(0x10d)][_0x5d84be(0x153)]('Retrieve\x20Deployment\x20Results');const _0x27c704=await new id_deployment_result_retriever_1[(_0x5d84be(0x13d))]({'salesforceService':this[_0x5d84be(0x116)],'value':this['_componentIds']})[_0x5d84be(0x183)]();if(!_0x27c704[_0x5d84be(0x16d)])throw new Error(_0x5d84be(0x14a));return _0x27c704;}async[a361_0x2ae901(0x120)](){const _0x11ec52=a361_0x2ae901;this[_0x11ec52(0x10d)][_0x11ec52(0x153)](_0x11ec52(0x17f));const _0x1ac17e=await this['_salesforceService']['retrieveRecords']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x11ec52(0xfa)]+_0x11ec52(0x103)+flosum_constants_1['FlosumConstants'][_0x11ec52(0x170)]+_0x11ec52(0x174)),_0x347801=await(0x0,fetch_attachments_1[_0x11ec52(0x130)])(this[_0x11ec52(0x169)],[_0x1ac17e[0x0]['Id']]),_0x1ed47e=await(0x0,fetch_attachments_1[_0x11ec52(0x13a)])(_0x347801,this[_0x11ec52(0x169)]);if(!_0x1ed47e[_0x11ec52(0x16d)])throw new Error(_0x11ec52(0x10f));return _0x1ed47e[0x0][_0x11ec52(0x144)][_0x11ec52(0x105)];}async[a361_0x2ae901(0x16b)](_0x288de2){const _0x538cd8=a361_0x2ae901;this['_logger'][_0x538cd8(0x153)](_0x538cd8(0x14b));const _0x1001c5=await this[_0x538cd8(0x120)](),_0x44795b=await new zip_creator_rollback_1[(_0x538cd8(0xfd))]({'rollbackName':this['_metadataLog'][_0x538cd8(0x176)],'backup':_0x1001c5,'deploymentResults':_0x288de2})[_0x538cd8(0x13f)](),_0x1ba20e=this[_0x538cd8(0x15a)]+'/'+(0x0,shortid_1[_0x538cd8(0x188)])()+_0x538cd8(0xfe);return await(0x0,promises_1[_0x538cd8(0x13e)])(_0x1ba20e,_0x44795b),_0x1ba20e;}async[a361_0x2ae901(0x107)](_0x386dcd){const _0x448259=a361_0x2ae901;this['_logger']['log'](_0x448259(0x181));const _0x264cd7=await this[_0x448259(0x101)][_0x448259(0x171)](_0x386dcd),_0x583629=this[_0x448259(0x15a)]+_0x448259(0x177)+_0x386dcd[_0x448259(0x104)](_0x386dcd[_0x448259(0x160)]('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x583629,_0x264cd7),await this[_0x448259(0x101)]['validate'](_0x583629),_0x583629;}['formFlosumDeploymentResults'](_0x53f3c1){const _0x6fe5e1=a361_0x2ae901;return this[_0x6fe5e1(0x10d)][_0x6fe5e1(0x153)](_0x6fe5e1(0x10c)),_0x53f3c1[_0x6fe5e1(0x138)](_0xdaeab5=>{const _0x130ca5=_0x6fe5e1;return this[_0x130ca5(0x10d)]['log'](_0xdaeab5[_0x130ca5(0x111)]+'.'+_0xdaeab5['name']+_0x130ca5(0x11c)+_0xdaeab5[_0x130ca5(0x158)]),{[constants_1[_0x130ca5(0x178)]+'Type__c']:_0x130ca5(0x15e),[constants_1[_0x130ca5(0x178)]+_0x130ca5(0x12b)]:_0xdaeab5['status']===status_enums_1[_0x130ca5(0x123)][_0x130ca5(0x135)]?_0x130ca5(0x162):_0x130ca5(0x106),[constants_1[_0x130ca5(0x178)]+_0x130ca5(0x139)]:_0xdaeab5[_0x130ca5(0x118)],[constants_1[_0x130ca5(0x178)]+_0x130ca5(0xfc)]:_0xdaeab5[_0x130ca5(0x176)],[constants_1[_0x130ca5(0x178)]+_0x130ca5(0x132)]:_0xdaeab5[_0x130ca5(0x111)],[constants_1['FLOSUM_NAMESPACE']+_0x130ca5(0x16e)]:_0xdaeab5[_0x130ca5(0x112)],[constants_1[_0x130ca5(0x178)]+_0x130ca5(0xfb)]:this['_metadataLog']['organizationId'],[constants_1[_0x130ca5(0x178)]+_0x130ca5(0x159)]:this['_metadataLogId']};});}async[a361_0x2ae901(0x10e)](_0x3ea9e1){const _0x172e6a=a361_0x2ae901;this[_0x172e6a(0x10d)][_0x172e6a(0x153)](_0x172e6a(0x12a));const _0x595a06=await this[_0x172e6a(0x116)][_0x172e6a(0x16f)](constants_1[_0x172e6a(0x178)]+'Deployment_Result__c',_0x3ea9e1),_0x560a6b=_0x595a06['filter'](_0xd30d26=>!_0xd30d26[_0x172e6a(0x10b)])[_0x172e6a(0x138)](_0x30ae22=>_0x30ae22[_0x172e6a(0x150)])[_0x172e6a(0x161)]();if(_0x560a6b[_0x172e6a(0x16d)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x560a6b);}async['finishRollbackWithError'](_0x715d30){const _0x502ef8=a361_0x2ae901;if(!this[_0x502ef8(0x10a)]){this[_0x502ef8(0x173)]['error'](_0x715d30);return;}this[_0x502ef8(0x10d)]['logError'](_0x715d30),await this[_0x502ef8(0x10d)]['updateLog'](),await this[_0x502ef8(0x154)](![],!![],'');}async['finishRollback'](_0x482441,_0x5115bc,_0x35b0d0){const _0x32f2e8=a361_0x2ae901,{id:_0x7a5ba0,organizationId:_0x53d517,branchId:_0xa760b2,organizationName:_0x5f5a74}=this['_metadataLog'],_0xd4f15=_0x32f2e8(0xf7)+this['_instanceUrl']+'/'+_0x7a5ba0+_0x32f2e8(0x117)+_0x32f2e8(0x175)+_0x32f2e8(0x122),_0x5a5186=_0x32f2e8(0xf7)+this['_instanceUrl']+'/'+_0x53d517+'\x20>'+_0x5f5a74+_0x32f2e8(0x115),_0xbf4907=_0xd4f15+_0x32f2e8(0x15f)+_0x5a5186+_0x32f2e8(0x182),_0x278620={[constants_1[_0x32f2e8(0x178)]+_0x32f2e8(0x155)]:_0xbf4907,[constants_1['FLOSUM_NAMESPACE']+_0x32f2e8(0x13c)]:new Date(),[constants_1[_0x32f2e8(0x178)]+_0x32f2e8(0x16c)]:_0xa760b2,[constants_1[_0x32f2e8(0x178)]+_0x32f2e8(0x140)]:'Branch',[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0x32f2e8(0x11e),[constants_1[_0x32f2e8(0x178)]+_0x32f2e8(0x157)]:_0x53d517},_0x450e4d={[constants_1[_0x32f2e8(0x178)]+_0x32f2e8(0x186)]:!_0x482441,[constants_1['FLOSUM_NAMESPACE']+_0x32f2e8(0x17b)]:_0x482441,[constants_1[_0x32f2e8(0x178)]+_0x32f2e8(0x12b)]:_0x5115bc?status_enums_1[_0x32f2e8(0x17c)][_0x32f2e8(0xf6)]:status_enums_1['MetadataLogStatus'][_0x32f2e8(0x131)],[constants_1['FLOSUM_NAMESPACE']+_0x32f2e8(0x17d)]:!![],[constants_1[_0x32f2e8(0x178)]+_0x32f2e8(0x136)]:_0x35b0d0};await this[_0x32f2e8(0x169)]['patch'](flosum_constants_1[_0x32f2e8(0x109)][_0x32f2e8(0x149)]+'/'+constants_1[_0x32f2e8(0x178)]+'Metadata_Log__c/'+this[_0x32f2e8(0x121)],_0x450e4d),await this['_connectionSalesforce']['post'](flosum_constants_1['FlosumConstants'][_0x32f2e8(0x149)]+'/'+constants_1['FLOSUM_NAMESPACE']+'Log__c',_0x278620),this[_0x32f2e8(0x10d)][_0x32f2e8(0x153)]('Rollback\x20completed\x20'+(_0x482441?_0x32f2e8(0x108):'with\x20error')+'.'),await this[_0x32f2e8(0x10d)][_0x32f2e8(0x185)]();}async[a361_0x2ae901(0x142)](){const _0x3daa1b=a361_0x2ae901;try{this[_0x3daa1b(0x10a)]=await this[_0x3daa1b(0x167)]();const _0x13dfb2=await this['retrieveDeploymentResults']();await this[_0x3daa1b(0x10d)][_0x3daa1b(0x185)]();const _0x6723f=await this[_0x3daa1b(0x16b)](_0x13dfb2),_0x4870fa=await this[_0x3daa1b(0x107)](_0x6723f);await this[_0x3daa1b(0x10d)]['updateLog']();const _0x206107=await this[_0x3daa1b(0x16a)]['import'](_0x4870fa);await this[_0x3daa1b(0x10d)][_0x3daa1b(0x185)]();const _0x1ead57=this[_0x3daa1b(0x148)](_0x206107[_0x3daa1b(0x146)]);await this['saveDeploymentResults'](_0x1ead57),await this['finishRollback'](_0x206107[_0x3daa1b(0x110)],![],_0x206107[_0x3daa1b(0x129)]);}catch(_0x25e639){await this['finishRollbackWithError'](_0x25e639)[_0x3daa1b(0x151)](_0x3c3a66=>this[_0x3daa1b(0x173)][_0x3daa1b(0x14c)](_0x3c3a66));}}}exports['RollbackService']=RollbackService;