const a405_0x19b0d=a405_0x9f65;(function(_0x27fd04,_0x3b414e){const _0x4427f2=a405_0x9f65,_0x550e91=_0x27fd04();while(!![]){try{const _0x55e694=-parseInt(_0x4427f2(0x1d3))/0x1+parseInt(_0x4427f2(0x1c1))/0x2*(parseInt(_0x4427f2(0x21a))/0x3)+parseInt(_0x4427f2(0x1ea))/0x4+parseInt(_0x4427f2(0x220))/0x5+-parseInt(_0x4427f2(0x20d))/0x6+parseInt(_0x4427f2(0x1aa))/0x7*(-parseInt(_0x4427f2(0x1c3))/0x8)+-parseInt(_0x4427f2(0x1f7))/0x9*(-parseInt(_0x4427f2(0x22d))/0xa);if(_0x55e694===_0x3b414e)break;else _0x550e91['push'](_0x550e91['shift']());}catch(_0x50ac06){_0x550e91['push'](_0x550e91['shift']());}}}(a405_0x4800,0x8a630));const a405_0xcf22d3=(function(){let _0x2dd9f6=!![];return function(_0x2bbc8e,_0x4ec9e5){const _0x2e19e5=_0x2dd9f6?function(){const _0x479972=a405_0x9f65;if(_0x4ec9e5){const _0x19177b=_0x4ec9e5[_0x479972(0x1f8)](_0x2bbc8e,arguments);return _0x4ec9e5=null,_0x19177b;}}:function(){};return _0x2dd9f6=![],_0x2e19e5;};}()),a405_0x34a2e7=a405_0xcf22d3(this,function(){const _0x32ee40=a405_0x9f65;return a405_0x34a2e7[_0x32ee40(0x1f3)]()[_0x32ee40(0x1f5)](_0x32ee40(0x216))[_0x32ee40(0x1f3)]()[_0x32ee40(0x1cf)](a405_0x34a2e7)[_0x32ee40(0x1f5)](_0x32ee40(0x216));});a405_0x34a2e7();function a405_0x9f65(_0xeb292d,_0x2294af){const _0x4bb084=a405_0x4800();return a405_0x9f65=function(_0x34a2e7,_0xcf22d3){_0x34a2e7=_0x34a2e7-0x1a9;let _0x48005a=_0x4bb084[_0x34a2e7];return _0x48005a;},a405_0x9f65(_0xeb292d,_0x2294af);}function a405_0x4800(){const _0x359940=['constructor','ENDPOINT_UPSERT_RECORD','updateLog','Failure','555378qHJuXX','deploymentAction','Activity_Item__c','VeevaService','from','execute','logError','FLOSUM_NAMESPACE','_packageImportService','stepName','retrieveMetadataLog','Logger','filter','../classes/errors/salesforce-dml-error','writeFile','Create\x20Vpk\x20package','BACKUP_ZIP_NAME','organizationId','\x20has\x20been\x20created.','COMPLETED','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','fetchAttachmentsDetailsById','Body','1527076sIcBDT','map','FlosumConstants','MetadataLogStatus','DEPLOYED','\x20</a>','_metadataLogId','text/plain','retrieveRecords','toString','_logger','search','createVpk','9SIYHjd','apply','../dtos/metadata-log.dto','Branch','Deployment_Result__c','error','flat','retrieveBackup','<a\x20href=','Cannot\x20find\x20Backup\x20Zip','Metadata_Log__c/','post','_parentMetadataLogId','Create\x20zip\x20from\x20backup','Log__c','./package-import.service','Job_Completed__c','_tempFolder','VpkService','finishRollbackWithError','Success','insertMultipleRecords','2359410DUmJhk','saveLog','Succeed__c','name','_connectionVeeva','_metadataLog','_instanceUrl','catch','bind','(((.+)+)+)+$','Org__c','base64','PackageComponentStatus','1124178lnEXjB','/Attachment','__esModule','.zip','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Veeva\x20Rollback\x20(Deployment)','3923225azoXgy','default','saveDeploymentResults','_salesforceService','Retrieve\x20Backup','../classes/rollback/zip-creator.rollback','Form\x20Deployment\x20Results','Cannot\x20find\x20Deployment\x20Results','formFlosumDeploymentResults','Component_Type__c','/vpk__','IdDeploymentResultRetriever','retrieveAttachments','524750rKGaLU','createZip','\x27\x20AND\x20Name\x20=\x20\x27','import','./veeva.service','status','_connectionSalesforce','Deployment','retrieveDeploymentResults','finishRollback','_timeZone','PackageImportService','Retrieve\x20Deployment\x20Results','7yNCRVb','generate','_veevaService','EXCEPTION','success','Save\x20log','MetadataLogDto','log','Deployment\x20Result','TargetId__c','RollbackService','patch','retrieve','../classes/retrievers/deployment-results/id.deployment-result.retriever','Veeva_Step_Name__c','../../../core','Status__c','errors','./vpk.service','Action__c','SalesforceService','Branch__c','_vpkService','4RPeSHj','create','3623168hkGJlQ','../../shared/utils/fetch-attachments','slice','_componentIds','ZipCreatorRollback','length','shortid','_systemLogger','Is_Error__c','Metadata_Log__c','fs/promises','\x20>\x20'];a405_0x4800=function(){return _0x359940;};return a405_0x4800();}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x30457f){const _0x5c9493=a405_0x9f65;return _0x30457f&&_0x30457f[_0x5c9493(0x21c)]?_0x30457f:{'default':_0x30457f};};Object['defineProperty'](exports,a405_0x19b0d(0x21c),{'value':!![]}),exports[a405_0x19b0d(0x1b4)]=void 0x0;const veeva_service_1=require(a405_0x19b0d(0x231)),salesforce_service_1=require('./salesforce.service'),package_import_service_1=require(a405_0x19b0d(0x206)),id_deployment_result_retriever_1=require(a405_0x19b0d(0x1b7)),flosum_constants_1=require('../constants/flosum.constants'),fetch_attachments_1=require(a405_0x19b0d(0x1c4)),constants_1=require('../../../constants'),zip_creator_rollback_1=require(a405_0x19b0d(0x225)),shortid_1=__importDefault(require(a405_0x19b0d(0x1c9))),promises_1=require(a405_0x19b0d(0x1cd)),vpk_service_1=require(a405_0x19b0d(0x1bc)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require(a405_0x19b0d(0x1e0)),metadata_log_dto_1=require(a405_0x19b0d(0x1f9)),core_1=require(a405_0x19b0d(0x1b9));class RollbackService{constructor({connectionSalesforce:_0x426e59,connectionVeeva:_0x4284f0,logger:_0x2cf5f2,tempFolder:_0x3aa028,instanceUrl:_0x1404ed,timeZone:_0xa240e4,metadataLogId:_0x20c7f0,attachmentLogId:_0x2e6caf,parentMetadataLogId:_0x47d589,componentIds:_0x5f1de0}){const _0x8cde13=a405_0x19b0d;this[_0x8cde13(0x233)]=_0x426e59,this[_0x8cde13(0x211)]=_0x4284f0,this[_0x8cde13(0x1f4)]=_0x2cf5f2,this['_tempFolder']=_0x3aa028,this[_0x8cde13(0x213)]=_0x1404ed,this[_0x8cde13(0x237)]=_0xa240e4,this[_0x8cde13(0x1f0)]=_0x20c7f0,this['_attachmentLogId']=_0x2e6caf,this[_0x8cde13(0x203)]=_0x47d589,this[_0x8cde13(0x1c6)]=_0x5f1de0,this[_0x8cde13(0x1ca)]=new core_1[(_0x8cde13(0x1de))]('veeva-rollback'),this[_0x8cde13(0x1ac)]=new veeva_service_1[(_0x8cde13(0x1d6))]({'connection':_0x4284f0,'logger':_0x2cf5f2}),this['_salesforceService']=new salesforce_service_1[(_0x8cde13(0x1be))]({'connection':_0x426e59}),this['_packageImportService']=new package_import_service_1[(_0x8cde13(0x238))]({'veevaService':this[_0x8cde13(0x1ac)],'connection':_0x4284f0,'logger':_0x2cf5f2,'saveLog':this[_0x8cde13(0x20e)][_0x8cde13(0x215)](this)}),this[_0x8cde13(0x1c0)]=new vpk_service_1[(_0x8cde13(0x209))]({'connection':_0x4284f0});}async[a405_0x19b0d(0x20e)](_0x46e1ad,_0x592787){const _0x4a9c47=a405_0x19b0d;this[_0x4a9c47(0x1f4)][_0x4a9c47(0x1b1)](_0x4a9c47(0x1af));const _0x47da85={'Body':Buffer[_0x4a9c47(0x1d7)](_0x46e1ad)['toString'](_0x4a9c47(0x218)),'ContentType':_0x4a9c47(0x1f1),'ParentId':this['_metadataLogId'],'Name':_0x592787};await this[_0x4a9c47(0x233)][_0x4a9c47(0x202)](flosum_constants_1['FlosumConstants'][_0x4a9c47(0x1d0)]+_0x4a9c47(0x21b),_0x47da85);}async[a405_0x19b0d(0x1dd)](){const _0x7b85da=a405_0x19b0d;this[_0x7b85da(0x1f4)][_0x7b85da(0x1b1)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x2a5646]=await this['_salesforceService'][_0x7b85da(0x1f2)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1[_0x7b85da(0x1da)]+_0x7b85da(0x1e7)+constants_1[_0x7b85da(0x1da)]+_0x7b85da(0x21e)+constants_1[_0x7b85da(0x1da)]+'Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20'+constants_1[_0x7b85da(0x1da)]+'Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27'+this[_0x7b85da(0x1f0)]+'\x27\x0a\x20\x20\x20\x20');return new metadata_log_dto_1[(_0x7b85da(0x1b0))](_0x2a5646);}async[a405_0x19b0d(0x235)](){const _0x5182b9=a405_0x19b0d;this[_0x5182b9(0x1f4)]['log'](_0x5182b9(0x1a9));const _0x5b8107=await new id_deployment_result_retriever_1[(_0x5182b9(0x22b))]({'salesforceService':this[_0x5182b9(0x223)],'value':this[_0x5182b9(0x1c6)]})[_0x5182b9(0x1b6)]();if(!_0x5b8107[_0x5182b9(0x1c8)])throw new Error(_0x5182b9(0x227));return _0x5b8107;}async[a405_0x19b0d(0x1fe)](){const _0x3568bc=a405_0x19b0d;this[_0x3568bc(0x1f4)][_0x3568bc(0x1b1)](_0x3568bc(0x224));const _0x919462=await this['_salesforceService'][_0x3568bc(0x1f2)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x3568bc(0x203)]+_0x3568bc(0x22f)+flosum_constants_1[_0x3568bc(0x1ec)][_0x3568bc(0x1e3)]+'\x27\x0a\x20\x20\x20\x20'),_0x133f77=await(0x0,fetch_attachments_1[_0x3568bc(0x1e8)])(this[_0x3568bc(0x233)],[_0x919462[0x0]['Id']]),_0x4872cb=await(0x0,fetch_attachments_1[_0x3568bc(0x22c)])(_0x133f77,this['_connectionSalesforce']);if(!_0x4872cb[_0x3568bc(0x1c8)])throw new Error(_0x3568bc(0x200));return _0x4872cb[0x0]['values'][_0x3568bc(0x1e9)];}async[a405_0x19b0d(0x22e)](_0x3775ef){const _0x5415f9=a405_0x19b0d;this['_logger']['log'](_0x5415f9(0x204));const _0x507542=await this[_0x5415f9(0x1fe)](),_0x1865be=await new zip_creator_rollback_1[(_0x5415f9(0x1c7))]({'rollbackName':this[_0x5415f9(0x212)][_0x5415f9(0x210)],'backup':_0x507542,'deploymentResults':_0x3775ef})[_0x5415f9(0x1c2)](),_0x5d78e4=this[_0x5415f9(0x208)]+'/'+(0x0,shortid_1[_0x5415f9(0x221)])()+_0x5415f9(0x21d);return await(0x0,promises_1[_0x5415f9(0x1e1)])(_0x5d78e4,_0x1865be),_0x5d78e4;}async[a405_0x19b0d(0x1f6)](_0x49f80f){const _0x593801=a405_0x19b0d;this[_0x593801(0x1f4)][_0x593801(0x1b1)](_0x593801(0x1e2));const _0x3ff75e=await this[_0x593801(0x1c0)][_0x593801(0x1ab)](_0x49f80f),_0x28e486=this[_0x593801(0x208)]+_0x593801(0x22a)+_0x49f80f[_0x593801(0x1c5)](_0x49f80f['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x28e486,_0x3ff75e),await this[_0x593801(0x1c0)]['validate'](_0x28e486),_0x28e486;}[a405_0x19b0d(0x228)](_0x10ec8e){const _0x5b783f=a405_0x19b0d;return this[_0x5b783f(0x1f4)][_0x5b783f(0x1b1)](_0x5b783f(0x226)),_0x10ec8e[_0x5b783f(0x1eb)](_0x56d633=>{const _0x55594c=_0x5b783f;return this[_0x55594c(0x1f4)][_0x55594c(0x1b1)](_0x56d633['type']+'.'+_0x56d633['name']+'\x20:\x20'+_0x56d633[_0x55594c(0x232)]),{[constants_1['FLOSUM_NAMESPACE']+'Type__c']:_0x55594c(0x1b2),[constants_1[_0x55594c(0x1da)]+_0x55594c(0x1ba)]:_0x56d633[_0x55594c(0x232)]===status_enums_1[_0x55594c(0x219)][_0x55594c(0x1ee)]?_0x55594c(0x20b):_0x55594c(0x1d2),[constants_1[_0x55594c(0x1da)]+'Result__c']:_0x56d633[_0x55594c(0x1d4)],[constants_1[_0x55594c(0x1da)]+'Component_Name__c']:_0x56d633[_0x55594c(0x210)],[constants_1[_0x55594c(0x1da)]+_0x55594c(0x229)]:_0x56d633['type'],[constants_1[_0x55594c(0x1da)]+_0x55594c(0x1b8)]:_0x56d633[_0x55594c(0x1dc)],[constants_1[_0x55594c(0x1da)]+_0x55594c(0x217)]:this[_0x55594c(0x212)][_0x55594c(0x1e4)],[constants_1[_0x55594c(0x1da)]+_0x55594c(0x1cc)]:this[_0x55594c(0x1f0)]};});}async[a405_0x19b0d(0x222)](_0x4bb733){const _0x3dd5e2=a405_0x19b0d;this[_0x3dd5e2(0x1f4)][_0x3dd5e2(0x1b1)]('Save\x20Deployment\x20Results');const _0x4936d8=await this[_0x3dd5e2(0x223)][_0x3dd5e2(0x20c)](constants_1[_0x3dd5e2(0x1da)]+_0x3dd5e2(0x1fb),_0x4bb733),_0x10762a=_0x4936d8[_0x3dd5e2(0x1df)](_0x37a79e=>!_0x37a79e[_0x3dd5e2(0x1ae)])[_0x3dd5e2(0x1eb)](_0x307399=>_0x307399[_0x3dd5e2(0x1bb)])[_0x3dd5e2(0x1fd)]();if(_0x10762a[_0x3dd5e2(0x1c8)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x10762a);}async[a405_0x19b0d(0x20a)](_0x29789f){const _0x51ec14=a405_0x19b0d;if(!this[_0x51ec14(0x212)]){this['_systemLogger'][_0x51ec14(0x1fc)](_0x29789f);return;}this[_0x51ec14(0x1f4)][_0x51ec14(0x1d9)](_0x29789f),await this['_logger']['updateLog'](),await this[_0x51ec14(0x236)](![],!![],'');}async[a405_0x19b0d(0x236)](_0x565f36,_0x301c05,_0x3b3264){const _0x4ffa2c=a405_0x19b0d,{id:_0x23ca4,organizationId:_0x12f734,branchId:_0x42acb4,organizationName:_0x5b357f}=this[_0x4ffa2c(0x212)],_0x455813=_0x4ffa2c(0x1ff)+this['_instanceUrl']+'/'+_0x23ca4+_0x4ffa2c(0x1ce)+_0x4ffa2c(0x21f)+_0x4ffa2c(0x1ef),_0x2219fa=_0x4ffa2c(0x1ff)+this['_instanceUrl']+'/'+_0x12f734+'\x20>'+_0x5b357f+'</a>',_0x2065b0=_0x455813+'\x20of\x20branch\x20to\x20Organization\x20'+_0x2219fa+_0x4ffa2c(0x1e5),_0x2e3644={[constants_1['FLOSUM_NAMESPACE']+_0x4ffa2c(0x1bd)]:_0x2065b0,[constants_1['FLOSUM_NAMESPACE']+'Date__c']:new Date(),[constants_1['FLOSUM_NAMESPACE']+_0x4ffa2c(0x1bf)]:_0x42acb4,[constants_1[_0x4ffa2c(0x1da)]+_0x4ffa2c(0x1d5)]:_0x4ffa2c(0x1fa),[constants_1['FLOSUM_NAMESPACE']+'Activity_Type__c']:_0x4ffa2c(0x234),[constants_1[_0x4ffa2c(0x1da)]+_0x4ffa2c(0x1b3)]:_0x12f734},_0x181583={[constants_1['FLOSUM_NAMESPACE']+_0x4ffa2c(0x1cb)]:!_0x565f36,[constants_1[_0x4ffa2c(0x1da)]+_0x4ffa2c(0x20f)]:_0x565f36,[constants_1['FLOSUM_NAMESPACE']+_0x4ffa2c(0x1ba)]:_0x301c05?status_enums_1[_0x4ffa2c(0x1ed)][_0x4ffa2c(0x1ad)]:status_enums_1[_0x4ffa2c(0x1ed)][_0x4ffa2c(0x1e6)],[constants_1['FLOSUM_NAMESPACE']+_0x4ffa2c(0x207)]:!![],[constants_1[_0x4ffa2c(0x1da)]+'External_Deployment_Id__c']:_0x3b3264};await this[_0x4ffa2c(0x233)][_0x4ffa2c(0x1b5)](flosum_constants_1[_0x4ffa2c(0x1ec)][_0x4ffa2c(0x1d0)]+'/'+constants_1['FLOSUM_NAMESPACE']+_0x4ffa2c(0x201)+this[_0x4ffa2c(0x1f0)],_0x181583),await this[_0x4ffa2c(0x233)][_0x4ffa2c(0x202)](flosum_constants_1[_0x4ffa2c(0x1ec)]['ENDPOINT_UPSERT_RECORD']+'/'+constants_1[_0x4ffa2c(0x1da)]+_0x4ffa2c(0x205),_0x2e3644),this[_0x4ffa2c(0x1f4)]['log']('Rollback\x20completed\x20'+(_0x565f36?'successfully':'with\x20error')+'.'),await this[_0x4ffa2c(0x1f4)][_0x4ffa2c(0x1d1)]();}async[a405_0x19b0d(0x1d8)](){const _0xfddcf1=a405_0x19b0d;try{this['_metadataLog']=await this[_0xfddcf1(0x1dd)]();const _0x30a14b=await this['retrieveDeploymentResults']();await this[_0xfddcf1(0x1f4)]['updateLog']();const _0x632fda=await this[_0xfddcf1(0x22e)](_0x30a14b),_0x4edc80=await this['createVpk'](_0x632fda);await this[_0xfddcf1(0x1f4)][_0xfddcf1(0x1d1)]();const _0x4aa940=await this[_0xfddcf1(0x1db)][_0xfddcf1(0x230)](_0x4edc80);await this[_0xfddcf1(0x1f4)][_0xfddcf1(0x1d1)]();const _0x155f19=this[_0xfddcf1(0x228)](_0x4aa940['packageComponentList']);await this['saveDeploymentResults'](_0x155f19),await this[_0xfddcf1(0x236)](_0x4aa940['isDeployed'],![],_0x4aa940['packageId']);}catch(_0x2f0114){await this['finishRollbackWithError'](_0x2f0114)[_0xfddcf1(0x214)](_0x5a272e=>this[_0xfddcf1(0x1ca)][_0xfddcf1(0x1fc)](_0x5a272e));}}}exports['RollbackService']=RollbackService;