const a376_0x516b33=a376_0x1fd0;(function(_0x217d3d,_0xaf2818){const _0x348f03=a376_0x1fd0,_0x29d240=_0x217d3d();while(!![]){try{const _0x352465=parseInt(_0x348f03(0xf4))/0x1*(parseInt(_0x348f03(0x118))/0x2)+parseInt(_0x348f03(0x131))/0x3+-parseInt(_0x348f03(0x128))/0x4+-parseInt(_0x348f03(0x10a))/0x5*(parseInt(_0x348f03(0x113))/0x6)+parseInt(_0x348f03(0x111))/0x7*(parseInt(_0x348f03(0x13d))/0x8)+-parseInt(_0x348f03(0xe3))/0x9*(-parseInt(_0x348f03(0x150))/0xa)+parseInt(_0x348f03(0x130))/0xb*(-parseInt(_0x348f03(0x105))/0xc);if(_0x352465===_0xaf2818)break;else _0x29d240['push'](_0x29d240['shift']());}catch(_0x14808f){_0x29d240['push'](_0x29d240['shift']());}}}(a376_0xd78c,0xcc0d6));const a376_0x1a94ba=(function(){let _0x2c6d06=!![];return function(_0x62d23,_0x1a0ad1){const _0x1c3072=_0x2c6d06?function(){const _0x219cb9=a376_0x1fd0;if(_0x1a0ad1){const _0x472fbd=_0x1a0ad1[_0x219cb9(0xed)](_0x62d23,arguments);return _0x1a0ad1=null,_0x472fbd;}}:function(){};return _0x2c6d06=![],_0x1c3072;};}()),a376_0x40155b=a376_0x1a94ba(this,function(){const _0x7a7944=a376_0x1fd0;return a376_0x40155b['toString']()['search'](_0x7a7944(0x15a))[_0x7a7944(0x116)]()[_0x7a7944(0x148)](a376_0x40155b)['search'](_0x7a7944(0x15a));});a376_0x40155b();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x358702){const _0x18e4b2=a376_0x1fd0;return _0x358702&&_0x358702[_0x18e4b2(0x156)]?_0x358702:{'default':_0x358702};};function a376_0x1fd0(_0x367ce1,_0x8a55a0){const _0x1eeb16=a376_0xd78c();return a376_0x1fd0=function(_0x40155b,_0x1a94ba){_0x40155b=_0x40155b-0xd4;let _0xd78cfc=_0x1eeb16[_0x40155b];return _0xd78cfc;},a376_0x1fd0(_0x367ce1,_0x8a55a0);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a376_0x516b33(0x134)]=void 0x0;function a376_0xd78c(){const _0x5c5b63=['_packageImportService','_tempFolder','Branch__c\x0a\x20\x20\x20\x20\x20\x20FROM\x20','Action__c','finishRollback','424hyNDzd','External_Deployment_Id__c','VeevaService','_componentIds','Activity_Type__c','FLOSUM_NAMESPACE','Veeva_Step_Name__c','Deployment','BACKUP_ZIP_NAME','createVpk','type','constructor','organizationId','Retrieve\x20Backup','status','saveLog','Rollback\x20completed\x20','./package-import.service','createZip','16054020QMUPvt','Create\x20zip\x20from\x20backup','validate','formFlosumDeploymentResults','Job_Completed__c','Body','__esModule','Component_Type__c','Cannot\x20find\x20Deployment\x20Results','Deployment\x20Result','(((.+)+)+)+$','map','catch','retrieveRecords','_metadataLog','Organisation__r.Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','./salesforce.service','Veeva\x20Rollback\x20(Deployment)','updateLog','Form\x20Deployment\x20Results','name','_connectionSalesforce','Create\x20Vpk\x20package','IdDeploymentResultRetriever','saveDeploymentResults','../classes/rollback/zip-creator.rollback','\x27\x0a\x20\x20\x20\x20','MetadataLogDto','Activity_Item__c','_salesforceService','create','Metadata_Log__c','Save\x20Deployment\x20Results','9ghLsGL','EXCEPTION','FlosumConstants','writeFile','_veevaService','_vpkService','logError','patch','COMPLETED','retrieve','apply','successfully','flat','stepName','\x20>\x20','error','_timeZone','5663wbuvri','Result__c','Organisation__c,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','SalesforceService','\x20:\x20','./vpk.service','ENDPOINT_UPSERT_RECORD','text/plain','../../../core','_instanceUrl','packageComponentList','with\x20error','Branch__c','fetchAttachmentsDetailsById','../dtos/metadata-log.dto','../constants/flosum.constants','_systemLogger','144fwVtoH','length','Type__c','log','errors','1692035EyFHiU','veeva-rollback','success','/vpk__','deploymentAction','finishRollbackWithError','/Attachment','11053CwISbl','base64','6uuecxM','shortid','.zip','toString','generate','146GlrpzX','MetadataLogStatus','_parentMetadataLogId','filter','_connectionVeeva','DEPLOYED','Save\x20log','post','Date__c','from','_logger','default','_metadataLogId','Cannot\x20find\x20Backup\x20Zip','Log__c','Branch','3338640yIsDfi','Metadata_Log__c\x0a\x20\x20\x20\x20\x20\x20WHERE\x20Id\x20=\x20\x27','\x20of\x20branch\x20to\x20Organization\x20','retrieveBackup','slice','execute','../../shared/utils/fetch-attachments','</a>','142373hQfIuo','185079dKMMpY','TargetId__c','../../../constants','RollbackService','\x20has\x20been\x20created.','retrieveDeploymentResults','Succeed__c'];a376_0xd78c=function(){return _0x5c5b63;};return a376_0xd78c();}const veeva_service_1=require('./veeva.service'),salesforce_service_1=require(a376_0x516b33(0x160)),package_import_service_1=require(a376_0x516b33(0x14e)),id_deployment_result_retriever_1=require('../classes/retrievers/deployment-results/id.deployment-result.retriever'),flosum_constants_1=require(a376_0x516b33(0x103)),fetch_attachments_1=require(a376_0x516b33(0x12e)),constants_1=require(a376_0x516b33(0x133)),zip_creator_rollback_1=require(a376_0x516b33(0xdb)),shortid_1=__importDefault(require(a376_0x516b33(0x114))),promises_1=require('fs/promises'),vpk_service_1=require(a376_0x516b33(0xf9)),status_enums_1=require('../enums/status.enums'),salesforce_dml_error_1=require('../classes/errors/salesforce-dml-error'),metadata_log_dto_1=require(a376_0x516b33(0x102)),core_1=require(a376_0x516b33(0xfc));class RollbackService{constructor({connectionSalesforce:_0x520d15,connectionVeeva:_0xedf2ca,logger:_0x3576d1,tempFolder:_0x8ebe70,instanceUrl:_0x20c6d1,timeZone:_0x153214,metadataLogId:_0x54b826,attachmentLogId:_0x585636,parentMetadataLogId:_0x229eac,componentIds:_0x5f14ac}){const _0x19bc65=a376_0x516b33;this[_0x19bc65(0xd7)]=_0x520d15,this[_0x19bc65(0x11c)]=_0xedf2ca,this[_0x19bc65(0x122)]=_0x3576d1,this['_tempFolder']=_0x8ebe70,this[_0x19bc65(0xfd)]=_0x20c6d1,this[_0x19bc65(0xf3)]=_0x153214,this[_0x19bc65(0x124)]=_0x54b826,this['_attachmentLogId']=_0x585636,this['_parentMetadataLogId']=_0x229eac,this[_0x19bc65(0x140)]=_0x5f14ac,this[_0x19bc65(0x104)]=new core_1['Logger'](_0x19bc65(0x10b)),this[_0x19bc65(0xe7)]=new veeva_service_1[(_0x19bc65(0x13f))]({'connection':_0xedf2ca,'logger':_0x3576d1}),this[_0x19bc65(0xdf)]=new salesforce_service_1[(_0x19bc65(0xf7))]({'connection':_0x520d15}),this[_0x19bc65(0x138)]=new package_import_service_1['PackageImportService']({'veevaService':this[_0x19bc65(0xe7)],'connection':_0xedf2ca,'logger':_0x3576d1,'saveLog':this[_0x19bc65(0x14c)]['bind'](this)}),this[_0x19bc65(0xe8)]=new vpk_service_1['VpkService']({'connection':_0xedf2ca});}async[a376_0x516b33(0x14c)](_0x43fdc3,_0x3eb9a2){const _0x3219a5=a376_0x516b33;this[_0x3219a5(0x122)][_0x3219a5(0x108)](_0x3219a5(0x11e));const _0x549555={'Body':Buffer[_0x3219a5(0x121)](_0x43fdc3)[_0x3219a5(0x116)](_0x3219a5(0x112)),'ContentType':_0x3219a5(0xfb),'ParentId':this['_metadataLogId'],'Name':_0x3eb9a2};await this[_0x3219a5(0xd7)][_0x3219a5(0x11f)](flosum_constants_1[_0x3219a5(0xe5)][_0x3219a5(0xfa)]+_0x3219a5(0x110),_0x549555);}async['retrieveMetadataLog'](){const _0x314aaa=a376_0x516b33;this[_0x314aaa(0x122)][_0x314aaa(0x108)]('Retrieve\x20Metadata\x20Log\x20info');const [_0x20a0f6]=await this[_0x314aaa(0xdf)][_0x314aaa(0x15d)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Id,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20Name,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+constants_1['FLOSUM_NAMESPACE']+_0x314aaa(0xf6)+constants_1['FLOSUM_NAMESPACE']+_0x314aaa(0x15f)+constants_1[_0x314aaa(0x142)]+_0x314aaa(0x13a)+constants_1[_0x314aaa(0x142)]+_0x314aaa(0x129)+this['_metadataLogId']+_0x314aaa(0xdc));return new metadata_log_dto_1[(_0x314aaa(0xdd))](_0x20a0f6);}async[a376_0x516b33(0x136)](){const _0xc93fa7=a376_0x516b33;this[_0xc93fa7(0x122)]['log']('Retrieve\x20Deployment\x20Results');const _0x20047a=await new id_deployment_result_retriever_1[(_0xc93fa7(0xd9))]({'salesforceService':this[_0xc93fa7(0xdf)],'value':this[_0xc93fa7(0x140)]})[_0xc93fa7(0xec)]();if(!_0x20047a[_0xc93fa7(0x106)])throw new Error(_0xc93fa7(0x158));return _0x20047a;}async['retrieveBackup'](){const _0x5de6d6=a376_0x516b33;this[_0x5de6d6(0x122)][_0x5de6d6(0x108)](_0x5de6d6(0x14a));const _0x218397=await this[_0x5de6d6(0xdf)][_0x5de6d6(0x15d)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20Id\x0a\x20\x20\x20\x20\x20\x20FROM\x20Attachment\x0a\x20\x20\x20\x20\x20\x20WHERE\x20ParentId\x20=\x20\x27'+this[_0x5de6d6(0x11a)]+'\x27\x20AND\x20Name\x20=\x20\x27'+flosum_constants_1[_0x5de6d6(0xe5)][_0x5de6d6(0x145)]+_0x5de6d6(0xdc)),_0x47be07=await(0x0,fetch_attachments_1[_0x5de6d6(0x101)])(this['_connectionSalesforce'],[_0x218397[0x0]['Id']]),_0x7e79b0=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x47be07,this[_0x5de6d6(0xd7)]);if(!_0x7e79b0['length'])throw new Error(_0x5de6d6(0x125));return _0x7e79b0[0x0]['values'][_0x5de6d6(0x155)];}async[a376_0x516b33(0x14f)](_0x2522d5){const _0x50ce99=a376_0x516b33;this[_0x50ce99(0x122)][_0x50ce99(0x108)](_0x50ce99(0x151));const _0x1d4dd3=await this[_0x50ce99(0x12b)](),_0x472fec=await new zip_creator_rollback_1['ZipCreatorRollback']({'rollbackName':this['_metadataLog']['name'],'backup':_0x1d4dd3,'deploymentResults':_0x2522d5})[_0x50ce99(0xe0)](),_0x578e57=this[_0x50ce99(0x139)]+'/'+(0x0,shortid_1[_0x50ce99(0x123)])()+_0x50ce99(0x115);return await(0x0,promises_1[_0x50ce99(0xe6)])(_0x578e57,_0x472fec),_0x578e57;}async[a376_0x516b33(0x146)](_0x5bc4c2){const _0x4aa76e=a376_0x516b33;this[_0x4aa76e(0x122)][_0x4aa76e(0x108)](_0x4aa76e(0xd8));const _0x57fc94=await this['_vpkService'][_0x4aa76e(0x117)](_0x5bc4c2),_0x24e9fd=this[_0x4aa76e(0x139)]+_0x4aa76e(0x10d)+_0x5bc4c2[_0x4aa76e(0x12c)](_0x5bc4c2['lastIndexOf']('/')+0x1);return await(0x0,promises_1['writeFile'])(_0x24e9fd,_0x57fc94),await this[_0x4aa76e(0xe8)][_0x4aa76e(0x152)](_0x24e9fd),_0x24e9fd;}[a376_0x516b33(0x153)](_0xa42f59){const _0x4da21f=a376_0x516b33;return this[_0x4da21f(0x122)][_0x4da21f(0x108)](_0x4da21f(0xd5)),_0xa42f59[_0x4da21f(0x15b)](_0x4da1f5=>{const _0x452f8b=_0x4da21f;return this[_0x452f8b(0x122)][_0x452f8b(0x108)](_0x4da1f5[_0x452f8b(0x147)]+'.'+_0x4da1f5[_0x452f8b(0xd6)]+_0x452f8b(0xf8)+_0x4da1f5[_0x452f8b(0x14b)]),{[constants_1[_0x452f8b(0x142)]+_0x452f8b(0x107)]:_0x452f8b(0x159),[constants_1[_0x452f8b(0x142)]+'Status__c']:_0x4da1f5[_0x452f8b(0x14b)]===status_enums_1['PackageComponentStatus'][_0x452f8b(0x11d)]?'Success':'Failure',[constants_1[_0x452f8b(0x142)]+_0x452f8b(0xf5)]:_0x4da1f5[_0x452f8b(0x10e)],[constants_1['FLOSUM_NAMESPACE']+'Component_Name__c']:_0x4da1f5[_0x452f8b(0xd6)],[constants_1['FLOSUM_NAMESPACE']+_0x452f8b(0x157)]:_0x4da1f5['type'],[constants_1[_0x452f8b(0x142)]+_0x452f8b(0x143)]:_0x4da1f5[_0x452f8b(0xf0)],[constants_1['FLOSUM_NAMESPACE']+'Org__c']:this[_0x452f8b(0x15e)][_0x452f8b(0x149)],[constants_1[_0x452f8b(0x142)]+_0x452f8b(0xe1)]:this[_0x452f8b(0x124)]};});}async['saveDeploymentResults'](_0xb52620){const _0x56f1f6=a376_0x516b33;this[_0x56f1f6(0x122)][_0x56f1f6(0x108)](_0x56f1f6(0xe2));const _0x3d88bc=await this[_0x56f1f6(0xdf)]['insertMultipleRecords'](constants_1['FLOSUM_NAMESPACE']+'Deployment_Result__c',_0xb52620),_0x25594d=_0x3d88bc[_0x56f1f6(0x11b)](_0x5241b0=>!_0x5241b0[_0x56f1f6(0x10c)])[_0x56f1f6(0x15b)](_0x4fdef5=>_0x4fdef5[_0x56f1f6(0x109)])[_0x56f1f6(0xef)]();if(_0x25594d[_0x56f1f6(0x106)])throw new salesforce_dml_error_1['SalesforceDmlError'](_0x25594d);}async['finishRollbackWithError'](_0x56c665){const _0x145fd7=a376_0x516b33;if(!this[_0x145fd7(0x15e)]){this[_0x145fd7(0x104)][_0x145fd7(0xf2)](_0x56c665);return;}this['_logger'][_0x145fd7(0xe9)](_0x56c665),await this[_0x145fd7(0x122)][_0x145fd7(0xd4)](),await this[_0x145fd7(0x13c)](![],!![],'');}async[a376_0x516b33(0x13c)](_0xbc9139,_0x4d58fb,_0x16581f){const _0x3bb5d8=a376_0x516b33,{id:_0x3390fd,organizationId:_0x2d5836,branchId:_0x264900,organizationName:_0x478e60}=this[_0x3bb5d8(0x15e)],_0x425244='<a\x20href='+this[_0x3bb5d8(0xfd)]+'/'+_0x3390fd+_0x3bb5d8(0xf1)+_0x3bb5d8(0x161)+'\x20</a>',_0x29f03f='<a\x20href='+this[_0x3bb5d8(0xfd)]+'/'+_0x2d5836+'\x20>'+_0x478e60+_0x3bb5d8(0x12f),_0x4fe02d=_0x425244+_0x3bb5d8(0x12a)+_0x29f03f+_0x3bb5d8(0x135),_0x8ce5f9={[constants_1[_0x3bb5d8(0x142)]+_0x3bb5d8(0x13b)]:_0x4fe02d,[constants_1['FLOSUM_NAMESPACE']+_0x3bb5d8(0x120)]:new Date(),[constants_1[_0x3bb5d8(0x142)]+_0x3bb5d8(0x100)]:_0x264900,[constants_1[_0x3bb5d8(0x142)]+_0x3bb5d8(0xde)]:_0x3bb5d8(0x127),[constants_1[_0x3bb5d8(0x142)]+_0x3bb5d8(0x141)]:_0x3bb5d8(0x144),[constants_1[_0x3bb5d8(0x142)]+_0x3bb5d8(0x132)]:_0x2d5836},_0x4dd24b={[constants_1[_0x3bb5d8(0x142)]+'Is_Error__c']:!_0xbc9139,[constants_1[_0x3bb5d8(0x142)]+_0x3bb5d8(0x137)]:_0xbc9139,[constants_1[_0x3bb5d8(0x142)]+'Status__c']:_0x4d58fb?status_enums_1[_0x3bb5d8(0x119)][_0x3bb5d8(0xe4)]:status_enums_1[_0x3bb5d8(0x119)][_0x3bb5d8(0xeb)],[constants_1[_0x3bb5d8(0x142)]+_0x3bb5d8(0x154)]:!![],[constants_1['FLOSUM_NAMESPACE']+_0x3bb5d8(0x13e)]:_0x16581f};await this[_0x3bb5d8(0xd7)][_0x3bb5d8(0xea)](flosum_constants_1['FlosumConstants'][_0x3bb5d8(0xfa)]+'/'+constants_1[_0x3bb5d8(0x142)]+'Metadata_Log__c/'+this[_0x3bb5d8(0x124)],_0x4dd24b),await this[_0x3bb5d8(0xd7)][_0x3bb5d8(0x11f)](flosum_constants_1[_0x3bb5d8(0xe5)][_0x3bb5d8(0xfa)]+'/'+constants_1[_0x3bb5d8(0x142)]+_0x3bb5d8(0x126),_0x8ce5f9),this['_logger'][_0x3bb5d8(0x108)](_0x3bb5d8(0x14d)+(_0xbc9139?_0x3bb5d8(0xee):_0x3bb5d8(0xff))+'.'),await this[_0x3bb5d8(0x122)][_0x3bb5d8(0xd4)]();}async[a376_0x516b33(0x12d)](){const _0xb3355e=a376_0x516b33;try{this[_0xb3355e(0x15e)]=await this['retrieveMetadataLog']();const _0x394e61=await this[_0xb3355e(0x136)]();await this[_0xb3355e(0x122)][_0xb3355e(0xd4)]();const _0x4ee4a9=await this[_0xb3355e(0x14f)](_0x394e61),_0x9f5c92=await this[_0xb3355e(0x146)](_0x4ee4a9);await this[_0xb3355e(0x122)][_0xb3355e(0xd4)]();const _0x3aae74=await this['_packageImportService']['import'](_0x9f5c92);await this[_0xb3355e(0x122)]['updateLog']();const _0x1f4f74=this[_0xb3355e(0x153)](_0x3aae74[_0xb3355e(0xfe)]);await this[_0xb3355e(0xda)](_0x1f4f74),await this[_0xb3355e(0x13c)](_0x3aae74['isDeployed'],![],_0x3aae74['packageId']);}catch(_0x423831){await this[_0xb3355e(0x10f)](_0x423831)[_0xb3355e(0x15c)](_0x5d0cc6=>this[_0xb3355e(0x104)][_0xb3355e(0xf2)](_0x5d0cc6));}}}exports[a376_0x516b33(0x134)]=RollbackService;