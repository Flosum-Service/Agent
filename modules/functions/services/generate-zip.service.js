const a86_0x3e8a58=a86_0x1cef;(function(_0x3f6c40,_0x226381){const _0x27f880=a86_0x1cef,_0x2b2b89=_0x3f6c40();while(!![]){try{const _0x345e2b=parseInt(_0x27f880(0x103))/0x1+parseInt(_0x27f880(0x128))/0x2+parseInt(_0x27f880(0x11c))/0x3*(-parseInt(_0x27f880(0xfe))/0x4)+parseInt(_0x27f880(0x131))/0x5*(-parseInt(_0x27f880(0x123))/0x6)+parseInt(_0x27f880(0x14e))/0x7+parseInt(_0x27f880(0x15a))/0x8*(parseInt(_0x27f880(0x139))/0x9)+parseInt(_0x27f880(0x119))/0xa*(-parseInt(_0x27f880(0x108))/0xb);if(_0x345e2b===_0x226381)break;else _0x2b2b89['push'](_0x2b2b89['shift']());}catch(_0x2a372e){_0x2b2b89['push'](_0x2b2b89['shift']());}}}(a86_0x1f5a,0x8b0c5));const a86_0x54ddf9=(function(){let _0x47c7ec=!![];return function(_0x2ef824,_0x5accb1){const _0x377c3f=_0x47c7ec?function(){const _0x2d25ab=a86_0x1cef;if(_0x5accb1){const _0x56c36d=_0x5accb1[_0x2d25ab(0x121)](_0x2ef824,arguments);return _0x5accb1=null,_0x56c36d;}}:function(){};return _0x47c7ec=![],_0x377c3f;};}()),a86_0x5deb22=a86_0x54ddf9(this,function(){const _0x288369=a86_0x1cef;return a86_0x5deb22[_0x288369(0x148)]()[_0x288369(0x11e)](_0x288369(0x10d))[_0x288369(0x148)]()['constructor'](a86_0x5deb22)[_0x288369(0x11e)](_0x288369(0x10d));});a86_0x5deb22();function a86_0x1f5a(){const _0x5696e4=['body','writeFile','Component__r','filter','13405030aqjhIW','every','BUILD','3CnPLfR','MDApiWriter','search','UTF-8','__esModule','apply','toBuffer','6RkUgUP','replace','orgId','find','../../shared/utils/fetch-attachments','935188BwoBZe','Zip','1.0','http://soap.sforce.com/2006/04/metadata','Builder','retrieveAttachments','indexOf','text','length','691620tIuYrQ','async','fetchComponentsDetailsByComponentsHistory','../utils/components-api','xml2js','destructiveChangesPost.xml','ComponentsApi','after\x20create\x20zip','207ZvpnDO','uuid','src','splitZip','log','defineProperty','adm-zip','join','MAX_ZIP_SIZE','extractComponentPermissions','dir','../../git/parsers/utils/zip','substring','createZip','map','toString','fs/promises','cwd','types','reduce','then','4477942EXEnqx','Name','start','after\x20create\x20second\x20zip','buildObject','Profile','generateAndDeployZip','fetchAttachmentsDetailsById','post','.temp','../utils/extract-component-permissions','addLocalFolder','353224ByQKVO','type','path','default','2645388aaaedx','Component_Name__c','file','fileType','Body','586896oslCDn','values','keys','files','package.xml','11CFbiUj','SALESFORCE_API_VERSION','generateAsync','name','PermissionSet','(((.+)+)+)+$','fileName','unzip','DEFLATE','push','../../../constants','exists','base64'];a86_0x1f5a=function(){return _0x5696e4;};return a86_0x1f5a();}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x22d998){const _0x299de5=a86_0x1cef;return _0x22d998&&_0x22d998[_0x299de5(0x120)]?_0x22d998:{'default':_0x22d998};};Object[a86_0x3e8a58(0x13e)](exports,a86_0x3e8a58(0x120),{'value':!![]}),exports[a86_0x3e8a58(0x154)]=void 0x0;const constants_1=require(a86_0x3e8a58(0x112)),path_1=__importDefault(require(a86_0x3e8a58(0x15c))),extract_component_permissions_1=require(a86_0x3e8a58(0x158)),xml2js_1=require(a86_0x3e8a58(0x135)),zip_1=require(a86_0x3e8a58(0x144)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a86_0x3e8a58(0x149)),components_api_1=require(a86_0x3e8a58(0x134)),adm_zip_1=__importDefault(require(a86_0x3e8a58(0x13f))),uuid_1=require(a86_0x3e8a58(0x13a)),fetch_attachments_1=require(a86_0x3e8a58(0x127)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a86_0x3e8a58(0x136),DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x55d072,isExtractComponentsPermissions:_0x11860d,preDestructiveAttachmentId:_0x3f91e5,postDestructiveAttachmentId:_0x21f08f,branchId:_0xd0770a,credentials:_0x520264,metadataLogId:_0x3a886e,environments:_0x30684b,metaTypes:_0x5e79ae},_0x18e508){const _0x24251c=a86_0x3e8a58,_0x5965cf=(0x0,uuid_1['v4'])();try{const _0x4287d9=await(0x0,fetch_attachments_1[_0x24251c(0x155)])(_0x18e508,_0x55d072),_0x578471=_0x4287d9[_0x24251c(0x14c)]((_0x3794ec,_0x18f04b)=>({..._0x3794ec,[_0x18f04b['Id']]:_0x18f04b[_0x24251c(0x14f)]}),{}),_0x3dd722=await getComponents(_0x4287d9,_0x18e508,_0x578471),_0x1b6e2f=await components_api_1[_0x24251c(0x137)][_0x24251c(0x133)](_0x18e508,_0x4287d9[_0x24251c(0x147)](({ParentId:_0x54fef3})=>_0x54fef3))[_0x24251c(0x14d)](_0x5f031e=>components_api_1[_0x24251c(0x137)]['removeNamespacePrefix'](_0x5f031e));if(_0x11860d){const _0x2fd811=_0x3dd722['filter'](({fileType:_0x214648})=>_0x214648===_0x24251c(0x153)||_0x214648===_0x24251c(0x10c));await removePermission(_0x2fd811,_0x1b6e2f);}await replaceEnvironments(_0x5e79ae,_0x30684b,_0x3dd722),await writeZip(_0x3dd722,_0x5965cf),await generateAndWritePackageXML(_0x4287d9,_0x1b6e2f,_0x5965cf);_0x3f91e5&&await saveDestructiveChanges(_0x18e508,_0x3f91e5,DESTRUCTIVE_CHANGES_PER_NAME,_0x5965cf);_0x21f08f&&await saveDestructiveChanges(_0x18e508,_0x21f08f,DESTRUCTIVE_CHANGES_POST_NAME,_0x5965cf);const _0x2819d8=(await createDeployZip(_0x5965cf)[_0x24251c(0x14d)](_0x1a063e=>{return _0x1a063e;}))[_0x24251c(0x122)]()[_0x24251c(0x148)](_0x24251c(0x114));console['log'](_0x24251c(0x138));const _0x268c00=_0x2819d8[_0x24251c(0x130)];if(_0x268c00>=components_api_1[_0x24251c(0x141)]){const _0x272426=await createDeployZip(_0x5965cf);console[_0x24251c(0x13d)](_0x24251c(0x151));const [_0x5baaea,_0x2900a3]=await components_api_1[_0x24251c(0x137)][_0x24251c(0x13c)](_0x272426,_0x268c00),_0x40e03f=await insertZip(_0x18e508,_0xd0770a,_0x520264[_0x24251c(0x125)],_0x3a886e,_0x5baaea[_0x24251c(0x122)]()[_0x24251c(0x148)](_0x24251c(0x114))),_0x5a8292=await insertZip(_0x18e508,_0xd0770a,_0x520264[_0x24251c(0x125)],_0x3a886e,_0x2900a3[_0x24251c(0x122)]()[_0x24251c(0x148)]('base64'));return _0x40e03f+','+_0x5a8292;}else return await insertZip(_0x18e508,_0xd0770a,_0x520264[_0x24251c(0x125)],_0x3a886e,_0x2819d8);}catch(_0x2d611f){throw _0x2d611f;}finally{if(await fs_internal_1['FS'][_0x24251c(0x113)](path_1[_0x24251c(0xfd)][_0x24251c(0x140)](process[_0x24251c(0x14a)](),'.temp',_0x5965cf)))await(0x0,promises_1['rm'])(path_1[_0x24251c(0xfd)]['join'](process[_0x24251c(0x14a)](),_0x24251c(0x157),_0x5965cf),{'recursive':!![]});}}exports[a86_0x3e8a58(0x154)]=generateAndDeployZip;async function getComponents(_0x529ba6,_0x1d82d0,_0x30f4ac){const _0x325f46=a86_0x3e8a58,_0x447ef0=[],_0x31aa8e=await(0x0,fetch_attachments_1[_0x325f46(0x12d)])(_0x529ba6,_0x1d82d0);return await getComponentFromZip(_0x31aa8e,_0x30f4ac)[_0x325f46(0x14d)](_0x1df671=>{_0x447ef0['push'](..._0x1df671);}),_0x447ef0;}async function getComponentFromZip(_0x41502f,_0x1c4c13){const _0x4732de=a86_0x3e8a58,_0x504e1f=[];for(const _0x6feeec of _0x41502f){const _0x3d50c4=await zip_1[_0x4732de(0x129)][_0x4732de(0x10f)](_0x6feeec[_0x4732de(0x104)]['Body']);for(const _0x179d39 in _0x3d50c4['files']){!_0x3d50c4['files'][_0x179d39][_0x4732de(0x143)]&&_0x504e1f[_0x4732de(0x111)]({'fileName':_0x179d39[_0x4732de(0x145)](_0x179d39[_0x4732de(0x12e)]('/')+0x1),'fileType':_0x1c4c13[_0x6feeec['id']],'body':_0x6feeec[_0x4732de(0x104)][_0x4732de(0x102)]});}}return _0x504e1f;}async function removePermission(_0x32aaeb,_0x32764e){const _0x102eb3=a86_0x3e8a58;for(const _0x10de9f of _0x32aaeb){const _0x2c4b1e=await zip_1[_0x102eb3(0x129)][_0x102eb3(0x10f)](_0x10de9f[_0x102eb3(0x115)]),_0x4998f7=[];for(const _0x5f8f3 in _0x2c4b1e[_0x102eb3(0x106)]){!_0x2c4b1e['files'][_0x5f8f3]['dir']&&_0x4998f7[_0x102eb3(0x111)]({'fileName':_0x5f8f3,'body':await _0x2c4b1e['files'][_0x5f8f3][_0x102eb3(0x132)](_0x102eb3(0x12f))});}const _0x23227c=await(0x0,extract_component_permissions_1[_0x102eb3(0x142)])(_0x4998f7[0x0][_0x102eb3(0x115)][_0x102eb3(0x148)](),_0x32764e,_0x10de9f[_0x102eb3(0x101)]),_0x9bb2b1=new xml2js_1[(_0x102eb3(0x12c))]({'xmldec':{'version':_0x102eb3(0x12a),'encoding':_0x102eb3(0x11f)}}),_0x2328ec=_0x9bb2b1[_0x102eb3(0x152)](_0x23227c),_0x13223c=zip_1['Zip'][_0x102eb3(0x146)]();_0x13223c[_0x102eb3(0x100)](_0x4998f7[0x0][_0x102eb3(0x10e)],_0x2328ec),_0x10de9f['body']=await _0x13223c[_0x102eb3(0x10a)]({'type':'base64','compression':_0x102eb3(0x110),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x2e3a9e,_0x3cc203,_0xbff0f1){const _0x4e55ce=a86_0x3e8a58;for(const _0x511fbd of _0xbff0f1){if(_0x2e3a9e[_0x4e55ce(0x11a)](_0x276100=>_0x276100!==_0x511fbd[_0x4e55ce(0x101)]))continue;const _0x338bd8=await zip_1[_0x4e55ce(0x129)]['unzip'](_0x511fbd[_0x4e55ce(0x115)]);for(const _0x1436a in _0x338bd8[_0x4e55ce(0x106)]){if(!_0x338bd8[_0x4e55ce(0x106)][_0x1436a][_0x4e55ce(0x143)]){let _0x5f4984=await _0x338bd8[_0x4e55ce(0x106)][_0x1436a][_0x4e55ce(0x132)](_0x4e55ce(0x12f));for(const _0x44ca2c of Object[_0x4e55ce(0x105)](_0x3cc203)){const _0x126430=new RegExp('%%'+_0x44ca2c+'%%','g');_0x5f4984=_0x5f4984[_0x4e55ce(0x124)](_0x126430,_0x3cc203[_0x44ca2c]);}_0x338bd8['file'](_0x1436a,_0x5f4984);}}_0x511fbd[_0x4e55ce(0x115)]=await _0x338bd8['generateAsync']({'type':_0x4e55ce(0x114),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0xe2d6e4,_0x7651d0){const _0x25eaf7=a86_0x3e8a58,_0x4190ad=new mdapi_1[(_0x25eaf7(0x11d))]({'components':_0xe2d6e4,'sourceDir':path_1['default'][_0x25eaf7(0x140)](process[_0x25eaf7(0x14a)](),_0x25eaf7(0x157),_0x7651d0,DEPLOY_DIR_NAME,_0x25eaf7(0x13b)),'skipChildErrors':![]});await _0x4190ad[_0x25eaf7(0x150)]();}async function generateAndWritePackageXML(_0x50ce53,_0x457e45,_0x11f88){const _0x4c50ea=a86_0x3e8a58,_0x547d58=getComponentsTypeAndName(_0x50ce53,_0x457e45),_0x4fa559=[...new Set(_0x547d58[_0x4c50ea(0x147)](_0x1a979d=>_0x1a979d[_0x4c50ea(0x15b)]))],_0x2eb1f0={'Package':{'$':{'xmlns':_0x4c50ea(0x12b)},'types':[],'version':''+constants_1[_0x4c50ea(0x109)][_0x4c50ea(0x145)](0x1)}};for(const _0x1f9425 of _0x4fa559){const _0x7af279=_0x547d58[_0x4c50ea(0x118)](_0x4af68d=>_0x4af68d[_0x4c50ea(0x15b)]===_0x1f9425)[_0x4c50ea(0x147)](_0x1509a9=>_0x1509a9[_0x4c50ea(0x10b)]),_0x280835={'members':_0x7af279,'name':_0x1f9425};_0x2eb1f0['Package'][_0x4c50ea(0x14b)][_0x4c50ea(0x111)](_0x280835);}const _0x12c3b1=new xml2js_1[(_0x4c50ea(0x12c))]({'xmldec':{'version':_0x4c50ea(0x12a),'encoding':_0x4c50ea(0x11f)}}),_0x81a0d4=_0x12c3b1[_0x4c50ea(0x152)](_0x2eb1f0);await fs_internal_1['FS'][_0x4c50ea(0x116)](path_1[_0x4c50ea(0xfd)][_0x4c50ea(0x140)](process[_0x4c50ea(0x14a)](),_0x4c50ea(0x157),_0x11f88,DEPLOY_DIR_NAME,_0x4c50ea(0x13b),_0x4c50ea(0x107)),_0x81a0d4);}function getComponentsTypeAndName(_0xba7b94,_0x46b421){const _0x5ddfc4=a86_0x3e8a58;return _0xba7b94[_0x5ddfc4(0x14c)]((_0x1545fc,_0x2db591)=>{const _0x47514e=_0x5ddfc4,_0x1c0a3d=_0x46b421[_0x47514e(0x126)](_0x3c97e6=>_0x3c97e6['Id']===_0x2db591['ParentId']);return _0x1c0a3d&&_0x1545fc[_0x47514e(0x111)]({'name':_0x1c0a3d[_0x47514e(0x117)][_0x47514e(0xff)],'type':_0x2db591[_0x47514e(0x14f)]}),_0x1545fc;},[]);}async function saveDestructiveChanges(_0x4c59d6,_0x4aa4c1,_0x43aa61,_0x46e676){const _0x253a6c=a86_0x3e8a58,_0x1c6b40=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x4c59d6,_0x4aa4c1))[_0x253a6c(0x148)]();await fs_internal_1['FS'][_0x253a6c(0x116)](path_1[_0x253a6c(0xfd)]['join'](process[_0x253a6c(0x14a)](),'.temp',_0x46e676,DEPLOY_DIR_NAME,_0x253a6c(0x13b),_0x43aa61),_0x1c6b40);}function a86_0x1cef(_0x31bb85,_0x53e736){const _0x2abb56=a86_0x1f5a();return a86_0x1cef=function(_0x5deb22,_0x54ddf9){_0x5deb22=_0x5deb22-0xfd;let _0x1f5aa4=_0x2abb56[_0x5deb22];return _0x1f5aa4;},a86_0x1cef(_0x31bb85,_0x53e736);}async function createDeployZip(_0x153366){const _0x13ba89=a86_0x3e8a58,_0x196d67=new adm_zip_1[(_0x13ba89(0xfd))]();return await _0x196d67[_0x13ba89(0x159)](path_1[_0x13ba89(0xfd)][_0x13ba89(0x140)](process['cwd'](),_0x13ba89(0x157),_0x153366,DEPLOY_DIR_NAME)),_0x196d67;}async function insertZip(_0x4d6e2e,_0xa94691,_0x58037a,_0x336bee,_0x15a711){const _0x4c2c9c=a86_0x3e8a58,_0x4e8596={'ParentId':_0xa94691,'Name':'BUILD'+_0x58037a,'Description':_0x4c2c9c(0x11b)+_0x336bee,'Body':_0x15a711},{data:_0x500843}=await _0x4d6e2e[_0x4c2c9c(0x156)]('/services/data/'+constants_1[_0x4c2c9c(0x109)]+'/sobjects/Attachment',_0x4e8596);return _0x500843['id'];}