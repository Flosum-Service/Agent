const a104_0x49e8dc=a104_0x241a;(function(_0x2dab0d,_0x35ef8c){const _0x317504=a104_0x241a,_0x4164ea=_0x2dab0d();while(!![]){try{const _0x565dd6=-parseInt(_0x317504(0x1f0))/0x1*(-parseInt(_0x317504(0x214))/0x2)+parseInt(_0x317504(0x1e8))/0x3*(-parseInt(_0x317504(0x1f9))/0x4)+-parseInt(_0x317504(0x1f5))/0x5+-parseInt(_0x317504(0x1df))/0x6*(parseInt(_0x317504(0x1d8))/0x7)+-parseInt(_0x317504(0x22a))/0x8*(parseInt(_0x317504(0x22b))/0x9)+parseInt(_0x317504(0x21c))/0xa+parseInt(_0x317504(0x22d))/0xb;if(_0x565dd6===_0x35ef8c)break;else _0x4164ea['push'](_0x4164ea['shift']());}catch(_0x344a31){_0x4164ea['push'](_0x4164ea['shift']());}}}(a104_0x5858,0xa6056));const a104_0x359900=(function(){let _0x509f0b=!![];return function(_0x586126,_0x55393d){const _0x4fec89=_0x509f0b?function(){const _0x3a28bb=a104_0x241a;if(_0x55393d){const _0x5115c0=_0x55393d[_0x3a28bb(0x237)](_0x586126,arguments);return _0x55393d=null,_0x5115c0;}}:function(){};return _0x509f0b=![],_0x4fec89;};}()),a104_0x480336=a104_0x359900(this,function(){const _0x3623a1=a104_0x241a;return a104_0x480336[_0x3623a1(0x215)]()[_0x3623a1(0x212)]('(((.+)+)+)+$')['toString']()[_0x3623a1(0x23c)](a104_0x480336)[_0x3623a1(0x212)](_0x3623a1(0x20e));});a104_0x480336();'use strict';var __importDefault=this&&this[a104_0x49e8dc(0x21d)]||function(_0x2f6fb6){return _0x2f6fb6&&_0x2f6fb6['__esModule']?_0x2f6fb6:{'default':_0x2f6fb6};};Object[a104_0x49e8dc(0x213)](exports,a104_0x49e8dc(0x1ed),{'value':!![]}),exports[a104_0x49e8dc(0x1e6)]=void 0x0;const path_1=__importDefault(require(a104_0x49e8dc(0x1f6))),extract_component_permissions_1=require(a104_0x49e8dc(0x219)),logger_1=require(a104_0x49e8dc(0x1dd)),xml2js_1=require(a104_0x49e8dc(0x217)),zip_1=require(a104_0x49e8dc(0x1ea)),mdapi_writer_1=require(a104_0x49e8dc(0x1de)),fs_internal_1=require(a104_0x49e8dc(0x224)),promises_1=require(a104_0x49e8dc(0x203)),components_api_1=require(a104_0x49e8dc(0x21e)),adm_zip_1=__importDefault(require(a104_0x49e8dc(0x229))),uuid_1=require(a104_0x49e8dc(0x1e2)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a104_0x49e8dc(0x1ef)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x49e8dc(0x1eb),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x49e8dc(0x1f2),DEPLOY_DIR_NAME='DEPLOYZIP',PERMISSION_SET_FOLDER_NAME=a104_0x49e8dc(0x207);async function generateAndDeployZip({attachmentsId:_0x3e162a,isExtractComponentsPermissionSets:_0x3a5534,isExtractComponentsProfiles:_0x5a7cf9,preDestructiveAttachmentId:_0x4187b7,postDestructiveAttachmentId:_0x26b74c,branchId:_0x1a3549,credentials:_0x5dbaaa,metadataLogId:_0x1ed4cb,environments:_0x54177f,metaTypes:_0x544587,apiVersion:_0x1c866a},_0x146e7a,_0x38ac16){const _0x4f8cea=a104_0x49e8dc;var _0x11acd4;const _0x281b33=(0x0,uuid_1['v4'])();try{const _0x451f2c=await(0x0,fetch_attachments_1[_0x4f8cea(0x220)])(_0x146e7a,_0x3e162a),_0x20e465=_0x451f2c[_0x4f8cea(0x1ff)]((_0xcc7df4,_0x218212)=>({..._0xcc7df4,[_0x218212['Id']]:_0x218212[_0x4f8cea(0x1ee)]}),{}),_0x4563d7=await getComponents(_0x451f2c,_0x146e7a,_0x20e465),_0x428a86=await components_api_1[_0x4f8cea(0x20b)]['fetchComponentsDetailsByComponentsHistory'](_0x146e7a,_0x451f2c[_0x4f8cea(0x200)](({ParentId:_0x389426})=>_0x389426),_0x1c866a)[_0x4f8cea(0x218)](_0x3fecb7=>components_api_1[_0x4f8cea(0x20b)][_0x4f8cea(0x22c)](_0x3fecb7));if(_0x5a7cf9){const _0x4bd297=_0x4563d7['filter'](({fileType:_0x30e693})=>_0x30e693===_0x4f8cea(0x1e1));await removePermission(_0x4bd297,_0x428a86);}const _0x353589=_0x4563d7['filter'](({fileType:_0x5322e8})=>_0x5322e8===_0x4f8cea(0x211));if(_0x353589[_0x4f8cea(0x209)]&&_0x3a5534){await removePermission(_0x353589,_0x428a86);const {items:_0x13cc53}=await retrieveTargetPermissionSets(_0x353589,_0x1c866a,_0x38ac16);await mergePermissionSets(_0x353589,((_0x11acd4=_0x13cc53['PermissionSet'])===null||_0x11acd4===void 0x0?void 0x0:_0x11acd4[_0x4f8cea(0x23d)])||[]);}await replaceEnvironments(_0x544587,_0x54177f,_0x4563d7),await writeZip(_0x4563d7,_0x281b33),await generateAndWritePackageXML(_0x451f2c,_0x428a86,_0x281b33,_0x1c866a);_0x4187b7&&await saveDestructiveChanges(_0x146e7a,_0x4187b7,DESTRUCTIVE_CHANGES_PER_NAME,_0x281b33);_0x26b74c&&await saveDestructiveChanges(_0x146e7a,_0x26b74c,DESTRUCTIVE_CHANGES_POST_NAME,_0x281b33);const _0x393346=(await createDeployZip(_0x281b33)[_0x4f8cea(0x218)](_0x4abbc3=>{return _0x4abbc3;}))[_0x4f8cea(0x1e9)]()[_0x4f8cea(0x215)](_0x4f8cea(0x231)),_0x4ea40a=_0x393346['length'];if(_0x4ea40a>=components_api_1[_0x4f8cea(0x1f4)]){const _0x38f28e=await createDeployZip(_0x281b33),[_0x2b3a4d,_0x243585]=await components_api_1[_0x4f8cea(0x20b)][_0x4f8cea(0x223)](_0x38f28e,_0x4ea40a),_0x31eaac=await insertZip(_0x146e7a,_0x1a3549,_0x5dbaaa['orgId'],_0x1ed4cb,_0x2b3a4d[_0x4f8cea(0x1e9)]()['toString'](_0x4f8cea(0x231)),_0x1c866a),_0x45c6d9=await insertZip(_0x146e7a,_0x1a3549,_0x5dbaaa[_0x4f8cea(0x1db)],_0x1ed4cb,_0x243585[_0x4f8cea(0x1e9)]()[_0x4f8cea(0x215)](_0x4f8cea(0x231)),_0x1c866a);return _0x31eaac+','+_0x45c6d9;}else return await insertZip(_0x146e7a,_0x1a3549,_0x5dbaaa[_0x4f8cea(0x1db)],_0x1ed4cb,_0x393346,_0x1c866a);}catch(_0x2acafc){throw _0x2acafc;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x4f8cea(0x1f8)][_0x4f8cea(0x234)](process[_0x4f8cea(0x20c)](),'.temp',_0x281b33)))await(0x0,promises_1['rm'])(path_1[_0x4f8cea(0x1f8)][_0x4f8cea(0x234)](process[_0x4f8cea(0x20c)](),'.temp',_0x281b33),{'recursive':!![]});}}exports[a104_0x49e8dc(0x1e6)]=generateAndDeployZip;async function getComponents(_0xc9414a,_0x389b43,_0xa09f21){const _0xf0a67d=a104_0x49e8dc,_0x2163f6=[],_0x1b628f=await(0x0,fetch_attachments_1[_0xf0a67d(0x1fe)])(_0xc9414a,_0x389b43);return await getComponentFromZip(_0x1b628f,_0xa09f21)['then'](_0x54394d=>{const _0x5909a6=_0xf0a67d;_0x2163f6[_0x5909a6(0x22f)](..._0x54394d);}),_0x2163f6;}async function getComponentFromZip(_0x3dcd3c,_0xb0344f){const _0xf32dc7=a104_0x49e8dc,_0x27c612=[];for(const _0xdbd379 of _0x3dcd3c){const _0x348210=await zip_1['Zip'][_0xf32dc7(0x226)](_0xdbd379[_0xf32dc7(0x236)][_0xf32dc7(0x233)]);for(const _0x127fd7 in _0x348210[_0xf32dc7(0x21b)]){!_0x348210[_0xf32dc7(0x21b)][_0x127fd7][_0xf32dc7(0x23e)]&&_0x27c612[_0xf32dc7(0x22f)]({'fileName':_0x127fd7[_0xf32dc7(0x232)](_0x127fd7['indexOf']('/')+0x1),'fileType':_0xb0344f[_0xdbd379['id']],'body':_0xdbd379[_0xf32dc7(0x236)][_0xf32dc7(0x233)]});}}return _0x27c612;}async function removePermission(_0x1c08f2,_0x5f2a11){const _0x5a82c4=a104_0x49e8dc;for(const _0x53b015 of _0x1c08f2){const _0x5be7b3=await zip_1[_0x5a82c4(0x205)][_0x5a82c4(0x226)](_0x53b015[_0x5a82c4(0x221)]),_0x40af19=[];for(const _0x38fb2f in _0x5be7b3[_0x5a82c4(0x21b)]){!_0x5be7b3[_0x5a82c4(0x21b)][_0x38fb2f][_0x5a82c4(0x23e)]&&_0x40af19[_0x5a82c4(0x22f)]({'fileName':_0x38fb2f,'body':await _0x5be7b3['files'][_0x38fb2f]['async'](_0x5a82c4(0x1fc))});}const _0x39ba01=await(0x0,extract_component_permissions_1[_0x5a82c4(0x1e3)])(_0x40af19[0x0][_0x5a82c4(0x221)][_0x5a82c4(0x215)](),_0x5f2a11,_0x53b015[_0x5a82c4(0x21f)]),_0x2a3ff9=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x101f8d=_0x2a3ff9[_0x5a82c4(0x1da)](_0x39ba01),_0x47462b=zip_1[_0x5a82c4(0x205)][_0x5a82c4(0x239)]();_0x47462b[_0x5a82c4(0x1fa)](_0x40af19[0x0][_0x5a82c4(0x228)],_0x101f8d),_0x53b015[_0x5a82c4(0x221)]=await _0x47462b[_0x5a82c4(0x1fb)]({'type':_0x5a82c4(0x231),'compression':_0x5a82c4(0x235),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x161212,_0x1ed405,_0x260347){const _0x2786af=a104_0x49e8dc,_0x36977f=_0x161212[_0x2786af(0x200)](_0x10254e=>PERMISSION_SET_FOLDER_NAME+'/'+_0x10254e[_0x2786af(0x228)])[_0x2786af(0x234)](';'),_0x475186=[{'field':_0x2786af(0x228),'option':salesforce_1[_0x2786af(0x1ec)]['IN'],'value':_0x36977f}],_0x1c810a=new logger_1['Logger']();return new salesforce_1['PartialRetrieve'](_0x1ed405,_0x260347,_0x1c810a,_0x475186,null,[salesforce_1[_0x2786af(0x1d7)][_0x2786af(0x23a)]])['execute']();}async function mergePermissionSets(_0x552038,_0x504e72){const _0x5ac36f=a104_0x49e8dc,_0x3ca5ce=_0x504e72[_0x5ac36f(0x1ff)]((_0x2ea9cc,_0x357321)=>_0x2ea9cc[_0x5ac36f(0x208)](_0x357321[_0x5ac36f(0x1fd)][_0x5ac36f(0x228)],_0x357321),new Map());for(const _0x337f09 of _0x552038){const _0x456f6e=PERMISSION_SET_FOLDER_NAME+'/'+_0x337f09[_0x5ac36f(0x228)],_0x454b81=_0x3ca5ce[_0x5ac36f(0x1d9)](_0x456f6e);if(!_0x454b81)continue;const _0x2f1794=await zip_1[_0x5ac36f(0x205)][_0x5ac36f(0x226)](_0x337f09[_0x5ac36f(0x221)]),_0x77a3e7=await _0x2f1794[_0x5ac36f(0x21b)][_0x456f6e][_0x5ac36f(0x1f7)](_0x5ac36f(0x1fc)),_0x15f732=_0x454b81[_0x5ac36f(0x21b)][_0x456f6e][_0x5ac36f(0x215)](),_0x141b9f=await(0x0,extract_component_permissions_1[_0x5ac36f(0x1f3)])(_0x77a3e7,_0x15f732,_0x337f09[_0x5ac36f(0x21f)]),_0x43ba13=zip_1[_0x5ac36f(0x205)][_0x5ac36f(0x239)]();_0x43ba13[_0x5ac36f(0x1fa)](_0x456f6e,_0x141b9f),_0x337f09[_0x5ac36f(0x221)]=await _0x43ba13[_0x5ac36f(0x1fb)]({'type':_0x5ac36f(0x231),'compression':_0x5ac36f(0x235),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x31c8ca,_0x162a73,_0xc47a7e){const _0x2b6911=a104_0x49e8dc;for(const _0x11c865 of _0xc47a7e){if(_0x31c8ca[_0x2b6911(0x216)](_0x4f9794=>_0x4f9794!==_0x11c865[_0x2b6911(0x21f)]))continue;const _0x33ccd5=await zip_1[_0x2b6911(0x205)][_0x2b6911(0x226)](_0x11c865[_0x2b6911(0x221)]);for(const _0x2b6bc2 in _0x33ccd5['files']){if(!_0x33ccd5['files'][_0x2b6bc2][_0x2b6911(0x23e)]){let _0x488c06=await _0x33ccd5[_0x2b6911(0x21b)][_0x2b6bc2][_0x2b6911(0x1f7)]('text');for(const _0x449a9 of Object[_0x2b6911(0x204)](_0x162a73)){const _0x30994f=new RegExp('%%'+_0x449a9+'%%','g');_0x488c06=_0x488c06['replace'](_0x30994f,_0x162a73[_0x449a9]);}_0x33ccd5[_0x2b6911(0x1fa)](_0x2b6bc2,_0x488c06);}}_0x11c865[_0x2b6911(0x221)]=await _0x33ccd5['generateAsync']({'type':_0x2b6911(0x231),'compression':_0x2b6911(0x235),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x3137a1,_0x219f31){const _0x23bab7=a104_0x49e8dc,_0x17737a=new mdapi_writer_1[(_0x23bab7(0x201))]({'components':_0x3137a1,'sourceDir':path_1[_0x23bab7(0x1f8)]['join'](process['cwd'](),'.temp',_0x219f31,DEPLOY_DIR_NAME,_0x23bab7(0x206)),'skipChildErrors':![]});await _0x17737a['execute']();}async function generateAndWritePackageXML(_0x43defe,_0x4c384d,_0x1680a2,_0x6b5fc){const _0x344126=a104_0x49e8dc,_0x394d5d=getComponentsTypeAndName(_0x43defe,_0x4c384d),_0x368ded=[...new Set(_0x394d5d[_0x344126(0x200)](_0x24dad7=>_0x24dad7[_0x344126(0x1e0)]))],_0x5a76e0={'Package':{'$':{'xmlns':_0x344126(0x20d)},'types':[],'version':''+_0x6b5fc}};for(const _0x436bb8 of _0x368ded){const _0xf13119=_0x394d5d[_0x344126(0x1e5)](_0x5a639f=>_0x5a639f[_0x344126(0x1e0)]===_0x436bb8)[_0x344126(0x200)](_0x2d12ad=>_0x2d12ad[_0x344126(0x210)]),_0x1e0113={'members':_0xf13119,'name':_0x436bb8};_0x5a76e0[_0x344126(0x1e4)][_0x344126(0x20f)][_0x344126(0x22f)](_0x1e0113);}const _0x3d786f=new xml2js_1['Builder']({'xmldec':{'version':_0x344126(0x1dc),'encoding':_0x344126(0x20a)}}),_0x209fd9=_0x3d786f[_0x344126(0x1da)](_0x5a76e0);await fs_internal_1['FS'][_0x344126(0x225)](path_1[_0x344126(0x1f8)][_0x344126(0x234)](process['cwd'](),_0x344126(0x202),_0x1680a2,DEPLOY_DIR_NAME,'src','package.xml'),_0x209fd9);}function getComponentsTypeAndName(_0xf695fd,_0x587c27){const _0x5ef122=a104_0x49e8dc;return _0xf695fd[_0x5ef122(0x1ff)]((_0x4d3f89,_0x3e37c8)=>{const _0x442ff1=_0x5ef122,_0x15da29=_0x587c27[_0x442ff1(0x230)](_0x58267e=>_0x58267e['Id']===_0x3e37c8['ParentId']);return _0x15da29&&_0x4d3f89['push']({'name':_0x15da29[_0x442ff1(0x1f1)][_0x442ff1(0x23b)],'type':salesforce_1[_0x442ff1(0x238)]['FOLDER_TO_METADATA_TYPE_MAP'][_0x3e37c8['Name']]||_0x3e37c8[_0x442ff1(0x1ee)]}),_0x4d3f89;},[]);}async function saveDestructiveChanges(_0x1bb4e4,_0x580707,_0x184cfb,_0x17d8b1){const _0x29c7e2=a104_0x49e8dc,_0x3f51ed=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x1bb4e4,_0x580707))[_0x29c7e2(0x215)]();await fs_internal_1['FS'][_0x29c7e2(0x225)](path_1[_0x29c7e2(0x1f8)]['join'](process[_0x29c7e2(0x20c)](),_0x29c7e2(0x202),_0x17d8b1,DEPLOY_DIR_NAME,_0x29c7e2(0x206),_0x184cfb),_0x3f51ed);}function a104_0x5858(){const _0xef7667=['Component__r','destructiveChangesPost.xml','mergeComponentPermissions','MAX_ZIP_SIZE','3623120jIkwUX','path','async','default','316aXndWM','file','generateAsync','text','listMetadataItem','retrieveAttachments','reduce','map','MDApiWriter','.temp','fs/promises','keys','Zip','src','permissionsets','set','length','UTF-8','ComponentsApi','cwd','http://soap.sforce.com/2006/04/metadata','(((.+)+)+)+$','types','name','PermissionSet','search','defineProperty','65524WHuzyQ','toString','every','xml2js','then','../utils/extract-component-permissions','post','files','3366560TuSIej','__importDefault','../utils/components-api','fileType','fetchAttachmentsDetailsById','body','BUILD','splitZip','../../git/internal/fs.internal','writeFile','unzip','/services/data/v','fileName','adm-zip','472XWMdPE','141327WLXERW','removeNamespacePrefix','31222081tLaCuT','/sobjects/Attachment','push','find','base64','substring','Body','join','DEFLATE','values','apply','MetadataConstants','createZip','PERMISSION_SET','Component_Name__c','constructor','components','dir','MetadataType','1070853mbMAwo','get','buildObject','orgId','1.0','../classes/logger','../../git/writers/mdapi.writer','30PQxMbH','type','Profile','uuid','extractComponentPermissions','Package','filter','generateAndDeployZip','addLocalFolder','29127eqaUMe','toBuffer','../../git/parsers/utils/zip','destructiveChangesPre.xml','DeclarativeFilterOptions','__esModule','Name','@flosum/salesforce','21UBikDJ'];a104_0x5858=function(){return _0xef7667;};return a104_0x5858();}function a104_0x241a(_0x3d3bdb,_0x5125ce){const _0x108d78=a104_0x5858();return a104_0x241a=function(_0x480336,_0x359900){_0x480336=_0x480336-0x1d7;let _0x5858a4=_0x108d78[_0x480336];return _0x5858a4;},a104_0x241a(_0x3d3bdb,_0x5125ce);}async function createDeployZip(_0x132cf3){const _0x5047ae=a104_0x49e8dc,_0x3b2039=new adm_zip_1['default']();return await _0x3b2039[_0x5047ae(0x1e7)](path_1[_0x5047ae(0x1f8)]['join'](process[_0x5047ae(0x20c)](),'.temp',_0x132cf3,DEPLOY_DIR_NAME)),_0x3b2039;}async function insertZip(_0x38a458,_0x398f8c,_0x325c68,_0x4061b1,_0x49a5df,_0x553d92){const _0x12c3de=a104_0x49e8dc,_0x1c5ebe={'ParentId':_0x398f8c,'Name':_0x12c3de(0x222)+_0x325c68,'Description':_0x12c3de(0x222)+_0x4061b1,'Body':_0x49a5df},{data:_0x444986}=await _0x38a458[_0x12c3de(0x21a)](_0x12c3de(0x227)+_0x553d92+_0x12c3de(0x22e),_0x1c5ebe);return _0x444986['id'];}