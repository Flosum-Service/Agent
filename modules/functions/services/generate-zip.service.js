const a86_0x2e06f5=a86_0x4213;(function(_0x3ef459,_0x33c0aa){const _0xaa369=a86_0x4213,_0x30ac4c=_0x3ef459();while(!![]){try{const _0x2d4b89=parseInt(_0xaa369(0x87))/0x1+parseInt(_0xaa369(0xbf))/0x2+parseInt(_0xaa369(0xb2))/0x3*(parseInt(_0xaa369(0xa3))/0x4)+-parseInt(_0xaa369(0xdd))/0x5*(-parseInt(_0xaa369(0xa5))/0x6)+parseInt(_0xaa369(0xc4))/0x7+-parseInt(_0xaa369(0xc8))/0x8*(parseInt(_0xaa369(0x81))/0x9)+-parseInt(_0xaa369(0x90))/0xa;if(_0x2d4b89===_0x33c0aa)break;else _0x30ac4c['push'](_0x30ac4c['shift']());}catch(_0x4e7345){_0x30ac4c['push'](_0x30ac4c['shift']());}}}(a86_0x1487,0xb3567));const a86_0x24016d=(function(){let _0x36b1bc=!![];return function(_0x44cb78,_0x1c77cd){const _0x13cdf5=_0x36b1bc?function(){const _0x13d1b=a86_0x4213;if(_0x1c77cd){const _0x514e81=_0x1c77cd[_0x13d1b(0x8a)](_0x44cb78,arguments);return _0x1c77cd=null,_0x514e81;}}:function(){};return _0x36b1bc=![],_0x13cdf5;};}()),a86_0xe413b1=a86_0x24016d(this,function(){const _0x1056a4=a86_0x4213;return a86_0xe413b1[_0x1056a4(0xa6)]()[_0x1056a4(0xaf)](_0x1056a4(0x85))[_0x1056a4(0xa6)]()['constructor'](a86_0xe413b1)['search'](_0x1056a4(0x85));});a86_0xe413b1();'use strict';var __importDefault=this&&this[a86_0x2e06f5(0xd9)]||function(_0x2fd1fc){const _0x38dfd0=a86_0x2e06f5;return _0x2fd1fc&&_0x2fd1fc[_0x38dfd0(0xcd)]?_0x2fd1fc:{'default':_0x2fd1fc};};Object[a86_0x2e06f5(0xae)](exports,a86_0x2e06f5(0xcd),{'value':!![]}),exports[a86_0x2e06f5(0x8f)]=void 0x0;const constants_1=require(a86_0x2e06f5(0x8d)),path_1=__importDefault(require('path')),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require('xml2js'),zip_1=require(a86_0x2e06f5(0xd4)),mdapi_1=require(a86_0x2e06f5(0xd8)),fs_internal_1=require(a86_0x2e06f5(0x89)),promises_1=require(a86_0x2e06f5(0xd6)),components_api_1=require(a86_0x2e06f5(0xb7)),adm_zip_1=__importDefault(require(a86_0x2e06f5(0xbc))),uuid_1=require(a86_0x2e06f5(0x93)),fetch_attachments_1=require(a86_0x2e06f5(0x84)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x2e06f5(0x97),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x2e06f5(0xb4),DEPLOY_DIR_NAME=a86_0x2e06f5(0xa7);async function generateAndDeployZip({attachmentsId:_0xae437,isExtractComponentsPermissions:_0x471095,preDestructiveAttachmentId:_0x193cf1,postDestructiveAttachmentId:_0x316380,branchId:_0x24e23c,credentials:_0x16f64f,metadataLogId:_0x442d9d,environments:_0xb700e5,metaTypes:_0x4acf39},_0xe2cf08){const _0x90f03a=a86_0x2e06f5,_0x1c8bf7=(0x0,uuid_1['v4'])();try{const _0x440444=await(0x0,fetch_attachments_1[_0x90f03a(0xa0)])(_0xe2cf08,_0xae437),_0x45e4ea=_0x440444[_0x90f03a(0xc5)]((_0x3d2940,_0x32b98b)=>({..._0x3d2940,[_0x32b98b['Id']]:_0x32b98b[_0x90f03a(0xa2)]}),{}),_0x27604e=await getComponents(_0x440444,_0xe2cf08,_0x45e4ea),_0x2b967a=await components_api_1[_0x90f03a(0x98)][_0x90f03a(0x9a)](_0xe2cf08,_0x440444[_0x90f03a(0xcb)](({ParentId:_0x209a81})=>_0x209a81))[_0x90f03a(0x7f)](_0x146539=>components_api_1[_0x90f03a(0x98)]['removeNamespacePrefix'](_0x146539));if(_0x471095){const _0x462b0b=_0x27604e['filter'](({fileType:_0x16c53c})=>_0x16c53c===_0x90f03a(0x8e)||_0x16c53c===_0x90f03a(0xda));await removePermission(_0x462b0b,_0x2b967a);}await replaceEnvironments(_0x4acf39,_0xb700e5,_0x27604e),await writeZip(_0x27604e,_0x1c8bf7),await generateAndWritePackageXML(_0x440444,_0x2b967a,_0x1c8bf7);_0x193cf1&&await saveDestructiveChanges(_0xe2cf08,_0x193cf1,DESTRUCTIVE_CHANGES_PER_NAME,_0x1c8bf7);_0x316380&&await saveDestructiveChanges(_0xe2cf08,_0x316380,DESTRUCTIVE_CHANGES_POST_NAME,_0x1c8bf7);const _0xf28f6f=(await createDeployZip(_0x1c8bf7)['then'](_0x1a7d8b=>{return _0x1a7d8b;}))[_0x90f03a(0xad)]()[_0x90f03a(0xa6)]('base64');console[_0x90f03a(0x9e)](_0x90f03a(0xd0));const _0x5bab1c=_0xf28f6f[_0x90f03a(0xc7)];if(_0x5bab1c>=components_api_1[_0x90f03a(0xce)]){const _0x5705aa=await createDeployZip(_0x1c8bf7);console['log']('after\x20create\x20second\x20zip');const [_0x2f2f13,_0x5868dd]=await components_api_1[_0x90f03a(0x98)][_0x90f03a(0xb5)](_0x5705aa,_0x5bab1c),_0x49032c=await insertZip(_0xe2cf08,_0x24e23c,_0x16f64f[_0x90f03a(0x91)],_0x442d9d,_0x2f2f13[_0x90f03a(0xad)]()[_0x90f03a(0xa6)](_0x90f03a(0x82))),_0x58cd0e=await insertZip(_0xe2cf08,_0x24e23c,_0x16f64f[_0x90f03a(0x91)],_0x442d9d,_0x5868dd['toBuffer']()[_0x90f03a(0xa6)](_0x90f03a(0x82)));return _0x49032c+','+_0x58cd0e;}else return await insertZip(_0xe2cf08,_0x24e23c,_0x16f64f[_0x90f03a(0x91)],_0x442d9d,_0xf28f6f);}catch(_0x2cac25){throw _0x2cac25;}finally{if(await fs_internal_1['FS'][_0x90f03a(0x86)](path_1[_0x90f03a(0x8b)][_0x90f03a(0xc3)](process[_0x90f03a(0xaa)](),_0x90f03a(0xa8),_0x1c8bf7)))await(0x0,promises_1['rm'])(path_1[_0x90f03a(0x8b)][_0x90f03a(0xc3)](process['cwd'](),_0x90f03a(0xa8),_0x1c8bf7),{'recursive':!![]});}}exports[a86_0x2e06f5(0x8f)]=generateAndDeployZip;async function getComponents(_0x3982c5,_0x1df8ec,_0x3bf5ba){const _0x55a0c4=a86_0x2e06f5,_0x47c206=[],_0x2370ef=await(0x0,fetch_attachments_1[_0x55a0c4(0xd5)])(_0x3982c5,_0x1df8ec);return await getComponentFromZip(_0x2370ef,_0x3bf5ba)[_0x55a0c4(0x7f)](_0x4d2e74=>{const _0x735634=_0x55a0c4;_0x47c206[_0x735634(0xc6)](..._0x4d2e74);}),_0x47c206;}function a86_0x1487(){const _0x44bb36=['default','http://soap.sforce.com/2006/04/metadata','../../../constants','Profile','generateAndDeployZip','11575050qMuxLZ','orgId','Body','uuid','ParentId','find','type','destructiveChangesPre.xml','ComponentsApi','unzip','fetchComponentsDetailsByComponentsHistory','files','Zip','fileName','log','async','fetchAttachmentsDetailsById','types','Name','16sSuhAr','file','2931798nRMtDX','toString','DEPLOYZIP','.temp','text','cwd','dir','fileType','toBuffer','defineProperty','search','indexOf','/services/data/','560217NMFWIj','DEFLATE','destructiveChangesPost.xml','splitZip','fetchAttachmentBody','../utils/components-api','/sobjects/Attachment','writeFile','replace','MDApiWriter','adm-zip','src','start','1942104TddGJn','generateAsync','buildObject','Component_Name__c','join','2643767guyYPk','reduce','push','length','69272uQtamr','every','body','map','createZip','__esModule','MAX_ZIP_SIZE','name','after\x20create\x20zip','Component__r','substring','addLocalFolder','../../git/parsers/utils/zip','retrieveAttachments','fs/promises','UTF-8','../../git/parsers/mdapi','__importDefault','PermissionSet','extractComponentPermissions','values','10wXVsQi','filter','then','Builder','1521qBwhot','base64','1.0','../../shared/utils/fetch-attachments','(((.+)+)+)+$','exists','282488pToAPz','Package','../../git/internal/fs.internal','apply'];a86_0x1487=function(){return _0x44bb36;};return a86_0x1487();}async function getComponentFromZip(_0x550a8e,_0x18056a){const _0x597155=a86_0x2e06f5,_0x56fb71=[];for(const _0x1de2a5 of _0x550a8e){const _0x5dde36=await zip_1[_0x597155(0x9c)][_0x597155(0x99)](_0x1de2a5[_0x597155(0xdc)]['Body']);for(const _0x2f85f0 in _0x5dde36[_0x597155(0x9b)]){!_0x5dde36['files'][_0x2f85f0]['dir']&&_0x56fb71['push']({'fileName':_0x2f85f0[_0x597155(0xd2)](_0x2f85f0[_0x597155(0xb0)]('/')+0x1),'fileType':_0x18056a[_0x1de2a5['id']],'body':_0x1de2a5[_0x597155(0xdc)][_0x597155(0x92)]});}}return _0x56fb71;}async function removePermission(_0x4392a7,_0x75b46b){const _0x37f91c=a86_0x2e06f5;for(const _0xdfe61 of _0x4392a7){const _0x2a21ba=await zip_1[_0x37f91c(0x9c)][_0x37f91c(0x99)](_0xdfe61[_0x37f91c(0xca)]),_0x54a964=[];for(const _0x1dddc0 in _0x2a21ba['files']){!_0x2a21ba[_0x37f91c(0x9b)][_0x1dddc0][_0x37f91c(0xab)]&&_0x54a964[_0x37f91c(0xc6)]({'fileName':_0x1dddc0,'body':await _0x2a21ba[_0x37f91c(0x9b)][_0x1dddc0][_0x37f91c(0x9f)](_0x37f91c(0xa9))});}const _0x2865df=await(0x0,extract_component_permissions_1[_0x37f91c(0xdb)])(_0x54a964[0x0][_0x37f91c(0xca)][_0x37f91c(0xa6)](),_0x75b46b,_0xdfe61[_0x37f91c(0xac)]),_0x26081f=new xml2js_1['Builder']({'xmldec':{'version':_0x37f91c(0x83),'encoding':_0x37f91c(0xd7)}}),_0x5e825c=_0x26081f[_0x37f91c(0xc1)](_0x2865df),_0x46cd13=zip_1[_0x37f91c(0x9c)][_0x37f91c(0xcc)]();_0x46cd13[_0x37f91c(0xa4)](_0x54a964[0x0][_0x37f91c(0x9d)],_0x5e825c),_0xdfe61['body']=await _0x46cd13[_0x37f91c(0xc0)]({'type':_0x37f91c(0x82),'compression':_0x37f91c(0xb3),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x2bd436,_0x260d38,_0x8ab115){const _0x4abfa4=a86_0x2e06f5;for(const _0x332771 of _0x8ab115){if(_0x2bd436[_0x4abfa4(0xc9)](_0x55abcb=>_0x55abcb!==_0x332771[_0x4abfa4(0xac)]))continue;const _0x55eb3b=await zip_1[_0x4abfa4(0x9c)][_0x4abfa4(0x99)](_0x332771[_0x4abfa4(0xca)]);for(const _0x2470c9 in _0x55eb3b[_0x4abfa4(0x9b)]){if(!_0x55eb3b[_0x4abfa4(0x9b)][_0x2470c9][_0x4abfa4(0xab)]){let _0x4d9c64=await _0x55eb3b['files'][_0x2470c9][_0x4abfa4(0x9f)](_0x4abfa4(0xa9));for(const _0x1730f2 of Object['keys'](_0x260d38)){const _0x3311ac=new RegExp('%%'+_0x1730f2+'%%','g');_0x4d9c64=_0x4d9c64[_0x4abfa4(0xba)](_0x3311ac,_0x260d38[_0x1730f2]);}_0x55eb3b[_0x4abfa4(0xa4)](_0x2470c9,_0x4d9c64);}}_0x332771['body']=await _0x55eb3b[_0x4abfa4(0xc0)]({'type':_0x4abfa4(0x82),'compression':_0x4abfa4(0xb3),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x43ca73,_0x526065){const _0x2a6d98=a86_0x2e06f5,_0x2cd8c5=new mdapi_1[(_0x2a6d98(0xbb))]({'components':_0x43ca73,'sourceDir':path_1[_0x2a6d98(0x8b)][_0x2a6d98(0xc3)](process['cwd'](),'.temp',_0x526065,DEPLOY_DIR_NAME,_0x2a6d98(0xbd)),'skipChildErrors':![]});await _0x2cd8c5[_0x2a6d98(0xbe)]();}async function generateAndWritePackageXML(_0x55c101,_0x5392d4,_0x1ab47b){const _0x214ab8=a86_0x2e06f5,_0x446404=getComponentsTypeAndName(_0x55c101,_0x5392d4),_0x393113=[...new Set(_0x446404[_0x214ab8(0xcb)](_0xc23eb9=>_0xc23eb9[_0x214ab8(0x96)]))],_0x282b2f={'Package':{'$':{'xmlns':_0x214ab8(0x8c)},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION']['substring'](0x1)}};for(const _0x22a1e7 of _0x393113){const _0x597e61=_0x446404[_0x214ab8(0xde)](_0x4956f3=>_0x4956f3[_0x214ab8(0x96)]===_0x22a1e7)[_0x214ab8(0xcb)](_0x124e84=>_0x124e84[_0x214ab8(0xcf)]),_0x36b379={'members':_0x597e61,'name':_0x22a1e7};_0x282b2f[_0x214ab8(0x88)][_0x214ab8(0xa1)][_0x214ab8(0xc6)](_0x36b379);}const _0xb54297=new xml2js_1[(_0x214ab8(0x80))]({'xmldec':{'version':_0x214ab8(0x83),'encoding':_0x214ab8(0xd7)}}),_0xa84215=_0xb54297[_0x214ab8(0xc1)](_0x282b2f);await fs_internal_1['FS'][_0x214ab8(0xb9)](path_1[_0x214ab8(0x8b)]['join'](process[_0x214ab8(0xaa)](),_0x214ab8(0xa8),_0x1ab47b,DEPLOY_DIR_NAME,'src','package.xml'),_0xa84215);}function getComponentsTypeAndName(_0x4958b4,_0x3b093a){return _0x4958b4['reduce']((_0xfe4b39,_0x127d4a)=>{const _0x15497e=a86_0x4213,_0x3b98ca=_0x3b093a[_0x15497e(0x95)](_0x2b0024=>_0x2b0024['Id']===_0x127d4a[_0x15497e(0x94)]);return _0x3b98ca&&_0xfe4b39[_0x15497e(0xc6)]({'name':_0x3b98ca[_0x15497e(0xd1)][_0x15497e(0xc2)],'type':_0x127d4a[_0x15497e(0xa2)]}),_0xfe4b39;},[]);}async function saveDestructiveChanges(_0x583ecb,_0x25aef2,_0x129b82,_0x120c00){const _0x313d4d=a86_0x2e06f5,_0x43c8af=(await(0x0,fetch_attachments_1[_0x313d4d(0xb6)])(_0x583ecb,_0x25aef2))['toString']();await fs_internal_1['FS'][_0x313d4d(0xb9)](path_1[_0x313d4d(0x8b)]['join'](process[_0x313d4d(0xaa)](),_0x313d4d(0xa8),_0x120c00,DEPLOY_DIR_NAME,'src',_0x129b82),_0x43c8af);}function a86_0x4213(_0x58c803,_0x1d492e){const _0x416c4b=a86_0x1487();return a86_0x4213=function(_0xe413b1,_0x24016d){_0xe413b1=_0xe413b1-0x7f;let _0x148756=_0x416c4b[_0xe413b1];return _0x148756;},a86_0x4213(_0x58c803,_0x1d492e);}async function createDeployZip(_0x2a17b7){const _0x1e0bea=a86_0x2e06f5,_0x509537=new adm_zip_1[(_0x1e0bea(0x8b))]();return await _0x509537[_0x1e0bea(0xd3)](path_1['default'][_0x1e0bea(0xc3)](process[_0x1e0bea(0xaa)](),_0x1e0bea(0xa8),_0x2a17b7,DEPLOY_DIR_NAME)),_0x509537;}async function insertZip(_0x399379,_0x388716,_0x5919f4,_0x1e8311,_0x4c05f3){const _0x38b358=a86_0x2e06f5,_0x3e33ae={'ParentId':_0x388716,'Name':'BUILD'+_0x5919f4,'Description':'BUILD'+_0x1e8311,'Body':_0x4c05f3},{data:_0x4ac7e3}=await _0x399379['post'](_0x38b358(0xb1)+constants_1['SALESFORCE_API_VERSION']+_0x38b358(0xb8),_0x3e33ae);return _0x4ac7e3['id'];}