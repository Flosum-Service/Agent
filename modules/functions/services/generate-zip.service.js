const a87_0xaf4f2a=a87_0xfcb6;(function(_0x16a677,_0x5e9f3f){const _0x20539c=a87_0xfcb6,_0x47fc54=_0x16a677();while(!![]){try{const _0x1a9227=-parseInt(_0x20539c(0x18e))/0x1*(-parseInt(_0x20539c(0x198))/0x2)+-parseInt(_0x20539c(0x1ed))/0x3+parseInt(_0x20539c(0x1e4))/0x4*(parseInt(_0x20539c(0x1cb))/0x5)+parseInt(_0x20539c(0x1ae))/0x6*(parseInt(_0x20539c(0x19f))/0x7)+-parseInt(_0x20539c(0x193))/0x8+parseInt(_0x20539c(0x1a2))/0x9+-parseInt(_0x20539c(0x1c4))/0xa*(-parseInt(_0x20539c(0x1e5))/0xb);if(_0x1a9227===_0x5e9f3f)break;else _0x47fc54['push'](_0x47fc54['shift']());}catch(_0x4014d9){_0x47fc54['push'](_0x47fc54['shift']());}}}(a87_0x37fa,0x483a7));function a87_0x37fa(){const _0x159e28=['Component_Name__c','1.0','join','mergeComponentPermissions','MetadataConstants','search','generateAsync','default','6IMGxdb','MetadataType','adm-zip','http://soap.sforce.com/2006/04/metadata','fetchAttachmentsDetailsById','Name','src','Body','.temp','unzip','type','then','generateAndDeployZip','name','orgId','../../git/writers/mdapi.writer','Zip','fileName','dir','PERMISSION_SET','../classes/logger','exists','6580ugmWRU','files','buildObject','uuid','Logger','set','Builder','749860gdUiPm','reduce','(((.+)+)+)+$','constructor','writeFile','text','cwd','push','MDApiWriter','PermissionSet','toBuffer','fs/promises','find','post','filter','extractComponentPermissions','Package','listMetadataItem','keys','substring','../../git/parsers/utils/zip','permissionsets','/services/data/v','fetchAttachmentBody','UTF-8','4zOuLRX','1177uABEEx','/sobjects/Attachment','ParentId','BUILD','../../git/internal/fs.internal','DEFLATE','base64','package.xml','1093143ZQCsIB','execute','values','4443htntAi','map','destructiveChangesPre.xml','toString','__esModule','618848MloMKk','xml2js','fetchComponentsDetailsByComponentsHistory','ComponentsApi','../utils/extract-component-permissions','92ETGIMR','Profile','createZip','body','get','PartialRetrieve','fileType','546119MzkrVZ','types','addLocalFolder','2113299lOauag','length','async','@flosum/salesforce'];a87_0x37fa=function(){return _0x159e28;};return a87_0x37fa();}const a87_0xb44b68=(function(){let _0x24e2ef=!![];return function(_0x53c24e,_0x232626){const _0x54acc6=_0x24e2ef?function(){if(_0x232626){const _0x98ed87=_0x232626['apply'](_0x53c24e,arguments);return _0x232626=null,_0x98ed87;}}:function(){};return _0x24e2ef=![],_0x54acc6;};}()),a87_0x1fa915=a87_0xb44b68(this,function(){const _0x131735=a87_0xfcb6;return a87_0x1fa915[_0x131735(0x191)]()[_0x131735(0x1ab)](_0x131735(0x1cd))[_0x131735(0x191)]()[_0x131735(0x1ce)](a87_0x1fa915)[_0x131735(0x1ab)](_0x131735(0x1cd));});a87_0x1fa915();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3d9633){const _0x2bcb58=a87_0xfcb6;return _0x3d9633&&_0x3d9633[_0x2bcb58(0x192)]?_0x3d9633:{'default':_0x3d9633};};function a87_0xfcb6(_0x216cef,_0x427c3a){const _0x133de3=a87_0x37fa();return a87_0xfcb6=function(_0x1fa915,_0xb44b68){_0x1fa915=_0x1fa915-0x18c;let _0x37faeb=_0x133de3[_0x1fa915];return _0x37faeb;},a87_0xfcb6(_0x216cef,_0x427c3a);}Object['defineProperty'](exports,a87_0xaf4f2a(0x192),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require(a87_0xaf4f2a(0x197)),logger_1=require(a87_0xaf4f2a(0x1c2)),xml2js_1=require(a87_0xaf4f2a(0x194)),zip_1=require(a87_0xaf4f2a(0x1df)),mdapi_writer_1=require(a87_0xaf4f2a(0x1bd)),fs_internal_1=require(a87_0xaf4f2a(0x1e9)),promises_1=require(a87_0xaf4f2a(0x1d6)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a87_0xaf4f2a(0x1b0))),uuid_1=require(a87_0xaf4f2a(0x1c7)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a87_0xaf4f2a(0x1a5)),DESTRUCTIVE_CHANGES_PER_NAME=a87_0xaf4f2a(0x190),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME='DEPLOYZIP',PERMISSION_SET_FOLDER_NAME=a87_0xaf4f2a(0x1e0);async function generateAndDeployZip({attachmentsId:_0x4bd29a,isExtractComponentsPermissionSets:_0x3873b2,isExtractComponentsProfiles:_0x51456a,preDestructiveAttachmentId:_0x13e5da,postDestructiveAttachmentId:_0x85110d,branchId:_0x47782d,credentials:_0x379f23,metadataLogId:_0x4e9952,environments:_0x3613c9,metaTypes:_0x497d66,apiVersion:_0x223a7c},_0x161d6f,_0x6fb8a0){const _0x559f88=a87_0xaf4f2a,_0x422733=(0x0,uuid_1['v4'])();try{const _0x316f10=await(0x0,fetch_attachments_1[_0x559f88(0x1b2)])(_0x161d6f,_0x4bd29a),_0x5ebcc4=_0x316f10[_0x559f88(0x1cc)]((_0x53b70c,_0x376cbf)=>({..._0x53b70c,[_0x376cbf['Id']]:_0x376cbf[_0x559f88(0x1b3)]}),{}),_0x5e8055=await getComponents(_0x316f10,_0x161d6f,_0x5ebcc4),_0x3f16c1=await components_api_1[_0x559f88(0x196)][_0x559f88(0x195)](_0x161d6f,_0x316f10[_0x559f88(0x18f)](({ParentId:_0x2c0289})=>_0x2c0289),_0x223a7c)[_0x559f88(0x1b9)](_0x3ee7aa=>components_api_1[_0x559f88(0x196)]['removeNamespacePrefix'](_0x3ee7aa));if(_0x51456a){const _0x11baa6=_0x5e8055[_0x559f88(0x1d9)](({fileType:_0x15fc30})=>_0x15fc30===_0x559f88(0x199));await removePermission(_0x11baa6,_0x3f16c1);}const _0x2e8abf=_0x5e8055[_0x559f88(0x1d9)](({fileType:_0xe474d3})=>_0xe474d3===_0x559f88(0x1d4));if(_0x2e8abf){_0x3873b2&&await removePermission(_0x2e8abf,_0x3f16c1);const {items:{PermissionSet:{components:_0x4b248a}}}=await retrieveTargetPermissionSets(_0x2e8abf,_0x223a7c,_0x6fb8a0);await mergePermissionSets(_0x2e8abf,_0x4b248a);}await replaceEnvironments(_0x497d66,_0x3613c9,_0x5e8055),await writeZip(_0x5e8055,_0x422733),await generateAndWritePackageXML(_0x316f10,_0x3f16c1,_0x422733,_0x223a7c);_0x13e5da&&await saveDestructiveChanges(_0x161d6f,_0x13e5da,DESTRUCTIVE_CHANGES_PER_NAME,_0x422733);_0x85110d&&await saveDestructiveChanges(_0x161d6f,_0x85110d,DESTRUCTIVE_CHANGES_POST_NAME,_0x422733);const _0x334702=(await createDeployZip(_0x422733)[_0x559f88(0x1b9)](_0x312e00=>{return _0x312e00;}))['toBuffer']()[_0x559f88(0x191)](_0x559f88(0x1eb)),_0x208655=_0x334702[_0x559f88(0x1a3)];if(_0x208655>=components_api_1['MAX_ZIP_SIZE']){const _0x12fc6f=await createDeployZip(_0x422733),[_0x75b993,_0x4274dc]=await components_api_1[_0x559f88(0x196)]['splitZip'](_0x12fc6f,_0x208655),_0x43dc99=await insertZip(_0x161d6f,_0x47782d,_0x379f23['orgId'],_0x4e9952,_0x75b993[_0x559f88(0x1d5)]()[_0x559f88(0x191)](_0x559f88(0x1eb)),_0x223a7c),_0xaf76b9=await insertZip(_0x161d6f,_0x47782d,_0x379f23[_0x559f88(0x1bc)],_0x4e9952,_0x4274dc[_0x559f88(0x1d5)]()[_0x559f88(0x191)](_0x559f88(0x1eb)),_0x223a7c);return _0x43dc99+','+_0xaf76b9;}else return await insertZip(_0x161d6f,_0x47782d,_0x379f23[_0x559f88(0x1bc)],_0x4e9952,_0x334702,_0x223a7c);}catch(_0x5da630){throw _0x5da630;}finally{if(await fs_internal_1['FS'][_0x559f88(0x1c3)](path_1[_0x559f88(0x1ad)][_0x559f88(0x1a8)](process[_0x559f88(0x1d1)](),_0x559f88(0x1b6),_0x422733)))await(0x0,promises_1['rm'])(path_1['default'][_0x559f88(0x1a8)](process[_0x559f88(0x1d1)](),'.temp',_0x422733),{'recursive':!![]});}}exports[a87_0xaf4f2a(0x1ba)]=generateAndDeployZip;async function getComponents(_0x5c360f,_0xbee0fc,_0x2f8fe3){const _0xe4ab86=a87_0xaf4f2a,_0x15fc90=[],_0x1613b8=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x5c360f,_0xbee0fc);return await getComponentFromZip(_0x1613b8,_0x2f8fe3)[_0xe4ab86(0x1b9)](_0x3ac3e3=>{const _0x4b9ad8=_0xe4ab86;_0x15fc90[_0x4b9ad8(0x1d2)](..._0x3ac3e3);}),_0x15fc90;}async function getComponentFromZip(_0x300e2d,_0x507202){const _0x581a54=a87_0xaf4f2a,_0x2db5e8=[];for(const _0x42cfc8 of _0x300e2d){const _0x199e2b=await zip_1[_0x581a54(0x1be)][_0x581a54(0x1b7)](_0x42cfc8['values'][_0x581a54(0x1b5)]);for(const _0x13c0e6 in _0x199e2b[_0x581a54(0x1c5)]){!_0x199e2b[_0x581a54(0x1c5)][_0x13c0e6]['dir']&&_0x2db5e8['push']({'fileName':_0x13c0e6[_0x581a54(0x1de)](_0x13c0e6['indexOf']('/')+0x1),'fileType':_0x507202[_0x42cfc8['id']],'body':_0x42cfc8[_0x581a54(0x18d)][_0x581a54(0x1b5)]});}}return _0x2db5e8;}async function removePermission(_0x161dae,_0x15ce4f){const _0x226ed6=a87_0xaf4f2a;for(const _0x24ec3d of _0x161dae){const _0xe63e0d=await zip_1['Zip'][_0x226ed6(0x1b7)](_0x24ec3d[_0x226ed6(0x19b)]),_0x56bee0=[];for(const _0x550cc6 in _0xe63e0d[_0x226ed6(0x1c5)]){!_0xe63e0d['files'][_0x550cc6]['dir']&&_0x56bee0[_0x226ed6(0x1d2)]({'fileName':_0x550cc6,'body':await _0xe63e0d['files'][_0x550cc6][_0x226ed6(0x1a4)]('text')});}const _0x188074=await(0x0,extract_component_permissions_1[_0x226ed6(0x1da)])(_0x56bee0[0x0][_0x226ed6(0x19b)][_0x226ed6(0x191)](),_0x15ce4f,_0x24ec3d[_0x226ed6(0x19e)]),_0x3907e9=new xml2js_1[(_0x226ed6(0x1ca))]({'xmldec':{'version':'1.0','encoding':_0x226ed6(0x1e3)}}),_0x15908f=_0x3907e9['buildObject'](_0x188074),_0x1a5010=zip_1[_0x226ed6(0x1be)][_0x226ed6(0x19a)]();_0x1a5010['file'](_0x56bee0[0x0][_0x226ed6(0x1bf)],_0x15908f),_0x24ec3d[_0x226ed6(0x19b)]=await _0x1a5010[_0x226ed6(0x1ac)]({'type':'base64','compression':_0x226ed6(0x1ea),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x71878e,_0x39ef50,_0xc75bbd){const _0x215537=a87_0xaf4f2a,_0x2983f9=_0x71878e[_0x215537(0x18f)](_0x2dfd72=>PERMISSION_SET_FOLDER_NAME+'/'+_0x2dfd72[_0x215537(0x1bf)])['join'](';'),_0x1fc5eb=[{'field':'fileName','option':salesforce_1['DeclarativeFilterOptions']['IN'],'value':_0x2983f9}],_0xf24dc0=new logger_1[(_0x215537(0x1c8))]();return new salesforce_1[(_0x215537(0x19d))](_0x39ef50,_0xc75bbd,_0xf24dc0,_0x1fc5eb,null,[salesforce_1[_0x215537(0x1af)][_0x215537(0x1c1)]])[_0x215537(0x18c)]();}async function mergePermissionSets(_0xdc92cc,_0x238bda){const _0x47309d=a87_0xaf4f2a,_0x448a77=_0x238bda['reduce']((_0x423eaa,_0x5275e6)=>_0x423eaa[_0x47309d(0x1c9)](_0x5275e6[_0x47309d(0x1dc)][_0x47309d(0x1bf)],_0x5275e6),new Map());for(const _0x506dbf of _0xdc92cc){const _0x3e02be=PERMISSION_SET_FOLDER_NAME+'/'+_0x506dbf[_0x47309d(0x1bf)],_0x3caba8=_0x448a77[_0x47309d(0x19c)](_0x3e02be);if(!_0x3caba8)continue;const _0x456ef9=await zip_1[_0x47309d(0x1be)][_0x47309d(0x1b7)](_0x506dbf[_0x47309d(0x19b)]),_0x34dfd6=await _0x456ef9[_0x47309d(0x1c5)][_0x3e02be][_0x47309d(0x1a4)](_0x47309d(0x1d0)),_0x167f1e=_0x3caba8[_0x47309d(0x1c5)][_0x3e02be][_0x47309d(0x191)](),_0x266a20=await(0x0,extract_component_permissions_1[_0x47309d(0x1a9)])(_0x34dfd6,_0x167f1e,_0x506dbf[_0x47309d(0x19e)]),_0x249fd1=zip_1[_0x47309d(0x1be)]['createZip']();_0x249fd1['file'](_0x3e02be,_0x266a20),_0x506dbf['body']=await _0x249fd1[_0x47309d(0x1ac)]({'type':_0x47309d(0x1eb),'compression':_0x47309d(0x1ea),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x4173c8,_0x34beb1,_0x2dd9ed){const _0x516663=a87_0xaf4f2a;for(const _0x3ddde5 of _0x2dd9ed){if(_0x4173c8['every'](_0x410cf8=>_0x410cf8!==_0x3ddde5[_0x516663(0x19e)]))continue;const _0x2990a0=await zip_1[_0x516663(0x1be)]['unzip'](_0x3ddde5[_0x516663(0x19b)]);for(const _0x5bc24b in _0x2990a0[_0x516663(0x1c5)]){if(!_0x2990a0[_0x516663(0x1c5)][_0x5bc24b][_0x516663(0x1c0)]){let _0x16b7c2=await _0x2990a0[_0x516663(0x1c5)][_0x5bc24b][_0x516663(0x1a4)](_0x516663(0x1d0));for(const _0x1d3642 of Object[_0x516663(0x1dd)](_0x34beb1)){const _0x15b937=new RegExp('%%'+_0x1d3642+'%%','g');_0x16b7c2=_0x16b7c2['replace'](_0x15b937,_0x34beb1[_0x1d3642]);}_0x2990a0['file'](_0x5bc24b,_0x16b7c2);}}_0x3ddde5[_0x516663(0x19b)]=await _0x2990a0[_0x516663(0x1ac)]({'type':_0x516663(0x1eb),'compression':_0x516663(0x1ea),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x29bbb2,_0x408d00){const _0x10f514=a87_0xaf4f2a,_0x497878=new mdapi_writer_1[(_0x10f514(0x1d3))]({'components':_0x29bbb2,'sourceDir':path_1[_0x10f514(0x1ad)]['join'](process[_0x10f514(0x1d1)](),_0x10f514(0x1b6),_0x408d00,DEPLOY_DIR_NAME,_0x10f514(0x1b4)),'skipChildErrors':![]});await _0x497878[_0x10f514(0x18c)]();}async function generateAndWritePackageXML(_0x35f784,_0x362952,_0x47be50,_0x24e370){const _0x4a4a2d=a87_0xaf4f2a,_0x3c1799=getComponentsTypeAndName(_0x35f784,_0x362952),_0x5afcc3=[...new Set(_0x3c1799['map'](_0x7b9be6=>_0x7b9be6[_0x4a4a2d(0x1b8)]))],_0x5143c4={'Package':{'$':{'xmlns':_0x4a4a2d(0x1b1)},'types':[],'version':''+_0x24e370}};for(const _0x5f2592 of _0x5afcc3){const _0x539ebb=_0x3c1799[_0x4a4a2d(0x1d9)](_0x1e131a=>_0x1e131a[_0x4a4a2d(0x1b8)]===_0x5f2592)[_0x4a4a2d(0x18f)](_0x2c53b3=>_0x2c53b3[_0x4a4a2d(0x1bb)]),_0x14e23a={'members':_0x539ebb,'name':_0x5f2592};_0x5143c4[_0x4a4a2d(0x1db)][_0x4a4a2d(0x1a0)][_0x4a4a2d(0x1d2)](_0x14e23a);}const _0x5bad5d=new xml2js_1[(_0x4a4a2d(0x1ca))]({'xmldec':{'version':_0x4a4a2d(0x1a7),'encoding':_0x4a4a2d(0x1e3)}}),_0x1544e4=_0x5bad5d[_0x4a4a2d(0x1c6)](_0x5143c4);await fs_internal_1['FS']['writeFile'](path_1['default']['join'](process[_0x4a4a2d(0x1d1)](),_0x4a4a2d(0x1b6),_0x47be50,DEPLOY_DIR_NAME,_0x4a4a2d(0x1b4),_0x4a4a2d(0x1ec)),_0x1544e4);}function getComponentsTypeAndName(_0x220b3c,_0x3ba72f){const _0x4581f4=a87_0xaf4f2a;return _0x220b3c[_0x4581f4(0x1cc)]((_0x393ec7,_0x3afbff)=>{const _0x3fdd55=_0x4581f4,_0x4bcff2=_0x3ba72f[_0x3fdd55(0x1d7)](_0x4d2fa3=>_0x4d2fa3['Id']===_0x3afbff[_0x3fdd55(0x1e7)]);return _0x4bcff2&&_0x393ec7[_0x3fdd55(0x1d2)]({'name':_0x4bcff2['Component__r'][_0x3fdd55(0x1a6)],'type':salesforce_1[_0x3fdd55(0x1aa)]['FOLDER_TO_METADATA_TYPE_MAP'][_0x3afbff[_0x3fdd55(0x1b3)]]||_0x3afbff[_0x3fdd55(0x1b3)]}),_0x393ec7;},[]);}async function saveDestructiveChanges(_0x433cf8,_0x20465a,_0x255723,_0x3bfabd){const _0x16c052=a87_0xaf4f2a,_0x94298b=(await(0x0,fetch_attachments_1[_0x16c052(0x1e2)])(_0x433cf8,_0x20465a))[_0x16c052(0x191)]();await fs_internal_1['FS'][_0x16c052(0x1cf)](path_1[_0x16c052(0x1ad)][_0x16c052(0x1a8)](process[_0x16c052(0x1d1)](),_0x16c052(0x1b6),_0x3bfabd,DEPLOY_DIR_NAME,_0x16c052(0x1b4),_0x255723),_0x94298b);}async function createDeployZip(_0x3bd1eb){const _0x25a731=a87_0xaf4f2a,_0x40ff59=new adm_zip_1[(_0x25a731(0x1ad))]();return await _0x40ff59[_0x25a731(0x1a1)](path_1[_0x25a731(0x1ad)]['join'](process[_0x25a731(0x1d1)](),_0x25a731(0x1b6),_0x3bd1eb,DEPLOY_DIR_NAME)),_0x40ff59;}async function insertZip(_0x259501,_0x281ef1,_0x481dfe,_0x41e8ce,_0x92cfeb,_0x49d467){const _0x243f7e=a87_0xaf4f2a,_0x47eb77={'ParentId':_0x281ef1,'Name':'BUILD'+_0x481dfe,'Description':_0x243f7e(0x1e8)+_0x41e8ce,'Body':_0x92cfeb},{data:_0x1ec825}=await _0x259501[_0x243f7e(0x1d8)](_0x243f7e(0x1e1)+_0x49d467+_0x243f7e(0x1e6),_0x47eb77);return _0x1ec825['id'];}