const a86_0x220e0d=a86_0x119d;(function(_0x587e3d,_0x479d2d){const _0x4186a5=a86_0x119d,_0x47d55d=_0x587e3d();while(!![]){try{const _0x5b97a3=-parseInt(_0x4186a5(0xa8))/0x1+parseInt(_0x4186a5(0xc7))/0x2*(-parseInt(_0x4186a5(0xcd))/0x3)+-parseInt(_0x4186a5(0xea))/0x4+parseInt(_0x4186a5(0xe4))/0x5*(-parseInt(_0x4186a5(0xf0))/0x6)+parseInt(_0x4186a5(0xe6))/0x7*(parseInt(_0x4186a5(0xd4))/0x8)+-parseInt(_0x4186a5(0xc8))/0x9*(parseInt(_0x4186a5(0xa1))/0xa)+-parseInt(_0x4186a5(0xbe))/0xb*(-parseInt(_0x4186a5(0xc0))/0xc);if(_0x5b97a3===_0x479d2d)break;else _0x47d55d['push'](_0x47d55d['shift']());}catch(_0x351865){_0x47d55d['push'](_0x47d55d['shift']());}}}(a86_0xa808,0xc6601));const a86_0x435cda=(function(){let _0x4a8493=!![];return function(_0x3a1d45,_0x13f34a){const _0x2fdc6e=_0x4a8493?function(){const _0x5a24d7=a86_0x119d;if(_0x13f34a){const _0x45dad8=_0x13f34a[_0x5a24d7(0xda)](_0x3a1d45,arguments);return _0x13f34a=null,_0x45dad8;}}:function(){};return _0x4a8493=![],_0x2fdc6e;};}()),a86_0x18f1e5=a86_0x435cda(this,function(){const _0x4365e6=a86_0x119d;return a86_0x18f1e5[_0x4365e6(0xa7)]()[_0x4365e6(0xe5)](_0x4365e6(0xe7))[_0x4365e6(0xa7)]()[_0x4365e6(0xc6)](a86_0x18f1e5)[_0x4365e6(0xe5)](_0x4365e6(0xe7));});a86_0x18f1e5();'use strict';var __importDefault=this&&this[a86_0x220e0d(0xd5)]||function(_0x9ac30c){const _0x312bdd=a86_0x220e0d;return _0x9ac30c&&_0x9ac30c[_0x312bdd(0x9c)]?_0x9ac30c:{'default':_0x9ac30c};};Object[a86_0x220e0d(0xdd)](exports,'__esModule',{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a86_0x220e0d(0xa2)),zip_1=require(a86_0x220e0d(0xe3)),mdapi_1=require(a86_0x220e0d(0x9d)),fs_internal_1=require(a86_0x220e0d(0xf3)),promises_1=require(a86_0x220e0d(0xba)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a86_0x220e0d(0xd8))),uuid_1=require(a86_0x220e0d(0xb2)),fetch_attachments_1=require(a86_0x220e0d(0x9e)),salesforce_1=require(a86_0x220e0d(0xd9)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x220e0d(0x9b),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x220e0d(0x98),DEPLOY_DIR_NAME=a86_0x220e0d(0xef);async function generateAndDeployZip({attachmentsId:_0x59e2d0,isExtractComponentsPermissions:_0x5c88ff,preDestructiveAttachmentId:_0x22c530,postDestructiveAttachmentId:_0x95cd29,branchId:_0x1d90dc,credentials:_0x3c4d3a,metadataLogId:_0x3766fc,environments:_0x297324,metaTypes:_0x118af3,apiVersion:_0x1e55f3},_0x4fad38){const _0x379587=a86_0x220e0d,_0x5f0421=(0x0,uuid_1['v4'])();try{const _0x546b99=await(0x0,fetch_attachments_1[_0x379587(0xaf)])(_0x4fad38,_0x59e2d0),_0x36cbed=_0x546b99['reduce']((_0x44d1c8,_0x509ed1)=>({..._0x44d1c8,[_0x509ed1['Id']]:_0x509ed1[_0x379587(0xb5)]}),{}),_0x42ab06=await getComponents(_0x546b99,_0x4fad38,_0x36cbed),_0x1bcbe9=await components_api_1[_0x379587(0xb9)][_0x379587(0xf1)](_0x4fad38,_0x546b99[_0x379587(0xab)](({ParentId:_0x4a5e4d})=>_0x4a5e4d),_0x1e55f3)[_0x379587(0xed)](_0x1b1e78=>components_api_1['ComponentsApi']['removeNamespacePrefix'](_0x1b1e78));if(_0x5c88ff){const _0x36258d=_0x42ab06[_0x379587(0xe8)](({fileType:_0x1eb4cd})=>_0x1eb4cd===_0x379587(0xac));await removePermission(_0x36258d,_0x1bcbe9);}await replaceEnvironments(_0x118af3,_0x297324,_0x42ab06),await writeZip(_0x42ab06,_0x5f0421),await generateAndWritePackageXML(_0x546b99,_0x1bcbe9,_0x5f0421,_0x1e55f3);_0x22c530&&await saveDestructiveChanges(_0x4fad38,_0x22c530,DESTRUCTIVE_CHANGES_PER_NAME,_0x5f0421);_0x95cd29&&await saveDestructiveChanges(_0x4fad38,_0x95cd29,DESTRUCTIVE_CHANGES_POST_NAME,_0x5f0421);const _0x3d263d=(await createDeployZip(_0x5f0421)[_0x379587(0xed)](_0x327e9a=>{return _0x327e9a;}))[_0x379587(0xe2)]()[_0x379587(0xa7)](_0x379587(0xa9)),_0x530d80=_0x3d263d[_0x379587(0xdc)];if(_0x530d80>=components_api_1[_0x379587(0xc3)]){const _0x366eda=await createDeployZip(_0x5f0421),[_0x2bd128,_0x501125]=await components_api_1[_0x379587(0xb9)]['splitZip'](_0x366eda,_0x530d80),_0x42c76c=await insertZip(_0x4fad38,_0x1d90dc,_0x3c4d3a['orgId'],_0x3766fc,_0x2bd128[_0x379587(0xe2)]()[_0x379587(0xa7)](_0x379587(0xa9)),_0x1e55f3),_0x450c2f=await insertZip(_0x4fad38,_0x1d90dc,_0x3c4d3a[_0x379587(0xca)],_0x3766fc,_0x501125[_0x379587(0xe2)]()[_0x379587(0xa7)]('base64'),_0x1e55f3);return _0x42c76c+','+_0x450c2f;}else return await insertZip(_0x4fad38,_0x1d90dc,_0x3c4d3a[_0x379587(0xca)],_0x3766fc,_0x3d263d,_0x1e55f3);}catch(_0x214ec2){throw _0x214ec2;}finally{if(await fs_internal_1['FS'][_0x379587(0xd6)](path_1[_0x379587(0xd7)][_0x379587(0xa0)](process[_0x379587(0xb3)](),_0x379587(0xd1),_0x5f0421)))await(0x0,promises_1['rm'])(path_1[_0x379587(0xd7)]['join'](process['cwd'](),_0x379587(0xd1),_0x5f0421),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0xf5acd5,_0x8d6dc5,_0x4bb989){const _0x1f51f=a86_0x220e0d,_0x5f1d0f=[],_0x1dde29=await(0x0,fetch_attachments_1[_0x1f51f(0xb1)])(_0xf5acd5,_0x8d6dc5);return await getComponentFromZip(_0x1dde29,_0x4bb989)[_0x1f51f(0xed)](_0x4279ef=>{_0x5f1d0f['push'](..._0x4279ef);}),_0x5f1d0f;}async function getComponentFromZip(_0x578de7,_0x496fb1){const _0xac5b0d=a86_0x220e0d,_0x4449b6=[];for(const _0x43bcc4 of _0x578de7){const _0x472940=await zip_1[_0xac5b0d(0xae)][_0xac5b0d(0xcf)](_0x43bcc4[_0xac5b0d(0xf2)]['Body']);for(const _0x3782fd in _0x472940[_0xac5b0d(0xbc)]){!_0x472940[_0xac5b0d(0xbc)][_0x3782fd][_0xac5b0d(0xbb)]&&_0x4449b6[_0xac5b0d(0xde)]({'fileName':_0x3782fd['substring'](_0x3782fd[_0xac5b0d(0xa6)]('/')+0x1),'fileType':_0x496fb1[_0x43bcc4['id']],'body':_0x43bcc4[_0xac5b0d(0xf2)][_0xac5b0d(0xc1)]});}}return _0x4449b6;}async function removePermission(_0x2942d0,_0x20a269){const _0x5c1fad=a86_0x220e0d;for(const _0x5087b4 of _0x2942d0){const _0x530fde=await zip_1['Zip'][_0x5c1fad(0xcf)](_0x5087b4['body']),_0x495944=[];for(const _0x1821c0 in _0x530fde[_0x5c1fad(0xbc)]){!_0x530fde[_0x5c1fad(0xbc)][_0x1821c0]['dir']&&_0x495944[_0x5c1fad(0xde)]({'fileName':_0x1821c0,'body':await _0x530fde[_0x5c1fad(0xbc)][_0x1821c0][_0x5c1fad(0xb4)](_0x5c1fad(0xd3))});}const _0x2cf2e5=await(0x0,extract_component_permissions_1[_0x5c1fad(0xc4)])(_0x495944[0x0][_0x5c1fad(0xcc)]['toString'](),_0x20a269,_0x5087b4[_0x5c1fad(0xa4)]),_0x10f726=new xml2js_1['Builder']({'xmldec':{'version':_0x5c1fad(0xe9),'encoding':'UTF-8'}}),_0x42368f=_0x10f726[_0x5c1fad(0xbd)](_0x2cf2e5),_0x4f5462=zip_1[_0x5c1fad(0xae)][_0x5c1fad(0xdb)]();_0x4f5462['file'](_0x495944[0x0][_0x5c1fad(0xcb)],_0x42368f),_0x5087b4[_0x5c1fad(0xcc)]=await _0x4f5462[_0x5c1fad(0x9a)]({'type':'base64','compression':_0x5c1fad(0xc5),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x16dfb6,_0x37003c,_0x3ed5d1){const _0x316b81=a86_0x220e0d;for(const _0x4b5227 of _0x3ed5d1){if(_0x16dfb6[_0x316b81(0xbf)](_0x58dd62=>_0x58dd62!==_0x4b5227[_0x316b81(0xa4)]))continue;const _0x53094d=await zip_1[_0x316b81(0xae)][_0x316b81(0xcf)](_0x4b5227[_0x316b81(0xcc)]);for(const _0x36f9ec in _0x53094d['files']){if(!_0x53094d['files'][_0x36f9ec][_0x316b81(0xbb)]){let _0x3cc2c0=await _0x53094d[_0x316b81(0xbc)][_0x36f9ec][_0x316b81(0xb4)](_0x316b81(0xd3));for(const _0x19f394 of Object['keys'](_0x37003c)){const _0x3bb671=new RegExp('%%'+_0x19f394+'%%','g');_0x3cc2c0=_0x3cc2c0[_0x316b81(0xb7)](_0x3bb671,_0x37003c[_0x19f394]);}_0x53094d['file'](_0x36f9ec,_0x3cc2c0);}}_0x4b5227['body']=await _0x53094d[_0x316b81(0x9a)]({'type':'base64','compression':_0x316b81(0xc5),'compressionOptions':{'level':0x6}});}}function a86_0xa808(){const _0x1893f5=['fetchComponentsDetailsByComponentsHistory','values','../../git/internal/fs.internal','destructiveChangesPost.xml','fetchAttachmentBody','generateAsync','destructiveChangesPre.xml','__esModule','../../git/parsers/mdapi','../../shared/utils/fetch-attachments','post','join','20GZyBwy','xml2js','Component_Name__c','fileType','UTF-8','indexOf','toString','198032DoLjDy','base64','package.xml','map','Profile','/sobjects/Attachment','Zip','fetchAttachmentsDetailsById','FOLDER_TO_METADATA_TYPE_MAP','retrieveAttachments','uuid','cwd','async','Name','name','replace','reduce','ComponentsApi','fs/promises','dir','files','buildObject','25313739muHvfg','every','24yjcNEa','Body','types','MAX_ZIP_SIZE','extractComponentPermissions','DEFLATE','constructor','3100022uTjhla','1782954wjxJnm','http://soap.sforce.com/2006/04/metadata','orgId','fileName','body','3xvqpZO','find','unzip','type','.temp','writeFile','text','72376FEoMNK','__importDefault','exists','default','adm-zip','@flosum/salesforce','apply','createZip','length','defineProperty','push','MDApiWriter','/services/data/v','BUILD','toBuffer','../../git/parsers/utils/zip','2405omjved','search','497xfHFsg','(((.+)+)+)+$','filter','1.0','3878456NJCvKL','ParentId','MetadataConstants','then','Builder','DEPLOYZIP','16446eCnxFu'];a86_0xa808=function(){return _0x1893f5;};return a86_0xa808();}async function writeZip(_0x1fc9d0,_0x19bf2f){const _0x3fa7f9=a86_0x220e0d,_0x2243b1=new mdapi_1[(_0x3fa7f9(0xdf))]({'components':_0x1fc9d0,'sourceDir':path_1[_0x3fa7f9(0xd7)][_0x3fa7f9(0xa0)](process['cwd'](),_0x3fa7f9(0xd1),_0x19bf2f,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x2243b1['start']();}async function generateAndWritePackageXML(_0x16e3c5,_0x4e9364,_0x4bee5f,_0x24ad63){const _0xbacef2=a86_0x220e0d,_0x5e7844=getComponentsTypeAndName(_0x16e3c5,_0x4e9364),_0x502c01=[...new Set(_0x5e7844['map'](_0x4bdf45=>_0x4bdf45[_0xbacef2(0xd0)]))],_0x486686={'Package':{'$':{'xmlns':_0xbacef2(0xc9)},'types':[],'version':''+_0x24ad63}};for(const _0x381edc of _0x502c01){const _0x2742b1=_0x5e7844['filter'](_0x467c4d=>_0x467c4d[_0xbacef2(0xd0)]===_0x381edc)[_0xbacef2(0xab)](_0x1427c2=>_0x1427c2[_0xbacef2(0xb6)]),_0x4bc583={'members':_0x2742b1,'name':_0x381edc};_0x486686['Package'][_0xbacef2(0xc2)]['push'](_0x4bc583);}const _0x5c58e4=new xml2js_1[(_0xbacef2(0xee))]({'xmldec':{'version':'1.0','encoding':_0xbacef2(0xa5)}}),_0x1b4009=_0x5c58e4['buildObject'](_0x486686);await fs_internal_1['FS'][_0xbacef2(0xd2)](path_1[_0xbacef2(0xd7)][_0xbacef2(0xa0)](process[_0xbacef2(0xb3)](),_0xbacef2(0xd1),_0x4bee5f,DEPLOY_DIR_NAME,'src',_0xbacef2(0xaa)),_0x1b4009);}function a86_0x119d(_0x219b81,_0x358e96){const _0x149c4d=a86_0xa808();return a86_0x119d=function(_0x18f1e5,_0x435cda){_0x18f1e5=_0x18f1e5-0x98;let _0xa8089f=_0x149c4d[_0x18f1e5];return _0xa8089f;},a86_0x119d(_0x219b81,_0x358e96);}function getComponentsTypeAndName(_0x5f4f2b,_0x9b64e2){const _0x17bb01=a86_0x220e0d;return _0x5f4f2b[_0x17bb01(0xb8)]((_0x3b28f9,_0x56caed)=>{const _0x467e87=_0x17bb01,_0x3c16f1=_0x9b64e2[_0x467e87(0xce)](_0x32461b=>_0x32461b['Id']===_0x56caed[_0x467e87(0xeb)]);return _0x3c16f1&&_0x3b28f9[_0x467e87(0xde)]({'name':_0x3c16f1['Component__r'][_0x467e87(0xa3)],'type':salesforce_1[_0x467e87(0xec)][_0x467e87(0xb0)][_0x56caed['Name']]||_0x56caed[_0x467e87(0xb5)]}),_0x3b28f9;},[]);}async function saveDestructiveChanges(_0x43a4b3,_0x119949,_0x347e6b,_0x204143){const _0x180b26=a86_0x220e0d,_0x5b427e=(await(0x0,fetch_attachments_1[_0x180b26(0x99)])(_0x43a4b3,_0x119949))[_0x180b26(0xa7)]();await fs_internal_1['FS'][_0x180b26(0xd2)](path_1[_0x180b26(0xd7)][_0x180b26(0xa0)](process[_0x180b26(0xb3)](),_0x180b26(0xd1),_0x204143,DEPLOY_DIR_NAME,'src',_0x347e6b),_0x5b427e);}async function createDeployZip(_0x2ac431){const _0x3de41e=a86_0x220e0d,_0x1aca42=new adm_zip_1['default']();return await _0x1aca42['addLocalFolder'](path_1['default'][_0x3de41e(0xa0)](process['cwd'](),_0x3de41e(0xd1),_0x2ac431,DEPLOY_DIR_NAME)),_0x1aca42;}async function insertZip(_0x595f6c,_0x3f3988,_0x2a33bd,_0x591afb,_0x1caa11,_0x828d0d){const _0x4d27bd=a86_0x220e0d,_0x45075f={'ParentId':_0x3f3988,'Name':_0x4d27bd(0xe1)+_0x2a33bd,'Description':'BUILD'+_0x591afb,'Body':_0x1caa11},{data:_0x3ee232}=await _0x595f6c[_0x4d27bd(0x9f)](_0x4d27bd(0xe0)+_0x828d0d+_0x4d27bd(0xad),_0x45075f);return _0x3ee232['id'];}