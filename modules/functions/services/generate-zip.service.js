const a86_0x264732=a86_0x5202;function a86_0x5202(_0x2ac08a,_0x5291f7){const _0x2801c5=a86_0x29d1();return a86_0x5202=function(_0x14bbd7,_0x38c912){_0x14bbd7=_0x14bbd7-0x1c0;let _0x29d101=_0x2801c5[_0x14bbd7];return _0x29d101;},a86_0x5202(_0x2ac08a,_0x5291f7);}(function(_0x6c4b1b,_0x154d46){const _0x4db454=a86_0x5202,_0x495157=_0x6c4b1b();while(!![]){try{const _0x502886=parseInt(_0x4db454(0x1e8))/0x1+-parseInt(_0x4db454(0x1db))/0x2+parseInt(_0x4db454(0x215))/0x3*(-parseInt(_0x4db454(0x1e6))/0x4)+parseInt(_0x4db454(0x1ca))/0x5*(parseInt(_0x4db454(0x1e4))/0x6)+-parseInt(_0x4db454(0x205))/0x7*(parseInt(_0x4db454(0x1eb))/0x8)+parseInt(_0x4db454(0x1e9))/0x9*(-parseInt(_0x4db454(0x1e1))/0xa)+parseInt(_0x4db454(0x1c7))/0xb*(parseInt(_0x4db454(0x1f0))/0xc);if(_0x502886===_0x154d46)break;else _0x495157['push'](_0x495157['shift']());}catch(_0x1fb9de){_0x495157['push'](_0x495157['shift']());}}}(a86_0x29d1,0x57a0d));const a86_0x38c912=(function(){let _0x56214d=!![];return function(_0x3bccf1,_0x32f974){const _0x9f5873=_0x56214d?function(){const _0x47b0c5=a86_0x5202;if(_0x32f974){const _0x3d0c46=_0x32f974[_0x47b0c5(0x21e)](_0x3bccf1,arguments);return _0x32f974=null,_0x3d0c46;}}:function(){};return _0x56214d=![],_0x9f5873;};}()),a86_0x14bbd7=a86_0x38c912(this,function(){const _0x453bae=a86_0x5202;return a86_0x14bbd7[_0x453bae(0x216)]()[_0x453bae(0x1f8)]('(((.+)+)+)+$')[_0x453bae(0x216)]()[_0x453bae(0x1d5)](a86_0x14bbd7)[_0x453bae(0x1f8)]('(((.+)+)+)+$');});a86_0x14bbd7();'use strict';var __importDefault=this&&this[a86_0x264732(0x21a)]||function(_0xa5072e){const _0x1d3382=a86_0x264732;return _0xa5072e&&_0xa5072e[_0x1d3382(0x1dc)]?_0xa5072e:{'default':_0xa5072e};};Object[a86_0x264732(0x1d6)](exports,'__esModule',{'value':!![]}),exports[a86_0x264732(0x20d)]=void 0x0;const constants_1=require(a86_0x264732(0x20f)),path_1=__importDefault(require(a86_0x264732(0x1c9))),extract_component_permissions_1=require(a86_0x264732(0x204)),xml2js_1=require(a86_0x264732(0x1f4)),zip_1=require(a86_0x264732(0x21c)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a86_0x264732(0x1f6)),promises_1=require(a86_0x264732(0x1c4)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a86_0x264732(0x1de))),uuid_1=require(a86_0x264732(0x220)),fetch_attachments_1=require(a86_0x264732(0x214)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x264732(0x1e0),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x264732(0x1f3),DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x4373ab,isExtractComponentsPermissions:_0x513573,preDestructiveAttachmentId:_0x40b39f,postDestructiveAttachmentId:_0x50f42a,branchId:_0xb4519c,credentials:_0x4da33a,metadataLogId:_0x59b137,environments:_0x1d0a57,metaTypes:_0x305869},_0x5592b4){const _0x4ff429=a86_0x264732,_0x2009d1=(0x0,uuid_1['v4'])();try{const _0x4a244c=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x5592b4,_0x4373ab),_0x967e85=_0x4a244c[_0x4ff429(0x1e2)]((_0xc0eb64,_0x56b584)=>({..._0xc0eb64,[_0x56b584['Id']]:_0x56b584[_0x4ff429(0x1ea)]}),{}),_0x2232bb=await getComponents(_0x4a244c,_0x5592b4,_0x967e85),_0x5ab544=await components_api_1[_0x4ff429(0x213)][_0x4ff429(0x1f5)](_0x5592b4,_0x4a244c[_0x4ff429(0x1e5)](({ParentId:_0x4a79da})=>_0x4a79da))[_0x4ff429(0x207)](_0x3b9d5f=>components_api_1[_0x4ff429(0x213)][_0x4ff429(0x1fb)](_0x3b9d5f));if(_0x513573){const _0x420942=_0x2232bb[_0x4ff429(0x1dd)](({fileType:_0x5570c9})=>_0x5570c9===_0x4ff429(0x1ce)||_0x5570c9===_0x4ff429(0x202));await removePermission(_0x420942,_0x5ab544);}await replaceEnvironments(_0x305869,_0x1d0a57,_0x2232bb),await writeZip(_0x2232bb,_0x2009d1),await generateAndWritePackageXML(_0x4a244c,_0x5ab544,_0x2009d1);_0x40b39f&&await saveDestructiveChanges(_0x5592b4,_0x40b39f,DESTRUCTIVE_CHANGES_PER_NAME,_0x2009d1);_0x50f42a&&await saveDestructiveChanges(_0x5592b4,_0x50f42a,DESTRUCTIVE_CHANGES_POST_NAME,_0x2009d1);const _0x47182e=(await createDeployZip(_0x2009d1)[_0x4ff429(0x207)](_0x336860=>{return _0x336860;}))[_0x4ff429(0x1e3)]()[_0x4ff429(0x216)]('base64');console[_0x4ff429(0x201)](_0x4ff429(0x203));const _0x64418c=_0x47182e[_0x4ff429(0x1d2)];if(_0x64418c>=components_api_1[_0x4ff429(0x1f2)]){const _0x537add=await createDeployZip(_0x2009d1);console[_0x4ff429(0x201)]('after\x20create\x20second\x20zip');const [_0x22a665,_0x336557]=await components_api_1[_0x4ff429(0x213)][_0x4ff429(0x1c5)](_0x537add,_0x64418c),_0x26b927=await insertZip(_0x5592b4,_0xb4519c,_0x4da33a[_0x4ff429(0x206)],_0x59b137,_0x22a665[_0x4ff429(0x1e3)]()[_0x4ff429(0x216)]('base64')),_0x413d3a=await insertZip(_0x5592b4,_0xb4519c,_0x4da33a[_0x4ff429(0x206)],_0x59b137,_0x336557[_0x4ff429(0x1e3)]()['toString']('base64'));return _0x26b927+','+_0x413d3a;}else return await insertZip(_0x5592b4,_0xb4519c,_0x4da33a[_0x4ff429(0x206)],_0x59b137,_0x47182e);}catch(_0x15d57d){throw _0x15d57d;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x4ff429(0x1d3)][_0x4ff429(0x1ed)](process[_0x4ff429(0x1d1)](),'.temp',_0x2009d1)))await(0x0,promises_1['rm'])(path_1[_0x4ff429(0x1d3)][_0x4ff429(0x1ed)](process['cwd'](),_0x4ff429(0x209),_0x2009d1),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x2577a7,_0x354ce1,_0x32a08d){const _0x32ba17=a86_0x264732,_0x48dbd8=[],_0x3e690a=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x2577a7,_0x354ce1);return await getComponentFromZip(_0x3e690a,_0x32a08d)[_0x32ba17(0x207)](_0x5f58a7=>{_0x48dbd8['push'](..._0x5f58a7);}),_0x48dbd8;}async function getComponentFromZip(_0x3f1364,_0x59c4bf){const _0x4821a2=a86_0x264732,_0x20d005=[];for(const _0x32eb7e of _0x3f1364){const _0x3d5caf=await zip_1['Zip'][_0x4821a2(0x1cb)](_0x32eb7e['values'][_0x4821a2(0x1fa)]);for(const _0x3abfca in _0x3d5caf['files']){!_0x3d5caf[_0x4821a2(0x20e)][_0x3abfca][_0x4821a2(0x1fc)]&&_0x20d005[_0x4821a2(0x1d8)]({'fileName':_0x3abfca[_0x4821a2(0x1e7)](_0x3abfca[_0x4821a2(0x20a)]('/')+0x1),'fileType':_0x59c4bf[_0x32eb7e['id']],'body':_0x32eb7e[_0x4821a2(0x1ee)][_0x4821a2(0x1fa)]});}}return _0x20d005;}function a86_0x29d1(){const _0x3cf4e1=['name','extractComponentPermissions','ComponentsApi','../../shared/utils/fetch-attachments','207ieAyTn','toString','every','src','/services/data/','__importDefault','fileName','../../git/parsers/utils/zip','base64','apply','Zip','uuid','async','file','addLocalFolder','BUILD','fs/promises','splitZip','types','77dqWCfT','body','path','16395rrdytW','unzip','MDApiWriter','Builder','Profile','1.0','UTF-8','cwd','length','default','type','constructor','defineProperty','SALESFORCE_API_VERSION','push','keys','DEFLATE','1190402rCpzBK','__esModule','filter','adm-zip','generateAsync','destructiveChangesPre.xml','3637870WQFftg','reduce','toBuffer','1266xCHHTK','map','7716UICMrD','substring','88609UOGBiu','9DISuaS','Name','14176kUDOTa','ParentId','join','values','writeFile','2194464KobxKZ','createZip','MAX_ZIP_SIZE','destructiveChangesPost.xml','xml2js','fetchComponentsDetailsByComponentsHistory','../../git/internal/fs.internal','Package','search','http://soap.sforce.com/2006/04/metadata','Body','removeNamespacePrefix','dir','Component__r','package.xml','start','post','log','PermissionSet','after\x20create\x20zip','../utils/extract-component-permissions','2408JIculs','orgId','then','find','.temp','indexOf','fileType','text','generateAndDeployZip','files','../../../constants','buildObject'];a86_0x29d1=function(){return _0x3cf4e1;};return a86_0x29d1();}async function removePermission(_0x56478c,_0x1697e9){const _0x504304=a86_0x264732;for(const _0x2d6234 of _0x56478c){const _0xe497db=await zip_1['Zip']['unzip'](_0x2d6234[_0x504304(0x1c8)]),_0x46c575=[];for(const _0x56f441 in _0xe497db[_0x504304(0x20e)]){!_0xe497db[_0x504304(0x20e)][_0x56f441]['dir']&&_0x46c575[_0x504304(0x1d8)]({'fileName':_0x56f441,'body':await _0xe497db[_0x504304(0x20e)][_0x56f441][_0x504304(0x1c0)](_0x504304(0x20c))});}const _0x645321=await(0x0,extract_component_permissions_1[_0x504304(0x212)])(_0x46c575[0x0]['body'][_0x504304(0x216)](),_0x1697e9,_0x2d6234[_0x504304(0x20b)]),_0x1aba69=new xml2js_1[(_0x504304(0x1cd))]({'xmldec':{'version':_0x504304(0x1cf),'encoding':_0x504304(0x1d0)}}),_0x425d32=_0x1aba69[_0x504304(0x210)](_0x645321),_0x2aa30c=zip_1[_0x504304(0x21f)][_0x504304(0x1f1)]();_0x2aa30c[_0x504304(0x1c1)](_0x46c575[0x0][_0x504304(0x21b)],_0x425d32),_0x2d6234[_0x504304(0x1c8)]=await _0x2aa30c['generateAsync']({'type':_0x504304(0x21d),'compression':_0x504304(0x1da),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x1b685d,_0x415f03,_0x3605de){const _0xeb81fc=a86_0x264732;for(const _0x41cc67 of _0x3605de){if(_0x1b685d[_0xeb81fc(0x217)](_0x37b0d3=>_0x37b0d3!==_0x41cc67[_0xeb81fc(0x20b)]))continue;const _0x2d6248=await zip_1[_0xeb81fc(0x21f)]['unzip'](_0x41cc67[_0xeb81fc(0x1c8)]);for(const _0x4a98ff in _0x2d6248[_0xeb81fc(0x20e)]){if(!_0x2d6248[_0xeb81fc(0x20e)][_0x4a98ff]['dir']){let _0x5bef4d=await _0x2d6248[_0xeb81fc(0x20e)][_0x4a98ff][_0xeb81fc(0x1c0)](_0xeb81fc(0x20c));for(const _0x548d00 of Object[_0xeb81fc(0x1d9)](_0x415f03)){const _0x12b49d=new RegExp('%%'+_0x548d00+'%%','g');_0x5bef4d=_0x5bef4d['replace'](_0x12b49d,_0x415f03[_0x548d00]);}_0x2d6248[_0xeb81fc(0x1c1)](_0x4a98ff,_0x5bef4d);}}_0x41cc67['body']=await _0x2d6248[_0xeb81fc(0x1df)]({'type':_0xeb81fc(0x21d),'compression':_0xeb81fc(0x1da),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x150c51,_0x4c27a5){const _0x55d15d=a86_0x264732,_0x39578a=new mdapi_1[(_0x55d15d(0x1cc))]({'components':_0x150c51,'sourceDir':path_1[_0x55d15d(0x1d3)][_0x55d15d(0x1ed)](process['cwd'](),_0x55d15d(0x209),_0x4c27a5,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x39578a[_0x55d15d(0x1ff)]();}async function generateAndWritePackageXML(_0x1b6bc4,_0x4c56ed,_0x5ebfa2){const _0xa995af=a86_0x264732,_0x2779b9=getComponentsTypeAndName(_0x1b6bc4,_0x4c56ed),_0x32a438=[...new Set(_0x2779b9[_0xa995af(0x1e5)](_0x330c5e=>_0x330c5e[_0xa995af(0x1d4)]))],_0xe1ee97={'Package':{'$':{'xmlns':_0xa995af(0x1f9)},'types':[],'version':''+constants_1[_0xa995af(0x1d7)][_0xa995af(0x1e7)](0x1)}};for(const _0x2101d6 of _0x32a438){const _0x4a5a65=_0x2779b9['filter'](_0x2bf148=>_0x2bf148[_0xa995af(0x1d4)]===_0x2101d6)['map'](_0x3db0dd=>_0x3db0dd[_0xa995af(0x211)]),_0x1b13af={'members':_0x4a5a65,'name':_0x2101d6};_0xe1ee97[_0xa995af(0x1f7)][_0xa995af(0x1c6)][_0xa995af(0x1d8)](_0x1b13af);}const _0x1f0f05=new xml2js_1[(_0xa995af(0x1cd))]({'xmldec':{'version':_0xa995af(0x1cf),'encoding':_0xa995af(0x1d0)}}),_0x42925f=_0x1f0f05[_0xa995af(0x210)](_0xe1ee97);await fs_internal_1['FS'][_0xa995af(0x1ef)](path_1[_0xa995af(0x1d3)][_0xa995af(0x1ed)](process['cwd'](),_0xa995af(0x209),_0x5ebfa2,DEPLOY_DIR_NAME,_0xa995af(0x218),_0xa995af(0x1fe)),_0x42925f);}function getComponentsTypeAndName(_0x2b54f2,_0x55c302){const _0x42fc4e=a86_0x264732;return _0x2b54f2[_0x42fc4e(0x1e2)]((_0x3bc77c,_0x29e2fc)=>{const _0x500b9a=_0x42fc4e,_0x4fdd12=_0x55c302[_0x500b9a(0x208)](_0xca26ca=>_0xca26ca['Id']===_0x29e2fc[_0x500b9a(0x1ec)]);return _0x4fdd12&&_0x3bc77c[_0x500b9a(0x1d8)]({'name':_0x4fdd12[_0x500b9a(0x1fd)]['Component_Name__c'],'type':_0x29e2fc[_0x500b9a(0x1ea)]}),_0x3bc77c;},[]);}async function saveDestructiveChanges(_0x4869d7,_0x4ac0c4,_0x1b2bb3,_0x470dbd){const _0x400ebc=a86_0x264732,_0x28b073=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x4869d7,_0x4ac0c4))[_0x400ebc(0x216)]();await fs_internal_1['FS'][_0x400ebc(0x1ef)](path_1[_0x400ebc(0x1d3)]['join'](process[_0x400ebc(0x1d1)](),'.temp',_0x470dbd,DEPLOY_DIR_NAME,'src',_0x1b2bb3),_0x28b073);}async function createDeployZip(_0x3a1b5a){const _0x59c934=a86_0x264732,_0x1ca61d=new adm_zip_1[(_0x59c934(0x1d3))]();return await _0x1ca61d[_0x59c934(0x1c2)](path_1[_0x59c934(0x1d3)][_0x59c934(0x1ed)](process[_0x59c934(0x1d1)](),_0x59c934(0x209),_0x3a1b5a,DEPLOY_DIR_NAME)),_0x1ca61d;}async function insertZip(_0x505285,_0x491a19,_0x1a4e6d,_0x4566ad,_0x352ae4){const _0x3a2458=a86_0x264732,_0x9fd0f3={'ParentId':_0x491a19,'Name':_0x3a2458(0x1c3)+_0x1a4e6d,'Description':_0x3a2458(0x1c3)+_0x4566ad,'Body':_0x352ae4},{data:_0x1ae58e}=await _0x505285[_0x3a2458(0x200)](_0x3a2458(0x219)+constants_1[_0x3a2458(0x1d7)]+'/sobjects/Attachment',_0x9fd0f3);return _0x1ae58e['id'];}