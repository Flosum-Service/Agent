const a104_0x24d065=a104_0x1a85;(function(_0x523c6e,_0x417e38){const _0x3efceb=a104_0x1a85,_0x283da9=_0x523c6e();while(!![]){try{const _0x558a17=parseInt(_0x3efceb(0x1a7))/0x1+-parseInt(_0x3efceb(0x155))/0x2+parseInt(_0x3efceb(0x176))/0x3*(parseInt(_0x3efceb(0x156))/0x4)+-parseInt(_0x3efceb(0x158))/0x5+parseInt(_0x3efceb(0x174))/0x6*(-parseInt(_0x3efceb(0x17e))/0x7)+-parseInt(_0x3efceb(0x165))/0x8*(-parseInt(_0x3efceb(0x15c))/0x9)+parseInt(_0x3efceb(0x168))/0xa*(parseInt(_0x3efceb(0x16f))/0xb);if(_0x558a17===_0x417e38)break;else _0x283da9['push'](_0x283da9['shift']());}catch(_0xe94f68){_0x283da9['push'](_0x283da9['shift']());}}}(a104_0x379e,0x796db));const a104_0x16340c=(function(){let _0x51f066=!![];return function(_0x16b309,_0x15e3e3){const _0x1726d1=_0x51f066?function(){const _0x1ca508=a104_0x1a85;if(_0x15e3e3){const _0x4baee9=_0x15e3e3[_0x1ca508(0x18a)](_0x16b309,arguments);return _0x15e3e3=null,_0x4baee9;}}:function(){};return _0x51f066=![],_0x1726d1;};}()),a104_0x3a84bb=a104_0x16340c(this,function(){const _0x377233=a104_0x1a85;return a104_0x3a84bb[_0x377233(0x1a0)]()[_0x377233(0x166)](_0x377233(0x195))[_0x377233(0x1a0)]()[_0x377233(0x172)](a104_0x3a84bb)[_0x377233(0x166)](_0x377233(0x195));});a104_0x3a84bb();'use strict';function a104_0x379e(){const _0x2157ce=['toBuffer','../../git/writers/mdapi.writer','extractComponentPermissions','buildObject','toString','destructiveChangesPost.xml','default','1.0','Component__r','UTF-8','body','955345EuijWL','/sobjects/Attachment','types','Logger','unzip','path','filter','../utils/components-api','text','retrieveAttachments','Builder','defineProperty','reduce','mergeComponentPermissions','async','ComponentsApi','map','../utils/extract-component-permissions','splitZip','78916jLMSqB','474808uMFZmz','cwd','4050555yaSbyy','fileName','fetchComponentsDetailsByComponentsHistory','adm-zip','56412QdqPib','../classes/logger','substring','execute','generateAsync','values','Profile','find','fs/promises','32togfwc','search','src','10ZmhCGt','MDApiWriter','dir','file','addLocalFolder','join','/services/data/v','4953113ljbAKC','set','destructiveChangesPre.xml','constructor','PermissionSet','5488044jFtgYc','removeNamespacePrefix','21zobmAM','Name','../../git/parsers/utils/zip','files','listMetadataItem','Package','every','keys','7RiQnoD','Body','base64','type','post','http://soap.sforce.com/2006/04/metadata','then','BUILD','fetchAttachmentBody','writeFile','createZip','ParentId','apply','Component_Name__c','length','fileType','package.xml','generateAndDeployZip','PERMISSION_SET','DEFLATE','get','uuid','__importDefault','(((.+)+)+)+$','../../shared/utils/fetch-attachments','push','DeclarativeFilterOptions','.temp','Zip','__esModule'];a104_0x379e=function(){return _0x2157ce;};return a104_0x379e();}var __importDefault=this&&this[a104_0x24d065(0x194)]||function(_0x5982ca){const _0x2c08af=a104_0x24d065;return _0x5982ca&&_0x5982ca[_0x2c08af(0x19b)]?_0x5982ca:{'default':_0x5982ca};};Object[a104_0x24d065(0x14d)](exports,a104_0x24d065(0x19b),{'value':!![]}),exports[a104_0x24d065(0x18f)]=void 0x0;const path_1=__importDefault(require(a104_0x24d065(0x1ac))),extract_component_permissions_1=require(a104_0x24d065(0x153)),logger_1=require(a104_0x24d065(0x15d)),xml2js_1=require('xml2js'),zip_1=require(a104_0x24d065(0x178)),mdapi_writer_1=require(a104_0x24d065(0x19d)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a104_0x24d065(0x164)),components_api_1=require(a104_0x24d065(0x149)),adm_zip_1=__importDefault(require(a104_0x24d065(0x15b))),uuid_1=require(a104_0x24d065(0x193)),fetch_attachments_1=require(a104_0x24d065(0x196)),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x24d065(0x171),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x24d065(0x1a1),DEPLOY_DIR_NAME='DEPLOYZIP',PERMISSION_SET_FOLDER_NAME='permissionsets';async function generateAndDeployZip({attachmentsId:_0x4e32c8,isExtractComponentsPermissionSets:_0x253442,isExtractComponentsProfiles:_0x25bb6b,preDestructiveAttachmentId:_0x4dd239,postDestructiveAttachmentId:_0x57b9ee,branchId:_0x249046,credentials:_0x1c67fd,metadataLogId:_0x1959f0,environments:_0x563010,metaTypes:_0x2bc645,apiVersion:_0x493865},_0x3ba498,_0x12885f){const _0x59ae28=a104_0x24d065;var _0x5b1ee3;const _0x19cfc1=(0x0,uuid_1['v4'])();try{const _0x46b831=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x3ba498,_0x4e32c8),_0x206a18=_0x46b831[_0x59ae28(0x14e)]((_0x156f37,_0x2ed9)=>({..._0x156f37,[_0x2ed9['Id']]:_0x2ed9[_0x59ae28(0x177)]}),{}),_0x53035d=await getComponents(_0x46b831,_0x3ba498,_0x206a18),_0x1c2fde=await components_api_1[_0x59ae28(0x151)][_0x59ae28(0x15a)](_0x3ba498,_0x46b831[_0x59ae28(0x152)](({ParentId:_0x64639c})=>_0x64639c),_0x493865)[_0x59ae28(0x184)](_0x2bd1e1=>components_api_1[_0x59ae28(0x151)][_0x59ae28(0x175)](_0x2bd1e1));if(_0x25bb6b){const _0x2634b9=_0x53035d[_0x59ae28(0x148)](({fileType:_0x15f668})=>_0x15f668===_0x59ae28(0x162));await removePermission(_0x2634b9,_0x1c2fde);}const _0x506fbb=_0x53035d[_0x59ae28(0x148)](({fileType:_0x26ba5d})=>_0x26ba5d===_0x59ae28(0x173));if(_0x506fbb[_0x59ae28(0x18c)]&&_0x253442){await removePermission(_0x506fbb,_0x1c2fde);const {items:_0x189df1}=await retrieveTargetPermissionSets(_0x506fbb,_0x493865,_0x12885f);await mergePermissionSets(_0x506fbb,((_0x5b1ee3=_0x189df1[_0x59ae28(0x173)])===null||_0x5b1ee3===void 0x0?void 0x0:_0x5b1ee3['components'])||[]);}await replaceEnvironments(_0x2bc645,_0x563010,_0x53035d),await writeZip(_0x53035d,_0x19cfc1),await generateAndWritePackageXML(_0x46b831,_0x1c2fde,_0x19cfc1,_0x493865);_0x4dd239&&await saveDestructiveChanges(_0x3ba498,_0x4dd239,DESTRUCTIVE_CHANGES_PER_NAME,_0x19cfc1);_0x57b9ee&&await saveDestructiveChanges(_0x3ba498,_0x57b9ee,DESTRUCTIVE_CHANGES_POST_NAME,_0x19cfc1);const _0x3eef7f=(await createDeployZip(_0x19cfc1)[_0x59ae28(0x184)](_0x38fe32=>{return _0x38fe32;}))[_0x59ae28(0x19c)]()['toString'](_0x59ae28(0x180)),_0x4a797b=_0x3eef7f[_0x59ae28(0x18c)];if(_0x4a797b>=components_api_1['MAX_ZIP_SIZE']){const _0x312ca2=await createDeployZip(_0x19cfc1),[_0x210eaa,_0x5f1f29]=await components_api_1[_0x59ae28(0x151)][_0x59ae28(0x154)](_0x312ca2,_0x4a797b),_0x1f53c4=await insertZip(_0x3ba498,_0x249046,_0x1c67fd['orgId'],_0x1959f0,_0x210eaa[_0x59ae28(0x19c)]()[_0x59ae28(0x1a0)](_0x59ae28(0x180)),_0x493865),_0x586f05=await insertZip(_0x3ba498,_0x249046,_0x1c67fd['orgId'],_0x1959f0,_0x5f1f29[_0x59ae28(0x19c)]()['toString'](_0x59ae28(0x180)),_0x493865);return _0x1f53c4+','+_0x586f05;}else return await insertZip(_0x3ba498,_0x249046,_0x1c67fd['orgId'],_0x1959f0,_0x3eef7f,_0x493865);}catch(_0x3caf40){throw _0x3caf40;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x59ae28(0x1a2)][_0x59ae28(0x16d)](process[_0x59ae28(0x157)](),_0x59ae28(0x199),_0x19cfc1)))await(0x0,promises_1['rm'])(path_1[_0x59ae28(0x1a2)][_0x59ae28(0x16d)](process[_0x59ae28(0x157)](),_0x59ae28(0x199),_0x19cfc1),{'recursive':!![]});}}exports[a104_0x24d065(0x18f)]=generateAndDeployZip;async function getComponents(_0x3932ae,_0x4e24e1,_0x2887b6){const _0x2de17c=a104_0x24d065,_0x372b1d=[],_0x3c4386=await(0x0,fetch_attachments_1[_0x2de17c(0x14b)])(_0x3932ae,_0x4e24e1);return await getComponentFromZip(_0x3c4386,_0x2887b6)[_0x2de17c(0x184)](_0x2328b2=>{const _0x133680=_0x2de17c;_0x372b1d[_0x133680(0x197)](..._0x2328b2);}),_0x372b1d;}function a104_0x1a85(_0x2024d8,_0x1d3090){const _0x5e1453=a104_0x379e();return a104_0x1a85=function(_0x3a84bb,_0x16340c){_0x3a84bb=_0x3a84bb-0x148;let _0x379e99=_0x5e1453[_0x3a84bb];return _0x379e99;},a104_0x1a85(_0x2024d8,_0x1d3090);}async function getComponentFromZip(_0x3351d9,_0x3a24df){const _0x30c9b9=a104_0x24d065,_0x2d7c8b=[];for(const _0x235c50 of _0x3351d9){const _0x40e70e=await zip_1['Zip'][_0x30c9b9(0x1ab)](_0x235c50['values'][_0x30c9b9(0x17f)]);for(const _0x3a0f12 in _0x40e70e['files']){!_0x40e70e[_0x30c9b9(0x179)][_0x3a0f12]['dir']&&_0x2d7c8b[_0x30c9b9(0x197)]({'fileName':_0x3a0f12[_0x30c9b9(0x15e)](_0x3a0f12['indexOf']('/')+0x1),'fileType':_0x3a24df[_0x235c50['id']],'body':_0x235c50[_0x30c9b9(0x161)]['Body']});}}return _0x2d7c8b;}async function removePermission(_0x5e5852,_0x235d5c){const _0x4a9d69=a104_0x24d065;for(const _0x293db0 of _0x5e5852){const _0x1ebe72=await zip_1['Zip'][_0x4a9d69(0x1ab)](_0x293db0[_0x4a9d69(0x1a6)]),_0x25a9fc=[];for(const _0x5bce3b in _0x1ebe72[_0x4a9d69(0x179)]){!_0x1ebe72[_0x4a9d69(0x179)][_0x5bce3b][_0x4a9d69(0x16a)]&&_0x25a9fc['push']({'fileName':_0x5bce3b,'body':await _0x1ebe72['files'][_0x5bce3b]['async']('text')});}const _0x3b5c57=await(0x0,extract_component_permissions_1[_0x4a9d69(0x19e)])(_0x25a9fc[0x0][_0x4a9d69(0x1a6)][_0x4a9d69(0x1a0)](),_0x235d5c,_0x293db0[_0x4a9d69(0x18d)]),_0x349613=new xml2js_1[(_0x4a9d69(0x14c))]({'xmldec':{'version':_0x4a9d69(0x1a3),'encoding':_0x4a9d69(0x1a5)}}),_0x3e658e=_0x349613[_0x4a9d69(0x19f)](_0x3b5c57),_0x39466e=zip_1[_0x4a9d69(0x19a)][_0x4a9d69(0x188)]();_0x39466e[_0x4a9d69(0x16b)](_0x25a9fc[0x0][_0x4a9d69(0x159)],_0x3e658e),_0x293db0['body']=await _0x39466e[_0x4a9d69(0x160)]({'type':'base64','compression':_0x4a9d69(0x191),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x5e4c29,_0x5a944a,_0x5492a1){const _0x5231a2=a104_0x24d065,_0xdb224d=_0x5e4c29['map'](_0x23b3c2=>PERMISSION_SET_FOLDER_NAME+'/'+_0x23b3c2[_0x5231a2(0x159)])[_0x5231a2(0x16d)](';'),_0x28e77e=[{'field':_0x5231a2(0x159),'option':salesforce_1[_0x5231a2(0x198)]['IN'],'value':_0xdb224d}],_0x45ba06=new logger_1[(_0x5231a2(0x1aa))]();return new salesforce_1['PartialRetrieve'](_0x5a944a,_0x5492a1,_0x45ba06,_0x28e77e,null,[salesforce_1['MetadataType'][_0x5231a2(0x190)]])[_0x5231a2(0x15f)]();}async function mergePermissionSets(_0x57fa3e,_0x51bd2a){const _0x3a3804=a104_0x24d065,_0xcb05b9=_0x51bd2a['reduce']((_0x2de71b,_0x301633)=>_0x2de71b[_0x3a3804(0x170)](_0x301633[_0x3a3804(0x17a)][_0x3a3804(0x159)],_0x301633),new Map());for(const _0x4214be of _0x57fa3e){const _0x3e0263=PERMISSION_SET_FOLDER_NAME+'/'+_0x4214be[_0x3a3804(0x159)],_0x76d0a8=_0xcb05b9[_0x3a3804(0x192)](_0x3e0263);if(!_0x76d0a8)continue;const _0x3d303c=await zip_1[_0x3a3804(0x19a)]['unzip'](_0x4214be[_0x3a3804(0x1a6)]),_0x5eed3d=await _0x3d303c[_0x3a3804(0x179)][_0x3e0263][_0x3a3804(0x150)](_0x3a3804(0x14a)),_0x654f57=_0x76d0a8[_0x3a3804(0x179)][_0x3e0263][_0x3a3804(0x1a0)](),_0x389f42=await(0x0,extract_component_permissions_1[_0x3a3804(0x14f)])(_0x5eed3d,_0x654f57,_0x4214be[_0x3a3804(0x18d)]),_0xa5df89=zip_1['Zip'][_0x3a3804(0x188)]();_0xa5df89[_0x3a3804(0x16b)](_0x3e0263,_0x389f42),_0x4214be['body']=await _0xa5df89[_0x3a3804(0x160)]({'type':_0x3a3804(0x180),'compression':_0x3a3804(0x191),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x102e4e,_0x4ea2ba,_0x236d95){const _0x570e17=a104_0x24d065;for(const _0x4caa53 of _0x236d95){if(_0x102e4e[_0x570e17(0x17c)](_0x508844=>_0x508844!==_0x4caa53['fileType']))continue;const _0x3055e5=await zip_1[_0x570e17(0x19a)][_0x570e17(0x1ab)](_0x4caa53[_0x570e17(0x1a6)]);for(const _0x33aa50 in _0x3055e5[_0x570e17(0x179)]){if(!_0x3055e5[_0x570e17(0x179)][_0x33aa50][_0x570e17(0x16a)]){let _0x28f2d6=await _0x3055e5[_0x570e17(0x179)][_0x33aa50][_0x570e17(0x150)](_0x570e17(0x14a));for(const _0x533e5e of Object[_0x570e17(0x17d)](_0x4ea2ba)){const _0x32088b=new RegExp('%%'+_0x533e5e+'%%','g');_0x28f2d6=_0x28f2d6['replace'](_0x32088b,_0x4ea2ba[_0x533e5e]);}_0x3055e5[_0x570e17(0x16b)](_0x33aa50,_0x28f2d6);}}_0x4caa53[_0x570e17(0x1a6)]=await _0x3055e5[_0x570e17(0x160)]({'type':_0x570e17(0x180),'compression':_0x570e17(0x191),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x46aa3e,_0x33d74f){const _0x335053=a104_0x24d065,_0x1ad1ad=new mdapi_writer_1[(_0x335053(0x169))]({'components':_0x46aa3e,'sourceDir':path_1['default'][_0x335053(0x16d)](process[_0x335053(0x157)](),_0x335053(0x199),_0x33d74f,DEPLOY_DIR_NAME,_0x335053(0x167)),'skipChildErrors':![]});await _0x1ad1ad[_0x335053(0x15f)]();}async function generateAndWritePackageXML(_0x35ba47,_0x51bbe1,_0x1d54c2,_0x618c8){const _0x188085=a104_0x24d065,_0x40ea17=getComponentsTypeAndName(_0x35ba47,_0x51bbe1),_0x52c0a5=[...new Set(_0x40ea17['map'](_0x5237f4=>_0x5237f4[_0x188085(0x181)]))],_0x46784b={'Package':{'$':{'xmlns':_0x188085(0x183)},'types':[],'version':''+_0x618c8}};for(const _0xd61643 of _0x52c0a5){const _0x3cf545=_0x40ea17[_0x188085(0x148)](_0x5b4667=>_0x5b4667[_0x188085(0x181)]===_0xd61643)[_0x188085(0x152)](_0x4254d4=>_0x4254d4['name']),_0x48fd71={'members':_0x3cf545,'name':_0xd61643};_0x46784b[_0x188085(0x17b)][_0x188085(0x1a9)][_0x188085(0x197)](_0x48fd71);}const _0x29f9b8=new xml2js_1[(_0x188085(0x14c))]({'xmldec':{'version':_0x188085(0x1a3),'encoding':_0x188085(0x1a5)}}),_0x541ed0=_0x29f9b8[_0x188085(0x19f)](_0x46784b);await fs_internal_1['FS'][_0x188085(0x187)](path_1['default'][_0x188085(0x16d)](process[_0x188085(0x157)](),_0x188085(0x199),_0x1d54c2,DEPLOY_DIR_NAME,_0x188085(0x167),_0x188085(0x18e)),_0x541ed0);}function getComponentsTypeAndName(_0x591cbe,_0x1f1f82){return _0x591cbe['reduce']((_0x12619d,_0x16686f)=>{const _0x192a31=a104_0x1a85,_0x5189a6=_0x1f1f82[_0x192a31(0x163)](_0x599ea8=>_0x599ea8['Id']===_0x16686f[_0x192a31(0x189)]);return _0x5189a6&&_0x12619d['push']({'name':_0x5189a6[_0x192a31(0x1a4)][_0x192a31(0x18b)],'type':salesforce_1['MetadataConstants']['FOLDER_TO_METADATA_TYPE_MAP'][_0x16686f[_0x192a31(0x177)]]||_0x16686f[_0x192a31(0x177)]}),_0x12619d;},[]);}async function saveDestructiveChanges(_0x52f796,_0x5711e9,_0x3bcbfa,_0x308e06){const _0x328031=a104_0x24d065,_0x24bdab=(await(0x0,fetch_attachments_1[_0x328031(0x186)])(_0x52f796,_0x5711e9))['toString']();await fs_internal_1['FS'][_0x328031(0x187)](path_1[_0x328031(0x1a2)][_0x328031(0x16d)](process[_0x328031(0x157)](),_0x328031(0x199),_0x308e06,DEPLOY_DIR_NAME,_0x328031(0x167),_0x3bcbfa),_0x24bdab);}async function createDeployZip(_0x174e4f){const _0x1747ae=a104_0x24d065,_0x442d24=new adm_zip_1['default']();return await _0x442d24[_0x1747ae(0x16c)](path_1[_0x1747ae(0x1a2)][_0x1747ae(0x16d)](process[_0x1747ae(0x157)](),_0x1747ae(0x199),_0x174e4f,DEPLOY_DIR_NAME)),_0x442d24;}async function insertZip(_0xb4be91,_0x4e8633,_0x16d196,_0x58b158,_0x505b09,_0x7d5f4f){const _0x4d2cbd=a104_0x24d065,_0x19ed16={'ParentId':_0x4e8633,'Name':_0x4d2cbd(0x185)+_0x16d196,'Description':'BUILD'+_0x58b158,'Body':_0x505b09},{data:_0x4c9777}=await _0xb4be91[_0x4d2cbd(0x182)](_0x4d2cbd(0x16e)+_0x7d5f4f+_0x4d2cbd(0x1a8),_0x19ed16);return _0x4c9777['id'];}