const a86_0x1b9b03=a86_0x6279;(function(_0x4b80dd,_0x644df3){const _0x1ed753=a86_0x6279,_0x26fbe4=_0x4b80dd();while(!![]){try{const _0x23cf9b=-parseInt(_0x1ed753(0x12d))/0x1*(parseInt(_0x1ed753(0x117))/0x2)+-parseInt(_0x1ed753(0x119))/0x3*(-parseInt(_0x1ed753(0x12c))/0x4)+parseInt(_0x1ed753(0xf8))/0x5+-parseInt(_0x1ed753(0x138))/0x6*(parseInt(_0x1ed753(0x10f))/0x7)+-parseInt(_0x1ed753(0xf2))/0x8*(-parseInt(_0x1ed753(0xe6))/0x9)+parseInt(_0x1ed753(0x121))/0xa*(-parseInt(_0x1ed753(0xf3))/0xb)+-parseInt(_0x1ed753(0xf4))/0xc;if(_0x23cf9b===_0x644df3)break;else _0x26fbe4['push'](_0x26fbe4['shift']());}catch(_0x59d676){_0x26fbe4['push'](_0x26fbe4['shift']());}}}(a86_0x2615,0x8131a));const a86_0x5674a2=(function(){let _0x1ea84e=!![];return function(_0x325cd7,_0x3209d3){const _0xf02fd2=_0x1ea84e?function(){const _0x5ab75f=a86_0x6279;if(_0x3209d3){const _0x13b45e=_0x3209d3[_0x5ab75f(0x132)](_0x325cd7,arguments);return _0x3209d3=null,_0x13b45e;}}:function(){};return _0x1ea84e=![],_0xf02fd2;};}()),a86_0x2a3be2=a86_0x5674a2(this,function(){const _0x26d320=a86_0x6279;return a86_0x2a3be2['toString']()[_0x26d320(0xe4)](_0x26d320(0xf7))[_0x26d320(0x12a)]()[_0x26d320(0x114)](a86_0x2a3be2)[_0x26d320(0xe4)]('(((.+)+)+)+$');});a86_0x2a3be2();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x11a61b){const _0xf3cbbf=a86_0x6279;return _0x11a61b&&_0x11a61b[_0xf3cbbf(0x12f)]?_0x11a61b:{'default':_0x11a61b};};Object[a86_0x1b9b03(0x131)](exports,'__esModule',{'value':!![]}),exports[a86_0x1b9b03(0xff)]=void 0x0;const path_1=__importDefault(require(a86_0x1b9b03(0xfc))),extract_component_permissions_1=require(a86_0x1b9b03(0x10e)),xml2js_1=require(a86_0x1b9b03(0xe7)),zip_1=require(a86_0x1b9b03(0x115)),mdapi_1=require(a86_0x1b9b03(0xf1)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require('fs/promises'),components_api_1=require(a86_0x1b9b03(0x10d)),adm_zip_1=__importDefault(require(a86_0x1b9b03(0x102))),uuid_1=require(a86_0x1b9b03(0x136)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x1b9b03(0xec),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x1b9b03(0x130),DEPLOY_DIR_NAME=a86_0x1b9b03(0x120);async function generateAndDeployZip({attachmentsId:_0xc5ef2f,isExtractComponentsPermissions:_0x10a0f1,preDestructiveAttachmentId:_0x19f025,postDestructiveAttachmentId:_0x45831a,branchId:_0x2b7ce0,credentials:_0x7cfb81,metadataLogId:_0x1daef4,environments:_0x162964,metaTypes:_0x5db492,apiVersion:_0x34e0c1},_0x4aa1d7){const _0x205980=a86_0x1b9b03,_0x15b986=(0x0,uuid_1['v4'])();try{const _0x53fd0f=await(0x0,fetch_attachments_1[_0x205980(0xee)])(_0x4aa1d7,_0xc5ef2f),_0x8ca0bf=_0x53fd0f[_0x205980(0x107)]((_0x13a526,_0x563b28)=>({..._0x13a526,[_0x563b28['Id']]:_0x563b28[_0x205980(0xed)]}),{}),_0x283c35=await getComponents(_0x53fd0f,_0x4aa1d7,_0x8ca0bf),_0x2c44e5=await components_api_1[_0x205980(0x10b)][_0x205980(0x129)](_0x4aa1d7,_0x53fd0f[_0x205980(0x137)](({ParentId:_0x2756a1})=>_0x2756a1),_0x34e0c1)[_0x205980(0xe2)](_0x2709a2=>components_api_1['ComponentsApi']['removeNamespacePrefix'](_0x2709a2));if(_0x10a0f1){const _0x4925ed=_0x283c35[_0x205980(0x11f)](({fileType:_0x4af5d7})=>_0x4af5d7===_0x205980(0xf9)||_0x4af5d7==='PermissionSet');await removePermission(_0x4925ed,_0x2c44e5);}await replaceEnvironments(_0x5db492,_0x162964,_0x283c35),await writeZip(_0x283c35,_0x15b986),await generateAndWritePackageXML(_0x53fd0f,_0x2c44e5,_0x15b986,_0x34e0c1);_0x19f025&&await saveDestructiveChanges(_0x4aa1d7,_0x19f025,DESTRUCTIVE_CHANGES_PER_NAME,_0x15b986);_0x45831a&&await saveDestructiveChanges(_0x4aa1d7,_0x45831a,DESTRUCTIVE_CHANGES_POST_NAME,_0x15b986);const _0x1e4431=(await createDeployZip(_0x15b986)[_0x205980(0xe2)](_0x1f952c=>{return _0x1f952c;}))[_0x205980(0x103)]()[_0x205980(0x12a)](_0x205980(0xe8)),_0x83a8b4=_0x1e4431[_0x205980(0x10a)];if(_0x83a8b4>=components_api_1[_0x205980(0x112)]){const _0x5557e8=await createDeployZip(_0x15b986),[_0x491568,_0x521912]=await components_api_1[_0x205980(0x10b)][_0x205980(0xf5)](_0x5557e8,_0x83a8b4),_0x38fe78=await insertZip(_0x4aa1d7,_0x2b7ce0,_0x7cfb81[_0x205980(0x116)],_0x1daef4,_0x491568[_0x205980(0x103)]()['toString'](_0x205980(0xe8)),_0x34e0c1),_0x567f3f=await insertZip(_0x4aa1d7,_0x2b7ce0,_0x7cfb81[_0x205980(0x116)],_0x1daef4,_0x521912['toBuffer']()[_0x205980(0x12a)](_0x205980(0xe8)),_0x34e0c1);return _0x38fe78+','+_0x567f3f;}else return await insertZip(_0x4aa1d7,_0x2b7ce0,_0x7cfb81[_0x205980(0x116)],_0x1daef4,_0x1e4431,_0x34e0c1);}catch(_0x22c123){throw _0x22c123;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x205980(0x139)]['join'](process[_0x205980(0x118)](),'.temp',_0x15b986)))await(0x0,promises_1['rm'])(path_1[_0x205980(0x139)][_0x205980(0x106)](process[_0x205980(0x118)](),_0x205980(0x101),_0x15b986),{'recursive':!![]});}}exports[a86_0x1b9b03(0xff)]=generateAndDeployZip;async function getComponents(_0x33ca58,_0xec48d,_0xe8e9bb){const _0x325ce8=a86_0x1b9b03,_0x3277a9=[],_0x4b0a3c=await(0x0,fetch_attachments_1[_0x325ce8(0xe9)])(_0x33ca58,_0xec48d);return await getComponentFromZip(_0x4b0a3c,_0xe8e9bb)[_0x325ce8(0xe2)](_0x4525f1=>{const _0x173452=_0x325ce8;_0x3277a9[_0x173452(0xfa)](..._0x4525f1);}),_0x3277a9;}async function getComponentFromZip(_0x356449,_0x519add){const _0x1f7d84=a86_0x1b9b03,_0x50e247=[];for(const _0x3d74be of _0x356449){const _0x540112=await zip_1['Zip'][_0x1f7d84(0x11a)](_0x3d74be['values'][_0x1f7d84(0x127)]);for(const _0x2b3bc6 in _0x540112[_0x1f7d84(0x113)]){!_0x540112[_0x1f7d84(0x113)][_0x2b3bc6][_0x1f7d84(0xf0)]&&_0x50e247[_0x1f7d84(0xfa)]({'fileName':_0x2b3bc6[_0x1f7d84(0x122)](_0x2b3bc6[_0x1f7d84(0x128)]('/')+0x1),'fileType':_0x519add[_0x3d74be['id']],'body':_0x3d74be[_0x1f7d84(0x125)][_0x1f7d84(0x127)]});}}return _0x50e247;}async function removePermission(_0x58a126,_0x1b9074){const _0x3c126b=a86_0x1b9b03;for(const _0x26e45b of _0x58a126){const _0x4fdcd9=await zip_1[_0x3c126b(0x11b)][_0x3c126b(0x11a)](_0x26e45b['body']),_0x3e21c4=[];for(const _0x3b9e5e in _0x4fdcd9['files']){!_0x4fdcd9['files'][_0x3b9e5e][_0x3c126b(0xf0)]&&_0x3e21c4[_0x3c126b(0xfa)]({'fileName':_0x3b9e5e,'body':await _0x4fdcd9[_0x3c126b(0x113)][_0x3b9e5e][_0x3c126b(0x104)](_0x3c126b(0x105))});}const _0x2680eb=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x3e21c4[0x0][_0x3c126b(0x12e)]['toString'](),_0x1b9074,_0x26e45b[_0x3c126b(0xfe)]),_0x3c425d=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x500fdb=_0x3c425d[_0x3c126b(0x108)](_0x2680eb),_0x556bd0=zip_1['Zip'][_0x3c126b(0x123)]();_0x556bd0[_0x3c126b(0xfb)](_0x3e21c4[0x0][_0x3c126b(0x12b)],_0x500fdb),_0x26e45b[_0x3c126b(0x12e)]=await _0x556bd0['generateAsync']({'type':_0x3c126b(0xe8),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}function a86_0x6279(_0x244cb1,_0x28e479){const _0x3aec1a=a86_0x2615();return a86_0x6279=function(_0x2a3be2,_0x5674a2){_0x2a3be2=_0x2a3be2-0xe1;let _0x261561=_0x3aec1a[_0x2a3be2];return _0x261561;},a86_0x6279(_0x244cb1,_0x28e479);}async function replaceEnvironments(_0x594765,_0x28f586,_0x51783f){const _0x38cdc7=a86_0x1b9b03;for(const _0x648ab2 of _0x51783f){if(_0x594765['every'](_0x7de76b=>_0x7de76b!==_0x648ab2[_0x38cdc7(0xfe)]))continue;const _0x5e4b3c=await zip_1['Zip'][_0x38cdc7(0x11a)](_0x648ab2[_0x38cdc7(0x12e)]);for(const _0x296aec in _0x5e4b3c[_0x38cdc7(0x113)]){if(!_0x5e4b3c['files'][_0x296aec][_0x38cdc7(0xf0)]){let _0x2bd0f0=await _0x5e4b3c[_0x38cdc7(0x113)][_0x296aec][_0x38cdc7(0x104)](_0x38cdc7(0x105));for(const _0x193e63 of Object['keys'](_0x28f586)){const _0x5b457d=new RegExp('%%'+_0x193e63+'%%','g');_0x2bd0f0=_0x2bd0f0[_0x38cdc7(0xe1)](_0x5b457d,_0x28f586[_0x193e63]);}_0x5e4b3c[_0x38cdc7(0xfb)](_0x296aec,_0x2bd0f0);}}_0x648ab2[_0x38cdc7(0x12e)]=await _0x5e4b3c[_0x38cdc7(0xef)]({'type':'base64','compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x139c4b,_0x5dc4c2){const _0x5631=a86_0x1b9b03,_0x43f47e=new mdapi_1[(_0x5631(0x133))]({'components':_0x139c4b,'sourceDir':path_1[_0x5631(0x139)][_0x5631(0x106)](process[_0x5631(0x118)](),_0x5631(0x101),_0x5dc4c2,DEPLOY_DIR_NAME,_0x5631(0xfd)),'skipChildErrors':![]});await _0x43f47e[_0x5631(0x13a)]();}async function generateAndWritePackageXML(_0x19a264,_0x21ca77,_0xad786c,_0x1a4974){const _0x13e832=a86_0x1b9b03,_0x524e94=getComponentsTypeAndName(_0x19a264,_0x21ca77),_0x21b2a5=[...new Set(_0x524e94[_0x13e832(0x137)](_0x5a0916=>_0x5a0916[_0x13e832(0xeb)]))],_0x1daa25={'Package':{'$':{'xmlns':_0x13e832(0x11d)},'types':[],'version':''+_0x1a4974}};for(const _0x1380d1 of _0x21b2a5){const _0x420b35=_0x524e94['filter'](_0x290fc1=>_0x290fc1['type']===_0x1380d1)[_0x13e832(0x137)](_0x55b45d=>_0x55b45d[_0x13e832(0x126)]),_0x25db1e={'members':_0x420b35,'name':_0x1380d1};_0x1daa25['Package'][_0x13e832(0xe5)][_0x13e832(0xfa)](_0x25db1e);}const _0x394464=new xml2js_1[(_0x13e832(0x10c))]({'xmldec':{'version':_0x13e832(0xf6),'encoding':_0x13e832(0x11e)}}),_0x4e4109=_0x394464[_0x13e832(0x108)](_0x1daa25);await fs_internal_1['FS'][_0x13e832(0xea)](path_1[_0x13e832(0x139)][_0x13e832(0x106)](process['cwd'](),_0x13e832(0x101),_0xad786c,DEPLOY_DIR_NAME,_0x13e832(0xfd),_0x13e832(0x110)),_0x4e4109);}function getComponentsTypeAndName(_0x257ba0,_0x55fc45){const _0x1aa96d=a86_0x1b9b03;return _0x257ba0[_0x1aa96d(0x107)]((_0xbc75c7,_0x218d5e)=>{const _0x2d64c0=_0x1aa96d,_0xa24cb=_0x55fc45['find'](_0x15d2cb=>_0x15d2cb['Id']===_0x218d5e['ParentId']);return _0xa24cb&&_0xbc75c7['push']({'name':_0xa24cb['Component__r'][_0x2d64c0(0x11c)],'type':salesforce_1[_0x2d64c0(0x111)][_0x2d64c0(0x135)][_0x218d5e[_0x2d64c0(0xed)]]||_0x218d5e[_0x2d64c0(0xed)]}),_0xbc75c7;},[]);}async function saveDestructiveChanges(_0xbfe4d5,_0x3a97d1,_0x199dd9,_0x1dbef8){const _0x10eb5d=a86_0x1b9b03,_0x4e6d04=(await(0x0,fetch_attachments_1[_0x10eb5d(0x109)])(_0xbfe4d5,_0x3a97d1))['toString']();await fs_internal_1['FS'][_0x10eb5d(0xea)](path_1[_0x10eb5d(0x139)]['join'](process[_0x10eb5d(0x118)](),_0x10eb5d(0x101),_0x1dbef8,DEPLOY_DIR_NAME,_0x10eb5d(0xfd),_0x199dd9),_0x4e6d04);}async function createDeployZip(_0x10da0b){const _0x5c1576=a86_0x1b9b03,_0x33d24c=new adm_zip_1[(_0x5c1576(0x139))]();return await _0x33d24c[_0x5c1576(0x134)](path_1[_0x5c1576(0x139)]['join'](process[_0x5c1576(0x118)](),_0x5c1576(0x101),_0x10da0b,DEPLOY_DIR_NAME)),_0x33d24c;}function a86_0x2615(){const _0x3e1573=['(((.+)+)+)+$','2689920ajqmEA','Profile','push','file','path','src','fileType','generateAndDeployZip','/sobjects/Attachment','.temp','adm-zip','toBuffer','async','text','join','reduce','buildObject','fetchAttachmentBody','length','ComponentsApi','Builder','../utils/components-api','../utils/extract-component-permissions','30506pzlBFh','package.xml','MetadataConstants','MAX_ZIP_SIZE','files','constructor','../../git/parsers/utils/zip','orgId','903670YCenTt','cwd','279XEMsuS','unzip','Zip','Component_Name__c','http://soap.sforce.com/2006/04/metadata','UTF-8','filter','DEPLOYZIP','10YdXpFf','substring','createZip','BUILD','values','name','Body','indexOf','fetchComponentsDetailsByComponentsHistory','toString','fileName','19664lpzhJE','1WBPspT','body','__esModule','destructiveChangesPost.xml','defineProperty','apply','MDApiWriter','addLocalFolder','FOLDER_TO_METADATA_TYPE_MAP','uuid','map','6iwRdJd','default','start','replace','then','/services/data/v','search','types','20421RZyOqI','xml2js','base64','retrieveAttachments','writeFile','type','destructiveChangesPre.xml','Name','fetchAttachmentsDetailsById','generateAsync','dir','../../git/parsers/mdapi','2512JRxQTI','3712687KDcggA','4617000ylftwO','splitZip','1.0'];a86_0x2615=function(){return _0x3e1573;};return a86_0x2615();}async function insertZip(_0x25c85e,_0x39b17a,_0x3b75db,_0x58090f,_0xbee9c1,_0x32734c){const _0x1abc5b=a86_0x1b9b03,_0x5f1946={'ParentId':_0x39b17a,'Name':_0x1abc5b(0x124)+_0x3b75db,'Description':_0x1abc5b(0x124)+_0x58090f,'Body':_0xbee9c1},{data:_0x1bc80c}=await _0x25c85e['post'](_0x1abc5b(0xe3)+_0x32734c+_0x1abc5b(0x100),_0x5f1946);return _0x1bc80c['id'];}