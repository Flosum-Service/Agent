const a85_0x1445bd=a85_0x20e8;(function(_0x27ea44,_0x21e4d2){const _0x332d0c=a85_0x20e8,_0x51c8e6=_0x27ea44();while(!![]){try{const _0x500046=-parseInt(_0x332d0c(0x116))/0x1+-parseInt(_0x332d0c(0x152))/0x2+parseInt(_0x332d0c(0x167))/0x3+parseInt(_0x332d0c(0x143))/0x4*(parseInt(_0x332d0c(0x140))/0x5)+-parseInt(_0x332d0c(0x11f))/0x6+parseInt(_0x332d0c(0x12b))/0x7*(parseInt(_0x332d0c(0x117))/0x8)+parseInt(_0x332d0c(0x141))/0x9;if(_0x500046===_0x21e4d2)break;else _0x51c8e6['push'](_0x51c8e6['shift']());}catch(_0x45cb67){_0x51c8e6['push'](_0x51c8e6['shift']());}}}(a85_0x1902,0xe17b5));const a85_0x148cb7=(function(){let _0x3892d3=!![];return function(_0x47e787,_0x1e2ba3){const _0x4cf5c1=_0x3892d3?function(){if(_0x1e2ba3){const _0x83cb92=_0x1e2ba3['apply'](_0x47e787,arguments);return _0x1e2ba3=null,_0x83cb92;}}:function(){};return _0x3892d3=![],_0x4cf5c1;};}()),a85_0x275be4=a85_0x148cb7(this,function(){const _0x2e8e70=a85_0x20e8;return a85_0x275be4[_0x2e8e70(0x12f)]()['search']('(((.+)+)+)+$')[_0x2e8e70(0x12f)]()['constructor'](a85_0x275be4)[_0x2e8e70(0x15c)]('(((.+)+)+)+$');});a85_0x275be4();'use strict';var __importDefault=this&&this[a85_0x1445bd(0x13b)]||function(_0x4746b4){const _0x32c767=a85_0x1445bd;return _0x4746b4&&_0x4746b4[_0x32c767(0x13a)]?_0x4746b4:{'default':_0x4746b4};};Object[a85_0x1445bd(0x153)](exports,a85_0x1445bd(0x13a),{'value':!![]}),exports[a85_0x1445bd(0x145)]=void 0x0;const constants_1=require(a85_0x1445bd(0x151)),path_1=__importDefault(require(a85_0x1445bd(0x14c))),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a85_0x1445bd(0x149)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a85_0x1445bd(0x128)),components_api_1=require(a85_0x1445bd(0x133)),adm_zip_1=__importDefault(require(a85_0x1445bd(0x132))),uuid_1=require(a85_0x1445bd(0x11e)),fetch_attachments_1=require(a85_0x1445bd(0x138)),DESTRUCTIVE_CHANGES_PER_NAME=a85_0x1445bd(0x14e),DESTRUCTIVE_CHANGES_POST_NAME=a85_0x1445bd(0x125),DEPLOY_DIR_NAME=a85_0x1445bd(0x15a);async function generateAndDeployZip({attachmentsId:_0xad500d,isExtractComponentsPermissions:_0x354980,preDestructiveAttachmentId:_0x39870a,postDestructiveAttachmentId:_0x3558c1,branchId:_0x21dee8,credentials:_0x3e7099,metadataLogId:_0x49dc59,environments:_0x44350c,metaTypes:_0x15a215},_0x21f07b){const _0x15ae01=a85_0x1445bd,_0x3b38f6=(0x0,uuid_1['v4'])();try{const _0x36b69f=await(0x0,fetch_attachments_1[_0x15ae01(0x12c)])(_0x21f07b,_0xad500d),_0x4fb47e=_0x36b69f[_0x15ae01(0x134)]((_0x315d93,_0x58e1e3)=>({..._0x315d93,[_0x58e1e3['Id']]:_0x58e1e3[_0x15ae01(0x15b)]}),{}),_0x19a2f6=await getComponents(_0x36b69f,_0x21f07b,_0x4fb47e),_0x4f282d=await components_api_1[_0x15ae01(0x15d)][_0x15ae01(0x170)](_0x21f07b,_0x36b69f[_0x15ae01(0x131)](({ParentId:_0x412e8c})=>_0x412e8c))[_0x15ae01(0x13c)](_0x1955bd=>components_api_1['ComponentsApi'][_0x15ae01(0x12e)](_0x1955bd));if(_0x354980){const _0x4a98e0=_0x19a2f6[_0x15ae01(0x11a)](({fileType:_0x222686})=>_0x222686===_0x15ae01(0x129)||_0x222686===_0x15ae01(0x168));await removePermission(_0x4a98e0,_0x4f282d);}await replaceEnvironments(_0x15a215,_0x44350c,_0x19a2f6),await writeZip(_0x19a2f6,_0x3b38f6),await generateAndWritePackageXML(_0x36b69f,_0x4f282d,_0x3b38f6);_0x39870a&&await saveDestructiveChanges(_0x21f07b,_0x39870a,DESTRUCTIVE_CHANGES_PER_NAME,_0x3b38f6);_0x3558c1&&await saveDestructiveChanges(_0x21f07b,_0x3558c1,DESTRUCTIVE_CHANGES_POST_NAME,_0x3b38f6);const _0x572132=(await createDeployZip(_0x3b38f6)['then'](_0x187a4a=>{return _0x187a4a;}))['toBuffer']()[_0x15ae01(0x12f)](_0x15ae01(0x11b));console[_0x15ae01(0x13d)]('after\x20create\x20zip');const _0x390a74=_0x572132[_0x15ae01(0x148)];if(_0x390a74>=components_api_1[_0x15ae01(0x130)]){const _0x40d9f3=await createDeployZip(_0x3b38f6);console[_0x15ae01(0x13d)](_0x15ae01(0x165));const [_0x331a1e,_0x4cbd6b]=await components_api_1['ComponentsApi'][_0x15ae01(0x13e)](_0x40d9f3,_0x390a74),_0x1f4cbe=await insertZip(_0x21f07b,_0x21dee8,_0x3e7099[_0x15ae01(0x120)],_0x49dc59,_0x331a1e[_0x15ae01(0x136)]()[_0x15ae01(0x12f)](_0x15ae01(0x11b))),_0x5a8b15=await insertZip(_0x21f07b,_0x21dee8,_0x3e7099['orgId'],_0x49dc59,_0x4cbd6b['toBuffer']()[_0x15ae01(0x12f)](_0x15ae01(0x11b)));return _0x1f4cbe+','+_0x5a8b15;}else return await insertZip(_0x21f07b,_0x21dee8,_0x3e7099[_0x15ae01(0x120)],_0x49dc59,_0x572132);}catch(_0x2a52b6){throw _0x2a52b6;}finally{if(await fs_internal_1['FS'][_0x15ae01(0x160)](path_1['default']['join'](process[_0x15ae01(0x15e)](),_0x15ae01(0x161),_0x3b38f6)))await(0x0,promises_1['rm'])(path_1[_0x15ae01(0x16e)][_0x15ae01(0x150)](process[_0x15ae01(0x15e)](),_0x15ae01(0x161),_0x3b38f6),{'recursive':!![]});}}exports[a85_0x1445bd(0x145)]=generateAndDeployZip;function a85_0x1902(){const _0x6dfafd=['indexOf','join','../../../constants','1070058XzTdmX','defineProperty','Package','Zip','DEFLATE','unzip','substring','Body','DEPLOYZIP','Name','search','ComponentsApi','cwd','generateAsync','exists','.temp','type','text','Component_Name__c','after\x20create\x20second\x20zip','writeFile','835101gkiSzo','PermissionSet','async','UTF-8','BUILD','types','push','default','fetchAttachmentBody','fetchComponentsDetailsByComponentsHistory','Builder','1057086MAcgew','1694864SjSelj','MDApiWriter','start','filter','base64','dir','SALESFORCE_API_VERSION','uuid','7046448KVhKRq','orgId','name','fileType','buildObject','body','destructiveChangesPost.xml','package.xml','values','fs/promises','Profile','1.0','28zqCeco','fetchAttachmentsDetailsById','every','removeNamespacePrefix','toString','MAX_ZIP_SIZE','map','adm-zip','../utils/components-api','reduce','files','toBuffer','createZip','../../shared/utils/fetch-attachments','retrieveAttachments','__esModule','__importDefault','then','log','splitZip','post','29195uQjNLf','13461840IctSHt','/sobjects/Attachment','732bISLUp','extractComponentPermissions','generateAndDeployZip','ParentId','http://soap.sforce.com/2006/04/metadata','length','xml2js','addLocalFolder','src','path','file','destructiveChangesPre.xml'];a85_0x1902=function(){return _0x6dfafd;};return a85_0x1902();}async function getComponents(_0x14fbc3,_0x8dfff2,_0x284bb1){const _0x4b84e7=a85_0x1445bd,_0x123c9e=[],_0x5e53c9=await(0x0,fetch_attachments_1[_0x4b84e7(0x139)])(_0x14fbc3,_0x8dfff2);return await getComponentFromZip(_0x5e53c9,_0x284bb1)[_0x4b84e7(0x13c)](_0xad97ad=>{const _0x5ad3a5=_0x4b84e7;_0x123c9e[_0x5ad3a5(0x16d)](..._0xad97ad);}),_0x123c9e;}async function getComponentFromZip(_0x218583,_0x14d76f){const _0x17b08c=a85_0x1445bd,_0x48e6b7=[];for(const _0x1a3b5a of _0x218583){const _0x547cee=await zip_1[_0x17b08c(0x155)]['unzip'](_0x1a3b5a[_0x17b08c(0x127)][_0x17b08c(0x159)]);for(const _0x548335 in _0x547cee[_0x17b08c(0x135)]){!_0x547cee['files'][_0x548335]['dir']&&_0x48e6b7[_0x17b08c(0x16d)]({'fileName':_0x548335['substring'](_0x548335[_0x17b08c(0x14f)]('/')+0x1),'fileType':_0x14d76f[_0x1a3b5a['id']],'body':_0x1a3b5a[_0x17b08c(0x127)][_0x17b08c(0x159)]});}}return _0x48e6b7;}async function removePermission(_0x3c6ec5,_0x56bda3){const _0x45d866=a85_0x1445bd;for(const _0x30ba49 of _0x3c6ec5){const _0x2da379=await zip_1[_0x45d866(0x155)]['unzip'](_0x30ba49[_0x45d866(0x124)]),_0x454a97=[];for(const _0x12b2e2 in _0x2da379[_0x45d866(0x135)]){!_0x2da379[_0x45d866(0x135)][_0x12b2e2][_0x45d866(0x11c)]&&_0x454a97[_0x45d866(0x16d)]({'fileName':_0x12b2e2,'body':await _0x2da379[_0x45d866(0x135)][_0x12b2e2][_0x45d866(0x169)](_0x45d866(0x163))});}const _0x199611=await(0x0,extract_component_permissions_1[_0x45d866(0x144)])(_0x454a97[0x0][_0x45d866(0x124)][_0x45d866(0x12f)](),_0x56bda3,_0x30ba49[_0x45d866(0x122)]),_0x55d5c9=new xml2js_1['Builder']({'xmldec':{'version':_0x45d866(0x12a),'encoding':'UTF-8'}}),_0x249847=_0x55d5c9[_0x45d866(0x123)](_0x199611),_0x104ef7=zip_1[_0x45d866(0x155)][_0x45d866(0x137)]();_0x104ef7['file'](_0x454a97[0x0]['fileName'],_0x249847),_0x30ba49[_0x45d866(0x124)]=await _0x104ef7[_0x45d866(0x15f)]({'type':'base64','compression':_0x45d866(0x156),'compressionOptions':{'level':0x6}});}}function a85_0x20e8(_0x59a66d,_0xe46886){const _0xa400c=a85_0x1902();return a85_0x20e8=function(_0x275be4,_0x148cb7){_0x275be4=_0x275be4-0x116;let _0x190221=_0xa400c[_0x275be4];return _0x190221;},a85_0x20e8(_0x59a66d,_0xe46886);}async function replaceEnvironments(_0x434792,_0x3f534c,_0x561c6d){const _0x2393e3=a85_0x1445bd;for(const _0x3ca5bc of _0x561c6d){if(_0x434792[_0x2393e3(0x12d)](_0x464508=>_0x464508!==_0x3ca5bc['fileType']))continue;const _0x282a85=await zip_1[_0x2393e3(0x155)][_0x2393e3(0x157)](_0x3ca5bc['body']);for(const _0x31ae23 in _0x282a85[_0x2393e3(0x135)]){if(!_0x282a85[_0x2393e3(0x135)][_0x31ae23]['dir']){let _0x19e4db=await _0x282a85[_0x2393e3(0x135)][_0x31ae23]['async']('text');for(const _0x4c376b of Object['keys'](_0x3f534c)){const _0x223848=new RegExp('%%'+_0x4c376b+'%%','g');_0x19e4db=_0x19e4db['replace'](_0x223848,_0x3f534c[_0x4c376b]);}_0x282a85[_0x2393e3(0x14d)](_0x31ae23,_0x19e4db);}}_0x3ca5bc[_0x2393e3(0x124)]=await _0x282a85['generateAsync']({'type':_0x2393e3(0x11b),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x37a92b,_0xc1a3cc){const _0x239af3=a85_0x1445bd,_0x2ef6be=new mdapi_1[(_0x239af3(0x118))]({'components':_0x37a92b,'sourceDir':path_1[_0x239af3(0x16e)][_0x239af3(0x150)](process[_0x239af3(0x15e)](),'.temp',_0xc1a3cc,DEPLOY_DIR_NAME,_0x239af3(0x14b)),'skipChildErrors':![]});await _0x2ef6be[_0x239af3(0x119)]();}async function generateAndWritePackageXML(_0x3d703f,_0x30c6c7,_0x593085){const _0x24554c=a85_0x1445bd,_0x8b42ec=getComponentsTypeAndName(_0x3d703f,_0x30c6c7),_0x24cf27=[...new Set(_0x8b42ec['map'](_0x177459=>_0x177459[_0x24554c(0x162)]))],_0x3dcfaf={'Package':{'$':{'xmlns':_0x24554c(0x147)},'types':[],'version':''+constants_1[_0x24554c(0x11d)][_0x24554c(0x158)](0x1)}};for(const _0x57ab55 of _0x24cf27){const _0x18b625=_0x8b42ec[_0x24554c(0x11a)](_0x33fe2a=>_0x33fe2a[_0x24554c(0x162)]===_0x57ab55)[_0x24554c(0x131)](_0xf2beaa=>_0xf2beaa[_0x24554c(0x121)]),_0x10cef3={'members':_0x18b625,'name':_0x57ab55};_0x3dcfaf[_0x24554c(0x154)][_0x24554c(0x16c)]['push'](_0x10cef3);}const _0x27874c=new xml2js_1[(_0x24554c(0x171))]({'xmldec':{'version':_0x24554c(0x12a),'encoding':_0x24554c(0x16a)}}),_0x10cfdd=_0x27874c['buildObject'](_0x3dcfaf);await fs_internal_1['FS']['writeFile'](path_1[_0x24554c(0x16e)][_0x24554c(0x150)](process[_0x24554c(0x15e)](),_0x24554c(0x161),_0x593085,DEPLOY_DIR_NAME,'src',_0x24554c(0x126)),_0x10cfdd);}function getComponentsTypeAndName(_0x5cabcc,_0x447eeb){const _0x4c54b2=a85_0x1445bd;return _0x5cabcc[_0x4c54b2(0x134)]((_0x2be871,_0x174e14)=>{const _0x2a19c8=_0x4c54b2,_0x46d742=_0x447eeb['find'](_0x3ced40=>_0x3ced40['Id']===_0x174e14[_0x2a19c8(0x146)]);return _0x46d742&&_0x2be871[_0x2a19c8(0x16d)]({'name':_0x46d742['Component__r'][_0x2a19c8(0x164)],'type':_0x174e14['Name']}),_0x2be871;},[]);}async function saveDestructiveChanges(_0x2ccf13,_0x2940b9,_0x538564,_0x3ccb30){const _0x34d343=a85_0x1445bd,_0x5ba8c9=(await(0x0,fetch_attachments_1[_0x34d343(0x16f)])(_0x2ccf13,_0x2940b9))['toString']();await fs_internal_1['FS'][_0x34d343(0x166)](path_1[_0x34d343(0x16e)][_0x34d343(0x150)](process[_0x34d343(0x15e)](),_0x34d343(0x161),_0x3ccb30,DEPLOY_DIR_NAME,_0x34d343(0x14b),_0x538564),_0x5ba8c9);}async function createDeployZip(_0x2b5538){const _0x5b473c=a85_0x1445bd,_0x18a1f5=new adm_zip_1[(_0x5b473c(0x16e))]();return await _0x18a1f5[_0x5b473c(0x14a)](path_1[_0x5b473c(0x16e)][_0x5b473c(0x150)](process[_0x5b473c(0x15e)](),_0x5b473c(0x161),_0x2b5538,DEPLOY_DIR_NAME)),_0x18a1f5;}async function insertZip(_0x347b49,_0x3ca80d,_0x145f80,_0x4ac82b,_0x33b73a){const _0x5c3d49=a85_0x1445bd,_0x4bb08d={'ParentId':_0x3ca80d,'Name':_0x5c3d49(0x16b)+_0x145f80,'Description':'BUILD'+_0x4ac82b,'Body':_0x33b73a},{data:_0x4578b4}=await _0x347b49[_0x5c3d49(0x13f)]('/services/data/'+constants_1[_0x5c3d49(0x11d)]+_0x5c3d49(0x142),_0x4bb08d);return _0x4578b4['id'];}