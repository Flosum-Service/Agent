const a86_0x3aa237=a86_0x1155;(function(_0x3fcc7f,_0x82a828){const _0x540893=a86_0x1155,_0x57351a=_0x3fcc7f();while(!![]){try{const _0x50fb2b=-parseInt(_0x540893(0x162))/0x1*(-parseInt(_0x540893(0x114))/0x2)+-parseInt(_0x540893(0x16a))/0x3+-parseInt(_0x540893(0x125))/0x4+-parseInt(_0x540893(0x158))/0x5+-parseInt(_0x540893(0x153))/0x6+parseInt(_0x540893(0x148))/0x7*(-parseInt(_0x540893(0x14e))/0x8)+parseInt(_0x540893(0x155))/0x9*(parseInt(_0x540893(0x160))/0xa);if(_0x50fb2b===_0x82a828)break;else _0x57351a['push'](_0x57351a['shift']());}catch(_0x4fe484){_0x57351a['push'](_0x57351a['shift']());}}}(a86_0x5ee6,0x48642));const a86_0xe0655b=(function(){let _0x3f281d=!![];return function(_0x55b44c,_0x503f66){const _0x15b178=_0x3f281d?function(){const _0x32138f=a86_0x1155;if(_0x503f66){const _0x5ba179=_0x503f66[_0x32138f(0x169)](_0x55b44c,arguments);return _0x503f66=null,_0x5ba179;}}:function(){};return _0x3f281d=![],_0x15b178;};}()),a86_0x439d45=a86_0xe0655b(this,function(){const _0xb6694b=a86_0x1155;return a86_0x439d45['toString']()[_0xb6694b(0x14f)](_0xb6694b(0x118))['toString']()[_0xb6694b(0x129)](a86_0x439d45)['search'](_0xb6694b(0x118));});a86_0x439d45();'use strict';var __importDefault=this&&this[a86_0x3aa237(0x126)]||function(_0x4584b5){return _0x4584b5&&_0x4584b5['__esModule']?_0x4584b5:{'default':_0x4584b5};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a86_0x3aa237(0x13f)]=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require(a86_0x3aa237(0x143))),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a86_0x3aa237(0x134)),zip_1=require(a86_0x3aa237(0x152)),mdapi_1=require(a86_0x3aa237(0x131)),fs_internal_1=require(a86_0x3aa237(0x116)),promises_1=require('fs/promises'),components_api_1=require(a86_0x3aa237(0x133)),adm_zip_1=__importDefault(require(a86_0x3aa237(0x164))),uuid_1=require('uuid'),fetch_attachments_1=require(a86_0x3aa237(0x12c)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x3aa237(0x11d),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x3aa237(0x15e),DEPLOY_DIR_NAME=a86_0x3aa237(0x15c);async function generateAndDeployZip({attachmentsId:_0x438ee7,isExtractComponentsPermissions:_0x259192,preDestructiveAttachmentId:_0x4c1208,postDestructiveAttachmentId:_0x3026c2,branchId:_0x4387f3,credentials:_0x58265a,metadataLogId:_0x74f35f,environments:_0x962138,metaTypes:_0x13c1c0},_0x9f94ea){const _0x29a763=a86_0x3aa237,_0x3f1d55=(0x0,uuid_1['v4'])();try{const _0x294789=await(0x0,fetch_attachments_1[_0x29a763(0x13c)])(_0x9f94ea,_0x438ee7),_0x24b989=_0x294789['reduce']((_0x1c63d9,_0x119de1)=>({..._0x1c63d9,[_0x119de1['Id']]:_0x119de1[_0x29a763(0x13d)]}),{}),_0x434220=await getComponents(_0x294789,_0x9f94ea,_0x24b989),_0x54bd55=await components_api_1['ComponentsApi'][_0x29a763(0x14c)](_0x9f94ea,_0x294789[_0x29a763(0x141)](({ParentId:_0x31c467})=>_0x31c467))[_0x29a763(0x15b)](_0x3b00be=>components_api_1[_0x29a763(0x159)][_0x29a763(0x128)](_0x3b00be));if(_0x259192){const _0x902c0b=_0x434220['filter'](({fileType:_0x157135})=>_0x157135==='Profile'||_0x157135===_0x29a763(0x13a));await removePermission(_0x902c0b,_0x54bd55);}await replaceEnvironments(_0x13c1c0,_0x962138,_0x434220),await writeZip(_0x434220,_0x3f1d55),await generateAndWritePackageXML(_0x294789,_0x54bd55,_0x3f1d55);_0x4c1208&&await saveDestructiveChanges(_0x9f94ea,_0x4c1208,DESTRUCTIVE_CHANGES_PER_NAME,_0x3f1d55);_0x3026c2&&await saveDestructiveChanges(_0x9f94ea,_0x3026c2,DESTRUCTIVE_CHANGES_POST_NAME,_0x3f1d55);const _0x595fcc=(await createDeployZip(_0x3f1d55)['then'](_0x1fc0b3=>{return _0x1fc0b3;}))['toBuffer']()[_0x29a763(0x166)]('base64');console[_0x29a763(0x150)](_0x29a763(0x121));const _0x2b811f=_0x595fcc[_0x29a763(0x136)];if(_0x2b811f>=components_api_1[_0x29a763(0x14d)]){const _0x3c37e1=await createDeployZip(_0x3f1d55);console['log'](_0x29a763(0x12d));const [_0x2450d6,_0x27e6ab]=await components_api_1[_0x29a763(0x159)][_0x29a763(0x122)](_0x3c37e1,_0x2b811f),_0x23c442=await insertZip(_0x9f94ea,_0x4387f3,_0x58265a[_0x29a763(0x145)],_0x74f35f,_0x2450d6[_0x29a763(0x130)]()[_0x29a763(0x166)](_0x29a763(0x111))),_0x1ca85a=await insertZip(_0x9f94ea,_0x4387f3,_0x58265a[_0x29a763(0x145)],_0x74f35f,_0x27e6ab[_0x29a763(0x130)]()[_0x29a763(0x166)]('base64'));return _0x23c442+','+_0x1ca85a;}else return await insertZip(_0x9f94ea,_0x4387f3,_0x58265a[_0x29a763(0x145)],_0x74f35f,_0x595fcc);}catch(_0x48cb99){throw _0x48cb99;}finally{if(await fs_internal_1['FS'][_0x29a763(0x15d)](path_1[_0x29a763(0x147)]['join'](process['cwd'](),_0x29a763(0x137),_0x3f1d55)))await(0x0,promises_1['rm'])(path_1[_0x29a763(0x147)][_0x29a763(0x140)](process[_0x29a763(0x167)](),_0x29a763(0x137),_0x3f1d55),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x3b39c8,_0x329a56,_0x4c62e0){const _0x2ad812=a86_0x3aa237,_0xbce86f=[],_0x417c0e=await(0x0,fetch_attachments_1[_0x2ad812(0x144)])(_0x3b39c8,_0x329a56);return await getComponentFromZip(_0x417c0e,_0x4c62e0)['then'](_0x131113=>{const _0x54c650=_0x2ad812;_0xbce86f[_0x54c650(0x142)](..._0x131113);}),_0xbce86f;}async function getComponentFromZip(_0x2f3a4d,_0x548784){const _0x55adfa=a86_0x3aa237,_0x484745=[];for(const _0xc74180 of _0x2f3a4d){const _0x57c1a3=await zip_1[_0x55adfa(0x11b)][_0x55adfa(0x127)](_0xc74180['values'][_0x55adfa(0x120)]);for(const _0x478d9f in _0x57c1a3[_0x55adfa(0x11f)]){!_0x57c1a3[_0x55adfa(0x11f)][_0x478d9f][_0x55adfa(0x156)]&&_0x484745[_0x55adfa(0x142)]({'fileName':_0x478d9f[_0x55adfa(0x123)](_0x478d9f[_0x55adfa(0x132)]('/')+0x1),'fileType':_0x548784[_0xc74180['id']],'body':_0xc74180[_0x55adfa(0x12e)][_0x55adfa(0x120)]});}}return _0x484745;}async function removePermission(_0x485362,_0x491c42){const _0x659776=a86_0x3aa237;for(const _0x5d1da3 of _0x485362){const _0x54af90=await zip_1['Zip'][_0x659776(0x127)](_0x5d1da3['body']),_0xa1795a=[];for(const _0x11f1c1 in _0x54af90['files']){!_0x54af90[_0x659776(0x11f)][_0x11f1c1][_0x659776(0x156)]&&_0xa1795a['push']({'fileName':_0x11f1c1,'body':await _0x54af90[_0x659776(0x11f)][_0x11f1c1]['async'](_0x659776(0x113))});}const _0x5d7da2=await(0x0,extract_component_permissions_1[_0x659776(0x168)])(_0xa1795a[0x0]['body'][_0x659776(0x166)](),_0x491c42,_0x5d1da3[_0x659776(0x11e)]),_0x2cb041=new xml2js_1[(_0x659776(0x157))]({'xmldec':{'version':_0x659776(0x117),'encoding':_0x659776(0x151)}}),_0x211731=_0x2cb041[_0x659776(0x13b)](_0x5d7da2),_0x1f2c2d=zip_1['Zip'][_0x659776(0x124)]();_0x1f2c2d[_0x659776(0x163)](_0xa1795a[0x0]['fileName'],_0x211731),_0x5d1da3[_0x659776(0x12a)]=await _0x1f2c2d[_0x659776(0x11a)]({'type':_0x659776(0x111),'compression':_0x659776(0x15a),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x15a17e,_0x4caf4d,_0x18c078){const _0x1a1be3=a86_0x3aa237;for(const _0x48f97d of _0x18c078){if(_0x15a17e[_0x1a1be3(0x115)](_0x21b758=>_0x21b758!==_0x48f97d[_0x1a1be3(0x11e)]))continue;const _0x24e6b5=await zip_1['Zip'][_0x1a1be3(0x127)](_0x48f97d['body']);for(const _0x2e216e in _0x24e6b5[_0x1a1be3(0x11f)]){if(!_0x24e6b5['files'][_0x2e216e]['dir']){let _0x14e5b1=await _0x24e6b5[_0x1a1be3(0x11f)][_0x2e216e][_0x1a1be3(0x135)](_0x1a1be3(0x113));for(const _0x3eba76 of Object[_0x1a1be3(0x119)](_0x4caf4d)){const _0x478e7d=new RegExp('%%'+_0x3eba76+'%%','g');_0x14e5b1=_0x14e5b1[_0x1a1be3(0x149)](_0x478e7d,_0x4caf4d[_0x3eba76]);}_0x24e6b5['file'](_0x2e216e,_0x14e5b1);}}_0x48f97d['body']=await _0x24e6b5[_0x1a1be3(0x11a)]({'type':_0x1a1be3(0x111),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}function a86_0x1155(_0x41842b,_0x48a25c){const _0x4ed23f=a86_0x5ee6();return a86_0x1155=function(_0x439d45,_0xe0655b){_0x439d45=_0x439d45-0x111;let _0x5ee600=_0x4ed23f[_0x439d45];return _0x5ee600;},a86_0x1155(_0x41842b,_0x48a25c);}async function writeZip(_0x399619,_0x118167){const _0x4b2456=a86_0x3aa237,_0x6208eb=new mdapi_1[(_0x4b2456(0x13e))]({'components':_0x399619,'sourceDir':path_1[_0x4b2456(0x147)][_0x4b2456(0x140)](process[_0x4b2456(0x167)](),_0x4b2456(0x137),_0x118167,DEPLOY_DIR_NAME,_0x4b2456(0x161)),'skipChildErrors':![]});await _0x6208eb[_0x4b2456(0x112)]();}async function generateAndWritePackageXML(_0x3ce971,_0x36573c,_0x140524){const _0x54f864=a86_0x3aa237,_0x2118d1=getComponentsTypeAndName(_0x3ce971,_0x36573c),_0x15b76b=[...new Set(_0x2118d1[_0x54f864(0x141)](_0x24083e=>_0x24083e['type']))],_0x1e0062={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1[_0x54f864(0x14a)][_0x54f864(0x123)](0x1)}};for(const _0x5f5d09 of _0x15b76b){const _0x5f037f=_0x2118d1[_0x54f864(0x11c)](_0x135d69=>_0x135d69[_0x54f864(0x14b)]===_0x5f5d09)['map'](_0x52a5db=>_0x52a5db[_0x54f864(0x165)]),_0x144fce={'members':_0x5f037f,'name':_0x5f5d09};_0x1e0062['Package']['types'][_0x54f864(0x142)](_0x144fce);}const _0x1770f9=new xml2js_1[(_0x54f864(0x157))]({'xmldec':{'version':_0x54f864(0x117),'encoding':_0x54f864(0x151)}}),_0x3d9281=_0x1770f9[_0x54f864(0x13b)](_0x1e0062);await fs_internal_1['FS'][_0x54f864(0x138)](path_1['default']['join'](process['cwd'](),_0x54f864(0x137),_0x140524,DEPLOY_DIR_NAME,'src',_0x54f864(0x12b)),_0x3d9281);}function getComponentsTypeAndName(_0x4b76d0,_0x4fed9d){const _0x46fb27=a86_0x3aa237;return _0x4b76d0[_0x46fb27(0x12f)]((_0x214d63,_0x56d838)=>{const _0x2195e0=_0x4fed9d['find'](_0x5abbe4=>_0x5abbe4['Id']===_0x56d838['ParentId']);return _0x2195e0&&_0x214d63['push']({'name':_0x2195e0['Component__r']['Component_Name__c'],'type':_0x56d838['Name']}),_0x214d63;},[]);}async function saveDestructiveChanges(_0x4e8929,_0xcc2cd,_0x4d13ec,_0x260a40){const _0x6202bb=a86_0x3aa237,_0x1f81f2=(await(0x0,fetch_attachments_1[_0x6202bb(0x154)])(_0x4e8929,_0xcc2cd))[_0x6202bb(0x166)]();await fs_internal_1['FS']['writeFile'](path_1[_0x6202bb(0x147)][_0x6202bb(0x140)](process[_0x6202bb(0x167)](),_0x6202bb(0x137),_0x260a40,DEPLOY_DIR_NAME,_0x6202bb(0x161),_0x4d13ec),_0x1f81f2);}async function createDeployZip(_0x50eb19){const _0x4af044=a86_0x3aa237,_0x233b00=new adm_zip_1[(_0x4af044(0x147))]();return await _0x233b00[_0x4af044(0x146)](path_1['default'][_0x4af044(0x140)](process[_0x4af044(0x167)](),_0x4af044(0x137),_0x50eb19,DEPLOY_DIR_NAME)),_0x233b00;}async function insertZip(_0x5eb197,_0x398af8,_0x2df75f,_0x57a95b,_0xbcbc47){const _0x2dcc69=a86_0x3aa237,_0xf0a8a3={'ParentId':_0x398af8,'Name':_0x2dcc69(0x15f)+_0x2df75f,'Description':_0x2dcc69(0x15f)+_0x57a95b,'Body':_0xbcbc47},{data:_0x2510d4}=await _0x5eb197['post']('/services/data/'+constants_1[_0x2dcc69(0x14a)]+_0x2dcc69(0x139),_0xf0a8a3);return _0x2510d4['id'];}function a86_0x5ee6(){const _0xe85379=['path','retrieveAttachments','orgId','addLocalFolder','default','1312745PvDAYg','replace','SALESFORCE_API_VERSION','type','fetchComponentsDetailsByComponentsHistory','MAX_ZIP_SIZE','16xeakXU','search','log','UTF-8','../../git/parsers/utils/zip','2317440mfWePy','fetchAttachmentBody','6389514xVJOQf','dir','Builder','1478100gOEXAR','ComponentsApi','DEFLATE','then','DEPLOYZIP','exists','destructiveChangesPost.xml','BUILD','20IgQDQN','src','61LEIXSN','file','adm-zip','name','toString','cwd','extractComponentPermissions','apply','958842tdXSQx','base64','start','text','12626nmvtia','every','../../git/internal/fs.internal','1.0','(((.+)+)+)+$','keys','generateAsync','Zip','filter','destructiveChangesPre.xml','fileType','files','Body','after\x20create\x20zip','splitZip','substring','createZip','527708paktoi','__importDefault','unzip','removeNamespacePrefix','constructor','body','package.xml','../../shared/utils/fetch-attachments','after\x20create\x20second\x20zip','values','reduce','toBuffer','../../git/parsers/mdapi','indexOf','../utils/components-api','xml2js','async','length','.temp','writeFile','/sobjects/Attachment','PermissionSet','buildObject','fetchAttachmentsDetailsById','Name','MDApiWriter','generateAndDeployZip','join','map','push'];a86_0x5ee6=function(){return _0xe85379;};return a86_0x5ee6();}