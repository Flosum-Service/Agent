const a86_0x57fbcd=a86_0x3463;(function(_0x3e9dff,_0x157948){const _0x3f794e=a86_0x3463,_0x5abe8f=_0x3e9dff();while(!![]){try{const _0x2702c7=-parseInt(_0x3f794e(0xde))/0x1*(parseInt(_0x3f794e(0xe6))/0x2)+parseInt(_0x3f794e(0xcc))/0x3+-parseInt(_0x3f794e(0xd1))/0x4*(-parseInt(_0x3f794e(0x102))/0x5)+-parseInt(_0x3f794e(0x107))/0x6*(-parseInt(_0x3f794e(0xc9))/0x7)+parseInt(_0x3f794e(0xdd))/0x8+-parseInt(_0x3f794e(0xfc))/0x9+-parseInt(_0x3f794e(0xdb))/0xa;if(_0x2702c7===_0x157948)break;else _0x5abe8f['push'](_0x5abe8f['shift']());}catch(_0x768f77){_0x5abe8f['push'](_0x5abe8f['shift']());}}}(a86_0x3297,0xe939c));const a86_0x2dfa30=(function(){let _0x1aa3fc=!![];return function(_0x1d0201,_0x11f02d){const _0x4e54a5=_0x1aa3fc?function(){const _0x4ff102=a86_0x3463;if(_0x11f02d){const _0x4643ab=_0x11f02d[_0x4ff102(0x114)](_0x1d0201,arguments);return _0x11f02d=null,_0x4643ab;}}:function(){};return _0x1aa3fc=![],_0x4e54a5;};}()),a86_0x42ab06=a86_0x2dfa30(this,function(){const _0x66b7f1=a86_0x3463;return a86_0x42ab06[_0x66b7f1(0x106)]()[_0x66b7f1(0xe7)](_0x66b7f1(0xf9))[_0x66b7f1(0x106)]()['constructor'](a86_0x42ab06)[_0x66b7f1(0xe7)](_0x66b7f1(0xf9));});a86_0x42ab06();'use strict';function a86_0x3297(){const _0x5e7dd3=['.temp','splitZip','buildObject','base64','every','../../shared/utils/fetch-attachments','(((.+)+)+)+$','text','Name','7370091kiGdUj','extractComponentPermissions','fileName','PermissionSet','generateAsync','Package','5nScTzM','types','toBuffer','map','toString','6oiPOVk','SALESFORCE_API_VERSION','Body','Zip','1.0','post','writeFile','cwd','join','MAX_ZIP_SIZE','Builder','addLocalFolder','dir','apply','/services/data/','default','ParentId','src','ComponentsApi','DEPLOYZIP','replace','uuid','__importDefault','../utils/components-api','defineProperty','package.xml','keys','BUILD','push','files','10055087VMlJiI','UTF-8','length','4359963aNTuwW','generateAndDeployZip','unzip','Profile','http://soap.sforce.com/2006/04/metadata','5750244qtWUCZ','/sobjects/Attachment','../../git/parsers/mdapi','../utils/extract-component-permissions','../../../constants','reduce','path','fetchComponentsDetailsByComponentsHistory','name','fetchAttachmentBody','33340910McEgjz','values','9449080LYEMZi','7146RWDraB','substring','MDApiWriter','then','body','removeNamespacePrefix','exists','orgId','112OYgAoZ','search','fs/promises','xml2js','after\x20create\x20zip','createZip','type','fetchAttachmentsDetailsById','DEFLATE','../../git/parsers/utils/zip','__esModule','destructiveChangesPre.xml','find'];a86_0x3297=function(){return _0x5e7dd3;};return a86_0x3297();}var __importDefault=this&&this[a86_0x57fbcd(0xc1)]||function(_0x431a60){const _0x6e58e4=a86_0x57fbcd;return _0x431a60&&_0x431a60[_0x6e58e4(0xf0)]?_0x431a60:{'default':_0x431a60};};Object[a86_0x57fbcd(0xc3)](exports,a86_0x57fbcd(0xf0),{'value':!![]}),exports[a86_0x57fbcd(0xcd)]=void 0x0;const constants_1=require(a86_0x57fbcd(0xd5)),path_1=__importDefault(require(a86_0x57fbcd(0xd7))),extract_component_permissions_1=require(a86_0x57fbcd(0xd4)),xml2js_1=require(a86_0x57fbcd(0xe9)),zip_1=require(a86_0x57fbcd(0xef)),mdapi_1=require(a86_0x57fbcd(0xd3)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a86_0x57fbcd(0xe8)),components_api_1=require(a86_0x57fbcd(0xc2)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a86_0x57fbcd(0xc0)),fetch_attachments_1=require(a86_0x57fbcd(0xf8)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x57fbcd(0xf1),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a86_0x57fbcd(0xbe);async function generateAndDeployZip({attachmentsId:_0x1df25b,isExtractComponentsPermissions:_0x129027,preDestructiveAttachmentId:_0x307496,postDestructiveAttachmentId:_0xe65e71,branchId:_0x1f4140,credentials:_0x14d925,metadataLogId:_0x3344eb,environments:_0x219375,metaTypes:_0x10a5d8},_0x449c41){const _0x1ddde3=a86_0x57fbcd,_0x4e44ac=(0x0,uuid_1['v4'])();try{const _0x31ef34=await(0x0,fetch_attachments_1[_0x1ddde3(0xed)])(_0x449c41,_0x1df25b),_0x150ab3=_0x31ef34[_0x1ddde3(0xd6)]((_0x91deec,_0x390ee6)=>({..._0x91deec,[_0x390ee6['Id']]:_0x390ee6['Name']}),{}),_0x329b42=await getComponents(_0x31ef34,_0x449c41,_0x150ab3),_0x3fe823=await components_api_1[_0x1ddde3(0xbd)][_0x1ddde3(0xd8)](_0x449c41,_0x31ef34[_0x1ddde3(0x105)](({ParentId:_0x55004a})=>_0x55004a))['then'](_0x577868=>components_api_1[_0x1ddde3(0xbd)][_0x1ddde3(0xe3)](_0x577868));if(_0x129027){const _0x14b95b=_0x329b42['filter'](({fileType:_0x495d00})=>_0x495d00===_0x1ddde3(0xcf)||_0x495d00===_0x1ddde3(0xff));await removePermission(_0x14b95b,_0x3fe823);}await replaceEnvironments(_0x10a5d8,_0x219375,_0x329b42),await writeZip(_0x329b42,_0x4e44ac),await generateAndWritePackageXML(_0x31ef34,_0x3fe823,_0x4e44ac);_0x307496&&await saveDestructiveChanges(_0x449c41,_0x307496,DESTRUCTIVE_CHANGES_PER_NAME,_0x4e44ac);_0xe65e71&&await saveDestructiveChanges(_0x449c41,_0xe65e71,DESTRUCTIVE_CHANGES_POST_NAME,_0x4e44ac);const _0x23d02b=(await createDeployZip(_0x4e44ac)[_0x1ddde3(0xe1)](_0xef0940=>{return _0xef0940;}))[_0x1ddde3(0x104)]()[_0x1ddde3(0x106)](_0x1ddde3(0xf6));console['log'](_0x1ddde3(0xea));const _0x314f3f=_0x23d02b[_0x1ddde3(0xcb)];if(_0x314f3f>=components_api_1[_0x1ddde3(0x110)]){const _0x76e735=await createDeployZip(_0x4e44ac);console['log']('after\x20create\x20second\x20zip');const [_0x23f3ec,_0x430efa]=await components_api_1[_0x1ddde3(0xbd)][_0x1ddde3(0xf4)](_0x76e735,_0x314f3f),_0x381a06=await insertZip(_0x449c41,_0x1f4140,_0x14d925[_0x1ddde3(0xe5)],_0x3344eb,_0x23f3ec[_0x1ddde3(0x104)]()[_0x1ddde3(0x106)]('base64')),_0x316425=await insertZip(_0x449c41,_0x1f4140,_0x14d925[_0x1ddde3(0xe5)],_0x3344eb,_0x430efa[_0x1ddde3(0x104)]()[_0x1ddde3(0x106)](_0x1ddde3(0xf6)));return _0x381a06+','+_0x316425;}else return await insertZip(_0x449c41,_0x1f4140,_0x14d925['orgId'],_0x3344eb,_0x23d02b);}catch(_0x1b0cb8){throw _0x1b0cb8;}finally{if(await fs_internal_1['FS'][_0x1ddde3(0xe4)](path_1[_0x1ddde3(0xba)][_0x1ddde3(0x10f)](process[_0x1ddde3(0x10e)](),'.temp',_0x4e44ac)))await(0x0,promises_1['rm'])(path_1['default']['join'](process[_0x1ddde3(0x10e)](),_0x1ddde3(0xf3),_0x4e44ac),{'recursive':!![]});}}exports[a86_0x57fbcd(0xcd)]=generateAndDeployZip;async function getComponents(_0x3bd8d5,_0x3c0392,_0x47b746){const _0x507b74=a86_0x57fbcd,_0x359a41=[],_0x5d5c9b=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x3bd8d5,_0x3c0392);return await getComponentFromZip(_0x5d5c9b,_0x47b746)[_0x507b74(0xe1)](_0x987906=>{const _0x3324ef=_0x507b74;_0x359a41[_0x3324ef(0xc7)](..._0x987906);}),_0x359a41;}async function getComponentFromZip(_0x12af07,_0x43f061){const _0x31192c=a86_0x57fbcd,_0x542054=[];for(const _0x454655 of _0x12af07){const _0x3ce2e0=await zip_1[_0x31192c(0x10a)][_0x31192c(0xce)](_0x454655[_0x31192c(0xdc)]['Body']);for(const _0x2504b3 in _0x3ce2e0[_0x31192c(0xc8)]){!_0x3ce2e0[_0x31192c(0xc8)][_0x2504b3]['dir']&&_0x542054[_0x31192c(0xc7)]({'fileName':_0x2504b3[_0x31192c(0xdf)](_0x2504b3['indexOf']('/')+0x1),'fileType':_0x43f061[_0x454655['id']],'body':_0x454655[_0x31192c(0xdc)][_0x31192c(0x109)]});}}return _0x542054;}async function removePermission(_0x190443,_0x5751c5){const _0x40dec5=a86_0x57fbcd;for(const _0x1f1d4e of _0x190443){const _0x52538d=await zip_1[_0x40dec5(0x10a)][_0x40dec5(0xce)](_0x1f1d4e['body']),_0x28b888=[];for(const _0x5859c3 in _0x52538d[_0x40dec5(0xc8)]){!_0x52538d[_0x40dec5(0xc8)][_0x5859c3][_0x40dec5(0x113)]&&_0x28b888['push']({'fileName':_0x5859c3,'body':await _0x52538d['files'][_0x5859c3]['async'](_0x40dec5(0xfa))});}const _0x121906=await(0x0,extract_component_permissions_1[_0x40dec5(0xfd)])(_0x28b888[0x0][_0x40dec5(0xe2)][_0x40dec5(0x106)](),_0x5751c5,_0x1f1d4e['fileType']),_0x39d59b=new xml2js_1['Builder']({'xmldec':{'version':_0x40dec5(0x10b),'encoding':_0x40dec5(0xca)}}),_0x535491=_0x39d59b[_0x40dec5(0xf5)](_0x121906),_0xfc8dfe=zip_1[_0x40dec5(0x10a)][_0x40dec5(0xeb)]();_0xfc8dfe['file'](_0x28b888[0x0][_0x40dec5(0xfe)],_0x535491),_0x1f1d4e['body']=await _0xfc8dfe[_0x40dec5(0x100)]({'type':'base64','compression':_0x40dec5(0xee),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x15b794,_0x253e42,_0x43aed9){const _0x42514b=a86_0x57fbcd;for(const _0x36060e of _0x43aed9){if(_0x15b794[_0x42514b(0xf7)](_0x1de466=>_0x1de466!==_0x36060e['fileType']))continue;const _0x3b0e72=await zip_1[_0x42514b(0x10a)][_0x42514b(0xce)](_0x36060e[_0x42514b(0xe2)]);for(const _0x168572 in _0x3b0e72[_0x42514b(0xc8)]){if(!_0x3b0e72[_0x42514b(0xc8)][_0x168572][_0x42514b(0x113)]){let _0x515911=await _0x3b0e72[_0x42514b(0xc8)][_0x168572]['async'](_0x42514b(0xfa));for(const _0x371f64 of Object[_0x42514b(0xc5)](_0x253e42)){const _0x40a46c=new RegExp('%%'+_0x371f64+'%%','g');_0x515911=_0x515911[_0x42514b(0xbf)](_0x40a46c,_0x253e42[_0x371f64]);}_0x3b0e72['file'](_0x168572,_0x515911);}}_0x36060e[_0x42514b(0xe2)]=await _0x3b0e72[_0x42514b(0x100)]({'type':'base64','compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x104034,_0x426608){const _0x2684a4=a86_0x57fbcd,_0x468b9d=new mdapi_1[(_0x2684a4(0xe0))]({'components':_0x104034,'sourceDir':path_1[_0x2684a4(0xba)]['join'](process['cwd'](),_0x2684a4(0xf3),_0x426608,DEPLOY_DIR_NAME,_0x2684a4(0xbc)),'skipChildErrors':![]});await _0x468b9d['start']();}async function generateAndWritePackageXML(_0x4cab2e,_0x141e17,_0x188ded){const _0x3878f3=a86_0x57fbcd,_0x3b8b69=getComponentsTypeAndName(_0x4cab2e,_0x141e17),_0x30bc8f=[...new Set(_0x3b8b69['map'](_0x58b255=>_0x58b255['type']))],_0x100ac2={'Package':{'$':{'xmlns':_0x3878f3(0xd0)},'types':[],'version':''+constants_1[_0x3878f3(0x108)][_0x3878f3(0xdf)](0x1)}};for(const _0x376cf9 of _0x30bc8f){const _0x1dbae5=_0x3b8b69['filter'](_0x2090a6=>_0x2090a6[_0x3878f3(0xec)]===_0x376cf9)[_0x3878f3(0x105)](_0x4c973=>_0x4c973[_0x3878f3(0xd9)]),_0x57a492={'members':_0x1dbae5,'name':_0x376cf9};_0x100ac2[_0x3878f3(0x101)][_0x3878f3(0x103)][_0x3878f3(0xc7)](_0x57a492);}const _0xea839f=new xml2js_1[(_0x3878f3(0x111))]({'xmldec':{'version':_0x3878f3(0x10b),'encoding':_0x3878f3(0xca)}}),_0x3b8cf7=_0xea839f[_0x3878f3(0xf5)](_0x100ac2);await fs_internal_1['FS']['writeFile'](path_1['default'][_0x3878f3(0x10f)](process[_0x3878f3(0x10e)](),_0x3878f3(0xf3),_0x188ded,DEPLOY_DIR_NAME,_0x3878f3(0xbc),_0x3878f3(0xc4)),_0x3b8cf7);}function getComponentsTypeAndName(_0x46661a,_0xb73292){const _0x4d53cb=a86_0x57fbcd;return _0x46661a[_0x4d53cb(0xd6)]((_0x3b0fb5,_0x44481e)=>{const _0x1eb7d8=_0x4d53cb,_0x38dd3a=_0xb73292[_0x1eb7d8(0xf2)](_0x52f0ac=>_0x52f0ac['Id']===_0x44481e[_0x1eb7d8(0xbb)]);return _0x38dd3a&&_0x3b0fb5['push']({'name':_0x38dd3a['Component__r']['Component_Name__c'],'type':_0x44481e[_0x1eb7d8(0xfb)]}),_0x3b0fb5;},[]);}async function saveDestructiveChanges(_0x1b5378,_0x4a056e,_0x4fc8d2,_0xcd9cb7){const _0x4decf8=a86_0x57fbcd,_0x3f8d4c=(await(0x0,fetch_attachments_1[_0x4decf8(0xda)])(_0x1b5378,_0x4a056e))[_0x4decf8(0x106)]();await fs_internal_1['FS'][_0x4decf8(0x10d)](path_1[_0x4decf8(0xba)]['join'](process[_0x4decf8(0x10e)](),'.temp',_0xcd9cb7,DEPLOY_DIR_NAME,_0x4decf8(0xbc),_0x4fc8d2),_0x3f8d4c);}async function createDeployZip(_0x4798c8){const _0x51e99e=a86_0x57fbcd,_0x45ed31=new adm_zip_1[(_0x51e99e(0xba))]();return await _0x45ed31[_0x51e99e(0x112)](path_1['default'][_0x51e99e(0x10f)](process[_0x51e99e(0x10e)](),'.temp',_0x4798c8,DEPLOY_DIR_NAME)),_0x45ed31;}function a86_0x3463(_0x4dfa2c,_0x4e6d93){const _0x91db37=a86_0x3297();return a86_0x3463=function(_0x42ab06,_0x2dfa30){_0x42ab06=_0x42ab06-0xba;let _0x329787=_0x91db37[_0x42ab06];return _0x329787;},a86_0x3463(_0x4dfa2c,_0x4e6d93);}async function insertZip(_0x7d8e65,_0x114fd1,_0x1cba37,_0x5a48ec,_0x338507){const _0x1497f2=a86_0x57fbcd,_0x350fab={'ParentId':_0x114fd1,'Name':_0x1497f2(0xc6)+_0x1cba37,'Description':_0x1497f2(0xc6)+_0x5a48ec,'Body':_0x338507},{data:_0x3e1268}=await _0x7d8e65[_0x1497f2(0x10c)](_0x1497f2(0x115)+constants_1[_0x1497f2(0x108)]+_0x1497f2(0xd2),_0x350fab);return _0x3e1268['id'];}