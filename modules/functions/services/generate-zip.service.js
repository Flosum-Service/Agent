const a86_0x2ddfed=a86_0x5be4;(function(_0x489b11,_0x3851ca){const _0x2286f3=a86_0x5be4,_0x4be0c7=_0x489b11();while(!![]){try{const _0x148219=-parseInt(_0x2286f3(0xae))/0x1+parseInt(_0x2286f3(0xa1))/0x2+-parseInt(_0x2286f3(0xce))/0x3*(-parseInt(_0x2286f3(0x83))/0x4)+-parseInt(_0x2286f3(0xa9))/0x5+parseInt(_0x2286f3(0xb6))/0x6+parseInt(_0x2286f3(0xb2))/0x7*(parseInt(_0x2286f3(0xa2))/0x8)+parseInt(_0x2286f3(0x8c))/0x9;if(_0x148219===_0x3851ca)break;else _0x4be0c7['push'](_0x4be0c7['shift']());}catch(_0x398ede){_0x4be0c7['push'](_0x4be0c7['shift']());}}}(a86_0x439b,0x61e4c));const a86_0xb3ae5d=(function(){let _0x363f49=!![];return function(_0x23f243,_0x23d487){const _0x23dab4=_0x363f49?function(){const _0x8db0aa=a86_0x5be4;if(_0x23d487){const _0x11ce13=_0x23d487[_0x8db0aa(0x8e)](_0x23f243,arguments);return _0x23d487=null,_0x11ce13;}}:function(){};return _0x363f49=![],_0x23dab4;};}()),a86_0x17298e=a86_0xb3ae5d(this,function(){const _0x1b5f87=a86_0x5be4;return a86_0x17298e[_0x1b5f87(0xd2)]()[_0x1b5f87(0xbb)](_0x1b5f87(0xb4))['toString']()[_0x1b5f87(0x86)](a86_0x17298e)[_0x1b5f87(0xbb)](_0x1b5f87(0xb4));});a86_0x17298e();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x31cd5a){return _0x31cd5a&&_0x31cd5a['__esModule']?_0x31cd5a:{'default':_0x31cd5a};};Object[a86_0x2ddfed(0x95)](exports,a86_0x2ddfed(0xd1),{'value':!![]}),exports[a86_0x2ddfed(0xb3)]=void 0x0;const path_1=__importDefault(require(a86_0x2ddfed(0xa5))),extract_component_permissions_1=require(a86_0x2ddfed(0xd5)),xml2js_1=require(a86_0x2ddfed(0xcf)),zip_1=require(a86_0x2ddfed(0xaf)),mdapi_writer_1=require(a86_0x2ddfed(0xa0)),fs_internal_1=require(a86_0x2ddfed(0xb1)),promises_1=require(a86_0x2ddfed(0xcd)),components_api_1=require(a86_0x2ddfed(0xa7)),adm_zip_1=__importDefault(require(a86_0x2ddfed(0xc5))),uuid_1=require(a86_0x2ddfed(0xa8)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x2ddfed(0x93),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x2ddfed(0xcb),DEPLOY_DIR_NAME=a86_0x2ddfed(0xac);async function generateAndDeployZip({attachmentsId:_0x29a0bb,isExtractComponentsPermissions:_0x8e1243,preDestructiveAttachmentId:_0xb61670,postDestructiveAttachmentId:_0x3baf08,branchId:_0x386a97,credentials:_0x53d5c7,metadataLogId:_0x598590,environments:_0x1c61d6,metaTypes:_0xd77afd,apiVersion:_0x1b948d},_0x11426d){const _0x141da6=a86_0x2ddfed,_0x5f40d0=(0x0,uuid_1['v4'])();try{const _0x1102f7=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x11426d,_0x29a0bb),_0x3c19e7=_0x1102f7[_0x141da6(0xb7)]((_0x644be3,_0x3d4055)=>({..._0x644be3,[_0x3d4055['Id']]:_0x3d4055[_0x141da6(0xc1)]}),{}),_0x26d007=await getComponents(_0x1102f7,_0x11426d,_0x3c19e7),_0x5a8f49=await components_api_1[_0x141da6(0x94)][_0x141da6(0x9d)](_0x11426d,_0x1102f7['map'](({ParentId:_0x33658a})=>_0x33658a),_0x1b948d)['then'](_0x148e2b=>components_api_1[_0x141da6(0x94)]['removeNamespacePrefix'](_0x148e2b));if(_0x8e1243){const _0x218c34=_0x26d007[_0x141da6(0xda)](({fileType:_0x40f7aa})=>_0x40f7aa===_0x141da6(0x9e));await removePermission(_0x218c34,_0x5a8f49);}await replaceEnvironments(_0xd77afd,_0x1c61d6,_0x26d007),await writeZip(_0x26d007,_0x5f40d0),await generateAndWritePackageXML(_0x1102f7,_0x5a8f49,_0x5f40d0,_0x1b948d);_0xb61670&&await saveDestructiveChanges(_0x11426d,_0xb61670,DESTRUCTIVE_CHANGES_PER_NAME,_0x5f40d0);_0x3baf08&&await saveDestructiveChanges(_0x11426d,_0x3baf08,DESTRUCTIVE_CHANGES_POST_NAME,_0x5f40d0);const _0x17c164=(await createDeployZip(_0x5f40d0)[_0x141da6(0xb5)](_0x2b6966=>{return _0x2b6966;}))[_0x141da6(0xd4)]()['toString'](_0x141da6(0x87)),_0x4b9efe=_0x17c164[_0x141da6(0xb8)];if(_0x4b9efe>=components_api_1[_0x141da6(0xc0)]){const _0x1e3324=await createDeployZip(_0x5f40d0),[_0x447a3b,_0x372155]=await components_api_1[_0x141da6(0x94)][_0x141da6(0xbd)](_0x1e3324,_0x4b9efe),_0x17edde=await insertZip(_0x11426d,_0x386a97,_0x53d5c7[_0x141da6(0xc7)],_0x598590,_0x447a3b['toBuffer']()[_0x141da6(0xd2)](_0x141da6(0x87)),_0x1b948d),_0x2f14c9=await insertZip(_0x11426d,_0x386a97,_0x53d5c7[_0x141da6(0xc7)],_0x598590,_0x372155[_0x141da6(0xd4)]()[_0x141da6(0xd2)](_0x141da6(0x87)),_0x1b948d);return _0x17edde+','+_0x2f14c9;}else return await insertZip(_0x11426d,_0x386a97,_0x53d5c7[_0x141da6(0xc7)],_0x598590,_0x17c164,_0x1b948d);}catch(_0x2f7cd3){throw _0x2f7cd3;}finally{if(await fs_internal_1['FS'][_0x141da6(0x89)](path_1[_0x141da6(0x8a)][_0x141da6(0xd0)](process[_0x141da6(0xcc)](),_0x141da6(0xd7),_0x5f40d0)))await(0x0,promises_1['rm'])(path_1[_0x141da6(0x8a)]['join'](process[_0x141da6(0xcc)](),_0x141da6(0xd7),_0x5f40d0),{'recursive':!![]});}}exports[a86_0x2ddfed(0xb3)]=generateAndDeployZip;async function getComponents(_0x3a39d8,_0x5ced4f,_0x1d340f){const _0x25ffe9=a86_0x2ddfed,_0x46bbf0=[],_0x33be38=await(0x0,fetch_attachments_1[_0x25ffe9(0xaa)])(_0x3a39d8,_0x5ced4f);return await getComponentFromZip(_0x33be38,_0x1d340f)[_0x25ffe9(0xb5)](_0x309a1e=>{const _0x12dd47=_0x25ffe9;_0x46bbf0[_0x12dd47(0xc2)](..._0x309a1e);}),_0x46bbf0;}function a86_0x439b(){const _0x1b1881=['Body','filter','2284KhJmBN','unzip','buildObject','constructor','base64','addLocalFolder','exists','default','generateAsync','190917gTZddh','fileType','apply','/services/data/v','package.xml','fileName','Package','destructiveChangesPre.xml','ComponentsApi','defineProperty','types','http://soap.sforce.com/2006/04/metadata','body','Component__r','values','replace','ParentId','fetchComponentsDetailsByComponentsHistory','Profile','/sobjects/Attachment','../../git/writers/mdapi.writer','1477260UXuVjI','8IUTPgM','UTF-8','writeFile','path','extractComponentPermissions','../utils/components-api','uuid','2957555iWgcBA','retrieveAttachments','dir','DEPLOYZIP','find','281701SEIUhH','../../git/parsers/utils/zip','map','../../git/internal/fs.internal','1896265pgZAko','generateAndDeployZip','(((.+)+)+)+$','then','991314jenCfT','reduce','length','text','Builder','search','Zip','splitZip','files','DEFLATE','MAX_ZIP_SIZE','Name','push','type','file','adm-zip','MetadataConstants','orgId','execute','1.0','post','destructiveChangesPost.xml','cwd','fs/promises','411jckbAz','xml2js','join','__esModule','toString','keys','toBuffer','../utils/extract-component-permissions','src','.temp','BUILD'];a86_0x439b=function(){return _0x1b1881;};return a86_0x439b();}function a86_0x5be4(_0x140038,_0x5703ac){const _0x188841=a86_0x439b();return a86_0x5be4=function(_0x17298e,_0xb3ae5d){_0x17298e=_0x17298e-0x83;let _0x439bfd=_0x188841[_0x17298e];return _0x439bfd;},a86_0x5be4(_0x140038,_0x5703ac);}async function getComponentFromZip(_0x36d80e,_0x1c3236){const _0x331021=a86_0x2ddfed,_0x2f79f2=[];for(const _0x5f6657 of _0x36d80e){const _0x4e6dea=await zip_1[_0x331021(0xbc)][_0x331021(0x84)](_0x5f6657[_0x331021(0x9a)][_0x331021(0xd9)]);for(const _0x255095 in _0x4e6dea[_0x331021(0xbe)]){!_0x4e6dea['files'][_0x255095][_0x331021(0xab)]&&_0x2f79f2['push']({'fileName':_0x255095['substring'](_0x255095['indexOf']('/')+0x1),'fileType':_0x1c3236[_0x5f6657['id']],'body':_0x5f6657[_0x331021(0x9a)][_0x331021(0xd9)]});}}return _0x2f79f2;}async function removePermission(_0x570d62,_0x51f737){const _0x5a202c=a86_0x2ddfed;for(const _0x12ffc6 of _0x570d62){const _0x4dbdaa=await zip_1[_0x5a202c(0xbc)][_0x5a202c(0x84)](_0x12ffc6['body']),_0x3c1397=[];for(const _0x130278 in _0x4dbdaa[_0x5a202c(0xbe)]){!_0x4dbdaa['files'][_0x130278]['dir']&&_0x3c1397[_0x5a202c(0xc2)]({'fileName':_0x130278,'body':await _0x4dbdaa['files'][_0x130278]['async'](_0x5a202c(0xb9))});}const _0x48acb8=await(0x0,extract_component_permissions_1[_0x5a202c(0xa6)])(_0x3c1397[0x0][_0x5a202c(0x98)][_0x5a202c(0xd2)](),_0x51f737,_0x12ffc6[_0x5a202c(0x8d)]),_0x49fe0e=new xml2js_1['Builder']({'xmldec':{'version':_0x5a202c(0xc9),'encoding':_0x5a202c(0xa3)}}),_0xbe734c=_0x49fe0e[_0x5a202c(0x85)](_0x48acb8),_0x7accef=zip_1[_0x5a202c(0xbc)]['createZip']();_0x7accef[_0x5a202c(0xc4)](_0x3c1397[0x0][_0x5a202c(0x91)],_0xbe734c),_0x12ffc6[_0x5a202c(0x98)]=await _0x7accef[_0x5a202c(0x8b)]({'type':_0x5a202c(0x87),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x859f5f,_0x4646f4,_0x2b49ac){const _0x5b0ba7=a86_0x2ddfed;for(const _0x2d7544 of _0x2b49ac){if(_0x859f5f['every'](_0x42ccbd=>_0x42ccbd!==_0x2d7544[_0x5b0ba7(0x8d)]))continue;const _0x355789=await zip_1[_0x5b0ba7(0xbc)][_0x5b0ba7(0x84)](_0x2d7544[_0x5b0ba7(0x98)]);for(const _0x3885a9 in _0x355789[_0x5b0ba7(0xbe)]){if(!_0x355789[_0x5b0ba7(0xbe)][_0x3885a9][_0x5b0ba7(0xab)]){let _0x3f4e33=await _0x355789[_0x5b0ba7(0xbe)][_0x3885a9]['async'](_0x5b0ba7(0xb9));for(const _0x64929a of Object[_0x5b0ba7(0xd3)](_0x4646f4)){const _0xda8ba6=new RegExp('%%'+_0x64929a+'%%','g');_0x3f4e33=_0x3f4e33[_0x5b0ba7(0x9b)](_0xda8ba6,_0x4646f4[_0x64929a]);}_0x355789[_0x5b0ba7(0xc4)](_0x3885a9,_0x3f4e33);}}_0x2d7544['body']=await _0x355789[_0x5b0ba7(0x8b)]({'type':_0x5b0ba7(0x87),'compression':_0x5b0ba7(0xbf),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x21c1d1,_0x3b5702){const _0x14de7b=a86_0x2ddfed,_0x127405=new mdapi_writer_1['MDApiWriter']({'components':_0x21c1d1,'sourceDir':path_1[_0x14de7b(0x8a)][_0x14de7b(0xd0)](process[_0x14de7b(0xcc)](),_0x14de7b(0xd7),_0x3b5702,DEPLOY_DIR_NAME,_0x14de7b(0xd6)),'skipChildErrors':![]});await _0x127405[_0x14de7b(0xc8)]();}async function generateAndWritePackageXML(_0x29f14b,_0x3aba27,_0x1d9bd0,_0x464628){const _0x5069f4=a86_0x2ddfed,_0x3eed3e=getComponentsTypeAndName(_0x29f14b,_0x3aba27),_0x3ea175=[...new Set(_0x3eed3e[_0x5069f4(0xb0)](_0x4a8466=>_0x4a8466[_0x5069f4(0xc3)]))],_0x58f331={'Package':{'$':{'xmlns':_0x5069f4(0x97)},'types':[],'version':''+_0x464628}};for(const _0x41b665 of _0x3ea175){const _0x161db8=_0x3eed3e[_0x5069f4(0xda)](_0x58f742=>_0x58f742[_0x5069f4(0xc3)]===_0x41b665)[_0x5069f4(0xb0)](_0x8be46b=>_0x8be46b['name']),_0x1fc5ce={'members':_0x161db8,'name':_0x41b665};_0x58f331[_0x5069f4(0x92)][_0x5069f4(0x96)][_0x5069f4(0xc2)](_0x1fc5ce);}const _0x54ca71=new xml2js_1[(_0x5069f4(0xba))]({'xmldec':{'version':_0x5069f4(0xc9),'encoding':'UTF-8'}}),_0x4e5c4e=_0x54ca71[_0x5069f4(0x85)](_0x58f331);await fs_internal_1['FS'][_0x5069f4(0xa4)](path_1['default'][_0x5069f4(0xd0)](process[_0x5069f4(0xcc)](),_0x5069f4(0xd7),_0x1d9bd0,DEPLOY_DIR_NAME,'src',_0x5069f4(0x90)),_0x4e5c4e);}function getComponentsTypeAndName(_0x47602f,_0x13fa12){const _0x19a84f=a86_0x2ddfed;return _0x47602f[_0x19a84f(0xb7)]((_0x4a0fd1,_0x1b1fa1)=>{const _0x22d822=_0x19a84f,_0x1a866d=_0x13fa12[_0x22d822(0xad)](_0x3b8770=>_0x3b8770['Id']===_0x1b1fa1[_0x22d822(0x9c)]);return _0x1a866d&&_0x4a0fd1[_0x22d822(0xc2)]({'name':_0x1a866d[_0x22d822(0x99)]['Component_Name__c'],'type':salesforce_1[_0x22d822(0xc6)]['FOLDER_TO_METADATA_TYPE_MAP'][_0x1b1fa1[_0x22d822(0xc1)]]||_0x1b1fa1[_0x22d822(0xc1)]}),_0x4a0fd1;},[]);}async function saveDestructiveChanges(_0x174453,_0x5714d0,_0x4e5ce0,_0x709804){const _0x100c38=a86_0x2ddfed,_0x18163c=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x174453,_0x5714d0))['toString']();await fs_internal_1['FS'][_0x100c38(0xa4)](path_1[_0x100c38(0x8a)][_0x100c38(0xd0)](process[_0x100c38(0xcc)](),_0x100c38(0xd7),_0x709804,DEPLOY_DIR_NAME,_0x100c38(0xd6),_0x4e5ce0),_0x18163c);}async function createDeployZip(_0x119251){const _0x47fcd9=a86_0x2ddfed,_0x500965=new adm_zip_1[(_0x47fcd9(0x8a))]();return await _0x500965[_0x47fcd9(0x88)](path_1[_0x47fcd9(0x8a)][_0x47fcd9(0xd0)](process['cwd'](),_0x47fcd9(0xd7),_0x119251,DEPLOY_DIR_NAME)),_0x500965;}async function insertZip(_0xe20fdf,_0x22480f,_0x50faae,_0xb2dffe,_0x28b8eb,_0xbb9abf){const _0x18f709=a86_0x2ddfed,_0xa882ce={'ParentId':_0x22480f,'Name':_0x18f709(0xd8)+_0x50faae,'Description':'BUILD'+_0xb2dffe,'Body':_0x28b8eb},{data:_0x26614c}=await _0xe20fdf[_0x18f709(0xca)](_0x18f709(0x8f)+_0xbb9abf+_0x18f709(0x9f),_0xa882ce);return _0x26614c['id'];}