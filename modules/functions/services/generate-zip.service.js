const a54_0x47ad9d=a54_0x3558;function a54_0x43e3(){const _0x3efe26=['xml2js','fetchComponentsDetailsByComponentsHistory','Body','MDApiWriter','path','addLocalFolder','DEFLATE','../utils/extract-component-permissions','cwd','base64','6nUZAzs','writeFile','length','package.xml','name','dir','(((.+)+)+)+$','.temp','fetchAttachmentBody','Component__r','generateAndDeployZip','../../../constants','Zip','BUILD','toBuffer','map','../../git/parsers/utils/zip','DEPLOYZIP','destructiveChangesPost.xml','PermissionSet','post','1172125lfihlj','3927654jrPhWW','every','orgId','filter','then','fileType','reduce','../../git/parsers/mdapi','toString','fetchAttachmentsDetails','src','__esModule','../../git/internal/fs.internal','3138807TxryWk','Profile','file','adm-zip','510944zNqDve','async','179407bCmivc','start','97778QSBudk','values','text','buildObject','../utils/components-api','join','search','Name','removeNamespacePrefix','SALESFORCE_API_VERSION','constructor','Package','Component_Name__c','MAX_ZIP_SIZE','http://soap.sforce.com/2006/04/metadata','exists','type','1716648lmsRNV','ComponentsApi','files','substring','Builder','generateAsync','default','3BRrclZ','ParentId','log','1.0','body','push','fileName','/services/data/','UTF-8','apply','unzip','indexOf','__importDefault','defineProperty','find','retrieveAttachments'];a54_0x43e3=function(){return _0x3efe26;};return a54_0x43e3();}(function(_0x5c8b01,_0x46b719){const _0x36a70c=a54_0x3558,_0xd813f9=_0x5c8b01();while(!![]){try{const _0x112d50=parseInt(_0x36a70c(0xc2))/0x1+parseInt(_0x36a70c(0xc4))/0x2*(-parseInt(_0x36a70c(0xdc))/0x3)+parseInt(_0x36a70c(0xc0))/0x4+-parseInt(_0x36a70c(0xae))/0x5*(parseInt(_0x36a70c(0xf6))/0x6)+parseInt(_0x36a70c(0xbc))/0x7+parseInt(_0x36a70c(0xd5))/0x8+-parseInt(_0x36a70c(0xaf))/0x9;if(_0x112d50===_0x46b719)break;else _0xd813f9['push'](_0xd813f9['shift']());}catch(_0x1fc084){_0xd813f9['push'](_0xd813f9['shift']());}}}(a54_0x43e3,0x3d225));const a54_0x1a7b45=(function(){let _0x365457=!![];return function(_0x208af4,_0x48cd8d){const _0x2dd999=_0x365457?function(){const _0x303ba1=a54_0x3558;if(_0x48cd8d){const _0x5b126e=_0x48cd8d[_0x303ba1(0xe5)](_0x208af4,arguments);return _0x48cd8d=null,_0x5b126e;}}:function(){};return _0x365457=![],_0x2dd999;};}()),a54_0x1eedfb=a54_0x1a7b45(this,function(){const _0x213db7=a54_0x3558;return a54_0x1eedfb[_0x213db7(0xb7)]()['search'](_0x213db7(0xfc))[_0x213db7(0xb7)]()[_0x213db7(0xce)](a54_0x1eedfb)[_0x213db7(0xca)](_0x213db7(0xfc));});a54_0x1eedfb();'use strict';var __importDefault=this&&this[a54_0x47ad9d(0xe8)]||function(_0x28f91b){const _0x2eafbb=a54_0x47ad9d;return _0x28f91b&&_0x28f91b[_0x2eafbb(0xba)]?_0x28f91b:{'default':_0x28f91b};};Object[a54_0x47ad9d(0xe9)](exports,'__esModule',{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require(a54_0x47ad9d(0xa4)),path_1=__importDefault(require(a54_0x47ad9d(0xf0))),extract_component_permissions_1=require(a54_0x47ad9d(0xf3)),xml2js_1=require(a54_0x47ad9d(0xec)),zip_1=require(a54_0x47ad9d(0xa9)),mdapi_1=require(a54_0x47ad9d(0xb6)),fs_internal_1=require(a54_0x47ad9d(0xbb)),promises_1=require('fs/promises'),components_api_1=require(a54_0x47ad9d(0xc8)),adm_zip_1=__importDefault(require(a54_0x47ad9d(0xbf))),uuid_1=require('uuid'),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a54_0x47ad9d(0xab),DEPLOY_DIR_NAME=a54_0x47ad9d(0xaa);async function generateAndDeployZip({attachmentsId:_0x3aeb1a,isExtractComponentsPermissions:_0x462ec7,preDestructiveAttachmentId:_0x5b0ad8,postDestructiveAttachmentId:_0x1dfffe,branchId:_0x167b2a,credentials:_0x5569d1,metadataLogId:_0x55243a,environments:_0x497439,metaTypes:_0x18f7d3},_0x4ddcac){const _0x5b3d9a=a54_0x47ad9d,_0xe5f4d4=(0x0,uuid_1['v4'])();try{const _0xbef76d=await components_api_1[_0x5b3d9a(0xd6)][_0x5b3d9a(0xb8)](_0x4ddcac,_0x3aeb1a),_0x4d5299=_0xbef76d[_0x5b3d9a(0xb5)]((_0x3ecc74,_0x32c05d)=>({..._0x3ecc74,[_0x32c05d['Id']]:_0x32c05d[_0x5b3d9a(0xcb)]}),{}),_0x10d617=await getComponents(_0xbef76d,_0x4ddcac,_0x4d5299),_0x5d7f8d=await components_api_1['ComponentsApi'][_0x5b3d9a(0xed)](_0x4ddcac,_0xbef76d[_0x5b3d9a(0xa8)](({ParentId:_0x48f164})=>_0x48f164))[_0x5b3d9a(0xb3)](_0x30f4ea=>components_api_1['ComponentsApi'][_0x5b3d9a(0xcc)](_0x30f4ea));if(_0x462ec7){const _0x48ae82=_0x10d617[_0x5b3d9a(0xb2)](({fileType:_0x170855})=>_0x170855===_0x5b3d9a(0xbd)||_0x170855===_0x5b3d9a(0xac));await removePermission(_0x48ae82,_0x5d7f8d);}await replaceEnvironments(_0x18f7d3,_0x497439,_0x10d617),await writeZip(_0x10d617,_0xe5f4d4),await generateAndWritePackageXML(_0xbef76d,_0x5d7f8d,_0xe5f4d4);_0x5b0ad8&&await saveDestructiveChanges(_0x4ddcac,_0x5b0ad8,DESTRUCTIVE_CHANGES_PER_NAME,_0xe5f4d4);_0x1dfffe&&await saveDestructiveChanges(_0x4ddcac,_0x1dfffe,DESTRUCTIVE_CHANGES_POST_NAME,_0xe5f4d4);const _0x5cde5f=(await createDeployZip(_0xe5f4d4)[_0x5b3d9a(0xb3)](_0x2ec4e1=>{return _0x2ec4e1;}))[_0x5b3d9a(0xa7)]()[_0x5b3d9a(0xb7)](_0x5b3d9a(0xf5));console[_0x5b3d9a(0xde)]('after\x20create\x20zip');const _0x5cdc35=_0x5cde5f[_0x5b3d9a(0xf8)];if(_0x5cdc35>=components_api_1[_0x5b3d9a(0xd1)]){const _0x3224b6=await createDeployZip(_0xe5f4d4);console[_0x5b3d9a(0xde)]('after\x20create\x20second\x20zip');const [_0x5a8e68,_0x5d4a5d]=await components_api_1[_0x5b3d9a(0xd6)]['splitZip'](_0x3224b6,_0x5cdc35),_0x1f8875=await insertZip(_0x4ddcac,_0x167b2a,_0x5569d1[_0x5b3d9a(0xb1)],_0x55243a,_0x5a8e68[_0x5b3d9a(0xa7)]()[_0x5b3d9a(0xb7)]('base64')),_0x29e2ac=await insertZip(_0x4ddcac,_0x167b2a,_0x5569d1[_0x5b3d9a(0xb1)],_0x55243a,_0x5d4a5d[_0x5b3d9a(0xa7)]()[_0x5b3d9a(0xb7)]('base64'));return _0x1f8875+','+_0x29e2ac;}else return await insertZip(_0x4ddcac,_0x167b2a,_0x5569d1['orgId'],_0x55243a,_0x5cde5f);}catch(_0x513c04){throw _0x513c04;}finally{if(await fs_internal_1['FS'][_0x5b3d9a(0xd3)](path_1[_0x5b3d9a(0xdb)]['join'](process[_0x5b3d9a(0xf4)](),_0x5b3d9a(0xfd),_0xe5f4d4)))await(0x0,promises_1['rm'])(path_1['default']['join'](process[_0x5b3d9a(0xf4)](),_0x5b3d9a(0xfd),_0xe5f4d4),{'recursive':!![]});}}exports[a54_0x47ad9d(0x100)]=generateAndDeployZip;async function getComponents(_0x489d94,_0x3ccb61,_0x417c7e){const _0x14e290=a54_0x47ad9d,_0x22b7ff=[],_0x34d737=await components_api_1[_0x14e290(0xd6)][_0x14e290(0xeb)](_0x489d94,_0x3ccb61);return await getComponentFromZip(_0x34d737,_0x417c7e)[_0x14e290(0xb3)](_0x513372=>{const _0x4733e4=_0x14e290;_0x22b7ff[_0x4733e4(0xe1)](..._0x513372);}),_0x22b7ff;}async function getComponentFromZip(_0x36ff04,_0x13717e){const _0x18a092=a54_0x47ad9d,_0x23af10=[];for(const _0x3aa98a of _0x36ff04){const _0x454ad0=await zip_1[_0x18a092(0xa5)][_0x18a092(0xe6)](_0x3aa98a[_0x18a092(0xc5)][_0x18a092(0xee)]);for(const _0x4652ac in _0x454ad0[_0x18a092(0xd7)]){!_0x454ad0[_0x18a092(0xd7)][_0x4652ac][_0x18a092(0xfb)]&&_0x23af10[_0x18a092(0xe1)]({'fileName':_0x4652ac[_0x18a092(0xd8)](_0x4652ac[_0x18a092(0xe7)]('/')+0x1),'fileType':_0x13717e[_0x3aa98a['id']],'body':_0x3aa98a[_0x18a092(0xc5)][_0x18a092(0xee)]});}}return _0x23af10;}async function removePermission(_0x33be91,_0x47d4d2){const _0x1694c9=a54_0x47ad9d;for(const _0x4f0339 of _0x33be91){const _0x1e85f5=await zip_1['Zip'][_0x1694c9(0xe6)](_0x4f0339[_0x1694c9(0xe0)]),_0x4982ec=[];for(const _0x34d7c7 in _0x1e85f5[_0x1694c9(0xd7)]){!_0x1e85f5[_0x1694c9(0xd7)][_0x34d7c7][_0x1694c9(0xfb)]&&_0x4982ec[_0x1694c9(0xe1)]({'fileName':_0x34d7c7,'body':await _0x1e85f5[_0x1694c9(0xd7)][_0x34d7c7][_0x1694c9(0xc1)](_0x1694c9(0xc6))});}const _0x244fe9=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x4982ec[0x0][_0x1694c9(0xe0)]['toString'](),_0x47d4d2,_0x4f0339['fileType']),_0x1bc65d=new xml2js_1[(_0x1694c9(0xd9))]({'xmldec':{'version':_0x1694c9(0xdf),'encoding':_0x1694c9(0xe4)}}),_0x269475=_0x1bc65d[_0x1694c9(0xc7)](_0x244fe9),_0x5a897a=zip_1[_0x1694c9(0xa5)]['createZip']();_0x5a897a[_0x1694c9(0xbe)](_0x4982ec[0x0][_0x1694c9(0xe2)],_0x269475),_0x4f0339[_0x1694c9(0xe0)]=await _0x5a897a[_0x1694c9(0xda)]({'type':_0x1694c9(0xf5),'compression':_0x1694c9(0xf2),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x77109b,_0x3d1c4e,_0x1ee672){const _0x264230=a54_0x47ad9d;for(const _0x40e4e7 of _0x1ee672){if(_0x77109b[_0x264230(0xb0)](_0x2328cf=>_0x2328cf!==_0x40e4e7[_0x264230(0xb4)]))continue;const _0x129511=await zip_1[_0x264230(0xa5)][_0x264230(0xe6)](_0x40e4e7[_0x264230(0xe0)]);for(const _0x22ab7a in _0x129511[_0x264230(0xd7)]){if(!_0x129511['files'][_0x22ab7a]['dir']){let _0xbdaa5a=await _0x129511[_0x264230(0xd7)][_0x22ab7a]['async'](_0x264230(0xc6));for(const _0x1dac75 of Object['keys'](_0x3d1c4e)){const _0x3a8c8d=new RegExp('%%'+_0x1dac75+'%%','g');_0xbdaa5a=_0xbdaa5a['replace'](_0x3a8c8d,_0x3d1c4e[_0x1dac75]);}_0x129511[_0x264230(0xbe)](_0x22ab7a,_0xbdaa5a);}}_0x40e4e7[_0x264230(0xe0)]=await _0x129511[_0x264230(0xda)]({'type':_0x264230(0xf5),'compression':_0x264230(0xf2),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x50b509,_0x416637){const _0x34323c=a54_0x47ad9d,_0x12533a=new mdapi_1[(_0x34323c(0xef))]({'components':_0x50b509,'sourceDir':path_1[_0x34323c(0xdb)]['join'](process[_0x34323c(0xf4)](),_0x34323c(0xfd),_0x416637,DEPLOY_DIR_NAME,_0x34323c(0xb9)),'skipChildErrors':![]});await _0x12533a[_0x34323c(0xc3)]();}async function generateAndWritePackageXML(_0x5a16d1,_0x2981d4,_0x54f054){const _0x1fe5c6=a54_0x47ad9d,_0x3ee4ab=getComponentsTypeAndName(_0x5a16d1,_0x2981d4),_0x1e63ca=[...new Set(_0x3ee4ab[_0x1fe5c6(0xa8)](_0x2484a5=>_0x2484a5[_0x1fe5c6(0xd4)]))],_0x32b9a5={'Package':{'$':{'xmlns':_0x1fe5c6(0xd2)},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION'][_0x1fe5c6(0xd8)](0x1)}};for(const _0x28a6ab of _0x1e63ca){const _0x4b59bf=_0x3ee4ab[_0x1fe5c6(0xb2)](_0x4ba806=>_0x4ba806[_0x1fe5c6(0xd4)]===_0x28a6ab)[_0x1fe5c6(0xa8)](_0x22edf9=>_0x22edf9[_0x1fe5c6(0xfa)]),_0x121f6a={'members':_0x4b59bf,'name':_0x28a6ab};_0x32b9a5[_0x1fe5c6(0xcf)]['types'][_0x1fe5c6(0xe1)](_0x121f6a);}const _0x3e0d83=new xml2js_1[(_0x1fe5c6(0xd9))]({'xmldec':{'version':_0x1fe5c6(0xdf),'encoding':'UTF-8'}}),_0x125cb4=_0x3e0d83[_0x1fe5c6(0xc7)](_0x32b9a5);await fs_internal_1['FS'][_0x1fe5c6(0xf7)](path_1[_0x1fe5c6(0xdb)][_0x1fe5c6(0xc9)](process['cwd'](),_0x1fe5c6(0xfd),_0x54f054,DEPLOY_DIR_NAME,_0x1fe5c6(0xb9),_0x1fe5c6(0xf9)),_0x125cb4);}function getComponentsTypeAndName(_0x1318c3,_0x4086bf){const _0x10bc48=a54_0x47ad9d;return _0x1318c3[_0x10bc48(0xb5)]((_0x46ced2,_0x1b2534)=>{const _0xa06a60=_0x10bc48,_0x4930e9=_0x4086bf[_0xa06a60(0xea)](_0x989729=>_0x989729['Id']===_0x1b2534[_0xa06a60(0xdd)]);return _0x4930e9&&_0x46ced2['push']({'name':_0x4930e9[_0xa06a60(0xff)][_0xa06a60(0xd0)],'type':_0x1b2534[_0xa06a60(0xcb)]}),_0x46ced2;},[]);}function a54_0x3558(_0x5a5a8a,_0x3dadcb){const _0x474756=a54_0x43e3();return a54_0x3558=function(_0x1eedfb,_0x1a7b45){_0x1eedfb=_0x1eedfb-0xa4;let _0x43e3eb=_0x474756[_0x1eedfb];return _0x43e3eb;},a54_0x3558(_0x5a5a8a,_0x3dadcb);}async function saveDestructiveChanges(_0x24ca6a,_0x189d9f,_0x1a9d17,_0xc9b693){const _0x18aeff=a54_0x47ad9d,_0x43dbe6=(await components_api_1[_0x18aeff(0xd6)][_0x18aeff(0xfe)](_0x24ca6a,_0x189d9f))['toString']();await fs_internal_1['FS'][_0x18aeff(0xf7)](path_1[_0x18aeff(0xdb)][_0x18aeff(0xc9)](process['cwd'](),_0x18aeff(0xfd),_0xc9b693,DEPLOY_DIR_NAME,_0x18aeff(0xb9),_0x1a9d17),_0x43dbe6);}async function createDeployZip(_0x317389){const _0x44a90d=a54_0x47ad9d,_0x1c5b00=new adm_zip_1[(_0x44a90d(0xdb))]();return await _0x1c5b00[_0x44a90d(0xf1)](path_1[_0x44a90d(0xdb)][_0x44a90d(0xc9)](process['cwd'](),_0x44a90d(0xfd),_0x317389,DEPLOY_DIR_NAME)),_0x1c5b00;}async function insertZip(_0x492725,_0x3bb1a0,_0x5f2f4d,_0x2fbcec,_0x5a1a48){const _0x248023=a54_0x47ad9d,_0x3721ce={'ParentId':_0x3bb1a0,'Name':_0x248023(0xa6)+_0x5f2f4d,'Description':_0x248023(0xa6)+_0x2fbcec,'Body':_0x5a1a48},{data:_0x472754}=await _0x492725[_0x248023(0xad)](_0x248023(0xe3)+constants_1[_0x248023(0xcd)]+'/sobjects/Attachment',_0x3721ce);return _0x472754['id'];}