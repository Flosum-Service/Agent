const a86_0x1d5c9e=a86_0x466d;(function(_0x422fbe,_0x34af16){const _0x27bd74=a86_0x466d,_0x168cdf=_0x422fbe();while(!![]){try{const _0x12e133=-parseInt(_0x27bd74(0x205))/0x1*(-parseInt(_0x27bd74(0x1e2))/0x2)+-parseInt(_0x27bd74(0x212))/0x3+parseInt(_0x27bd74(0x220))/0x4*(-parseInt(_0x27bd74(0x1cc))/0x5)+parseInt(_0x27bd74(0x1df))/0x6+-parseInt(_0x27bd74(0x224))/0x7+parseInt(_0x27bd74(0x200))/0x8*(parseInt(_0x27bd74(0x1e5))/0x9)+-parseInt(_0x27bd74(0x1f5))/0xa*(parseInt(_0x27bd74(0x219))/0xb);if(_0x12e133===_0x34af16)break;else _0x168cdf['push'](_0x168cdf['shift']());}catch(_0x376b98){_0x168cdf['push'](_0x168cdf['shift']());}}}(a86_0x1e67,0x7d3ec));const a86_0x197b0c=(function(){let _0x194f20=!![];return function(_0xcede2b,_0x10f77d){const _0x3770e0=_0x194f20?function(){const _0x2735d4=a86_0x466d;if(_0x10f77d){const _0xa99203=_0x10f77d[_0x2735d4(0x1f4)](_0xcede2b,arguments);return _0x10f77d=null,_0xa99203;}}:function(){};return _0x194f20=![],_0x3770e0;};}()),a86_0x162722=a86_0x197b0c(this,function(){const _0x3e9956=a86_0x466d;return a86_0x162722[_0x3e9956(0x1ce)]()[_0x3e9956(0x1fc)]('(((.+)+)+)+$')[_0x3e9956(0x1ce)]()['constructor'](a86_0x162722)[_0x3e9956(0x1fc)]('(((.+)+)+)+$');});a86_0x162722();'use strict';var __importDefault=this&&this[a86_0x1d5c9e(0x208)]||function(_0x14614f){return _0x14614f&&_0x14614f['__esModule']?_0x14614f:{'default':_0x14614f};};Object[a86_0x1d5c9e(0x1cb)](exports,a86_0x1d5c9e(0x1e7),{'value':!![]}),exports[a86_0x1d5c9e(0x204)]=void 0x0;function a86_0x466d(_0xfbfa,_0x447e4a){const _0x13485d=a86_0x1e67();return a86_0x466d=function(_0x162722,_0x197b0c){_0x162722=_0x162722-0x1ca;let _0x1e67a4=_0x13485d[_0x162722];return _0x1e67a4;},a86_0x466d(_0xfbfa,_0x447e4a);}const constants_1=require(a86_0x1d5c9e(0x211)),path_1=__importDefault(require(a86_0x1d5c9e(0x1de))),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a86_0x1d5c9e(0x20a)),zip_1=require(a86_0x1d5c9e(0x1d5)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a86_0x1d5c9e(0x217)),promises_1=require(a86_0x1d5c9e(0x1eb)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a86_0x1d5c9e(0x1e3))),uuid_1=require(a86_0x1d5c9e(0x210)),fetch_attachments_1=require(a86_0x1d5c9e(0x1f2)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a86_0x1d5c9e(0x20b),DEPLOY_DIR_NAME=a86_0x1d5c9e(0x1f1);function a86_0x1e67(){const _0x176876=['cwd','DEFLATE','extractComponentPermissions','src','../../git/internal/fs.internal','default','1914mFzKKv','splitZip','Builder','substring','after\x20create\x20zip','fileName','map','4hVzWbc','then','retrieveAttachments','type','1386532keGtpN','buildObject','BUILD','defineProperty','3388595UTAVVw','Body','toString','keys','file','fetchAttachmentsDetailsById','addLocalFolder','types','removeNamespacePrefix','../../git/parsers/utils/zip','UTF-8','unzip','log','Profile','Zip','toBuffer','text','Component_Name__c','path','4858752QwDEpI','/sobjects/Attachment','writeFile','6zylIZF','adm-zip','async','4187547oXlbwT','fetchComponentsDetailsByComponentsHistory','__esModule','fileType','name','SALESFORCE_API_VERSION','fs/promises','values','orgId','length','body','.temp','DEPLOYZIP','../../shared/utils/fetch-attachments','dir','apply','21370RTQivW','filter','/services/data/','base64','every','Name','after\x20create\x20second\x20zip','search','1.0','MAX_ZIP_SIZE','indexOf','8gJLOJf','MDApiWriter','package.xml','start','generateAndDeployZip','240863DleJGE','createZip','ComponentsApi','__importDefault','PermissionSet','xml2js','destructiveChangesPost.xml','join','files','find','http://soap.sforce.com/2006/04/metadata','uuid','../../../constants','711081RclWsg'];a86_0x1e67=function(){return _0x176876;};return a86_0x1e67();}async function generateAndDeployZip({attachmentsId:_0x4e9d19,isExtractComponentsPermissions:_0xaff7b7,preDestructiveAttachmentId:_0x410f59,postDestructiveAttachmentId:_0x316240,branchId:_0x7d6c55,credentials:_0x3af05f,metadataLogId:_0xa7d20b,environments:_0x537c1a,metaTypes:_0x2c871c},_0x2c1df4){const _0x2ed739=a86_0x1d5c9e,_0x2b2b79=(0x0,uuid_1['v4'])();try{const _0x26d85f=await(0x0,fetch_attachments_1[_0x2ed739(0x1d1)])(_0x2c1df4,_0x4e9d19),_0x86852a=_0x26d85f['reduce']((_0x264374,_0x1658b1)=>({..._0x264374,[_0x1658b1['Id']]:_0x1658b1[_0x2ed739(0x1fa)]}),{}),_0x283420=await getComponents(_0x26d85f,_0x2c1df4,_0x86852a),_0xc97afe=await components_api_1['ComponentsApi'][_0x2ed739(0x1e6)](_0x2c1df4,_0x26d85f[_0x2ed739(0x21f)](({ParentId:_0x211f71})=>_0x211f71))[_0x2ed739(0x221)](_0x4bcaaa=>components_api_1[_0x2ed739(0x207)][_0x2ed739(0x1d4)](_0x4bcaaa));if(_0xaff7b7){const _0x4b3a72=_0x283420[_0x2ed739(0x1f6)](({fileType:_0x5f4212})=>_0x5f4212===_0x2ed739(0x1d9)||_0x5f4212===_0x2ed739(0x209));await removePermission(_0x4b3a72,_0xc97afe);}await replaceEnvironments(_0x2c871c,_0x537c1a,_0x283420),await writeZip(_0x283420,_0x2b2b79),await generateAndWritePackageXML(_0x26d85f,_0xc97afe,_0x2b2b79);_0x410f59&&await saveDestructiveChanges(_0x2c1df4,_0x410f59,DESTRUCTIVE_CHANGES_PER_NAME,_0x2b2b79);_0x316240&&await saveDestructiveChanges(_0x2c1df4,_0x316240,DESTRUCTIVE_CHANGES_POST_NAME,_0x2b2b79);const _0x127acd=(await createDeployZip(_0x2b2b79)['then'](_0x29e142=>{return _0x29e142;}))['toBuffer']()[_0x2ed739(0x1ce)](_0x2ed739(0x1f8));console[_0x2ed739(0x1d8)](_0x2ed739(0x21d));const _0x3c1d7e=_0x127acd[_0x2ed739(0x1ee)];if(_0x3c1d7e>=components_api_1[_0x2ed739(0x1fe)]){const _0x173a12=await createDeployZip(_0x2b2b79);console[_0x2ed739(0x1d8)](_0x2ed739(0x1fb));const [_0x36955a,_0x3aeb09]=await components_api_1[_0x2ed739(0x207)][_0x2ed739(0x21a)](_0x173a12,_0x3c1d7e),_0x55beb8=await insertZip(_0x2c1df4,_0x7d6c55,_0x3af05f[_0x2ed739(0x1ed)],_0xa7d20b,_0x36955a[_0x2ed739(0x1db)]()[_0x2ed739(0x1ce)](_0x2ed739(0x1f8))),_0x1e76bc=await insertZip(_0x2c1df4,_0x7d6c55,_0x3af05f[_0x2ed739(0x1ed)],_0xa7d20b,_0x3aeb09[_0x2ed739(0x1db)]()['toString'](_0x2ed739(0x1f8)));return _0x55beb8+','+_0x1e76bc;}else return await insertZip(_0x2c1df4,_0x7d6c55,_0x3af05f[_0x2ed739(0x1ed)],_0xa7d20b,_0x127acd);}catch(_0x1633a4){throw _0x1633a4;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x2ed739(0x218)]['join'](process[_0x2ed739(0x213)](),_0x2ed739(0x1f0),_0x2b2b79)))await(0x0,promises_1['rm'])(path_1['default']['join'](process[_0x2ed739(0x213)](),_0x2ed739(0x1f0),_0x2b2b79),{'recursive':!![]});}}exports[a86_0x1d5c9e(0x204)]=generateAndDeployZip;async function getComponents(_0x2d002e,_0xd0a7a2,_0x2180bc){const _0x29439a=a86_0x1d5c9e,_0x46571a=[],_0x51d550=await(0x0,fetch_attachments_1[_0x29439a(0x222)])(_0x2d002e,_0xd0a7a2);return await getComponentFromZip(_0x51d550,_0x2180bc)[_0x29439a(0x221)](_0x58adf4=>{_0x46571a['push'](..._0x58adf4);}),_0x46571a;}async function getComponentFromZip(_0x3e175b,_0x26ed97){const _0x36c607=a86_0x1d5c9e,_0x112294=[];for(const _0x1f79db of _0x3e175b){const _0x5ea600=await zip_1['Zip'][_0x36c607(0x1d7)](_0x1f79db['values'][_0x36c607(0x1cd)]);for(const _0x38b673 in _0x5ea600[_0x36c607(0x20d)]){!_0x5ea600[_0x36c607(0x20d)][_0x38b673]['dir']&&_0x112294['push']({'fileName':_0x38b673[_0x36c607(0x21c)](_0x38b673[_0x36c607(0x1ff)]('/')+0x1),'fileType':_0x26ed97[_0x1f79db['id']],'body':_0x1f79db[_0x36c607(0x1ec)][_0x36c607(0x1cd)]});}}return _0x112294;}async function removePermission(_0x190712,_0x7f9f7){const _0x2b681c=a86_0x1d5c9e;for(const _0x616f64 of _0x190712){const _0x42ae9c=await zip_1[_0x2b681c(0x1da)][_0x2b681c(0x1d7)](_0x616f64['body']),_0x5eacbf=[];for(const _0x222242 in _0x42ae9c[_0x2b681c(0x20d)]){!_0x42ae9c['files'][_0x222242][_0x2b681c(0x1f3)]&&_0x5eacbf['push']({'fileName':_0x222242,'body':await _0x42ae9c[_0x2b681c(0x20d)][_0x222242][_0x2b681c(0x1e4)](_0x2b681c(0x1dc))});}const _0x3889d7=await(0x0,extract_component_permissions_1[_0x2b681c(0x215)])(_0x5eacbf[0x0][_0x2b681c(0x1ef)][_0x2b681c(0x1ce)](),_0x7f9f7,_0x616f64[_0x2b681c(0x1e8)]),_0x5370f3=new xml2js_1[(_0x2b681c(0x21b))]({'xmldec':{'version':_0x2b681c(0x1fd),'encoding':_0x2b681c(0x1d6)}}),_0x2ab566=_0x5370f3[_0x2b681c(0x225)](_0x3889d7),_0x3a305a=zip_1['Zip'][_0x2b681c(0x206)]();_0x3a305a[_0x2b681c(0x1d0)](_0x5eacbf[0x0][_0x2b681c(0x21e)],_0x2ab566),_0x616f64[_0x2b681c(0x1ef)]=await _0x3a305a['generateAsync']({'type':_0x2b681c(0x1f8),'compression':_0x2b681c(0x214),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x11effb,_0x4bf3ff,_0x27a362){const _0x28db6a=a86_0x1d5c9e;for(const _0x34fc4b of _0x27a362){if(_0x11effb[_0x28db6a(0x1f9)](_0x4f6e0d=>_0x4f6e0d!==_0x34fc4b[_0x28db6a(0x1e8)]))continue;const _0x33ee34=await zip_1['Zip'][_0x28db6a(0x1d7)](_0x34fc4b[_0x28db6a(0x1ef)]);for(const _0x25f4e6 in _0x33ee34[_0x28db6a(0x20d)]){if(!_0x33ee34[_0x28db6a(0x20d)][_0x25f4e6][_0x28db6a(0x1f3)]){let _0x19584b=await _0x33ee34[_0x28db6a(0x20d)][_0x25f4e6][_0x28db6a(0x1e4)]('text');for(const _0x3ad2c0 of Object[_0x28db6a(0x1cf)](_0x4bf3ff)){const _0x3c3c02=new RegExp('%%'+_0x3ad2c0+'%%','g');_0x19584b=_0x19584b['replace'](_0x3c3c02,_0x4bf3ff[_0x3ad2c0]);}_0x33ee34['file'](_0x25f4e6,_0x19584b);}}_0x34fc4b[_0x28db6a(0x1ef)]=await _0x33ee34['generateAsync']({'type':'base64','compression':_0x28db6a(0x214),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x12af32,_0x1b969f){const _0x5560b7=a86_0x1d5c9e,_0xde25a5=new mdapi_1[(_0x5560b7(0x201))]({'components':_0x12af32,'sourceDir':path_1[_0x5560b7(0x218)]['join'](process[_0x5560b7(0x213)](),'.temp',_0x1b969f,DEPLOY_DIR_NAME,_0x5560b7(0x216)),'skipChildErrors':![]});await _0xde25a5[_0x5560b7(0x203)]();}async function generateAndWritePackageXML(_0xff39a0,_0x5d0d4f,_0x4cc4f3){const _0x2a3879=a86_0x1d5c9e,_0x46de33=getComponentsTypeAndName(_0xff39a0,_0x5d0d4f),_0x21202b=[...new Set(_0x46de33[_0x2a3879(0x21f)](_0x4763ac=>_0x4763ac[_0x2a3879(0x223)]))],_0x394b7b={'Package':{'$':{'xmlns':_0x2a3879(0x20f)},'types':[],'version':''+constants_1[_0x2a3879(0x1ea)][_0x2a3879(0x21c)](0x1)}};for(const _0x6a7a8b of _0x21202b){const _0x38f5ed=_0x46de33[_0x2a3879(0x1f6)](_0x69e6e1=>_0x69e6e1[_0x2a3879(0x223)]===_0x6a7a8b)[_0x2a3879(0x21f)](_0x5f39bd=>_0x5f39bd[_0x2a3879(0x1e9)]),_0x19d325={'members':_0x38f5ed,'name':_0x6a7a8b};_0x394b7b['Package'][_0x2a3879(0x1d3)]['push'](_0x19d325);}const _0x3f5a9d=new xml2js_1[(_0x2a3879(0x21b))]({'xmldec':{'version':_0x2a3879(0x1fd),'encoding':'UTF-8'}}),_0x4cbcd8=_0x3f5a9d['buildObject'](_0x394b7b);await fs_internal_1['FS'][_0x2a3879(0x1e1)](path_1[_0x2a3879(0x218)][_0x2a3879(0x20c)](process[_0x2a3879(0x213)](),_0x2a3879(0x1f0),_0x4cc4f3,DEPLOY_DIR_NAME,_0x2a3879(0x216),_0x2a3879(0x202)),_0x4cbcd8);}function getComponentsTypeAndName(_0x27a449,_0x2d38a5){return _0x27a449['reduce']((_0x29a4b4,_0x48c7)=>{const _0x2c1be2=a86_0x466d,_0x24bdf8=_0x2d38a5[_0x2c1be2(0x20e)](_0xdec31=>_0xdec31['Id']===_0x48c7['ParentId']);return _0x24bdf8&&_0x29a4b4['push']({'name':_0x24bdf8['Component__r'][_0x2c1be2(0x1dd)],'type':_0x48c7[_0x2c1be2(0x1fa)]}),_0x29a4b4;},[]);}async function saveDestructiveChanges(_0x2561d0,_0x5f27fe,_0x5b82bb,_0x268bb5){const _0x382f29=a86_0x1d5c9e,_0x216469=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x2561d0,_0x5f27fe))[_0x382f29(0x1ce)]();await fs_internal_1['FS']['writeFile'](path_1[_0x382f29(0x218)][_0x382f29(0x20c)](process['cwd'](),_0x382f29(0x1f0),_0x268bb5,DEPLOY_DIR_NAME,_0x382f29(0x216),_0x5b82bb),_0x216469);}async function createDeployZip(_0x4eff1d){const _0x38a0f3=a86_0x1d5c9e,_0x4be318=new adm_zip_1[(_0x38a0f3(0x218))]();return await _0x4be318[_0x38a0f3(0x1d2)](path_1[_0x38a0f3(0x218)]['join'](process['cwd'](),_0x38a0f3(0x1f0),_0x4eff1d,DEPLOY_DIR_NAME)),_0x4be318;}async function insertZip(_0x56f1e0,_0x34cb37,_0x8445dc,_0x18154a,_0x3ae0ca){const _0x2fae68=a86_0x1d5c9e,_0x13ad88={'ParentId':_0x34cb37,'Name':_0x2fae68(0x1ca)+_0x8445dc,'Description':'BUILD'+_0x18154a,'Body':_0x3ae0ca},{data:_0x3cb011}=await _0x56f1e0['post'](_0x2fae68(0x1f7)+constants_1[_0x2fae68(0x1ea)]+_0x2fae68(0x1e0),_0x13ad88);return _0x3cb011['id'];}