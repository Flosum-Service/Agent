const a54_0x50a43d=a54_0x51c7;(function(_0x493607,_0x523ad0){const _0x1829ea=a54_0x51c7,_0x26200c=_0x493607();while(!![]){try{const _0x10d1f4=parseInt(_0x1829ea(0x147))/0x1*(parseInt(_0x1829ea(0x18a))/0x2)+-parseInt(_0x1829ea(0x14e))/0x3*(parseInt(_0x1829ea(0x162))/0x4)+-parseInt(_0x1829ea(0x145))/0x5*(parseInt(_0x1829ea(0x186))/0x6)+parseInt(_0x1829ea(0x178))/0x7*(-parseInt(_0x1829ea(0x14f))/0x8)+parseInt(_0x1829ea(0x141))/0x9*(-parseInt(_0x1829ea(0x144))/0xa)+parseInt(_0x1829ea(0x193))/0xb*(-parseInt(_0x1829ea(0x16d))/0xc)+parseInt(_0x1829ea(0x140))/0xd;if(_0x10d1f4===_0x523ad0)break;else _0x26200c['push'](_0x26200c['shift']());}catch(_0x4e1cab){_0x26200c['push'](_0x26200c['shift']());}}}(a54_0xd334,0x24acb));const a54_0x27bfac=(function(){let _0x1e6113=!![];return function(_0x1d5f2b,_0x198635){const _0x35f345=_0x1e6113?function(){const _0xdd0105=a54_0x51c7;if(_0x198635){const _0x1ff5ac=_0x198635[_0xdd0105(0x13b)](_0x1d5f2b,arguments);return _0x198635=null,_0x1ff5ac;}}:function(){};return _0x1e6113=![],_0x35f345;};}()),a54_0x47532f=a54_0x27bfac(this,function(){const _0x357f6f=a54_0x51c7;return a54_0x47532f[_0x357f6f(0x161)]()[_0x357f6f(0x158)](_0x357f6f(0x164))[_0x357f6f(0x161)]()[_0x357f6f(0x153)](a54_0x47532f)[_0x357f6f(0x158)](_0x357f6f(0x164));});a54_0x47532f();'use strict';var __importDefault=this&&this[a54_0x50a43d(0x180)]||function(_0x47ef92){const _0x4a66df=a54_0x50a43d;return _0x47ef92&&_0x47ef92[_0x4a66df(0x17d)]?_0x47ef92:{'default':_0x47ef92};};Object[a54_0x50a43d(0x151)](exports,a54_0x50a43d(0x17d),{'value':!![]}),exports[a54_0x50a43d(0x181)]=void 0x0;const constants_1=require(a54_0x50a43d(0x16a)),path_1=__importDefault(require(a54_0x50a43d(0x188))),extract_component_permissions_1=require(a54_0x50a43d(0x16e)),xml2js_1=require(a54_0x50a43d(0x15a)),zip_1=require(a54_0x50a43d(0x16f)),mdapi_1=require(a54_0x50a43d(0x179)),fs_internal_1=require(a54_0x50a43d(0x17b)),promises_1=require(a54_0x50a43d(0x155)),components_api_1=require(a54_0x50a43d(0x15f)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a54_0x50a43d(0x196)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a54_0x50a43d(0x190),DESTRUCTIVE_CHANGES_POST_NAME=a54_0x50a43d(0x16c),DEPLOY_DIR_NAME=a54_0x50a43d(0x18b);async function generateAndDeployZip({attachmentsId:_0x29ffe5,isExtractComponentsPermissions:_0x5039a1,preDestructiveAttachmentId:_0x217b35,postDestructiveAttachmentId:_0x173321,branchId:_0x542977,credentials:_0xa5d295,metadataLogId:_0x13fca1,environments:_0x3ce485,metaTypes:_0x4f5f19},_0xc00929){const _0x3bac5e=a54_0x50a43d,_0x2b1d8f=(0x0,uuid_1['v4'])();try{const _0x2b0aa1=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0xc00929,_0x29ffe5),_0x3d6abe=_0x2b0aa1[_0x3bac5e(0x146)]((_0x22f6b1,_0x260914)=>({..._0x22f6b1,[_0x260914['Id']]:_0x260914['Name']}),{}),_0x141f57=await getComponents(_0x2b0aa1,_0xc00929,_0x3d6abe),_0x4fafd9=await components_api_1['ComponentsApi'][_0x3bac5e(0x18e)](_0xc00929,_0x2b0aa1[_0x3bac5e(0x13e)](({ParentId:_0x2c9c83})=>_0x2c9c83))[_0x3bac5e(0x185)](_0x4945ea=>components_api_1[_0x3bac5e(0x16b)][_0x3bac5e(0x159)](_0x4945ea));if(_0x5039a1){const _0x5b8d0d=_0x141f57[_0x3bac5e(0x150)](({fileType:_0x4f1f32})=>_0x4f1f32===_0x3bac5e(0x183)||_0x4f1f32===_0x3bac5e(0x17f));await removePermission(_0x5b8d0d,_0x4fafd9);}await replaceEnvironments(_0x4f5f19,_0x3ce485,_0x141f57),await writeZip(_0x141f57,_0x2b1d8f),await generateAndWritePackageXML(_0x2b0aa1,_0x4fafd9,_0x2b1d8f);_0x217b35&&await saveDestructiveChanges(_0xc00929,_0x217b35,DESTRUCTIVE_CHANGES_PER_NAME,_0x2b1d8f);_0x173321&&await saveDestructiveChanges(_0xc00929,_0x173321,DESTRUCTIVE_CHANGES_POST_NAME,_0x2b1d8f);const _0x46fb4d=(await createDeployZip(_0x2b1d8f)['then'](_0x4aabca=>{return _0x4aabca;}))['toBuffer']()[_0x3bac5e(0x161)]('base64');console[_0x3bac5e(0x170)]('after\x20create\x20zip');const _0x501f54=_0x46fb4d[_0x3bac5e(0x156)];if(_0x501f54>=components_api_1[_0x3bac5e(0x191)]){const _0x4882d0=await createDeployZip(_0x2b1d8f);console[_0x3bac5e(0x170)](_0x3bac5e(0x15b));const [_0x4c65ff,_0x4ae486]=await components_api_1[_0x3bac5e(0x16b)]['splitZip'](_0x4882d0,_0x501f54),_0xaa215e=await insertZip(_0xc00929,_0x542977,_0xa5d295[_0x3bac5e(0x148)],_0x13fca1,_0x4c65ff[_0x3bac5e(0x14b)]()[_0x3bac5e(0x161)](_0x3bac5e(0x15d))),_0x2297e0=await insertZip(_0xc00929,_0x542977,_0xa5d295[_0x3bac5e(0x148)],_0x13fca1,_0x4ae486[_0x3bac5e(0x14b)]()[_0x3bac5e(0x161)](_0x3bac5e(0x15d)));return _0xaa215e+','+_0x2297e0;}else return await insertZip(_0xc00929,_0x542977,_0xa5d295['orgId'],_0x13fca1,_0x46fb4d);}catch(_0x1dd947){throw _0x1dd947;}finally{if(await fs_internal_1['FS'][_0x3bac5e(0x163)](path_1[_0x3bac5e(0x154)][_0x3bac5e(0x143)](process[_0x3bac5e(0x177)](),_0x3bac5e(0x174),_0x2b1d8f)))await(0x0,promises_1['rm'])(path_1[_0x3bac5e(0x154)][_0x3bac5e(0x143)](process['cwd'](),_0x3bac5e(0x174),_0x2b1d8f),{'recursive':!![]});}}exports[a54_0x50a43d(0x181)]=generateAndDeployZip;async function getComponents(_0x49f932,_0x4c26ab,_0x43386c){const _0x184edc=a54_0x50a43d,_0x1d7de1=[],_0x398d90=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x49f932,_0x4c26ab);return await getComponentFromZip(_0x398d90,_0x43386c)[_0x184edc(0x185)](_0x3ff26c=>{const _0x4dad83=_0x184edc;_0x1d7de1[_0x4dad83(0x17c)](..._0x3ff26c);}),_0x1d7de1;}async function getComponentFromZip(_0x107c6a,_0x3fb43c){const _0x55f651=a54_0x50a43d,_0x320aa1=[];for(const _0x3b984c of _0x107c6a){const _0x58deb5=await zip_1[_0x55f651(0x198)][_0x55f651(0x17a)](_0x3b984c[_0x55f651(0x192)][_0x55f651(0x13d)]);for(const _0x5f14b4 in _0x58deb5[_0x55f651(0x18c)]){!_0x58deb5[_0x55f651(0x18c)][_0x5f14b4][_0x55f651(0x189)]&&_0x320aa1['push']({'fileName':_0x5f14b4['substring'](_0x5f14b4['indexOf']('/')+0x1),'fileType':_0x3fb43c[_0x3b984c['id']],'body':_0x3b984c['values'][_0x55f651(0x13d)]});}}return _0x320aa1;}function a54_0x51c7(_0x31889a,_0x37d1f0){const _0x28fa38=a54_0xd334();return a54_0x51c7=function(_0x47532f,_0x27bfac){_0x47532f=_0x47532f-0x13b;let _0xd3340d=_0x28fa38[_0x47532f];return _0xd3340d;},a54_0x51c7(_0x31889a,_0x37d1f0);}function a54_0xd334(){const _0x50236d=['every','Body','map','substring','9556950tVJktX','9MHmFgt','BUILD','join','1053250xZokMy','224195feLYbh','reduce','32489GFSZHH','orgId','writeFile','Name','toBuffer','text','async','11577rMHpRD','8gAVVeD','filter','defineProperty','package.xml','constructor','default','fs/promises','length','type','search','removeNamespacePrefix','xml2js','after\x20create\x20second\x20zip','UTF-8','base64','types','../utils/components-api','find','toString','212frwZOP','exists','(((.+)+)+)+$','SALESFORCE_API_VERSION','post','src','/sobjects/Attachment','keys','../../../constants','ComponentsApi','destructiveChangesPost.xml','36SPTzVL','../utils/extract-component-permissions','../../git/parsers/utils/zip','log','generateAsync','file','body','.temp','start','fileName','cwd','703507MUZMez','../../git/parsers/mdapi','unzip','../../git/internal/fs.internal','push','__esModule','1.0','PermissionSet','__importDefault','generateAndDeployZip','Builder','Profile','fileType','then','6MxAzsh','fetchAttachmentBody','path','dir','2ZjxUGe','DEPLOYZIP','files','Package','fetchComponentsDetailsByComponentsHistory','name','destructiveChangesPre.xml','MAX_ZIP_SIZE','values','594836bzaJTH','MDApiWriter','ParentId','uuid','extractComponentPermissions','Zip','buildObject','apply'];a54_0xd334=function(){return _0x50236d;};return a54_0xd334();}async function removePermission(_0x2ee0ff,_0x49f0e1){const _0x498199=a54_0x50a43d;for(const _0x82246d of _0x2ee0ff){const _0x3da48f=await zip_1[_0x498199(0x198)]['unzip'](_0x82246d[_0x498199(0x173)]),_0x3a5bac=[];for(const _0x587b9c in _0x3da48f[_0x498199(0x18c)]){!_0x3da48f['files'][_0x587b9c][_0x498199(0x189)]&&_0x3a5bac[_0x498199(0x17c)]({'fileName':_0x587b9c,'body':await _0x3da48f[_0x498199(0x18c)][_0x587b9c][_0x498199(0x14d)](_0x498199(0x14c))});}const _0x460d7c=await(0x0,extract_component_permissions_1[_0x498199(0x197)])(_0x3a5bac[0x0]['body'][_0x498199(0x161)](),_0x49f0e1,_0x82246d['fileType']),_0x1e638a=new xml2js_1[(_0x498199(0x182))]({'xmldec':{'version':_0x498199(0x17e),'encoding':_0x498199(0x15c)}}),_0x278a0d=_0x1e638a[_0x498199(0x199)](_0x460d7c),_0x3acca9=zip_1[_0x498199(0x198)]['createZip']();_0x3acca9[_0x498199(0x172)](_0x3a5bac[0x0][_0x498199(0x176)],_0x278a0d),_0x82246d[_0x498199(0x173)]=await _0x3acca9[_0x498199(0x171)]({'type':'base64','compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x5d7ba4,_0x45c434,_0x12e523){const _0x5da731=a54_0x50a43d;for(const _0x32ab5c of _0x12e523){if(_0x5d7ba4[_0x5da731(0x13c)](_0x46c27f=>_0x46c27f!==_0x32ab5c[_0x5da731(0x184)]))continue;const _0x3877c1=await zip_1[_0x5da731(0x198)][_0x5da731(0x17a)](_0x32ab5c[_0x5da731(0x173)]);for(const _0xb5212e in _0x3877c1['files']){if(!_0x3877c1[_0x5da731(0x18c)][_0xb5212e]['dir']){let _0x377a17=await _0x3877c1['files'][_0xb5212e]['async'](_0x5da731(0x14c));for(const _0x2f9b98 of Object[_0x5da731(0x169)](_0x45c434)){const _0x420333=new RegExp('%%'+_0x2f9b98+'%%','g');_0x377a17=_0x377a17['replace'](_0x420333,_0x45c434[_0x2f9b98]);}_0x3877c1[_0x5da731(0x172)](_0xb5212e,_0x377a17);}}_0x32ab5c[_0x5da731(0x173)]=await _0x3877c1[_0x5da731(0x171)]({'type':_0x5da731(0x15d),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x2ffac6,_0x440792){const _0x2a374f=a54_0x50a43d,_0x332480=new mdapi_1[(_0x2a374f(0x194))]({'components':_0x2ffac6,'sourceDir':path_1[_0x2a374f(0x154)][_0x2a374f(0x143)](process[_0x2a374f(0x177)](),_0x2a374f(0x174),_0x440792,DEPLOY_DIR_NAME,_0x2a374f(0x167)),'skipChildErrors':![]});await _0x332480[_0x2a374f(0x175)]();}async function generateAndWritePackageXML(_0x1b8dda,_0x231d85,_0x4b8032){const _0x48492d=a54_0x50a43d,_0x4fd9ad=getComponentsTypeAndName(_0x1b8dda,_0x231d85),_0x14602b=[...new Set(_0x4fd9ad[_0x48492d(0x13e)](_0xeafb9c=>_0xeafb9c[_0x48492d(0x157)]))],_0x5a9cdf={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1[_0x48492d(0x165)][_0x48492d(0x13f)](0x1)}};for(const _0x4357c8 of _0x14602b){const _0x3de6b7=_0x4fd9ad[_0x48492d(0x150)](_0x1e53b0=>_0x1e53b0[_0x48492d(0x157)]===_0x4357c8)[_0x48492d(0x13e)](_0x26b5b4=>_0x26b5b4[_0x48492d(0x18f)]),_0x3c788f={'members':_0x3de6b7,'name':_0x4357c8};_0x5a9cdf[_0x48492d(0x18d)][_0x48492d(0x15e)][_0x48492d(0x17c)](_0x3c788f);}const _0x5f1dc2=new xml2js_1[(_0x48492d(0x182))]({'xmldec':{'version':_0x48492d(0x17e),'encoding':_0x48492d(0x15c)}}),_0x448595=_0x5f1dc2[_0x48492d(0x199)](_0x5a9cdf);await fs_internal_1['FS']['writeFile'](path_1[_0x48492d(0x154)]['join'](process[_0x48492d(0x177)](),_0x48492d(0x174),_0x4b8032,DEPLOY_DIR_NAME,_0x48492d(0x167),_0x48492d(0x152)),_0x448595);}function getComponentsTypeAndName(_0x407163,_0xbefdab){const _0x382257=a54_0x50a43d;return _0x407163[_0x382257(0x146)]((_0x157a30,_0x99cbb5)=>{const _0x1bba35=_0x382257,_0x14a282=_0xbefdab[_0x1bba35(0x160)](_0x26af3c=>_0x26af3c['Id']===_0x99cbb5[_0x1bba35(0x195)]);return _0x14a282&&_0x157a30[_0x1bba35(0x17c)]({'name':_0x14a282['Component__r']['Component_Name__c'],'type':_0x99cbb5[_0x1bba35(0x14a)]}),_0x157a30;},[]);}async function saveDestructiveChanges(_0x2170e4,_0x3834cc,_0x1fbdfb,_0xf6ee9f){const _0xe6d310=a54_0x50a43d,_0x2a15a9=(await(0x0,fetch_attachments_1[_0xe6d310(0x187)])(_0x2170e4,_0x3834cc))[_0xe6d310(0x161)]();await fs_internal_1['FS'][_0xe6d310(0x149)](path_1[_0xe6d310(0x154)][_0xe6d310(0x143)](process['cwd'](),_0xe6d310(0x174),_0xf6ee9f,DEPLOY_DIR_NAME,_0xe6d310(0x167),_0x1fbdfb),_0x2a15a9);}async function createDeployZip(_0x45a78d){const _0x5682bf=a54_0x50a43d,_0xda1721=new adm_zip_1[(_0x5682bf(0x154))]();return await _0xda1721['addLocalFolder'](path_1['default'][_0x5682bf(0x143)](process[_0x5682bf(0x177)](),_0x5682bf(0x174),_0x45a78d,DEPLOY_DIR_NAME)),_0xda1721;}async function insertZip(_0x4c4da9,_0x16fbca,_0x454bab,_0x21733d,_0xf2f82e){const _0x3e8f0a=a54_0x50a43d,_0x14fd02={'ParentId':_0x16fbca,'Name':_0x3e8f0a(0x142)+_0x454bab,'Description':'BUILD'+_0x21733d,'Body':_0xf2f82e},{data:_0x1c71c1}=await _0x4c4da9[_0x3e8f0a(0x166)]('/services/data/'+constants_1[_0x3e8f0a(0x165)]+_0x3e8f0a(0x168),_0x14fd02);return _0x1c71c1['id'];}