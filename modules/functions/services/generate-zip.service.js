const a86_0x4d9cca=a86_0x398d;(function(_0x48f596,_0x5c935c){const _0x212e9d=a86_0x398d,_0x44cfe8=_0x48f596();while(!![]){try{const _0x5f693c=parseInt(_0x212e9d(0xc8))/0x1*(-parseInt(_0x212e9d(0x105))/0x2)+-parseInt(_0x212e9d(0xfd))/0x3+parseInt(_0x212e9d(0xe3))/0x4+parseInt(_0x212e9d(0x103))/0x5+-parseInt(_0x212e9d(0xd9))/0x6*(-parseInt(_0x212e9d(0xb5))/0x7)+-parseInt(_0x212e9d(0xfe))/0x8*(parseInt(_0x212e9d(0xdd))/0x9)+parseInt(_0x212e9d(0xf7))/0xa*(parseInt(_0x212e9d(0x107))/0xb);if(_0x5f693c===_0x5c935c)break;else _0x44cfe8['push'](_0x44cfe8['shift']());}catch(_0x3ec7ca){_0x44cfe8['push'](_0x44cfe8['shift']());}}}(a86_0x1a4b,0x5cd12));const a86_0x3e40df=(function(){let _0x41da40=!![];return function(_0x5f0dc5,_0x4583ec){const _0x52bc83=_0x41da40?function(){const _0x409a43=a86_0x398d;if(_0x4583ec){const _0x311929=_0x4583ec[_0x409a43(0xd0)](_0x5f0dc5,arguments);return _0x4583ec=null,_0x311929;}}:function(){};return _0x41da40=![],_0x52bc83;};}()),a86_0xcffc33=a86_0x3e40df(this,function(){const _0x39a148=a86_0x398d;return a86_0xcffc33['toString']()[_0x39a148(0xd4)](_0x39a148(0xd6))[_0x39a148(0xd3)]()[_0x39a148(0x101)](a86_0xcffc33)['search'](_0x39a148(0xd6));});a86_0xcffc33();'use strict';var __importDefault=this&&this[a86_0x4d9cca(0xc3)]||function(_0x543d08){const _0x2477da=a86_0x4d9cca;return _0x543d08&&_0x543d08[_0x2477da(0xf9)]?_0x543d08:{'default':_0x543d08};};Object[a86_0x4d9cca(0xc1)](exports,'__esModule',{'value':!![]}),exports[a86_0x4d9cca(0xe9)]=void 0x0;const constants_1=require(a86_0x4d9cca(0xf4)),path_1=__importDefault(require(a86_0x4d9cca(0xec))),extract_component_permissions_1=require(a86_0x4d9cca(0xd7)),xml2js_1=require(a86_0x4d9cca(0xb1)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a86_0x4d9cca(0xde)),promises_1=require('fs/promises'),components_api_1=require(a86_0x4d9cca(0xc4)),adm_zip_1=__importDefault(require(a86_0x4d9cca(0xe1))),uuid_1=require(a86_0x4d9cca(0xcb)),fetch_attachments_1=require(a86_0x4d9cca(0xb8)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x4d9cca(0xb6),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x4d9cca(0xc9),DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x5a725f,isExtractComponentsPermissions:_0x26b8d9,preDestructiveAttachmentId:_0x47052a,postDestructiveAttachmentId:_0x17c275,branchId:_0x88aa39,credentials:_0x20763c,metadataLogId:_0x17c97c,environments:_0x2f0713,metaTypes:_0x35cda0},_0x5d8463){const _0x5be63d=a86_0x4d9cca,_0x1a4e42=(0x0,uuid_1['v4'])();try{const _0x5dc10f=await(0x0,fetch_attachments_1[_0x5be63d(0x104)])(_0x5d8463,_0x5a725f),_0x5a68c3=_0x5dc10f[_0x5be63d(0xc7)]((_0x5d1585,_0x26516d)=>({..._0x5d1585,[_0x26516d['Id']]:_0x26516d[_0x5be63d(0xdb)]}),{}),_0x2f9c69=await getComponents(_0x5dc10f,_0x5d8463,_0x5a68c3),_0xa9ddff=await components_api_1[_0x5be63d(0x10b)]['fetchComponentsDetailsByComponentsHistory'](_0x5d8463,_0x5dc10f[_0x5be63d(0xea)](({ParentId:_0x38c1b4})=>_0x38c1b4))[_0x5be63d(0x108)](_0x81c995=>components_api_1[_0x5be63d(0x10b)][_0x5be63d(0xfc)](_0x81c995));if(_0x26b8d9){const _0x1319e1=_0x2f9c69[_0x5be63d(0xf8)](({fileType:_0x4bbfef})=>_0x4bbfef==='Profile'||_0x4bbfef===_0x5be63d(0x106));await removePermission(_0x1319e1,_0xa9ddff);}await replaceEnvironments(_0x35cda0,_0x2f0713,_0x2f9c69),await writeZip(_0x2f9c69,_0x1a4e42),await generateAndWritePackageXML(_0x5dc10f,_0xa9ddff,_0x1a4e42);_0x47052a&&await saveDestructiveChanges(_0x5d8463,_0x47052a,DESTRUCTIVE_CHANGES_PER_NAME,_0x1a4e42);_0x17c275&&await saveDestructiveChanges(_0x5d8463,_0x17c275,DESTRUCTIVE_CHANGES_POST_NAME,_0x1a4e42);const _0x5ccfd3=(await createDeployZip(_0x1a4e42)[_0x5be63d(0x108)](_0x497b89=>{return _0x497b89;}))[_0x5be63d(0xe7)]()['toString'](_0x5be63d(0x100));console['log'](_0x5be63d(0xf3));const _0x43d7c1=_0x5ccfd3[_0x5be63d(0xd2)];if(_0x43d7c1>=components_api_1[_0x5be63d(0xfa)]){const _0x4c75c8=await createDeployZip(_0x1a4e42);console[_0x5be63d(0xd1)]('after\x20create\x20second\x20zip');const [_0x41166d,_0x4b5f1a]=await components_api_1[_0x5be63d(0x10b)]['splitZip'](_0x4c75c8,_0x43d7c1),_0x2a5985=await insertZip(_0x5d8463,_0x88aa39,_0x20763c[_0x5be63d(0x109)],_0x17c97c,_0x41166d[_0x5be63d(0xe7)]()[_0x5be63d(0xd3)]('base64')),_0x2f19ad=await insertZip(_0x5d8463,_0x88aa39,_0x20763c[_0x5be63d(0x109)],_0x17c97c,_0x4b5f1a[_0x5be63d(0xe7)]()[_0x5be63d(0xd3)](_0x5be63d(0x100)));return _0x2a5985+','+_0x2f19ad;}else return await insertZip(_0x5d8463,_0x88aa39,_0x20763c[_0x5be63d(0x109)],_0x17c97c,_0x5ccfd3);}catch(_0x8ee774){throw _0x8ee774;}finally{if(await fs_internal_1['FS'][_0x5be63d(0xb2)](path_1['default'][_0x5be63d(0xf0)](process['cwd'](),_0x5be63d(0xff),_0x1a4e42)))await(0x0,promises_1['rm'])(path_1[_0x5be63d(0xe6)][_0x5be63d(0xf0)](process['cwd'](),_0x5be63d(0xff),_0x1a4e42),{'recursive':!![]});}}function a86_0x1a4b(){const _0x3ec96c=['/services/data/','Package','generateAsync','unzip','file','Zip','dir','substring','defineProperty','name','__importDefault','../utils/components-api','addLocalFolder','http://soap.sforce.com/2006/04/metadata','reduce','3uLSLch','destructiveChangesPost.xml','buildObject','uuid','text','keys','post','type','apply','log','length','toString','search','/sobjects/Attachment','(((.+)+)+)+$','../utils/extract-component-permissions','values','12846Cfeaai','Component__r','Name','cwd','910350rnTfFN','../../git/internal/fs.internal','push','Body','adm-zip','fileName','2288800dooloZ','body','BUILD','default','toBuffer','replace','generateAndDeployZip','map','ParentId','path','SALESFORCE_API_VERSION','every','DEFLATE','join','fileType','writeFile','after\x20create\x20zip','../../../constants','fetchAttachmentBody','Builder','190IwvXbU','filter','__esModule','MAX_ZIP_SIZE','indexOf','removeNamespacePrefix','1845477EfsoJG','40vYHgng','.temp','base64','constructor','UTF-8','653155hSlWnN','fetchAttachmentsDetailsById','77052ZcShGR','PermissionSet','91509NKUSyM','then','orgId','src','ComponentsApi','start','extractComponentPermissions','xml2js','exists','files','package.xml','2471vIRdjj','destructiveChangesPre.xml','find','../../shared/utils/fetch-attachments'];a86_0x1a4b=function(){return _0x3ec96c;};return a86_0x1a4b();}exports[a86_0x4d9cca(0xe9)]=generateAndDeployZip;async function getComponents(_0x551876,_0x873f72,_0x1aff1e){const _0x3b5917=a86_0x4d9cca,_0x1f007d=[],_0x4a5f79=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x551876,_0x873f72);return await getComponentFromZip(_0x4a5f79,_0x1aff1e)[_0x3b5917(0x108)](_0x2dacb1=>{const _0x9ae129=_0x3b5917;_0x1f007d[_0x9ae129(0xdf)](..._0x2dacb1);}),_0x1f007d;}async function getComponentFromZip(_0x57dc8d,_0x130463){const _0x4c4261=a86_0x4d9cca,_0x3cab5f=[];for(const _0x2e19b8 of _0x57dc8d){const _0xb6fb53=await zip_1['Zip'][_0x4c4261(0xbc)](_0x2e19b8[_0x4c4261(0xd8)][_0x4c4261(0xe0)]);for(const _0xbf6dea in _0xb6fb53[_0x4c4261(0xb3)]){!_0xb6fb53[_0x4c4261(0xb3)][_0xbf6dea][_0x4c4261(0xbf)]&&_0x3cab5f[_0x4c4261(0xdf)]({'fileName':_0xbf6dea[_0x4c4261(0xc0)](_0xbf6dea[_0x4c4261(0xfb)]('/')+0x1),'fileType':_0x130463[_0x2e19b8['id']],'body':_0x2e19b8[_0x4c4261(0xd8)]['Body']});}}return _0x3cab5f;}async function removePermission(_0x592765,_0x1bef57){const _0x45eb8c=a86_0x4d9cca;for(const _0xd751b0 of _0x592765){const _0x3733ca=await zip_1[_0x45eb8c(0xbe)][_0x45eb8c(0xbc)](_0xd751b0[_0x45eb8c(0xe4)]),_0x406981=[];for(const _0x10ed89 in _0x3733ca[_0x45eb8c(0xb3)]){!_0x3733ca[_0x45eb8c(0xb3)][_0x10ed89][_0x45eb8c(0xbf)]&&_0x406981['push']({'fileName':_0x10ed89,'body':await _0x3733ca[_0x45eb8c(0xb3)][_0x10ed89]['async'](_0x45eb8c(0xcc))});}const _0x1621a3=await(0x0,extract_component_permissions_1[_0x45eb8c(0xb0)])(_0x406981[0x0][_0x45eb8c(0xe4)]['toString'](),_0x1bef57,_0xd751b0['fileType']),_0x27e243=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':_0x45eb8c(0x102)}}),_0x1baa3a=_0x27e243[_0x45eb8c(0xca)](_0x1621a3),_0x4b7e29=zip_1['Zip']['createZip']();_0x4b7e29[_0x45eb8c(0xbd)](_0x406981[0x0][_0x45eb8c(0xe2)],_0x1baa3a),_0xd751b0['body']=await _0x4b7e29[_0x45eb8c(0xbb)]({'type':_0x45eb8c(0x100),'compression':_0x45eb8c(0xef),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x116f1c,_0x497dd8,_0x5a0850){const _0x20b979=a86_0x4d9cca;for(const _0x17feff of _0x5a0850){if(_0x116f1c[_0x20b979(0xee)](_0x41bc94=>_0x41bc94!==_0x17feff[_0x20b979(0xf1)]))continue;const _0x1bc01=await zip_1[_0x20b979(0xbe)]['unzip'](_0x17feff[_0x20b979(0xe4)]);for(const _0x3d02d5 in _0x1bc01['files']){if(!_0x1bc01[_0x20b979(0xb3)][_0x3d02d5]['dir']){let _0x5c3605=await _0x1bc01['files'][_0x3d02d5]['async'](_0x20b979(0xcc));for(const _0x57cfa9 of Object[_0x20b979(0xcd)](_0x497dd8)){const _0x1ec56c=new RegExp('%%'+_0x57cfa9+'%%','g');_0x5c3605=_0x5c3605[_0x20b979(0xe8)](_0x1ec56c,_0x497dd8[_0x57cfa9]);}_0x1bc01['file'](_0x3d02d5,_0x5c3605);}}_0x17feff[_0x20b979(0xe4)]=await _0x1bc01['generateAsync']({'type':_0x20b979(0x100),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x48ce46,_0x4d2e05){const _0x3596c6=a86_0x4d9cca,_0x876318=new mdapi_1['MDApiWriter']({'components':_0x48ce46,'sourceDir':path_1['default'][_0x3596c6(0xf0)](process['cwd'](),_0x3596c6(0xff),_0x4d2e05,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x876318[_0x3596c6(0x10c)]();}async function generateAndWritePackageXML(_0x51d2e7,_0x20a59a,_0x2802b4){const _0x5e16c3=a86_0x4d9cca,_0x32d4a1=getComponentsTypeAndName(_0x51d2e7,_0x20a59a),_0x39e81b=[...new Set(_0x32d4a1['map'](_0x11fc95=>_0x11fc95[_0x5e16c3(0xcf)]))],_0x451e5b={'Package':{'$':{'xmlns':_0x5e16c3(0xc6)},'types':[],'version':''+constants_1[_0x5e16c3(0xed)]['substring'](0x1)}};for(const _0x283132 of _0x39e81b){const _0x51580d=_0x32d4a1[_0x5e16c3(0xf8)](_0x3f9238=>_0x3f9238[_0x5e16c3(0xcf)]===_0x283132)[_0x5e16c3(0xea)](_0x34769f=>_0x34769f[_0x5e16c3(0xc2)]),_0xb9ce3d={'members':_0x51580d,'name':_0x283132};_0x451e5b[_0x5e16c3(0xba)]['types'][_0x5e16c3(0xdf)](_0xb9ce3d);}const _0xd1cd3a=new xml2js_1[(_0x5e16c3(0xf6))]({'xmldec':{'version':'1.0','encoding':_0x5e16c3(0x102)}}),_0x29564b=_0xd1cd3a[_0x5e16c3(0xca)](_0x451e5b);await fs_internal_1['FS'][_0x5e16c3(0xf2)](path_1[_0x5e16c3(0xe6)][_0x5e16c3(0xf0)](process[_0x5e16c3(0xdc)](),'.temp',_0x2802b4,DEPLOY_DIR_NAME,_0x5e16c3(0x10a),_0x5e16c3(0xb4)),_0x29564b);}function getComponentsTypeAndName(_0x2fd178,_0x41edf4){const _0x58cf11=a86_0x4d9cca;return _0x2fd178[_0x58cf11(0xc7)]((_0x4ab01a,_0x2a3029)=>{const _0x43567b=_0x58cf11,_0x327105=_0x41edf4[_0x43567b(0xb7)](_0x118e4d=>_0x118e4d['Id']===_0x2a3029[_0x43567b(0xeb)]);return _0x327105&&_0x4ab01a[_0x43567b(0xdf)]({'name':_0x327105[_0x43567b(0xda)]['Component_Name__c'],'type':_0x2a3029[_0x43567b(0xdb)]}),_0x4ab01a;},[]);}function a86_0x398d(_0x3593f8,_0x3a3066){const _0x51f069=a86_0x1a4b();return a86_0x398d=function(_0xcffc33,_0x3e40df){_0xcffc33=_0xcffc33-0xb0;let _0x1a4bb8=_0x51f069[_0xcffc33];return _0x1a4bb8;},a86_0x398d(_0x3593f8,_0x3a3066);}async function saveDestructiveChanges(_0x4f7453,_0x4400d2,_0x297693,_0x116c6c){const _0x1f1c97=a86_0x4d9cca,_0x5037db=(await(0x0,fetch_attachments_1[_0x1f1c97(0xf5)])(_0x4f7453,_0x4400d2))[_0x1f1c97(0xd3)]();await fs_internal_1['FS'][_0x1f1c97(0xf2)](path_1[_0x1f1c97(0xe6)][_0x1f1c97(0xf0)](process[_0x1f1c97(0xdc)](),_0x1f1c97(0xff),_0x116c6c,DEPLOY_DIR_NAME,_0x1f1c97(0x10a),_0x297693),_0x5037db);}async function createDeployZip(_0x560f0d){const _0x530d5c=a86_0x4d9cca,_0x5609a1=new adm_zip_1[(_0x530d5c(0xe6))]();return await _0x5609a1[_0x530d5c(0xc5)](path_1['default'][_0x530d5c(0xf0)](process[_0x530d5c(0xdc)](),_0x530d5c(0xff),_0x560f0d,DEPLOY_DIR_NAME)),_0x5609a1;}async function insertZip(_0x12b9b8,_0x382603,_0x488edf,_0x1a67ba,_0x43fd73){const _0x458920=a86_0x4d9cca,_0x1db79a={'ParentId':_0x382603,'Name':'BUILD'+_0x488edf,'Description':_0x458920(0xe5)+_0x1a67ba,'Body':_0x43fd73},{data:_0x4fdccc}=await _0x12b9b8[_0x458920(0xce)](_0x458920(0xb9)+constants_1[_0x458920(0xed)]+_0x458920(0xd5),_0x1db79a);return _0x4fdccc['id'];}