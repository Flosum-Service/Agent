const a86_0x43b1e6=a86_0xdf3f;(function(_0x41b87f,_0xd98fe7){const _0x54c411=a86_0xdf3f,_0x4298db=_0x41b87f();while(!![]){try{const _0x5c80e2=parseInt(_0x54c411(0xae))/0x1+-parseInt(_0x54c411(0xe9))/0x2*(parseInt(_0x54c411(0xab))/0x3)+parseInt(_0x54c411(0xbc))/0x4*(parseInt(_0x54c411(0xca))/0x5)+-parseInt(_0x54c411(0xa5))/0x6*(-parseInt(_0x54c411(0xd6))/0x7)+parseInt(_0x54c411(0xa9))/0x8*(-parseInt(_0x54c411(0xe6))/0x9)+-parseInt(_0x54c411(0xdd))/0xa*(-parseInt(_0x54c411(0xba))/0xb)+parseInt(_0x54c411(0xef))/0xc*(parseInt(_0x54c411(0x100))/0xd);if(_0x5c80e2===_0xd98fe7)break;else _0x4298db['push'](_0x4298db['shift']());}catch(_0x21ab4b){_0x4298db['push'](_0x4298db['shift']());}}}(a86_0xcbe3,0xb1d11));const a86_0x3a6523=(function(){let _0x40e1a8=!![];return function(_0x662bda,_0x1f66de){const _0x3a184b=_0x40e1a8?function(){const _0x472a03=a86_0xdf3f;if(_0x1f66de){const _0x464b4a=_0x1f66de[_0x472a03(0xe5)](_0x662bda,arguments);return _0x1f66de=null,_0x464b4a;}}:function(){};return _0x40e1a8=![],_0x3a184b;};}()),a86_0x159596=a86_0x3a6523(this,function(){const _0x7c8d69=a86_0xdf3f;return a86_0x159596['toString']()['search']('(((.+)+)+)+$')[_0x7c8d69(0xd1)]()[_0x7c8d69(0xf6)](a86_0x159596)[_0x7c8d69(0xb4)](_0x7c8d69(0xd4));});a86_0x159596();function a86_0xdf3f(_0x18c84f,_0x1c6921){const _0x50bc5f=a86_0xcbe3();return a86_0xdf3f=function(_0x159596,_0x3a6523){_0x159596=_0x159596-0xa1;let _0xcbe316=_0x50bc5f[_0x159596];return _0xcbe316;},a86_0xdf3f(_0x18c84f,_0x1c6921);}'use strict';var __importDefault=this&&this[a86_0x43b1e6(0xa1)]||function(_0x188195){const _0x181741=a86_0x43b1e6;return _0x188195&&_0x188195[_0x181741(0xc6)]?_0x188195:{'default':_0x188195};};Object[a86_0x43b1e6(0xf4)](exports,a86_0x43b1e6(0xc6),{'value':!![]}),exports[a86_0x43b1e6(0xbd)]=void 0x0;const constants_1=require(a86_0x43b1e6(0xea)),path_1=__importDefault(require(a86_0x43b1e6(0xc5))),extract_component_permissions_1=require(a86_0x43b1e6(0xb1)),xml2js_1=require(a86_0x43b1e6(0xe8)),zip_1=require(a86_0x43b1e6(0xa2)),mdapi_1=require(a86_0x43b1e6(0xf7)),fs_internal_1=require(a86_0x43b1e6(0xb2)),promises_1=require(a86_0x43b1e6(0xd7)),components_api_1=require(a86_0x43b1e6(0xf1)),adm_zip_1=__importDefault(require(a86_0x43b1e6(0xf5))),uuid_1=require(a86_0x43b1e6(0xf9)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x43b1e6(0xb8),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a86_0x43b1e6(0xda);function a86_0xcbe3(){const _0x1e6f18=['search','Component_Name__c','ComponentsApi','start','destructiveChangesPre.xml','text','2319361RuCYIb','retrieveAttachments','2206940FlBlEM','generateAndDeployZip','splitZip','map','async','after\x20create\x20second\x20zip','src','unzip','removeNamespacePrefix','path','__esModule','package.xml','Name','buildObject','5NobvNE','.temp','UTF-8','body','extractComponentPermissions','substring','MDApiWriter','toString','generateAsync','after\x20create\x20zip','(((.+)+)+)+$','fileName','7ZWPuRd','fs/promises','BUILD','base64','DEPLOYZIP','1.0','SALESFORCE_API_VERSION','20ggKvFJ','Builder','reduce','ParentId','find','join','file','files','apply','2989314xAhpyk','addLocalFolder','xml2js','687094ghtagu','../../../constants','filter','Package','MAX_ZIP_SIZE','fetchComponentsDetailsByComponentsHistory','12ceyoBv','indexOf','../utils/components-api','fileType','PermissionSet','defineProperty','adm-zip','constructor','../../git/parsers/mdapi','orgId','uuid','exists','log','Profile','/sobjects/Attachment','then','type','5359757sHGfDZ','__importDefault','../../git/parsers/utils/zip','every','Body','3750378xYkAfH','Zip','push','values','16oXMdOB','dir','9fWsUXO','keys','writeFile','412481qZWbwV','default','cwd','../utils/extract-component-permissions','../../git/internal/fs.internal','DEFLATE'];a86_0xcbe3=function(){return _0x1e6f18;};return a86_0xcbe3();}async function generateAndDeployZip({attachmentsId:_0x412b91,isExtractComponentsPermissions:_0x41f243,preDestructiveAttachmentId:_0x56aa5f,postDestructiveAttachmentId:_0x4efe21,branchId:_0x145892,credentials:_0x534e7c,metadataLogId:_0x25330a,environments:_0x3c1c0c,metaTypes:_0x3da273},_0x11c1bd){const _0x3df4b1=a86_0x43b1e6,_0x7a142=(0x0,uuid_1['v4'])();try{const _0x38741a=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x11c1bd,_0x412b91),_0x2974c7=_0x38741a[_0x3df4b1(0xdf)]((_0x5ccad0,_0x2bfa25)=>({..._0x5ccad0,[_0x2bfa25['Id']]:_0x2bfa25[_0x3df4b1(0xc8)]}),{}),_0x47b55e=await getComponents(_0x38741a,_0x11c1bd,_0x2974c7),_0x57792b=await components_api_1[_0x3df4b1(0xb6)][_0x3df4b1(0xee)](_0x11c1bd,_0x38741a[_0x3df4b1(0xbf)](({ParentId:_0x10b689})=>_0x10b689))['then'](_0x12c024=>components_api_1[_0x3df4b1(0xb6)][_0x3df4b1(0xc4)](_0x12c024));if(_0x41f243){const _0x585cc5=_0x47b55e[_0x3df4b1(0xeb)](({fileType:_0x5d522a})=>_0x5d522a===_0x3df4b1(0xfc)||_0x5d522a===_0x3df4b1(0xf3));await removePermission(_0x585cc5,_0x57792b);}await replaceEnvironments(_0x3da273,_0x3c1c0c,_0x47b55e),await writeZip(_0x47b55e,_0x7a142),await generateAndWritePackageXML(_0x38741a,_0x57792b,_0x7a142);_0x56aa5f&&await saveDestructiveChanges(_0x11c1bd,_0x56aa5f,DESTRUCTIVE_CHANGES_PER_NAME,_0x7a142);_0x4efe21&&await saveDestructiveChanges(_0x11c1bd,_0x4efe21,DESTRUCTIVE_CHANGES_POST_NAME,_0x7a142);const _0x874aaa=(await createDeployZip(_0x7a142)['then'](_0x222ac0=>{return _0x222ac0;}))['toBuffer']()[_0x3df4b1(0xd1)](_0x3df4b1(0xd9));console['log'](_0x3df4b1(0xd3));const _0x24baa4=_0x874aaa['length'];if(_0x24baa4>=components_api_1[_0x3df4b1(0xed)]){const _0x515680=await createDeployZip(_0x7a142);console[_0x3df4b1(0xfb)](_0x3df4b1(0xc1));const [_0x2b1cf9,_0x50c19c]=await components_api_1[_0x3df4b1(0xb6)][_0x3df4b1(0xbe)](_0x515680,_0x24baa4),_0x26de2f=await insertZip(_0x11c1bd,_0x145892,_0x534e7c['orgId'],_0x25330a,_0x2b1cf9['toBuffer']()[_0x3df4b1(0xd1)]('base64')),_0x359fd7=await insertZip(_0x11c1bd,_0x145892,_0x534e7c[_0x3df4b1(0xf8)],_0x25330a,_0x50c19c['toBuffer']()[_0x3df4b1(0xd1)](_0x3df4b1(0xd9)));return _0x26de2f+','+_0x359fd7;}else return await insertZip(_0x11c1bd,_0x145892,_0x534e7c[_0x3df4b1(0xf8)],_0x25330a,_0x874aaa);}catch(_0x4c3d52){throw _0x4c3d52;}finally{if(await fs_internal_1['FS'][_0x3df4b1(0xfa)](path_1[_0x3df4b1(0xaf)][_0x3df4b1(0xe2)](process[_0x3df4b1(0xb0)](),_0x3df4b1(0xcb),_0x7a142)))await(0x0,promises_1['rm'])(path_1[_0x3df4b1(0xaf)]['join'](process[_0x3df4b1(0xb0)](),_0x3df4b1(0xcb),_0x7a142),{'recursive':!![]});}}exports[a86_0x43b1e6(0xbd)]=generateAndDeployZip;async function getComponents(_0x19ce6c,_0x419c73,_0x34d03e){const _0x80d631=a86_0x43b1e6,_0x4475b3=[],_0x15651b=await(0x0,fetch_attachments_1[_0x80d631(0xbb)])(_0x19ce6c,_0x419c73);return await getComponentFromZip(_0x15651b,_0x34d03e)[_0x80d631(0xfe)](_0x57a677=>{_0x4475b3['push'](..._0x57a677);}),_0x4475b3;}async function getComponentFromZip(_0x28dff,_0x27d5fb){const _0x490972=a86_0x43b1e6,_0xc894b1=[];for(const _0x1d88a0 of _0x28dff){const _0x405bd0=await zip_1[_0x490972(0xa6)][_0x490972(0xc3)](_0x1d88a0['values'][_0x490972(0xa4)]);for(const _0x21668e in _0x405bd0['files']){!_0x405bd0[_0x490972(0xe4)][_0x21668e][_0x490972(0xaa)]&&_0xc894b1[_0x490972(0xa7)]({'fileName':_0x21668e[_0x490972(0xcf)](_0x21668e[_0x490972(0xf0)]('/')+0x1),'fileType':_0x27d5fb[_0x1d88a0['id']],'body':_0x1d88a0[_0x490972(0xa8)]['Body']});}}return _0xc894b1;}async function removePermission(_0x4d8191,_0xd354e8){const _0x418f1a=a86_0x43b1e6;for(const _0x410007 of _0x4d8191){const _0x2f23db=await zip_1['Zip'][_0x418f1a(0xc3)](_0x410007[_0x418f1a(0xcd)]),_0x3834b0=[];for(const _0x460fcd in _0x2f23db[_0x418f1a(0xe4)]){!_0x2f23db[_0x418f1a(0xe4)][_0x460fcd][_0x418f1a(0xaa)]&&_0x3834b0[_0x418f1a(0xa7)]({'fileName':_0x460fcd,'body':await _0x2f23db[_0x418f1a(0xe4)][_0x460fcd]['async'](_0x418f1a(0xb9))});}const _0x256f68=await(0x0,extract_component_permissions_1[_0x418f1a(0xce)])(_0x3834b0[0x0][_0x418f1a(0xcd)][_0x418f1a(0xd1)](),_0xd354e8,_0x410007[_0x418f1a(0xf2)]),_0x2c25b=new xml2js_1[(_0x418f1a(0xde))]({'xmldec':{'version':_0x418f1a(0xdb),'encoding':_0x418f1a(0xcc)}}),_0x4cc9fc=_0x2c25b[_0x418f1a(0xc9)](_0x256f68),_0x12e0e9=zip_1[_0x418f1a(0xa6)]['createZip']();_0x12e0e9[_0x418f1a(0xe3)](_0x3834b0[0x0][_0x418f1a(0xd5)],_0x4cc9fc),_0x410007['body']=await _0x12e0e9['generateAsync']({'type':_0x418f1a(0xd9),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x307670,_0x2500fe,_0x3ae8f9){const _0x4b914d=a86_0x43b1e6;for(const _0x4fdf5f of _0x3ae8f9){if(_0x307670[_0x4b914d(0xa3)](_0x54b374=>_0x54b374!==_0x4fdf5f[_0x4b914d(0xf2)]))continue;const _0x365e25=await zip_1[_0x4b914d(0xa6)]['unzip'](_0x4fdf5f[_0x4b914d(0xcd)]);for(const _0x577ab5 in _0x365e25[_0x4b914d(0xe4)]){if(!_0x365e25[_0x4b914d(0xe4)][_0x577ab5]['dir']){let _0x150b92=await _0x365e25[_0x4b914d(0xe4)][_0x577ab5][_0x4b914d(0xc0)](_0x4b914d(0xb9));for(const _0x158ca0 of Object[_0x4b914d(0xac)](_0x2500fe)){const _0xbaba9a=new RegExp('%%'+_0x158ca0+'%%','g');_0x150b92=_0x150b92['replace'](_0xbaba9a,_0x2500fe[_0x158ca0]);}_0x365e25[_0x4b914d(0xe3)](_0x577ab5,_0x150b92);}}_0x4fdf5f['body']=await _0x365e25[_0x4b914d(0xd2)]({'type':_0x4b914d(0xd9),'compression':_0x4b914d(0xb3),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x1b4a18,_0x441bf3){const _0x32c5aa=a86_0x43b1e6,_0x2832fd=new mdapi_1[(_0x32c5aa(0xd0))]({'components':_0x1b4a18,'sourceDir':path_1['default'][_0x32c5aa(0xe2)](process[_0x32c5aa(0xb0)](),_0x32c5aa(0xcb),_0x441bf3,DEPLOY_DIR_NAME,_0x32c5aa(0xc2)),'skipChildErrors':![]});await _0x2832fd[_0x32c5aa(0xb7)]();}async function generateAndWritePackageXML(_0x1e61af,_0x661e75,_0x47a20b){const _0x2d9954=a86_0x43b1e6,_0x157069=getComponentsTypeAndName(_0x1e61af,_0x661e75),_0x3e72d8=[...new Set(_0x157069[_0x2d9954(0xbf)](_0x2c6e9e=>_0x2c6e9e[_0x2d9954(0xff)]))],_0x5abc12={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1[_0x2d9954(0xdc)][_0x2d9954(0xcf)](0x1)}};for(const _0x5ccde3 of _0x3e72d8){const _0x38a13d=_0x157069[_0x2d9954(0xeb)](_0x9228c1=>_0x9228c1[_0x2d9954(0xff)]===_0x5ccde3)[_0x2d9954(0xbf)](_0x2e5e78=>_0x2e5e78['name']),_0x2ad732={'members':_0x38a13d,'name':_0x5ccde3};_0x5abc12[_0x2d9954(0xec)]['types'][_0x2d9954(0xa7)](_0x2ad732);}const _0x16c936=new xml2js_1[(_0x2d9954(0xde))]({'xmldec':{'version':_0x2d9954(0xdb),'encoding':_0x2d9954(0xcc)}}),_0x10418d=_0x16c936[_0x2d9954(0xc9)](_0x5abc12);await fs_internal_1['FS'][_0x2d9954(0xad)](path_1[_0x2d9954(0xaf)]['join'](process[_0x2d9954(0xb0)](),_0x2d9954(0xcb),_0x47a20b,DEPLOY_DIR_NAME,_0x2d9954(0xc2),_0x2d9954(0xc7)),_0x10418d);}function getComponentsTypeAndName(_0xcea543,_0x415b5a){const _0xb78f6f=a86_0x43b1e6;return _0xcea543[_0xb78f6f(0xdf)]((_0x55f54d,_0x3f2b06)=>{const _0x239b7a=_0xb78f6f,_0x152720=_0x415b5a[_0x239b7a(0xe1)](_0x3de07c=>_0x3de07c['Id']===_0x3f2b06[_0x239b7a(0xe0)]);return _0x152720&&_0x55f54d[_0x239b7a(0xa7)]({'name':_0x152720['Component__r'][_0x239b7a(0xb5)],'type':_0x3f2b06['Name']}),_0x55f54d;},[]);}async function saveDestructiveChanges(_0xa4279e,_0x20fe4f,_0x20312a,_0x210ef5){const _0x2adc4f=a86_0x43b1e6,_0x3be6a8=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0xa4279e,_0x20fe4f))[_0x2adc4f(0xd1)]();await fs_internal_1['FS'][_0x2adc4f(0xad)](path_1['default'][_0x2adc4f(0xe2)](process['cwd'](),_0x2adc4f(0xcb),_0x210ef5,DEPLOY_DIR_NAME,_0x2adc4f(0xc2),_0x20312a),_0x3be6a8);}async function createDeployZip(_0x63441b){const _0x5c71c3=a86_0x43b1e6,_0x2582b0=new adm_zip_1['default']();return await _0x2582b0[_0x5c71c3(0xe7)](path_1[_0x5c71c3(0xaf)][_0x5c71c3(0xe2)](process[_0x5c71c3(0xb0)](),_0x5c71c3(0xcb),_0x63441b,DEPLOY_DIR_NAME)),_0x2582b0;}async function insertZip(_0x49bd0f,_0x546eb4,_0x41c83f,_0x1eb188,_0x205028){const _0x5899e0=a86_0x43b1e6,_0x3307ee={'ParentId':_0x546eb4,'Name':_0x5899e0(0xd8)+_0x41c83f,'Description':_0x5899e0(0xd8)+_0x1eb188,'Body':_0x205028},{data:_0x577f0c}=await _0x49bd0f['post']('/services/data/'+constants_1['SALESFORCE_API_VERSION']+_0x5899e0(0xfd),_0x3307ee);return _0x577f0c['id'];}