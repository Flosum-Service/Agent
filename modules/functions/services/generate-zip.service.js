const a86_0x42217f=a86_0x2aca;(function(_0xd07afd,_0x3d1f43){const _0x548bf9=a86_0x2aca,_0x2efde5=_0xd07afd();while(!![]){try{const _0x528f95=-parseInt(_0x548bf9(0x16d))/0x1+parseInt(_0x548bf9(0x13f))/0x2+parseInt(_0x548bf9(0x17a))/0x3+parseInt(_0x548bf9(0x192))/0x4*(-parseInt(_0x548bf9(0x19b))/0x5)+-parseInt(_0x548bf9(0x184))/0x6+-parseInt(_0x548bf9(0x170))/0x7+parseInt(_0x548bf9(0x186))/0x8*(parseInt(_0x548bf9(0x150))/0x9);if(_0x528f95===_0x3d1f43)break;else _0x2efde5['push'](_0x2efde5['shift']());}catch(_0x50202a){_0x2efde5['push'](_0x2efde5['shift']());}}}(a86_0xf443,0xa4e55));const a86_0x1e7e8a=(function(){let _0x32a3fe=!![];return function(_0x28957a,_0x48028a){const _0x6e2b8b=_0x32a3fe?function(){const _0x526ac4=a86_0x2aca;if(_0x48028a){const _0x31e69e=_0x48028a[_0x526ac4(0x190)](_0x28957a,arguments);return _0x48028a=null,_0x31e69e;}}:function(){};return _0x32a3fe=![],_0x6e2b8b;};}()),a86_0x4b11e7=a86_0x1e7e8a(this,function(){const _0x59b837=a86_0x2aca;return a86_0x4b11e7['toString']()[_0x59b837(0x155)](_0x59b837(0x141))['toString']()[_0x59b837(0x183)](a86_0x4b11e7)[_0x59b837(0x155)](_0x59b837(0x141));});a86_0x4b11e7();'use strict';var __importDefault=this&&this[a86_0x42217f(0x188)]||function(_0x19efbf){const _0x4f3495=a86_0x42217f;return _0x19efbf&&_0x19efbf[_0x4f3495(0x163)]?_0x19efbf:{'default':_0x19efbf};};Object[a86_0x42217f(0x146)](exports,a86_0x42217f(0x163),{'value':!![]}),exports[a86_0x42217f(0x18f)]=void 0x0;const path_1=__importDefault(require(a86_0x42217f(0x166))),extract_component_permissions_1=require(a86_0x42217f(0x198)),xml2js_1=require(a86_0x42217f(0x174)),zip_1=require(a86_0x42217f(0x18a)),mdapi_1=require(a86_0x42217f(0x187)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a86_0x42217f(0x145)),components_api_1=require(a86_0x42217f(0x185)),adm_zip_1=__importDefault(require(a86_0x42217f(0x17e))),uuid_1=require('uuid'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a86_0x42217f(0x199)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x42217f(0x18b),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x42217f(0x173),DEPLOY_DIR_NAME=a86_0x42217f(0x165);function a86_0xf443(){const _0x429728=['MetadataConstants','length','Builder','UTF-8','files','Name','1096628GuYmpj','FOLDER_TO_METADATA_TYPE_MAP','fetchComponentsDetailsByComponentsHistory','7406574EkcEBT','fileName','map','destructiveChangesPost.xml','xml2js','fileType','post','Profile','/services/data/v','orgId','1970217uUGmvn','values','toBuffer','generateAsync','adm-zip','splitZip','src','substring','indexOf','constructor','3292368VfhOiz','../utils/components-api','454840OXXfNs','../../git/parsers/mdapi','__importDefault','filter','../../git/parsers/utils/zip','destructiveChangesPre.xml','async','types','MDApiWriter','generateAndDeployZip','apply','BUILD','8feqkOu','addLocalFolder','1.0','Component_Name__c','dir','Component__r','../utils/extract-component-permissions','@flosum/salesforce','start','3036695PXkWQA','ComponentsApi','Zip','1846950vPTkyY','type','(((.+)+)+)+$','then','replace','toString','fs/promises','defineProperty','package.xml','body','file','unzip','MAX_ZIP_SIZE','find','fetchAttachmentBody','buildObject','default','477nKVhGO','every','text','PermissionSet','/sobjects/Attachment','search','cwd','fetchAttachmentsDetailsById','base64','push','reduce','join','removeNamespacePrefix','writeFile','DEFLATE','ParentId','createZip','Body','.temp','__esModule','exists','DEPLOYZIP','path'];a86_0xf443=function(){return _0x429728;};return a86_0xf443();}async function generateAndDeployZip({attachmentsId:_0x48a96b,isExtractComponentsPermissions:_0x57427c,preDestructiveAttachmentId:_0x571fc8,postDestructiveAttachmentId:_0x237b8e,branchId:_0x228440,credentials:_0xe606e4,metadataLogId:_0x3911c3,environments:_0x5f0d34,metaTypes:_0x1b749d,apiVersion:_0x131398},_0x543b94){const _0x552ee8=a86_0x42217f,_0x1e0a2a=(0x0,uuid_1['v4'])();try{const _0x26ab50=await(0x0,fetch_attachments_1[_0x552ee8(0x157)])(_0x543b94,_0x48a96b),_0x230722=_0x26ab50[_0x552ee8(0x15a)]((_0x4f1def,_0x5945c3)=>({..._0x4f1def,[_0x5945c3['Id']]:_0x5945c3[_0x552ee8(0x16c)]}),{}),_0x1d4125=await getComponents(_0x26ab50,_0x543b94,_0x230722),_0x330f03=await components_api_1[_0x552ee8(0x19c)][_0x552ee8(0x16f)](_0x543b94,_0x26ab50[_0x552ee8(0x172)](({ParentId:_0x4e3822})=>_0x4e3822),_0x131398)[_0x552ee8(0x142)](_0x5367f6=>components_api_1[_0x552ee8(0x19c)][_0x552ee8(0x15c)](_0x5367f6));if(_0x57427c){const _0x56b259=_0x1d4125[_0x552ee8(0x189)](({fileType:_0x17bcfe})=>_0x17bcfe===_0x552ee8(0x177)||_0x17bcfe===_0x552ee8(0x153));await removePermission(_0x56b259,_0x330f03);}await replaceEnvironments(_0x1b749d,_0x5f0d34,_0x1d4125),await writeZip(_0x1d4125,_0x1e0a2a),await generateAndWritePackageXML(_0x26ab50,_0x330f03,_0x1e0a2a,_0x131398);_0x571fc8&&await saveDestructiveChanges(_0x543b94,_0x571fc8,DESTRUCTIVE_CHANGES_PER_NAME,_0x1e0a2a);_0x237b8e&&await saveDestructiveChanges(_0x543b94,_0x237b8e,DESTRUCTIVE_CHANGES_POST_NAME,_0x1e0a2a);const _0x17a19d=(await createDeployZip(_0x1e0a2a)[_0x552ee8(0x142)](_0x12b21c=>{return _0x12b21c;}))[_0x552ee8(0x17c)]()[_0x552ee8(0x144)](_0x552ee8(0x158)),_0x587e06=_0x17a19d[_0x552ee8(0x168)];if(_0x587e06>=components_api_1[_0x552ee8(0x14b)]){const _0x21a4d1=await createDeployZip(_0x1e0a2a),[_0x3ab0e3,_0x3d05b6]=await components_api_1[_0x552ee8(0x19c)][_0x552ee8(0x17f)](_0x21a4d1,_0x587e06),_0x5976bc=await insertZip(_0x543b94,_0x228440,_0xe606e4[_0x552ee8(0x179)],_0x3911c3,_0x3ab0e3[_0x552ee8(0x17c)]()[_0x552ee8(0x144)](_0x552ee8(0x158)),_0x131398),_0x409ba4=await insertZip(_0x543b94,_0x228440,_0xe606e4[_0x552ee8(0x179)],_0x3911c3,_0x3d05b6['toBuffer']()[_0x552ee8(0x144)](_0x552ee8(0x158)),_0x131398);return _0x5976bc+','+_0x409ba4;}else return await insertZip(_0x543b94,_0x228440,_0xe606e4[_0x552ee8(0x179)],_0x3911c3,_0x17a19d,_0x131398);}catch(_0x282315){throw _0x282315;}finally{if(await fs_internal_1['FS'][_0x552ee8(0x164)](path_1['default']['join'](process['cwd'](),_0x552ee8(0x162),_0x1e0a2a)))await(0x0,promises_1['rm'])(path_1[_0x552ee8(0x14f)][_0x552ee8(0x15b)](process['cwd'](),_0x552ee8(0x162),_0x1e0a2a),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x7aea7d,_0x5777b0,_0x534ed2){const _0x2eb12e=a86_0x42217f,_0x1b1a32=[],_0x3913d2=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x7aea7d,_0x5777b0);return await getComponentFromZip(_0x3913d2,_0x534ed2)[_0x2eb12e(0x142)](_0x48fc2f=>{const _0x4bc553=_0x2eb12e;_0x1b1a32[_0x4bc553(0x159)](..._0x48fc2f);}),_0x1b1a32;}async function getComponentFromZip(_0x16a14f,_0x595e7d){const _0x2a670e=a86_0x42217f,_0x40ea2f=[];for(const _0x3a8b49 of _0x16a14f){const _0x550336=await zip_1['Zip'][_0x2a670e(0x14a)](_0x3a8b49[_0x2a670e(0x17b)]['Body']);for(const _0x32afee in _0x550336[_0x2a670e(0x16b)]){!_0x550336[_0x2a670e(0x16b)][_0x32afee]['dir']&&_0x40ea2f[_0x2a670e(0x159)]({'fileName':_0x32afee[_0x2a670e(0x181)](_0x32afee[_0x2a670e(0x182)]('/')+0x1),'fileType':_0x595e7d[_0x3a8b49['id']],'body':_0x3a8b49[_0x2a670e(0x17b)][_0x2a670e(0x161)]});}}return _0x40ea2f;}async function removePermission(_0x545667,_0x34b6ae){const _0x27fad2=a86_0x42217f;for(const _0x411f01 of _0x545667){const _0x7c8e58=await zip_1['Zip'][_0x27fad2(0x14a)](_0x411f01['body']),_0x15407d=[];for(const _0x1f822d in _0x7c8e58[_0x27fad2(0x16b)]){!_0x7c8e58[_0x27fad2(0x16b)][_0x1f822d]['dir']&&_0x15407d['push']({'fileName':_0x1f822d,'body':await _0x7c8e58[_0x27fad2(0x16b)][_0x1f822d][_0x27fad2(0x18c)](_0x27fad2(0x152))});}const _0x182f0d=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x15407d[0x0][_0x27fad2(0x148)][_0x27fad2(0x144)](),_0x34b6ae,_0x411f01[_0x27fad2(0x175)]),_0x11372f=new xml2js_1[(_0x27fad2(0x169))]({'xmldec':{'version':_0x27fad2(0x194),'encoding':_0x27fad2(0x16a)}}),_0x1a7f48=_0x11372f[_0x27fad2(0x14e)](_0x182f0d),_0x3a9b4f=zip_1[_0x27fad2(0x19d)][_0x27fad2(0x160)]();_0x3a9b4f[_0x27fad2(0x149)](_0x15407d[0x0][_0x27fad2(0x171)],_0x1a7f48),_0x411f01[_0x27fad2(0x148)]=await _0x3a9b4f[_0x27fad2(0x17d)]({'type':_0x27fad2(0x158),'compression':_0x27fad2(0x15e),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x8c2953,_0x4a6692,_0x4276e5){const _0x311de8=a86_0x42217f;for(const _0x55d677 of _0x4276e5){if(_0x8c2953[_0x311de8(0x151)](_0x556095=>_0x556095!==_0x55d677[_0x311de8(0x175)]))continue;const _0x5a2f5e=await zip_1['Zip'][_0x311de8(0x14a)](_0x55d677[_0x311de8(0x148)]);for(const _0x5623c0 in _0x5a2f5e[_0x311de8(0x16b)]){if(!_0x5a2f5e[_0x311de8(0x16b)][_0x5623c0][_0x311de8(0x196)]){let _0x204f56=await _0x5a2f5e[_0x311de8(0x16b)][_0x5623c0][_0x311de8(0x18c)](_0x311de8(0x152));for(const _0x545843 of Object['keys'](_0x4a6692)){const _0x5269d3=new RegExp('%%'+_0x545843+'%%','g');_0x204f56=_0x204f56[_0x311de8(0x143)](_0x5269d3,_0x4a6692[_0x545843]);}_0x5a2f5e[_0x311de8(0x149)](_0x5623c0,_0x204f56);}}_0x55d677[_0x311de8(0x148)]=await _0x5a2f5e['generateAsync']({'type':_0x311de8(0x158),'compression':_0x311de8(0x15e),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x5d16a8,_0x3cf1b4){const _0x26aa69=a86_0x42217f,_0x3d0e3a=new mdapi_1[(_0x26aa69(0x18e))]({'components':_0x5d16a8,'sourceDir':path_1[_0x26aa69(0x14f)]['join'](process[_0x26aa69(0x156)](),_0x26aa69(0x162),_0x3cf1b4,DEPLOY_DIR_NAME,_0x26aa69(0x180)),'skipChildErrors':![]});await _0x3d0e3a[_0x26aa69(0x19a)]();}function a86_0x2aca(_0x479eee,_0x48cc17){const _0x418d44=a86_0xf443();return a86_0x2aca=function(_0x4b11e7,_0x1e7e8a){_0x4b11e7=_0x4b11e7-0x13f;let _0xf443e3=_0x418d44[_0x4b11e7];return _0xf443e3;},a86_0x2aca(_0x479eee,_0x48cc17);}async function generateAndWritePackageXML(_0x43b6d0,_0x869f00,_0x1d62f9,_0x342007){const _0x5a5080=a86_0x42217f,_0x10da95=getComponentsTypeAndName(_0x43b6d0,_0x869f00),_0x49aef6=[...new Set(_0x10da95['map'](_0x9ed0ad=>_0x9ed0ad[_0x5a5080(0x140)]))],_0x23456f={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x342007}};for(const _0x43addc of _0x49aef6){const _0x3a9ee9=_0x10da95['filter'](_0x3a5db2=>_0x3a5db2['type']===_0x43addc)[_0x5a5080(0x172)](_0x521acf=>_0x521acf['name']),_0x6800d2={'members':_0x3a9ee9,'name':_0x43addc};_0x23456f['Package'][_0x5a5080(0x18d)][_0x5a5080(0x159)](_0x6800d2);}const _0x4d9a80=new xml2js_1[(_0x5a5080(0x169))]({'xmldec':{'version':_0x5a5080(0x194),'encoding':_0x5a5080(0x16a)}}),_0x1cd9b2=_0x4d9a80[_0x5a5080(0x14e)](_0x23456f);await fs_internal_1['FS'][_0x5a5080(0x15d)](path_1[_0x5a5080(0x14f)][_0x5a5080(0x15b)](process['cwd'](),_0x5a5080(0x162),_0x1d62f9,DEPLOY_DIR_NAME,'src',_0x5a5080(0x147)),_0x1cd9b2);}function getComponentsTypeAndName(_0x3fd72d,_0x5ec427){return _0x3fd72d['reduce']((_0x2c1247,_0x179cb0)=>{const _0x6662b7=a86_0x2aca,_0x92ddf1=_0x5ec427[_0x6662b7(0x14c)](_0x2be536=>_0x2be536['Id']===_0x179cb0[_0x6662b7(0x15f)]);return _0x92ddf1&&_0x2c1247['push']({'name':_0x92ddf1[_0x6662b7(0x197)][_0x6662b7(0x195)],'type':salesforce_1[_0x6662b7(0x167)][_0x6662b7(0x16e)][_0x179cb0[_0x6662b7(0x16c)]]||_0x179cb0[_0x6662b7(0x16c)]}),_0x2c1247;},[]);}async function saveDestructiveChanges(_0xfe42a6,_0x447d80,_0x58ed33,_0x30cfa2){const _0x2c8f42=a86_0x42217f,_0x939033=(await(0x0,fetch_attachments_1[_0x2c8f42(0x14d)])(_0xfe42a6,_0x447d80))['toString']();await fs_internal_1['FS']['writeFile'](path_1[_0x2c8f42(0x14f)][_0x2c8f42(0x15b)](process[_0x2c8f42(0x156)](),_0x2c8f42(0x162),_0x30cfa2,DEPLOY_DIR_NAME,_0x2c8f42(0x180),_0x58ed33),_0x939033);}async function createDeployZip(_0x2be1cf){const _0x172506=a86_0x42217f,_0x2fc06e=new adm_zip_1[(_0x172506(0x14f))]();return await _0x2fc06e[_0x172506(0x193)](path_1['default'][_0x172506(0x15b)](process[_0x172506(0x156)](),_0x172506(0x162),_0x2be1cf,DEPLOY_DIR_NAME)),_0x2fc06e;}async function insertZip(_0x3a6687,_0x5e7d51,_0x1e7466,_0x5354ed,_0x467940,_0x378062){const _0x215958=a86_0x42217f,_0x23f15a={'ParentId':_0x5e7d51,'Name':_0x215958(0x191)+_0x1e7466,'Description':_0x215958(0x191)+_0x5354ed,'Body':_0x467940},{data:_0x83094f}=await _0x3a6687[_0x215958(0x176)](_0x215958(0x178)+_0x378062+_0x215958(0x154),_0x23f15a);return _0x83094f['id'];}