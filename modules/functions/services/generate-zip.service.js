const a54_0xccfd3c=a54_0x3759;(function(_0x3ee09c,_0x483488){const _0x325666=a54_0x3759,_0x440b92=_0x3ee09c();while(!![]){try{const _0x143c40=parseInt(_0x325666(0xc6))/0x1*(parseInt(_0x325666(0x9e))/0x2)+parseInt(_0x325666(0xa9))/0x3*(parseInt(_0x325666(0xae))/0x4)+-parseInt(_0x325666(0xbf))/0x5*(-parseInt(_0x325666(0xd3))/0x6)+-parseInt(_0x325666(0xfc))/0x7*(-parseInt(_0x325666(0xce))/0x8)+parseInt(_0x325666(0xb8))/0x9*(-parseInt(_0x325666(0xcb))/0xa)+-parseInt(_0x325666(0xe4))/0xb+-parseInt(_0x325666(0xa7))/0xc*(parseInt(_0x325666(0xbb))/0xd);if(_0x143c40===_0x483488)break;else _0x440b92['push'](_0x440b92['shift']());}catch(_0x4ab0f2){_0x440b92['push'](_0x440b92['shift']());}}}(a54_0x2bd1,0xd641e));const a54_0x3075af=(function(){let _0x2a0a2a=!![];return function(_0x4a525d,_0xdab75c){const _0x5d39fa=_0x2a0a2a?function(){const _0x42c711=a54_0x3759;if(_0xdab75c){const _0x5d2bdc=_0xdab75c[_0x42c711(0xbd)](_0x4a525d,arguments);return _0xdab75c=null,_0x5d2bdc;}}:function(){};return _0x2a0a2a=![],_0x5d39fa;};}()),a54_0x37c71f=a54_0x3075af(this,function(){const _0x332564=a54_0x3759;return a54_0x37c71f[_0x332564(0xf5)]()['search'](_0x332564(0xb1))['toString']()[_0x332564(0xd5)](a54_0x37c71f)[_0x332564(0xee)](_0x332564(0xb1));});a54_0x37c71f();'use strict';var __importDefault=this&&this[a54_0xccfd3c(0xcd)]||function(_0x9c9009){const _0x31f408=a54_0xccfd3c;return _0x9c9009&&_0x9c9009[_0x31f408(0xe2)]?_0x9c9009:{'default':_0x9c9009};};function a54_0x3759(_0x354634,_0x12d8b3){const _0x3b9316=a54_0x2bd1();return a54_0x3759=function(_0x37c71f,_0x3075af){_0x37c71f=_0x37c71f-0x9e;let _0x2bd176=_0x3b9316[_0x37c71f];return _0x2bd176;},a54_0x3759(_0x354634,_0x12d8b3);}Object[a54_0xccfd3c(0xb6)](exports,a54_0xccfd3c(0xe2),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require(a54_0xccfd3c(0xbe)),path_1=__importDefault(require('path')),extract_component_permissions_1=require(a54_0xccfd3c(0xe5)),xml2js_1=require(a54_0xccfd3c(0xad)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require(a54_0xccfd3c(0xc0)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a54_0xccfd3c(0xc7)),components_api_1=require(a54_0xccfd3c(0xf3)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a54_0xccfd3c(0xe8)),DESTRUCTIVE_CHANGES_PER_NAME=a54_0xccfd3c(0xa0),DESTRUCTIVE_CHANGES_POST_NAME=a54_0xccfd3c(0xdd),DEPLOY_DIR_NAME=a54_0xccfd3c(0xe0);async function generateAndDeployZip({attachmentsId:_0x2b8825,isExtractComponentsPermissions:_0xd29f05,preDestructiveAttachmentId:_0x3e1a07,postDestructiveAttachmentId:_0x42eb9d,branchId:_0x5dbd98,credentials:_0x5538d8,metadataLogId:_0x3c621b,environments:_0x5424c4,metaTypes:_0x44e44f},_0x5ccdc8){const _0x221e39=a54_0xccfd3c,_0x4f6c59=(0x0,uuid_1['v4'])();try{const _0x1d6198=await components_api_1[_0x221e39(0xcc)][_0x221e39(0xba)](_0x5ccdc8,_0x2b8825),_0x3cea80=_0x1d6198['reduce']((_0x4f42ff,_0x61fd79)=>({..._0x4f42ff,[_0x61fd79['Id']]:_0x61fd79[_0x221e39(0xd7)]}),{}),_0x20b20f=await getComponents(_0x1d6198,_0x5ccdc8,_0x3cea80),_0x551f79=await components_api_1[_0x221e39(0xcc)][_0x221e39(0xab)](_0x5ccdc8,_0x1d6198[_0x221e39(0xeb)](({ParentId:_0x579b09})=>_0x579b09))['then'](_0x483c6d=>components_api_1[_0x221e39(0xcc)][_0x221e39(0xdb)](_0x483c6d));if(_0xd29f05){const _0xca0c13=_0x20b20f[_0x221e39(0xf2)](({fileType:_0x395404})=>_0x395404===_0x221e39(0xbc)||_0x395404===_0x221e39(0xa5));await removePermission(_0xca0c13,_0x551f79);}await replaceEnvironments(_0x44e44f,_0x5424c4,_0x20b20f),await writeZip(_0x20b20f,_0x4f6c59),await generateAndWritePackageXML(_0x1d6198,_0x551f79,_0x4f6c59);_0x3e1a07&&await saveDestructiveChanges(_0x5ccdc8,_0x3e1a07,DESTRUCTIVE_CHANGES_PER_NAME,_0x4f6c59);_0x42eb9d&&await saveDestructiveChanges(_0x5ccdc8,_0x42eb9d,DESTRUCTIVE_CHANGES_POST_NAME,_0x4f6c59);const _0x1d2b35=(await createDeployZip(_0x4f6c59)[_0x221e39(0xb4)](_0x18623f=>{return _0x18623f;}))[_0x221e39(0xf6)]()[_0x221e39(0xf5)](_0x221e39(0xa2));console[_0x221e39(0xca)](_0x221e39(0x9f));const _0x3ac0c6=_0x1d2b35[_0x221e39(0xc3)];if(_0x3ac0c6>=components_api_1[_0x221e39(0xd8)]){const _0x276a96=await createDeployZip(_0x4f6c59);console['log'](_0x221e39(0xa4));const [_0x297d84,_0x49c7d9]=await components_api_1[_0x221e39(0xcc)][_0x221e39(0xd2)](_0x276a96,_0x3ac0c6),_0x51004d=await insertZip(_0x5ccdc8,_0x5dbd98,_0x5538d8[_0x221e39(0xed)],_0x3c621b,_0x297d84[_0x221e39(0xf6)]()[_0x221e39(0xf5)](_0x221e39(0xa2))),_0x104a6d=await insertZip(_0x5ccdc8,_0x5dbd98,_0x5538d8[_0x221e39(0xed)],_0x3c621b,_0x49c7d9[_0x221e39(0xf6)]()[_0x221e39(0xf5)]('base64'));return _0x51004d+','+_0x104a6d;}else return await insertZip(_0x5ccdc8,_0x5dbd98,_0x5538d8[_0x221e39(0xed)],_0x3c621b,_0x1d2b35);}catch(_0x1b5ec1){throw _0x1b5ec1;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x221e39(0xd6)][_0x221e39(0xd1)](process[_0x221e39(0xec)](),'.temp',_0x4f6c59)))await(0x0,promises_1['rm'])(path_1[_0x221e39(0xd6)]['join'](process[_0x221e39(0xec)](),_0x221e39(0xf7),_0x4f6c59),{'recursive':!![]});}}function a54_0x2bd1(){const _0x6b11b=['.temp','body','src','unzip','keys','2076767dDszNY','878AiuePx','after\x20create\x20zip','destructiveChangesPre.xml','UTF-8','base64','Zip','after\x20create\x20second\x20zip','PermissionSet','MDApiWriter','12aiXCgk','BUILD','4094457zoYBbw','post','fetchComponentsDetailsByComponentsHistory','text','xml2js','4oCsqQI','createZip','find','(((.+)+)+)+$','name','ParentId','then','retrieveAttachments','defineProperty','start','486sDAYvE','substring','fetchAttachmentsDetails','19750718WtZPfL','Profile','apply','../../../constants','189490zDufJt','../../git/parsers/mdapi','fileType','file','length','1.0','buildObject','368naJRel','fs/promises','/sobjects/Attachment','extractComponentPermissions','log','123710UWtsRv','ComponentsApi','__importDefault','40oZTRWZ','type','http://soap.sforce.com/2006/04/metadata','join','splitZip','12gvaXQx','indexOf','constructor','default','Name','MAX_ZIP_SIZE','DEFLATE','dir','removeNamespacePrefix','replace','destructiveChangesPost.xml','/services/data/','SALESFORCE_API_VERSION','DEPLOYZIP','files','__esModule','every','227194MWYmtd','../utils/extract-component-permissions','Body','async','uuid','addLocalFolder','push','map','cwd','orgId','search','generateAndDeployZip','Builder','values','filter','../utils/components-api','fileName','toString','toBuffer'];a54_0x2bd1=function(){return _0x6b11b;};return a54_0x2bd1();}exports[a54_0xccfd3c(0xef)]=generateAndDeployZip;async function getComponents(_0x190a07,_0x42208b,_0x2939fc){const _0x2b8275=a54_0xccfd3c,_0x175499=[],_0x3ce843=await components_api_1[_0x2b8275(0xcc)][_0x2b8275(0xb5)](_0x190a07,_0x42208b);return await getComponentFromZip(_0x3ce843,_0x2939fc)[_0x2b8275(0xb4)](_0x5c9648=>{_0x175499['push'](..._0x5c9648);}),_0x175499;}async function getComponentFromZip(_0x1dc3d4,_0x14dd02){const _0x251c20=a54_0xccfd3c,_0x20f9da=[];for(const _0x39afad of _0x1dc3d4){const _0x2611fd=await zip_1[_0x251c20(0xa3)]['unzip'](_0x39afad[_0x251c20(0xf1)][_0x251c20(0xe6)]);for(const _0x10d9be in _0x2611fd[_0x251c20(0xe1)]){!_0x2611fd[_0x251c20(0xe1)][_0x10d9be][_0x251c20(0xda)]&&_0x20f9da[_0x251c20(0xea)]({'fileName':_0x10d9be[_0x251c20(0xb9)](_0x10d9be[_0x251c20(0xd4)]('/')+0x1),'fileType':_0x14dd02[_0x39afad['id']],'body':_0x39afad[_0x251c20(0xf1)][_0x251c20(0xe6)]});}}return _0x20f9da;}async function removePermission(_0x43436e,_0xaf1a3f){const _0x105601=a54_0xccfd3c;for(const _0x2758ba of _0x43436e){const _0x57f873=await zip_1[_0x105601(0xa3)][_0x105601(0xfa)](_0x2758ba['body']),_0x2ed012=[];for(const _0x58de97 in _0x57f873['files']){!_0x57f873[_0x105601(0xe1)][_0x58de97][_0x105601(0xda)]&&_0x2ed012['push']({'fileName':_0x58de97,'body':await _0x57f873[_0x105601(0xe1)][_0x58de97][_0x105601(0xe7)](_0x105601(0xac))});}const _0x126978=await(0x0,extract_component_permissions_1[_0x105601(0xc9)])(_0x2ed012[0x0][_0x105601(0xf8)][_0x105601(0xf5)](),_0xaf1a3f,_0x2758ba[_0x105601(0xc1)]),_0xcecb05=new xml2js_1[(_0x105601(0xf0))]({'xmldec':{'version':_0x105601(0xc4),'encoding':_0x105601(0xa1)}}),_0x31e118=_0xcecb05[_0x105601(0xc5)](_0x126978),_0x21410e=zip_1[_0x105601(0xa3)][_0x105601(0xaf)]();_0x21410e[_0x105601(0xc2)](_0x2ed012[0x0][_0x105601(0xf4)],_0x31e118),_0x2758ba[_0x105601(0xf8)]=await _0x21410e['generateAsync']({'type':'base64','compression':_0x105601(0xd9),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x1d6056,_0x43450b,_0x454395){const _0x1e1aee=a54_0xccfd3c;for(const _0x4255d4 of _0x454395){if(_0x1d6056[_0x1e1aee(0xe3)](_0x51860d=>_0x51860d!==_0x4255d4[_0x1e1aee(0xc1)]))continue;const _0x19b6ca=await zip_1[_0x1e1aee(0xa3)][_0x1e1aee(0xfa)](_0x4255d4['body']);for(const _0x531c68 in _0x19b6ca[_0x1e1aee(0xe1)]){if(!_0x19b6ca['files'][_0x531c68]['dir']){let _0x62e4af=await _0x19b6ca[_0x1e1aee(0xe1)][_0x531c68]['async'](_0x1e1aee(0xac));for(const _0x1a37cd of Object[_0x1e1aee(0xfb)](_0x43450b)){const _0x51c8ac=new RegExp('%%'+_0x1a37cd+'%%','g');_0x62e4af=_0x62e4af[_0x1e1aee(0xdc)](_0x51c8ac,_0x43450b[_0x1a37cd]);}_0x19b6ca[_0x1e1aee(0xc2)](_0x531c68,_0x62e4af);}}_0x4255d4[_0x1e1aee(0xf8)]=await _0x19b6ca['generateAsync']({'type':'base64','compression':_0x1e1aee(0xd9),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x4d2f13,_0x1efc36){const _0x2d6f8c=a54_0xccfd3c,_0x44c065=new mdapi_1[(_0x2d6f8c(0xa6))]({'components':_0x4d2f13,'sourceDir':path_1[_0x2d6f8c(0xd6)][_0x2d6f8c(0xd1)](process[_0x2d6f8c(0xec)](),'.temp',_0x1efc36,DEPLOY_DIR_NAME,_0x2d6f8c(0xf9)),'skipChildErrors':![]});await _0x44c065[_0x2d6f8c(0xb7)]();}async function generateAndWritePackageXML(_0x63b04d,_0x385c42,_0x163895){const _0x4f2880=a54_0xccfd3c,_0x4f044c=getComponentsTypeAndName(_0x63b04d,_0x385c42),_0x414fae=[...new Set(_0x4f044c[_0x4f2880(0xeb)](_0x52cb42=>_0x52cb42[_0x4f2880(0xcf)]))],_0x38b7a0={'Package':{'$':{'xmlns':_0x4f2880(0xd0)},'types':[],'version':''+constants_1[_0x4f2880(0xdf)]['substring'](0x1)}};for(const _0xb2443c of _0x414fae){const _0x30b117=_0x4f044c['filter'](_0x169d83=>_0x169d83[_0x4f2880(0xcf)]===_0xb2443c)['map'](_0x22a8bc=>_0x22a8bc[_0x4f2880(0xb2)]),_0x1c67f7={'members':_0x30b117,'name':_0xb2443c};_0x38b7a0['Package']['types'][_0x4f2880(0xea)](_0x1c67f7);}const _0x38ca69=new xml2js_1['Builder']({'xmldec':{'version':_0x4f2880(0xc4),'encoding':_0x4f2880(0xa1)}}),_0x5d3348=_0x38ca69[_0x4f2880(0xc5)](_0x38b7a0);await fs_internal_1['FS']['writeFile'](path_1[_0x4f2880(0xd6)][_0x4f2880(0xd1)](process[_0x4f2880(0xec)](),_0x4f2880(0xf7),_0x163895,DEPLOY_DIR_NAME,'src','package.xml'),_0x5d3348);}function getComponentsTypeAndName(_0x36bb6e,_0x4f270e){return _0x36bb6e['reduce']((_0x26574e,_0x3fbc8a)=>{const _0x4792de=a54_0x3759,_0x3354e6=_0x4f270e[_0x4792de(0xb0)](_0x2e1145=>_0x2e1145['Id']===_0x3fbc8a[_0x4792de(0xb3)]);return _0x3354e6&&_0x26574e[_0x4792de(0xea)]({'name':_0x3354e6['Component__r']['Component_Name__c'],'type':_0x3fbc8a['Name']}),_0x26574e;},[]);}async function saveDestructiveChanges(_0x1d098c,_0x59985b,_0x1527c7,_0x537304){const _0x4f7c4f=a54_0xccfd3c,_0x28d2fd=(await components_api_1['ComponentsApi']['fetchAttachmentBody'](_0x1d098c,_0x59985b))[_0x4f7c4f(0xf5)]();await fs_internal_1['FS']['writeFile'](path_1[_0x4f7c4f(0xd6)]['join'](process[_0x4f7c4f(0xec)](),_0x4f7c4f(0xf7),_0x537304,DEPLOY_DIR_NAME,_0x4f7c4f(0xf9),_0x1527c7),_0x28d2fd);}async function createDeployZip(_0x2064d6){const _0x2ec750=a54_0xccfd3c,_0x4543a1=new adm_zip_1[(_0x2ec750(0xd6))]();return await _0x4543a1[_0x2ec750(0xe9)](path_1[_0x2ec750(0xd6)][_0x2ec750(0xd1)](process[_0x2ec750(0xec)](),_0x2ec750(0xf7),_0x2064d6,DEPLOY_DIR_NAME)),_0x4543a1;}async function insertZip(_0xc011e4,_0x469fb4,_0x191025,_0x8d9e1,_0x21f9ea){const _0x44a216=a54_0xccfd3c,_0x1b96fc={'ParentId':_0x469fb4,'Name':'BUILD'+_0x191025,'Description':_0x44a216(0xa8)+_0x8d9e1,'Body':_0x21f9ea},{data:_0x4d72a9}=await _0xc011e4[_0x44a216(0xaa)](_0x44a216(0xde)+constants_1[_0x44a216(0xdf)]+_0x44a216(0xc8),_0x1b96fc);return _0x4d72a9['id'];}