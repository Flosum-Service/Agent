const a86_0x4565e1=a86_0x5152;(function(_0x10a60a,_0x5d18e4){const _0x42c2d5=a86_0x5152,_0x14af69=_0x10a60a();while(!![]){try{const _0x4a3e14=parseInt(_0x42c2d5(0x11f))/0x1+-parseInt(_0x42c2d5(0x14a))/0x2*(parseInt(_0x42c2d5(0x12f))/0x3)+-parseInt(_0x42c2d5(0x16f))/0x4*(-parseInt(_0x42c2d5(0x150))/0x5)+parseInt(_0x42c2d5(0x136))/0x6+parseInt(_0x42c2d5(0x15c))/0x7*(parseInt(_0x42c2d5(0x128))/0x8)+-parseInt(_0x42c2d5(0x16c))/0x9+-parseInt(_0x42c2d5(0x16b))/0xa*(parseInt(_0x42c2d5(0x172))/0xb);if(_0x4a3e14===_0x5d18e4)break;else _0x14af69['push'](_0x14af69['shift']());}catch(_0x4b2fd7){_0x14af69['push'](_0x14af69['shift']());}}}(a86_0x1a68,0x4c0a5));const a86_0x466967=(function(){let _0x1352c6=!![];return function(_0x40ad41,_0x1f4f20){const _0x3b5b22=_0x1352c6?function(){if(_0x1f4f20){const _0x217d40=_0x1f4f20['apply'](_0x40ad41,arguments);return _0x1f4f20=null,_0x217d40;}}:function(){};return _0x1352c6=![],_0x3b5b22;};}()),a86_0x24115b=a86_0x466967(this,function(){const _0x345ff7=a86_0x5152;return a86_0x24115b[_0x345ff7(0x15d)]()['search']('(((.+)+)+)+$')[_0x345ff7(0x15d)]()[_0x345ff7(0x13e)](a86_0x24115b)[_0x345ff7(0x143)](_0x345ff7(0x130));});a86_0x24115b();'use strict';var __importDefault=this&&this[a86_0x4565e1(0x129)]||function(_0x6428c5){return _0x6428c5&&_0x6428c5['__esModule']?_0x6428c5:{'default':_0x6428c5};};Object[a86_0x4565e1(0x125)](exports,'__esModule',{'value':!![]}),exports[a86_0x4565e1(0x13d)]=void 0x0;const constants_1=require(a86_0x4565e1(0x161)),path_1=__importDefault(require(a86_0x4565e1(0x157))),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a86_0x4565e1(0x162)),zip_1=require(a86_0x4565e1(0x138)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a86_0x4565e1(0x153)),components_api_1=require(a86_0x4565e1(0x135)),adm_zip_1=__importDefault(require(a86_0x4565e1(0x14e))),uuid_1=require('uuid'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a86_0x4565e1(0x16d),DEPLOY_DIR_NAME=a86_0x4565e1(0x121);async function generateAndDeployZip({attachmentsId:_0x2b856f,isExtractComponentsPermissions:_0x495693,preDestructiveAttachmentId:_0xb417e9,postDestructiveAttachmentId:_0x40b7d4,branchId:_0x4e6bf5,credentials:_0x32fb40,metadataLogId:_0x1071c3,environments:_0x1a0aa7,metaTypes:_0x30bae1},_0x5b1d20){const _0x3d6593=a86_0x4565e1,_0x19c537=(0x0,uuid_1['v4'])();try{const _0x1ac06c=await(0x0,fetch_attachments_1[_0x3d6593(0x170)])(_0x5b1d20,_0x2b856f),_0x35da72=_0x1ac06c['reduce']((_0xcdc3f3,_0x3074ca)=>({..._0xcdc3f3,[_0x3074ca['Id']]:_0x3074ca[_0x3d6593(0x163)]}),{}),_0x1e5bcf=await getComponents(_0x1ac06c,_0x5b1d20,_0x35da72),_0x58d635=await components_api_1['ComponentsApi'][_0x3d6593(0x147)](_0x5b1d20,_0x1ac06c[_0x3d6593(0x12a)](({ParentId:_0x45dd4e})=>_0x45dd4e))[_0x3d6593(0x140)](_0x5e44ea=>components_api_1[_0x3d6593(0x14d)]['removeNamespacePrefix'](_0x5e44ea));if(_0x495693){const _0x5df497=_0x1e5bcf['filter'](({fileType:_0x4a245f})=>_0x4a245f===_0x3d6593(0x134)||_0x4a245f===_0x3d6593(0x13b));await removePermission(_0x5df497,_0x58d635);}await replaceEnvironments(_0x30bae1,_0x1a0aa7,_0x1e5bcf),await writeZip(_0x1e5bcf,_0x19c537),await generateAndWritePackageXML(_0x1ac06c,_0x58d635,_0x19c537);_0xb417e9&&await saveDestructiveChanges(_0x5b1d20,_0xb417e9,DESTRUCTIVE_CHANGES_PER_NAME,_0x19c537);_0x40b7d4&&await saveDestructiveChanges(_0x5b1d20,_0x40b7d4,DESTRUCTIVE_CHANGES_POST_NAME,_0x19c537);const _0x1083d7=(await createDeployZip(_0x19c537)['then'](_0x26173b=>{return _0x26173b;}))[_0x3d6593(0x155)]()[_0x3d6593(0x15d)](_0x3d6593(0x167));console[_0x3d6593(0x11c)](_0x3d6593(0x154));const _0x46d717=_0x1083d7['length'];if(_0x46d717>=components_api_1['MAX_ZIP_SIZE']){const _0x3364e9=await createDeployZip(_0x19c537);console[_0x3d6593(0x11c)](_0x3d6593(0x149));const [_0x8609e4,_0xf1215a]=await components_api_1[_0x3d6593(0x14d)][_0x3d6593(0x123)](_0x3364e9,_0x46d717),_0x2a7065=await insertZip(_0x5b1d20,_0x4e6bf5,_0x32fb40[_0x3d6593(0x169)],_0x1071c3,_0x8609e4[_0x3d6593(0x155)]()[_0x3d6593(0x15d)]('base64')),_0x5d99db=await insertZip(_0x5b1d20,_0x4e6bf5,_0x32fb40[_0x3d6593(0x169)],_0x1071c3,_0xf1215a[_0x3d6593(0x155)]()[_0x3d6593(0x15d)](_0x3d6593(0x167)));return _0x2a7065+','+_0x5d99db;}else return await insertZip(_0x5b1d20,_0x4e6bf5,_0x32fb40['orgId'],_0x1071c3,_0x1083d7);}catch(_0x41ec19){throw _0x41ec19;}finally{if(await fs_internal_1['FS']['exists'](path_1['default']['join'](process[_0x3d6593(0x152)](),_0x3d6593(0x12d),_0x19c537)))await(0x0,promises_1['rm'])(path_1[_0x3d6593(0x166)][_0x3d6593(0x15f)](process[_0x3d6593(0x152)](),_0x3d6593(0x12d),_0x19c537),{'recursive':!![]});}}function a86_0x1a68(){const _0x274f81=['fs/promises','after\x20create\x20zip','toBuffer','generateAsync','path','/sobjects/Attachment','BUILD','writeFile','keys','133lFuhUo','toString','extractComponentPermissions','join','substring','../../../constants','xml2js','Name','find','Zip','default','base64','async','orgId','SALESFORCE_API_VERSION','11420RMsoVA','3219012UOpeSK','destructiveChangesPost.xml','post','10280qrMOGv','fetchAttachmentsDetailsById','src','9218RFFXXw','createZip','files','indexOf','type','log','UTF-8','types','511165pAaXzw','push','DEPLOYZIP','file','splitZip','start','defineProperty','every','fetchAttachmentBody','248344GbYBrB','__importDefault','map','/services/data/','Builder','.temp','Body','105ruzptG','(((.+)+)+)+$','package.xml','addLocalFolder','Component_Name__c','Profile','../utils/components-api','3411528yIrOND','values','../../git/parsers/utils/zip','replace','dir','PermissionSet','reduce','generateAndDeployZip','constructor','body','then','1.0','MDApiWriter','search','fileType','Component__r','http://soap.sforce.com/2006/04/metadata','fetchComponentsDetailsByComponentsHistory','fileName','after\x20create\x20second\x20zip','22602VsUpil','DEFLATE','unzip','ComponentsApi','adm-zip','buildObject','685ocemzZ','text','cwd'];a86_0x1a68=function(){return _0x274f81;};return a86_0x1a68();}exports[a86_0x4565e1(0x13d)]=generateAndDeployZip;async function getComponents(_0x1d9cb8,_0x2008a5,_0x8f3a9){const _0x21a33e=a86_0x4565e1,_0x57be32=[],_0x152376=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x1d9cb8,_0x2008a5);return await getComponentFromZip(_0x152376,_0x8f3a9)[_0x21a33e(0x140)](_0x210c7b=>{_0x57be32['push'](..._0x210c7b);}),_0x57be32;}async function getComponentFromZip(_0x1423df,_0x47839a){const _0x577ae6=a86_0x4565e1,_0x4a4d41=[];for(const _0xfad4ed of _0x1423df){const _0x5d95ed=await zip_1['Zip'][_0x577ae6(0x14c)](_0xfad4ed[_0x577ae6(0x137)][_0x577ae6(0x12e)]);for(const _0x41d43b in _0x5d95ed['files']){!_0x5d95ed[_0x577ae6(0x119)][_0x41d43b][_0x577ae6(0x13a)]&&_0x4a4d41['push']({'fileName':_0x41d43b[_0x577ae6(0x160)](_0x41d43b[_0x577ae6(0x11a)]('/')+0x1),'fileType':_0x47839a[_0xfad4ed['id']],'body':_0xfad4ed[_0x577ae6(0x137)]['Body']});}}return _0x4a4d41;}async function removePermission(_0x5b5600,_0xb1fb60){const _0x30cfb7=a86_0x4565e1;for(const _0x50a1c8 of _0x5b5600){const _0x4bf31c=await zip_1[_0x30cfb7(0x165)]['unzip'](_0x50a1c8[_0x30cfb7(0x13f)]),_0x40ab5a=[];for(const _0x1e05b7 in _0x4bf31c[_0x30cfb7(0x119)]){!_0x4bf31c[_0x30cfb7(0x119)][_0x1e05b7][_0x30cfb7(0x13a)]&&_0x40ab5a['push']({'fileName':_0x1e05b7,'body':await _0x4bf31c[_0x30cfb7(0x119)][_0x1e05b7][_0x30cfb7(0x168)](_0x30cfb7(0x151))});}const _0x107f6b=await(0x0,extract_component_permissions_1[_0x30cfb7(0x15e)])(_0x40ab5a[0x0][_0x30cfb7(0x13f)][_0x30cfb7(0x15d)](),_0xb1fb60,_0x50a1c8[_0x30cfb7(0x144)]),_0xd480b4=new xml2js_1[(_0x30cfb7(0x12c))]({'xmldec':{'version':_0x30cfb7(0x141),'encoding':'UTF-8'}}),_0x57893f=_0xd480b4[_0x30cfb7(0x14f)](_0x107f6b),_0x233cdc=zip_1[_0x30cfb7(0x165)][_0x30cfb7(0x118)]();_0x233cdc[_0x30cfb7(0x122)](_0x40ab5a[0x0][_0x30cfb7(0x148)],_0x57893f),_0x50a1c8[_0x30cfb7(0x13f)]=await _0x233cdc['generateAsync']({'type':'base64','compression':_0x30cfb7(0x14b),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x46324a,_0x356bd2,_0x1cf39a){const _0x206686=a86_0x4565e1;for(const _0x29988f of _0x1cf39a){if(_0x46324a[_0x206686(0x126)](_0x584904=>_0x584904!==_0x29988f[_0x206686(0x144)]))continue;const _0x12e661=await zip_1[_0x206686(0x165)][_0x206686(0x14c)](_0x29988f[_0x206686(0x13f)]);for(const _0x231063 in _0x12e661[_0x206686(0x119)]){if(!_0x12e661['files'][_0x231063][_0x206686(0x13a)]){let _0x42ef60=await _0x12e661[_0x206686(0x119)][_0x231063][_0x206686(0x168)](_0x206686(0x151));for(const _0x43e980 of Object[_0x206686(0x15b)](_0x356bd2)){const _0x834b8b=new RegExp('%%'+_0x43e980+'%%','g');_0x42ef60=_0x42ef60[_0x206686(0x139)](_0x834b8b,_0x356bd2[_0x43e980]);}_0x12e661[_0x206686(0x122)](_0x231063,_0x42ef60);}}_0x29988f[_0x206686(0x13f)]=await _0x12e661[_0x206686(0x156)]({'type':_0x206686(0x167),'compression':_0x206686(0x14b),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x1f4f36,_0x211ddf){const _0x2b2212=a86_0x4565e1,_0x270599=new mdapi_1[(_0x2b2212(0x142))]({'components':_0x1f4f36,'sourceDir':path_1['default'][_0x2b2212(0x15f)](process[_0x2b2212(0x152)](),_0x2b2212(0x12d),_0x211ddf,DEPLOY_DIR_NAME,_0x2b2212(0x171)),'skipChildErrors':![]});await _0x270599[_0x2b2212(0x124)]();}async function generateAndWritePackageXML(_0x59ad76,_0xdd1b16,_0x3e807d){const _0x3f73c6=a86_0x4565e1,_0x4b3f6a=getComponentsTypeAndName(_0x59ad76,_0xdd1b16),_0x458340=[...new Set(_0x4b3f6a['map'](_0x5aa28c=>_0x5aa28c[_0x3f73c6(0x11b)]))],_0x1eb838={'Package':{'$':{'xmlns':_0x3f73c6(0x146)},'types':[],'version':''+constants_1[_0x3f73c6(0x16a)][_0x3f73c6(0x160)](0x1)}};for(const _0x42a2a3 of _0x458340){const _0x510f57=_0x4b3f6a['filter'](_0x48b8fc=>_0x48b8fc['type']===_0x42a2a3)[_0x3f73c6(0x12a)](_0xa051c0=>_0xa051c0['name']),_0x5a181b={'members':_0x510f57,'name':_0x42a2a3};_0x1eb838['Package'][_0x3f73c6(0x11e)][_0x3f73c6(0x120)](_0x5a181b);}const _0x58d22b=new xml2js_1[(_0x3f73c6(0x12c))]({'xmldec':{'version':_0x3f73c6(0x141),'encoding':_0x3f73c6(0x11d)}}),_0x2f413e=_0x58d22b[_0x3f73c6(0x14f)](_0x1eb838);await fs_internal_1['FS'][_0x3f73c6(0x15a)](path_1['default'][_0x3f73c6(0x15f)](process[_0x3f73c6(0x152)](),_0x3f73c6(0x12d),_0x3e807d,DEPLOY_DIR_NAME,'src',_0x3f73c6(0x131)),_0x2f413e);}function getComponentsTypeAndName(_0x46a716,_0x36d16b){const _0x4fbccc=a86_0x4565e1;return _0x46a716[_0x4fbccc(0x13c)]((_0x2eff60,_0x50d069)=>{const _0x17721f=_0x4fbccc,_0x51852a=_0x36d16b[_0x17721f(0x164)](_0x4ba174=>_0x4ba174['Id']===_0x50d069['ParentId']);return _0x51852a&&_0x2eff60['push']({'name':_0x51852a[_0x17721f(0x145)][_0x17721f(0x133)],'type':_0x50d069[_0x17721f(0x163)]}),_0x2eff60;},[]);}async function saveDestructiveChanges(_0x2df99c,_0x34a517,_0x5a5922,_0x2dfbe5){const _0x59a101=a86_0x4565e1,_0x36344c=(await(0x0,fetch_attachments_1[_0x59a101(0x127)])(_0x2df99c,_0x34a517))[_0x59a101(0x15d)]();await fs_internal_1['FS']['writeFile'](path_1[_0x59a101(0x166)]['join'](process[_0x59a101(0x152)](),_0x59a101(0x12d),_0x2dfbe5,DEPLOY_DIR_NAME,'src',_0x5a5922),_0x36344c);}async function createDeployZip(_0x46f88e){const _0x2b1d69=a86_0x4565e1,_0x15cb93=new adm_zip_1[(_0x2b1d69(0x166))]();return await _0x15cb93[_0x2b1d69(0x132)](path_1[_0x2b1d69(0x166)]['join'](process['cwd'](),_0x2b1d69(0x12d),_0x46f88e,DEPLOY_DIR_NAME)),_0x15cb93;}function a86_0x5152(_0x3f7f3e,_0x5dc951){const _0x5e5f95=a86_0x1a68();return a86_0x5152=function(_0x24115b,_0x466967){_0x24115b=_0x24115b-0x118;let _0x1a6827=_0x5e5f95[_0x24115b];return _0x1a6827;},a86_0x5152(_0x3f7f3e,_0x5dc951);}async function insertZip(_0x42f00c,_0x407c76,_0x118635,_0x3b7374,_0x3aadc1){const _0x53a0b3=a86_0x4565e1,_0x5c412f={'ParentId':_0x407c76,'Name':_0x53a0b3(0x159)+_0x118635,'Description':_0x53a0b3(0x159)+_0x3b7374,'Body':_0x3aadc1},{data:_0x5e3c66}=await _0x42f00c[_0x53a0b3(0x16e)](_0x53a0b3(0x12b)+constants_1['SALESFORCE_API_VERSION']+_0x53a0b3(0x158),_0x5c412f);return _0x5e3c66['id'];}