const a86_0x401bf2=a86_0x182d;(function(_0xf7dcb5,_0x56670f){const _0xb62a3c=a86_0x182d,_0x218562=_0xf7dcb5();while(!![]){try{const _0x355489=-parseInt(_0xb62a3c(0xb5))/0x1+parseInt(_0xb62a3c(0x88))/0x2*(parseInt(_0xb62a3c(0x92))/0x3)+-parseInt(_0xb62a3c(0x98))/0x4+parseInt(_0xb62a3c(0xb6))/0x5+parseInt(_0xb62a3c(0xa0))/0x6*(-parseInt(_0xb62a3c(0xa8))/0x7)+-parseInt(_0xb62a3c(0x7b))/0x8+parseInt(_0xb62a3c(0x79))/0x9;if(_0x355489===_0x56670f)break;else _0x218562['push'](_0x218562['shift']());}catch(_0x11a230){_0x218562['push'](_0x218562['shift']());}}}(a86_0x1074,0xe8e81));const a86_0x142131=(function(){let _0x327c77=!![];return function(_0x4e4f5,_0x2de6f7){const _0x348d19=_0x327c77?function(){const _0x4dbc40=a86_0x182d;if(_0x2de6f7){const _0x2c8d86=_0x2de6f7[_0x4dbc40(0x76)](_0x4e4f5,arguments);return _0x2de6f7=null,_0x2c8d86;}}:function(){};return _0x327c77=![],_0x348d19;};}()),a86_0x30e718=a86_0x142131(this,function(){const _0x396991=a86_0x182d;return a86_0x30e718[_0x396991(0x74)]()['search'](_0x396991(0xb2))[_0x396991(0x74)]()[_0x396991(0x7f)](a86_0x30e718)[_0x396991(0xbe)](_0x396991(0xb2));});a86_0x30e718();'use strict';var __importDefault=this&&this[a86_0x401bf2(0xb4)]||function(_0x40fe6b){const _0x3279de=a86_0x401bf2;return _0x40fe6b&&_0x40fe6b[_0x3279de(0x6d)]?_0x40fe6b:{'default':_0x40fe6b};};Object[a86_0x401bf2(0x91)](exports,'__esModule',{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require(a86_0x401bf2(0xa1)),path_1=__importDefault(require(a86_0x401bf2(0x9b))),extract_component_permissions_1=require(a86_0x401bf2(0xc5)),xml2js_1=require('xml2js'),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a86_0x401bf2(0xc4)),promises_1=require('fs/promises'),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a86_0x401bf2(0x6f))),uuid_1=require(a86_0x401bf2(0x8d)),fetch_attachments_1=require(a86_0x401bf2(0x97)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a86_0x401bf2(0xa3),DEPLOY_DIR_NAME=a86_0x401bf2(0xa5);function a86_0x182d(_0x32cbd4,_0x4b8873){const _0xe5d0fc=a86_0x1074();return a86_0x182d=function(_0x30e718,_0x142131){_0x30e718=_0x30e718-0x6b;let _0x107432=_0xe5d0fc[_0x30e718];return _0x107432;},a86_0x182d(_0x32cbd4,_0x4b8873);}async function generateAndDeployZip({attachmentsId:_0x328424,isExtractComponentsPermissions:_0x5bdd02,preDestructiveAttachmentId:_0x33d041,postDestructiveAttachmentId:_0x3a82af,branchId:_0x5e4d75,credentials:_0x4a036b,metadataLogId:_0x3d9617,environments:_0x5b75cf,metaTypes:_0x2cf1f3},_0xe292f1){const _0x5abdf1=a86_0x401bf2,_0x19af8f=(0x0,uuid_1['v4'])();try{const _0x5e9fd1=await(0x0,fetch_attachments_1[_0x5abdf1(0xae)])(_0xe292f1,_0x328424),_0x14167d=_0x5e9fd1[_0x5abdf1(0x6e)]((_0x527c07,_0xd544b)=>({..._0x527c07,[_0xd544b['Id']]:_0xd544b[_0x5abdf1(0x87)]}),{}),_0x146e9e=await getComponents(_0x5e9fd1,_0xe292f1,_0x14167d),_0x4dd85d=await components_api_1[_0x5abdf1(0xab)]['fetchComponentsDetailsByComponentsHistory'](_0xe292f1,_0x5e9fd1[_0x5abdf1(0x75)](({ParentId:_0x3f26be})=>_0x3f26be))[_0x5abdf1(0xba)](_0x45287a=>components_api_1[_0x5abdf1(0xab)]['removeNamespacePrefix'](_0x45287a));if(_0x5bdd02){const _0xe6a836=_0x146e9e[_0x5abdf1(0xc2)](({fileType:_0x547297})=>_0x547297==='Profile'||_0x547297===_0x5abdf1(0x96));await removePermission(_0xe6a836,_0x4dd85d);}await replaceEnvironments(_0x2cf1f3,_0x5b75cf,_0x146e9e),await writeZip(_0x146e9e,_0x19af8f),await generateAndWritePackageXML(_0x5e9fd1,_0x4dd85d,_0x19af8f);_0x33d041&&await saveDestructiveChanges(_0xe292f1,_0x33d041,DESTRUCTIVE_CHANGES_PER_NAME,_0x19af8f);_0x3a82af&&await saveDestructiveChanges(_0xe292f1,_0x3a82af,DESTRUCTIVE_CHANGES_POST_NAME,_0x19af8f);const _0x65631a=(await createDeployZip(_0x19af8f)[_0x5abdf1(0xba)](_0x53959e=>{return _0x53959e;}))[_0x5abdf1(0x93)]()[_0x5abdf1(0x74)](_0x5abdf1(0xb7));console[_0x5abdf1(0x9d)](_0x5abdf1(0x94));const _0x537b0c=_0x65631a[_0x5abdf1(0xbf)];if(_0x537b0c>=components_api_1[_0x5abdf1(0x78)]){const _0x5f1802=await createDeployZip(_0x19af8f);console['log'](_0x5abdf1(0x8e));const [_0x170529,_0x2da332]=await components_api_1['ComponentsApi']['splitZip'](_0x5f1802,_0x537b0c),_0x186400=await insertZip(_0xe292f1,_0x5e4d75,_0x4a036b[_0x5abdf1(0xa7)],_0x3d9617,_0x170529[_0x5abdf1(0x93)]()[_0x5abdf1(0x74)]('base64')),_0xd05449=await insertZip(_0xe292f1,_0x5e4d75,_0x4a036b[_0x5abdf1(0xa7)],_0x3d9617,_0x2da332[_0x5abdf1(0x93)]()[_0x5abdf1(0x74)](_0x5abdf1(0xb7)));return _0x186400+','+_0xd05449;}else return await insertZip(_0xe292f1,_0x5e4d75,_0x4a036b[_0x5abdf1(0xa7)],_0x3d9617,_0x65631a);}catch(_0x50e4b8){throw _0x50e4b8;}finally{if(await fs_internal_1['FS'][_0x5abdf1(0xa6)](path_1[_0x5abdf1(0xc3)][_0x5abdf1(0x9e)](process[_0x5abdf1(0xbc)](),_0x5abdf1(0xbd),_0x19af8f)))await(0x0,promises_1['rm'])(path_1[_0x5abdf1(0xc3)][_0x5abdf1(0x9e)](process[_0x5abdf1(0xbc)](),_0x5abdf1(0xbd),_0x19af8f),{'recursive':!![]});}}exports[a86_0x401bf2(0xaf)]=generateAndDeployZip;async function getComponents(_0x32e467,_0x458226,_0x2de763){const _0x332318=a86_0x401bf2,_0x2d09a0=[],_0x22d12b=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x32e467,_0x458226);return await getComponentFromZip(_0x22d12b,_0x2de763)[_0x332318(0xba)](_0x2bec5d=>{const _0x2edde9=_0x332318;_0x2d09a0[_0x2edde9(0x71)](..._0x2bec5d);}),_0x2d09a0;}async function getComponentFromZip(_0x724337,_0x7e2695){const _0x2c1819=a86_0x401bf2,_0x103ad2=[];for(const _0x1228dc of _0x724337){const _0x120f09=await zip_1[_0x2c1819(0xb1)][_0x2c1819(0x99)](_0x1228dc[_0x2c1819(0x72)][_0x2c1819(0xaa)]);for(const _0x59dd26 in _0x120f09[_0x2c1819(0x73)]){!_0x120f09['files'][_0x59dd26][_0x2c1819(0xad)]&&_0x103ad2['push']({'fileName':_0x59dd26['substring'](_0x59dd26[_0x2c1819(0x9f)]('/')+0x1),'fileType':_0x7e2695[_0x1228dc['id']],'body':_0x1228dc[_0x2c1819(0x72)]['Body']});}}return _0x103ad2;}async function removePermission(_0x4a7dc0,_0x351645){const _0x3fd144=a86_0x401bf2;for(const _0x3098ed of _0x4a7dc0){const _0xb65321=await zip_1[_0x3fd144(0xb1)][_0x3fd144(0x99)](_0x3098ed[_0x3fd144(0x6b)]),_0x8118be=[];for(const _0x204b96 in _0xb65321[_0x3fd144(0x73)]){!_0xb65321[_0x3fd144(0x73)][_0x204b96][_0x3fd144(0xad)]&&_0x8118be['push']({'fileName':_0x204b96,'body':await _0xb65321[_0x3fd144(0x73)][_0x204b96]['async'](_0x3fd144(0x8f))});}const _0x3bfff6=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x8118be[0x0][_0x3fd144(0x6b)][_0x3fd144(0x74)](),_0x351645,_0x3098ed['fileType']),_0x3d5c73=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':_0x3fd144(0x6c)}}),_0x3f3dcf=_0x3d5c73[_0x3fd144(0xac)](_0x3bfff6),_0x1bd765=zip_1[_0x3fd144(0xb1)][_0x3fd144(0x82)]();_0x1bd765[_0x3fd144(0x8a)](_0x8118be[0x0][_0x3fd144(0x7d)],_0x3f3dcf),_0x3098ed['body']=await _0x1bd765[_0x3fd144(0xb3)]({'type':'base64','compression':_0x3fd144(0x7c),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x48ecc2,_0x4c3187,_0x1f772c){const _0x4ade85=a86_0x401bf2;for(const _0x3239d9 of _0x1f772c){if(_0x48ecc2[_0x4ade85(0x86)](_0x5ea54a=>_0x5ea54a!==_0x3239d9[_0x4ade85(0x70)]))continue;const _0x5137fc=await zip_1['Zip'][_0x4ade85(0x99)](_0x3239d9[_0x4ade85(0x6b)]);for(const _0x136477 in _0x5137fc['files']){if(!_0x5137fc[_0x4ade85(0x73)][_0x136477][_0x4ade85(0xad)]){let _0x39a395=await _0x5137fc[_0x4ade85(0x73)][_0x136477][_0x4ade85(0x77)](_0x4ade85(0x8f));for(const _0x355e84 of Object[_0x4ade85(0xc0)](_0x4c3187)){const _0x4a28d0=new RegExp('%%'+_0x355e84+'%%','g');_0x39a395=_0x39a395[_0x4ade85(0x8c)](_0x4a28d0,_0x4c3187[_0x355e84]);}_0x5137fc[_0x4ade85(0x8a)](_0x136477,_0x39a395);}}_0x3239d9[_0x4ade85(0x6b)]=await _0x5137fc['generateAsync']({'type':'base64','compression':_0x4ade85(0x7c),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x516c05,_0x4a9e87){const _0x4e2fec=a86_0x401bf2,_0x3c51ed=new mdapi_1[(_0x4e2fec(0xc1))]({'components':_0x516c05,'sourceDir':path_1['default']['join'](process['cwd'](),'.temp',_0x4a9e87,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x3c51ed[_0x4e2fec(0x90)]();}async function generateAndWritePackageXML(_0x3e269a,_0x1f0d84,_0x208381){const _0x6608e1=a86_0x401bf2,_0x1a1a49=getComponentsTypeAndName(_0x3e269a,_0x1f0d84),_0x19fe96=[...new Set(_0x1a1a49['map'](_0x1bcd76=>_0x1bcd76[_0x6608e1(0xa9)]))],_0x2399a5={'Package':{'$':{'xmlns':_0x6608e1(0x83)},'types':[],'version':''+constants_1[_0x6608e1(0x85)]['substring'](0x1)}};for(const _0x4c71a3 of _0x19fe96){const _0x3dee52=_0x1a1a49['filter'](_0x460a5e=>_0x460a5e[_0x6608e1(0xa9)]===_0x4c71a3)[_0x6608e1(0x75)](_0x469a27=>_0x469a27[_0x6608e1(0x8b)]),_0x5a3ac7={'members':_0x3dee52,'name':_0x4c71a3};_0x2399a5[_0x6608e1(0xb8)][_0x6608e1(0xa2)][_0x6608e1(0x71)](_0x5a3ac7);}const _0x38a2e1=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':_0x6608e1(0x6c)}}),_0x4621eb=_0x38a2e1[_0x6608e1(0xac)](_0x2399a5);await fs_internal_1['FS']['writeFile'](path_1[_0x6608e1(0xc3)][_0x6608e1(0x9e)](process['cwd'](),'.temp',_0x208381,DEPLOY_DIR_NAME,_0x6608e1(0x9a),_0x6608e1(0x7e)),_0x4621eb);}function getComponentsTypeAndName(_0x5ea221,_0x3e4d5f){const _0xe217d2=a86_0x401bf2;return _0x5ea221[_0xe217d2(0x6e)]((_0x2e59cf,_0x11cb4f)=>{const _0x3e8c5d=_0xe217d2,_0x2abd54=_0x3e4d5f[_0x3e8c5d(0x95)](_0x3a58b8=>_0x3a58b8['Id']===_0x11cb4f[_0x3e8c5d(0x81)]);return _0x2abd54&&_0x2e59cf[_0x3e8c5d(0x71)]({'name':_0x2abd54[_0x3e8c5d(0x7a)][_0x3e8c5d(0xb9)],'type':_0x11cb4f['Name']}),_0x2e59cf;},[]);}async function saveDestructiveChanges(_0x22fda5,_0x2bf892,_0x54f425,_0x2b9d51){const _0x3ef9f7=a86_0x401bf2,_0x5bf51=(await(0x0,fetch_attachments_1[_0x3ef9f7(0x89)])(_0x22fda5,_0x2bf892))['toString']();await fs_internal_1['FS'][_0x3ef9f7(0xb0)](path_1['default'][_0x3ef9f7(0x9e)](process[_0x3ef9f7(0xbc)](),_0x3ef9f7(0xbd),_0x2b9d51,DEPLOY_DIR_NAME,'src',_0x54f425),_0x5bf51);}async function createDeployZip(_0x25118f){const _0x43e322=a86_0x401bf2,_0x5b5f4c=new adm_zip_1[(_0x43e322(0xc3))]();return await _0x5b5f4c[_0x43e322(0xbb)](path_1[_0x43e322(0xc3)]['join'](process['cwd'](),_0x43e322(0xbd),_0x25118f,DEPLOY_DIR_NAME)),_0x5b5f4c;}function a86_0x1074(){const _0xea9242=['BUILD','DEPLOYZIP','exists','orgId','307734EbFbGC','type','Body','ComponentsApi','buildObject','dir','fetchAttachmentsDetailsById','generateAndDeployZip','writeFile','Zip','(((.+)+)+)+$','generateAsync','__importDefault','1661127ObnjJB','4753565lLbbeo','base64','Package','Component_Name__c','then','addLocalFolder','cwd','.temp','search','length','keys','MDApiWriter','filter','default','../../git/internal/fs.internal','../utils/extract-component-permissions','body','UTF-8','__esModule','reduce','adm-zip','fileType','push','values','files','toString','map','apply','async','MAX_ZIP_SIZE','24179085qEZgKe','Component__r','682448xewbee','DEFLATE','fileName','package.xml','constructor','post','ParentId','createZip','http://soap.sforce.com/2006/04/metadata','/services/data/','SALESFORCE_API_VERSION','every','Name','23150JnDVAz','fetchAttachmentBody','file','name','replace','uuid','after\x20create\x20second\x20zip','text','start','defineProperty','81yGPDkU','toBuffer','after\x20create\x20zip','find','PermissionSet','../../shared/utils/fetch-attachments','73796RdrnIl','unzip','src','path','/sobjects/Attachment','log','join','indexOf','168ooNZTm','../../../constants','types','destructiveChangesPost.xml'];a86_0x1074=function(){return _0xea9242;};return a86_0x1074();}async function insertZip(_0x16b347,_0x4466c4,_0x348a72,_0x329421,_0x2c9f00){const _0x38a8c6=a86_0x401bf2,_0x68c278={'ParentId':_0x4466c4,'Name':_0x38a8c6(0xa4)+_0x348a72,'Description':_0x38a8c6(0xa4)+_0x329421,'Body':_0x2c9f00},{data:_0x5b2359}=await _0x16b347[_0x38a8c6(0x80)](_0x38a8c6(0x84)+constants_1['SALESFORCE_API_VERSION']+_0x38a8c6(0x9c),_0x68c278);return _0x5b2359['id'];}