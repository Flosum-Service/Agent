const a104_0x317000=a104_0x3c76;(function(_0x511723,_0x1a31c2){const _0x213ebe=a104_0x3c76,_0x3f145a=_0x511723();while(!![]){try{const _0x54d223=-parseInt(_0x213ebe(0x132))/0x1*(-parseInt(_0x213ebe(0x13a))/0x2)+parseInt(_0x213ebe(0x156))/0x3*(parseInt(_0x213ebe(0x13c))/0x4)+-parseInt(_0x213ebe(0x114))/0x5+parseInt(_0x213ebe(0x153))/0x6*(-parseInt(_0x213ebe(0x10b))/0x7)+parseInt(_0x213ebe(0x118))/0x8+-parseInt(_0x213ebe(0x100))/0x9+parseInt(_0x213ebe(0x127))/0xa;if(_0x54d223===_0x1a31c2)break;else _0x3f145a['push'](_0x3f145a['shift']());}catch(_0x4afe82){_0x3f145a['push'](_0x3f145a['shift']());}}}(a104_0x1354,0x26fb5));const a104_0xa1c198=(function(){let _0x1c105f=!![];return function(_0x5283df,_0x5be16a){const _0x313ab7=_0x1c105f?function(){if(_0x5be16a){const _0x4335d0=_0x5be16a['apply'](_0x5283df,arguments);return _0x5be16a=null,_0x4335d0;}}:function(){};return _0x1c105f=![],_0x313ab7;};}()),a104_0x3b0f97=a104_0xa1c198(this,function(){const _0x55bf6d=a104_0x3c76;return a104_0x3b0f97[_0x55bf6d(0x119)]()[_0x55bf6d(0x14f)]('(((.+)+)+)+$')[_0x55bf6d(0x119)]()[_0x55bf6d(0x147)](a104_0x3b0f97)[_0x55bf6d(0x14f)](_0x55bf6d(0x105));});a104_0x3b0f97();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x5ba800){const _0xa2f56f=a104_0x3c76;return _0x5ba800&&_0x5ba800[_0xa2f56f(0x10a)]?_0x5ba800:{'default':_0x5ba800};};function a104_0x1354(){const _0x1ac5cb=['DEFLATE','Profile','40941urZJJJ','post','replace','fetchComponentsDetailsByComponentsHistory','fileName','unzip','join','files','2807964qcHkuN','destructiveChangesPre.xml','components','generateAndDeployZip','fileType','(((.+)+)+)+$','reduce','ParentId','xml2js','fetchAttachmentBody','__esModule','2814HtmmLr','body','destructiveChangesPost.xml','dir','src','exists','PermissionSet','listMetadataItem','default','1571545lEdHMO','keys','../classes/logger','indexOf','1711696BKrRAp','toString','async','1.0','.temp','../../shared/utils/fetch-attachments','Name','orgId','retrieveAttachments','filter','addLocalFolder','../../git/writers/mdapi.writer','substring','/sobjects/Attachment','cwd','6282790NhTLTr','MAX_ZIP_SIZE','writeFile','map','generateAsync','length','file','Zip','removeNamespacePrefix','Body','/services/data/v','47tRVADG','MetadataConstants','@flosum/salesforce','get','execute','PartialRetrieve','name','package.xml','8452NGiGln','MDApiWriter','4QaNQPk','DEPLOYZIP','toBuffer','then','../utils/extract-component-permissions','MetadataType','DeclarativeFilterOptions','set','Logger','push','FOLDER_TO_METADATA_TYPE_MAP','constructor','text','ComponentsApi','Package','createZip','base64','fs/promises','type','search','buildObject','../../git/internal/fs.internal','Builder','4008UNPGEb'];a104_0x1354=function(){return _0x1ac5cb;};return a104_0x1354();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a104_0x317000(0x103)]=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require(a104_0x317000(0x140)),logger_1=require(a104_0x317000(0x116)),xml2js_1=require(a104_0x317000(0x108)),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require(a104_0x317000(0x123)),fs_internal_1=require(a104_0x317000(0x151)),promises_1=require(a104_0x317000(0x14d)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require('uuid'),fetch_attachments_1=require(a104_0x317000(0x11d)),salesforce_1=require(a104_0x317000(0x134)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x317000(0x101),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x317000(0x10d),DEPLOY_DIR_NAME=a104_0x317000(0x13d),PERMISSION_SET_FOLDER_NAME='permissionsets';async function generateAndDeployZip({attachmentsId:_0x4c82dc,isExtractComponentsPermissionSets:_0x149369,isExtractComponentsProfiles:_0x326621,preDestructiveAttachmentId:_0x129cad,postDestructiveAttachmentId:_0xabe907,branchId:_0x4033f2,credentials:_0x2052ce,metadataLogId:_0x528169,environments:_0x246d22,metaTypes:_0x1129f3,apiVersion:_0x23d77e},_0x9fce9a,_0x4de62f){const _0x156ed5=a104_0x317000;var _0x55c727;const _0x43882d=(0x0,uuid_1['v4'])();try{const _0x3d2c60=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x9fce9a,_0x4c82dc),_0x38fd67=_0x3d2c60[_0x156ed5(0x106)]((_0x632307,_0x4d6dca)=>({..._0x632307,[_0x4d6dca['Id']]:_0x4d6dca[_0x156ed5(0x11e)]}),{}),_0x346bf7=await getComponents(_0x3d2c60,_0x9fce9a,_0x38fd67),_0x50f46f=await components_api_1[_0x156ed5(0x149)][_0x156ed5(0xfb)](_0x9fce9a,_0x3d2c60['map'](({ParentId:_0x2939a9})=>_0x2939a9),_0x23d77e)['then'](_0x3a9eb9=>components_api_1[_0x156ed5(0x149)][_0x156ed5(0x12f)](_0x3a9eb9));if(_0x326621){const _0x4826f4=_0x346bf7['filter'](({fileType:_0x533970})=>_0x533970===_0x156ed5(0x155));await removePermission(_0x4826f4,_0x50f46f);}const _0x1893b7=_0x346bf7['filter'](({fileType:_0x415e6f})=>_0x415e6f===_0x156ed5(0x111));if(_0x1893b7[_0x156ed5(0x12c)]&&_0x149369){await removePermission(_0x1893b7,_0x50f46f);const {items:_0x3e9df5}=await retrieveTargetPermissionSets(_0x1893b7,_0x23d77e,_0x4de62f);await mergePermissionSets(_0x1893b7,((_0x55c727=_0x3e9df5[_0x156ed5(0x111)])===null||_0x55c727===void 0x0?void 0x0:_0x55c727[_0x156ed5(0x102)])||[]);}await replaceEnvironments(_0x1129f3,_0x246d22,_0x346bf7),await writeZip(_0x346bf7,_0x43882d),await generateAndWritePackageXML(_0x3d2c60,_0x50f46f,_0x43882d,_0x23d77e);_0x129cad&&await saveDestructiveChanges(_0x9fce9a,_0x129cad,DESTRUCTIVE_CHANGES_PER_NAME,_0x43882d);_0xabe907&&await saveDestructiveChanges(_0x9fce9a,_0xabe907,DESTRUCTIVE_CHANGES_POST_NAME,_0x43882d);const _0x34643f=(await createDeployZip(_0x43882d)[_0x156ed5(0x13f)](_0x4bf133=>{return _0x4bf133;}))[_0x156ed5(0x13e)]()[_0x156ed5(0x119)]('base64'),_0x2e71cb=_0x34643f[_0x156ed5(0x12c)];if(_0x2e71cb>=components_api_1[_0x156ed5(0x128)]){const _0x5a33cc=await createDeployZip(_0x43882d),[_0x50efa0,_0x293e33]=await components_api_1['ComponentsApi']['splitZip'](_0x5a33cc,_0x2e71cb),_0x17f7c4=await insertZip(_0x9fce9a,_0x4033f2,_0x2052ce[_0x156ed5(0x11f)],_0x528169,_0x50efa0[_0x156ed5(0x13e)]()[_0x156ed5(0x119)](_0x156ed5(0x14c)),_0x23d77e),_0x5e7c95=await insertZip(_0x9fce9a,_0x4033f2,_0x2052ce['orgId'],_0x528169,_0x293e33[_0x156ed5(0x13e)]()[_0x156ed5(0x119)](_0x156ed5(0x14c)),_0x23d77e);return _0x17f7c4+','+_0x5e7c95;}else return await insertZip(_0x9fce9a,_0x4033f2,_0x2052ce[_0x156ed5(0x11f)],_0x528169,_0x34643f,_0x23d77e);}catch(_0x50e3f3){throw _0x50e3f3;}finally{if(await fs_internal_1['FS'][_0x156ed5(0x110)](path_1['default'][_0x156ed5(0xfe)](process[_0x156ed5(0x126)](),_0x156ed5(0x11c),_0x43882d)))await(0x0,promises_1['rm'])(path_1[_0x156ed5(0x113)][_0x156ed5(0xfe)](process[_0x156ed5(0x126)](),'.temp',_0x43882d),{'recursive':!![]});}}exports[a104_0x317000(0x103)]=generateAndDeployZip;async function getComponents(_0x1b531d,_0x22350c,_0x2eca41){const _0x1249d1=a104_0x317000,_0x4a9981=[],_0x28212e=await(0x0,fetch_attachments_1[_0x1249d1(0x120)])(_0x1b531d,_0x22350c);return await getComponentFromZip(_0x28212e,_0x2eca41)[_0x1249d1(0x13f)](_0x417d2e=>{const _0x3cba33=_0x1249d1;_0x4a9981[_0x3cba33(0x145)](..._0x417d2e);}),_0x4a9981;}async function getComponentFromZip(_0x3f1e37,_0x3e684a){const _0x1d547e=a104_0x317000,_0x38d430=[];for(const _0x2c1216 of _0x3f1e37){const _0x44dac0=await zip_1[_0x1d547e(0x12e)][_0x1d547e(0xfd)](_0x2c1216['values'][_0x1d547e(0x130)]);for(const _0x38924b in _0x44dac0['files']){!_0x44dac0[_0x1d547e(0xff)][_0x38924b]['dir']&&_0x38d430['push']({'fileName':_0x38924b[_0x1d547e(0x124)](_0x38924b[_0x1d547e(0x117)]('/')+0x1),'fileType':_0x3e684a[_0x2c1216['id']],'body':_0x2c1216['values'][_0x1d547e(0x130)]});}}return _0x38d430;}async function removePermission(_0x2a9871,_0x3ba8ad){const _0x163f9b=a104_0x317000;for(const _0x4b6feb of _0x2a9871){const _0x4d49f2=await zip_1[_0x163f9b(0x12e)]['unzip'](_0x4b6feb['body']),_0x2cf011=[];for(const _0x3f7176 in _0x4d49f2[_0x163f9b(0xff)]){!_0x4d49f2[_0x163f9b(0xff)][_0x3f7176][_0x163f9b(0x10e)]&&_0x2cf011[_0x163f9b(0x145)]({'fileName':_0x3f7176,'body':await _0x4d49f2[_0x163f9b(0xff)][_0x3f7176][_0x163f9b(0x11a)]('text')});}const _0xb975e2=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x2cf011[0x0][_0x163f9b(0x10c)][_0x163f9b(0x119)](),_0x3ba8ad,_0x4b6feb['fileType']),_0x29412a=new xml2js_1[(_0x163f9b(0x152))]({'xmldec':{'version':_0x163f9b(0x11b),'encoding':'UTF-8'}}),_0x29be74=_0x29412a[_0x163f9b(0x150)](_0xb975e2),_0x82d37=zip_1['Zip'][_0x163f9b(0x14b)]();_0x82d37['file'](_0x2cf011[0x0][_0x163f9b(0xfc)],_0x29be74),_0x4b6feb[_0x163f9b(0x10c)]=await _0x82d37[_0x163f9b(0x12b)]({'type':_0x163f9b(0x14c),'compression':_0x163f9b(0x154),'compressionOptions':{'level':0x6}});}}function a104_0x3c76(_0x1627f2,_0x4be126){const _0x582bef=a104_0x1354();return a104_0x3c76=function(_0x3b0f97,_0xa1c198){_0x3b0f97=_0x3b0f97-0xfb;let _0x13542d=_0x582bef[_0x3b0f97];return _0x13542d;},a104_0x3c76(_0x1627f2,_0x4be126);}async function retrieveTargetPermissionSets(_0x382e99,_0x229b6d,_0x4c80e8){const _0x434c02=a104_0x317000,_0xdc2112=_0x382e99[_0x434c02(0x12a)](_0xb62305=>PERMISSION_SET_FOLDER_NAME+'/'+_0xb62305[_0x434c02(0xfc)])[_0x434c02(0xfe)](';'),_0x6a6bd7=[{'field':_0x434c02(0xfc),'option':salesforce_1[_0x434c02(0x142)]['IN'],'value':_0xdc2112}],_0x2e271f=new logger_1[(_0x434c02(0x144))]();return new salesforce_1[(_0x434c02(0x137))](_0x229b6d,_0x4c80e8,_0x2e271f,_0x6a6bd7,null,[salesforce_1[_0x434c02(0x141)]['PERMISSION_SET']])[_0x434c02(0x136)]();}async function mergePermissionSets(_0x46311a,_0x570243){const _0x514cb4=a104_0x317000,_0x39be26=_0x570243['reduce']((_0x21bbe3,_0x18d7fd)=>_0x21bbe3[_0x514cb4(0x143)](_0x18d7fd[_0x514cb4(0x112)][_0x514cb4(0xfc)],_0x18d7fd),new Map());for(const _0x40fb69 of _0x46311a){const _0x1edd27=PERMISSION_SET_FOLDER_NAME+'/'+_0x40fb69[_0x514cb4(0xfc)],_0x5cc529=_0x39be26[_0x514cb4(0x135)](_0x1edd27);if(!_0x5cc529)continue;const _0x2f1b5f=await zip_1[_0x514cb4(0x12e)][_0x514cb4(0xfd)](_0x40fb69[_0x514cb4(0x10c)]),_0x493917=await _0x2f1b5f[_0x514cb4(0xff)][_0x1edd27][_0x514cb4(0x11a)](_0x514cb4(0x148)),_0x54c494=_0x5cc529[_0x514cb4(0xff)][_0x1edd27]['toString'](),_0x4d3371=await(0x0,extract_component_permissions_1['mergeComponentPermissions'])(_0x493917,_0x54c494,_0x40fb69[_0x514cb4(0x104)]),_0x424ed4=zip_1[_0x514cb4(0x12e)][_0x514cb4(0x14b)]();_0x424ed4[_0x514cb4(0x12d)](_0x1edd27,_0x4d3371),_0x40fb69['body']=await _0x424ed4[_0x514cb4(0x12b)]({'type':_0x514cb4(0x14c),'compression':_0x514cb4(0x154),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x1bf0ef,_0x2e3040,_0x253441){const _0x187763=a104_0x317000;for(const _0x2dd91d of _0x253441){if(_0x1bf0ef['every'](_0x2ae94e=>_0x2ae94e!==_0x2dd91d[_0x187763(0x104)]))continue;const _0x2633f6=await zip_1[_0x187763(0x12e)][_0x187763(0xfd)](_0x2dd91d['body']);for(const _0x5167db in _0x2633f6['files']){if(!_0x2633f6['files'][_0x5167db][_0x187763(0x10e)]){let _0x387987=await _0x2633f6[_0x187763(0xff)][_0x5167db][_0x187763(0x11a)](_0x187763(0x148));for(const _0x133bc3 of Object[_0x187763(0x115)](_0x2e3040)){const _0x53bbcc=new RegExp('%%'+_0x133bc3+'%%','g');_0x387987=_0x387987[_0x187763(0x158)](_0x53bbcc,_0x2e3040[_0x133bc3]);}_0x2633f6['file'](_0x5167db,_0x387987);}}_0x2dd91d[_0x187763(0x10c)]=await _0x2633f6[_0x187763(0x12b)]({'type':'base64','compression':_0x187763(0x154),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x1ef497,_0x8136b3){const _0x48f00e=a104_0x317000,_0x1084d1=new mdapi_writer_1[(_0x48f00e(0x13b))]({'components':_0x1ef497,'sourceDir':path_1[_0x48f00e(0x113)][_0x48f00e(0xfe)](process[_0x48f00e(0x126)](),_0x48f00e(0x11c),_0x8136b3,DEPLOY_DIR_NAME,_0x48f00e(0x10f)),'skipChildErrors':![]});await _0x1084d1[_0x48f00e(0x136)]();}async function generateAndWritePackageXML(_0x151bdc,_0x482621,_0x224075,_0xdb1933){const _0x1a4815=a104_0x317000,_0x36fe57=getComponentsTypeAndName(_0x151bdc,_0x482621),_0x5f41c6=[...new Set(_0x36fe57[_0x1a4815(0x12a)](_0x1b721e=>_0x1b721e[_0x1a4815(0x14e)]))],_0x1f3ed3={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0xdb1933}};for(const _0x444b39 of _0x5f41c6){const _0x2f611a=_0x36fe57[_0x1a4815(0x121)](_0x99a74=>_0x99a74['type']===_0x444b39)['map'](_0x37d5f5=>_0x37d5f5[_0x1a4815(0x138)]),_0x505327={'members':_0x2f611a,'name':_0x444b39};_0x1f3ed3[_0x1a4815(0x14a)]['types'][_0x1a4815(0x145)](_0x505327);}const _0x51238f=new xml2js_1['Builder']({'xmldec':{'version':_0x1a4815(0x11b),'encoding':'UTF-8'}}),_0x194e57=_0x51238f['buildObject'](_0x1f3ed3);await fs_internal_1['FS'][_0x1a4815(0x129)](path_1[_0x1a4815(0x113)][_0x1a4815(0xfe)](process[_0x1a4815(0x126)](),_0x1a4815(0x11c),_0x224075,DEPLOY_DIR_NAME,_0x1a4815(0x10f),_0x1a4815(0x139)),_0x194e57);}function getComponentsTypeAndName(_0x5d4b98,_0x54c4da){const _0x5e4305=a104_0x317000;return _0x5d4b98[_0x5e4305(0x106)]((_0x39b907,_0x25e567)=>{const _0x6578bb=_0x5e4305,_0x2f105d=_0x54c4da['find'](_0x5a371d=>_0x5a371d['Id']===_0x25e567[_0x6578bb(0x107)]);return _0x2f105d&&_0x39b907[_0x6578bb(0x145)]({'name':_0x2f105d['Component__r']['Component_Name__c'],'type':salesforce_1[_0x6578bb(0x133)][_0x6578bb(0x146)][_0x25e567['Name']]||_0x25e567[_0x6578bb(0x11e)]}),_0x39b907;},[]);}async function saveDestructiveChanges(_0x4d24a7,_0x43541e,_0x24b904,_0x3f7319){const _0x44bc0a=a104_0x317000,_0x2239c6=(await(0x0,fetch_attachments_1[_0x44bc0a(0x109)])(_0x4d24a7,_0x43541e))[_0x44bc0a(0x119)]();await fs_internal_1['FS'][_0x44bc0a(0x129)](path_1['default'][_0x44bc0a(0xfe)](process[_0x44bc0a(0x126)](),_0x44bc0a(0x11c),_0x3f7319,DEPLOY_DIR_NAME,'src',_0x24b904),_0x2239c6);}async function createDeployZip(_0x278311){const _0x1c0bb2=a104_0x317000,_0xc56161=new adm_zip_1['default']();return await _0xc56161[_0x1c0bb2(0x122)](path_1[_0x1c0bb2(0x113)][_0x1c0bb2(0xfe)](process[_0x1c0bb2(0x126)](),'.temp',_0x278311,DEPLOY_DIR_NAME)),_0xc56161;}async function insertZip(_0x424a4b,_0x4c274e,_0xa3ffbb,_0x4b28ec,_0x3bc05f,_0x554b17){const _0xe3d47f=a104_0x317000,_0x514784={'ParentId':_0x4c274e,'Name':'BUILD'+_0xa3ffbb,'Description':'BUILD'+_0x4b28ec,'Body':_0x3bc05f},{data:_0x2d797c}=await _0x424a4b[_0xe3d47f(0x157)](_0xe3d47f(0x131)+_0x554b17+_0xe3d47f(0x125),_0x514784);return _0x2d797c['id'];}