const a54_0x3ee240=a54_0x1d49;(function(_0x31bf9e,_0x2b5783){const _0x4c8287=a54_0x1d49,_0x2fedc=_0x31bf9e();while(!![]){try{const _0x45c291=parseInt(_0x4c8287(0x1ce))/0x1+parseInt(_0x4c8287(0x1b3))/0x2*(-parseInt(_0x4c8287(0x1d4))/0x3)+-parseInt(_0x4c8287(0x1a9))/0x4*(-parseInt(_0x4c8287(0x1ba))/0x5)+-parseInt(_0x4c8287(0x17f))/0x6+parseInt(_0x4c8287(0x184))/0x7+parseInt(_0x4c8287(0x1b2))/0x8*(parseInt(_0x4c8287(0x181))/0x9)+-parseInt(_0x4c8287(0x197))/0xa;if(_0x45c291===_0x2b5783)break;else _0x2fedc['push'](_0x2fedc['shift']());}catch(_0x3ccf1a){_0x2fedc['push'](_0x2fedc['shift']());}}}(a54_0x23d3,0x32f55));const a54_0x346c38=(function(){let _0x1feee0=!![];return function(_0x53bc71,_0x519ae4){const _0xb026d7=_0x1feee0?function(){const _0x1c181d=a54_0x1d49;if(_0x519ae4){const _0x5488c0=_0x519ae4[_0x1c181d(0x1bc)](_0x53bc71,arguments);return _0x519ae4=null,_0x5488c0;}}:function(){};return _0x1feee0=![],_0xb026d7;};}()),a54_0x4b8e9d=a54_0x346c38(this,function(){const _0x18bf90=a54_0x1d49;return a54_0x4b8e9d[_0x18bf90(0x1be)]()[_0x18bf90(0x18e)](_0x18bf90(0x1c2))[_0x18bf90(0x1be)]()[_0x18bf90(0x1b6)](a54_0x4b8e9d)[_0x18bf90(0x18e)]('(((.+)+)+)+$');});a54_0x4b8e9d();'use strict';var __importDefault=this&&this[a54_0x3ee240(0x1b8)]||function(_0x48acf2){const _0x483aa=a54_0x3ee240;return _0x48acf2&&_0x48acf2[_0x483aa(0x194)]?_0x48acf2:{'default':_0x48acf2};};Object['defineProperty'](exports,a54_0x3ee240(0x194),{'value':!![]}),exports[a54_0x3ee240(0x180)]=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require(a54_0x3ee240(0x1d5))),extract_component_permissions_1=require(a54_0x3ee240(0x1a7)),xml2js_1=require(a54_0x3ee240(0x195)),zip_1=require(a54_0x3ee240(0x19e)),mdapi_1=require(a54_0x3ee240(0x19f)),fs_internal_1=require(a54_0x3ee240(0x1a5)),promises_1=require(a54_0x3ee240(0x1b1)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a54_0x3ee240(0x1c5))),uuid_1=require('uuid'),DESTRUCTIVE_CHANGES_PER_NAME=a54_0x3ee240(0x19a),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a54_0x3ee240(0x1da);async function generateAndDeployZip({attachmentsId:_0x1f65dd,isExtractComponentsPermissions:_0x426bc0,preDestructiveAttachmentId:_0x825236,postDestructiveAttachmentId:_0x191c68,branchId:_0x118dbf,credentials:_0x24d3ff,metadataLogId:_0x3f8d19,environments:_0x4478e8,metaTypes:_0x55ad93},_0x43a5e9){const _0x1f1d75=a54_0x3ee240,_0x499963=(0x0,uuid_1['v4'])();try{const _0x2e7b7b=await components_api_1[_0x1f1d75(0x1c0)][_0x1f1d75(0x190)](_0x43a5e9,_0x1f65dd),_0x4110f6=_0x2e7b7b[_0x1f1d75(0x19d)]((_0xadc14f,_0x201d72)=>({..._0xadc14f,[_0x201d72['Id']]:_0x201d72['Name']}),{}),_0x361ac4=await getComponents(_0x2e7b7b,_0x43a5e9,_0x4110f6),_0x1864ac=await components_api_1['ComponentsApi']['fetchComponentsDetailsByComponentsHistory'](_0x43a5e9,_0x2e7b7b[_0x1f1d75(0x17e)](({ParentId:_0x3c68b4})=>_0x3c68b4))[_0x1f1d75(0x1db)](_0x480669=>components_api_1['ComponentsApi'][_0x1f1d75(0x1c1)](_0x480669));if(_0x426bc0){const _0x1eabc8=_0x361ac4[_0x1f1d75(0x188)](({fileType:_0x595d87})=>_0x595d87===_0x1f1d75(0x199)||_0x595d87===_0x1f1d75(0x1a6));await removePermission(_0x1eabc8,_0x1864ac);}await replaceEnvironments(_0x55ad93,_0x4478e8,_0x361ac4),await writeZip(_0x361ac4,_0x499963),await generateAndWritePackageXML(_0x2e7b7b,_0x1864ac,_0x499963);_0x825236&&await saveDestructiveChanges(_0x43a5e9,_0x825236,DESTRUCTIVE_CHANGES_PER_NAME,_0x499963);_0x191c68&&await saveDestructiveChanges(_0x43a5e9,_0x191c68,DESTRUCTIVE_CHANGES_POST_NAME,_0x499963);const _0x34007b=(await createDeployZip(_0x499963)[_0x1f1d75(0x1db)](_0x29ab32=>{return _0x29ab32;}))[_0x1f1d75(0x1d8)]()[_0x1f1d75(0x1be)](_0x1f1d75(0x19b));console[_0x1f1d75(0x1d9)](_0x1f1d75(0x1bf));const _0x9732be=_0x34007b[_0x1f1d75(0x19c)];if(_0x9732be>=components_api_1[_0x1f1d75(0x1bb)]){const _0x2c4ef9=await createDeployZip(_0x499963);console[_0x1f1d75(0x1d9)](_0x1f1d75(0x1d1));const [_0x23b269,_0x27ca51]=await components_api_1[_0x1f1d75(0x1c0)][_0x1f1d75(0x1b4)](_0x2c4ef9,_0x9732be),_0x1442d3=await insertZip(_0x43a5e9,_0x118dbf,_0x24d3ff[_0x1f1d75(0x1b9)],_0x3f8d19,_0x23b269[_0x1f1d75(0x1d8)]()[_0x1f1d75(0x1be)]('base64')),_0x39b2f7=await insertZip(_0x43a5e9,_0x118dbf,_0x24d3ff[_0x1f1d75(0x1b9)],_0x3f8d19,_0x27ca51[_0x1f1d75(0x1d8)]()['toString'](_0x1f1d75(0x19b)));return _0x1442d3+','+_0x39b2f7;}else return await insertZip(_0x43a5e9,_0x118dbf,_0x24d3ff[_0x1f1d75(0x1b9)],_0x3f8d19,_0x34007b);}catch(_0x3ef0cf){throw _0x3ef0cf;}finally{if(await fs_internal_1['FS'][_0x1f1d75(0x1b7)](path_1[_0x1f1d75(0x1bd)][_0x1f1d75(0x1d7)](process[_0x1f1d75(0x1c3)](),_0x1f1d75(0x18b),_0x499963)))await(0x0,promises_1['rm'])(path_1[_0x1f1d75(0x1bd)][_0x1f1d75(0x1d7)](process['cwd'](),'.temp',_0x499963),{'recursive':!![]});}}exports[a54_0x3ee240(0x180)]=generateAndDeployZip;async function getComponents(_0x2b5b8f,_0x1986df,_0x5d1a33){const _0xa5553=a54_0x3ee240,_0x405629=[],_0x417ce2=await components_api_1[_0xa5553(0x1c0)][_0xa5553(0x1cb)](_0x2b5b8f,_0x1986df);return await getComponentFromZip(_0x417ce2,_0x5d1a33)[_0xa5553(0x1db)](_0xbc02d=>{const _0x921ec3=_0xa5553;_0x405629[_0x921ec3(0x183)](..._0xbc02d);}),_0x405629;}function a54_0x23d3(){const _0x4665f8=['104256mYAejH','path','text','join','toBuffer','log','DEPLOYZIP','then','SALESFORCE_API_VERSION','values','fileName','map','27978bKAXEk','generateAndDeployZip','1510803GdgAIA','MDApiWriter','push','1352932nbKYWD','http://soap.sforce.com/2006/04/metadata','ParentId','async','filter','Name','src','.temp','writeFile','Package','search','file','fetchAttachmentsDetails','name','Component__r','addLocalFolder','__esModule','xml2js','unzip','2618420oJMNdp','Zip','Profile','destructiveChangesPre.xml','base64','length','reduce','../../git/parsers/utils/zip','../../git/parsers/mdapi','generateAsync','/sobjects/Attachment','keys','files','every','../../git/internal/fs.internal','PermissionSet','../utils/extract-component-permissions','types','316QVJfhO','indexOf','UTF-8','Component_Name__c','body','substring','package.xml','buildObject','fs/promises','8CZiSFx','18XlMzSb','splitZip','DEFLATE','constructor','exists','__importDefault','orgId','24005Adwomv','MAX_ZIP_SIZE','apply','default','toString','after\x20create\x20zip','ComponentsApi','removeNamespacePrefix','(((.+)+)+)+$','cwd','fetchAttachmentBody','adm-zip','find','Builder','type','BUILD','start','retrieveAttachments','post','/services/data/','47576AaFlQV','Body','1.0','after\x20create\x20second\x20zip','dir','fileType'];a54_0x23d3=function(){return _0x4665f8;};return a54_0x23d3();}async function getComponentFromZip(_0x3e4828,_0x505bd5){const _0x326c2c=a54_0x3ee240,_0x4a2641=[];for(const _0x494dd8 of _0x3e4828){const _0x1149b5=await zip_1['Zip'][_0x326c2c(0x196)](_0x494dd8[_0x326c2c(0x17c)][_0x326c2c(0x1cf)]);for(const _0x7eb26d in _0x1149b5[_0x326c2c(0x1a3)]){!_0x1149b5[_0x326c2c(0x1a3)][_0x7eb26d][_0x326c2c(0x1d2)]&&_0x4a2641['push']({'fileName':_0x7eb26d[_0x326c2c(0x1ae)](_0x7eb26d[_0x326c2c(0x1aa)]('/')+0x1),'fileType':_0x505bd5[_0x494dd8['id']],'body':_0x494dd8['values']['Body']});}}return _0x4a2641;}function a54_0x1d49(_0x2aacb4,_0x123e8d){const _0x3b5db6=a54_0x23d3();return a54_0x1d49=function(_0x4b8e9d,_0x346c38){_0x4b8e9d=_0x4b8e9d-0x17c;let _0x23d310=_0x3b5db6[_0x4b8e9d];return _0x23d310;},a54_0x1d49(_0x2aacb4,_0x123e8d);}async function removePermission(_0x5141a5,_0x34d947){const _0x431814=a54_0x3ee240;for(const _0x1711c8 of _0x5141a5){const _0x4aa937=await zip_1[_0x431814(0x198)]['unzip'](_0x1711c8[_0x431814(0x1ad)]),_0x3e9a5e=[];for(const _0x3c901a in _0x4aa937[_0x431814(0x1a3)]){!_0x4aa937['files'][_0x3c901a][_0x431814(0x1d2)]&&_0x3e9a5e['push']({'fileName':_0x3c901a,'body':await _0x4aa937['files'][_0x3c901a][_0x431814(0x187)](_0x431814(0x1d6))});}const _0x13b74f=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x3e9a5e[0x0][_0x431814(0x1ad)][_0x431814(0x1be)](),_0x34d947,_0x1711c8['fileType']),_0x6bf361=new xml2js_1['Builder']({'xmldec':{'version':_0x431814(0x1d0),'encoding':_0x431814(0x1ab)}}),_0x2f667b=_0x6bf361[_0x431814(0x1b0)](_0x13b74f),_0xbfc822=zip_1[_0x431814(0x198)]['createZip']();_0xbfc822[_0x431814(0x18f)](_0x3e9a5e[0x0][_0x431814(0x17d)],_0x2f667b),_0x1711c8[_0x431814(0x1ad)]=await _0xbfc822['generateAsync']({'type':_0x431814(0x19b),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x5d6dc0,_0x420e1b,_0x4791d9){const _0x1fa719=a54_0x3ee240;for(const _0x1031bd of _0x4791d9){if(_0x5d6dc0[_0x1fa719(0x1a4)](_0x42a483=>_0x42a483!==_0x1031bd[_0x1fa719(0x1d3)]))continue;const _0x14a1fa=await zip_1[_0x1fa719(0x198)][_0x1fa719(0x196)](_0x1031bd[_0x1fa719(0x1ad)]);for(const _0x5d243b in _0x14a1fa['files']){if(!_0x14a1fa[_0x1fa719(0x1a3)][_0x5d243b]['dir']){let _0x19b8bd=await _0x14a1fa[_0x1fa719(0x1a3)][_0x5d243b][_0x1fa719(0x187)](_0x1fa719(0x1d6));for(const _0x1b602f of Object[_0x1fa719(0x1a2)](_0x420e1b)){const _0x26113e=new RegExp('%%'+_0x1b602f+'%%','g');_0x19b8bd=_0x19b8bd['replace'](_0x26113e,_0x420e1b[_0x1b602f]);}_0x14a1fa[_0x1fa719(0x18f)](_0x5d243b,_0x19b8bd);}}_0x1031bd[_0x1fa719(0x1ad)]=await _0x14a1fa[_0x1fa719(0x1a0)]({'type':_0x1fa719(0x19b),'compression':_0x1fa719(0x1b5),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x4ca4c9,_0x199334){const _0x48cfb3=a54_0x3ee240,_0xde8102=new mdapi_1[(_0x48cfb3(0x182))]({'components':_0x4ca4c9,'sourceDir':path_1['default'][_0x48cfb3(0x1d7)](process['cwd'](),_0x48cfb3(0x18b),_0x199334,DEPLOY_DIR_NAME,_0x48cfb3(0x18a)),'skipChildErrors':![]});await _0xde8102[_0x48cfb3(0x1ca)]();}async function generateAndWritePackageXML(_0xbb3701,_0x4c656a,_0x3687a2){const _0x2af87b=a54_0x3ee240,_0x1c6f5=getComponentsTypeAndName(_0xbb3701,_0x4c656a),_0x122b80=[...new Set(_0x1c6f5['map'](_0xcd9eda=>_0xcd9eda[_0x2af87b(0x1c8)]))],_0xf911a9={'Package':{'$':{'xmlns':_0x2af87b(0x185)},'types':[],'version':''+constants_1[_0x2af87b(0x1dc)][_0x2af87b(0x1ae)](0x1)}};for(const _0x219ea0 of _0x122b80){const _0x545678=_0x1c6f5['filter'](_0x18ad0b=>_0x18ad0b[_0x2af87b(0x1c8)]===_0x219ea0)[_0x2af87b(0x17e)](_0x1104ba=>_0x1104ba[_0x2af87b(0x191)]),_0x271051={'members':_0x545678,'name':_0x219ea0};_0xf911a9[_0x2af87b(0x18d)][_0x2af87b(0x1a8)][_0x2af87b(0x183)](_0x271051);}const _0x155ff8=new xml2js_1[(_0x2af87b(0x1c7))]({'xmldec':{'version':_0x2af87b(0x1d0),'encoding':'UTF-8'}}),_0x1668c9=_0x155ff8[_0x2af87b(0x1b0)](_0xf911a9);await fs_internal_1['FS'][_0x2af87b(0x18c)](path_1[_0x2af87b(0x1bd)][_0x2af87b(0x1d7)](process['cwd'](),_0x2af87b(0x18b),_0x3687a2,DEPLOY_DIR_NAME,_0x2af87b(0x18a),_0x2af87b(0x1af)),_0x1668c9);}function getComponentsTypeAndName(_0x499080,_0x4dee4){const _0x5003d9=a54_0x3ee240;return _0x499080[_0x5003d9(0x19d)]((_0x17a07d,_0x56a035)=>{const _0x2e0c30=_0x5003d9,_0x5d52df=_0x4dee4[_0x2e0c30(0x1c6)](_0x5bd810=>_0x5bd810['Id']===_0x56a035[_0x2e0c30(0x186)]);return _0x5d52df&&_0x17a07d['push']({'name':_0x5d52df[_0x2e0c30(0x192)][_0x2e0c30(0x1ac)],'type':_0x56a035[_0x2e0c30(0x189)]}),_0x17a07d;},[]);}async function saveDestructiveChanges(_0x5ee2f5,_0x4409e4,_0x26e5fd,_0x2f3cd2){const _0x2de1c4=a54_0x3ee240,_0x187fda=(await components_api_1[_0x2de1c4(0x1c0)][_0x2de1c4(0x1c4)](_0x5ee2f5,_0x4409e4))[_0x2de1c4(0x1be)]();await fs_internal_1['FS'][_0x2de1c4(0x18c)](path_1[_0x2de1c4(0x1bd)][_0x2de1c4(0x1d7)](process[_0x2de1c4(0x1c3)](),_0x2de1c4(0x18b),_0x2f3cd2,DEPLOY_DIR_NAME,_0x2de1c4(0x18a),_0x26e5fd),_0x187fda);}async function createDeployZip(_0x52a381){const _0x1aacb7=a54_0x3ee240,_0x9f721f=new adm_zip_1[(_0x1aacb7(0x1bd))]();return await _0x9f721f[_0x1aacb7(0x193)](path_1[_0x1aacb7(0x1bd)][_0x1aacb7(0x1d7)](process[_0x1aacb7(0x1c3)](),_0x1aacb7(0x18b),_0x52a381,DEPLOY_DIR_NAME)),_0x9f721f;}async function insertZip(_0x3528c7,_0x33300a,_0x1bbdad,_0x5ab0e3,_0x562d3d){const _0x5b3ba9=a54_0x3ee240,_0x6ae480={'ParentId':_0x33300a,'Name':_0x5b3ba9(0x1c9)+_0x1bbdad,'Description':'BUILD'+_0x5ab0e3,'Body':_0x562d3d},{data:_0xb56213}=await _0x3528c7[_0x5b3ba9(0x1cc)](_0x5b3ba9(0x1cd)+constants_1[_0x5b3ba9(0x1dc)]+_0x5b3ba9(0x1a1),_0x6ae480);return _0xb56213['id'];}