const a104_0x4bfb5a=a104_0x44b4;(function(_0x15c5e7,_0x1fe1a0){const _0x185cbd=a104_0x44b4,_0x1810ed=_0x15c5e7();while(!![]){try{const _0x1a684d=parseInt(_0x185cbd(0xc4))/0x1+-parseInt(_0x185cbd(0xc8))/0x2*(-parseInt(_0x185cbd(0x95))/0x3)+-parseInt(_0x185cbd(0xa0))/0x4+parseInt(_0x185cbd(0x87))/0x5+-parseInt(_0x185cbd(0xda))/0x6*(parseInt(_0x185cbd(0x90))/0x7)+parseInt(_0x185cbd(0xad))/0x8*(-parseInt(_0x185cbd(0xcf))/0x9)+-parseInt(_0x185cbd(0x91))/0xa*(-parseInt(_0x185cbd(0x82))/0xb);if(_0x1a684d===_0x1fe1a0)break;else _0x1810ed['push'](_0x1810ed['shift']());}catch(_0x51acf2){_0x1810ed['push'](_0x1810ed['shift']());}}}(a104_0x5a01,0xcde8f));function a104_0x44b4(_0x437a07,_0x253653){const _0xfd1cae=a104_0x5a01();return a104_0x44b4=function(_0x1bf051,_0x356205){_0x1bf051=_0x1bf051-0x82;let _0x5a0164=_0xfd1cae[_0x1bf051];return _0x5a0164;},a104_0x44b4(_0x437a07,_0x253653);}const a104_0x356205=(function(){let _0x1608ab=!![];return function(_0x2a6333,_0x4d159d){const _0x2ce37b=_0x1608ab?function(){const _0x1be659=a104_0x44b4;if(_0x4d159d){const _0x24882c=_0x4d159d[_0x1be659(0xcc)](_0x2a6333,arguments);return _0x4d159d=null,_0x24882c;}}:function(){};return _0x1608ab=![],_0x2ce37b;};}()),a104_0x1bf051=a104_0x356205(this,function(){const _0x4f527b=a104_0x44b4;return a104_0x1bf051[_0x4f527b(0x88)]()[_0x4f527b(0xaa)](_0x4f527b(0xe3))[_0x4f527b(0x88)]()['constructor'](a104_0x1bf051)[_0x4f527b(0xaa)]('(((.+)+)+)+$');});a104_0x1bf051();'use strict';var __importDefault=this&&this[a104_0x4bfb5a(0xc6)]||function(_0x413b25){const _0x189bae=a104_0x4bfb5a;return _0x413b25&&_0x413b25[_0x189bae(0xd4)]?_0x413b25:{'default':_0x413b25};};Object[a104_0x4bfb5a(0xa4)](exports,a104_0x4bfb5a(0xd4),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require(a104_0x4bfb5a(0x9d))),extract_component_permissions_1=require(a104_0x4bfb5a(0xc3)),logger_1=require(a104_0x4bfb5a(0xd5)),xml2js_1=require(a104_0x4bfb5a(0xdc)),zip_1=require(a104_0x4bfb5a(0xb2)),mdapi_writer_1=require(a104_0x4bfb5a(0xc0)),fs_internal_1=require(a104_0x4bfb5a(0x9b)),promises_1=require('fs/promises'),components_api_1=require(a104_0x4bfb5a(0xa1)),adm_zip_1=__importDefault(require(a104_0x4bfb5a(0xbc))),uuid_1=require(a104_0x4bfb5a(0x9e)),fetch_attachments_1=require(a104_0x4bfb5a(0xb5)),salesforce_1=require(a104_0x4bfb5a(0xc5)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a104_0x4bfb5a(0xc9),DEPLOY_DIR_NAME=a104_0x4bfb5a(0x83),PERMISSION_SET_FOLDER_NAME=a104_0x4bfb5a(0xa8);async function generateAndDeployZip({attachmentsId:_0x28d332,isExtractComponentsPermissionSets:_0x59deb1,isExtractComponentsProfiles:_0x497218,preDestructiveAttachmentId:_0x3fb00b,postDestructiveAttachmentId:_0x44a4c7,branchId:_0x3c6201,credentials:_0x4cb0d7,metadataLogId:_0x550e4c,environments:_0x116af2,metaTypes:_0x57edb3,apiVersion:_0x400bd5},_0x4ebd8b,_0x3439a6){const _0x1232a2=a104_0x4bfb5a;var _0x3bdff3;const _0x7947a4=(0x0,uuid_1['v4'])();try{const _0x148cda=await(0x0,fetch_attachments_1[_0x1232a2(0xbd)])(_0x4ebd8b,_0x28d332),_0x2302b6=_0x148cda[_0x1232a2(0xe6)]((_0xe55a49,_0x5a3f7c)=>({..._0xe55a49,[_0x5a3f7c['Id']]:_0x5a3f7c['Name']}),{}),_0x241e66=await getComponents(_0x148cda,_0x4ebd8b,_0x2302b6),_0x1ac47a=await components_api_1[_0x1232a2(0xc1)]['fetchComponentsDetailsByComponentsHistory'](_0x4ebd8b,_0x148cda['map'](({ParentId:_0x183a13})=>_0x183a13),_0x400bd5)[_0x1232a2(0xe2)](_0x470526=>components_api_1[_0x1232a2(0xc1)][_0x1232a2(0xb8)](_0x470526));if(_0x497218){const _0xdc7f77=_0x241e66['filter'](({fileType:_0x2a93c3})=>_0x2a93c3==='Profile');await removePermission(_0xdc7f77,_0x1ac47a);}const _0x1a6ba2=_0x241e66['filter'](({fileType:_0x39876d})=>_0x39876d===_0x1232a2(0xdd));if(_0x1a6ba2[_0x1232a2(0x94)]&&_0x59deb1){await removePermission(_0x1a6ba2,_0x1ac47a);const {items:_0x5ebfa8}=await retrieveTargetPermissionSets(_0x1a6ba2,_0x400bd5,_0x3439a6);await mergePermissionSets(_0x1a6ba2,((_0x3bdff3=_0x5ebfa8['PermissionSet'])===null||_0x3bdff3===void 0x0?void 0x0:_0x3bdff3[_0x1232a2(0xb1)])||[]);}await replaceEnvironments(_0x57edb3,_0x116af2,_0x241e66),await writeZip(_0x241e66,_0x7947a4),await generateAndWritePackageXML(_0x148cda,_0x1ac47a,_0x7947a4,_0x400bd5);_0x3fb00b&&await saveDestructiveChanges(_0x4ebd8b,_0x3fb00b,DESTRUCTIVE_CHANGES_PER_NAME,_0x7947a4);_0x44a4c7&&await saveDestructiveChanges(_0x4ebd8b,_0x44a4c7,DESTRUCTIVE_CHANGES_POST_NAME,_0x7947a4);const _0x235c2c=(await createDeployZip(_0x7947a4)[_0x1232a2(0xe2)](_0x3c869f=>{return _0x3c869f;}))[_0x1232a2(0xd9)]()['toString']('base64'),_0x1a86e3=_0x235c2c[_0x1232a2(0x94)];if(_0x1a86e3>=components_api_1['MAX_ZIP_SIZE']){const _0x522f41=await createDeployZip(_0x7947a4),[_0x48c8fb,_0x25b056]=await components_api_1[_0x1232a2(0xc1)][_0x1232a2(0xca)](_0x522f41,_0x1a86e3),_0x204b66=await insertZip(_0x4ebd8b,_0x3c6201,_0x4cb0d7[_0x1232a2(0x8f)],_0x550e4c,_0x48c8fb[_0x1232a2(0xd9)]()[_0x1232a2(0x88)](_0x1232a2(0xe4)),_0x400bd5),_0x33c5ae=await insertZip(_0x4ebd8b,_0x3c6201,_0x4cb0d7[_0x1232a2(0x8f)],_0x550e4c,_0x25b056['toBuffer']()['toString']('base64'),_0x400bd5);return _0x204b66+','+_0x33c5ae;}else return await insertZip(_0x4ebd8b,_0x3c6201,_0x4cb0d7[_0x1232a2(0x8f)],_0x550e4c,_0x235c2c,_0x400bd5);}catch(_0x50dfca){throw _0x50dfca;}finally{if(await fs_internal_1['FS'][_0x1232a2(0xdf)](path_1['default']['join'](process[_0x1232a2(0xbb)](),_0x1232a2(0x9f),_0x7947a4)))await(0x0,promises_1['rm'])(path_1[_0x1232a2(0xdb)][_0x1232a2(0xa7)](process['cwd'](),_0x1232a2(0x9f),_0x7947a4),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x430c72,_0x2aa280,_0x6dd6f4){const _0x3f256e=a104_0x4bfb5a,_0x22a584=[],_0x66fe2f=await(0x0,fetch_attachments_1[_0x3f256e(0x8c)])(_0x430c72,_0x2aa280);return await getComponentFromZip(_0x66fe2f,_0x6dd6f4)['then'](_0x3ed827=>{const _0x240b4e=_0x3f256e;_0x22a584[_0x240b4e(0x99)](..._0x3ed827);}),_0x22a584;}async function getComponentFromZip(_0x4537ae,_0x1731c2){const _0x1728f7=a104_0x4bfb5a,_0x5d0f25=[];for(const _0x34ac36 of _0x4537ae){const _0x2706f8=await zip_1['Zip'][_0x1728f7(0xb0)](_0x34ac36[_0x1728f7(0xb3)][_0x1728f7(0x86)]);for(const _0x902e39 in _0x2706f8[_0x1728f7(0xe5)]){!_0x2706f8[_0x1728f7(0xe5)][_0x902e39][_0x1728f7(0x8e)]&&_0x5d0f25[_0x1728f7(0x99)]({'fileName':_0x902e39[_0x1728f7(0xe8)](_0x902e39[_0x1728f7(0xa5)]('/')+0x1),'fileType':_0x1731c2[_0x34ac36['id']],'body':_0x34ac36[_0x1728f7(0xb3)][_0x1728f7(0x86)]});}}return _0x5d0f25;}async function removePermission(_0x3645c1,_0x36e076){const _0xa09fab=a104_0x4bfb5a;for(const _0x4c34e4 of _0x3645c1){const _0x15c24b=await zip_1[_0xa09fab(0xde)][_0xa09fab(0xb0)](_0x4c34e4['body']),_0x5c61db=[];for(const _0x58b73d in _0x15c24b['files']){!_0x15c24b[_0xa09fab(0xe5)][_0x58b73d][_0xa09fab(0x8e)]&&_0x5c61db[_0xa09fab(0x99)]({'fileName':_0x58b73d,'body':await _0x15c24b[_0xa09fab(0xe5)][_0x58b73d][_0xa09fab(0xe7)](_0xa09fab(0x84))});}const _0x2e1ff7=await(0x0,extract_component_permissions_1[_0xa09fab(0xac)])(_0x5c61db[0x0][_0xa09fab(0xb7)]['toString'](),_0x36e076,_0x4c34e4[_0xa09fab(0xaf)]),_0x2bde58=new xml2js_1[(_0xa09fab(0xcb))]({'xmldec':{'version':_0xa09fab(0xa6),'encoding':_0xa09fab(0xb4)}}),_0xe6e186=_0x2bde58['buildObject'](_0x2e1ff7),_0x35106e=zip_1[_0xa09fab(0xde)][_0xa09fab(0xd8)]();_0x35106e[_0xa09fab(0xab)](_0x5c61db[0x0][_0xa09fab(0x9a)],_0xe6e186),_0x4c34e4['body']=await _0x35106e[_0xa09fab(0xd3)]({'type':_0xa09fab(0xe4),'compression':_0xa09fab(0xa2),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x2ec751,_0x5ed80d,_0x5e48b4){const _0x3bcfdc=a104_0x4bfb5a,_0x54ba20=_0x2ec751[_0x3bcfdc(0xe1)](_0xec52ba=>PERMISSION_SET_FOLDER_NAME+'/'+_0xec52ba[_0x3bcfdc(0x9a)])[_0x3bcfdc(0xa7)](';'),_0x165b75=[{'field':'fileName','option':salesforce_1[_0x3bcfdc(0x92)]['IN'],'value':_0x54ba20}],_0x379e84=new logger_1[(_0x3bcfdc(0xbf))]();return new salesforce_1['PartialRetrieve'](_0x5ed80d,_0x5e48b4,_0x379e84,_0x165b75,null,[salesforce_1[_0x3bcfdc(0xb9)]['PERMISSION_SET']])[_0x3bcfdc(0xba)]();}async function mergePermissionSets(_0x525086,_0x115153){const _0x54f0ba=a104_0x4bfb5a,_0x4de297=_0x115153['reduce']((_0x3f360b,_0x2de8a)=>_0x3f360b['set'](_0x2de8a[_0x54f0ba(0xc2)][_0x54f0ba(0x9a)],_0x2de8a),new Map());for(const _0x2e7bfb of _0x525086){const _0x3c6b22=PERMISSION_SET_FOLDER_NAME+'/'+_0x2e7bfb[_0x54f0ba(0x9a)],_0x27dff0=_0x4de297[_0x54f0ba(0xa3)](_0x3c6b22);if(!_0x27dff0)continue;const _0x450acd=await zip_1[_0x54f0ba(0xde)]['unzip'](_0x2e7bfb[_0x54f0ba(0xb7)]),_0xbfbb0a=await _0x450acd[_0x54f0ba(0xe5)][_0x3c6b22]['async'](_0x54f0ba(0x84)),_0x165df0=_0x27dff0[_0x54f0ba(0xe5)][_0x3c6b22][_0x54f0ba(0x88)](),_0x15c168=await(0x0,extract_component_permissions_1['mergeComponentPermissions'])(_0xbfbb0a,_0x165df0,_0x2e7bfb[_0x54f0ba(0xaf)]),_0x4921c6=zip_1['Zip'][_0x54f0ba(0xd8)]();_0x4921c6['file'](_0x3c6b22,_0x15c168),_0x2e7bfb[_0x54f0ba(0xb7)]=await _0x4921c6[_0x54f0ba(0xd3)]({'type':_0x54f0ba(0xe4),'compression':_0x54f0ba(0xa2),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x37a7c1,_0x2c2c70,_0x1da354){const _0x8e62c8=a104_0x4bfb5a;for(const _0x2170ab of _0x1da354){if(_0x37a7c1[_0x8e62c8(0xbe)](_0x12f8a9=>_0x12f8a9!==_0x2170ab['fileType']))continue;const _0x5adef0=await zip_1[_0x8e62c8(0xde)]['unzip'](_0x2170ab[_0x8e62c8(0xb7)]);for(const _0x124466 in _0x5adef0['files']){if(!_0x5adef0['files'][_0x124466][_0x8e62c8(0x8e)]){let _0x5cd202=await _0x5adef0[_0x8e62c8(0xe5)][_0x124466][_0x8e62c8(0xe7)](_0x8e62c8(0x84));for(const _0x52dd13 of Object[_0x8e62c8(0xd1)](_0x2c2c70)){const _0x27222d=new RegExp('%%'+_0x52dd13+'%%','g');_0x5cd202=_0x5cd202['replace'](_0x27222d,_0x2c2c70[_0x52dd13]);}_0x5adef0[_0x8e62c8(0xab)](_0x124466,_0x5cd202);}}_0x2170ab[_0x8e62c8(0xb7)]=await _0x5adef0[_0x8e62c8(0xd3)]({'type':_0x8e62c8(0xe4),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x175ee9,_0x549d18){const _0x103688=a104_0x4bfb5a,_0x21ddba=new mdapi_writer_1[(_0x103688(0x85))]({'components':_0x175ee9,'sourceDir':path_1[_0x103688(0xdb)][_0x103688(0xa7)](process['cwd'](),'.temp',_0x549d18,DEPLOY_DIR_NAME,_0x103688(0x96)),'skipChildErrors':![]});await _0x21ddba['execute']();}function a104_0x5a01(){const _0x1a69bc=['fileName','../../git/internal/fs.internal','Component__r','path','uuid','.temp','6688224NsYPbz','../utils/components-api','DEFLATE','get','defineProperty','indexOf','1.0','join','permissionsets','Package','search','file','extractComponentPermissions','86648WkXTRV','fetchAttachmentBody','fileType','unzip','components','../../git/parsers/utils/zip','values','UTF-8','../../shared/utils/fetch-attachments','Name','body','removeNamespacePrefix','MetadataType','execute','cwd','adm-zip','fetchAttachmentsDetailsById','every','Logger','../../git/writers/mdapi.writer','ComponentsApi','listMetadataItem','../utils/extract-component-permissions','90437Rwfnny','@flosum/salesforce','__importDefault','package.xml','177794EhNSGq','destructiveChangesPost.xml','splitZip','Builder','apply','writeFile','filter','954sIOARu','BUILD','keys','addLocalFolder','generateAsync','__esModule','../classes/logger','ParentId','/services/data/v','createZip','toBuffer','114SfOSoR','default','xml2js','PermissionSet','Zip','exists','type','map','then','(((.+)+)+)+$','base64','files','reduce','async','substring','3065359yZpkJT','DEPLOYZIP','text','MDApiWriter','Body','3884300xyFusQ','toString','post','/sobjects/Attachment','Component_Name__c','retrieveAttachments','name','dir','orgId','142583xWjYKq','60iuJGtw','DeclarativeFilterOptions','buildObject','length','51eoaYSe','src','FOLDER_TO_METADATA_TYPE_MAP','types','push'];a104_0x5a01=function(){return _0x1a69bc;};return a104_0x5a01();}async function generateAndWritePackageXML(_0x387c85,_0x6689cd,_0x5548a1,_0x2a65b0){const _0x22bdd4=a104_0x4bfb5a,_0x590c61=getComponentsTypeAndName(_0x387c85,_0x6689cd),_0x544723=[...new Set(_0x590c61[_0x22bdd4(0xe1)](_0x46ca33=>_0x46ca33[_0x22bdd4(0xe0)]))],_0x5aea03={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x2a65b0}};for(const _0x1fb715 of _0x544723){const _0x1cabc6=_0x590c61[_0x22bdd4(0xce)](_0xa2c588=>_0xa2c588['type']===_0x1fb715)[_0x22bdd4(0xe1)](_0x813e4e=>_0x813e4e[_0x22bdd4(0x8d)]),_0x2c1d8e={'members':_0x1cabc6,'name':_0x1fb715};_0x5aea03[_0x22bdd4(0xa9)][_0x22bdd4(0x98)][_0x22bdd4(0x99)](_0x2c1d8e);}const _0x467680=new xml2js_1[(_0x22bdd4(0xcb))]({'xmldec':{'version':_0x22bdd4(0xa6),'encoding':'UTF-8'}}),_0x38076e=_0x467680[_0x22bdd4(0x93)](_0x5aea03);await fs_internal_1['FS'][_0x22bdd4(0xcd)](path_1[_0x22bdd4(0xdb)][_0x22bdd4(0xa7)](process[_0x22bdd4(0xbb)](),_0x22bdd4(0x9f),_0x5548a1,DEPLOY_DIR_NAME,_0x22bdd4(0x96),_0x22bdd4(0xc7)),_0x38076e);}function getComponentsTypeAndName(_0xae3179,_0x545025){return _0xae3179['reduce']((_0x1c7d2c,_0x3af0d1)=>{const _0xff5e4b=a104_0x44b4,_0x1e5770=_0x545025['find'](_0x557c7e=>_0x557c7e['Id']===_0x3af0d1[_0xff5e4b(0xd6)]);return _0x1e5770&&_0x1c7d2c[_0xff5e4b(0x99)]({'name':_0x1e5770[_0xff5e4b(0x9c)][_0xff5e4b(0x8b)],'type':salesforce_1['MetadataConstants'][_0xff5e4b(0x97)][_0x3af0d1[_0xff5e4b(0xb6)]]||_0x3af0d1[_0xff5e4b(0xb6)]}),_0x1c7d2c;},[]);}async function saveDestructiveChanges(_0x6ef86,_0x2271ed,_0x3f92d5,_0x49d369){const _0x9878e3=a104_0x4bfb5a,_0x4b9bdd=(await(0x0,fetch_attachments_1[_0x9878e3(0xae)])(_0x6ef86,_0x2271ed))[_0x9878e3(0x88)]();await fs_internal_1['FS'][_0x9878e3(0xcd)](path_1[_0x9878e3(0xdb)][_0x9878e3(0xa7)](process[_0x9878e3(0xbb)](),'.temp',_0x49d369,DEPLOY_DIR_NAME,_0x9878e3(0x96),_0x3f92d5),_0x4b9bdd);}async function createDeployZip(_0x487518){const _0x205655=a104_0x4bfb5a,_0x5c6095=new adm_zip_1['default']();return await _0x5c6095[_0x205655(0xd2)](path_1[_0x205655(0xdb)]['join'](process[_0x205655(0xbb)](),_0x205655(0x9f),_0x487518,DEPLOY_DIR_NAME)),_0x5c6095;}async function insertZip(_0x369365,_0x121a90,_0x3d79e6,_0x3453f8,_0x125902,_0x32297a){const _0x1191c0=a104_0x4bfb5a,_0x5e7d3b={'ParentId':_0x121a90,'Name':_0x1191c0(0xd0)+_0x3d79e6,'Description':_0x1191c0(0xd0)+_0x3453f8,'Body':_0x125902},{data:_0x4f8a7b}=await _0x369365[_0x1191c0(0x89)](_0x1191c0(0xd7)+_0x32297a+_0x1191c0(0x8a),_0x5e7d3b);return _0x4f8a7b['id'];}