const a105_0x164e07=a105_0x49bf;(function(_0x43fc72,_0x4627d7){const _0x359347=a105_0x49bf,_0x4d666e=_0x43fc72();while(!![]){try{const _0x596a79=parseInt(_0x359347(0x17b))/0x1+parseInt(_0x359347(0x18c))/0x2*(-parseInt(_0x359347(0x154))/0x3)+parseInt(_0x359347(0x1a1))/0x4+parseInt(_0x359347(0x1a4))/0x5+-parseInt(_0x359347(0x14d))/0x6+parseInt(_0x359347(0x199))/0x7+-parseInt(_0x359347(0x182))/0x8*(parseInt(_0x359347(0x15b))/0x9);if(_0x596a79===_0x4627d7)break;else _0x4d666e['push'](_0x4d666e['shift']());}catch(_0x2f07a0){_0x4d666e['push'](_0x4d666e['shift']());}}}(a105_0x38e4,0xd1fb4));const a105_0x6a804c=(function(){let _0x4e24eb=!![];return function(_0x50ffe8,_0x4a9f0f){const _0x12084f=_0x4e24eb?function(){const _0x2101cc=a105_0x49bf;if(_0x4a9f0f){const _0x22988d=_0x4a9f0f[_0x2101cc(0x15c)](_0x50ffe8,arguments);return _0x4a9f0f=null,_0x22988d;}}:function(){};return _0x4e24eb=![],_0x12084f;};}()),a105_0x5d404e=a105_0x6a804c(this,function(){const _0xa88571=a105_0x49bf;return a105_0x5d404e[_0xa88571(0x1a8)]()[_0xa88571(0x185)](_0xa88571(0x157))[_0xa88571(0x1a8)]()['constructor'](a105_0x5d404e)[_0xa88571(0x185)](_0xa88571(0x157));});a105_0x5d404e();'use strict';var __importDefault=this&&this[a105_0x164e07(0x1a2)]||function(_0x88c2b8){return _0x88c2b8&&_0x88c2b8['__esModule']?_0x88c2b8:{'default':_0x88c2b8};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require(a105_0x164e07(0x17c))),extract_component_permissions_1=require(a105_0x164e07(0x164)),logger_1=require(a105_0x164e07(0x155)),xml2js_1=require(a105_0x164e07(0x151)),zip_1=require(a105_0x164e07(0x184)),mdapi_writer_1=require(a105_0x164e07(0x1a3)),fs_internal_1=require(a105_0x164e07(0x191)),promises_1=require(a105_0x164e07(0x1a7)),components_api_1=require(a105_0x164e07(0x161)),adm_zip_1=__importDefault(require(a105_0x164e07(0x186))),uuid_1=require('uuid'),fetch_attachments_1=require(a105_0x164e07(0x197)),salesforce_1=require(a105_0x164e07(0x187)),DESTRUCTIVE_CHANGES_PER_NAME=a105_0x164e07(0x162),DESTRUCTIVE_CHANGES_POST_NAME=a105_0x164e07(0x171),DEPLOY_DIR_NAME=a105_0x164e07(0x15f),PERMISSION_SET_FOLDER_NAME=a105_0x164e07(0x192);async function generateAndDeployZip({attachmentsId:_0x4e070a,isExtractComponentsPermissionSets:_0x311c3b,isExtractComponentsProfiles:_0x5a0a8e,preDestructiveAttachmentId:_0x1a4577,postDestructiveAttachmentId:_0x84a5ce,branchId:_0x723475,credentials:_0x1d1c00,metadataLogId:_0x8fdac9,environments:_0x3ab5a3,metaTypes:_0x28eb5d,apiVersion:_0x2fc476},_0x533efb,_0x517e83){const _0x5777b3=a105_0x164e07;var _0xf07a92;const _0x2d5a92=(0x0,uuid_1['v4'])();try{const _0x55298c=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x533efb,_0x4e070a),_0x3d1d00=_0x55298c[_0x5777b3(0x150)]((_0x2b6754,_0x14ede6)=>({..._0x2b6754,[_0x14ede6['Id']]:_0x14ede6[_0x5777b3(0x180)]}),{}),_0x5326c1=await getComponents(_0x55298c,_0x533efb,_0x3d1d00),_0x46f59b=await components_api_1['ComponentsApi']['fetchComponentsDetailsByComponentsHistory'](_0x533efb,_0x55298c[_0x5777b3(0x172)](({ParentId:_0x57e8c8})=>_0x57e8c8),_0x2fc476)[_0x5777b3(0x167)](_0x593544=>components_api_1[_0x5777b3(0x174)]['removeNamespacePrefix'](_0x593544));if(_0x5a0a8e){const _0x5ebf7c=_0x5326c1[_0x5777b3(0x188)](({fileType:_0x15e565})=>_0x15e565==='Profile');await removePermission(_0x5ebf7c,_0x46f59b);}const _0x45b952=_0x5326c1['filter'](({fileType:_0x50b785})=>_0x50b785===_0x5777b3(0x16f));if(_0x45b952[_0x5777b3(0x1a6)]&&_0x311c3b){await removePermission(_0x45b952,_0x46f59b);const {items:_0x41f3bf}=await retrieveTargetPermissionSets(_0x45b952,_0x2fc476,_0x517e83);await mergePermissionSets(_0x45b952,((_0xf07a92=_0x41f3bf[_0x5777b3(0x16f)])===null||_0xf07a92===void 0x0?void 0x0:_0xf07a92[_0x5777b3(0x1aa)])||[]);}await replaceEnvironments(_0x28eb5d,_0x3ab5a3,_0x5326c1),await writeZip(_0x5326c1,_0x2d5a92),await generateAndWritePackageXML(_0x55298c,_0x46f59b,_0x2d5a92,_0x2fc476);_0x1a4577&&await saveDestructiveChanges(_0x533efb,_0x1a4577,DESTRUCTIVE_CHANGES_PER_NAME,_0x2d5a92);_0x84a5ce&&await saveDestructiveChanges(_0x533efb,_0x84a5ce,DESTRUCTIVE_CHANGES_POST_NAME,_0x2d5a92);const _0x172b57=(await createDeployZip(_0x2d5a92)[_0x5777b3(0x167)](_0x37d5c8=>{return _0x37d5c8;}))[_0x5777b3(0x153)]()[_0x5777b3(0x1a8)](_0x5777b3(0x14f)),_0x170875=_0x172b57[_0x5777b3(0x1a6)];if(_0x170875>=components_api_1[_0x5777b3(0x170)]){const _0x23f2ff=await createDeployZip(_0x2d5a92),[_0x16ce01,_0x10f1af]=await components_api_1['ComponentsApi'][_0x5777b3(0x194)](_0x23f2ff,_0x170875),_0x1767f9=await insertZip(_0x533efb,_0x723475,_0x1d1c00[_0x5777b3(0x17a)],_0x8fdac9,_0x16ce01[_0x5777b3(0x153)]()[_0x5777b3(0x1a8)](_0x5777b3(0x14f)),_0x2fc476),_0x13fe24=await insertZip(_0x533efb,_0x723475,_0x1d1c00[_0x5777b3(0x17a)],_0x8fdac9,_0x10f1af[_0x5777b3(0x153)]()[_0x5777b3(0x1a8)]('base64'),_0x2fc476);return _0x1767f9+','+_0x13fe24;}else return await insertZip(_0x533efb,_0x723475,_0x1d1c00[_0x5777b3(0x17a)],_0x8fdac9,_0x172b57,_0x2fc476);}catch(_0x347561){throw _0x347561;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x5777b3(0x18b)][_0x5777b3(0x17f)](process[_0x5777b3(0x165)](),'.temp',_0x2d5a92)))await(0x0,promises_1['rm'])(path_1[_0x5777b3(0x18b)][_0x5777b3(0x17f)](process[_0x5777b3(0x165)](),_0x5777b3(0x195),_0x2d5a92),{'recursive':!![]});}}exports[a105_0x164e07(0x1a5)]=generateAndDeployZip;async function getComponents(_0x2035bc,_0xd1d552,_0x3369aa){const _0x2c3c0e=a105_0x164e07,_0x143088=[],_0x5921be=await(0x0,fetch_attachments_1[_0x2c3c0e(0x179)])(_0x2035bc,_0xd1d552);return await getComponentFromZip(_0x5921be,_0x3369aa)['then'](_0x1d5cb7=>{const _0x1e0a38=_0x2c3c0e;_0x143088[_0x1e0a38(0x1ac)](..._0x1d5cb7);}),_0x143088;}async function getComponentFromZip(_0x32d864,_0x408f2c){const _0x32fea7=a105_0x164e07,_0x24598f=[];for(const _0x19735d of _0x32d864){const _0x27ac99=await zip_1[_0x32fea7(0x16a)][_0x32fea7(0x19a)](_0x19735d[_0x32fea7(0x1ab)][_0x32fea7(0x16e)]);for(const _0x33e6a2 in _0x27ac99[_0x32fea7(0x196)]){!_0x27ac99['files'][_0x33e6a2]['dir']&&_0x24598f[_0x32fea7(0x1ac)]({'fileName':_0x33e6a2[_0x32fea7(0x1ae)](_0x33e6a2[_0x32fea7(0x1a0)]('/')+0x1),'fileType':_0x408f2c[_0x19735d['id']],'body':_0x19735d[_0x32fea7(0x1ab)][_0x32fea7(0x16e)]});}}return _0x24598f;}async function removePermission(_0x3d6b62,_0x30920d){const _0x17839f=a105_0x164e07;for(const _0x2f7f4c of _0x3d6b62){const _0x348297=await zip_1[_0x17839f(0x16a)][_0x17839f(0x19a)](_0x2f7f4c[_0x17839f(0x1ad)]),_0xeae856=[];for(const _0x86853f in _0x348297[_0x17839f(0x196)]){!_0x348297[_0x17839f(0x196)][_0x86853f][_0x17839f(0x183)]&&_0xeae856[_0x17839f(0x1ac)]({'fileName':_0x86853f,'body':await _0x348297[_0x17839f(0x196)][_0x86853f][_0x17839f(0x15e)](_0x17839f(0x16b))});}const _0x2aa668=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0xeae856[0x0][_0x17839f(0x1ad)][_0x17839f(0x1a8)](),_0x30920d,_0x2f7f4c['fileType']),_0x375517=new xml2js_1[(_0x17839f(0x152))]({'xmldec':{'version':'1.0','encoding':_0x17839f(0x17d)}}),_0x3eaa6a=_0x375517[_0x17839f(0x17e)](_0x2aa668),_0x4c2d09=zip_1[_0x17839f(0x16a)][_0x17839f(0x160)]();_0x4c2d09[_0x17839f(0x177)](_0xeae856[0x0][_0x17839f(0x18e)],_0x3eaa6a),_0x2f7f4c[_0x17839f(0x1ad)]=await _0x4c2d09[_0x17839f(0x163)]({'type':_0x17839f(0x14f),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x4383ed,_0x1f612e,_0x2c4f39){const _0xa820f7=a105_0x164e07,_0x5b2aa5=_0x4383ed['map'](_0x27a6a8=>PERMISSION_SET_FOLDER_NAME+'/'+_0x27a6a8['fileName'])[_0xa820f7(0x17f)](';'),_0x5e3d36=[{'field':_0xa820f7(0x18e),'option':salesforce_1[_0xa820f7(0x15d)]['IN'],'value':_0x5b2aa5}],_0x109fd8=new logger_1['Logger']();return new salesforce_1[(_0xa820f7(0x1a9))](_0x1f612e,_0x2c4f39,_0x109fd8,_0x5e3d36,null,[salesforce_1[_0xa820f7(0x173)]['PERMISSION_SET']])[_0xa820f7(0x19e)]();}async function mergePermissionSets(_0x3e3690,_0x5e418e){const _0x160d3b=a105_0x164e07,_0xd01780=_0x5e418e[_0x160d3b(0x150)]((_0x5b8584,_0x179573)=>_0x5b8584[_0x160d3b(0x181)](_0x179573['listMetadataItem'][_0x160d3b(0x18e)],_0x179573),new Map());for(const _0x20a157 of _0x3e3690){const _0x43facd=PERMISSION_SET_FOLDER_NAME+'/'+_0x20a157['fileName'],_0x2a6ec8=_0xd01780[_0x160d3b(0x168)](_0x43facd);if(!_0x2a6ec8)continue;const _0x5ae672=await zip_1[_0x160d3b(0x16a)][_0x160d3b(0x19a)](_0x20a157['body']),_0x5991c6=await _0x5ae672[_0x160d3b(0x196)][_0x43facd]['async']('text'),_0x14705c=_0x2a6ec8[_0x160d3b(0x196)][_0x43facd][_0x160d3b(0x1a8)](),_0x16b213=await(0x0,extract_component_permissions_1[_0x160d3b(0x14e)])(_0x5991c6,_0x14705c,_0x20a157[_0x160d3b(0x19d)]),_0x2a817f=zip_1[_0x160d3b(0x16a)][_0x160d3b(0x160)]();_0x2a817f['file'](_0x43facd,_0x16b213),_0x20a157[_0x160d3b(0x1ad)]=await _0x2a817f[_0x160d3b(0x163)]({'type':_0x160d3b(0x14f),'compression':_0x160d3b(0x18d),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x196928,_0x5d1cd8,_0x5d3641){const _0x3491d1=a105_0x164e07;for(const _0x44f2f0 of _0x5d3641){if(_0x196928[_0x3491d1(0x15a)](_0x2008d0=>_0x2008d0!==_0x44f2f0[_0x3491d1(0x19d)]))continue;const _0x2612af=await zip_1[_0x3491d1(0x16a)]['unzip'](_0x44f2f0['body']);for(const _0x4c1af9 in _0x2612af[_0x3491d1(0x196)]){if(!_0x2612af[_0x3491d1(0x196)][_0x4c1af9][_0x3491d1(0x183)]){let _0x3d8734=await _0x2612af[_0x3491d1(0x196)][_0x4c1af9]['async'](_0x3491d1(0x16b));for(const _0x43330c of Object[_0x3491d1(0x16c)](_0x5d1cd8)){const _0x38e31b=new RegExp('%%'+_0x43330c+'%%','g');_0x3d8734=_0x3d8734[_0x3491d1(0x175)](_0x38e31b,_0x5d1cd8[_0x43330c]);}_0x2612af[_0x3491d1(0x177)](_0x4c1af9,_0x3d8734);}}_0x44f2f0[_0x3491d1(0x1ad)]=await _0x2612af[_0x3491d1(0x163)]({'type':'base64','compression':_0x3491d1(0x18d),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x398714,_0x56a645){const _0x462ee9=a105_0x164e07,_0x2fd444=new mdapi_writer_1['MDApiWriter']({'components':_0x398714,'sourceDir':path_1['default'][_0x462ee9(0x17f)](process[_0x462ee9(0x165)](),'.temp',_0x56a645,DEPLOY_DIR_NAME),'skipChildErrors':![]});await _0x2fd444['execute']();}function a105_0x49bf(_0x3119a5,_0x31cbeb){const _0x390fea=a105_0x38e4();return a105_0x49bf=function(_0x5d404e,_0x6a804c){_0x5d404e=_0x5d404e-0x14d;let _0x38e407=_0x390fea[_0x5d404e];return _0x38e407;},a105_0x49bf(_0x3119a5,_0x31cbeb);}async function generateAndWritePackageXML(_0xaeb336,_0x558f3e,_0x3709c7,_0x3979b4){const _0x395df6=a105_0x164e07,_0x2e86b6=getComponentsTypeAndName(_0xaeb336,_0x558f3e),_0x138fcc=[...new Set(_0x2e86b6[_0x395df6(0x172)](_0xe8bb45=>_0xe8bb45[_0x395df6(0x189)]))],_0x388fbb={'Package':{'$':{'xmlns':_0x395df6(0x19b)},'types':[],'version':''+_0x3979b4}};for(const _0x2cbdd4 of _0x138fcc){const _0x4127a2=_0x2e86b6[_0x395df6(0x188)](_0x32d462=>_0x32d462['type']===_0x2cbdd4)['map'](_0x29d580=>_0x29d580[_0x395df6(0x18a)]),_0x59e9f9={'members':_0x4127a2,'name':_0x2cbdd4};_0x388fbb[_0x395df6(0x19c)]['types'][_0x395df6(0x1ac)](_0x59e9f9);}const _0x26549f=new xml2js_1[(_0x395df6(0x152))]({'xmldec':{'version':_0x395df6(0x166),'encoding':_0x395df6(0x17d)}}),_0x4950e7=_0x26549f[_0x395df6(0x17e)](_0x388fbb);await fs_internal_1['FS']['writeFile'](path_1[_0x395df6(0x18b)][_0x395df6(0x17f)](process['cwd'](),_0x395df6(0x195),_0x3709c7,DEPLOY_DIR_NAME,'package.xml'),_0x4950e7);}function getComponentsTypeAndName(_0x144b71,_0x45382a){return _0x144b71['reduce']((_0x14df91,_0x43c707)=>{const _0x5c3a1e=a105_0x49bf,_0x575cb9=_0x45382a[_0x5c3a1e(0x19f)](_0x50f580=>_0x50f580['Id']===_0x43c707[_0x5c3a1e(0x156)]);return _0x575cb9&&_0x14df91[_0x5c3a1e(0x1ac)]({'name':_0x575cb9['Component__r'][_0x5c3a1e(0x16d)],'type':salesforce_1[_0x5c3a1e(0x198)][_0x5c3a1e(0x190)][_0x43c707[_0x5c3a1e(0x180)]]||_0x43c707[_0x5c3a1e(0x180)]}),_0x14df91;},[]);}async function saveDestructiveChanges(_0x37952d,_0x46c727,_0x93da83,_0x32c883){const _0x1eee11=a105_0x164e07,_0x243b2f=(await(0x0,fetch_attachments_1[_0x1eee11(0x18f)])(_0x37952d,_0x46c727))[_0x1eee11(0x1a8)]();await fs_internal_1['FS'][_0x1eee11(0x176)](path_1[_0x1eee11(0x18b)][_0x1eee11(0x17f)](process[_0x1eee11(0x165)](),_0x1eee11(0x195),_0x32c883,DEPLOY_DIR_NAME,_0x93da83),_0x243b2f);}async function createDeployZip(_0x51da43){const _0x2246d2=a105_0x164e07,_0x1b7725=new adm_zip_1[(_0x2246d2(0x18b))]();return await _0x1b7725[_0x2246d2(0x159)](path_1[_0x2246d2(0x18b)][_0x2246d2(0x17f)](process[_0x2246d2(0x165)](),_0x2246d2(0x195),_0x51da43,DEPLOY_DIR_NAME)),_0x1b7725;}async function insertZip(_0x2b1598,_0x1b3307,_0xb969bd,_0x162536,_0x3da2d0,_0x182cee){const _0x85ae17=a105_0x164e07,_0x4ae86b={'ParentId':_0x1b3307,'Name':_0x85ae17(0x193)+_0xb969bd,'Description':_0x85ae17(0x193)+_0x162536,'Body':_0x3da2d0},{data:_0xdf09aa}=await _0x2b1598[_0x85ae17(0x158)](_0x85ae17(0x169)+_0x182cee+_0x85ae17(0x178),_0x4ae86b);return _0xdf09aa['id'];}function a105_0x38e4(){const _0x296435=['dir','../../git/parsers/utils/zip','search','adm-zip','@flosum/salesforce','filter','type','name','default','2744380VEbJdZ','DEFLATE','fileName','fetchAttachmentBody','FOLDER_TO_METADATA_TYPE_MAP','../../git/internal/fs.internal','permissionsets','BUILD','splitZip','.temp','files','../../shared/utils/fetch-attachments','MetadataConstants','9613737MPnKkM','unzip','http://soap.sforce.com/2006/04/metadata','Package','fileType','execute','find','indexOf','4374352QnbppJ','__importDefault','../../git/writers/mdapi.writer','7905370lxdsGP','generateAndDeployZip','length','fs/promises','toString','PartialRetrieve','components','values','push','body','substring','2693064AEcvMD','mergeComponentPermissions','base64','reduce','xml2js','Builder','toBuffer','3QeHxop','../classes/logger','ParentId','(((.+)+)+)+$','post','addLocalFolder','every','9BxrPtv','apply','DeclarativeFilterOptions','async','DEPLOYZIP','createZip','../utils/components-api','destructiveChangesPre.xml','generateAsync','../utils/extract-component-permissions','cwd','1.0','then','get','/services/data/v','Zip','text','keys','Component_Name__c','Body','PermissionSet','MAX_ZIP_SIZE','destructiveChangesPost.xml','map','MetadataType','ComponentsApi','replace','writeFile','file','/sobjects/Attachment','retrieveAttachments','orgId','169876gpqVYm','path','UTF-8','buildObject','join','Name','set','12294488eLgUnM'];a105_0x38e4=function(){return _0x296435;};return a105_0x38e4();}