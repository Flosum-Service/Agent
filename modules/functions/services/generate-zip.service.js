const a86_0x96e08f=a86_0x816a;(function(_0x583b8d,_0x2ea353){const _0x34f953=a86_0x816a,_0x5a59f9=_0x583b8d();while(!![]){try{const _0x50e709=-parseInt(_0x34f953(0x151))/0x1*(parseInt(_0x34f953(0x177))/0x2)+-parseInt(_0x34f953(0x169))/0x3+parseInt(_0x34f953(0x15e))/0x4*(-parseInt(_0x34f953(0x17a))/0x5)+parseInt(_0x34f953(0x17d))/0x6*(parseInt(_0x34f953(0x14a))/0x7)+parseInt(_0x34f953(0x1a1))/0x8*(-parseInt(_0x34f953(0x18a))/0x9)+-parseInt(_0x34f953(0x197))/0xa+parseInt(_0x34f953(0x15b))/0xb;if(_0x50e709===_0x2ea353)break;else _0x5a59f9['push'](_0x5a59f9['shift']());}catch(_0x572060){_0x5a59f9['push'](_0x5a59f9['shift']());}}}(a86_0x5edb,0xaf0c8));const a86_0x28cb49=(function(){let _0x469836=!![];return function(_0x17272d,_0x46c308){const _0x2156c1=_0x469836?function(){if(_0x46c308){const _0xb5e8df=_0x46c308['apply'](_0x17272d,arguments);return _0x46c308=null,_0xb5e8df;}}:function(){};return _0x469836=![],_0x2156c1;};}()),a86_0x12874f=a86_0x28cb49(this,function(){const _0x4f84c8=a86_0x816a;return a86_0x12874f[_0x4f84c8(0x168)]()[_0x4f84c8(0x14f)](_0x4f84c8(0x183))[_0x4f84c8(0x168)]()['constructor'](a86_0x12874f)[_0x4f84c8(0x14f)](_0x4f84c8(0x183));});a86_0x12874f();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3c6754){return _0x3c6754&&_0x3c6754['__esModule']?_0x3c6754:{'default':_0x3c6754};};Object[a86_0x96e08f(0x173)](exports,a86_0x96e08f(0x170),{'value':!![]}),exports[a86_0x96e08f(0x15c)]=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require(a86_0x96e08f(0x1a0))),extract_component_permissions_1=require(a86_0x96e08f(0x19d)),xml2js_1=require(a86_0x96e08f(0x171)),zip_1=require(a86_0x96e08f(0x159)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a86_0x96e08f(0x19e)),promises_1=require(a86_0x96e08f(0x187)),components_api_1=require(a86_0x96e08f(0x152)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a86_0x96e08f(0x163)),fetch_attachments_1=require(a86_0x96e08f(0x199)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a86_0x96e08f(0x16b);async function generateAndDeployZip({attachmentsId:_0x39950d,isExtractComponentsPermissions:_0x4a8890,preDestructiveAttachmentId:_0x381c71,postDestructiveAttachmentId:_0x109ed9,branchId:_0x23a645,credentials:_0x2a33be,metadataLogId:_0x45ee61,environments:_0x277bbf,metaTypes:_0x418cbf},_0x82f72d){const _0x502484=a86_0x96e08f,_0x332654=(0x0,uuid_1['v4'])();try{const _0x3f2e3c=await(0x0,fetch_attachments_1[_0x502484(0x19b)])(_0x82f72d,_0x39950d),_0x4c7ecc=_0x3f2e3c[_0x502484(0x1a3)]((_0x1dc109,_0x282702)=>({..._0x1dc109,[_0x282702['Id']]:_0x282702[_0x502484(0x192)]}),{}),_0x18c9e7=await getComponents(_0x3f2e3c,_0x82f72d,_0x4c7ecc),_0x4b51e9=await components_api_1[_0x502484(0x195)][_0x502484(0x198)](_0x82f72d,_0x3f2e3c[_0x502484(0x16a)](({ParentId:_0x3ca041})=>_0x3ca041))['then'](_0x3bd472=>components_api_1['ComponentsApi']['removeNamespacePrefix'](_0x3bd472));if(_0x4a8890){const _0x3b84bd=_0x18c9e7[_0x502484(0x157)](({fileType:_0x28132a})=>_0x28132a===_0x502484(0x180)||_0x28132a==='PermissionSet');await removePermission(_0x3b84bd,_0x4b51e9);}await replaceEnvironments(_0x418cbf,_0x277bbf,_0x18c9e7),await writeZip(_0x18c9e7,_0x332654),await generateAndWritePackageXML(_0x3f2e3c,_0x4b51e9,_0x332654);_0x381c71&&await saveDestructiveChanges(_0x82f72d,_0x381c71,DESTRUCTIVE_CHANGES_PER_NAME,_0x332654);_0x109ed9&&await saveDestructiveChanges(_0x82f72d,_0x109ed9,DESTRUCTIVE_CHANGES_POST_NAME,_0x332654);const _0x119af1=(await createDeployZip(_0x332654)[_0x502484(0x188)](_0x56eff3=>{return _0x56eff3;}))[_0x502484(0x166)]()['toString'](_0x502484(0x175));console[_0x502484(0x156)](_0x502484(0x196));const _0xbb0417=_0x119af1[_0x502484(0x18f)];if(_0xbb0417>=components_api_1[_0x502484(0x181)]){const _0xc9c1f3=await createDeployZip(_0x332654);console[_0x502484(0x156)](_0x502484(0x185));const [_0x27e7cd,_0x32ae8d]=await components_api_1[_0x502484(0x195)][_0x502484(0x176)](_0xc9c1f3,_0xbb0417),_0x3203d1=await insertZip(_0x82f72d,_0x23a645,_0x2a33be[_0x502484(0x161)],_0x45ee61,_0x27e7cd['toBuffer']()[_0x502484(0x168)](_0x502484(0x175))),_0x10f996=await insertZip(_0x82f72d,_0x23a645,_0x2a33be[_0x502484(0x161)],_0x45ee61,_0x32ae8d[_0x502484(0x166)]()['toString']('base64'));return _0x3203d1+','+_0x10f996;}else return await insertZip(_0x82f72d,_0x23a645,_0x2a33be['orgId'],_0x45ee61,_0x119af1);}catch(_0x47b857){throw _0x47b857;}finally{if(await fs_internal_1['FS'][_0x502484(0x18e)](path_1[_0x502484(0x149)]['join'](process[_0x502484(0x160)](),_0x502484(0x14c),_0x332654)))await(0x0,promises_1['rm'])(path_1[_0x502484(0x149)][_0x502484(0x14d)](process['cwd'](),_0x502484(0x14c),_0x332654),{'recursive':!![]});}}exports[a86_0x96e08f(0x15c)]=generateAndDeployZip;function a86_0x5edb(){const _0x25e93=['after\x20create\x20zip','4967630afKXfr','fetchComponentsDetailsByComponentsHistory','../../shared/utils/fetch-attachments','http://soap.sforce.com/2006/04/metadata','fetchAttachmentsDetailsById','retrieveAttachments','../utils/extract-component-permissions','../../git/internal/fs.internal','1.0','path','312nRywpP','find','reduce','writeFile','default','224UqyUNn','async','.temp','join','fileName','search','fileType','47WVwbxg','../utils/components-api','replace','push','substring','log','filter','every','../../git/parsers/utils/zip','Body','31360989Ydctcw','generateAndDeployZip','UTF-8','18852rQwfrR','src','cwd','orgId','unzip','uuid','addLocalFolder','generateAsync','toBuffer','file','toString','2866569CKusqv','map','DEPLOYZIP','keys','start','MDApiWriter','DEFLATE','__esModule','xml2js','Component__r','defineProperty','files','base64','splitZip','34104TKLFPS','Component_Name__c','text','130uRpeic','Zip','ParentId','114492bwFCjr','body','dir','Profile','MAX_ZIP_SIZE','values','(((.+)+)+)+$','name','after\x20create\x20second\x20zip','type','fs/promises','then','package.xml','85005PzLute','post','Builder','types','exists','length','fetchAttachmentBody','SALESFORCE_API_VERSION','Name','buildObject','indexOf','ComponentsApi'];a86_0x5edb=function(){return _0x25e93;};return a86_0x5edb();}async function getComponents(_0x518bd8,_0x344268,_0x26ba0b){const _0x208c82=a86_0x96e08f,_0x5d2191=[],_0x3da292=await(0x0,fetch_attachments_1[_0x208c82(0x19c)])(_0x518bd8,_0x344268);return await getComponentFromZip(_0x3da292,_0x26ba0b)['then'](_0x24f1fc=>{const _0x2e4136=_0x208c82;_0x5d2191[_0x2e4136(0x154)](..._0x24f1fc);}),_0x5d2191;}async function getComponentFromZip(_0x79d9dc,_0x42a0dc){const _0x2f6a76=a86_0x96e08f,_0x36bac8=[];for(const _0x2da32c of _0x79d9dc){const _0x5e7795=await zip_1[_0x2f6a76(0x17b)][_0x2f6a76(0x162)](_0x2da32c['values'][_0x2f6a76(0x15a)]);for(const _0x53a822 in _0x5e7795[_0x2f6a76(0x174)]){!_0x5e7795[_0x2f6a76(0x174)][_0x53a822][_0x2f6a76(0x17f)]&&_0x36bac8[_0x2f6a76(0x154)]({'fileName':_0x53a822[_0x2f6a76(0x155)](_0x53a822[_0x2f6a76(0x194)]('/')+0x1),'fileType':_0x42a0dc[_0x2da32c['id']],'body':_0x2da32c[_0x2f6a76(0x182)][_0x2f6a76(0x15a)]});}}return _0x36bac8;}async function removePermission(_0x4f239f,_0x2a1ffb){const _0x1044b1=a86_0x96e08f;for(const _0x414e35 of _0x4f239f){const _0x4b943f=await zip_1[_0x1044b1(0x17b)][_0x1044b1(0x162)](_0x414e35[_0x1044b1(0x17e)]),_0x1d5fcf=[];for(const _0x496011 in _0x4b943f[_0x1044b1(0x174)]){!_0x4b943f[_0x1044b1(0x174)][_0x496011]['dir']&&_0x1d5fcf[_0x1044b1(0x154)]({'fileName':_0x496011,'body':await _0x4b943f[_0x1044b1(0x174)][_0x496011][_0x1044b1(0x14b)](_0x1044b1(0x179))});}const _0x2cbd3a=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x1d5fcf[0x0][_0x1044b1(0x17e)][_0x1044b1(0x168)](),_0x2a1ffb,_0x414e35['fileType']),_0x992391=new xml2js_1[(_0x1044b1(0x18c))]({'xmldec':{'version':_0x1044b1(0x19f),'encoding':'UTF-8'}}),_0x559026=_0x992391[_0x1044b1(0x193)](_0x2cbd3a),_0x1d6f3e=zip_1[_0x1044b1(0x17b)]['createZip']();_0x1d6f3e['file'](_0x1d5fcf[0x0][_0x1044b1(0x14e)],_0x559026),_0x414e35[_0x1044b1(0x17e)]=await _0x1d6f3e[_0x1044b1(0x165)]({'type':'base64','compression':_0x1044b1(0x16f),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x186248,_0x1753f9,_0x2d4f10){const _0x302f2c=a86_0x96e08f;for(const _0x48f402 of _0x2d4f10){if(_0x186248[_0x302f2c(0x158)](_0x3c40ad=>_0x3c40ad!==_0x48f402[_0x302f2c(0x150)]))continue;const _0x460d1c=await zip_1[_0x302f2c(0x17b)]['unzip'](_0x48f402[_0x302f2c(0x17e)]);for(const _0x3b3ac9 in _0x460d1c[_0x302f2c(0x174)]){if(!_0x460d1c[_0x302f2c(0x174)][_0x3b3ac9][_0x302f2c(0x17f)]){let _0xfbf291=await _0x460d1c[_0x302f2c(0x174)][_0x3b3ac9][_0x302f2c(0x14b)](_0x302f2c(0x179));for(const _0x39435e of Object[_0x302f2c(0x16c)](_0x1753f9)){const _0x26704d=new RegExp('%%'+_0x39435e+'%%','g');_0xfbf291=_0xfbf291[_0x302f2c(0x153)](_0x26704d,_0x1753f9[_0x39435e]);}_0x460d1c[_0x302f2c(0x167)](_0x3b3ac9,_0xfbf291);}}_0x48f402['body']=await _0x460d1c[_0x302f2c(0x165)]({'type':'base64','compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x39ba43,_0x10596a){const _0x3c4ccf=a86_0x96e08f,_0x268117=new mdapi_1[(_0x3c4ccf(0x16e))]({'components':_0x39ba43,'sourceDir':path_1[_0x3c4ccf(0x149)][_0x3c4ccf(0x14d)](process[_0x3c4ccf(0x160)](),_0x3c4ccf(0x14c),_0x10596a,DEPLOY_DIR_NAME,_0x3c4ccf(0x15f)),'skipChildErrors':![]});await _0x268117[_0x3c4ccf(0x16d)]();}async function generateAndWritePackageXML(_0x1d621e,_0x55a25b,_0x23a4b7){const _0x554bf=a86_0x96e08f,_0x3467fe=getComponentsTypeAndName(_0x1d621e,_0x55a25b),_0x1cbe71=[...new Set(_0x3467fe[_0x554bf(0x16a)](_0x3692d3=>_0x3692d3['type']))],_0x5b8934={'Package':{'$':{'xmlns':_0x554bf(0x19a)},'types':[],'version':''+constants_1[_0x554bf(0x191)][_0x554bf(0x155)](0x1)}};for(const _0x3f911c of _0x1cbe71){const _0x21e35f=_0x3467fe[_0x554bf(0x157)](_0x32c3f2=>_0x32c3f2[_0x554bf(0x186)]===_0x3f911c)[_0x554bf(0x16a)](_0x1edb48=>_0x1edb48[_0x554bf(0x184)]),_0x2b1600={'members':_0x21e35f,'name':_0x3f911c};_0x5b8934['Package'][_0x554bf(0x18d)]['push'](_0x2b1600);}const _0x2d9d4f=new xml2js_1[(_0x554bf(0x18c))]({'xmldec':{'version':_0x554bf(0x19f),'encoding':_0x554bf(0x15d)}}),_0xd401ff=_0x2d9d4f['buildObject'](_0x5b8934);await fs_internal_1['FS'][_0x554bf(0x148)](path_1['default']['join'](process[_0x554bf(0x160)](),_0x554bf(0x14c),_0x23a4b7,DEPLOY_DIR_NAME,'src',_0x554bf(0x189)),_0xd401ff);}function getComponentsTypeAndName(_0x41c474,_0x59c687){const _0x26ca2d=a86_0x96e08f;return _0x41c474[_0x26ca2d(0x1a3)]((_0x1131b6,_0x490e6e)=>{const _0x129ae6=_0x26ca2d,_0x285b13=_0x59c687[_0x129ae6(0x1a2)](_0x229de1=>_0x229de1['Id']===_0x490e6e[_0x129ae6(0x17c)]);return _0x285b13&&_0x1131b6[_0x129ae6(0x154)]({'name':_0x285b13[_0x129ae6(0x172)][_0x129ae6(0x178)],'type':_0x490e6e[_0x129ae6(0x192)]}),_0x1131b6;},[]);}async function saveDestructiveChanges(_0x2da48b,_0x21e5f3,_0x31a376,_0x4938a6){const _0x2fbadc=a86_0x96e08f,_0x3ebafb=(await(0x0,fetch_attachments_1[_0x2fbadc(0x190)])(_0x2da48b,_0x21e5f3))['toString']();await fs_internal_1['FS'][_0x2fbadc(0x148)](path_1[_0x2fbadc(0x149)][_0x2fbadc(0x14d)](process[_0x2fbadc(0x160)](),_0x2fbadc(0x14c),_0x4938a6,DEPLOY_DIR_NAME,'src',_0x31a376),_0x3ebafb);}function a86_0x816a(_0x3541d9,_0x3b227b){const _0x228012=a86_0x5edb();return a86_0x816a=function(_0x12874f,_0x28cb49){_0x12874f=_0x12874f-0x148;let _0x5edbc9=_0x228012[_0x12874f];return _0x5edbc9;},a86_0x816a(_0x3541d9,_0x3b227b);}async function createDeployZip(_0x108b3a){const _0x4fdff5=a86_0x96e08f,_0x5918e5=new adm_zip_1[(_0x4fdff5(0x149))]();return await _0x5918e5[_0x4fdff5(0x164)](path_1['default']['join'](process[_0x4fdff5(0x160)](),'.temp',_0x108b3a,DEPLOY_DIR_NAME)),_0x5918e5;}async function insertZip(_0x216837,_0x1da835,_0x504b38,_0xcc8ab7,_0x478d43){const _0x27fa25=a86_0x96e08f,_0x2b2024={'ParentId':_0x1da835,'Name':'BUILD'+_0x504b38,'Description':'BUILD'+_0xcc8ab7,'Body':_0x478d43},{data:_0x5e0399}=await _0x216837[_0x27fa25(0x18b)]('/services/data/'+constants_1[_0x27fa25(0x191)]+'/sobjects/Attachment',_0x2b2024);return _0x5e0399['id'];}