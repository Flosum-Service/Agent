const a87_0x5a13cd=a87_0x261e;(function(_0x2f669a,_0x47b4a0){const _0x4a68d4=a87_0x261e,_0x5c8ae7=_0x2f669a();while(!![]){try{const _0x2eda0e=parseInt(_0x4a68d4(0x143))/0x1+-parseInt(_0x4a68d4(0x14a))/0x2*(-parseInt(_0x4a68d4(0x129))/0x3)+parseInt(_0x4a68d4(0x152))/0x4+parseInt(_0x4a68d4(0x12d))/0x5*(parseInt(_0x4a68d4(0x115))/0x6)+-parseInt(_0x4a68d4(0x119))/0x7*(parseInt(_0x4a68d4(0x116))/0x8)+-parseInt(_0x4a68d4(0x12c))/0x9+-parseInt(_0x4a68d4(0x16e))/0xa;if(_0x2eda0e===_0x47b4a0)break;else _0x5c8ae7['push'](_0x5c8ae7['shift']());}catch(_0x1276f9){_0x5c8ae7['push'](_0x5c8ae7['shift']());}}}(a87_0x2a98,0xd9c06));const a87_0x3ebd89=(function(){let _0x12e854=!![];return function(_0x56575a,_0x3dac3d){const _0x3a7c8a=_0x12e854?function(){const _0x148d55=a87_0x261e;if(_0x3dac3d){const _0x427700=_0x3dac3d[_0x148d55(0x120)](_0x56575a,arguments);return _0x3dac3d=null,_0x427700;}}:function(){};return _0x12e854=![],_0x3a7c8a;};}()),a87_0x318fbe=a87_0x3ebd89(this,function(){const _0x4bfbe8=a87_0x261e;return a87_0x318fbe[_0x4bfbe8(0x146)]()[_0x4bfbe8(0x11f)](_0x4bfbe8(0x159))[_0x4bfbe8(0x146)]()[_0x4bfbe8(0x157)](a87_0x318fbe)[_0x4bfbe8(0x11f)](_0x4bfbe8(0x159));});a87_0x318fbe();'use strict';var __importDefault=this&&this[a87_0x5a13cd(0x174)]||function(_0x1cc6bd){return _0x1cc6bd&&_0x1cc6bd['__esModule']?_0x1cc6bd:{'default':_0x1cc6bd};};Object[a87_0x5a13cd(0x130)](exports,a87_0x5a13cd(0x141),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require(a87_0x5a13cd(0x158))),extract_component_permissions_1=require(a87_0x5a13cd(0x111)),logger_1=require(a87_0x5a13cd(0x160)),xml2js_1=require(a87_0x5a13cd(0x140)),zip_1=require(a87_0x5a13cd(0x118)),mdapi_writer_1=require(a87_0x5a13cd(0x161)),fs_internal_1=require(a87_0x5a13cd(0x177)),promises_1=require('fs/promises'),components_api_1=require(a87_0x5a13cd(0x16f)),adm_zip_1=__importDefault(require(a87_0x5a13cd(0x169))),uuid_1=require(a87_0x5a13cd(0x124)),fetch_attachments_1=require(a87_0x5a13cd(0x175)),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a87_0x5a13cd(0x123),PERMISSION_SET_FOLDER_NAME=a87_0x5a13cd(0x173);async function generateAndDeployZip({attachmentsId:_0xdd0416,isExtractComponentsPermissionSets:_0x437146,isExtractComponentsProfiles:_0x20c37e,preDestructiveAttachmentId:_0x515824,postDestructiveAttachmentId:_0x3876da,branchId:_0x1143e6,credentials:_0x5e2a01,metadataLogId:_0xcf9aac,environments:_0x4aa76c,metaTypes:_0x43e453,apiVersion:_0x311950},_0x467bab,_0x11a599){const _0x541931=a87_0x5a13cd;var _0x5f0a57;const _0x2194f9=(0x0,uuid_1['v4'])();try{const _0x1a657d=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x467bab,_0xdd0416),_0xa781e1=_0x1a657d[_0x541931(0x150)]((_0x129b11,_0x336fc0)=>({..._0x129b11,[_0x336fc0['Id']]:_0x336fc0[_0x541931(0x164)]}),{}),_0x77831b=await getComponents(_0x1a657d,_0x467bab,_0xa781e1),_0x122eb0=await components_api_1[_0x541931(0x15f)][_0x541931(0x11b)](_0x467bab,_0x1a657d[_0x541931(0x155)](({ParentId:_0xcf2843})=>_0xcf2843),_0x311950)[_0x541931(0x168)](_0x27e8cc=>components_api_1[_0x541931(0x15f)][_0x541931(0x12a)](_0x27e8cc));if(_0x20c37e){const _0x2aa25=_0x77831b['filter'](({fileType:_0x209b65})=>_0x209b65===_0x541931(0x16a));await removePermission(_0x2aa25,_0x122eb0);}const _0x4015c6=_0x77831b[_0x541931(0x171)](({fileType:_0x33e109})=>_0x33e109===_0x541931(0x12f));if(_0x4015c6){if(_0x437146){await removePermission(_0x4015c6,_0x122eb0);const {items:_0x3b04f8}=await retrieveTargetPermissionSets(_0x4015c6,_0x311950,_0x11a599);await mergePermissionSets(_0x4015c6,((_0x5f0a57=_0x3b04f8['PermissionSet'])===null||_0x5f0a57===void 0x0?void 0x0:_0x5f0a57['components'])||[]);}}await replaceEnvironments(_0x43e453,_0x4aa76c,_0x77831b),await writeZip(_0x77831b,_0x2194f9),await generateAndWritePackageXML(_0x1a657d,_0x122eb0,_0x2194f9,_0x311950);_0x515824&&await saveDestructiveChanges(_0x467bab,_0x515824,DESTRUCTIVE_CHANGES_PER_NAME,_0x2194f9);_0x3876da&&await saveDestructiveChanges(_0x467bab,_0x3876da,DESTRUCTIVE_CHANGES_POST_NAME,_0x2194f9);const _0x5992b1=(await createDeployZip(_0x2194f9)[_0x541931(0x168)](_0x5a3f94=>{return _0x5a3f94;}))['toBuffer']()[_0x541931(0x146)](_0x541931(0x153)),_0x42106d=_0x5992b1[_0x541931(0x125)];if(_0x42106d>=components_api_1[_0x541931(0x11e)]){const _0x254c83=await createDeployZip(_0x2194f9),[_0x335558,_0xa0375c]=await components_api_1['ComponentsApi'][_0x541931(0x154)](_0x254c83,_0x42106d),_0xa0a326=await insertZip(_0x467bab,_0x1143e6,_0x5e2a01['orgId'],_0xcf9aac,_0x335558[_0x541931(0x172)]()[_0x541931(0x146)](_0x541931(0x153)),_0x311950),_0xa9e084=await insertZip(_0x467bab,_0x1143e6,_0x5e2a01[_0x541931(0x117)],_0xcf9aac,_0xa0375c[_0x541931(0x172)]()[_0x541931(0x146)](_0x541931(0x153)),_0x311950);return _0xa0a326+','+_0xa9e084;}else return await insertZip(_0x467bab,_0x1143e6,_0x5e2a01[_0x541931(0x117)],_0xcf9aac,_0x5992b1,_0x311950);}catch(_0x57135e){throw _0x57135e;}finally{if(await fs_internal_1['FS'][_0x541931(0x14f)](path_1[_0x541931(0x151)][_0x541931(0x13f)](process['cwd'](),_0x541931(0x13c),_0x2194f9)))await(0x0,promises_1['rm'])(path_1[_0x541931(0x151)][_0x541931(0x13f)](process['cwd'](),_0x541931(0x13c),_0x2194f9),{'recursive':!![]});}}exports[a87_0x5a13cd(0x148)]=generateAndDeployZip;async function getComponents(_0x68a514,_0x55af40,_0x193425){const _0xdcfec6=a87_0x5a13cd,_0x2856a1=[],_0x550489=await(0x0,fetch_attachments_1[_0xdcfec6(0x15c)])(_0x68a514,_0x55af40);return await getComponentFromZip(_0x550489,_0x193425)[_0xdcfec6(0x168)](_0x17c6cf=>{const _0xac2eec=_0xdcfec6;_0x2856a1[_0xac2eec(0x13b)](..._0x17c6cf);}),_0x2856a1;}async function getComponentFromZip(_0x462851,_0xfcfa3f){const _0x49845d=a87_0x5a13cd,_0x5bc5b0=[];for(const _0x362a52 of _0x462851){const _0x28ca81=await zip_1[_0x49845d(0x134)]['unzip'](_0x362a52[_0x49845d(0x114)]['Body']);for(const _0x19cc2a in _0x28ca81[_0x49845d(0x126)]){!_0x28ca81[_0x49845d(0x126)][_0x19cc2a][_0x49845d(0x14c)]&&_0x5bc5b0['push']({'fileName':_0x19cc2a[_0x49845d(0x135)](_0x19cc2a[_0x49845d(0x14e)]('/')+0x1),'fileType':_0xfcfa3f[_0x362a52['id']],'body':_0x362a52['values'][_0x49845d(0x128)]});}}return _0x5bc5b0;}function a87_0x2a98(){const _0x502f42=['1250fHMtsI','unzip','PermissionSet','defineProperty','src','Package','text','Zip','substring','body','find','type','name','BUILD','push','.temp','PartialRetrieve','1.0','join','xml2js','__esModule','cwd','1349297roAFRI','FOLDER_TO_METADATA_TYPE_MAP','extractComponentPermissions','toString','Component__r','generateAndDeployZip','mergeComponentPermissions','1437118javWgQ','replace','dir','http://soap.sforce.com/2006/04/metadata','indexOf','exists','reduce','default','3768140zPHYCA','base64','splitZip','map','fileName','constructor','path','(((.+)+)+)+$','get','execute','retrieveAttachments','writeFile','keys','ComponentsApi','../classes/logger','../../git/writers/mdapi.writer','addLocalFolder','Builder','Name','UTF-8','/sobjects/Attachment','ParentId','then','adm-zip','Profile','createZip','MetadataConstants','types','24420740HLJQvp','../utils/components-api','package.xml','filter','toBuffer','permissionsets','__importDefault','../../shared/utils/fetch-attachments','listMetadataItem','../../git/internal/fs.internal','../utils/extract-component-permissions','buildObject','generateAsync','values','38358ebOkCU','3868568LMCRPN','orgId','../../git/parsers/utils/zip','7QLdNvY','async','fetchComponentsDetailsByComponentsHistory','file','Component_Name__c','MAX_ZIP_SIZE','search','apply','every','post','DEPLOYZIP','uuid','length','files','DEFLATE','Body','3aqFPMM','removeNamespacePrefix','set','7115274gPEXyG'];a87_0x2a98=function(){return _0x502f42;};return a87_0x2a98();}function a87_0x261e(_0x1d8a1a,_0x42e2dd){const _0x408dc3=a87_0x2a98();return a87_0x261e=function(_0x318fbe,_0x3ebd89){_0x318fbe=_0x318fbe-0x111;let _0x2a9839=_0x408dc3[_0x318fbe];return _0x2a9839;},a87_0x261e(_0x1d8a1a,_0x42e2dd);}async function removePermission(_0x435587,_0x25ee44){const _0x16e048=a87_0x5a13cd;for(const _0x1507de of _0x435587){const _0x22c31f=await zip_1[_0x16e048(0x134)][_0x16e048(0x12e)](_0x1507de[_0x16e048(0x136)]),_0xbedafb=[];for(const _0x42a09c in _0x22c31f[_0x16e048(0x126)]){!_0x22c31f['files'][_0x42a09c][_0x16e048(0x14c)]&&_0xbedafb[_0x16e048(0x13b)]({'fileName':_0x42a09c,'body':await _0x22c31f[_0x16e048(0x126)][_0x42a09c][_0x16e048(0x11a)](_0x16e048(0x133))});}const _0x21d583=await(0x0,extract_component_permissions_1[_0x16e048(0x145)])(_0xbedafb[0x0][_0x16e048(0x136)][_0x16e048(0x146)](),_0x25ee44,_0x1507de['fileType']),_0x1afb9b=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':_0x16e048(0x165)}}),_0x365799=_0x1afb9b[_0x16e048(0x112)](_0x21d583),_0x3e282f=zip_1['Zip'][_0x16e048(0x16b)]();_0x3e282f['file'](_0xbedafb[0x0][_0x16e048(0x156)],_0x365799),_0x1507de[_0x16e048(0x136)]=await _0x3e282f[_0x16e048(0x113)]({'type':'base64','compression':_0x16e048(0x127),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x526e74,_0x48a809,_0x43f358){const _0x53647e=a87_0x5a13cd,_0x18bbd1=_0x526e74['map'](_0x13a28e=>PERMISSION_SET_FOLDER_NAME+'/'+_0x13a28e[_0x53647e(0x156)])['join'](';'),_0x34093c=[{'field':_0x53647e(0x156),'option':salesforce_1['DeclarativeFilterOptions']['IN'],'value':_0x18bbd1}],_0x25b102=new logger_1['Logger']();return new salesforce_1[(_0x53647e(0x13d))](_0x48a809,_0x43f358,_0x25b102,_0x34093c,null,[salesforce_1['MetadataType']['PERMISSION_SET']])[_0x53647e(0x15b)]();}async function mergePermissionSets(_0x2d8ff3,_0x470fe9){const _0x13b6a2=a87_0x5a13cd,_0x204e60=_0x470fe9[_0x13b6a2(0x150)]((_0x3341a8,_0x1ef644)=>_0x3341a8[_0x13b6a2(0x12b)](_0x1ef644[_0x13b6a2(0x176)]['fileName'],_0x1ef644),new Map());for(const _0x5f1c96 of _0x2d8ff3){const _0x34e613=PERMISSION_SET_FOLDER_NAME+'/'+_0x5f1c96[_0x13b6a2(0x156)],_0x131751=_0x204e60[_0x13b6a2(0x15a)](_0x34e613);if(!_0x131751)continue;const _0x190949=await zip_1[_0x13b6a2(0x134)][_0x13b6a2(0x12e)](_0x5f1c96[_0x13b6a2(0x136)]),_0x201093=await _0x190949['files'][_0x34e613]['async'](_0x13b6a2(0x133)),_0x24aa26=_0x131751[_0x13b6a2(0x126)][_0x34e613][_0x13b6a2(0x146)](),_0xbc88c5=await(0x0,extract_component_permissions_1[_0x13b6a2(0x149)])(_0x201093,_0x24aa26,_0x5f1c96['fileType']),_0x522d9b=zip_1[_0x13b6a2(0x134)][_0x13b6a2(0x16b)]();_0x522d9b[_0x13b6a2(0x11c)](_0x34e613,_0xbc88c5),_0x5f1c96[_0x13b6a2(0x136)]=await _0x522d9b['generateAsync']({'type':_0x13b6a2(0x153),'compression':_0x13b6a2(0x127),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x394f87,_0x21aeed,_0x1c78e2){const _0x17a7f4=a87_0x5a13cd;for(const _0x50e23f of _0x1c78e2){if(_0x394f87[_0x17a7f4(0x121)](_0x2f3f9c=>_0x2f3f9c!==_0x50e23f['fileType']))continue;const _0x333fc1=await zip_1['Zip'][_0x17a7f4(0x12e)](_0x50e23f[_0x17a7f4(0x136)]);for(const _0x4fb055 in _0x333fc1[_0x17a7f4(0x126)]){if(!_0x333fc1[_0x17a7f4(0x126)][_0x4fb055][_0x17a7f4(0x14c)]){let _0x47c44b=await _0x333fc1['files'][_0x4fb055][_0x17a7f4(0x11a)](_0x17a7f4(0x133));for(const _0x50c040 of Object[_0x17a7f4(0x15e)](_0x21aeed)){const _0x24a6e7=new RegExp('%%'+_0x50c040+'%%','g');_0x47c44b=_0x47c44b[_0x17a7f4(0x14b)](_0x24a6e7,_0x21aeed[_0x50c040]);}_0x333fc1['file'](_0x4fb055,_0x47c44b);}}_0x50e23f['body']=await _0x333fc1[_0x17a7f4(0x113)]({'type':_0x17a7f4(0x153),'compression':_0x17a7f4(0x127),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x4d0ca4,_0x20d70a){const _0x32d31b=a87_0x5a13cd,_0x3bc7ab=new mdapi_writer_1['MDApiWriter']({'components':_0x4d0ca4,'sourceDir':path_1[_0x32d31b(0x151)][_0x32d31b(0x13f)](process[_0x32d31b(0x142)](),_0x32d31b(0x13c),_0x20d70a,DEPLOY_DIR_NAME,_0x32d31b(0x131)),'skipChildErrors':![]});await _0x3bc7ab[_0x32d31b(0x15b)]();}async function generateAndWritePackageXML(_0x28e1f7,_0x126208,_0x18fd7e,_0x4d2d7a){const _0xda4725=a87_0x5a13cd,_0x4203e4=getComponentsTypeAndName(_0x28e1f7,_0x126208),_0x4e3485=[...new Set(_0x4203e4[_0xda4725(0x155)](_0x53df0f=>_0x53df0f[_0xda4725(0x138)]))],_0x319042={'Package':{'$':{'xmlns':_0xda4725(0x14d)},'types':[],'version':''+_0x4d2d7a}};for(const _0xc84549 of _0x4e3485){const _0x4f4f81=_0x4203e4[_0xda4725(0x171)](_0x29c4e3=>_0x29c4e3['type']===_0xc84549)[_0xda4725(0x155)](_0xc4661b=>_0xc4661b[_0xda4725(0x139)]),_0x5e7523={'members':_0x4f4f81,'name':_0xc84549};_0x319042[_0xda4725(0x132)][_0xda4725(0x16d)]['push'](_0x5e7523);}const _0x230452=new xml2js_1[(_0xda4725(0x163))]({'xmldec':{'version':_0xda4725(0x13e),'encoding':_0xda4725(0x165)}}),_0x42b06e=_0x230452['buildObject'](_0x319042);await fs_internal_1['FS'][_0xda4725(0x15d)](path_1[_0xda4725(0x151)][_0xda4725(0x13f)](process['cwd'](),_0xda4725(0x13c),_0x18fd7e,DEPLOY_DIR_NAME,_0xda4725(0x131),_0xda4725(0x170)),_0x42b06e);}function getComponentsTypeAndName(_0x5c1558,_0x22ad9e){const _0x39fc86=a87_0x5a13cd;return _0x5c1558[_0x39fc86(0x150)]((_0x2c7ee8,_0x3eb17f)=>{const _0x5528c7=_0x39fc86,_0x28c20a=_0x22ad9e[_0x5528c7(0x137)](_0x3eb902=>_0x3eb902['Id']===_0x3eb17f[_0x5528c7(0x167)]);return _0x28c20a&&_0x2c7ee8['push']({'name':_0x28c20a[_0x5528c7(0x147)][_0x5528c7(0x11d)],'type':salesforce_1[_0x5528c7(0x16c)][_0x5528c7(0x144)][_0x3eb17f[_0x5528c7(0x164)]]||_0x3eb17f[_0x5528c7(0x164)]}),_0x2c7ee8;},[]);}async function saveDestructiveChanges(_0x538f7f,_0x1d8e4d,_0x370483,_0x38fed0){const _0x180e3f=a87_0x5a13cd,_0x2c1fcd=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x538f7f,_0x1d8e4d))['toString']();await fs_internal_1['FS'][_0x180e3f(0x15d)](path_1[_0x180e3f(0x151)]['join'](process[_0x180e3f(0x142)](),_0x180e3f(0x13c),_0x38fed0,DEPLOY_DIR_NAME,_0x180e3f(0x131),_0x370483),_0x2c1fcd);}async function createDeployZip(_0x49746f){const _0x12fbd9=a87_0x5a13cd,_0x405646=new adm_zip_1[(_0x12fbd9(0x151))]();return await _0x405646[_0x12fbd9(0x162)](path_1[_0x12fbd9(0x151)]['join'](process[_0x12fbd9(0x142)](),_0x12fbd9(0x13c),_0x49746f,DEPLOY_DIR_NAME)),_0x405646;}async function insertZip(_0xc80638,_0x5b02a1,_0x150e6a,_0x3ee655,_0x79df52,_0x952970){const _0x5d4464=a87_0x5a13cd,_0x1e121c={'ParentId':_0x5b02a1,'Name':'BUILD'+_0x150e6a,'Description':_0x5d4464(0x13a)+_0x3ee655,'Body':_0x79df52},{data:_0x1aadbd}=await _0xc80638[_0x5d4464(0x122)]('/services/data/v'+_0x952970+_0x5d4464(0x166),_0x1e121c);return _0x1aadbd['id'];}