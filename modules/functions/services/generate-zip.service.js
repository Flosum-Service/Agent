const a86_0x2b068f=a86_0x2b8d;function a86_0x2b8d(_0x397ff9,_0xbc9b98){const _0x18d332=a86_0x38d0();return a86_0x2b8d=function(_0x361fab,_0x561472){_0x361fab=_0x361fab-0x127;let _0x38d03a=_0x18d332[_0x361fab];return _0x38d03a;},a86_0x2b8d(_0x397ff9,_0xbc9b98);}(function(_0xb9d08c,_0x23a726){const _0x5f5b99=a86_0x2b8d,_0x5c438c=_0xb9d08c();while(!![]){try{const _0x51c5a6=parseInt(_0x5f5b99(0x13a))/0x1*(parseInt(_0x5f5b99(0x16e))/0x2)+parseInt(_0x5f5b99(0x17c))/0x3+parseInt(_0x5f5b99(0x167))/0x4*(-parseInt(_0x5f5b99(0x13f))/0x5)+parseInt(_0x5f5b99(0x179))/0x6*(parseInt(_0x5f5b99(0x17b))/0x7)+parseInt(_0x5f5b99(0x15b))/0x8+parseInt(_0x5f5b99(0x15f))/0x9+-parseInt(_0x5f5b99(0x137))/0xa*(parseInt(_0x5f5b99(0x13c))/0xb);if(_0x51c5a6===_0x23a726)break;else _0x5c438c['push'](_0x5c438c['shift']());}catch(_0x3b0df4){_0x5c438c['push'](_0x5c438c['shift']());}}}(a86_0x38d0,0x1aa5d));const a86_0x561472=(function(){let _0x541957=!![];return function(_0x3c81d4,_0x50a69b){const _0x3ccbd6=_0x541957?function(){const _0x11735c=a86_0x2b8d;if(_0x50a69b){const _0x5962d6=_0x50a69b[_0x11735c(0x130)](_0x3c81d4,arguments);return _0x50a69b=null,_0x5962d6;}}:function(){};return _0x541957=![],_0x3ccbd6;};}()),a86_0x361fab=a86_0x561472(this,function(){const _0x43c213=a86_0x2b8d;return a86_0x361fab[_0x43c213(0x156)]()[_0x43c213(0x154)](_0x43c213(0x151))[_0x43c213(0x156)]()[_0x43c213(0x16c)](a86_0x361fab)['search']('(((.+)+)+)+$');});a86_0x361fab();'use strict';var __importDefault=this&&this[a86_0x2b068f(0x127)]||function(_0x2cd0ce){return _0x2cd0ce&&_0x2cd0ce['__esModule']?_0x2cd0ce:{'default':_0x2cd0ce};};Object[a86_0x2b068f(0x171)](exports,a86_0x2b068f(0x129),{'value':!![]}),exports[a86_0x2b068f(0x131)]=void 0x0;const constants_1=require(a86_0x2b068f(0x153)),path_1=__importDefault(require(a86_0x2b068f(0x145))),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a86_0x2b068f(0x166)),zip_1=require(a86_0x2b068f(0x159)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a86_0x2b068f(0x175)),promises_1=require(a86_0x2b068f(0x14b)),components_api_1=require(a86_0x2b068f(0x162)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require('uuid'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x2b068f(0x147),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x2b068f(0x134),DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x44c6bf,isExtractComponentsPermissions:_0x56f06d,preDestructiveAttachmentId:_0x2f990f,postDestructiveAttachmentId:_0x28aa71,branchId:_0x5104b3,credentials:_0x8ed3fd,metadataLogId:_0x42115d,environments:_0x11f500,metaTypes:_0xef4928},_0x3e77e3){const _0x48333a=a86_0x2b068f,_0x3a5bea=(0x0,uuid_1['v4'])();try{const _0x13ecac=await(0x0,fetch_attachments_1[_0x48333a(0x132)])(_0x3e77e3,_0x44c6bf),_0x37731f=_0x13ecac[_0x48333a(0x160)]((_0x3d9062,_0x1d882c)=>({..._0x3d9062,[_0x1d882c['Id']]:_0x1d882c[_0x48333a(0x12f)]}),{}),_0xd89f8=await getComponents(_0x13ecac,_0x3e77e3,_0x37731f),_0x2e7fa6=await components_api_1[_0x48333a(0x17e)]['fetchComponentsDetailsByComponentsHistory'](_0x3e77e3,_0x13ecac[_0x48333a(0x155)](({ParentId:_0x346c48})=>_0x346c48))[_0x48333a(0x128)](_0x51a86b=>components_api_1['ComponentsApi'][_0x48333a(0x12d)](_0x51a86b));if(_0x56f06d){const _0x4b992c=_0xd89f8['filter'](({fileType:_0x2c3cdb})=>_0x2c3cdb===_0x48333a(0x12c)||_0x2c3cdb===_0x48333a(0x182));await removePermission(_0x4b992c,_0x2e7fa6);}await replaceEnvironments(_0xef4928,_0x11f500,_0xd89f8),await writeZip(_0xd89f8,_0x3a5bea),await generateAndWritePackageXML(_0x13ecac,_0x2e7fa6,_0x3a5bea);_0x2f990f&&await saveDestructiveChanges(_0x3e77e3,_0x2f990f,DESTRUCTIVE_CHANGES_PER_NAME,_0x3a5bea);_0x28aa71&&await saveDestructiveChanges(_0x3e77e3,_0x28aa71,DESTRUCTIVE_CHANGES_POST_NAME,_0x3a5bea);const _0x2f488a=(await createDeployZip(_0x3a5bea)[_0x48333a(0x128)](_0x4b7488=>{return _0x4b7488;}))[_0x48333a(0x157)]()[_0x48333a(0x156)](_0x48333a(0x174));console['log'](_0x48333a(0x152));const _0x453012=_0x2f488a[_0x48333a(0x13e)];if(_0x453012>=components_api_1[_0x48333a(0x146)]){const _0x4c087e=await createDeployZip(_0x3a5bea);console[_0x48333a(0x144)](_0x48333a(0x149));const [_0x351bb7,_0x411f6d]=await components_api_1[_0x48333a(0x17e)][_0x48333a(0x177)](_0x4c087e,_0x453012),_0x1589e9=await insertZip(_0x3e77e3,_0x5104b3,_0x8ed3fd[_0x48333a(0x13b)],_0x42115d,_0x351bb7['toBuffer']()[_0x48333a(0x156)](_0x48333a(0x174))),_0x1e14e=await insertZip(_0x3e77e3,_0x5104b3,_0x8ed3fd[_0x48333a(0x13b)],_0x42115d,_0x411f6d['toBuffer']()[_0x48333a(0x156)](_0x48333a(0x174)));return _0x1589e9+','+_0x1e14e;}else return await insertZip(_0x3e77e3,_0x5104b3,_0x8ed3fd[_0x48333a(0x13b)],_0x42115d,_0x2f488a);}catch(_0x15cb47){throw _0x15cb47;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x48333a(0x135)]['join'](process[_0x48333a(0x138)](),_0x48333a(0x178),_0x3a5bea)))await(0x0,promises_1['rm'])(path_1['default'][_0x48333a(0x170)](process[_0x48333a(0x138)](),_0x48333a(0x178),_0x3a5bea),{'recursive':!![]});}}exports[a86_0x2b068f(0x131)]=generateAndDeployZip;function a86_0x38d0(){const _0x3acc3f=['8qDdAMM','Body','buildObject','fileName','files','constructor','fetchAttachmentBody','14tHRQXZ','replace','join','defineProperty','text','dir','base64','../../git/internal/fs.internal','/sobjects/Attachment','splitZip','.temp','42DCWuwu','generateAsync','175553yxpEeF','239127wvZSQn','indexOf','ComponentsApi','file','fileType','push','PermissionSet','__importDefault','then','__esModule','unzip','filter','Profile','removeNamespacePrefix','ParentId','Name','apply','generateAndDeployZip','fetchAttachmentsDetailsById','SALESFORCE_API_VERSION','destructiveChangesPost.xml','default','type','130YqgiGh','cwd','UTF-8','12914UUHYfN','orgId','304909UvQUtN','every','length','209905KJCoHD','DEFLATE','find','BUILD','extractComponentPermissions','log','path','MAX_ZIP_SIZE','destructiveChangesPre.xml','Builder','after\x20create\x20second\x20zip','values','fs/promises','/services/data/','src','MDApiWriter','body','Package','(((.+)+)+)+$','after\x20create\x20zip','../../../constants','search','map','toString','toBuffer','createZip','../../git/parsers/utils/zip','Component__r','1649272IANoFL','addLocalFolder','1.0','http://soap.sforce.com/2006/04/metadata','14751fwhMcc','reduce','keys','../utils/components-api','types','async','Zip','xml2js'];a86_0x38d0=function(){return _0x3acc3f;};return a86_0x38d0();}async function getComponents(_0x229ed5,_0x16e15e,_0x461122){const _0x445937=a86_0x2b068f,_0x3c8c09=[],_0x22b516=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x229ed5,_0x16e15e);return await getComponentFromZip(_0x22b516,_0x461122)[_0x445937(0x128)](_0x4feb26=>{const _0x59b45=_0x445937;_0x3c8c09[_0x59b45(0x181)](..._0x4feb26);}),_0x3c8c09;}async function getComponentFromZip(_0x4bd7c7,_0x5a21de){const _0x5f44af=a86_0x2b068f,_0x491fc8=[];for(const _0x50e608 of _0x4bd7c7){const _0x4a33cb=await zip_1[_0x5f44af(0x165)]['unzip'](_0x50e608[_0x5f44af(0x14a)]['Body']);for(const _0x741f9f in _0x4a33cb['files']){!_0x4a33cb[_0x5f44af(0x16b)][_0x741f9f][_0x5f44af(0x173)]&&_0x491fc8[_0x5f44af(0x181)]({'fileName':_0x741f9f['substring'](_0x741f9f[_0x5f44af(0x17d)]('/')+0x1),'fileType':_0x5a21de[_0x50e608['id']],'body':_0x50e608[_0x5f44af(0x14a)][_0x5f44af(0x168)]});}}return _0x491fc8;}async function removePermission(_0x3f9a14,_0x5afa0d){const _0x4e9b0a=a86_0x2b068f;for(const _0x14fe14 of _0x3f9a14){const _0x57c62e=await zip_1['Zip'][_0x4e9b0a(0x12a)](_0x14fe14[_0x4e9b0a(0x14f)]),_0x434e1f=[];for(const _0x3a8c40 in _0x57c62e['files']){!_0x57c62e[_0x4e9b0a(0x16b)][_0x3a8c40][_0x4e9b0a(0x173)]&&_0x434e1f[_0x4e9b0a(0x181)]({'fileName':_0x3a8c40,'body':await _0x57c62e['files'][_0x3a8c40][_0x4e9b0a(0x164)](_0x4e9b0a(0x172))});}const _0x32d56a=await(0x0,extract_component_permissions_1[_0x4e9b0a(0x143)])(_0x434e1f[0x0][_0x4e9b0a(0x14f)][_0x4e9b0a(0x156)](),_0x5afa0d,_0x14fe14[_0x4e9b0a(0x180)]),_0x3b8324=new xml2js_1[(_0x4e9b0a(0x148))]({'xmldec':{'version':'1.0','encoding':_0x4e9b0a(0x139)}}),_0x1c98fe=_0x3b8324[_0x4e9b0a(0x169)](_0x32d56a),_0x142379=zip_1[_0x4e9b0a(0x165)][_0x4e9b0a(0x158)]();_0x142379['file'](_0x434e1f[0x0][_0x4e9b0a(0x16a)],_0x1c98fe),_0x14fe14['body']=await _0x142379[_0x4e9b0a(0x17a)]({'type':_0x4e9b0a(0x174),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x1d0541,_0x2d5240,_0x6ce26e){const _0x69112a=a86_0x2b068f;for(const _0x29dbc2 of _0x6ce26e){if(_0x1d0541[_0x69112a(0x13d)](_0x517e1e=>_0x517e1e!==_0x29dbc2[_0x69112a(0x180)]))continue;const _0x4805d6=await zip_1['Zip'][_0x69112a(0x12a)](_0x29dbc2[_0x69112a(0x14f)]);for(const _0x9fb73e in _0x4805d6['files']){if(!_0x4805d6['files'][_0x9fb73e][_0x69112a(0x173)]){let _0x2eb2a4=await _0x4805d6['files'][_0x9fb73e]['async'](_0x69112a(0x172));for(const _0x1f8a64 of Object[_0x69112a(0x161)](_0x2d5240)){const _0x7b844a=new RegExp('%%'+_0x1f8a64+'%%','g');_0x2eb2a4=_0x2eb2a4[_0x69112a(0x16f)](_0x7b844a,_0x2d5240[_0x1f8a64]);}_0x4805d6[_0x69112a(0x17f)](_0x9fb73e,_0x2eb2a4);}}_0x29dbc2['body']=await _0x4805d6[_0x69112a(0x17a)]({'type':_0x69112a(0x174),'compression':_0x69112a(0x140),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x483a73,_0x16bd60){const _0xa88db5=a86_0x2b068f,_0x5c68e2=new mdapi_1[(_0xa88db5(0x14e))]({'components':_0x483a73,'sourceDir':path_1[_0xa88db5(0x135)][_0xa88db5(0x170)](process[_0xa88db5(0x138)](),_0xa88db5(0x178),_0x16bd60,DEPLOY_DIR_NAME,_0xa88db5(0x14d)),'skipChildErrors':![]});await _0x5c68e2['start']();}async function generateAndWritePackageXML(_0x68aba6,_0x35b85f,_0x1983cf){const _0x1b0b2c=a86_0x2b068f,_0x3a7fee=getComponentsTypeAndName(_0x68aba6,_0x35b85f),_0x424115=[...new Set(_0x3a7fee[_0x1b0b2c(0x155)](_0x31fbdd=>_0x31fbdd[_0x1b0b2c(0x136)]))],_0xbac024={'Package':{'$':{'xmlns':_0x1b0b2c(0x15e)},'types':[],'version':''+constants_1[_0x1b0b2c(0x133)]['substring'](0x1)}};for(const _0x427e2d of _0x424115){const _0x213594=_0x3a7fee[_0x1b0b2c(0x12b)](_0x175d4c=>_0x175d4c[_0x1b0b2c(0x136)]===_0x427e2d)[_0x1b0b2c(0x155)](_0xf515c4=>_0xf515c4['name']),_0x481cc0={'members':_0x213594,'name':_0x427e2d};_0xbac024[_0x1b0b2c(0x150)][_0x1b0b2c(0x163)][_0x1b0b2c(0x181)](_0x481cc0);}const _0x4b4b68=new xml2js_1[(_0x1b0b2c(0x148))]({'xmldec':{'version':_0x1b0b2c(0x15d),'encoding':_0x1b0b2c(0x139)}}),_0x58c857=_0x4b4b68[_0x1b0b2c(0x169)](_0xbac024);await fs_internal_1['FS']['writeFile'](path_1[_0x1b0b2c(0x135)][_0x1b0b2c(0x170)](process['cwd'](),_0x1b0b2c(0x178),_0x1983cf,DEPLOY_DIR_NAME,_0x1b0b2c(0x14d),'package.xml'),_0x58c857);}function getComponentsTypeAndName(_0x5abe85,_0x32d2cf){const _0x43772f=a86_0x2b068f;return _0x5abe85[_0x43772f(0x160)]((_0xd89aba,_0x356321)=>{const _0x53c7bb=_0x43772f,_0x4827fb=_0x32d2cf[_0x53c7bb(0x141)](_0x54e505=>_0x54e505['Id']===_0x356321[_0x53c7bb(0x12e)]);return _0x4827fb&&_0xd89aba[_0x53c7bb(0x181)]({'name':_0x4827fb[_0x53c7bb(0x15a)]['Component_Name__c'],'type':_0x356321[_0x53c7bb(0x12f)]}),_0xd89aba;},[]);}async function saveDestructiveChanges(_0x49054e,_0x56fd0b,_0x49bc16,_0x4c1526){const _0x548460=a86_0x2b068f,_0x2bbd8e=(await(0x0,fetch_attachments_1[_0x548460(0x16d)])(_0x49054e,_0x56fd0b))[_0x548460(0x156)]();await fs_internal_1['FS']['writeFile'](path_1[_0x548460(0x135)][_0x548460(0x170)](process[_0x548460(0x138)](),_0x548460(0x178),_0x4c1526,DEPLOY_DIR_NAME,_0x548460(0x14d),_0x49bc16),_0x2bbd8e);}async function createDeployZip(_0x4369a2){const _0x384d79=a86_0x2b068f,_0x382232=new adm_zip_1[(_0x384d79(0x135))]();return await _0x382232[_0x384d79(0x15c)](path_1[_0x384d79(0x135)]['join'](process[_0x384d79(0x138)](),'.temp',_0x4369a2,DEPLOY_DIR_NAME)),_0x382232;}async function insertZip(_0x55fedb,_0x24f54a,_0x3eb21b,_0x22758b,_0x64b691){const _0x4cb605=a86_0x2b068f,_0x4a62ea={'ParentId':_0x24f54a,'Name':_0x4cb605(0x142)+_0x3eb21b,'Description':_0x4cb605(0x142)+_0x22758b,'Body':_0x64b691},{data:_0x29dea3}=await _0x55fedb['post'](_0x4cb605(0x14c)+constants_1['SALESFORCE_API_VERSION']+_0x4cb605(0x176),_0x4a62ea);return _0x29dea3['id'];}