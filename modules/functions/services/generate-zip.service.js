const a104_0x5577b0=a104_0x1b53;(function(_0x584422,_0x22893d){const _0x271ab8=a104_0x1b53,_0x549405=_0x584422();while(!![]){try{const _0x45a6fe=parseInt(_0x271ab8(0xc3))/0x1*(-parseInt(_0x271ab8(0xd3))/0x2)+parseInt(_0x271ab8(0xe5))/0x3*(parseInt(_0x271ab8(0xf8))/0x4)+-parseInt(_0x271ab8(0xf9))/0x5+parseInt(_0x271ab8(0xea))/0x6+parseInt(_0x271ab8(0xca))/0x7*(parseInt(_0x271ab8(0xe8))/0x8)+-parseInt(_0x271ab8(0x109))/0x9+parseInt(_0x271ab8(0xe4))/0xa;if(_0x45a6fe===_0x22893d)break;else _0x549405['push'](_0x549405['shift']());}catch(_0x13464e){_0x549405['push'](_0x549405['shift']());}}}(a104_0x212d,0x6f9ef));const a104_0x3579d4=(function(){let _0x2f738f=!![];return function(_0x4616b0,_0x28162e){const _0x4d01a3=_0x2f738f?function(){const _0xfe82c7=a104_0x1b53;if(_0x28162e){const _0x24115f=_0x28162e[_0xfe82c7(0xc7)](_0x4616b0,arguments);return _0x28162e=null,_0x24115f;}}:function(){};return _0x2f738f=![],_0x4d01a3;};}()),a104_0x71f7f3=a104_0x3579d4(this,function(){const _0x40a571=a104_0x1b53;return a104_0x71f7f3['toString']()['search']('(((.+)+)+)+$')[_0x40a571(0x11c)]()[_0x40a571(0x10b)](a104_0x71f7f3)['search']('(((.+)+)+)+$');});a104_0x71f7f3();function a104_0x1b53(_0x32b295,_0x24c010){const _0x62b2cb=a104_0x212d();return a104_0x1b53=function(_0x71f7f3,_0x3579d4){_0x71f7f3=_0x71f7f3-0xc1;let _0x212d84=_0x62b2cb[_0x71f7f3];return _0x212d84;},a104_0x1b53(_0x32b295,_0x24c010);}'use strict';var __importDefault=this&&this[a104_0x5577b0(0xdf)]||function(_0x58854f){return _0x58854f&&_0x58854f['__esModule']?_0x58854f:{'default':_0x58854f};};Object[a104_0x5577b0(0x110)](exports,a104_0x5577b0(0xd9),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require('../utils/extract-component-permissions'),logger_1=require(a104_0x5577b0(0xd1)),xml2js_1=require('xml2js'),zip_1=require(a104_0x5577b0(0xed)),mdapi_writer_1=require(a104_0x5577b0(0xfc)),fs_internal_1=require(a104_0x5577b0(0xeb)),promises_1=require(a104_0x5577b0(0x108)),components_api_1=require(a104_0x5577b0(0x10a)),adm_zip_1=__importDefault(require(a104_0x5577b0(0xc4))),uuid_1=require(a104_0x5577b0(0x102)),fetch_attachments_1=require(a104_0x5577b0(0xfa)),salesforce_1=require(a104_0x5577b0(0xdc)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a104_0x5577b0(0x125),PERMISSION_SET_FOLDER_NAME=a104_0x5577b0(0xce);async function generateAndDeployZip({attachmentsId:_0x59107f,isExtractComponentsPermissionSets:_0x1ad372,isExtractComponentsProfiles:_0x305af2,preDestructiveAttachmentId:_0x1791be,postDestructiveAttachmentId:_0x208978,branchId:_0x122317,credentials:_0x4a7b7d,metadataLogId:_0x3beacf,environments:_0x4c57b4,metaTypes:_0x2ad9a9,apiVersion:_0x5361b4},_0x11931c,_0x3e602b){const _0x326763=a104_0x5577b0;var _0x562f5d;const _0x4b3932=(0x0,uuid_1['v4'])();try{const _0x2637f8=await(0x0,fetch_attachments_1[_0x326763(0xd0)])(_0x11931c,_0x59107f),_0x2f8d9d=_0x2637f8['reduce']((_0x5ce8bb,_0x13bef6)=>({..._0x5ce8bb,[_0x13bef6['Id']]:_0x13bef6[_0x326763(0x103)]}),{}),_0x5c87ce=await getComponents(_0x2637f8,_0x11931c,_0x2f8d9d),_0x50a33e=await components_api_1['ComponentsApi'][_0x326763(0x100)](_0x11931c,_0x2637f8[_0x326763(0xf3)](({ParentId:_0x2b6ba6})=>_0x2b6ba6),_0x5361b4)[_0x326763(0xde)](_0x58c85f=>components_api_1['ComponentsApi'][_0x326763(0x112)](_0x58c85f));if(_0x305af2){const _0x8dc25a=_0x5c87ce[_0x326763(0xf2)](({fileType:_0x233fa3})=>_0x233fa3===_0x326763(0xcb));await removePermission(_0x8dc25a,_0x50a33e);}const _0x4e9e86=_0x5c87ce[_0x326763(0xf2)](({fileType:_0x2528bf})=>_0x2528bf===_0x326763(0x123));if(_0x4e9e86['length']&&_0x1ad372){await removePermission(_0x4e9e86,_0x50a33e);const {items:_0x596c83}=await retrieveTargetPermissionSets(_0x4e9e86,_0x5361b4,_0x3e602b);await mergePermissionSets(_0x4e9e86,((_0x562f5d=_0x596c83[_0x326763(0x123)])===null||_0x562f5d===void 0x0?void 0x0:_0x562f5d[_0x326763(0xe2)])||[]);}await replaceEnvironments(_0x2ad9a9,_0x4c57b4,_0x5c87ce),await writeZip(_0x5c87ce,_0x4b3932),await generateAndWritePackageXML(_0x2637f8,_0x50a33e,_0x4b3932,_0x5361b4);_0x1791be&&await saveDestructiveChanges(_0x11931c,_0x1791be,DESTRUCTIVE_CHANGES_PER_NAME,_0x4b3932);_0x208978&&await saveDestructiveChanges(_0x11931c,_0x208978,DESTRUCTIVE_CHANGES_POST_NAME,_0x4b3932);const _0x34984b=(await createDeployZip(_0x4b3932)[_0x326763(0xde)](_0x14168a=>{return _0x14168a;}))[_0x326763(0xe0)]()[_0x326763(0x11c)](_0x326763(0x11a)),_0x47e1c1=_0x34984b[_0x326763(0xc2)];if(_0x47e1c1>=components_api_1[_0x326763(0xf1)]){const _0x58c895=await createDeployZip(_0x4b3932),[_0x346dac,_0x248ba5]=await components_api_1['ComponentsApi'][_0x326763(0xd7)](_0x58c895,_0x47e1c1),_0x3cebea=await insertZip(_0x11931c,_0x122317,_0x4a7b7d[_0x326763(0xdd)],_0x3beacf,_0x346dac[_0x326763(0xe0)]()[_0x326763(0x11c)]('base64'),_0x5361b4),_0x2cfac8=await insertZip(_0x11931c,_0x122317,_0x4a7b7d[_0x326763(0xdd)],_0x3beacf,_0x248ba5[_0x326763(0xe0)]()[_0x326763(0x11c)](_0x326763(0x11a)),_0x5361b4);return _0x3cebea+','+_0x2cfac8;}else return await insertZip(_0x11931c,_0x122317,_0x4a7b7d[_0x326763(0xdd)],_0x3beacf,_0x34984b,_0x5361b4);}catch(_0x30cfed){throw _0x30cfed;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x326763(0xcc)][_0x326763(0xef)](process[_0x326763(0xd2)](),_0x326763(0xc8),_0x4b3932)))await(0x0,promises_1['rm'])(path_1[_0x326763(0xcc)][_0x326763(0xef)](process[_0x326763(0xd2)](),_0x326763(0xc8),_0x4b3932),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x3193a4,_0x3cd916,_0x4cbd3f){const _0x193a2b=a104_0x5577b0,_0x1d14f6=[],_0xbe3bb8=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x3193a4,_0x3cd916);return await getComponentFromZip(_0xbe3bb8,_0x4cbd3f)[_0x193a2b(0xde)](_0x53d003=>{_0x1d14f6['push'](..._0x53d003);}),_0x1d14f6;}async function getComponentFromZip(_0x50acf0,_0x106631){const _0x5c0337=a104_0x5577b0,_0x33d887=[];for(const _0x17c7ad of _0x50acf0){const _0x5089b9=await zip_1[_0x5c0337(0x114)]['unzip'](_0x17c7ad[_0x5c0337(0x11f)][_0x5c0337(0x116)]);for(const _0x5568a6 in _0x5089b9[_0x5c0337(0xe7)]){!_0x5089b9[_0x5c0337(0xe7)][_0x5568a6][_0x5c0337(0xec)]&&_0x33d887[_0x5c0337(0x10f)]({'fileName':_0x5568a6[_0x5c0337(0x105)](_0x5568a6[_0x5c0337(0xe9)]('/')+0x1),'fileType':_0x106631[_0x17c7ad['id']],'body':_0x17c7ad[_0x5c0337(0x11f)][_0x5c0337(0x116)]});}}return _0x33d887;}async function removePermission(_0x5b1934,_0x22ae51){const _0x249bd4=a104_0x5577b0;for(const _0x551890 of _0x5b1934){const _0x48344b=await zip_1[_0x249bd4(0x114)][_0x249bd4(0x113)](_0x551890['body']),_0x5307bc=[];for(const _0x2541ce in _0x48344b[_0x249bd4(0xe7)]){!_0x48344b[_0x249bd4(0xe7)][_0x2541ce][_0x249bd4(0xec)]&&_0x5307bc[_0x249bd4(0x10f)]({'fileName':_0x2541ce,'body':await _0x48344b[_0x249bd4(0xe7)][_0x2541ce][_0x249bd4(0x10e)](_0x249bd4(0x118))});}const _0x573a51=await(0x0,extract_component_permissions_1[_0x249bd4(0xf0)])(_0x5307bc[0x0]['body'][_0x249bd4(0x11c)](),_0x22ae51,_0x551890[_0x249bd4(0xf4)]),_0x2162ed=new xml2js_1['Builder']({'xmldec':{'version':_0x249bd4(0xc1),'encoding':'UTF-8'}}),_0x3bc9d7=_0x2162ed[_0x249bd4(0x122)](_0x573a51),_0x44e2da=zip_1['Zip'][_0x249bd4(0xc6)]();_0x44e2da[_0x249bd4(0x11e)](_0x5307bc[0x0][_0x249bd4(0x10d)],_0x3bc9d7),_0x551890[_0x249bd4(0xd5)]=await _0x44e2da[_0x249bd4(0xcd)]({'type':_0x249bd4(0x11a),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x100f63,_0x21532c,_0x207c0a){const _0x5b8098=a104_0x5577b0,_0x4006c5=_0x100f63[_0x5b8098(0xf3)](_0x317b33=>PERMISSION_SET_FOLDER_NAME+'/'+_0x317b33[_0x5b8098(0x10d)])[_0x5b8098(0xef)](';'),_0x5746a7=[{'field':_0x5b8098(0x10d),'option':salesforce_1[_0x5b8098(0xd8)]['IN'],'value':_0x4006c5}],_0x5bdde9=new logger_1[(_0x5b8098(0x124))]();return new salesforce_1[(_0x5b8098(0xc5))](_0x21532c,_0x207c0a,_0x5bdde9,_0x5746a7,null,[salesforce_1[_0x5b8098(0xf5)]['PERMISSION_SET']])[_0x5b8098(0x120)]();}async function mergePermissionSets(_0x42b853,_0xace623){const _0x3c507b=a104_0x5577b0,_0x33fdba=_0xace623[_0x3c507b(0x115)]((_0x584258,_0x100ed3)=>_0x584258[_0x3c507b(0xe6)](_0x100ed3['listMetadataItem'][_0x3c507b(0x10d)],_0x100ed3),new Map());for(const _0x501646 of _0x42b853){const _0x592bbb=PERMISSION_SET_FOLDER_NAME+'/'+_0x501646[_0x3c507b(0x10d)],_0x3374ba=_0x33fdba[_0x3c507b(0x101)](_0x592bbb);if(!_0x3374ba)continue;const _0x50deed=await zip_1['Zip'][_0x3c507b(0x113)](_0x501646[_0x3c507b(0xd5)]),_0x133cfe=await _0x50deed[_0x3c507b(0xe7)][_0x592bbb]['async'](_0x3c507b(0x118)),_0x4ae39b=_0x3374ba[_0x3c507b(0xe7)][_0x592bbb]['toString'](),_0x1bfa9a=await(0x0,extract_component_permissions_1[_0x3c507b(0xfd)])(_0x133cfe,_0x4ae39b,_0x501646['fileType']),_0x54daa0=zip_1[_0x3c507b(0x114)][_0x3c507b(0xc6)]();_0x54daa0[_0x3c507b(0x11e)](_0x592bbb,_0x1bfa9a),_0x501646['body']=await _0x54daa0['generateAsync']({'type':_0x3c507b(0x11a),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x20813a,_0x58bfaf,_0x4e657e){const _0x1cc2a7=a104_0x5577b0;for(const _0x27325e of _0x4e657e){if(_0x20813a[_0x1cc2a7(0xf7)](_0x1ec3e1=>_0x1ec3e1!==_0x27325e[_0x1cc2a7(0xf4)]))continue;const _0x27eef8=await zip_1[_0x1cc2a7(0x114)][_0x1cc2a7(0x113)](_0x27325e['body']);for(const _0x3ad5b9 in _0x27eef8[_0x1cc2a7(0xe7)]){if(!_0x27eef8[_0x1cc2a7(0xe7)][_0x3ad5b9][_0x1cc2a7(0xec)]){let _0x3d6d49=await _0x27eef8['files'][_0x3ad5b9][_0x1cc2a7(0x10e)](_0x1cc2a7(0x118));for(const _0x46c692 of Object[_0x1cc2a7(0xd6)](_0x58bfaf)){const _0x8c24ff=new RegExp('%%'+_0x46c692+'%%','g');_0x3d6d49=_0x3d6d49[_0x1cc2a7(0xc9)](_0x8c24ff,_0x58bfaf[_0x46c692]);}_0x27eef8['file'](_0x3ad5b9,_0x3d6d49);}}_0x27325e['body']=await _0x27eef8['generateAsync']({'type':_0x1cc2a7(0x11a),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x393c34,_0x46709e){const _0x427522=a104_0x5577b0,_0x4ec2f6=new mdapi_writer_1[(_0x427522(0x11d))]({'components':_0x393c34,'sourceDir':path_1[_0x427522(0xcc)][_0x427522(0xef)](process[_0x427522(0xd2)](),_0x427522(0xc8),_0x46709e,DEPLOY_DIR_NAME,_0x427522(0x111)),'skipChildErrors':![]});await _0x4ec2f6[_0x427522(0x120)]();}async function generateAndWritePackageXML(_0x102300,_0xd17f1a,_0x24d664,_0x1a3ddf){const _0x565093=a104_0x5577b0,_0x36afee=getComponentsTypeAndName(_0x102300,_0xd17f1a),_0x14b618=[...new Set(_0x36afee['map'](_0x3923f8=>_0x3923f8['type']))],_0x3b2a04={'Package':{'$':{'xmlns':_0x565093(0xfe)},'types':[],'version':''+_0x1a3ddf}};for(const _0x5d86bb of _0x14b618){const _0x1300aa=_0x36afee[_0x565093(0xf2)](_0x1c2653=>_0x1c2653['type']===_0x5d86bb)['map'](_0x523f86=>_0x523f86[_0x565093(0xe3)]),_0x4be2f3={'members':_0x1300aa,'name':_0x5d86bb};_0x3b2a04[_0x565093(0xdb)][_0x565093(0xcf)]['push'](_0x4be2f3);}const _0x222f29=new xml2js_1[(_0x565093(0xfb))]({'xmldec':{'version':'1.0','encoding':_0x565093(0xee)}}),_0x316d4b=_0x222f29[_0x565093(0x122)](_0x3b2a04);await fs_internal_1['FS'][_0x565093(0xff)](path_1[_0x565093(0xcc)][_0x565093(0xef)](process[_0x565093(0xd2)](),'.temp',_0x24d664,DEPLOY_DIR_NAME,_0x565093(0x111),_0x565093(0x10c)),_0x316d4b);}function getComponentsTypeAndName(_0x587a6f,_0xdd5986){return _0x587a6f['reduce']((_0x556924,_0x2fc1bb)=>{const _0x36c4e6=a104_0x1b53,_0x17ab71=_0xdd5986[_0x36c4e6(0x119)](_0x3164f5=>_0x3164f5['Id']===_0x2fc1bb[_0x36c4e6(0x117)]);return _0x17ab71&&_0x556924[_0x36c4e6(0x10f)]({'name':_0x17ab71[_0x36c4e6(0xf6)][_0x36c4e6(0x121)],'type':salesforce_1[_0x36c4e6(0xe1)][_0x36c4e6(0x11b)][_0x2fc1bb[_0x36c4e6(0x103)]]||_0x2fc1bb[_0x36c4e6(0x103)]}),_0x556924;},[]);}async function saveDestructiveChanges(_0x2558a0,_0x5e0375,_0x3f99dc,_0x3b9a10){const _0x451fb9=a104_0x5577b0,_0x316052=(await(0x0,fetch_attachments_1[_0x451fb9(0x107)])(_0x2558a0,_0x5e0375))[_0x451fb9(0x11c)]();await fs_internal_1['FS']['writeFile'](path_1['default'][_0x451fb9(0xef)](process[_0x451fb9(0xd2)](),_0x451fb9(0xc8),_0x3b9a10,DEPLOY_DIR_NAME,_0x451fb9(0x111),_0x3f99dc),_0x316052);}async function createDeployZip(_0x1f9494){const _0x469d09=a104_0x5577b0,_0x2353d2=new adm_zip_1[(_0x469d09(0xcc))]();return await _0x2353d2[_0x469d09(0x106)](path_1['default'][_0x469d09(0xef)](process[_0x469d09(0xd2)](),'.temp',_0x1f9494,DEPLOY_DIR_NAME)),_0x2353d2;}async function insertZip(_0x4cf5b9,_0xc0a19b,_0x467d06,_0x42a3d2,_0x38fae3,_0x3594ae){const _0x2d8170=a104_0x5577b0,_0x2dd4a7={'ParentId':_0xc0a19b,'Name':_0x2d8170(0x104)+_0x467d06,'Description':_0x2d8170(0x104)+_0x42a3d2,'Body':_0x38fae3},{data:_0x378a27}=await _0x4cf5b9[_0x2d8170(0xd4)]('/services/data/v'+_0x3594ae+_0x2d8170(0xda),_0x2dd4a7);return _0x378a27['id'];}function a104_0x212d(){const _0x260c32=['find','base64','FOLDER_TO_METADATA_TYPE_MAP','toString','MDApiWriter','file','values','execute','Component_Name__c','buildObject','PermissionSet','Logger','DEPLOYZIP','1.0','length','1Zectmr','adm-zip','PartialRetrieve','createZip','apply','.temp','replace','1505595cKSkbJ','Profile','default','generateAsync','permissionsets','types','fetchAttachmentsDetailsById','../classes/logger','cwd','6616TosfKa','post','body','keys','splitZip','DeclarativeFilterOptions','__esModule','/sobjects/Attachment','Package','@flosum/salesforce','orgId','then','__importDefault','toBuffer','MetadataConstants','components','name','3009460edBJOt','3uTlFDn','set','files','24vRfoEC','indexOf','3860370WtZGuY','../../git/internal/fs.internal','dir','../../git/parsers/utils/zip','UTF-8','join','extractComponentPermissions','MAX_ZIP_SIZE','filter','map','fileType','MetadataType','Component__r','every','501464oxZhBb','4385685RXrIbk','../../shared/utils/fetch-attachments','Builder','../../git/writers/mdapi.writer','mergeComponentPermissions','http://soap.sforce.com/2006/04/metadata','writeFile','fetchComponentsDetailsByComponentsHistory','get','uuid','Name','BUILD','substring','addLocalFolder','fetchAttachmentBody','fs/promises','3395862vtMYYA','../utils/components-api','constructor','package.xml','fileName','async','push','defineProperty','src','removeNamespacePrefix','unzip','Zip','reduce','Body','ParentId','text'];a104_0x212d=function(){return _0x260c32;};return a104_0x212d();}