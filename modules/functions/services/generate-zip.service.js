const a104_0x3be202=a104_0x4fba;(function(_0x18cd07,_0x2c2722){const _0x273246=a104_0x4fba,_0x4b943b=_0x18cd07();while(!![]){try{const _0xc2aaa8=parseInt(_0x273246(0x158))/0x1+parseInt(_0x273246(0x13b))/0x2*(-parseInt(_0x273246(0xfc))/0x3)+parseInt(_0x273246(0x10c))/0x4*(parseInt(_0x273246(0x124))/0x5)+parseInt(_0x273246(0x136))/0x6*(parseInt(_0x273246(0x122))/0x7)+-parseInt(_0x273246(0x109))/0x8*(parseInt(_0x273246(0xff))/0x9)+-parseInt(_0x273246(0x10b))/0xa*(parseInt(_0x273246(0x140))/0xb)+-parseInt(_0x273246(0xf2))/0xc*(-parseInt(_0x273246(0x15b))/0xd);if(_0xc2aaa8===_0x2c2722)break;else _0x4b943b['push'](_0x4b943b['shift']());}catch(_0x36cca7){_0x4b943b['push'](_0x4b943b['shift']());}}}(a104_0x19a5,0x74731));const a104_0x3bc222=(function(){let _0x410d70=!![];return function(_0x4bdd8d,_0x5b20b2){const _0x280fa5=_0x410d70?function(){const _0x186979=a104_0x4fba;if(_0x5b20b2){const _0x10c661=_0x5b20b2[_0x186979(0xf5)](_0x4bdd8d,arguments);return _0x5b20b2=null,_0x10c661;}}:function(){};return _0x410d70=![],_0x280fa5;};}()),a104_0x262170=a104_0x3bc222(this,function(){const _0x4a76df=a104_0x4fba;return a104_0x262170[_0x4a76df(0x114)]()[_0x4a76df(0x126)](_0x4a76df(0x130))[_0x4a76df(0x114)]()[_0x4a76df(0x11f)](a104_0x262170)[_0x4a76df(0x126)]('(((.+)+)+)+$');});a104_0x262170();'use strict';var __importDefault=this&&this[a104_0x3be202(0x147)]||function(_0xe37f9e){return _0xe37f9e&&_0xe37f9e['__esModule']?_0xe37f9e:{'default':_0xe37f9e};};Object[a104_0x3be202(0x100)](exports,'__esModule',{'value':!![]}),exports[a104_0x3be202(0x131)]=void 0x0;const path_1=__importDefault(require(a104_0x3be202(0x10e))),extract_component_permissions_1=require(a104_0x3be202(0x128)),logger_1=require(a104_0x3be202(0x13f)),xml2js_1=require('xml2js'),zip_1=require(a104_0x3be202(0x154)),mdapi_writer_1=require(a104_0x3be202(0x104)),fs_internal_1=require(a104_0x3be202(0x13a)),promises_1=require(a104_0x3be202(0x11b)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a104_0x3be202(0x12f))),uuid_1=require(a104_0x3be202(0xfe)),fetch_attachments_1=require(a104_0x3be202(0x118)),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x3be202(0x11a),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x3be202(0x105),DEPLOY_DIR_NAME='DEPLOYZIP',PERMISSION_SET_FOLDER_NAME=a104_0x3be202(0x103);async function generateAndDeployZip({attachmentsId:_0x3ca49d,isExtractComponentsPermissionSets:_0x4e7456,isExtractComponentsProfiles:_0x218139,preDestructiveAttachmentId:_0x25cebf,postDestructiveAttachmentId:_0x119503,branchId:_0x34299c,credentials:_0x55cc64,metadataLogId:_0x23c2a2,environments:_0x1b6869,metaTypes:_0x564f25,apiVersion:_0x23f03},_0x59a624,_0x10fb2b){const _0x3f495a=a104_0x3be202;var _0x8c21c8;const _0x5f4035=(0x0,uuid_1['v4'])();try{const _0x259b29=await(0x0,fetch_attachments_1[_0x3f495a(0x133)])(_0x59a624,_0x3ca49d),_0x1cda8c=_0x259b29['reduce']((_0x1f91d6,_0x44e2b9)=>({..._0x1f91d6,[_0x44e2b9['Id']]:_0x44e2b9[_0x3f495a(0x139)]}),{}),_0x30b483=await getComponents(_0x259b29,_0x59a624,_0x1cda8c),_0x252213=await components_api_1['ComponentsApi'][_0x3f495a(0x120)](_0x59a624,_0x259b29[_0x3f495a(0x14b)](({ParentId:_0x5effa3})=>_0x5effa3),_0x23f03)[_0x3f495a(0xf6)](_0xac9394=>components_api_1[_0x3f495a(0x148)][_0x3f495a(0x149)](_0xac9394));if(_0x218139){const _0x27685c=_0x30b483[_0x3f495a(0x14d)](({fileType:_0x498cad})=>_0x498cad===_0x3f495a(0xfb));await removePermission(_0x27685c,_0x252213);}const _0x1969af=_0x30b483[_0x3f495a(0x14d)](({fileType:_0x41db00})=>_0x41db00===_0x3f495a(0x12c));if(_0x1969af['length']&&_0x4e7456){await removePermission(_0x1969af,_0x252213);const {items:_0x406e16}=await retrieveTargetPermissionSets(_0x1969af,_0x23f03,_0x10fb2b);await mergePermissionSets(_0x1969af,((_0x8c21c8=_0x406e16[_0x3f495a(0x12c)])===null||_0x8c21c8===void 0x0?void 0x0:_0x8c21c8[_0x3f495a(0x129)])||[]);}await replaceEnvironments(_0x564f25,_0x1b6869,_0x30b483),await writeZip(_0x30b483,_0x5f4035),await generateAndWritePackageXML(_0x259b29,_0x252213,_0x5f4035,_0x23f03);_0x25cebf&&await saveDestructiveChanges(_0x59a624,_0x25cebf,DESTRUCTIVE_CHANGES_PER_NAME,_0x5f4035);_0x119503&&await saveDestructiveChanges(_0x59a624,_0x119503,DESTRUCTIVE_CHANGES_POST_NAME,_0x5f4035);const _0x14446b=(await createDeployZip(_0x5f4035)[_0x3f495a(0xf6)](_0x2ff44a=>{return _0x2ff44a;}))[_0x3f495a(0x119)]()[_0x3f495a(0x114)](_0x3f495a(0x152)),_0x1cdef4=_0x14446b['length'];if(_0x1cdef4>=components_api_1[_0x3f495a(0x111)]){const _0x30ee45=await createDeployZip(_0x5f4035),[_0x3dbc4d,_0x439c12]=await components_api_1[_0x3f495a(0x148)][_0x3f495a(0x132)](_0x30ee45,_0x1cdef4),_0x170bff=await insertZip(_0x59a624,_0x34299c,_0x55cc64[_0x3f495a(0x146)],_0x23c2a2,_0x3dbc4d[_0x3f495a(0x119)]()[_0x3f495a(0x114)](_0x3f495a(0x152)),_0x23f03),_0x376b4d=await insertZip(_0x59a624,_0x34299c,_0x55cc64[_0x3f495a(0x146)],_0x23c2a2,_0x439c12[_0x3f495a(0x119)]()['toString'](_0x3f495a(0x152)),_0x23f03);return _0x170bff+','+_0x376b4d;}else return await insertZip(_0x59a624,_0x34299c,_0x55cc64[_0x3f495a(0x146)],_0x23c2a2,_0x14446b,_0x23f03);}catch(_0x2e529f){throw _0x2e529f;}finally{if(await fs_internal_1['FS'][_0x3f495a(0x113)](path_1['default'][_0x3f495a(0x125)](process[_0x3f495a(0x106)](),_0x3f495a(0x123),_0x5f4035)))await(0x0,promises_1['rm'])(path_1[_0x3f495a(0x142)]['join'](process[_0x3f495a(0x106)](),'.temp',_0x5f4035),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x14869e,_0x4fc759,_0xf30d8a){const _0x3a83e6=a104_0x3be202,_0x27c79b=[],_0x1d1d3d=await(0x0,fetch_attachments_1[_0x3a83e6(0x13c)])(_0x14869e,_0x4fc759);return await getComponentFromZip(_0x1d1d3d,_0xf30d8a)['then'](_0x51eaff=>{const _0x2f814c=_0x3a83e6;_0x27c79b[_0x2f814c(0x107)](..._0x51eaff);}),_0x27c79b;}async function getComponentFromZip(_0xb202da,_0x4ec31f){const _0x10f80b=a104_0x3be202,_0x58d429=[];for(const _0x20a3a4 of _0xb202da){const _0x40a886=await zip_1[_0x10f80b(0x151)][_0x10f80b(0x10d)](_0x20a3a4[_0x10f80b(0x108)][_0x10f80b(0x116)]);for(const _0x5e211c in _0x40a886[_0x10f80b(0x101)]){!_0x40a886['files'][_0x5e211c][_0x10f80b(0x14f)]&&_0x58d429[_0x10f80b(0x107)]({'fileName':_0x5e211c['substring'](_0x5e211c[_0x10f80b(0xfa)]('/')+0x1),'fileType':_0x4ec31f[_0x20a3a4['id']],'body':_0x20a3a4[_0x10f80b(0x108)][_0x10f80b(0x116)]});}}return _0x58d429;}async function removePermission(_0x524b9d,_0x400d80){const _0x449e9a=a104_0x3be202;for(const _0x1de845 of _0x524b9d){const _0x3f1d98=await zip_1['Zip']['unzip'](_0x1de845[_0x449e9a(0x102)]),_0x5c4299=[];for(const _0x37b153 in _0x3f1d98[_0x449e9a(0x101)]){!_0x3f1d98[_0x449e9a(0x101)][_0x37b153]['dir']&&_0x5c4299['push']({'fileName':_0x37b153,'body':await _0x3f1d98[_0x449e9a(0x101)][_0x37b153][_0x449e9a(0xf7)]('text')});}const _0x4789ff=await(0x0,extract_component_permissions_1[_0x449e9a(0xf4)])(_0x5c4299[0x0][_0x449e9a(0x102)]['toString'](),_0x400d80,_0x1de845['fileType']),_0x31bf07=new xml2js_1[(_0x449e9a(0x12b))]({'xmldec':{'version':_0x449e9a(0x14c),'encoding':'UTF-8'}}),_0x4cd69c=_0x31bf07[_0x449e9a(0x117)](_0x4789ff),_0x58b227=zip_1[_0x449e9a(0x151)]['createZip']();_0x58b227[_0x449e9a(0x121)](_0x5c4299[0x0][_0x449e9a(0x10a)],_0x4cd69c),_0x1de845[_0x449e9a(0x102)]=await _0x58b227[_0x449e9a(0x135)]({'type':_0x449e9a(0x152),'compression':_0x449e9a(0x156),'compressionOptions':{'level':0x6}});}}function a104_0x19a5(){const _0xfa44d0=['MDApiWriter','MetadataConstants','45643cXYyHY','fetchAttachmentBody','4164qULjxQ','text','extractComponentPermissions','apply','then','async','writeFile','PartialRetrieve','indexOf','Profile','283029jeUyCS','reduce','uuid','63ieojLk','defineProperty','files','body','permissionsets','../../git/writers/mdapi.writer','destructiveChangesPost.xml','cwd','push','values','889520ivVUXQ','fileName','10EAEnGI','552KMuUxc','unzip','path','FOLDER_TO_METADATA_TYPE_MAP','BUILD','MAX_ZIP_SIZE','UTF-8','exists','toString','type','Body','buildObject','../../shared/utils/fetch-attachments','toBuffer','destructiveChangesPre.xml','fs/promises','get','/sobjects/Attachment','Component_Name__c','constructor','fetchComponentsDetailsByComponentsHistory','file','48545ZtFVLB','.temp','24690oNfxLj','join','search','DeclarativeFilterOptions','../utils/extract-component-permissions','components','addLocalFolder','Builder','PermissionSet','find','keys','adm-zip','(((.+)+)+)+$','generateAndDeployZip','splitZip','fetchAttachmentsDetailsById','mergeComponentPermissions','generateAsync','60nKIcPp','package.xml','createZip','Name','../../git/internal/fs.internal','14tLkJoz','retrieveAttachments','post','types','../classes/logger','6261068KaCxiK','Package','default','/services/data/v','fileType','execute','orgId','__importDefault','ComponentsApi','removeNamespacePrefix','listMetadataItem','map','1.0','filter','every','dir','PERMISSION_SET','Zip','base64','set','../../git/parsers/utils/zip','src','DEFLATE','replace','515785XUfaYH'];a104_0x19a5=function(){return _0xfa44d0;};return a104_0x19a5();}function a104_0x4fba(_0x3c31dd,_0x34a363){const _0x483177=a104_0x19a5();return a104_0x4fba=function(_0x262170,_0x3bc222){_0x262170=_0x262170-0xf1;let _0x19a5d0=_0x483177[_0x262170];return _0x19a5d0;},a104_0x4fba(_0x3c31dd,_0x34a363);}async function retrieveTargetPermissionSets(_0x5425e8,_0x34ada6,_0x8b6877){const _0x55d0ad=a104_0x3be202,_0x4cfce2=_0x5425e8[_0x55d0ad(0x14b)](_0x467c26=>PERMISSION_SET_FOLDER_NAME+'/'+_0x467c26['fileName'])[_0x55d0ad(0x125)](';'),_0x4c9f45=[{'field':_0x55d0ad(0x10a),'option':salesforce_1[_0x55d0ad(0x127)]['IN'],'value':_0x4cfce2}],_0x2d92ad=new logger_1['Logger']();return new salesforce_1[(_0x55d0ad(0xf9))](_0x34ada6,_0x8b6877,_0x2d92ad,_0x4c9f45,null,[salesforce_1['MetadataType'][_0x55d0ad(0x150)]])[_0x55d0ad(0x145)]();}async function mergePermissionSets(_0x780aba,_0x1fbc2a){const _0x105991=a104_0x3be202,_0x3b81a7=_0x1fbc2a[_0x105991(0xfd)]((_0x214392,_0x26ef65)=>_0x214392[_0x105991(0x153)](_0x26ef65[_0x105991(0x14a)][_0x105991(0x10a)],_0x26ef65),new Map());for(const _0x2a2ad6 of _0x780aba){const _0x3afefc=PERMISSION_SET_FOLDER_NAME+'/'+_0x2a2ad6[_0x105991(0x10a)],_0x413947=_0x3b81a7[_0x105991(0x11c)](_0x3afefc);if(!_0x413947)continue;const _0x4d6e4a=await zip_1[_0x105991(0x151)][_0x105991(0x10d)](_0x2a2ad6['body']),_0x26e35b=await _0x4d6e4a[_0x105991(0x101)][_0x3afefc][_0x105991(0xf7)](_0x105991(0xf3)),_0x572a27=_0x413947[_0x105991(0x101)][_0x3afefc][_0x105991(0x114)](),_0x3774b9=await(0x0,extract_component_permissions_1[_0x105991(0x134)])(_0x26e35b,_0x572a27,_0x2a2ad6[_0x105991(0x144)]),_0x4c0b21=zip_1[_0x105991(0x151)][_0x105991(0x138)]();_0x4c0b21[_0x105991(0x121)](_0x3afefc,_0x3774b9),_0x2a2ad6[_0x105991(0x102)]=await _0x4c0b21[_0x105991(0x135)]({'type':_0x105991(0x152),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x2ad009,_0x23c225,_0x3462b9){const _0x4c061c=a104_0x3be202;for(const _0x2dbe7e of _0x3462b9){if(_0x2ad009[_0x4c061c(0x14e)](_0x3e747c=>_0x3e747c!==_0x2dbe7e[_0x4c061c(0x144)]))continue;const _0x210c8f=await zip_1[_0x4c061c(0x151)][_0x4c061c(0x10d)](_0x2dbe7e['body']);for(const _0xbad614 in _0x210c8f[_0x4c061c(0x101)]){if(!_0x210c8f['files'][_0xbad614][_0x4c061c(0x14f)]){let _0x3f3d6d=await _0x210c8f[_0x4c061c(0x101)][_0xbad614][_0x4c061c(0xf7)](_0x4c061c(0xf3));for(const _0x5390fb of Object[_0x4c061c(0x12e)](_0x23c225)){const _0x140480=new RegExp('%%'+_0x5390fb+'%%','g');_0x3f3d6d=_0x3f3d6d[_0x4c061c(0x157)](_0x140480,_0x23c225[_0x5390fb]);}_0x210c8f[_0x4c061c(0x121)](_0xbad614,_0x3f3d6d);}}_0x2dbe7e[_0x4c061c(0x102)]=await _0x210c8f[_0x4c061c(0x135)]({'type':_0x4c061c(0x152),'compression':_0x4c061c(0x156),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x1d6b58,_0x37b71b){const _0x1abe70=a104_0x3be202,_0x3c312d=new mdapi_writer_1[(_0x1abe70(0x159))]({'components':_0x1d6b58,'sourceDir':path_1[_0x1abe70(0x142)][_0x1abe70(0x125)](process[_0x1abe70(0x106)](),_0x1abe70(0x123),_0x37b71b,DEPLOY_DIR_NAME,_0x1abe70(0x155)),'skipChildErrors':![]});await _0x3c312d[_0x1abe70(0x145)]();}async function generateAndWritePackageXML(_0x179746,_0x561300,_0x52ca4a,_0x51cdb7){const _0x5bbfa4=a104_0x3be202,_0x5920fb=getComponentsTypeAndName(_0x179746,_0x561300),_0x540fab=[...new Set(_0x5920fb[_0x5bbfa4(0x14b)](_0x3709a5=>_0x3709a5[_0x5bbfa4(0x115)]))],_0x1f9574={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x51cdb7}};for(const _0x3502e9 of _0x540fab){const _0x4e820d=_0x5920fb[_0x5bbfa4(0x14d)](_0x62ca43=>_0x62ca43[_0x5bbfa4(0x115)]===_0x3502e9)['map'](_0x1f8064=>_0x1f8064['name']),_0x32b8ae={'members':_0x4e820d,'name':_0x3502e9};_0x1f9574[_0x5bbfa4(0x141)][_0x5bbfa4(0x13e)]['push'](_0x32b8ae);}const _0x2646a6=new xml2js_1[(_0x5bbfa4(0x12b))]({'xmldec':{'version':_0x5bbfa4(0x14c),'encoding':_0x5bbfa4(0x112)}}),_0x3bdd1c=_0x2646a6[_0x5bbfa4(0x117)](_0x1f9574);await fs_internal_1['FS']['writeFile'](path_1['default'][_0x5bbfa4(0x125)](process[_0x5bbfa4(0x106)](),_0x5bbfa4(0x123),_0x52ca4a,DEPLOY_DIR_NAME,_0x5bbfa4(0x155),_0x5bbfa4(0x137)),_0x3bdd1c);}function getComponentsTypeAndName(_0x411cc5,_0x4e3594){const _0x4ff1d8=a104_0x3be202;return _0x411cc5[_0x4ff1d8(0xfd)]((_0x1d2809,_0x3a8820)=>{const _0x187738=_0x4ff1d8,_0x3c91f5=_0x4e3594[_0x187738(0x12d)](_0x17f92c=>_0x17f92c['Id']===_0x3a8820['ParentId']);return _0x3c91f5&&_0x1d2809['push']({'name':_0x3c91f5['Component__r'][_0x187738(0x11e)],'type':salesforce_1[_0x187738(0x15a)][_0x187738(0x10f)][_0x3a8820[_0x187738(0x139)]]||_0x3a8820[_0x187738(0x139)]}),_0x1d2809;},[]);}async function saveDestructiveChanges(_0x3d9142,_0x4e5d27,_0x22d00c,_0x503412){const _0x3b5c38=a104_0x3be202,_0x21a1f5=(await(0x0,fetch_attachments_1[_0x3b5c38(0xf1)])(_0x3d9142,_0x4e5d27))['toString']();await fs_internal_1['FS'][_0x3b5c38(0xf8)](path_1[_0x3b5c38(0x142)][_0x3b5c38(0x125)](process[_0x3b5c38(0x106)](),'.temp',_0x503412,DEPLOY_DIR_NAME,'src',_0x22d00c),_0x21a1f5);}async function createDeployZip(_0x4ce5b8){const _0x1b4fed=a104_0x3be202,_0x27ddb=new adm_zip_1[(_0x1b4fed(0x142))]();return await _0x27ddb[_0x1b4fed(0x12a)](path_1[_0x1b4fed(0x142)][_0x1b4fed(0x125)](process[_0x1b4fed(0x106)](),_0x1b4fed(0x123),_0x4ce5b8,DEPLOY_DIR_NAME)),_0x27ddb;}async function insertZip(_0x50f008,_0x9019e4,_0x505ee2,_0x47f963,_0x5dafe5,_0xf4250e){const _0x156235=a104_0x3be202,_0xd00256={'ParentId':_0x9019e4,'Name':_0x156235(0x110)+_0x505ee2,'Description':_0x156235(0x110)+_0x47f963,'Body':_0x5dafe5},{data:_0x1c06a8}=await _0x50f008[_0x156235(0x13d)](_0x156235(0x143)+_0xf4250e+_0x156235(0x11d),_0xd00256);return _0x1c06a8['id'];}