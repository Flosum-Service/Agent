const a54_0x38fe97=a54_0x2454;(function(_0x3e5ca8,_0x472750){const _0x5dab01=a54_0x2454,_0x5a0d2b=_0x3e5ca8();while(!![]){try{const _0xeafe99=-parseInt(_0x5dab01(0x1f0))/0x1*(-parseInt(_0x5dab01(0x202))/0x2)+-parseInt(_0x5dab01(0x229))/0x3*(parseInt(_0x5dab01(0x201))/0x4)+parseInt(_0x5dab01(0x21c))/0x5+parseInt(_0x5dab01(0x23b))/0x6+-parseInt(_0x5dab01(0x20e))/0x7*(parseInt(_0x5dab01(0x1ea))/0x8)+-parseInt(_0x5dab01(0x20f))/0x9+-parseInt(_0x5dab01(0x23a))/0xa*(-parseInt(_0x5dab01(0x1f3))/0xb);if(_0xeafe99===_0x472750)break;else _0x5a0d2b['push'](_0x5a0d2b['shift']());}catch(_0xd42984){_0x5a0d2b['push'](_0x5a0d2b['shift']());}}}(a54_0x7c4d,0xbd3ca));const a54_0x3cf58e=(function(){let _0x3ff49c=!![];return function(_0x571ebe,_0x2a5ec8){const _0x2ee1da=_0x3ff49c?function(){const _0x412e00=a54_0x2454;if(_0x2a5ec8){const _0x3d63df=_0x2a5ec8[_0x412e00(0x230)](_0x571ebe,arguments);return _0x2a5ec8=null,_0x3d63df;}}:function(){};return _0x3ff49c=![],_0x2ee1da;};}()),a54_0x2ec39d=a54_0x3cf58e(this,function(){const _0x496a0c=a54_0x2454;return a54_0x2ec39d[_0x496a0c(0x21a)]()['search'](_0x496a0c(0x1f4))['toString']()[_0x496a0c(0x200)](a54_0x2ec39d)['search'](_0x496a0c(0x1f4));});a54_0x2ec39d();'use strict';var __importDefault=this&&this[a54_0x38fe97(0x223)]||function(_0x69a8eb){const _0x4b0bf4=a54_0x38fe97;return _0x69a8eb&&_0x69a8eb[_0x4b0bf4(0x242)]?_0x69a8eb:{'default':_0x69a8eb};};Object[a54_0x38fe97(0x1f1)](exports,a54_0x38fe97(0x242),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require(a54_0x38fe97(0x22d)),path_1=__importDefault(require(a54_0x38fe97(0x1f9))),extract_component_permissions_1=require(a54_0x38fe97(0x220)),xml2js_1=require('xml2js'),zip_1=require(a54_0x38fe97(0x20a)),mdapi_1=require(a54_0x38fe97(0x235)),fs_internal_1=require(a54_0x38fe97(0x209)),promises_1=require(a54_0x38fe97(0x241)),components_api_1=require(a54_0x38fe97(0x237)),adm_zip_1=__importDefault(require(a54_0x38fe97(0x23c))),uuid_1=require('uuid'),fetch_attachments_1=require(a54_0x38fe97(0x207)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a54_0x38fe97(0x1ff),DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x49a4ec,isExtractComponentsPermissions:_0x119e1a,preDestructiveAttachmentId:_0x43facc,postDestructiveAttachmentId:_0x1bf777,branchId:_0x39100e,credentials:_0x16dcb,metadataLogId:_0x14aeb1,environments:_0x222794,metaTypes:_0x174ff9},_0x3ac919){const _0x202fe3=a54_0x38fe97,_0x13e457=(0x0,uuid_1['v4'])();try{const _0x3197f8=await(0x0,fetch_attachments_1[_0x202fe3(0x20b)])(_0x3ac919,_0x49a4ec),_0x4375f1=_0x3197f8[_0x202fe3(0x22a)]((_0x434586,_0x294f38)=>({..._0x434586,[_0x294f38['Id']]:_0x294f38[_0x202fe3(0x225)]}),{}),_0x305e81=await getComponents(_0x3197f8,_0x3ac919,_0x4375f1),_0x58ebc4=await components_api_1[_0x202fe3(0x1fe)][_0x202fe3(0x239)](_0x3ac919,_0x3197f8['map'](({ParentId:_0x21b594})=>_0x21b594))[_0x202fe3(0x233)](_0xcc588c=>components_api_1[_0x202fe3(0x1fe)][_0x202fe3(0x22b)](_0xcc588c));if(_0x119e1a){const _0x36eb5b=_0x305e81[_0x202fe3(0x1fc)](({fileType:_0x288098})=>_0x288098===_0x202fe3(0x231)||_0x288098===_0x202fe3(0x228));await removePermission(_0x36eb5b,_0x58ebc4);}await replaceEnvironments(_0x174ff9,_0x222794,_0x305e81),await writeZip(_0x305e81,_0x13e457),await generateAndWritePackageXML(_0x3197f8,_0x58ebc4,_0x13e457);_0x43facc&&await saveDestructiveChanges(_0x3ac919,_0x43facc,DESTRUCTIVE_CHANGES_PER_NAME,_0x13e457);_0x1bf777&&await saveDestructiveChanges(_0x3ac919,_0x1bf777,DESTRUCTIVE_CHANGES_POST_NAME,_0x13e457);const _0x3a379b=(await createDeployZip(_0x13e457)['then'](_0x2c88c0=>{return _0x2c88c0;}))[_0x202fe3(0x23d)]()['toString']('base64');console[_0x202fe3(0x21e)](_0x202fe3(0x1f2));const _0xfff1af=_0x3a379b[_0x202fe3(0x204)];if(_0xfff1af>=components_api_1[_0x202fe3(0x21d)]){const _0x37bb81=await createDeployZip(_0x13e457);console[_0x202fe3(0x21e)](_0x202fe3(0x217));const [_0x2c728a,_0x52d66c]=await components_api_1[_0x202fe3(0x1fe)][_0x202fe3(0x1ec)](_0x37bb81,_0xfff1af),_0x450802=await insertZip(_0x3ac919,_0x39100e,_0x16dcb[_0x202fe3(0x1f7)],_0x14aeb1,_0x2c728a[_0x202fe3(0x23d)]()['toString'](_0x202fe3(0x248))),_0x59d53f=await insertZip(_0x3ac919,_0x39100e,_0x16dcb[_0x202fe3(0x1f7)],_0x14aeb1,_0x52d66c[_0x202fe3(0x23d)]()['toString'](_0x202fe3(0x248)));return _0x450802+','+_0x59d53f;}else return await insertZip(_0x3ac919,_0x39100e,_0x16dcb[_0x202fe3(0x1f7)],_0x14aeb1,_0x3a379b);}catch(_0x5ad0c0){throw _0x5ad0c0;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x202fe3(0x243)][_0x202fe3(0x23e)](process['cwd'](),_0x202fe3(0x206),_0x13e457)))await(0x0,promises_1['rm'])(path_1[_0x202fe3(0x243)][_0x202fe3(0x23e)](process[_0x202fe3(0x211)](),_0x202fe3(0x206),_0x13e457),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x353da2,_0x1ca65c,_0x2b413d){const _0x506d63=a54_0x38fe97,_0x5f1104=[],_0x1e126c=await(0x0,fetch_attachments_1[_0x506d63(0x232)])(_0x353da2,_0x1ca65c);return await getComponentFromZip(_0x1e126c,_0x2b413d)[_0x506d63(0x233)](_0x18d73b=>{const _0x41cc6e=_0x506d63;_0x5f1104[_0x41cc6e(0x224)](..._0x18d73b);}),_0x5f1104;}function a54_0x2454(_0x490425,_0x223315){const _0x593bbc=a54_0x7c4d();return a54_0x2454=function(_0x2ec39d,_0x3cf58e){_0x2ec39d=_0x2ec39d-0x1ea;let _0x7c4de4=_0x593bbc[_0x2ec39d];return _0x7c4de4;},a54_0x2454(_0x490425,_0x223315);}async function getComponentFromZip(_0x302520,_0x25cbfc){const _0x29952e=a54_0x38fe97,_0x10f1f7=[];for(const _0x1a441f of _0x302520){const _0x3ec9cb=await zip_1[_0x29952e(0x20d)]['unzip'](_0x1a441f[_0x29952e(0x246)][_0x29952e(0x222)]);for(const _0x49979d in _0x3ec9cb[_0x29952e(0x213)]){!_0x3ec9cb[_0x29952e(0x213)][_0x49979d]['dir']&&_0x10f1f7[_0x29952e(0x224)]({'fileName':_0x49979d[_0x29952e(0x20c)](_0x49979d['indexOf']('/')+0x1),'fileType':_0x25cbfc[_0x1a441f['id']],'body':_0x1a441f[_0x29952e(0x246)][_0x29952e(0x222)]});}}return _0x10f1f7;}async function removePermission(_0x3b0aa1,_0x2b3085){const _0x1fb417=a54_0x38fe97;for(const _0x1feae6 of _0x3b0aa1){const _0x36ef80=await zip_1[_0x1fb417(0x20d)][_0x1fb417(0x21b)](_0x1feae6[_0x1fb417(0x1ed)]),_0x3424e6=[];for(const _0x4fae79 in _0x36ef80['files']){!_0x36ef80[_0x1fb417(0x213)][_0x4fae79][_0x1fb417(0x1f5)]&&_0x3424e6[_0x1fb417(0x224)]({'fileName':_0x4fae79,'body':await _0x36ef80[_0x1fb417(0x213)][_0x4fae79][_0x1fb417(0x218)](_0x1fb417(0x23f))});}const _0x490488=await(0x0,extract_component_permissions_1[_0x1fb417(0x240)])(_0x3424e6[0x0][_0x1fb417(0x1ed)]['toString'](),_0x2b3085,_0x1feae6[_0x1fb417(0x221)]),_0x4077a3=new xml2js_1[(_0x1fb417(0x203))]({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x535111=_0x4077a3['buildObject'](_0x490488),_0x1e7818=zip_1[_0x1fb417(0x20d)][_0x1fb417(0x22e)]();_0x1e7818['file'](_0x3424e6[0x0]['fileName'],_0x535111),_0x1feae6[_0x1fb417(0x1ed)]=await _0x1e7818[_0x1fb417(0x236)]({'type':_0x1fb417(0x248),'compression':_0x1fb417(0x1f6),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x521bbb,_0x4cacae,_0x4503e9){const _0xe1bf34=a54_0x38fe97;for(const _0x5122f6 of _0x4503e9){if(_0x521bbb[_0xe1bf34(0x21f)](_0x175912=>_0x175912!==_0x5122f6['fileType']))continue;const _0x3850ff=await zip_1[_0xe1bf34(0x20d)][_0xe1bf34(0x21b)](_0x5122f6[_0xe1bf34(0x1ed)]);for(const _0x684f1d in _0x3850ff['files']){if(!_0x3850ff[_0xe1bf34(0x213)][_0x684f1d][_0xe1bf34(0x1f5)]){let _0x43fdba=await _0x3850ff[_0xe1bf34(0x213)][_0x684f1d]['async'](_0xe1bf34(0x23f));for(const _0x230caf of Object[_0xe1bf34(0x1fd)](_0x4cacae)){const _0x573246=new RegExp('%%'+_0x230caf+'%%','g');_0x43fdba=_0x43fdba[_0xe1bf34(0x205)](_0x573246,_0x4cacae[_0x230caf]);}_0x3850ff['file'](_0x684f1d,_0x43fdba);}}_0x5122f6['body']=await _0x3850ff['generateAsync']({'type':_0xe1bf34(0x248),'compression':_0xe1bf34(0x1f6),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x4d0fef,_0x3146e4){const _0xee14c7=a54_0x38fe97,_0x309092=new mdapi_1[(_0xee14c7(0x245))]({'components':_0x4d0fef,'sourceDir':path_1['default'][_0xee14c7(0x23e)](process[_0xee14c7(0x211)](),_0xee14c7(0x206),_0x3146e4,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x309092[_0xee14c7(0x212)]();}async function generateAndWritePackageXML(_0x1b48aa,_0x58bb90,_0x33ab3f){const _0x2d89b0=a54_0x38fe97,_0x57bcb1=getComponentsTypeAndName(_0x1b48aa,_0x58bb90),_0x23827b=[...new Set(_0x57bcb1['map'](_0x546a23=>_0x546a23[_0x2d89b0(0x1eb)]))],_0x27bb73={'Package':{'$':{'xmlns':_0x2d89b0(0x227)},'types':[],'version':''+constants_1[_0x2d89b0(0x1ee)]['substring'](0x1)}};for(const _0x185bc1 of _0x23827b){const _0x2e1b8f=_0x57bcb1['filter'](_0x5a7974=>_0x5a7974['type']===_0x185bc1)[_0x2d89b0(0x247)](_0x3c2565=>_0x3c2565['name']),_0x41e48d={'members':_0x2e1b8f,'name':_0x185bc1};_0x27bb73[_0x2d89b0(0x22f)][_0x2d89b0(0x238)][_0x2d89b0(0x224)](_0x41e48d);}const _0x307732=new xml2js_1[(_0x2d89b0(0x203))]({'xmldec':{'version':'1.0','encoding':_0x2d89b0(0x22c)}}),_0x57d4fd=_0x307732[_0x2d89b0(0x1fa)](_0x27bb73);await fs_internal_1['FS'][_0x2d89b0(0x244)](path_1['default']['join'](process[_0x2d89b0(0x211)](),_0x2d89b0(0x206),_0x33ab3f,DEPLOY_DIR_NAME,_0x2d89b0(0x226),_0x2d89b0(0x219)),_0x57d4fd);}function a54_0x7c4d(){const _0x1949bb=['reduce','removeNamespacePrefix','UTF-8','../../../constants','createZip','Package','apply','Profile','retrieveAttachments','then','find','../../git/parsers/mdapi','generateAsync','../utils/components-api','types','fetchComponentsDetailsByComponentsHistory','120210xljkiP','3091698JIQDQz','adm-zip','toBuffer','join','text','extractComponentPermissions','fs/promises','__esModule','default','writeFile','MDApiWriter','values','map','base64','BUILD','96JGiLBQ','type','splitZip','body','SALESFORCE_API_VERSION','Component__r','1099957gzchOM','defineProperty','after\x20create\x20zip','66eQcBiw','(((.+)+)+)+$','dir','DEFLATE','orgId','Component_Name__c','path','buildObject','/services/data/','filter','keys','ComponentsApi','destructiveChangesPost.xml','constructor','8848pYbIqT','2WROeFv','Builder','length','replace','.temp','../../shared/utils/fetch-attachments','post','../../git/internal/fs.internal','../../git/parsers/utils/zip','fetchAttachmentsDetailsById','substring','Zip','142744uyNFmZ','6891534znjbOe','/sobjects/Attachment','cwd','start','files','fetchAttachmentBody','ParentId','addLocalFolder','after\x20create\x20second\x20zip','async','package.xml','toString','unzip','5036550nmomNW','MAX_ZIP_SIZE','log','every','../utils/extract-component-permissions','fileType','Body','__importDefault','push','Name','src','http://soap.sforce.com/2006/04/metadata','PermissionSet','1233JBeAgd'];a54_0x7c4d=function(){return _0x1949bb;};return a54_0x7c4d();}function getComponentsTypeAndName(_0x59feda,_0x425bdc){const _0x1d8a2e=a54_0x38fe97;return _0x59feda[_0x1d8a2e(0x22a)]((_0x3798ef,_0x28ab74)=>{const _0x3ae1ca=_0x1d8a2e,_0x23da7c=_0x425bdc[_0x3ae1ca(0x234)](_0x507c64=>_0x507c64['Id']===_0x28ab74[_0x3ae1ca(0x215)]);return _0x23da7c&&_0x3798ef[_0x3ae1ca(0x224)]({'name':_0x23da7c[_0x3ae1ca(0x1ef)][_0x3ae1ca(0x1f8)],'type':_0x28ab74[_0x3ae1ca(0x225)]}),_0x3798ef;},[]);}async function saveDestructiveChanges(_0x4446c6,_0x3558d6,_0x22f81f,_0x4fe539){const _0x9841fd=a54_0x38fe97,_0x30c541=(await(0x0,fetch_attachments_1[_0x9841fd(0x214)])(_0x4446c6,_0x3558d6))[_0x9841fd(0x21a)]();await fs_internal_1['FS'][_0x9841fd(0x244)](path_1['default'][_0x9841fd(0x23e)](process['cwd'](),_0x9841fd(0x206),_0x4fe539,DEPLOY_DIR_NAME,'src',_0x22f81f),_0x30c541);}async function createDeployZip(_0x3c4132){const _0x4c5123=a54_0x38fe97,_0x3d21ff=new adm_zip_1['default']();return await _0x3d21ff[_0x4c5123(0x216)](path_1[_0x4c5123(0x243)][_0x4c5123(0x23e)](process['cwd'](),_0x4c5123(0x206),_0x3c4132,DEPLOY_DIR_NAME)),_0x3d21ff;}async function insertZip(_0x3f4a50,_0x4bb366,_0x324242,_0x3091e5,_0x388fe3){const _0x17d0bf=a54_0x38fe97,_0x10f413={'ParentId':_0x4bb366,'Name':_0x17d0bf(0x249)+_0x324242,'Description':_0x17d0bf(0x249)+_0x3091e5,'Body':_0x388fe3},{data:_0x80c7c3}=await _0x3f4a50[_0x17d0bf(0x208)](_0x17d0bf(0x1fb)+constants_1['SALESFORCE_API_VERSION']+_0x17d0bf(0x210),_0x10f413);return _0x80c7c3['id'];}