const a104_0x2a641b=a104_0x21d0;(function(_0x3edf4c,_0x3db564){const _0x5563a7=a104_0x21d0,_0x6cd04a=_0x3edf4c();while(!![]){try{const _0x25959d=parseInt(_0x5563a7(0xf8))/0x1+parseInt(_0x5563a7(0x144))/0x2*(parseInt(_0x5563a7(0x143))/0x3)+-parseInt(_0x5563a7(0x12f))/0x4+parseInt(_0x5563a7(0xfb))/0x5*(-parseInt(_0x5563a7(0x136))/0x6)+-parseInt(_0x5563a7(0xf0))/0x7*(parseInt(_0x5563a7(0x122))/0x8)+-parseInt(_0x5563a7(0x148))/0x9*(parseInt(_0x5563a7(0x138))/0xa)+parseInt(_0x5563a7(0x111))/0xb*(parseInt(_0x5563a7(0x10a))/0xc);if(_0x25959d===_0x3db564)break;else _0x6cd04a['push'](_0x6cd04a['shift']());}catch(_0x3517bd){_0x6cd04a['push'](_0x6cd04a['shift']());}}}(a104_0x278a,0x3cfe0));const a104_0x19429f=(function(){let _0x546a43=!![];return function(_0x4a2612,_0x116c85){const _0x1b8430=_0x546a43?function(){if(_0x116c85){const _0x1e2b25=_0x116c85['apply'](_0x4a2612,arguments);return _0x116c85=null,_0x1e2b25;}}:function(){};return _0x546a43=![],_0x1b8430;};}()),a104_0x17b84f=a104_0x19429f(this,function(){const _0xa6788a=a104_0x21d0;return a104_0x17b84f[_0xa6788a(0x14d)]()[_0xa6788a(0x14e)](_0xa6788a(0xff))[_0xa6788a(0x14d)]()[_0xa6788a(0x10e)](a104_0x17b84f)['search']('(((.+)+)+)+$');});a104_0x17b84f();'use strict';var __importDefault=this&&this[a104_0x2a641b(0x13e)]||function(_0x2742ce){const _0x3c0322=a104_0x2a641b;return _0x2742ce&&_0x2742ce[_0x3c0322(0x125)]?_0x2742ce:{'default':_0x2742ce};};Object['defineProperty'](exports,a104_0x2a641b(0x125),{'value':!![]}),exports[a104_0x2a641b(0x147)]=void 0x0;const path_1=__importDefault(require(a104_0x2a641b(0x10c))),extract_component_permissions_1=require(a104_0x2a641b(0xfa)),logger_1=require(a104_0x2a641b(0x139)),xml2js_1=require(a104_0x2a641b(0x112)),zip_1=require(a104_0x2a641b(0xf2)),mdapi_writer_1=require(a104_0x2a641b(0x149)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require('fs/promises'),components_api_1=require(a104_0x2a641b(0x12b)),adm_zip_1=__importDefault(require(a104_0x2a641b(0xf1))),uuid_1=require(a104_0x2a641b(0xf9)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x2a641b(0x11b),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x2a641b(0x127),DEPLOY_DIR_NAME=a104_0x2a641b(0xf5),PERMISSION_SET_FOLDER_NAME='permissionsets';async function generateAndDeployZip({attachmentsId:_0x3ec102,isExtractComponentsPermissionSets:_0x57ec0d,isExtractComponentsProfiles:_0xaa4909,preDestructiveAttachmentId:_0x432c3c,postDestructiveAttachmentId:_0x399e04,branchId:_0x40d653,credentials:_0x151821,metadataLogId:_0x16242c,environments:_0x273795,metaTypes:_0x532e79,apiVersion:_0x25218b},_0x1d38e5,_0x3a716c){const _0x47e69b=a104_0x2a641b;var _0x1c6579;const _0x456f5e=(0x0,uuid_1['v4'])();try{const _0xe33570=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x1d38e5,_0x3ec102),_0x3fbdf6=_0xe33570[_0x47e69b(0x133)]((_0x32e8fe,_0x55b517)=>({..._0x32e8fe,[_0x55b517['Id']]:_0x55b517[_0x47e69b(0x120)]}),{}),_0x28e77c=await getComponents(_0xe33570,_0x1d38e5,_0x3fbdf6),_0x385d06=await components_api_1[_0x47e69b(0x13b)][_0x47e69b(0x11e)](_0x1d38e5,_0xe33570[_0x47e69b(0xfc)](({ParentId:_0x4d61ac})=>_0x4d61ac),_0x25218b)[_0x47e69b(0x14b)](_0x3aa1e6=>components_api_1['ComponentsApi'][_0x47e69b(0x100)](_0x3aa1e6));if(_0xaa4909){const _0x47adf8=_0x28e77c[_0x47e69b(0x140)](({fileType:_0x574c88})=>_0x574c88===_0x47e69b(0x12d));await removePermission(_0x47adf8,_0x385d06);}const _0x1b0a6b=_0x28e77c[_0x47e69b(0x140)](({fileType:_0x19dab8})=>_0x19dab8==='PermissionSet');if(_0x1b0a6b['length']&&_0x57ec0d){await removePermission(_0x1b0a6b,_0x385d06);const {items:_0x4bf0bb}=await retrieveTargetPermissionSets(_0x1b0a6b,_0x25218b,_0x3a716c);await mergePermissionSets(_0x1b0a6b,((_0x1c6579=_0x4bf0bb[_0x47e69b(0x121)])===null||_0x1c6579===void 0x0?void 0x0:_0x1c6579[_0x47e69b(0xfd)])||[]);}await replaceEnvironments(_0x532e79,_0x273795,_0x28e77c),await writeZip(_0x28e77c,_0x456f5e),await generateAndWritePackageXML(_0xe33570,_0x385d06,_0x456f5e,_0x25218b);_0x432c3c&&await saveDestructiveChanges(_0x1d38e5,_0x432c3c,DESTRUCTIVE_CHANGES_PER_NAME,_0x456f5e);_0x399e04&&await saveDestructiveChanges(_0x1d38e5,_0x399e04,DESTRUCTIVE_CHANGES_POST_NAME,_0x456f5e);const _0x2a04c1=(await createDeployZip(_0x456f5e)['then'](_0x5e29e0=>{return _0x5e29e0;}))['toBuffer']()[_0x47e69b(0x14d)](_0x47e69b(0x134)),_0x1e1fe1=_0x2a04c1[_0x47e69b(0x141)];if(_0x1e1fe1>=components_api_1[_0x47e69b(0x146)]){const _0xef5702=await createDeployZip(_0x456f5e),[_0xf14738,_0x3a13bf]=await components_api_1['ComponentsApi']['splitZip'](_0xef5702,_0x1e1fe1),_0x113b4f=await insertZip(_0x1d38e5,_0x40d653,_0x151821[_0x47e69b(0xf6)],_0x16242c,_0xf14738[_0x47e69b(0x10f)]()[_0x47e69b(0x14d)]('base64'),_0x25218b),_0x36000e=await insertZip(_0x1d38e5,_0x40d653,_0x151821[_0x47e69b(0xf6)],_0x16242c,_0x3a13bf['toBuffer']()[_0x47e69b(0x14d)](_0x47e69b(0x134)),_0x25218b);return _0x113b4f+','+_0x36000e;}else return await insertZip(_0x1d38e5,_0x40d653,_0x151821['orgId'],_0x16242c,_0x2a04c1,_0x25218b);}catch(_0x36aa66){throw _0x36aa66;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x47e69b(0x135)][_0x47e69b(0x114)](process[_0x47e69b(0x12e)](),_0x47e69b(0x142),_0x456f5e)))await(0x0,promises_1['rm'])(path_1[_0x47e69b(0x135)][_0x47e69b(0x114)](process[_0x47e69b(0x12e)](),'.temp',_0x456f5e),{'recursive':!![]});}}exports[a104_0x2a641b(0x147)]=generateAndDeployZip;async function getComponents(_0x3399b4,_0x4b873d,_0x1b2888){const _0x11b6ab=a104_0x2a641b,_0xf2ad06=[],_0x16369c=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x3399b4,_0x4b873d);return await getComponentFromZip(_0x16369c,_0x1b2888)[_0x11b6ab(0x14b)](_0x34e956=>{const _0x366220=_0x11b6ab;_0xf2ad06[_0x366220(0xfe)](..._0x34e956);}),_0xf2ad06;}async function getComponentFromZip(_0x565cfd,_0x22a4ac){const _0x3fe0d7=a104_0x2a641b,_0x3bb560=[];for(const _0x50ae53 of _0x565cfd){const _0x3de8d2=await zip_1[_0x3fe0d7(0x11a)][_0x3fe0d7(0x13a)](_0x50ae53[_0x3fe0d7(0x10d)]['Body']);for(const _0x5cc94b in _0x3de8d2[_0x3fe0d7(0x116)]){!_0x3de8d2[_0x3fe0d7(0x116)][_0x5cc94b][_0x3fe0d7(0x130)]&&_0x3bb560[_0x3fe0d7(0xfe)]({'fileName':_0x5cc94b[_0x3fe0d7(0x13c)](_0x5cc94b[_0x3fe0d7(0xf4)]('/')+0x1),'fileType':_0x22a4ac[_0x50ae53['id']],'body':_0x50ae53[_0x3fe0d7(0x10d)][_0x3fe0d7(0x119)]});}}return _0x3bb560;}async function removePermission(_0x36272f,_0x1f6a2c){const _0x2b6b2c=a104_0x2a641b;for(const _0x551dd7 of _0x36272f){const _0x4e702a=await zip_1['Zip']['unzip'](_0x551dd7[_0x2b6b2c(0x109)]),_0x5e15ea=[];for(const _0x1321f7 in _0x4e702a['files']){!_0x4e702a[_0x2b6b2c(0x116)][_0x1321f7][_0x2b6b2c(0x130)]&&_0x5e15ea[_0x2b6b2c(0xfe)]({'fileName':_0x1321f7,'body':await _0x4e702a['files'][_0x1321f7][_0x2b6b2c(0x106)](_0x2b6b2c(0x14c))});}const _0x2d82d0=await(0x0,extract_component_permissions_1[_0x2b6b2c(0x13d)])(_0x5e15ea[0x0][_0x2b6b2c(0x109)][_0x2b6b2c(0x14d)](),_0x1f6a2c,_0x551dd7['fileType']),_0x1ad8a8=new xml2js_1['Builder']({'xmldec':{'version':_0x2b6b2c(0x12c),'encoding':'UTF-8'}}),_0x59995b=_0x1ad8a8[_0x2b6b2c(0x118)](_0x2d82d0),_0x3bbbd4=zip_1[_0x2b6b2c(0x11a)][_0x2b6b2c(0x104)]();_0x3bbbd4[_0x2b6b2c(0x117)](_0x5e15ea[0x0]['fileName'],_0x59995b),_0x551dd7[_0x2b6b2c(0x109)]=await _0x3bbbd4[_0x2b6b2c(0x132)]({'type':_0x2b6b2c(0x134),'compression':_0x2b6b2c(0x102),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x1f25ac,_0x54f060,_0x2a4858){const _0x6f0b6b=a104_0x2a641b,_0x4d7bbe=_0x1f25ac[_0x6f0b6b(0xfc)](_0x6f990e=>PERMISSION_SET_FOLDER_NAME+'/'+_0x6f990e[_0x6f0b6b(0x11d)])['join'](';'),_0x575d29=[{'field':'fileName','option':salesforce_1[_0x6f0b6b(0x126)]['IN'],'value':_0x4d7bbe}],_0x186029=new logger_1[(_0x6f0b6b(0x124))]();return new salesforce_1[(_0x6f0b6b(0x11c))](_0x54f060,_0x2a4858,_0x186029,_0x575d29,null,[salesforce_1[_0x6f0b6b(0x10b)]['PERMISSION_SET']])[_0x6f0b6b(0xf3)]();}async function mergePermissionSets(_0x1173c2,_0x37ec5a){const _0x235df5=a104_0x2a641b,_0x50f46a=_0x37ec5a[_0x235df5(0x133)]((_0x4cc6ff,_0x1880dd)=>_0x4cc6ff['set'](_0x1880dd[_0x235df5(0x110)][_0x235df5(0x11d)],_0x1880dd),new Map());for(const _0x5756cb of _0x1173c2){const _0x1f0e4f=PERMISSION_SET_FOLDER_NAME+'/'+_0x5756cb[_0x235df5(0x11d)],_0x3ed5d8=_0x50f46a[_0x235df5(0x129)](_0x1f0e4f);if(!_0x3ed5d8)continue;const _0xce4651=await zip_1[_0x235df5(0x11a)]['unzip'](_0x5756cb[_0x235df5(0x109)]),_0x2e56a3=await _0xce4651[_0x235df5(0x116)][_0x1f0e4f][_0x235df5(0x106)]('text'),_0x49b6fc=_0x3ed5d8[_0x235df5(0x116)][_0x1f0e4f][_0x235df5(0x14d)](),_0x3c913c=await(0x0,extract_component_permissions_1[_0x235df5(0x137)])(_0x2e56a3,_0x49b6fc,_0x5756cb[_0x235df5(0x11f)]),_0x15e0b4=zip_1['Zip'][_0x235df5(0x104)]();_0x15e0b4[_0x235df5(0x117)](_0x1f0e4f,_0x3c913c),_0x5756cb[_0x235df5(0x109)]=await _0x15e0b4['generateAsync']({'type':_0x235df5(0x134),'compression':_0x235df5(0x102),'compressionOptions':{'level':0x6}});}}function a104_0x21d0(_0x204b17,_0x2cf6f5){const _0x58a3ee=a104_0x278a();return a104_0x21d0=function(_0x17b84f,_0x19429f){_0x17b84f=_0x17b84f-0xee;let _0x278a32=_0x58a3ee[_0x17b84f];return _0x278a32;},a104_0x21d0(_0x204b17,_0x2cf6f5);}async function replaceEnvironments(_0x84a4c3,_0x4438d3,_0x57d52e){const _0x1ff47e=a104_0x2a641b;for(const _0x1ad74f of _0x57d52e){if(_0x84a4c3[_0x1ff47e(0x107)](_0x31617c=>_0x31617c!==_0x1ad74f['fileType']))continue;const _0x382033=await zip_1[_0x1ff47e(0x11a)][_0x1ff47e(0x13a)](_0x1ad74f['body']);for(const _0x192080 in _0x382033[_0x1ff47e(0x116)]){if(!_0x382033[_0x1ff47e(0x116)][_0x192080]['dir']){let _0x4bf175=await _0x382033[_0x1ff47e(0x116)][_0x192080][_0x1ff47e(0x106)](_0x1ff47e(0x14c));for(const _0x34f874 of Object[_0x1ff47e(0xf7)](_0x4438d3)){const _0xa1fa3d=new RegExp('%%'+_0x34f874+'%%','g');_0x4bf175=_0x4bf175[_0x1ff47e(0x14a)](_0xa1fa3d,_0x4438d3[_0x34f874]);}_0x382033['file'](_0x192080,_0x4bf175);}}_0x1ad74f[_0x1ff47e(0x109)]=await _0x382033[_0x1ff47e(0x132)]({'type':'base64','compression':_0x1ff47e(0x102),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x18f522,_0x13449a){const _0x565678=a104_0x2a641b,_0x7e7aa4=new mdapi_writer_1[(_0x565678(0x108))]({'components':_0x18f522,'sourceDir':path_1[_0x565678(0x135)][_0x565678(0x114)](process['cwd'](),_0x565678(0x142),_0x13449a,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x7e7aa4[_0x565678(0xf3)]();}async function generateAndWritePackageXML(_0x89e518,_0x27ecd9,_0x1cebc2,_0x2c7ec7){const _0x5daea4=a104_0x2a641b,_0x51ab08=getComponentsTypeAndName(_0x89e518,_0x27ecd9),_0x3a2529=[...new Set(_0x51ab08[_0x5daea4(0xfc)](_0x4c1e15=>_0x4c1e15[_0x5daea4(0x12a)]))],_0x1577e8={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x2c7ec7}};for(const _0x1b7279 of _0x3a2529){const _0x57db53=_0x51ab08[_0x5daea4(0x140)](_0x2cdcbf=>_0x2cdcbf[_0x5daea4(0x12a)]===_0x1b7279)[_0x5daea4(0xfc)](_0xaf536c=>_0xaf536c[_0x5daea4(0xee)]),_0x183615={'members':_0x57db53,'name':_0x1b7279};_0x1577e8[_0x5daea4(0x145)]['types'][_0x5daea4(0xfe)](_0x183615);}const _0x75408a=new xml2js_1['Builder']({'xmldec':{'version':_0x5daea4(0x12c),'encoding':'UTF-8'}}),_0x430a3e=_0x75408a['buildObject'](_0x1577e8);await fs_internal_1['FS'][_0x5daea4(0x128)](path_1[_0x5daea4(0x135)]['join'](process[_0x5daea4(0x12e)](),_0x5daea4(0x142),_0x1cebc2,DEPLOY_DIR_NAME,_0x5daea4(0x105),_0x5daea4(0xef)),_0x430a3e);}function a104_0x278a(){const _0x421979=['createZip','src','async','every','MDApiWriter','body','234228zNzbXJ','MetadataType','path','values','constructor','toBuffer','listMetadataItem','451MXzDHx','xml2js','FOLDER_TO_METADATA_TYPE_MAP','join','/sobjects/Attachment','files','file','buildObject','Body','Zip','destructiveChangesPre.xml','PartialRetrieve','fileName','fetchComponentsDetailsByComponentsHistory','fileType','Name','PermissionSet','1913912hQjEls','/services/data/v','Logger','__esModule','DeclarativeFilterOptions','destructiveChangesPost.xml','writeFile','get','type','../utils/components-api','1.0','Profile','cwd','1083864nmyhOr','dir','MetadataConstants','generateAsync','reduce','base64','default','1335618SojFNK','mergeComponentPermissions','20aLnOVZ','../classes/logger','unzip','ComponentsApi','substring','extractComponentPermissions','__importDefault','ParentId','filter','length','.temp','1047KqCQCJ','1046LnYvpJ','Package','MAX_ZIP_SIZE','generateAndDeployZip','1130643UxmaCv','../../git/writers/mdapi.writer','replace','then','text','toString','search','BUILD','addLocalFolder','name','package.xml','7DTgoBJ','adm-zip','../../git/parsers/utils/zip','execute','indexOf','DEPLOYZIP','orgId','keys','251080XOKwdU','uuid','../utils/extract-component-permissions','5CYMJRs','map','components','push','(((.+)+)+)+$','removeNamespacePrefix','post','DEFLATE','fetchAttachmentBody'];a104_0x278a=function(){return _0x421979;};return a104_0x278a();}function getComponentsTypeAndName(_0x163bc7,_0x1e560c){return _0x163bc7['reduce']((_0x5bc8c9,_0x431c40)=>{const _0x566314=a104_0x21d0,_0x57d425=_0x1e560c['find'](_0x295a8e=>_0x295a8e['Id']===_0x431c40[_0x566314(0x13f)]);return _0x57d425&&_0x5bc8c9[_0x566314(0xfe)]({'name':_0x57d425['Component__r']['Component_Name__c'],'type':salesforce_1[_0x566314(0x131)][_0x566314(0x113)][_0x431c40[_0x566314(0x120)]]||_0x431c40['Name']}),_0x5bc8c9;},[]);}async function saveDestructiveChanges(_0x535a6a,_0x2bed2f,_0x58b9a9,_0x4b29cc){const _0x5154c2=a104_0x2a641b,_0x19764e=(await(0x0,fetch_attachments_1[_0x5154c2(0x103)])(_0x535a6a,_0x2bed2f))[_0x5154c2(0x14d)]();await fs_internal_1['FS'][_0x5154c2(0x128)](path_1['default']['join'](process['cwd'](),_0x5154c2(0x142),_0x4b29cc,DEPLOY_DIR_NAME,_0x5154c2(0x105),_0x58b9a9),_0x19764e);}async function createDeployZip(_0x44ddde){const _0x5ce24b=a104_0x2a641b,_0xe36097=new adm_zip_1[(_0x5ce24b(0x135))]();return await _0xe36097[_0x5ce24b(0x150)](path_1[_0x5ce24b(0x135)][_0x5ce24b(0x114)](process[_0x5ce24b(0x12e)](),_0x5ce24b(0x142),_0x44ddde,DEPLOY_DIR_NAME)),_0xe36097;}async function insertZip(_0x3a2bb5,_0x4189dd,_0x5b5ba4,_0x443aff,_0x59442b,_0x53f636){const _0x3e0415=a104_0x2a641b,_0x5dc43d={'ParentId':_0x4189dd,'Name':_0x3e0415(0x14f)+_0x5b5ba4,'Description':'BUILD'+_0x443aff,'Body':_0x59442b},{data:_0x1b4e9b}=await _0x3a2bb5[_0x3e0415(0x101)](_0x3e0415(0x123)+_0x53f636+_0x3e0415(0x115),_0x5dc43d);return _0x1b4e9b['id'];}