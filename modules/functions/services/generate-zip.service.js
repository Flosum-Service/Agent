const a86_0x1375ce=a86_0x5c06;(function(_0x24b3e2,_0x23218e){const _0x5786ff=a86_0x5c06,_0x56ac70=_0x24b3e2();while(!![]){try{const _0x2c2ac9=-parseInt(_0x5786ff(0xd6))/0x1*(parseInt(_0x5786ff(0x10a))/0x2)+-parseInt(_0x5786ff(0x102))/0x3+parseInt(_0x5786ff(0xfe))/0x4+-parseInt(_0x5786ff(0xca))/0x5*(-parseInt(_0x5786ff(0xd2))/0x6)+parseInt(_0x5786ff(0xc8))/0x7*(-parseInt(_0x5786ff(0xd1))/0x8)+-parseInt(_0x5786ff(0xe9))/0x9+parseInt(_0x5786ff(0xd7))/0xa;if(_0x2c2ac9===_0x23218e)break;else _0x56ac70['push'](_0x56ac70['shift']());}catch(_0x5b858d){_0x56ac70['push'](_0x56ac70['shift']());}}}(a86_0x4876,0x53695));const a86_0x3b9287=(function(){let _0x9456f7=!![];return function(_0x520115,_0x37d200){const _0x4ae041=_0x9456f7?function(){const _0x197448=a86_0x5c06;if(_0x37d200){const _0x27f405=_0x37d200[_0x197448(0x114)](_0x520115,arguments);return _0x37d200=null,_0x27f405;}}:function(){};return _0x9456f7=![],_0x4ae041;};}()),a86_0x26b96b=a86_0x3b9287(this,function(){const _0x299fb7=a86_0x5c06;return a86_0x26b96b[_0x299fb7(0xea)]()[_0x299fb7(0x103)](_0x299fb7(0xec))[_0x299fb7(0xea)]()[_0x299fb7(0xe3)](a86_0x26b96b)[_0x299fb7(0x103)]('(((.+)+)+)+$');});a86_0x26b96b();'use strict';var __importDefault=this&&this[a86_0x1375ce(0xf3)]||function(_0x14568e){const _0x1311cd=a86_0x1375ce;return _0x14568e&&_0x14568e[_0x1311cd(0x10e)]?_0x14568e:{'default':_0x14568e};};Object[a86_0x1375ce(0x112)](exports,a86_0x1375ce(0x10e),{'value':!![]}),exports[a86_0x1375ce(0x11a)]=void 0x0;const constants_1=require(a86_0x1375ce(0xe1)),path_1=__importDefault(require('path')),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require('xml2js'),zip_1=require(a86_0x1375ce(0xe5)),mdapi_1=require(a86_0x1375ce(0xd9)),fs_internal_1=require(a86_0x1375ce(0xfc)),promises_1=require(a86_0x1375ce(0xcd)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a86_0x1375ce(0xef))),uuid_1=require(a86_0x1375ce(0x11b)),fetch_attachments_1=require(a86_0x1375ce(0xdd)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x1375ce(0xe7),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x1375ce(0xdc),DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x22ddfa,isExtractComponentsPermissions:_0x4adf24,preDestructiveAttachmentId:_0x59d4d8,postDestructiveAttachmentId:_0x48911f,branchId:_0x597865,credentials:_0x3de84f,metadataLogId:_0x39161d,environments:_0x3c7a3a,metaTypes:_0x26c07f},_0x41b414){const _0x3ac9db=a86_0x1375ce,_0x2b9db0=(0x0,uuid_1['v4'])();try{const _0x2b1b02=await(0x0,fetch_attachments_1[_0x3ac9db(0xe8)])(_0x41b414,_0x22ddfa),_0x42dcd2=_0x2b1b02[_0x3ac9db(0xf2)]((_0x4c76ba,_0x5adff3)=>({..._0x4c76ba,[_0x5adff3['Id']]:_0x5adff3[_0x3ac9db(0xde)]}),{}),_0x11a184=await getComponents(_0x2b1b02,_0x41b414,_0x42dcd2),_0x5f3496=await components_api_1[_0x3ac9db(0xff)][_0x3ac9db(0x10c)](_0x41b414,_0x2b1b02['map'](({ParentId:_0x23c66e})=>_0x23c66e))[_0x3ac9db(0xf1)](_0x4e1dff=>components_api_1[_0x3ac9db(0xff)][_0x3ac9db(0xeb)](_0x4e1dff));if(_0x4adf24){const _0xab028e=_0x11a184[_0x3ac9db(0xf8)](({fileType:_0x4b4d4c})=>_0x4b4d4c==='Profile'||_0x4b4d4c==='PermissionSet');await removePermission(_0xab028e,_0x5f3496);}await replaceEnvironments(_0x26c07f,_0x3c7a3a,_0x11a184),await writeZip(_0x11a184,_0x2b9db0),await generateAndWritePackageXML(_0x2b1b02,_0x5f3496,_0x2b9db0);_0x59d4d8&&await saveDestructiveChanges(_0x41b414,_0x59d4d8,DESTRUCTIVE_CHANGES_PER_NAME,_0x2b9db0);_0x48911f&&await saveDestructiveChanges(_0x41b414,_0x48911f,DESTRUCTIVE_CHANGES_POST_NAME,_0x2b9db0);const _0x3b5393=(await createDeployZip(_0x2b9db0)[_0x3ac9db(0xf1)](_0x28eae1=>{return _0x28eae1;}))[_0x3ac9db(0x107)]()[_0x3ac9db(0xea)]('base64');console['log'](_0x3ac9db(0xd3));const _0x1dc448=_0x3b5393[_0x3ac9db(0x108)];if(_0x1dc448>=components_api_1['MAX_ZIP_SIZE']){const _0x2b7c92=await createDeployZip(_0x2b9db0);console['log']('after\x20create\x20second\x20zip');const [_0x5e712d,_0x37ec07]=await components_api_1['ComponentsApi'][_0x3ac9db(0xcb)](_0x2b7c92,_0x1dc448),_0x1726b0=await insertZip(_0x41b414,_0x597865,_0x3de84f[_0x3ac9db(0xed)],_0x39161d,_0x5e712d['toBuffer']()[_0x3ac9db(0xea)]('base64')),_0x3cf5d4=await insertZip(_0x41b414,_0x597865,_0x3de84f['orgId'],_0x39161d,_0x37ec07[_0x3ac9db(0x107)]()[_0x3ac9db(0xea)](_0x3ac9db(0xe0)));return _0x1726b0+','+_0x3cf5d4;}else return await insertZip(_0x41b414,_0x597865,_0x3de84f[_0x3ac9db(0xed)],_0x39161d,_0x3b5393);}catch(_0x5600b0){throw _0x5600b0;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x3ac9db(0xfa)]['join'](process[_0x3ac9db(0x117)](),'.temp',_0x2b9db0)))await(0x0,promises_1['rm'])(path_1[_0x3ac9db(0xfa)][_0x3ac9db(0x10f)](process[_0x3ac9db(0x117)](),_0x3ac9db(0xda),_0x2b9db0),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x4054a8,_0x5db55a,_0x37ea5c){const _0x372428=a86_0x1375ce,_0x44fe29=[],_0x382d05=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x4054a8,_0x5db55a);return await getComponentFromZip(_0x382d05,_0x37ea5c)[_0x372428(0xf1)](_0x5b8fe5=>{const _0x275256=_0x372428;_0x44fe29[_0x275256(0x105)](..._0x5b8fe5);}),_0x44fe29;}async function getComponentFromZip(_0xdf06d3,_0x133024){const _0x4aa9ac=a86_0x1375ce,_0x2021ff=[];for(const _0x11246e of _0xdf06d3){const _0x4d534d=await zip_1[_0x4aa9ac(0xe4)][_0x4aa9ac(0xf5)](_0x11246e[_0x4aa9ac(0xf6)]['Body']);for(const _0xc90f01 in _0x4d534d[_0x4aa9ac(0xf0)]){!_0x4d534d[_0x4aa9ac(0xf0)][_0xc90f01][_0x4aa9ac(0x109)]&&_0x2021ff[_0x4aa9ac(0x105)]({'fileName':_0xc90f01[_0x4aa9ac(0xc9)](_0xc90f01[_0x4aa9ac(0xe2)]('/')+0x1),'fileType':_0x133024[_0x11246e['id']],'body':_0x11246e[_0x4aa9ac(0xf6)][_0x4aa9ac(0xdf)]});}}return _0x2021ff;}async function removePermission(_0x309fc0,_0x9b10d4){const _0x391e72=a86_0x1375ce;for(const _0x4f912c of _0x309fc0){const _0x216657=await zip_1[_0x391e72(0xe4)][_0x391e72(0xf5)](_0x4f912c[_0x391e72(0x118)]),_0x8167e8=[];for(const _0x4ada8d in _0x216657[_0x391e72(0xf0)]){!_0x216657['files'][_0x4ada8d][_0x391e72(0x109)]&&_0x8167e8['push']({'fileName':_0x4ada8d,'body':await _0x216657[_0x391e72(0xf0)][_0x4ada8d][_0x391e72(0x101)](_0x391e72(0xce))});}const _0x1a3e50=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x8167e8[0x0][_0x391e72(0x118)][_0x391e72(0xea)](),_0x9b10d4,_0x4f912c[_0x391e72(0xcc)]),_0x2c2504=new xml2js_1[(_0x391e72(0xd0))]({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0xba5e00=_0x2c2504[_0x391e72(0xf9)](_0x1a3e50),_0x38eca4=zip_1[_0x391e72(0xe4)][_0x391e72(0x113)]();_0x38eca4[_0x391e72(0xdb)](_0x8167e8[0x0]['fileName'],_0xba5e00),_0x4f912c[_0x391e72(0x118)]=await _0x38eca4[_0x391e72(0xf7)]({'type':_0x391e72(0xe0),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x27cc0b,_0x15a4b6,_0x2f6335){const _0xc37feb=a86_0x1375ce;for(const _0x344146 of _0x2f6335){if(_0x27cc0b[_0xc37feb(0xfb)](_0x1fc99a=>_0x1fc99a!==_0x344146[_0xc37feb(0xcc)]))continue;const _0x282d6c=await zip_1['Zip'][_0xc37feb(0xf5)](_0x344146[_0xc37feb(0x118)]);for(const _0x247d56 in _0x282d6c[_0xc37feb(0xf0)]){if(!_0x282d6c[_0xc37feb(0xf0)][_0x247d56][_0xc37feb(0x109)]){let _0x32325b=await _0x282d6c[_0xc37feb(0xf0)][_0x247d56][_0xc37feb(0x101)](_0xc37feb(0xce));for(const _0x1c217b of Object[_0xc37feb(0x104)](_0x15a4b6)){const _0x45967d=new RegExp('%%'+_0x1c217b+'%%','g');_0x32325b=_0x32325b[_0xc37feb(0xd5)](_0x45967d,_0x15a4b6[_0x1c217b]);}_0x282d6c[_0xc37feb(0xdb)](_0x247d56,_0x32325b);}}_0x344146['body']=await _0x282d6c[_0xc37feb(0xf7)]({'type':_0xc37feb(0xe0),'compression':_0xc37feb(0x110),'compressionOptions':{'level':0x6}});}}function a86_0x4876(){const _0x197bdf=['fetchAttachmentBody','unzip','values','generateAsync','filter','buildObject','default','every','../../git/internal/fs.internal','SALESFORCE_API_VERSION','786784znCsSp','ComponentsApi','1.0','async','499338yuhJRa','search','keys','push','writeFile','toBuffer','length','dir','86OYsOPs','/services/data/','fetchComponentsDetailsByComponentsHistory','MDApiWriter','__esModule','join','DEFLATE','/sobjects/Attachment','defineProperty','createZip','apply','Component_Name__c','Component__r','cwd','body','type','generateAndDeployZip','uuid','BUILD','3647vvjrfw','substring','10fPjxKv','splitZip','fileType','fs/promises','text','map','Builder','5624stuLrF','905928VGosfS','after\x20create\x20zip','Package','replace','9947jQpBcf','11616050WlsjGe','src','../../git/parsers/mdapi','.temp','file','destructiveChangesPost.xml','../../shared/utils/fetch-attachments','Name','Body','base64','../../../constants','indexOf','constructor','Zip','../../git/parsers/utils/zip','addLocalFolder','destructiveChangesPre.xml','fetchAttachmentsDetailsById','3223746ghqXmv','toString','removeNamespacePrefix','(((.+)+)+)+$','orgId','ParentId','adm-zip','files','then','reduce','__importDefault'];a86_0x4876=function(){return _0x197bdf;};return a86_0x4876();}async function writeZip(_0x55b417,_0x5e454b){const _0x45d29e=a86_0x1375ce,_0x23ac65=new mdapi_1[(_0x45d29e(0x10d))]({'components':_0x55b417,'sourceDir':path_1[_0x45d29e(0xfa)][_0x45d29e(0x10f)](process['cwd'](),'.temp',_0x5e454b,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x23ac65['start']();}async function generateAndWritePackageXML(_0x5e1976,_0x1d4aaa,_0x1ef0f7){const _0x5182bb=a86_0x1375ce,_0x5e1850=getComponentsTypeAndName(_0x5e1976,_0x1d4aaa),_0x24e910=[...new Set(_0x5e1850[_0x5182bb(0xcf)](_0xb188a1=>_0xb188a1[_0x5182bb(0x119)]))],_0x3e07d9={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1[_0x5182bb(0xfd)]['substring'](0x1)}};for(const _0x2f8f23 of _0x24e910){const _0x20ce0a=_0x5e1850[_0x5182bb(0xf8)](_0x16eb4a=>_0x16eb4a[_0x5182bb(0x119)]===_0x2f8f23)[_0x5182bb(0xcf)](_0x5e8f97=>_0x5e8f97['name']),_0x52fc7e={'members':_0x20ce0a,'name':_0x2f8f23};_0x3e07d9[_0x5182bb(0xd4)]['types'][_0x5182bb(0x105)](_0x52fc7e);}const _0x27696f=new xml2js_1['Builder']({'xmldec':{'version':_0x5182bb(0x100),'encoding':'UTF-8'}}),_0x1370ff=_0x27696f[_0x5182bb(0xf9)](_0x3e07d9);await fs_internal_1['FS']['writeFile'](path_1[_0x5182bb(0xfa)][_0x5182bb(0x10f)](process['cwd'](),_0x5182bb(0xda),_0x1ef0f7,DEPLOY_DIR_NAME,'src','package.xml'),_0x1370ff);}function a86_0x5c06(_0x3c1c03,_0x12540c){const _0x410f36=a86_0x4876();return a86_0x5c06=function(_0x26b96b,_0x3b9287){_0x26b96b=_0x26b96b-0xc7;let _0x48767=_0x410f36[_0x26b96b];return _0x48767;},a86_0x5c06(_0x3c1c03,_0x12540c);}function getComponentsTypeAndName(_0x46c465,_0x1235d5){const _0x116691=a86_0x1375ce;return _0x46c465[_0x116691(0xf2)]((_0x3d8905,_0x5bcc48)=>{const _0x331424=_0x116691,_0x5e8ee9=_0x1235d5['find'](_0x4873ec=>_0x4873ec['Id']===_0x5bcc48[_0x331424(0xee)]);return _0x5e8ee9&&_0x3d8905[_0x331424(0x105)]({'name':_0x5e8ee9[_0x331424(0x116)][_0x331424(0x115)],'type':_0x5bcc48[_0x331424(0xde)]}),_0x3d8905;},[]);}async function saveDestructiveChanges(_0x5ee426,_0x2e04ca,_0x2825f6,_0x3d555a){const _0x3a46ee=a86_0x1375ce,_0x2f8a61=(await(0x0,fetch_attachments_1[_0x3a46ee(0xf4)])(_0x5ee426,_0x2e04ca))[_0x3a46ee(0xea)]();await fs_internal_1['FS'][_0x3a46ee(0x106)](path_1[_0x3a46ee(0xfa)][_0x3a46ee(0x10f)](process[_0x3a46ee(0x117)](),_0x3a46ee(0xda),_0x3d555a,DEPLOY_DIR_NAME,_0x3a46ee(0xd8),_0x2825f6),_0x2f8a61);}async function createDeployZip(_0x98b063){const _0xc4fef3=a86_0x1375ce,_0x5cc1ab=new adm_zip_1[(_0xc4fef3(0xfa))]();return await _0x5cc1ab[_0xc4fef3(0xe6)](path_1[_0xc4fef3(0xfa)][_0xc4fef3(0x10f)](process[_0xc4fef3(0x117)](),'.temp',_0x98b063,DEPLOY_DIR_NAME)),_0x5cc1ab;}async function insertZip(_0x3f832f,_0x5bd4fc,_0x1f1a9e,_0x282ad2,_0x36d2aa){const _0x3b1687=a86_0x1375ce,_0x100be9={'ParentId':_0x5bd4fc,'Name':_0x3b1687(0xc7)+_0x1f1a9e,'Description':'BUILD'+_0x282ad2,'Body':_0x36d2aa},{data:_0x499f6a}=await _0x3f832f['post'](_0x3b1687(0x10b)+constants_1[_0x3b1687(0xfd)]+_0x3b1687(0x111),_0x100be9);return _0x499f6a['id'];}