const a85_0x660b3e=a85_0x5eb3;(function(_0x40a247,_0x5cbee4){const _0x26d186=a85_0x5eb3,_0x391ef6=_0x40a247();while(!![]){try{const _0x42225d=parseInt(_0x26d186(0x19d))/0x1*(-parseInt(_0x26d186(0x179))/0x2)+-parseInt(_0x26d186(0x175))/0x3+-parseInt(_0x26d186(0x173))/0x4+parseInt(_0x26d186(0x1ad))/0x5*(parseInt(_0x26d186(0x188))/0x6)+-parseInt(_0x26d186(0x1a9))/0x7+parseInt(_0x26d186(0x163))/0x8*(-parseInt(_0x26d186(0x1a4))/0x9)+-parseInt(_0x26d186(0x165))/0xa*(-parseInt(_0x26d186(0x17c))/0xb);if(_0x42225d===_0x5cbee4)break;else _0x391ef6['push'](_0x391ef6['shift']());}catch(_0x54ff9d){_0x391ef6['push'](_0x391ef6['shift']());}}}(a85_0xe3bd,0x993ce));const a85_0x4576f5=(function(){let _0x6b8ce4=!![];return function(_0x58bd7e,_0x5ae8ca){const _0x3104ad=_0x6b8ce4?function(){const _0x9499b5=a85_0x5eb3;if(_0x5ae8ca){const _0x58f3b6=_0x5ae8ca[_0x9499b5(0x18a)](_0x58bd7e,arguments);return _0x5ae8ca=null,_0x58f3b6;}}:function(){};return _0x6b8ce4=![],_0x3104ad;};}()),a85_0x260ac5=a85_0x4576f5(this,function(){const _0x5573ab=a85_0x5eb3;return a85_0x260ac5[_0x5573ab(0x167)]()[_0x5573ab(0x17f)]('(((.+)+)+)+$')[_0x5573ab(0x167)]()[_0x5573ab(0x1a7)](a85_0x260ac5)[_0x5573ab(0x17f)](_0x5573ab(0x19a));});a85_0x260ac5();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x4cb450){const _0x29539d=a85_0x5eb3;return _0x4cb450&&_0x4cb450[_0x29539d(0x1b3)]?_0x4cb450:{'default':_0x4cb450};};Object[a85_0x660b3e(0x1b1)](exports,a85_0x660b3e(0x1b3),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require('path')),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a85_0x660b3e(0x18f)),zip_1=require(a85_0x660b3e(0x1a6)),mdapi_1=require(a85_0x660b3e(0x185)),fs_internal_1=require(a85_0x660b3e(0x18d)),promises_1=require(a85_0x660b3e(0x1a3)),components_api_1=require(a85_0x660b3e(0x1b2)),adm_zip_1=__importDefault(require(a85_0x660b3e(0x15d))),uuid_1=require(a85_0x660b3e(0x196)),fetch_attachments_1=require(a85_0x660b3e(0x17b)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a85_0x660b3e(0x1a8),DEPLOY_DIR_NAME=a85_0x660b3e(0x1ab);function a85_0xe3bd(){const _0x5efd87=['413050nZJPCH','Name','push','search','PermissionSet','reduce','body','dir','splitZip','../../git/parsers/mdapi','values','Component__r','6NUACui','start','apply','indexOf','fetchAttachmentBody','../../git/internal/fs.internal','SALESFORCE_API_VERSION','xml2js','after\x20create\x20zip','Body','length','fileName','Builder','MDApiWriter','uuid','map','after\x20create\x20second\x20zip','base64','(((.+)+)+)+$','UTF-8','generateAsync','1sNtvSj','BUILD','post','async','files','keys','fs/promises','3987xhNJxj','find','../../git/parsers/utils/zip','constructor','destructiveChangesPost.xml','4678268UTkkpV','substring','DEPLOYZIP','createZip','4866535ZLnQYj','1.0','join','unzip','defineProperty','../utils/components-api','__esModule','filter','ComponentsApi','type','MAX_ZIP_SIZE','src','Package','DEFLATE','adm-zip','exists','text','cwd','generateAndDeployZip','fetchAttachmentsDetailsById','18440JpBdVC','writeFile','730aLpUFu','addLocalFolder','toString','retrieveAttachments','default','fetchComponentsDetailsByComponentsHistory','toBuffer','ParentId','.temp','Component_Name__c','then','file','name','orgId','1497068GgGsRp','/sobjects/Attachment','2511306szcJnX','buildObject','fileType','Zip','371974LIzvMz','extractComponentPermissions','../../shared/utils/fetch-attachments'];a85_0xe3bd=function(){return _0x5efd87;};return a85_0xe3bd();}async function generateAndDeployZip({attachmentsId:_0x58321c,isExtractComponentsPermissions:_0x3fcd69,preDestructiveAttachmentId:_0x31133a,postDestructiveAttachmentId:_0x1c37cd,branchId:_0x41a8a0,credentials:_0x5b51c0,metadataLogId:_0x37ad3e,environments:_0x4e047f,metaTypes:_0x5bbf81},_0xe120f4){const _0x163e8c=a85_0x660b3e,_0x5b483c=(0x0,uuid_1['v4'])();try{const _0x11b091=await(0x0,fetch_attachments_1[_0x163e8c(0x162)])(_0xe120f4,_0x58321c),_0x4af863=_0x11b091[_0x163e8c(0x181)]((_0x369fa5,_0x2e60b5)=>({..._0x369fa5,[_0x2e60b5['Id']]:_0x2e60b5[_0x163e8c(0x17d)]}),{}),_0x4b809f=await getComponents(_0x11b091,_0xe120f4,_0x4af863),_0x5f1e68=await components_api_1['ComponentsApi'][_0x163e8c(0x16a)](_0xe120f4,_0x11b091[_0x163e8c(0x197)](({ParentId:_0x1c5ade})=>_0x1c5ade))['then'](_0x39d618=>components_api_1[_0x163e8c(0x1b5)]['removeNamespacePrefix'](_0x39d618));if(_0x3fcd69){const _0x24a2ef=_0x4b809f[_0x163e8c(0x1b4)](({fileType:_0x255538})=>_0x255538==='Profile'||_0x255538===_0x163e8c(0x180));await removePermission(_0x24a2ef,_0x5f1e68);}await replaceEnvironments(_0x5bbf81,_0x4e047f,_0x4b809f),await writeZip(_0x4b809f,_0x5b483c),await generateAndWritePackageXML(_0x11b091,_0x5f1e68,_0x5b483c);_0x31133a&&await saveDestructiveChanges(_0xe120f4,_0x31133a,DESTRUCTIVE_CHANGES_PER_NAME,_0x5b483c);_0x1c37cd&&await saveDestructiveChanges(_0xe120f4,_0x1c37cd,DESTRUCTIVE_CHANGES_POST_NAME,_0x5b483c);const _0x19eeb5=(await createDeployZip(_0x5b483c)[_0x163e8c(0x16f)](_0x4ebfde=>{return _0x4ebfde;}))[_0x163e8c(0x16b)]()['toString'](_0x163e8c(0x199));console['log'](_0x163e8c(0x190));const _0x32b227=_0x19eeb5[_0x163e8c(0x192)];if(_0x32b227>=components_api_1[_0x163e8c(0x1b7)]){const _0x3b6615=await createDeployZip(_0x5b483c);console['log'](_0x163e8c(0x198));const [_0x5b2b4f,_0x2cc12d]=await components_api_1[_0x163e8c(0x1b5)][_0x163e8c(0x184)](_0x3b6615,_0x32b227),_0x3e2f32=await insertZip(_0xe120f4,_0x41a8a0,_0x5b51c0[_0x163e8c(0x172)],_0x37ad3e,_0x5b2b4f[_0x163e8c(0x16b)]()[_0x163e8c(0x167)](_0x163e8c(0x199))),_0x4c93a5=await insertZip(_0xe120f4,_0x41a8a0,_0x5b51c0['orgId'],_0x37ad3e,_0x2cc12d['toBuffer']()[_0x163e8c(0x167)](_0x163e8c(0x199)));return _0x3e2f32+','+_0x4c93a5;}else return await insertZip(_0xe120f4,_0x41a8a0,_0x5b51c0[_0x163e8c(0x172)],_0x37ad3e,_0x19eeb5);}catch(_0x25198b){throw _0x25198b;}finally{if(await fs_internal_1['FS'][_0x163e8c(0x15e)](path_1[_0x163e8c(0x169)][_0x163e8c(0x1af)](process['cwd'](),'.temp',_0x5b483c)))await(0x0,promises_1['rm'])(path_1['default'][_0x163e8c(0x1af)](process[_0x163e8c(0x160)](),_0x163e8c(0x16d),_0x5b483c),{'recursive':!![]});}}exports[a85_0x660b3e(0x161)]=generateAndDeployZip;async function getComponents(_0x290113,_0x2bc172,_0x18a694){const _0x320180=a85_0x660b3e,_0x1cbdd6=[],_0x403962=await(0x0,fetch_attachments_1[_0x320180(0x168)])(_0x290113,_0x2bc172);return await getComponentFromZip(_0x403962,_0x18a694)[_0x320180(0x16f)](_0x51d5b2=>{const _0x26292e=_0x320180;_0x1cbdd6[_0x26292e(0x17e)](..._0x51d5b2);}),_0x1cbdd6;}async function getComponentFromZip(_0x555c2b,_0x424cf7){const _0x48ef89=a85_0x660b3e,_0x42ca73=[];for(const _0x57b892 of _0x555c2b){const _0x282938=await zip_1[_0x48ef89(0x178)]['unzip'](_0x57b892[_0x48ef89(0x186)][_0x48ef89(0x191)]);for(const _0x188833 in _0x282938['files']){!_0x282938['files'][_0x188833][_0x48ef89(0x183)]&&_0x42ca73[_0x48ef89(0x17e)]({'fileName':_0x188833['substring'](_0x188833[_0x48ef89(0x18b)]('/')+0x1),'fileType':_0x424cf7[_0x57b892['id']],'body':_0x57b892[_0x48ef89(0x186)][_0x48ef89(0x191)]});}}return _0x42ca73;}async function removePermission(_0xa406de,_0xf47918){const _0x342611=a85_0x660b3e;for(const _0x412535 of _0xa406de){const _0x3047d8=await zip_1['Zip'][_0x342611(0x1b0)](_0x412535['body']),_0x2aab69=[];for(const _0x20447e in _0x3047d8[_0x342611(0x1a1)]){!_0x3047d8[_0x342611(0x1a1)][_0x20447e][_0x342611(0x183)]&&_0x2aab69['push']({'fileName':_0x20447e,'body':await _0x3047d8[_0x342611(0x1a1)][_0x20447e][_0x342611(0x1a0)](_0x342611(0x15f))});}const _0x38a173=await(0x0,extract_component_permissions_1[_0x342611(0x17a)])(_0x2aab69[0x0][_0x342611(0x182)][_0x342611(0x167)](),_0xf47918,_0x412535[_0x342611(0x177)]),_0x3e9ce1=new xml2js_1[(_0x342611(0x194))]({'xmldec':{'version':_0x342611(0x1ae),'encoding':_0x342611(0x19b)}}),_0x26fad2=_0x3e9ce1[_0x342611(0x176)](_0x38a173),_0x291cd9=zip_1[_0x342611(0x178)][_0x342611(0x1ac)]();_0x291cd9[_0x342611(0x170)](_0x2aab69[0x0][_0x342611(0x193)],_0x26fad2),_0x412535['body']=await _0x291cd9['generateAsync']({'type':_0x342611(0x199),'compression':_0x342611(0x15c),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x3ebb67,_0x8ed316,_0x5dda3c){const _0x3f5f51=a85_0x660b3e;for(const _0x580393 of _0x5dda3c){if(_0x3ebb67['every'](_0x5c85b2=>_0x5c85b2!==_0x580393['fileType']))continue;const _0x5e55ce=await zip_1[_0x3f5f51(0x178)][_0x3f5f51(0x1b0)](_0x580393['body']);for(const _0xce938c in _0x5e55ce[_0x3f5f51(0x1a1)]){if(!_0x5e55ce[_0x3f5f51(0x1a1)][_0xce938c]['dir']){let _0x25ddcf=await _0x5e55ce[_0x3f5f51(0x1a1)][_0xce938c][_0x3f5f51(0x1a0)](_0x3f5f51(0x15f));for(const _0x9fdbd7 of Object[_0x3f5f51(0x1a2)](_0x8ed316)){const _0x336bd7=new RegExp('%%'+_0x9fdbd7+'%%','g');_0x25ddcf=_0x25ddcf['replace'](_0x336bd7,_0x8ed316[_0x9fdbd7]);}_0x5e55ce[_0x3f5f51(0x170)](_0xce938c,_0x25ddcf);}}_0x580393[_0x3f5f51(0x182)]=await _0x5e55ce[_0x3f5f51(0x19c)]({'type':_0x3f5f51(0x199),'compression':_0x3f5f51(0x15c),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x2decb1,_0x25f7eb){const _0x9e1cf8=a85_0x660b3e,_0x599bdc=new mdapi_1[(_0x9e1cf8(0x195))]({'components':_0x2decb1,'sourceDir':path_1['default'][_0x9e1cf8(0x1af)](process[_0x9e1cf8(0x160)](),_0x9e1cf8(0x16d),_0x25f7eb,DEPLOY_DIR_NAME,_0x9e1cf8(0x15a)),'skipChildErrors':![]});await _0x599bdc[_0x9e1cf8(0x189)]();}async function generateAndWritePackageXML(_0x2c2f75,_0x1a51a0,_0x1cae26){const _0xaf1feb=a85_0x660b3e,_0x2d7671=getComponentsTypeAndName(_0x2c2f75,_0x1a51a0),_0x25f2db=[...new Set(_0x2d7671[_0xaf1feb(0x197)](_0x23ad2a=>_0x23ad2a['type']))],_0x441184={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION'][_0xaf1feb(0x1aa)](0x1)}};for(const _0x3a841f of _0x25f2db){const _0x4f2017=_0x2d7671[_0xaf1feb(0x1b4)](_0x2996a9=>_0x2996a9[_0xaf1feb(0x1b6)]===_0x3a841f)[_0xaf1feb(0x197)](_0x4aca4a=>_0x4aca4a[_0xaf1feb(0x171)]),_0x20db3b={'members':_0x4f2017,'name':_0x3a841f};_0x441184[_0xaf1feb(0x15b)]['types'][_0xaf1feb(0x17e)](_0x20db3b);}const _0x4369cf=new xml2js_1[(_0xaf1feb(0x194))]({'xmldec':{'version':_0xaf1feb(0x1ae),'encoding':_0xaf1feb(0x19b)}}),_0x2b65b7=_0x4369cf[_0xaf1feb(0x176)](_0x441184);await fs_internal_1['FS'][_0xaf1feb(0x164)](path_1[_0xaf1feb(0x169)][_0xaf1feb(0x1af)](process['cwd'](),_0xaf1feb(0x16d),_0x1cae26,DEPLOY_DIR_NAME,'src','package.xml'),_0x2b65b7);}function a85_0x5eb3(_0x14b999,_0x10a1a7){const _0x5b4b3f=a85_0xe3bd();return a85_0x5eb3=function(_0x260ac5,_0x4576f5){_0x260ac5=_0x260ac5-0x15a;let _0xe3bd47=_0x5b4b3f[_0x260ac5];return _0xe3bd47;},a85_0x5eb3(_0x14b999,_0x10a1a7);}function getComponentsTypeAndName(_0x63591b,_0x110002){return _0x63591b['reduce']((_0x337810,_0xecf978)=>{const _0x1c4909=a85_0x5eb3,_0x30b458=_0x110002[_0x1c4909(0x1a5)](_0x3617ae=>_0x3617ae['Id']===_0xecf978[_0x1c4909(0x16c)]);return _0x30b458&&_0x337810[_0x1c4909(0x17e)]({'name':_0x30b458[_0x1c4909(0x187)][_0x1c4909(0x16e)],'type':_0xecf978[_0x1c4909(0x17d)]}),_0x337810;},[]);}async function saveDestructiveChanges(_0x28d5c9,_0x3defb3,_0x2c32c7,_0x5291b3){const _0x4da32a=a85_0x660b3e,_0x3caded=(await(0x0,fetch_attachments_1[_0x4da32a(0x18c)])(_0x28d5c9,_0x3defb3))[_0x4da32a(0x167)]();await fs_internal_1['FS'][_0x4da32a(0x164)](path_1[_0x4da32a(0x169)][_0x4da32a(0x1af)](process[_0x4da32a(0x160)](),_0x4da32a(0x16d),_0x5291b3,DEPLOY_DIR_NAME,_0x4da32a(0x15a),_0x2c32c7),_0x3caded);}async function createDeployZip(_0x9bcd3){const _0x33da14=a85_0x660b3e,_0x17290f=new adm_zip_1[(_0x33da14(0x169))]();return await _0x17290f[_0x33da14(0x166)](path_1[_0x33da14(0x169)][_0x33da14(0x1af)](process[_0x33da14(0x160)](),_0x33da14(0x16d),_0x9bcd3,DEPLOY_DIR_NAME)),_0x17290f;}async function insertZip(_0x30d168,_0x27103d,_0x3c5bc3,_0xd1c4dd,_0x1eb97e){const _0x2c5ca1=a85_0x660b3e,_0x4a97a7={'ParentId':_0x27103d,'Name':_0x2c5ca1(0x19e)+_0x3c5bc3,'Description':_0x2c5ca1(0x19e)+_0xd1c4dd,'Body':_0x1eb97e},{data:_0x52e227}=await _0x30d168[_0x2c5ca1(0x19f)]('/services/data/'+constants_1[_0x2c5ca1(0x18e)]+_0x2c5ca1(0x174),_0x4a97a7);return _0x52e227['id'];}