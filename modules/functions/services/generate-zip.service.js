const a104_0x3cb7da=a104_0x5aa7;(function(_0x4fe4ea,_0x2c408a){const _0x4e91e4=a104_0x5aa7,_0x31e708=_0x4fe4ea();while(!![]){try{const _0x231a86=-parseInt(_0x4e91e4(0x109))/0x1+parseInt(_0x4e91e4(0x115))/0x2*(parseInt(_0x4e91e4(0x114))/0x3)+-parseInt(_0x4e91e4(0x127))/0x4*(-parseInt(_0x4e91e4(0x12c))/0x5)+parseInt(_0x4e91e4(0x158))/0x6+-parseInt(_0x4e91e4(0x11c))/0x7*(-parseInt(_0x4e91e4(0x13f))/0x8)+-parseInt(_0x4e91e4(0x143))/0x9*(-parseInt(_0x4e91e4(0x10c))/0xa)+parseInt(_0x4e91e4(0x15b))/0xb*(-parseInt(_0x4e91e4(0x144))/0xc);if(_0x231a86===_0x2c408a)break;else _0x31e708['push'](_0x31e708['shift']());}catch(_0x6095c1){_0x31e708['push'](_0x31e708['shift']());}}}(a104_0x3aa1,0x7fc02));const a104_0x4fa4e6=(function(){let _0x59f92b=!![];return function(_0x43f413,_0x23ab68){const _0xe91497=_0x59f92b?function(){const _0x3db405=a104_0x5aa7;if(_0x23ab68){const _0xf649b3=_0x23ab68[_0x3db405(0x145)](_0x43f413,arguments);return _0x23ab68=null,_0xf649b3;}}:function(){};return _0x59f92b=![],_0xe91497;};}()),a104_0x529ab7=a104_0x4fa4e6(this,function(){const _0x5dd9ee=a104_0x5aa7;return a104_0x529ab7[_0x5dd9ee(0x132)]()[_0x5dd9ee(0x15d)](_0x5dd9ee(0x15f))[_0x5dd9ee(0x132)]()[_0x5dd9ee(0x129)](a104_0x529ab7)[_0x5dd9ee(0x15d)](_0x5dd9ee(0x15f));});a104_0x529ab7();'use strict';var __importDefault=this&&this[a104_0x3cb7da(0x13c)]||function(_0x13b06a){const _0x36a2d4=a104_0x3cb7da;return _0x13b06a&&_0x13b06a[_0x36a2d4(0x118)]?_0x13b06a:{'default':_0x13b06a};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a104_0x3cb7da(0x161)]=void 0x0;const path_1=__importDefault(require(a104_0x3cb7da(0x125))),extract_component_permissions_1=require(a104_0x3cb7da(0x10e)),logger_1=require('../classes/logger'),xml2js_1=require('xml2js'),zip_1=require(a104_0x3cb7da(0x133)),mdapi_writer_1=require(a104_0x3cb7da(0x10d)),fs_internal_1=require(a104_0x3cb7da(0x15e)),promises_1=require(a104_0x3cb7da(0x141)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a104_0x3cb7da(0x13b))),uuid_1=require(a104_0x3cb7da(0x152)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a104_0x3cb7da(0x171)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x3cb7da(0x148),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x3cb7da(0x11f),DEPLOY_DIR_NAME=a104_0x3cb7da(0x162),PERMISSION_SET_FOLDER_NAME=a104_0x3cb7da(0x14e);async function generateAndDeployZip({attachmentsId:_0x8eea50,isExtractComponentsPermissionSets:_0x24cd8c,isExtractComponentsProfiles:_0x29626b,preDestructiveAttachmentId:_0x7d7a9,postDestructiveAttachmentId:_0x466240,branchId:_0x1d3c5d,credentials:_0x3135ec,metadataLogId:_0x4cc84b,environments:_0x2b5ace,metaTypes:_0x4ce2b4,apiVersion:_0xbf822},_0x1f4437,_0x32e8fb){const _0x4917aa=a104_0x3cb7da;var _0xde09de;const _0x3eda88=(0x0,uuid_1['v4'])();try{const _0x44a1bb=await(0x0,fetch_attachments_1[_0x4917aa(0x16c)])(_0x1f4437,_0x8eea50),_0x15dd19=_0x44a1bb[_0x4917aa(0x135)]((_0x501ff0,_0x454a3e)=>({..._0x501ff0,[_0x454a3e['Id']]:_0x454a3e[_0x4917aa(0x113)]}),{}),_0x2cb80d=await getComponents(_0x44a1bb,_0x1f4437,_0x15dd19),_0x2586f9=await components_api_1[_0x4917aa(0x10b)][_0x4917aa(0x159)](_0x1f4437,_0x44a1bb[_0x4917aa(0x12b)](({ParentId:_0x43a922})=>_0x43a922),_0xbf822)[_0x4917aa(0x139)](_0x1b236f=>components_api_1[_0x4917aa(0x10b)]['removeNamespacePrefix'](_0x1b236f));if(_0x29626b){const _0x30c0e0=_0x2cb80d['filter'](({fileType:_0x46dcfb})=>_0x46dcfb===_0x4917aa(0x154));await removePermission(_0x30c0e0,_0x2586f9);}const _0x2a8c8e=_0x2cb80d[_0x4917aa(0x117)](({fileType:_0xf4f268})=>_0xf4f268===_0x4917aa(0x15c));if(_0x2a8c8e[_0x4917aa(0x164)]&&_0x24cd8c){await removePermission(_0x2a8c8e,_0x2586f9);const {items:_0x364033}=await retrieveTargetPermissionSets(_0x2a8c8e,_0xbf822,_0x32e8fb);await mergePermissionSets(_0x2a8c8e,((_0xde09de=_0x364033['PermissionSet'])===null||_0xde09de===void 0x0?void 0x0:_0xde09de[_0x4917aa(0x160)])||[]);}await replaceEnvironments(_0x4ce2b4,_0x2b5ace,_0x2cb80d),await writeZip(_0x2cb80d,_0x3eda88),await generateAndWritePackageXML(_0x44a1bb,_0x2586f9,_0x3eda88,_0xbf822);_0x7d7a9&&await saveDestructiveChanges(_0x1f4437,_0x7d7a9,DESTRUCTIVE_CHANGES_PER_NAME,_0x3eda88);_0x466240&&await saveDestructiveChanges(_0x1f4437,_0x466240,DESTRUCTIVE_CHANGES_POST_NAME,_0x3eda88);const _0x55751e=(await createDeployZip(_0x3eda88)[_0x4917aa(0x139)](_0x5079f2=>{return _0x5079f2;}))[_0x4917aa(0x151)]()[_0x4917aa(0x132)]('base64'),_0x14d517=_0x55751e[_0x4917aa(0x164)];if(_0x14d517>=components_api_1[_0x4917aa(0x170)]){const _0x3160bd=await createDeployZip(_0x3eda88),[_0x32af17,_0x5137f8]=await components_api_1[_0x4917aa(0x10b)][_0x4917aa(0x12e)](_0x3160bd,_0x14d517),_0x12143e=await insertZip(_0x1f4437,_0x1d3c5d,_0x3135ec[_0x4917aa(0x12a)],_0x4cc84b,_0x32af17[_0x4917aa(0x151)]()[_0x4917aa(0x132)](_0x4917aa(0x119)),_0xbf822),_0x155989=await insertZip(_0x1f4437,_0x1d3c5d,_0x3135ec[_0x4917aa(0x12a)],_0x4cc84b,_0x5137f8[_0x4917aa(0x151)]()[_0x4917aa(0x132)](_0x4917aa(0x119)),_0xbf822);return _0x12143e+','+_0x155989;}else return await insertZip(_0x1f4437,_0x1d3c5d,_0x3135ec[_0x4917aa(0x12a)],_0x4cc84b,_0x55751e,_0xbf822);}catch(_0x55f8de){throw _0x55f8de;}finally{if(await fs_internal_1['FS'][_0x4917aa(0x167)](path_1[_0x4917aa(0x14b)][_0x4917aa(0x153)](process[_0x4917aa(0x169)](),'.temp',_0x3eda88)))await(0x0,promises_1['rm'])(path_1[_0x4917aa(0x14b)][_0x4917aa(0x153)](process[_0x4917aa(0x169)](),_0x4917aa(0x142),_0x3eda88),{'recursive':!![]});}}exports[a104_0x3cb7da(0x161)]=generateAndDeployZip;async function getComponents(_0x12cf29,_0x4b2b27,_0x5cf1c1){const _0x5a3eed=a104_0x3cb7da,_0x318c4f=[],_0x26a589=await(0x0,fetch_attachments_1[_0x5a3eed(0x134)])(_0x12cf29,_0x4b2b27);return await getComponentFromZip(_0x26a589,_0x5cf1c1)[_0x5a3eed(0x139)](_0x177041=>{_0x318c4f['push'](..._0x177041);}),_0x318c4f;}async function getComponentFromZip(_0x57cd84,_0x5870e5){const _0x3fd506=a104_0x3cb7da,_0x3e24d2=[];for(const _0x162c43 of _0x57cd84){const _0x102591=await zip_1[_0x3fd506(0x14d)][_0x3fd506(0x149)](_0x162c43[_0x3fd506(0x172)][_0x3fd506(0x14f)]);for(const _0x59d25f in _0x102591['files']){!_0x102591['files'][_0x59d25f]['dir']&&_0x3e24d2[_0x3fd506(0x16e)]({'fileName':_0x59d25f[_0x3fd506(0x121)](_0x59d25f[_0x3fd506(0x128)]('/')+0x1),'fileType':_0x5870e5[_0x162c43['id']],'body':_0x162c43[_0x3fd506(0x172)]['Body']});}}return _0x3e24d2;}async function removePermission(_0x2df28f,_0xeb605){const _0x2bf09a=a104_0x3cb7da;for(const _0x1d66be of _0x2df28f){const _0x4bf56d=await zip_1[_0x2bf09a(0x14d)][_0x2bf09a(0x149)](_0x1d66be[_0x2bf09a(0x14c)]),_0xad1eba=[];for(const _0x23316b in _0x4bf56d['files']){!_0x4bf56d['files'][_0x23316b]['dir']&&_0xad1eba[_0x2bf09a(0x16e)]({'fileName':_0x23316b,'body':await _0x4bf56d['files'][_0x23316b]['async'](_0x2bf09a(0x163))});}const _0x5927a5=await(0x0,extract_component_permissions_1[_0x2bf09a(0x174)])(_0xad1eba[0x0]['body'][_0x2bf09a(0x132)](),_0xeb605,_0x1d66be[_0x2bf09a(0x15a)]),_0x1f5f31=new xml2js_1[(_0x2bf09a(0x116))]({'xmldec':{'version':_0x2bf09a(0x13a),'encoding':'UTF-8'}}),_0x1a2183=_0x1f5f31[_0x2bf09a(0x123)](_0x5927a5),_0x33f64d=zip_1[_0x2bf09a(0x14d)][_0x2bf09a(0x168)]();_0x33f64d[_0x2bf09a(0x11b)](_0xad1eba[0x0][_0x2bf09a(0x140)],_0x1a2183),_0x1d66be[_0x2bf09a(0x14c)]=await _0x33f64d['generateAsync']({'type':_0x2bf09a(0x119),'compression':_0x2bf09a(0x112),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x52c6c3,_0x782840,_0x5acb6e){const _0x211504=a104_0x3cb7da,_0x2f9bcd=_0x52c6c3[_0x211504(0x12b)](_0x3d44f7=>PERMISSION_SET_FOLDER_NAME+'/'+_0x3d44f7['fileName'])['join'](';'),_0x9c0c92=[{'field':'fileName','option':salesforce_1[_0x211504(0x155)]['IN'],'value':_0x2f9bcd}],_0x529519=new logger_1[(_0x211504(0x14a))]();return new salesforce_1[(_0x211504(0x10a))](_0x782840,_0x5acb6e,_0x529519,_0x9c0c92,null,[salesforce_1[_0x211504(0x16b)][_0x211504(0x110)]])[_0x211504(0x173)]();}async function mergePermissionSets(_0x43a429,_0x432d24){const _0x4fbb01=a104_0x3cb7da,_0xc97599=_0x432d24[_0x4fbb01(0x135)]((_0x344a37,_0x35bd71)=>_0x344a37[_0x4fbb01(0x124)](_0x35bd71[_0x4fbb01(0x13d)][_0x4fbb01(0x140)],_0x35bd71),new Map());for(const _0x2c5706 of _0x43a429){const _0x30a578=PERMISSION_SET_FOLDER_NAME+'/'+_0x2c5706[_0x4fbb01(0x140)],_0x2246c5=_0xc97599[_0x4fbb01(0x11a)](_0x30a578);if(!_0x2246c5)continue;const _0x249a49=await zip_1[_0x4fbb01(0x14d)]['unzip'](_0x2c5706[_0x4fbb01(0x14c)]),_0x4c3309=await _0x249a49[_0x4fbb01(0x12f)][_0x30a578][_0x4fbb01(0x11e)](_0x4fbb01(0x163)),_0x1909f7=_0x2246c5[_0x4fbb01(0x12f)][_0x30a578][_0x4fbb01(0x132)](),_0x4b9561=await(0x0,extract_component_permissions_1[_0x4fbb01(0x11d)])(_0x4c3309,_0x1909f7,_0x2c5706[_0x4fbb01(0x15a)]),_0x391ad1=zip_1['Zip'][_0x4fbb01(0x168)]();_0x391ad1['file'](_0x30a578,_0x4b9561),_0x2c5706['body']=await _0x391ad1['generateAsync']({'type':_0x4fbb01(0x119),'compression':_0x4fbb01(0x112),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x2a306b,_0x2e6ff9,_0xcbee76){const _0x7a7aaa=a104_0x3cb7da;for(const _0x29eb36 of _0xcbee76){if(_0x2a306b[_0x7a7aaa(0x157)](_0x5f4f16=>_0x5f4f16!==_0x29eb36[_0x7a7aaa(0x15a)]))continue;const _0x49ca9a=await zip_1[_0x7a7aaa(0x14d)][_0x7a7aaa(0x149)](_0x29eb36[_0x7a7aaa(0x14c)]);for(const _0x1bba8d in _0x49ca9a[_0x7a7aaa(0x12f)]){if(!_0x49ca9a[_0x7a7aaa(0x12f)][_0x1bba8d][_0x7a7aaa(0x137)]){let _0xa5ecf2=await _0x49ca9a[_0x7a7aaa(0x12f)][_0x1bba8d][_0x7a7aaa(0x11e)](_0x7a7aaa(0x163));for(const _0x3f4766 of Object[_0x7a7aaa(0x10f)](_0x2e6ff9)){const _0x5cccf3=new RegExp('%%'+_0x3f4766+'%%','g');_0xa5ecf2=_0xa5ecf2[_0x7a7aaa(0x136)](_0x5cccf3,_0x2e6ff9[_0x3f4766]);}_0x49ca9a[_0x7a7aaa(0x11b)](_0x1bba8d,_0xa5ecf2);}}_0x29eb36[_0x7a7aaa(0x14c)]=await _0x49ca9a[_0x7a7aaa(0x13e)]({'type':_0x7a7aaa(0x119),'compression':_0x7a7aaa(0x112),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x472a26,_0x3f078a){const _0x404321=a104_0x3cb7da,_0x19a7dc=new mdapi_writer_1[(_0x404321(0x111))]({'components':_0x472a26,'sourceDir':path_1['default']['join'](process['cwd'](),'.temp',_0x3f078a,DEPLOY_DIR_NAME,_0x404321(0x120)),'skipChildErrors':![]});await _0x19a7dc[_0x404321(0x173)]();}async function generateAndWritePackageXML(_0x32860e,_0x27ab77,_0x129d19,_0x1b1774){const _0x5bb258=a104_0x3cb7da,_0x1edc3f=getComponentsTypeAndName(_0x32860e,_0x27ab77),_0x3d8c4e=[...new Set(_0x1edc3f[_0x5bb258(0x12b)](_0x28c81f=>_0x28c81f[_0x5bb258(0x146)]))],_0x3bff4c={'Package':{'$':{'xmlns':_0x5bb258(0x16a)},'types':[],'version':''+_0x1b1774}};for(const _0x45be4b of _0x3d8c4e){const _0x236b7e=_0x1edc3f['filter'](_0x5c6c6b=>_0x5c6c6b[_0x5bb258(0x146)]===_0x45be4b)[_0x5bb258(0x12b)](_0x508a42=>_0x508a42[_0x5bb258(0x138)]),_0x57697e={'members':_0x236b7e,'name':_0x45be4b};_0x3bff4c['Package'][_0x5bb258(0x131)][_0x5bb258(0x16e)](_0x57697e);}const _0x22ac5e=new xml2js_1[(_0x5bb258(0x116))]({'xmldec':{'version':_0x5bb258(0x13a),'encoding':_0x5bb258(0x150)}}),_0x3acdd4=_0x22ac5e[_0x5bb258(0x123)](_0x3bff4c);await fs_internal_1['FS'][_0x5bb258(0x16d)](path_1[_0x5bb258(0x14b)][_0x5bb258(0x153)](process['cwd'](),'.temp',_0x129d19,DEPLOY_DIR_NAME,_0x5bb258(0x120),_0x5bb258(0x166)),_0x3acdd4);}function a104_0x5aa7(_0x443686,_0x4e694e){const _0x5a160f=a104_0x3aa1();return a104_0x5aa7=function(_0x529ab7,_0x4fa4e6){_0x529ab7=_0x529ab7-0x109;let _0x3aa1dc=_0x5a160f[_0x529ab7];return _0x3aa1dc;},a104_0x5aa7(_0x443686,_0x4e694e);}function getComponentsTypeAndName(_0xf62957,_0x143d70){const _0x233bf9=a104_0x3cb7da;return _0xf62957[_0x233bf9(0x135)]((_0xfb3a01,_0x30eab9)=>{const _0xfbce30=_0x233bf9,_0x21edd3=_0x143d70['find'](_0x7f4c1c=>_0x7f4c1c['Id']===_0x30eab9['ParentId']);return _0x21edd3&&_0xfb3a01[_0xfbce30(0x16e)]({'name':_0x21edd3[_0xfbce30(0x156)][_0xfbce30(0x165)],'type':salesforce_1[_0xfbce30(0x16f)][_0xfbce30(0x147)][_0x30eab9[_0xfbce30(0x113)]]||_0x30eab9[_0xfbce30(0x113)]}),_0xfb3a01;},[]);}async function saveDestructiveChanges(_0xefc5c6,_0x5c16ff,_0x1cee0d,_0x513984){const _0x3b8ce2=a104_0x3cb7da,_0x10000a=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0xefc5c6,_0x5c16ff))[_0x3b8ce2(0x132)]();await fs_internal_1['FS'][_0x3b8ce2(0x16d)](path_1[_0x3b8ce2(0x14b)][_0x3b8ce2(0x153)](process[_0x3b8ce2(0x169)](),'.temp',_0x513984,DEPLOY_DIR_NAME,_0x3b8ce2(0x120),_0x1cee0d),_0x10000a);}function a104_0x3aa1(){const _0x482282=['165272hztaTT','fileName','fs/promises','.temp','18DXCCjJ','12MjSAZX','apply','type','FOLDER_TO_METADATA_TYPE_MAP','destructiveChangesPre.xml','unzip','Logger','default','body','Zip','permissionsets','Body','UTF-8','toBuffer','uuid','join','Profile','DeclarativeFilterOptions','Component__r','every','6066960mxIjjy','fetchComponentsDetailsByComponentsHistory','fileType','23149643tQtbxp','PermissionSet','search','../../git/internal/fs.internal','(((.+)+)+)+$','components','generateAndDeployZip','DEPLOYZIP','text','length','Component_Name__c','package.xml','exists','createZip','cwd','http://soap.sforce.com/2006/04/metadata','MetadataType','fetchAttachmentsDetailsById','writeFile','push','MetadataConstants','MAX_ZIP_SIZE','@flosum/salesforce','values','execute','extractComponentPermissions','721074IyMcTk','PartialRetrieve','ComponentsApi','1580980oqaUTL','../../git/writers/mdapi.writer','../utils/extract-component-permissions','keys','PERMISSION_SET','MDApiWriter','DEFLATE','Name','1113261UFneAK','2WvBOpA','Builder','filter','__esModule','base64','get','file','301rtrUVs','mergeComponentPermissions','async','destructiveChangesPost.xml','src','substring','addLocalFolder','buildObject','set','path','BUILD','234484isleAG','indexOf','constructor','orgId','map','65acrytc','/services/data/v','splitZip','files','/sobjects/Attachment','types','toString','../../git/parsers/utils/zip','retrieveAttachments','reduce','replace','dir','name','then','1.0','adm-zip','__importDefault','listMetadataItem','generateAsync'];a104_0x3aa1=function(){return _0x482282;};return a104_0x3aa1();}async function createDeployZip(_0x208346){const _0x2dfa81=a104_0x3cb7da,_0x2049fa=new adm_zip_1['default']();return await _0x2049fa[_0x2dfa81(0x122)](path_1[_0x2dfa81(0x14b)][_0x2dfa81(0x153)](process[_0x2dfa81(0x169)](),'.temp',_0x208346,DEPLOY_DIR_NAME)),_0x2049fa;}async function insertZip(_0x5675d3,_0x5b6bf4,_0x13719f,_0x246346,_0xd4dfc3,_0x5a53f7){const _0x252419=a104_0x3cb7da,_0x57b704={'ParentId':_0x5b6bf4,'Name':_0x252419(0x126)+_0x13719f,'Description':_0x252419(0x126)+_0x246346,'Body':_0xd4dfc3},{data:_0x39baea}=await _0x5675d3['post'](_0x252419(0x12d)+_0x5a53f7+_0x252419(0x130),_0x57b704);return _0x39baea['id'];}