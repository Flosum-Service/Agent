const a54_0x523d91=a54_0x4fc7;(function(_0x15a69c,_0x2f7083){const _0x38c0a1=a54_0x4fc7,_0xad5125=_0x15a69c();while(!![]){try{const _0x29b95b=parseInt(_0x38c0a1(0x195))/0x1*(parseInt(_0x38c0a1(0x189))/0x2)+-parseInt(_0x38c0a1(0x16d))/0x3+parseInt(_0x38c0a1(0x17e))/0x4*(-parseInt(_0x38c0a1(0x1a6))/0x5)+-parseInt(_0x38c0a1(0x173))/0x6+-parseInt(_0x38c0a1(0x167))/0x7+-parseInt(_0x38c0a1(0x18f))/0x8+parseInt(_0x38c0a1(0x1b2))/0x9;if(_0x29b95b===_0x2f7083)break;else _0xad5125['push'](_0xad5125['shift']());}catch(_0x5e1f53){_0xad5125['push'](_0xad5125['shift']());}}}(a54_0x1f26,0x64768));const a54_0x6ca29e=(function(){let _0x54823c=!![];return function(_0x4b47ce,_0xc50ab){const _0x2c074b=_0x54823c?function(){const _0x4d0820=a54_0x4fc7;if(_0xc50ab){const _0x506217=_0xc50ab[_0x4d0820(0x159)](_0x4b47ce,arguments);return _0xc50ab=null,_0x506217;}}:function(){};return _0x54823c=![],_0x2c074b;};}()),a54_0x41469f=a54_0x6ca29e(this,function(){const _0x1a711b=a54_0x4fc7;return a54_0x41469f['toString']()[_0x1a711b(0x188)]('(((.+)+)+)+$')[_0x1a711b(0x164)]()[_0x1a711b(0x18b)](a54_0x41469f)[_0x1a711b(0x188)]('(((.+)+)+)+$');});a54_0x41469f();'use strict';var __importDefault=this&&this[a54_0x523d91(0x17a)]||function(_0x453fb6){const _0x414895=a54_0x523d91;return _0x453fb6&&_0x453fb6[_0x414895(0x183)]?_0x453fb6:{'default':_0x453fb6};};Object['defineProperty'](exports,a54_0x523d91(0x183),{'value':!![]}),exports[a54_0x523d91(0x166)]=void 0x0;const constants_1=require(a54_0x523d91(0x181)),path_1=__importDefault(require(a54_0x523d91(0x179))),extract_component_permissions_1=require(a54_0x523d91(0x1ab)),xml2js_1=require(a54_0x523d91(0x158)),zip_1=require(a54_0x523d91(0x175)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a54_0x523d91(0x15c)),promises_1=require(a54_0x523d91(0x194)),components_api_1=require(a54_0x523d91(0x176)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require('uuid'),fetch_attachments_1=require(a54_0x523d91(0x1a9)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a54_0x523d91(0x1af),DEPLOY_DIR_NAME=a54_0x523d91(0x18a);function a54_0x1f26(){const _0x1ccfd2=['ParentId','1212360bxgeHw','keys','../../git/parsers/utils/zip','../utils/components-api','find','orgId','path','__importDefault','Package','UTF-8','async','11248zexgjp','src','splitZip','../../../constants','file','__esModule','removeNamespacePrefix','Name','fetchAttachmentBody','DEFLATE','search','2JVGsBM','DEPLOYZIP','constructor','SALESFORCE_API_VERSION','after\x20create\x20second\x20zip','values','4470328ctZhbi','log','toBuffer','name','fetchComponentsDetailsByComponentsHistory','fs/promises','609088ZhfbTH','join','BUILD','length','http://soap.sforce.com/2006/04/metadata','then','generateAsync','addLocalFolder','cwd','retrieveAttachments','default','map','MAX_ZIP_SIZE','ComponentsApi','MDApiWriter','fileType','Profile','1280KiobWP','body','type','../../shared/utils/fetch-attachments','Component_Name__c','../utils/extract-component-permissions','base64','start','every','destructiveChangesPost.xml','fetchAttachmentsDetailsById','push','13001670NJubIg','.temp','Body','xml2js','apply','PermissionSet','types','../../git/internal/fs.internal','replace','exists','files','reduce','unzip','Zip','createZip','toString','Builder','generateAndDeployZip','397502zDxRPc','text','fileName','substring','dir','after\x20create\x20zip','314139nKgoCq','1.0','indexOf','buildObject','filter'];a54_0x1f26=function(){return _0x1ccfd2;};return a54_0x1f26();}async function generateAndDeployZip({attachmentsId:_0x1ae92e,isExtractComponentsPermissions:_0x501c84,preDestructiveAttachmentId:_0x34fcc5,postDestructiveAttachmentId:_0x2762ab,branchId:_0x2a0a2e,credentials:_0x5c7a90,metadataLogId:_0x2fd385,environments:_0xbf852e,metaTypes:_0xcbdeae},_0x58e022){const _0x2b4e0b=a54_0x523d91,_0x2d2a67=(0x0,uuid_1['v4'])();try{const _0x391eae=await(0x0,fetch_attachments_1[_0x2b4e0b(0x1b0)])(_0x58e022,_0x1ae92e),_0x3945a1=_0x391eae[_0x2b4e0b(0x160)]((_0x5d2032,_0x92cd96)=>({..._0x5d2032,[_0x92cd96['Id']]:_0x92cd96['Name']}),{}),_0x2a0a76=await getComponents(_0x391eae,_0x58e022,_0x3945a1),_0x51f7f8=await components_api_1[_0x2b4e0b(0x1a2)][_0x2b4e0b(0x193)](_0x58e022,_0x391eae[_0x2b4e0b(0x1a0)](({ParentId:_0x3fc36a})=>_0x3fc36a))[_0x2b4e0b(0x19a)](_0x1cb17f=>components_api_1[_0x2b4e0b(0x1a2)][_0x2b4e0b(0x184)](_0x1cb17f));if(_0x501c84){const _0x42c1f8=_0x2a0a76['filter'](({fileType:_0x631217})=>_0x631217===_0x2b4e0b(0x1a5)||_0x631217===_0x2b4e0b(0x15a));await removePermission(_0x42c1f8,_0x51f7f8);}await replaceEnvironments(_0xcbdeae,_0xbf852e,_0x2a0a76),await writeZip(_0x2a0a76,_0x2d2a67),await generateAndWritePackageXML(_0x391eae,_0x51f7f8,_0x2d2a67);_0x34fcc5&&await saveDestructiveChanges(_0x58e022,_0x34fcc5,DESTRUCTIVE_CHANGES_PER_NAME,_0x2d2a67);_0x2762ab&&await saveDestructiveChanges(_0x58e022,_0x2762ab,DESTRUCTIVE_CHANGES_POST_NAME,_0x2d2a67);const _0x308a5a=(await createDeployZip(_0x2d2a67)['then'](_0x1dd721=>{return _0x1dd721;}))[_0x2b4e0b(0x191)]()[_0x2b4e0b(0x164)](_0x2b4e0b(0x1ac));console[_0x2b4e0b(0x190)](_0x2b4e0b(0x16c));const _0x187023=_0x308a5a[_0x2b4e0b(0x198)];if(_0x187023>=components_api_1[_0x2b4e0b(0x1a1)]){const _0x5d637a=await createDeployZip(_0x2d2a67);console[_0x2b4e0b(0x190)](_0x2b4e0b(0x18d));const [_0x89da84,_0x4c7b74]=await components_api_1[_0x2b4e0b(0x1a2)][_0x2b4e0b(0x180)](_0x5d637a,_0x187023),_0x1ea02f=await insertZip(_0x58e022,_0x2a0a2e,_0x5c7a90[_0x2b4e0b(0x178)],_0x2fd385,_0x89da84[_0x2b4e0b(0x191)]()[_0x2b4e0b(0x164)](_0x2b4e0b(0x1ac))),_0x2b4f40=await insertZip(_0x58e022,_0x2a0a2e,_0x5c7a90['orgId'],_0x2fd385,_0x4c7b74['toBuffer']()['toString'](_0x2b4e0b(0x1ac)));return _0x1ea02f+','+_0x2b4f40;}else return await insertZip(_0x58e022,_0x2a0a2e,_0x5c7a90[_0x2b4e0b(0x178)],_0x2fd385,_0x308a5a);}catch(_0x343906){throw _0x343906;}finally{if(await fs_internal_1['FS'][_0x2b4e0b(0x15e)](path_1[_0x2b4e0b(0x19f)][_0x2b4e0b(0x196)](process[_0x2b4e0b(0x19d)](),'.temp',_0x2d2a67)))await(0x0,promises_1['rm'])(path_1[_0x2b4e0b(0x19f)][_0x2b4e0b(0x196)](process[_0x2b4e0b(0x19d)](),_0x2b4e0b(0x1b3),_0x2d2a67),{'recursive':!![]});}}exports[a54_0x523d91(0x166)]=generateAndDeployZip;async function getComponents(_0x1592e3,_0x2fbcdc,_0x139316){const _0x3bdbf2=a54_0x523d91,_0x1ae5f3=[],_0x52c0f6=await(0x0,fetch_attachments_1[_0x3bdbf2(0x19e)])(_0x1592e3,_0x2fbcdc);return await getComponentFromZip(_0x52c0f6,_0x139316)[_0x3bdbf2(0x19a)](_0x3f565d=>{_0x1ae5f3['push'](..._0x3f565d);}),_0x1ae5f3;}async function getComponentFromZip(_0x3f8f74,_0x43faff){const _0x43e4bd=a54_0x523d91,_0x19a4fa=[];for(const _0x163565 of _0x3f8f74){const _0x480ab3=await zip_1[_0x43e4bd(0x162)]['unzip'](_0x163565[_0x43e4bd(0x18e)][_0x43e4bd(0x157)]);for(const _0x5e8baa in _0x480ab3['files']){!_0x480ab3[_0x43e4bd(0x15f)][_0x5e8baa][_0x43e4bd(0x16b)]&&_0x19a4fa['push']({'fileName':_0x5e8baa[_0x43e4bd(0x16a)](_0x5e8baa[_0x43e4bd(0x16f)]('/')+0x1),'fileType':_0x43faff[_0x163565['id']],'body':_0x163565['values'][_0x43e4bd(0x157)]});}}return _0x19a4fa;}async function removePermission(_0x487dd8,_0x130650){const _0x2ee2eb=a54_0x523d91;for(const _0x5d642d of _0x487dd8){const _0x136dca=await zip_1[_0x2ee2eb(0x162)][_0x2ee2eb(0x161)](_0x5d642d[_0x2ee2eb(0x1a7)]),_0x3aa9ae=[];for(const _0x3fd6e4 in _0x136dca[_0x2ee2eb(0x15f)]){!_0x136dca[_0x2ee2eb(0x15f)][_0x3fd6e4]['dir']&&_0x3aa9ae[_0x2ee2eb(0x1b1)]({'fileName':_0x3fd6e4,'body':await _0x136dca['files'][_0x3fd6e4][_0x2ee2eb(0x17d)](_0x2ee2eb(0x168))});}const _0x4dae70=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x3aa9ae[0x0][_0x2ee2eb(0x1a7)]['toString'](),_0x130650,_0x5d642d[_0x2ee2eb(0x1a4)]),_0x1df435=new xml2js_1['Builder']({'xmldec':{'version':_0x2ee2eb(0x16e),'encoding':'UTF-8'}}),_0x1175d3=_0x1df435[_0x2ee2eb(0x170)](_0x4dae70),_0x458f10=zip_1['Zip'][_0x2ee2eb(0x163)]();_0x458f10[_0x2ee2eb(0x182)](_0x3aa9ae[0x0][_0x2ee2eb(0x169)],_0x1175d3),_0x5d642d[_0x2ee2eb(0x1a7)]=await _0x458f10[_0x2ee2eb(0x19b)]({'type':'base64','compression':_0x2ee2eb(0x187),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x31cb1d,_0x5de89a,_0x3df10a){const _0x31c8d9=a54_0x523d91;for(const _0x258b38 of _0x3df10a){if(_0x31cb1d[_0x31c8d9(0x1ae)](_0x257329=>_0x257329!==_0x258b38[_0x31c8d9(0x1a4)]))continue;const _0x3d22df=await zip_1[_0x31c8d9(0x162)][_0x31c8d9(0x161)](_0x258b38[_0x31c8d9(0x1a7)]);for(const _0x57116f in _0x3d22df[_0x31c8d9(0x15f)]){if(!_0x3d22df[_0x31c8d9(0x15f)][_0x57116f][_0x31c8d9(0x16b)]){let _0x498208=await _0x3d22df[_0x31c8d9(0x15f)][_0x57116f][_0x31c8d9(0x17d)](_0x31c8d9(0x168));for(const _0x302274 of Object[_0x31c8d9(0x174)](_0x5de89a)){const _0x5a4f44=new RegExp('%%'+_0x302274+'%%','g');_0x498208=_0x498208[_0x31c8d9(0x15d)](_0x5a4f44,_0x5de89a[_0x302274]);}_0x3d22df[_0x31c8d9(0x182)](_0x57116f,_0x498208);}}_0x258b38[_0x31c8d9(0x1a7)]=await _0x3d22df[_0x31c8d9(0x19b)]({'type':_0x31c8d9(0x1ac),'compression':_0x31c8d9(0x187),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x599c39,_0x5cdc36){const _0x2ffda4=a54_0x523d91,_0x3197a8=new mdapi_1[(_0x2ffda4(0x1a3))]({'components':_0x599c39,'sourceDir':path_1[_0x2ffda4(0x19f)]['join'](process[_0x2ffda4(0x19d)](),_0x2ffda4(0x1b3),_0x5cdc36,DEPLOY_DIR_NAME,_0x2ffda4(0x17f)),'skipChildErrors':![]});await _0x3197a8[_0x2ffda4(0x1ad)]();}async function generateAndWritePackageXML(_0x289d06,_0x5d409b,_0x1526a6){const _0x310b3a=a54_0x523d91,_0x17c382=getComponentsTypeAndName(_0x289d06,_0x5d409b),_0x1ee0e6=[...new Set(_0x17c382[_0x310b3a(0x1a0)](_0x5a603a=>_0x5a603a['type']))],_0x3a879e={'Package':{'$':{'xmlns':_0x310b3a(0x199)},'types':[],'version':''+constants_1[_0x310b3a(0x18c)][_0x310b3a(0x16a)](0x1)}};for(const _0x122641 of _0x1ee0e6){const _0x15ef7f=_0x17c382[_0x310b3a(0x171)](_0x24d1b1=>_0x24d1b1[_0x310b3a(0x1a8)]===_0x122641)[_0x310b3a(0x1a0)](_0x506a79=>_0x506a79[_0x310b3a(0x192)]),_0x5cb620={'members':_0x15ef7f,'name':_0x122641};_0x3a879e[_0x310b3a(0x17b)][_0x310b3a(0x15b)][_0x310b3a(0x1b1)](_0x5cb620);}const _0x79c9d5=new xml2js_1[(_0x310b3a(0x165))]({'xmldec':{'version':_0x310b3a(0x16e),'encoding':_0x310b3a(0x17c)}}),_0x3a9fc1=_0x79c9d5[_0x310b3a(0x170)](_0x3a879e);await fs_internal_1['FS']['writeFile'](path_1[_0x310b3a(0x19f)][_0x310b3a(0x196)](process['cwd'](),'.temp',_0x1526a6,DEPLOY_DIR_NAME,_0x310b3a(0x17f),'package.xml'),_0x3a9fc1);}function getComponentsTypeAndName(_0x34fa30,_0x35741e){const _0x52f27f=a54_0x523d91;return _0x34fa30[_0x52f27f(0x160)]((_0x563073,_0xaa69a)=>{const _0x229570=_0x52f27f,_0x4f90a0=_0x35741e[_0x229570(0x177)](_0x23abab=>_0x23abab['Id']===_0xaa69a[_0x229570(0x172)]);return _0x4f90a0&&_0x563073[_0x229570(0x1b1)]({'name':_0x4f90a0['Component__r'][_0x229570(0x1aa)],'type':_0xaa69a[_0x229570(0x185)]}),_0x563073;},[]);}async function saveDestructiveChanges(_0x1f16ff,_0xfedef6,_0x21b0a6,_0x1888cd){const _0x4e68e5=a54_0x523d91,_0x133fdd=(await(0x0,fetch_attachments_1[_0x4e68e5(0x186)])(_0x1f16ff,_0xfedef6))[_0x4e68e5(0x164)]();await fs_internal_1['FS']['writeFile'](path_1[_0x4e68e5(0x19f)][_0x4e68e5(0x196)](process[_0x4e68e5(0x19d)](),_0x4e68e5(0x1b3),_0x1888cd,DEPLOY_DIR_NAME,_0x4e68e5(0x17f),_0x21b0a6),_0x133fdd);}async function createDeployZip(_0x170f71){const _0x19dc02=a54_0x523d91,_0x3fe724=new adm_zip_1[(_0x19dc02(0x19f))]();return await _0x3fe724[_0x19dc02(0x19c)](path_1[_0x19dc02(0x19f)]['join'](process[_0x19dc02(0x19d)](),_0x19dc02(0x1b3),_0x170f71,DEPLOY_DIR_NAME)),_0x3fe724;}function a54_0x4fc7(_0x95b2ec,_0x2fdad0){const _0x590dab=a54_0x1f26();return a54_0x4fc7=function(_0x41469f,_0x6ca29e){_0x41469f=_0x41469f-0x157;let _0x1f2691=_0x590dab[_0x41469f];return _0x1f2691;},a54_0x4fc7(_0x95b2ec,_0x2fdad0);}async function insertZip(_0x4bc5f3,_0x59cf8c,_0x316f04,_0x15a0e3,_0x202881){const _0x4ca984=a54_0x523d91,_0x35baa2={'ParentId':_0x59cf8c,'Name':_0x4ca984(0x197)+_0x316f04,'Description':'BUILD'+_0x15a0e3,'Body':_0x202881},{data:_0x428c81}=await _0x4bc5f3['post']('/services/data/'+constants_1[_0x4ca984(0x18c)]+'/sobjects/Attachment',_0x35baa2);return _0x428c81['id'];}