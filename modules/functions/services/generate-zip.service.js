const a104_0x1caec8=a104_0x59b4;(function(_0x394a24,_0x13a1d1){const _0x220a1d=a104_0x59b4,_0x278cd9=_0x394a24();while(!![]){try{const _0x24621c=parseInt(_0x220a1d(0x214))/0x1*(parseInt(_0x220a1d(0x206))/0x2)+-parseInt(_0x220a1d(0x245))/0x3*(parseInt(_0x220a1d(0x22a))/0x4)+parseInt(_0x220a1d(0x21d))/0x5+-parseInt(_0x220a1d(0x236))/0x6*(parseInt(_0x220a1d(0x1f9))/0x7)+-parseInt(_0x220a1d(0x23d))/0x8*(-parseInt(_0x220a1d(0x22f))/0x9)+-parseInt(_0x220a1d(0x1f6))/0xa+parseInt(_0x220a1d(0x20f))/0xb;if(_0x24621c===_0x13a1d1)break;else _0x278cd9['push'](_0x278cd9['shift']());}catch(_0x3bd64a){_0x278cd9['push'](_0x278cd9['shift']());}}}(a104_0x1e95,0x7840c));const a104_0x2ed1a4=(function(){let _0x1cf749=!![];return function(_0x476bba,_0x241219){const _0x518cec=_0x1cf749?function(){const _0x5212b3=a104_0x59b4;if(_0x241219){const _0x4fc383=_0x241219[_0x5212b3(0x239)](_0x476bba,arguments);return _0x241219=null,_0x4fc383;}}:function(){};return _0x1cf749=![],_0x518cec;};}()),a104_0xa98118=a104_0x2ed1a4(this,function(){const _0x4efadf=a104_0x59b4;return a104_0xa98118['toString']()[_0x4efadf(0x22d)](_0x4efadf(0x22e))['toString']()['constructor'](a104_0xa98118)[_0x4efadf(0x22d)]('(((.+)+)+)+$');});a104_0xa98118();'use strict';var __importDefault=this&&this[a104_0x1caec8(0x1f1)]||function(_0x4c7c31){const _0x528fd1=a104_0x1caec8;return _0x4c7c31&&_0x4c7c31[_0x528fd1(0x244)]?_0x4c7c31:{'default':_0x4c7c31};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a104_0x1caec8(0x1f0)]=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require(a104_0x1caec8(0x225)),logger_1=require(a104_0x1caec8(0x200)),xml2js_1=require(a104_0x1caec8(0x203)),zip_1=require(a104_0x1caec8(0x1f5)),mdapi_writer_1=require(a104_0x1caec8(0x227)),fs_internal_1=require(a104_0x1caec8(0x208)),promises_1=require(a104_0x1caec8(0x241)),components_api_1=require(a104_0x1caec8(0x210)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a104_0x1caec8(0x1ee)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a104_0x1caec8(0x20a)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x1caec8(0x1e9),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x1caec8(0x1fc),DEPLOY_DIR_NAME=a104_0x1caec8(0x1e8),PERMISSION_SET_FOLDER_NAME=a104_0x1caec8(0x201);async function generateAndDeployZip({attachmentsId:_0xf21daf,isExtractComponentsPermissionSets:_0x3c2d24,isExtractComponentsProfiles:_0x18cf23,preDestructiveAttachmentId:_0x11c36a,postDestructiveAttachmentId:_0x14621b,branchId:_0xc6f4c4,credentials:_0x4a6912,metadataLogId:_0x39106f,environments:_0x39d78a,metaTypes:_0x3cc014,apiVersion:_0x123ef5},_0xddaaf2,_0x417eb2){const _0x70982d=a104_0x1caec8;var _0x5f1ac3;const _0x5a0106=(0x0,uuid_1['v4'])();try{const _0x4edf1f=await(0x0,fetch_attachments_1[_0x70982d(0x212)])(_0xddaaf2,_0xf21daf),_0x48ea6b=_0x4edf1f[_0x70982d(0x213)]((_0xb71d48,_0x26410d)=>({..._0xb71d48,[_0x26410d['Id']]:_0x26410d[_0x70982d(0x1ed)]}),{}),_0xf020a7=await getComponents(_0x4edf1f,_0xddaaf2,_0x48ea6b),_0x392784=await components_api_1[_0x70982d(0x237)][_0x70982d(0x1fe)](_0xddaaf2,_0x4edf1f[_0x70982d(0x23b)](({ParentId:_0x3b8384})=>_0x3b8384),_0x123ef5)['then'](_0x261180=>components_api_1[_0x70982d(0x237)][_0x70982d(0x23a)](_0x261180));if(_0x18cf23){const _0x157556=_0xf020a7[_0x70982d(0x238)](({fileType:_0x3b0dcd})=>_0x3b0dcd===_0x70982d(0x218));await removePermission(_0x157556,_0x392784);}const _0x5e9cf3=_0xf020a7[_0x70982d(0x238)](({fileType:_0x83cb85})=>_0x83cb85==='PermissionSet');if(_0x5e9cf3[_0x70982d(0x224)]&&_0x3c2d24){await removePermission(_0x5e9cf3,_0x392784);const {items:_0x13e3ba}=await retrieveTargetPermissionSets(_0x5e9cf3,_0x123ef5,_0x417eb2);await mergePermissionSets(_0x5e9cf3,((_0x5f1ac3=_0x13e3ba[_0x70982d(0x22b)])===null||_0x5f1ac3===void 0x0?void 0x0:_0x5f1ac3[_0x70982d(0x229)])||[]);}await replaceEnvironments(_0x3cc014,_0x39d78a,_0xf020a7),await writeZip(_0xf020a7,_0x5a0106),await generateAndWritePackageXML(_0x4edf1f,_0x392784,_0x5a0106,_0x123ef5);_0x11c36a&&await saveDestructiveChanges(_0xddaaf2,_0x11c36a,DESTRUCTIVE_CHANGES_PER_NAME,_0x5a0106);_0x14621b&&await saveDestructiveChanges(_0xddaaf2,_0x14621b,DESTRUCTIVE_CHANGES_POST_NAME,_0x5a0106);const _0x2215ff=(await createDeployZip(_0x5a0106)[_0x70982d(0x21e)](_0x48380c=>{return _0x48380c;}))[_0x70982d(0x1fb)]()[_0x70982d(0x1f2)](_0x70982d(0x21f)),_0x393bde=_0x2215ff['length'];if(_0x393bde>=components_api_1['MAX_ZIP_SIZE']){const _0x3f2cfc=await createDeployZip(_0x5a0106),[_0x275b4c,_0x3a2347]=await components_api_1['ComponentsApi'][_0x70982d(0x247)](_0x3f2cfc,_0x393bde),_0x1b27f3=await insertZip(_0xddaaf2,_0xc6f4c4,_0x4a6912[_0x70982d(0x242)],_0x39106f,_0x275b4c[_0x70982d(0x1fb)]()[_0x70982d(0x1f2)]('base64'),_0x123ef5),_0xdc407=await insertZip(_0xddaaf2,_0xc6f4c4,_0x4a6912[_0x70982d(0x242)],_0x39106f,_0x3a2347[_0x70982d(0x1fb)]()[_0x70982d(0x1f2)](_0x70982d(0x21f)),_0x123ef5);return _0x1b27f3+','+_0xdc407;}else return await insertZip(_0xddaaf2,_0xc6f4c4,_0x4a6912[_0x70982d(0x242)],_0x39106f,_0x2215ff,_0x123ef5);}catch(_0x35995b){throw _0x35995b;}finally{if(await fs_internal_1['FS'][_0x70982d(0x202)](path_1[_0x70982d(0x215)][_0x70982d(0x211)](process[_0x70982d(0x1e7)](),_0x70982d(0x24a),_0x5a0106)))await(0x0,promises_1['rm'])(path_1[_0x70982d(0x215)]['join'](process[_0x70982d(0x1e7)](),_0x70982d(0x24a),_0x5a0106),{'recursive':!![]});}}exports[a104_0x1caec8(0x1f0)]=generateAndDeployZip;async function getComponents(_0x5ec678,_0x332cf3,_0x265bee){const _0x23221e=a104_0x1caec8,_0x18a42c=[],_0x285ae7=await(0x0,fetch_attachments_1[_0x23221e(0x223)])(_0x5ec678,_0x332cf3);return await getComponentFromZip(_0x285ae7,_0x265bee)[_0x23221e(0x21e)](_0x684e0e=>{const _0x345df6=_0x23221e;_0x18a42c[_0x345df6(0x220)](..._0x684e0e);}),_0x18a42c;}async function getComponentFromZip(_0x495e69,_0x2a227c){const _0x264eb1=a104_0x1caec8,_0x143f06=[];for(const _0x420de7 of _0x495e69){const _0x277d6b=await zip_1[_0x264eb1(0x23e)]['unzip'](_0x420de7[_0x264eb1(0x1e5)][_0x264eb1(0x20d)]);for(const _0x502ccb in _0x277d6b[_0x264eb1(0x240)]){!_0x277d6b[_0x264eb1(0x240)][_0x502ccb][_0x264eb1(0x1ff)]&&_0x143f06['push']({'fileName':_0x502ccb['substring'](_0x502ccb[_0x264eb1(0x23c)]('/')+0x1),'fileType':_0x2a227c[_0x420de7['id']],'body':_0x420de7[_0x264eb1(0x1e5)][_0x264eb1(0x20d)]});}}return _0x143f06;}async function removePermission(_0x103415,_0x444a08){const _0x59da7d=a104_0x1caec8;for(const _0x3479de of _0x103415){const _0x1f2e3b=await zip_1[_0x59da7d(0x23e)][_0x59da7d(0x21b)](_0x3479de[_0x59da7d(0x222)]),_0x1be0bc=[];for(const _0x46635e in _0x1f2e3b[_0x59da7d(0x240)]){!_0x1f2e3b[_0x59da7d(0x240)][_0x46635e][_0x59da7d(0x1ff)]&&_0x1be0bc[_0x59da7d(0x220)]({'fileName':_0x46635e,'body':await _0x1f2e3b[_0x59da7d(0x240)][_0x46635e][_0x59da7d(0x1fa)](_0x59da7d(0x24b))});}const _0x266ebe=await(0x0,extract_component_permissions_1[_0x59da7d(0x20e)])(_0x1be0bc[0x0]['body'][_0x59da7d(0x1f2)](),_0x444a08,_0x3479de[_0x59da7d(0x231)]),_0x449e08=new xml2js_1[(_0x59da7d(0x21c))]({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x2b6f90=_0x449e08[_0x59da7d(0x1f8)](_0x266ebe),_0x4c74a9=zip_1['Zip']['createZip']();_0x4c74a9[_0x59da7d(0x1fd)](_0x1be0bc[0x0][_0x59da7d(0x24c)],_0x2b6f90),_0x3479de['body']=await _0x4c74a9[_0x59da7d(0x20c)]({'type':_0x59da7d(0x21f),'compression':_0x59da7d(0x233),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x2c3416,_0xf9a43e,_0x4b56ae){const _0x2e5b56=a104_0x1caec8,_0x2fb111=_0x2c3416[_0x2e5b56(0x23b)](_0x2b406e=>PERMISSION_SET_FOLDER_NAME+'/'+_0x2b406e[_0x2e5b56(0x24c)])[_0x2e5b56(0x211)](';'),_0x2d2e0b=[{'field':'fileName','option':salesforce_1[_0x2e5b56(0x1e3)]['IN'],'value':_0x2fb111}],_0x1f4b6a=new logger_1[(_0x2e5b56(0x219))]();return new salesforce_1[(_0x2e5b56(0x1f3))](_0xf9a43e,_0x4b56ae,_0x1f4b6a,_0x2d2e0b,null,[salesforce_1[_0x2e5b56(0x1ea)][_0x2e5b56(0x23f)]])['execute']();}async function mergePermissionSets(_0xccfa5c,_0x6e8a8d){const _0x3af697=a104_0x1caec8,_0x1aede4=_0x6e8a8d[_0x3af697(0x213)]((_0x188a0f,_0x286106)=>_0x188a0f[_0x3af697(0x1ef)](_0x286106[_0x3af697(0x230)][_0x3af697(0x24c)],_0x286106),new Map());for(const _0x2e17e9 of _0xccfa5c){const _0x27a1e7=PERMISSION_SET_FOLDER_NAME+'/'+_0x2e17e9[_0x3af697(0x24c)],_0x32fad4=_0x1aede4[_0x3af697(0x1ec)](_0x27a1e7);if(!_0x32fad4)continue;const _0x4064f0=await zip_1[_0x3af697(0x23e)][_0x3af697(0x21b)](_0x2e17e9['body']),_0x6ac6d6=await _0x4064f0[_0x3af697(0x240)][_0x27a1e7][_0x3af697(0x1fa)](_0x3af697(0x24b)),_0x5b5c26=_0x32fad4['files'][_0x27a1e7]['toString'](),_0x325a36=await(0x0,extract_component_permissions_1[_0x3af697(0x234)])(_0x6ac6d6,_0x5b5c26,_0x2e17e9[_0x3af697(0x231)]),_0x4bbee2=zip_1[_0x3af697(0x23e)][_0x3af697(0x20b)]();_0x4bbee2[_0x3af697(0x1fd)](_0x27a1e7,_0x325a36),_0x2e17e9['body']=await _0x4bbee2['generateAsync']({'type':_0x3af697(0x21f),'compression':_0x3af697(0x233),'compressionOptions':{'level':0x6}});}}function a104_0x59b4(_0x23789d,_0x4c85d2){const _0x5c67d0=a104_0x1e95();return a104_0x59b4=function(_0xa98118,_0x2ed1a4){_0xa98118=_0xa98118-0x1e3;let _0x1e955c=_0x5c67d0[_0xa98118];return _0x1e955c;},a104_0x59b4(_0x23789d,_0x4c85d2);}async function replaceEnvironments(_0x38770a,_0x441b5c,_0xe1a42){const _0x5da444=a104_0x1caec8;for(const _0x37722d of _0xe1a42){if(_0x38770a[_0x5da444(0x22c)](_0x42be0c=>_0x42be0c!==_0x37722d[_0x5da444(0x231)]))continue;const _0x29d4e2=await zip_1['Zip'][_0x5da444(0x21b)](_0x37722d[_0x5da444(0x222)]);for(const _0x2dfe71 in _0x29d4e2[_0x5da444(0x240)]){if(!_0x29d4e2['files'][_0x2dfe71][_0x5da444(0x1ff)]){let _0x17a1bc=await _0x29d4e2[_0x5da444(0x240)][_0x2dfe71][_0x5da444(0x1fa)]('text');for(const _0x2f2a01 of Object[_0x5da444(0x21a)](_0x441b5c)){const _0x14cd64=new RegExp('%%'+_0x2f2a01+'%%','g');_0x17a1bc=_0x17a1bc[_0x5da444(0x248)](_0x14cd64,_0x441b5c[_0x2f2a01]);}_0x29d4e2[_0x5da444(0x1fd)](_0x2dfe71,_0x17a1bc);}}_0x37722d[_0x5da444(0x222)]=await _0x29d4e2['generateAsync']({'type':_0x5da444(0x21f),'compression':_0x5da444(0x233),'compressionOptions':{'level':0x6}});}}async function writeZip(_0xa187b7,_0x409267){const _0x25c1ef=a104_0x1caec8,_0x36e229=new mdapi_writer_1[(_0x25c1ef(0x205))]({'components':_0xa187b7,'sourceDir':path_1[_0x25c1ef(0x215)][_0x25c1ef(0x211)](process[_0x25c1ef(0x1e7)](),_0x25c1ef(0x24a),_0x409267,DEPLOY_DIR_NAME,_0x25c1ef(0x1e4)),'skipChildErrors':![]});await _0x36e229[_0x25c1ef(0x221)]();}async function generateAndWritePackageXML(_0x4c1bc7,_0x498d99,_0x2c1b55,_0x2a5233){const _0x239d7f=a104_0x1caec8,_0x32d6c3=getComponentsTypeAndName(_0x4c1bc7,_0x498d99),_0x2499b2=[...new Set(_0x32d6c3[_0x239d7f(0x23b)](_0x214d81=>_0x214d81['type']))],_0x3a60f5={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x2a5233}};for(const _0x37540b of _0x2499b2){const _0x2993b8=_0x32d6c3[_0x239d7f(0x238)](_0x1adba8=>_0x1adba8['type']===_0x37540b)[_0x239d7f(0x23b)](_0x10f3ad=>_0x10f3ad[_0x239d7f(0x249)]),_0x349ee8={'members':_0x2993b8,'name':_0x37540b};_0x3a60f5[_0x239d7f(0x217)][_0x239d7f(0x232)][_0x239d7f(0x220)](_0x349ee8);}const _0x1e6381=new xml2js_1[(_0x239d7f(0x21c))]({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x1396c1=_0x1e6381[_0x239d7f(0x1f8)](_0x3a60f5);await fs_internal_1['FS'][_0x239d7f(0x204)](path_1['default'][_0x239d7f(0x211)](process[_0x239d7f(0x1e7)](),'.temp',_0x2c1b55,DEPLOY_DIR_NAME,_0x239d7f(0x1e4),_0x239d7f(0x1f4)),_0x1396c1);}function getComponentsTypeAndName(_0x174f4b,_0x383d10){const _0x3fdacc=a104_0x1caec8;return _0x174f4b[_0x3fdacc(0x213)]((_0x3ffdd2,_0xa69c4)=>{const _0x1ab837=_0x3fdacc,_0x4ec109=_0x383d10[_0x1ab837(0x226)](_0x4da450=>_0x4da450['Id']===_0xa69c4[_0x1ab837(0x243)]);return _0x4ec109&&_0x3ffdd2[_0x1ab837(0x220)]({'name':_0x4ec109[_0x1ab837(0x1e6)][_0x1ab837(0x1eb)],'type':salesforce_1[_0x1ab837(0x246)][_0x1ab837(0x209)][_0xa69c4['Name']]||_0xa69c4[_0x1ab837(0x1ed)]}),_0x3ffdd2;},[]);}function a104_0x1e95(){const _0x1b9e79=['../utils/extract-component-permissions','find','../../git/writers/mdapi.writer','BUILD','components','76PyIUnW','PermissionSet','every','search','(((.+)+)+)+$','94671nCjiTn','listMetadataItem','fileType','types','DEFLATE','mergeComponentPermissions','/sobjects/Attachment','163752oBWTjX','ComponentsApi','filter','apply','removeNamespacePrefix','map','indexOf','424STfwin','Zip','PERMISSION_SET','files','fs/promises','orgId','ParentId','__esModule','137013AaFQXf','MetadataConstants','splitZip','replace','name','.temp','text','fileName','DeclarativeFilterOptions','src','values','Component__r','cwd','DEPLOYZIP','destructiveChangesPre.xml','MetadataType','Component_Name__c','get','Name','uuid','set','generateAndDeployZip','__importDefault','toString','PartialRetrieve','package.xml','../../git/parsers/utils/zip','3214140fKmrhW','post','buildObject','56ySYMzs','async','toBuffer','destructiveChangesPost.xml','file','fetchComponentsDetailsByComponentsHistory','dir','../classes/logger','permissionsets','exists','xml2js','writeFile','MDApiWriter','667274AbrKFW','fetchAttachmentBody','../../git/internal/fs.internal','FOLDER_TO_METADATA_TYPE_MAP','@flosum/salesforce','createZip','generateAsync','Body','extractComponentPermissions','482845bRsNww','../utils/components-api','join','fetchAttachmentsDetailsById','reduce','1HLlRfm','default','/services/data/v','Package','Profile','Logger','keys','unzip','Builder','4825080MZJlWR','then','base64','push','execute','body','retrieveAttachments','length'];a104_0x1e95=function(){return _0x1b9e79;};return a104_0x1e95();}async function saveDestructiveChanges(_0x2eb040,_0x2bea6f,_0x24de25,_0x17c8c2){const _0x3b8bfb=a104_0x1caec8,_0x50d5cf=(await(0x0,fetch_attachments_1[_0x3b8bfb(0x207)])(_0x2eb040,_0x2bea6f))[_0x3b8bfb(0x1f2)]();await fs_internal_1['FS'][_0x3b8bfb(0x204)](path_1[_0x3b8bfb(0x215)][_0x3b8bfb(0x211)](process[_0x3b8bfb(0x1e7)](),'.temp',_0x17c8c2,DEPLOY_DIR_NAME,_0x3b8bfb(0x1e4),_0x24de25),_0x50d5cf);}async function createDeployZip(_0x4c18c0){const _0x2f13a5=a104_0x1caec8,_0xe78cf=new adm_zip_1[(_0x2f13a5(0x215))]();return await _0xe78cf['addLocalFolder'](path_1[_0x2f13a5(0x215)][_0x2f13a5(0x211)](process['cwd'](),_0x2f13a5(0x24a),_0x4c18c0,DEPLOY_DIR_NAME)),_0xe78cf;}async function insertZip(_0x241fb9,_0x558f31,_0x580d39,_0x4bc28a,_0x6158ff,_0x21b3d7){const _0x43f15b=a104_0x1caec8,_0x389b06={'ParentId':_0x558f31,'Name':'BUILD'+_0x580d39,'Description':_0x43f15b(0x228)+_0x4bc28a,'Body':_0x6158ff},{data:_0xec545c}=await _0x241fb9[_0x43f15b(0x1f7)](_0x43f15b(0x216)+_0x21b3d7+_0x43f15b(0x235),_0x389b06);return _0xec545c['id'];}