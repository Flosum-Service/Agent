const a102_0x1938b2=a102_0x4082;(function(_0xdca8e,_0x37bbc2){const _0x442b4b=a102_0x4082,_0x2bcbb2=_0xdca8e();while(!![]){try{const _0x152365=parseInt(_0x442b4b(0x171))/0x1*(-parseInt(_0x442b4b(0x172))/0x2)+-parseInt(_0x442b4b(0x1b4))/0x3*(parseInt(_0x442b4b(0x165))/0x4)+-parseInt(_0x442b4b(0x164))/0x5*(-parseInt(_0x442b4b(0x1a8))/0x6)+-parseInt(_0x442b4b(0x175))/0x7*(parseInt(_0x442b4b(0x16d))/0x8)+parseInt(_0x442b4b(0x15e))/0x9+parseInt(_0x442b4b(0x1b3))/0xa*(-parseInt(_0x442b4b(0x1a6))/0xb)+parseInt(_0x442b4b(0x18a))/0xc;if(_0x152365===_0x37bbc2)break;else _0x2bcbb2['push'](_0x2bcbb2['shift']());}catch(_0x17821d){_0x2bcbb2['push'](_0x2bcbb2['shift']());}}}(a102_0x58c0,0xc2b4e));const a102_0x25dfff=(function(){let _0x338667=!![];return function(_0x480c35,_0x166a49){const _0x28816f=_0x338667?function(){if(_0x166a49){const _0x2d160b=_0x166a49['apply'](_0x480c35,arguments);return _0x166a49=null,_0x2d160b;}}:function(){};return _0x338667=![],_0x28816f;};}()),a102_0x3387fa=a102_0x25dfff(this,function(){const _0x43fffa=a102_0x4082;return a102_0x3387fa[_0x43fffa(0x1a3)]()['search']('(((.+)+)+)+$')['toString']()[_0x43fffa(0x167)](a102_0x3387fa)[_0x43fffa(0x17a)](_0x43fffa(0x184));});a102_0x3387fa();'use strict';function a102_0x4082(_0x2a0b02,_0x1220fa){const _0x247986=a102_0x58c0();return a102_0x4082=function(_0x3387fa,_0x25dfff){_0x3387fa=_0x3387fa-0x14f;let _0x58c0a4=_0x247986[_0x3387fa];return _0x58c0a4;},a102_0x4082(_0x2a0b02,_0x1220fa);}var __importDefault=this&&this['__importDefault']||function(_0x5254ea){const _0x28763e=a102_0x4082;return _0x5254ea&&_0x5254ea[_0x28763e(0x18f)]?_0x5254ea:{'default':_0x5254ea};};Object[a102_0x1938b2(0x1aa)](exports,a102_0x1938b2(0x18f),{'value':!![]}),exports[a102_0x1938b2(0x170)]=void 0x0;const path_1=__importDefault(require(a102_0x1938b2(0x187))),extract_component_permissions_1=require(a102_0x1938b2(0x16c)),logger_1=require(a102_0x1938b2(0x198)),xml2js_1=require(a102_0x1938b2(0x1ae)),zip_1=require(a102_0x1938b2(0x197)),mdapi_writer_1=require(a102_0x1938b2(0x15f)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require('fs/promises'),components_api_1=require(a102_0x1938b2(0x1b0)),adm_zip_1=__importDefault(require(a102_0x1938b2(0x168))),uuid_1=require('uuid'),fetch_attachments_1=require(a102_0x1938b2(0x189)),salesforce_1=require(a102_0x1938b2(0x188)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a102_0x1938b2(0x1a2),DEPLOY_DIR_NAME=a102_0x1938b2(0x153),PERMISSION_SET_FOLDER_NAME=a102_0x1938b2(0x180);async function generateAndDeployZip({attachmentsId:_0x29b816,isExtractComponentsPermissionSets:_0x5ab812,isExtractComponentsProfiles:_0x305f87,preDestructiveAttachmentId:_0x22e764,postDestructiveAttachmentId:_0x235716,branchId:_0x448fd7,credentials:_0x1a8e62,metadataLogId:_0x3c8a78,environments:_0x4c49f0,metaTypes:_0x109693,apiVersion:_0x495dca},_0x4eb5de,_0x5ccbda){const _0x30500d=a102_0x1938b2;var _0x283738;const _0x3777cd=(0x0,uuid_1['v4'])();try{const _0x9596e9=await(0x0,fetch_attachments_1[_0x30500d(0x1af)])(_0x4eb5de,_0x29b816),_0xd7545f=_0x9596e9[_0x30500d(0x192)]((_0x42aecf,_0x2c37c0)=>({..._0x42aecf,[_0x2c37c0['Id']]:_0x2c37c0[_0x30500d(0x186)]}),{}),_0x4d9463=await getComponents(_0x9596e9,_0x4eb5de,_0xd7545f),_0x37bdca=await components_api_1[_0x30500d(0x1ab)][_0x30500d(0x1b1)](_0x4eb5de,_0x9596e9['map'](({ParentId:_0x1d087c})=>_0x1d087c),_0x495dca)[_0x30500d(0x169)](_0x5d0cc0=>components_api_1[_0x30500d(0x1ab)][_0x30500d(0x185)](_0x5d0cc0));if(_0x305f87){const _0x2f94e8=_0x4d9463[_0x30500d(0x151)](({fileType:_0x17057d})=>_0x17057d===_0x30500d(0x162));await removePermission(_0x2f94e8,_0x37bdca);}const _0x21fd38=_0x4d9463[_0x30500d(0x151)](({fileType:_0x961eee})=>_0x961eee===_0x30500d(0x14f));if(_0x21fd38['length']&&_0x5ab812){await removePermission(_0x21fd38,_0x37bdca);const {items:_0x4ed705}=await retrieveTargetPermissionSets(_0x21fd38,_0x495dca,_0x5ccbda);await mergePermissionSets(_0x21fd38,((_0x283738=_0x4ed705[_0x30500d(0x14f)])===null||_0x283738===void 0x0?void 0x0:_0x283738[_0x30500d(0x1b2)])||[]);}await replaceEnvironments(_0x109693,_0x4c49f0,_0x4d9463),await writeZip(_0x4d9463,_0x3777cd),await generateAndWritePackageXML(_0x9596e9,_0x37bdca,_0x3777cd,_0x495dca);_0x22e764&&await saveDestructiveChanges(_0x4eb5de,_0x22e764,DESTRUCTIVE_CHANGES_PER_NAME,_0x3777cd);_0x235716&&await saveDestructiveChanges(_0x4eb5de,_0x235716,DESTRUCTIVE_CHANGES_POST_NAME,_0x3777cd);const _0x30df2d=(await createDeployZip(_0x3777cd)[_0x30500d(0x169)](_0x552eab=>{return _0x552eab;}))[_0x30500d(0x17f)]()[_0x30500d(0x1a3)](_0x30500d(0x183)),_0x5e3acf=_0x30df2d[_0x30500d(0x182)];if(_0x5e3acf>=components_api_1['MAX_ZIP_SIZE']){const _0x3d18f7=await createDeployZip(_0x3777cd),[_0xbc40a2,_0xa81594]=await components_api_1[_0x30500d(0x1ab)]['splitZip'](_0x3d18f7,_0x5e3acf),_0x169ece=await insertZip(_0x4eb5de,_0x448fd7,_0x1a8e62[_0x30500d(0x181)],_0x3c8a78,_0xbc40a2['toBuffer']()[_0x30500d(0x1a3)](_0x30500d(0x183)),_0x495dca),_0x3b879d=await insertZip(_0x4eb5de,_0x448fd7,_0x1a8e62[_0x30500d(0x181)],_0x3c8a78,_0xa81594['toBuffer']()[_0x30500d(0x1a3)]('base64'),_0x495dca);return _0x169ece+','+_0x3b879d;}else return await insertZip(_0x4eb5de,_0x448fd7,_0x1a8e62['orgId'],_0x3c8a78,_0x30df2d,_0x495dca);}catch(_0x13292b){throw _0x13292b;}finally{if(await fs_internal_1['FS'][_0x30500d(0x196)](path_1[_0x30500d(0x19b)]['join'](process[_0x30500d(0x193)](),_0x30500d(0x19a),_0x3777cd)))await(0x0,promises_1['rm'])(path_1[_0x30500d(0x19b)][_0x30500d(0x1b5)](process[_0x30500d(0x193)](),_0x30500d(0x19a),_0x3777cd),{'recursive':!![]});}}exports[a102_0x1938b2(0x170)]=generateAndDeployZip;async function getComponents(_0x2efee0,_0x550ca9,_0x4f13a8){const _0x56076c=a102_0x1938b2,_0x212110=[],_0x2dd820=await(0x0,fetch_attachments_1[_0x56076c(0x191)])(_0x2efee0,_0x550ca9);return await getComponentFromZip(_0x2dd820,_0x4f13a8)['then'](_0x9b4310=>{const _0xc060bf=_0x56076c;_0x212110[_0xc060bf(0x1a4)](..._0x9b4310);}),_0x212110;}function a102_0x58c0(){const _0x2b6473=['get','map','createZip','FOLDER_TO_METADATA_TYPE_MAP','mergeComponentPermissions','destructiveChangesPost.xml','toString','push','addLocalFolder','125301BsBshh','unzip','894IxfuDH','fileType','defineProperty','ComponentsApi','PERMISSION_SET','body','xml2js','fetchAttachmentsDetailsById','../utils/components-api','fetchComponentsDetailsByComponentsHistory','components','510AGtGPF','9TUJAly','join','PermissionSet','text','filter','UTF-8','DEPLOYZIP','fileName','async','types','Zip','PartialRetrieve','ParentId','writeFile','/sobjects/Attachment','values','/services/data/v','10011150BKHTma','../../git/writers/mdapi.writer','package.xml','DeclarativeFilterOptions','Profile','buildObject','105bFDWih','978532kYShHK','Component__r','constructor','adm-zip','then','generateAsync','file','../utils/extract-component-permissions','16VtmHDD','every','DEFLATE','generateAndDeployZip','46GuRWIX','10632oEUcVQ','dir','fetchAttachmentBody','3917858ZNaDbs','set','http://soap.sforce.com/2006/04/metadata','Component_Name__c','find','search','post','MDApiWriter','Builder','BUILD','toBuffer','permissionsets','orgId','length','base64','(((.+)+)+)+$','removeNamespacePrefix','Name','path','@flosum/salesforce','../../shared/utils/fetch-attachments','28329636ooQeBs','MetadataConstants','files','name','indexOf','__esModule','listMetadataItem','retrieveAttachments','reduce','cwd','type','substring','exists','../../git/parsers/utils/zip','../classes/logger','execute','.temp','default','src'];a102_0x58c0=function(){return _0x2b6473;};return a102_0x58c0();}async function getComponentFromZip(_0x221de8,_0xaf0cf6){const _0x43620e=a102_0x1938b2,_0x5d4118=[];for(const _0x518b94 of _0x221de8){const _0x2cf1d8=await zip_1['Zip'][_0x43620e(0x1a7)](_0x518b94[_0x43620e(0x15c)]['Body']);for(const _0x3aa2c7 in _0x2cf1d8[_0x43620e(0x18c)]){!_0x2cf1d8[_0x43620e(0x18c)][_0x3aa2c7][_0x43620e(0x173)]&&_0x5d4118[_0x43620e(0x1a4)]({'fileName':_0x3aa2c7[_0x43620e(0x195)](_0x3aa2c7[_0x43620e(0x18e)]('/')+0x1),'fileType':_0xaf0cf6[_0x518b94['id']],'body':_0x518b94[_0x43620e(0x15c)]['Body']});}}return _0x5d4118;}async function removePermission(_0xa00cac,_0x191a23){const _0x5bd02c=a102_0x1938b2;for(const _0x56ff7f of _0xa00cac){const _0x198e92=await zip_1[_0x5bd02c(0x157)][_0x5bd02c(0x1a7)](_0x56ff7f[_0x5bd02c(0x1ad)]),_0xf408ab=[];for(const _0x439626 in _0x198e92[_0x5bd02c(0x18c)]){!_0x198e92[_0x5bd02c(0x18c)][_0x439626]['dir']&&_0xf408ab[_0x5bd02c(0x1a4)]({'fileName':_0x439626,'body':await _0x198e92['files'][_0x439626][_0x5bd02c(0x155)](_0x5bd02c(0x150))});}const _0x9c50b4=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0xf408ab[0x0]['body'][_0x5bd02c(0x1a3)](),_0x191a23,_0x56ff7f[_0x5bd02c(0x1a9)]),_0x5074c9=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':_0x5bd02c(0x152)}}),_0x419a7a=_0x5074c9[_0x5bd02c(0x163)](_0x9c50b4),_0xcc501b=zip_1[_0x5bd02c(0x157)][_0x5bd02c(0x19f)]();_0xcc501b[_0x5bd02c(0x16b)](_0xf408ab[0x0][_0x5bd02c(0x154)],_0x419a7a),_0x56ff7f['body']=await _0xcc501b[_0x5bd02c(0x16a)]({'type':_0x5bd02c(0x183),'compression':_0x5bd02c(0x16f),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x42501a,_0x269073,_0x4972f7){const _0x264b54=a102_0x1938b2,_0x802699=_0x42501a[_0x264b54(0x19e)](_0x3b920d=>PERMISSION_SET_FOLDER_NAME+'/'+_0x3b920d[_0x264b54(0x154)])['join'](';'),_0x230109=[{'field':_0x264b54(0x154),'option':salesforce_1[_0x264b54(0x161)]['IN'],'value':_0x802699}],_0x4d663b=new logger_1['Logger']();return new salesforce_1[(_0x264b54(0x158))](_0x269073,_0x4972f7,_0x4d663b,_0x230109,null,[salesforce_1['MetadataType'][_0x264b54(0x1ac)]])[_0x264b54(0x199)]();}async function mergePermissionSets(_0x54fe30,_0x2b8a89){const _0x1e1a00=a102_0x1938b2,_0x59e820=_0x2b8a89[_0x1e1a00(0x192)]((_0x9390ce,_0x3cecaf)=>_0x9390ce[_0x1e1a00(0x176)](_0x3cecaf[_0x1e1a00(0x190)][_0x1e1a00(0x154)],_0x3cecaf),new Map());for(const _0x394b5a of _0x54fe30){const _0x31823c=PERMISSION_SET_FOLDER_NAME+'/'+_0x394b5a[_0x1e1a00(0x154)],_0x608b2c=_0x59e820[_0x1e1a00(0x19d)](_0x31823c);if(!_0x608b2c)continue;const _0x5b58da=await zip_1[_0x1e1a00(0x157)][_0x1e1a00(0x1a7)](_0x394b5a[_0x1e1a00(0x1ad)]),_0x1802ff=await _0x5b58da[_0x1e1a00(0x18c)][_0x31823c]['async'](_0x1e1a00(0x150)),_0xd1d800=_0x608b2c[_0x1e1a00(0x18c)][_0x31823c][_0x1e1a00(0x1a3)](),_0x2c1709=await(0x0,extract_component_permissions_1[_0x1e1a00(0x1a1)])(_0x1802ff,_0xd1d800,_0x394b5a[_0x1e1a00(0x1a9)]),_0x4acb51=zip_1[_0x1e1a00(0x157)][_0x1e1a00(0x19f)]();_0x4acb51[_0x1e1a00(0x16b)](_0x31823c,_0x2c1709),_0x394b5a[_0x1e1a00(0x1ad)]=await _0x4acb51[_0x1e1a00(0x16a)]({'type':_0x1e1a00(0x183),'compression':_0x1e1a00(0x16f),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x31cd8f,_0x53af63,_0x51a1f1){const _0x4fc4df=a102_0x1938b2;for(const _0x350fd8 of _0x51a1f1){if(_0x31cd8f[_0x4fc4df(0x16e)](_0x57463e=>_0x57463e!==_0x350fd8[_0x4fc4df(0x1a9)]))continue;const _0x545583=await zip_1[_0x4fc4df(0x157)]['unzip'](_0x350fd8[_0x4fc4df(0x1ad)]);for(const _0x4e2da5 in _0x545583[_0x4fc4df(0x18c)]){if(!_0x545583['files'][_0x4e2da5]['dir']){let _0x46a611=await _0x545583['files'][_0x4e2da5][_0x4fc4df(0x155)](_0x4fc4df(0x150));for(const _0x2844e3 of Object['keys'](_0x53af63)){const _0x44b3c2=new RegExp('%%'+_0x2844e3+'%%','g');_0x46a611=_0x46a611['replace'](_0x44b3c2,_0x53af63[_0x2844e3]);}_0x545583['file'](_0x4e2da5,_0x46a611);}}_0x350fd8[_0x4fc4df(0x1ad)]=await _0x545583[_0x4fc4df(0x16a)]({'type':'base64','compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x7257fc,_0x1b78ba){const _0x16335=a102_0x1938b2,_0x258f11=new mdapi_writer_1[(_0x16335(0x17c))]({'components':_0x7257fc,'sourceDir':path_1[_0x16335(0x19b)][_0x16335(0x1b5)](process[_0x16335(0x193)](),'.temp',_0x1b78ba,DEPLOY_DIR_NAME,_0x16335(0x19c)),'skipChildErrors':![]});await _0x258f11[_0x16335(0x199)]();}async function generateAndWritePackageXML(_0x10dbe9,_0x596474,_0x22b865,_0xb62990){const _0x503e74=a102_0x1938b2,_0x33b72c=getComponentsTypeAndName(_0x10dbe9,_0x596474),_0xd07551=[...new Set(_0x33b72c[_0x503e74(0x19e)](_0x301430=>_0x301430[_0x503e74(0x194)]))],_0x302e3f={'Package':{'$':{'xmlns':_0x503e74(0x177)},'types':[],'version':''+_0xb62990}};for(const _0x399447 of _0xd07551){const _0x4852a7=_0x33b72c[_0x503e74(0x151)](_0x3dfe33=>_0x3dfe33['type']===_0x399447)[_0x503e74(0x19e)](_0x2d9ae2=>_0x2d9ae2[_0x503e74(0x18d)]),_0x134a3e={'members':_0x4852a7,'name':_0x399447};_0x302e3f['Package'][_0x503e74(0x156)]['push'](_0x134a3e);}const _0x1751ef=new xml2js_1[(_0x503e74(0x17d))]({'xmldec':{'version':'1.0','encoding':_0x503e74(0x152)}}),_0x555e07=_0x1751ef[_0x503e74(0x163)](_0x302e3f);await fs_internal_1['FS'][_0x503e74(0x15a)](path_1[_0x503e74(0x19b)][_0x503e74(0x1b5)](process[_0x503e74(0x193)](),_0x503e74(0x19a),_0x22b865,DEPLOY_DIR_NAME,_0x503e74(0x19c),_0x503e74(0x160)),_0x555e07);}function getComponentsTypeAndName(_0x526efc,_0x2ec353){return _0x526efc['reduce']((_0x51c933,_0x570c18)=>{const _0x5768c3=a102_0x4082,_0x4befbb=_0x2ec353[_0x5768c3(0x179)](_0x4d8712=>_0x4d8712['Id']===_0x570c18[_0x5768c3(0x159)]);return _0x4befbb&&_0x51c933[_0x5768c3(0x1a4)]({'name':_0x4befbb[_0x5768c3(0x166)][_0x5768c3(0x178)],'type':salesforce_1[_0x5768c3(0x18b)][_0x5768c3(0x1a0)][_0x570c18[_0x5768c3(0x186)]]||_0x570c18[_0x5768c3(0x186)]}),_0x51c933;},[]);}async function saveDestructiveChanges(_0x3d1454,_0x76f20e,_0xf96d5,_0x120eb2){const _0x2b7c0e=a102_0x1938b2,_0x35a5c3=(await(0x0,fetch_attachments_1[_0x2b7c0e(0x174)])(_0x3d1454,_0x76f20e))['toString']();await fs_internal_1['FS'][_0x2b7c0e(0x15a)](path_1['default'][_0x2b7c0e(0x1b5)](process[_0x2b7c0e(0x193)](),_0x2b7c0e(0x19a),_0x120eb2,DEPLOY_DIR_NAME,_0x2b7c0e(0x19c),_0xf96d5),_0x35a5c3);}async function createDeployZip(_0x40fa0e){const _0x413678=a102_0x1938b2,_0x424ec5=new adm_zip_1['default']();return await _0x424ec5[_0x413678(0x1a5)](path_1[_0x413678(0x19b)][_0x413678(0x1b5)](process[_0x413678(0x193)](),'.temp',_0x40fa0e,DEPLOY_DIR_NAME)),_0x424ec5;}async function insertZip(_0x342bac,_0xf8aaf2,_0x36cb4d,_0x5b8b0f,_0x562cb9,_0x52c2b9){const _0x411a76=a102_0x1938b2,_0x1717f2={'ParentId':_0xf8aaf2,'Name':_0x411a76(0x17e)+_0x36cb4d,'Description':_0x411a76(0x17e)+_0x5b8b0f,'Body':_0x562cb9},{data:_0x31808f}=await _0x342bac[_0x411a76(0x17b)](_0x411a76(0x15d)+_0x52c2b9+_0x411a76(0x15b),_0x1717f2);return _0x31808f['id'];}