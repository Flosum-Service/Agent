const a102_0x50f63b=a102_0x10a2;function a102_0x1d98(){const _0x3e617a=['2HxuiDi','find','type','xml2js','__esModule','adm-zip','buildObject','values','search','Component__r','toBuffer','default','unzip','990460hIYFcM','fetchAttachmentBody','@flosum/salesforce','createZip','../utils/extract-component-permissions','splitZip','.temp','/sobjects/Attachment','fs/promises','extractComponentPermissions','Body','defineProperty','DEPLOYZIP','1566768eaxTTv','exists','destructiveChangesPre.xml','../utils/components-api','dir','BUILD','35157518NQAuKi','addLocalFolder','join','post','text','143405GtRCEn','generateAsync','files','1261578QGjWer','756164jWMgzI','Component_Name__c','fetchComponentsDetailsByComponentsHistory','http://soap.sforce.com/2006/04/metadata','28FMzpxB','keys','indexOf','UTF-8','generateAndDeployZip','filter','map','path','push','ParentId','then','4556136xxFmiE','substring','types','__importDefault','/services/data/v','../../git/writers/mdapi.writer','1.0','src','ComponentsApi','orgId','Builder','name','Zip','toString','reduce','removeNamespacePrefix','(((.+)+)+)+$','54HJGRxv','DEFLATE','MAX_ZIP_SIZE','async','Name','every','68tnMmTZ','cwd','uuid','fetchAttachmentsDetailsById','package.xml','base64','fileType','body'];a102_0x1d98=function(){return _0x3e617a;};return a102_0x1d98();}(function(_0x20eb1b,_0x24e073){const _0x33327c=a102_0x10a2,_0x4c58fe=_0x20eb1b();while(!![]){try{const _0x1e46e7=parseInt(_0x33327c(0xe5))/0x1*(parseInt(_0x33327c(0xb7))/0x2)+parseInt(_0x33327c(0xa8))/0x3+parseInt(_0x33327c(0xdd))/0x4*(parseInt(_0x33327c(0xb3))/0x5)+parseInt(_0x33327c(0xb6))/0x6*(parseInt(_0x33327c(0xbb))/0x7)+parseInt(_0x33327c(0xc6))/0x8+-parseInt(_0x33327c(0xd7))/0x9*(-parseInt(_0x33327c(0x9b))/0xa)+-parseInt(_0x33327c(0xae))/0xb;if(_0x1e46e7===_0x24e073)break;else _0x4c58fe['push'](_0x4c58fe['shift']());}catch(_0x3f6681){_0x4c58fe['push'](_0x4c58fe['shift']());}}}(a102_0x1d98,0x8c4f0));const a102_0x1c6b2b=(function(){let _0x384a3d=!![];return function(_0x5a6149,_0x1fa52c){const _0x416ba6=_0x384a3d?function(){if(_0x1fa52c){const _0x49c3b5=_0x1fa52c['apply'](_0x5a6149,arguments);return _0x1fa52c=null,_0x49c3b5;}}:function(){};return _0x384a3d=![],_0x416ba6;};}()),a102_0x502390=a102_0x1c6b2b(this,function(){const _0x4a3fa6=a102_0x10a2;return a102_0x502390[_0x4a3fa6(0xd3)]()[_0x4a3fa6(0xed)](_0x4a3fa6(0xd6))[_0x4a3fa6(0xd3)]()['constructor'](a102_0x502390)['search'](_0x4a3fa6(0xd6));});a102_0x502390();'use strict';var __importDefault=this&&this[a102_0x50f63b(0xc9)]||function(_0x4d1c43){const _0x1f412a=a102_0x50f63b;return _0x4d1c43&&_0x4d1c43[_0x1f412a(0xe9)]?_0x4d1c43:{'default':_0x4d1c43};};Object[a102_0x50f63b(0xa6)](exports,a102_0x50f63b(0xe9),{'value':!![]}),exports[a102_0x50f63b(0xbf)]=void 0x0;function a102_0x10a2(_0x34ce66,_0xd29890){const _0x12229a=a102_0x1d98();return a102_0x10a2=function(_0x502390,_0x1c6b2b){_0x502390=_0x502390-0x9b;let _0x1d98d3=_0x12229a[_0x502390];return _0x1d98d3;},a102_0x10a2(_0x34ce66,_0xd29890);}const path_1=__importDefault(require(a102_0x50f63b(0xc2))),extract_component_permissions_1=require(a102_0x50f63b(0x9f)),xml2js_1=require(a102_0x50f63b(0xe8)),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require(a102_0x50f63b(0xcb)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a102_0x50f63b(0xa3)),components_api_1=require(a102_0x50f63b(0xab)),adm_zip_1=__importDefault(require(a102_0x50f63b(0xea))),uuid_1=require(a102_0x50f63b(0xdf)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a102_0x50f63b(0x9d)),DESTRUCTIVE_CHANGES_PER_NAME=a102_0x50f63b(0xaa),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a102_0x50f63b(0xa7);async function generateAndDeployZip({attachmentsId:_0x11e3ce,isExtractComponentsPermissions:_0x6245df,preDestructiveAttachmentId:_0x397732,postDestructiveAttachmentId:_0x4e5dbf,branchId:_0x2962f3,credentials:_0x3e786e,metadataLogId:_0x17567c,environments:_0x3cfffb,metaTypes:_0x281c0d,apiVersion:_0xd728d6},_0x4400cf){const _0x5177ec=a102_0x50f63b,_0xd0f715=(0x0,uuid_1['v4'])();try{const _0x252411=await(0x0,fetch_attachments_1[_0x5177ec(0xe0)])(_0x4400cf,_0x11e3ce),_0x1325db=_0x252411[_0x5177ec(0xd4)]((_0xbf7b20,_0x4db59e)=>({..._0xbf7b20,[_0x4db59e['Id']]:_0x4db59e[_0x5177ec(0xdb)]}),{}),_0x3ab9eb=await getComponents(_0x252411,_0x4400cf,_0x1325db),_0x522434=await components_api_1['ComponentsApi'][_0x5177ec(0xb9)](_0x4400cf,_0x252411[_0x5177ec(0xc1)](({ParentId:_0x21b0b8})=>_0x21b0b8),_0xd728d6)[_0x5177ec(0xc5)](_0x1068c3=>components_api_1[_0x5177ec(0xce)][_0x5177ec(0xd5)](_0x1068c3));if(_0x6245df){const _0x291422=_0x3ab9eb[_0x5177ec(0xc0)](({fileType:_0x444157})=>_0x444157==='Profile');await removePermission(_0x291422,_0x522434);}await replaceEnvironments(_0x281c0d,_0x3cfffb,_0x3ab9eb),await writeZip(_0x3ab9eb,_0xd0f715),await generateAndWritePackageXML(_0x252411,_0x522434,_0xd0f715,_0xd728d6);_0x397732&&await saveDestructiveChanges(_0x4400cf,_0x397732,DESTRUCTIVE_CHANGES_PER_NAME,_0xd0f715);_0x4e5dbf&&await saveDestructiveChanges(_0x4400cf,_0x4e5dbf,DESTRUCTIVE_CHANGES_POST_NAME,_0xd0f715);const _0x52be0a=(await createDeployZip(_0xd0f715)['then'](_0x3e256f=>{return _0x3e256f;}))['toBuffer']()[_0x5177ec(0xd3)](_0x5177ec(0xe2)),_0x5ab2c0=_0x52be0a['length'];if(_0x5ab2c0>=components_api_1[_0x5177ec(0xd9)]){const _0x177a86=await createDeployZip(_0xd0f715),[_0x36cfcd,_0x2f158d]=await components_api_1[_0x5177ec(0xce)][_0x5177ec(0xa0)](_0x177a86,_0x5ab2c0),_0x3966e5=await insertZip(_0x4400cf,_0x2962f3,_0x3e786e[_0x5177ec(0xcf)],_0x17567c,_0x36cfcd['toBuffer']()[_0x5177ec(0xd3)](_0x5177ec(0xe2)),_0xd728d6),_0x57f3e6=await insertZip(_0x4400cf,_0x2962f3,_0x3e786e[_0x5177ec(0xcf)],_0x17567c,_0x2f158d[_0x5177ec(0xef)]()['toString']('base64'),_0xd728d6);return _0x3966e5+','+_0x57f3e6;}else return await insertZip(_0x4400cf,_0x2962f3,_0x3e786e[_0x5177ec(0xcf)],_0x17567c,_0x52be0a,_0xd728d6);}catch(_0x152695){throw _0x152695;}finally{if(await fs_internal_1['FS'][_0x5177ec(0xa9)](path_1[_0x5177ec(0xf0)]['join'](process[_0x5177ec(0xde)](),'.temp',_0xd0f715)))await(0x0,promises_1['rm'])(path_1[_0x5177ec(0xf0)][_0x5177ec(0xb0)](process['cwd'](),'.temp',_0xd0f715),{'recursive':!![]});}}exports[a102_0x50f63b(0xbf)]=generateAndDeployZip;async function getComponents(_0x20a5a8,_0x4c3268,_0x52f3bf){const _0x2ee267=a102_0x50f63b,_0x121a2d=[],_0x53a479=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x20a5a8,_0x4c3268);return await getComponentFromZip(_0x53a479,_0x52f3bf)[_0x2ee267(0xc5)](_0x2c5f53=>{_0x121a2d['push'](..._0x2c5f53);}),_0x121a2d;}async function getComponentFromZip(_0x10dd69,_0x138134){const _0x451a62=a102_0x50f63b,_0xe9a0e=[];for(const _0x3ce50d of _0x10dd69){const _0x50f872=await zip_1[_0x451a62(0xd2)][_0x451a62(0xf1)](_0x3ce50d[_0x451a62(0xec)][_0x451a62(0xa5)]);for(const _0x2ac322 in _0x50f872[_0x451a62(0xb5)]){!_0x50f872[_0x451a62(0xb5)][_0x2ac322][_0x451a62(0xac)]&&_0xe9a0e[_0x451a62(0xc3)]({'fileName':_0x2ac322[_0x451a62(0xc7)](_0x2ac322[_0x451a62(0xbd)]('/')+0x1),'fileType':_0x138134[_0x3ce50d['id']],'body':_0x3ce50d['values'][_0x451a62(0xa5)]});}}return _0xe9a0e;}async function removePermission(_0x4ffcae,_0x160541){const _0x8ef482=a102_0x50f63b;for(const _0xdb3a6b of _0x4ffcae){const _0x5161e8=await zip_1[_0x8ef482(0xd2)][_0x8ef482(0xf1)](_0xdb3a6b['body']),_0x4d9ec3=[];for(const _0x262952 in _0x5161e8[_0x8ef482(0xb5)]){!_0x5161e8['files'][_0x262952][_0x8ef482(0xac)]&&_0x4d9ec3[_0x8ef482(0xc3)]({'fileName':_0x262952,'body':await _0x5161e8[_0x8ef482(0xb5)][_0x262952][_0x8ef482(0xda)]('text')});}const _0x11c791=await(0x0,extract_component_permissions_1[_0x8ef482(0xa4)])(_0x4d9ec3[0x0][_0x8ef482(0xe4)]['toString'](),_0x160541,_0xdb3a6b[_0x8ef482(0xe3)]),_0xdfd805=new xml2js_1['Builder']({'xmldec':{'version':_0x8ef482(0xcc),'encoding':_0x8ef482(0xbe)}}),_0x3c0186=_0xdfd805['buildObject'](_0x11c791),_0x3d9dde=zip_1['Zip'][_0x8ef482(0x9e)]();_0x3d9dde['file'](_0x4d9ec3[0x0]['fileName'],_0x3c0186),_0xdb3a6b[_0x8ef482(0xe4)]=await _0x3d9dde[_0x8ef482(0xb4)]({'type':_0x8ef482(0xe2),'compression':_0x8ef482(0xd8),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x48caa2,_0x49a810,_0x28d566){const _0x31aa22=a102_0x50f63b;for(const _0x344ac8 of _0x28d566){if(_0x48caa2[_0x31aa22(0xdc)](_0x208fc6=>_0x208fc6!==_0x344ac8['fileType']))continue;const _0x179ef2=await zip_1[_0x31aa22(0xd2)][_0x31aa22(0xf1)](_0x344ac8[_0x31aa22(0xe4)]);for(const _0x3688b0 in _0x179ef2['files']){if(!_0x179ef2['files'][_0x3688b0][_0x31aa22(0xac)]){let _0x287206=await _0x179ef2['files'][_0x3688b0]['async'](_0x31aa22(0xb2));for(const _0x58cbce of Object[_0x31aa22(0xbc)](_0x49a810)){const _0x4b376f=new RegExp('%%'+_0x58cbce+'%%','g');_0x287206=_0x287206['replace'](_0x4b376f,_0x49a810[_0x58cbce]);}_0x179ef2['file'](_0x3688b0,_0x287206);}}_0x344ac8[_0x31aa22(0xe4)]=await _0x179ef2[_0x31aa22(0xb4)]({'type':_0x31aa22(0xe2),'compression':_0x31aa22(0xd8),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x288a59,_0x39b722){const _0x14a061=a102_0x50f63b,_0x5053ef=new mdapi_writer_1['MDApiWriter']({'components':_0x288a59,'sourceDir':path_1[_0x14a061(0xf0)][_0x14a061(0xb0)](process['cwd'](),_0x14a061(0xa1),_0x39b722,DEPLOY_DIR_NAME,_0x14a061(0xcd)),'skipChildErrors':![]});await _0x5053ef['execute']();}async function generateAndWritePackageXML(_0x38feb5,_0x485152,_0x56e82e,_0x25eb8f){const _0x4143e7=a102_0x50f63b,_0xa71200=getComponentsTypeAndName(_0x38feb5,_0x485152),_0x29d020=[...new Set(_0xa71200[_0x4143e7(0xc1)](_0x5038e3=>_0x5038e3[_0x4143e7(0xe7)]))],_0x1be552={'Package':{'$':{'xmlns':_0x4143e7(0xba)},'types':[],'version':''+_0x25eb8f}};for(const _0x54f9f9 of _0x29d020){const _0x1987d1=_0xa71200['filter'](_0x2cdbf1=>_0x2cdbf1[_0x4143e7(0xe7)]===_0x54f9f9)[_0x4143e7(0xc1)](_0x30b341=>_0x30b341[_0x4143e7(0xd1)]),_0x325f9e={'members':_0x1987d1,'name':_0x54f9f9};_0x1be552['Package'][_0x4143e7(0xc8)]['push'](_0x325f9e);}const _0x2b288a=new xml2js_1[(_0x4143e7(0xd0))]({'xmldec':{'version':'1.0','encoding':_0x4143e7(0xbe)}}),_0x34cc94=_0x2b288a[_0x4143e7(0xeb)](_0x1be552);await fs_internal_1['FS']['writeFile'](path_1[_0x4143e7(0xf0)][_0x4143e7(0xb0)](process['cwd'](),_0x4143e7(0xa1),_0x56e82e,DEPLOY_DIR_NAME,'src',_0x4143e7(0xe1)),_0x34cc94);}function getComponentsTypeAndName(_0x108bb3,_0x43259e){const _0x266cc3=a102_0x50f63b;return _0x108bb3[_0x266cc3(0xd4)]((_0x51fe66,_0x4a1386)=>{const _0x4e206a=_0x266cc3,_0xb3b975=_0x43259e[_0x4e206a(0xe6)](_0x581ed2=>_0x581ed2['Id']===_0x4a1386[_0x4e206a(0xc4)]);return _0xb3b975&&_0x51fe66[_0x4e206a(0xc3)]({'name':_0xb3b975[_0x4e206a(0xee)][_0x4e206a(0xb8)],'type':salesforce_1['MetadataConstants']['FOLDER_TO_METADATA_TYPE_MAP'][_0x4a1386[_0x4e206a(0xdb)]]||_0x4a1386[_0x4e206a(0xdb)]}),_0x51fe66;},[]);}async function saveDestructiveChanges(_0x433b59,_0x40bc54,_0x5af7c5,_0x171de4){const _0xa01386=a102_0x50f63b,_0x27f114=(await(0x0,fetch_attachments_1[_0xa01386(0x9c)])(_0x433b59,_0x40bc54))[_0xa01386(0xd3)]();await fs_internal_1['FS']['writeFile'](path_1['default'][_0xa01386(0xb0)](process[_0xa01386(0xde)](),_0xa01386(0xa1),_0x171de4,DEPLOY_DIR_NAME,_0xa01386(0xcd),_0x5af7c5),_0x27f114);}async function createDeployZip(_0x372836){const _0xeaaf6c=a102_0x50f63b,_0x4b0a9a=new adm_zip_1[(_0xeaaf6c(0xf0))]();return await _0x4b0a9a[_0xeaaf6c(0xaf)](path_1[_0xeaaf6c(0xf0)]['join'](process[_0xeaaf6c(0xde)](),'.temp',_0x372836,DEPLOY_DIR_NAME)),_0x4b0a9a;}async function insertZip(_0x2f0055,_0x1d8651,_0x49eeaa,_0x344657,_0x42b64b,_0x4a321b){const _0x3b3888=a102_0x50f63b,_0x44b74c={'ParentId':_0x1d8651,'Name':_0x3b3888(0xad)+_0x49eeaa,'Description':_0x3b3888(0xad)+_0x344657,'Body':_0x42b64b},{data:_0x1d75ef}=await _0x2f0055[_0x3b3888(0xb1)](_0x3b3888(0xca)+_0x4a321b+_0x3b3888(0xa2),_0x44b74c);return _0x1d75ef['id'];}