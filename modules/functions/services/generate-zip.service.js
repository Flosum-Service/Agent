const a86_0x15445a=a86_0x4217;(function(_0x15ca18,_0x340b2a){const _0x2182af=a86_0x4217,_0x5a4243=_0x15ca18();while(!![]){try{const _0x283952=parseInt(_0x2182af(0xdb))/0x1*(-parseInt(_0x2182af(0xa4))/0x2)+-parseInt(_0x2182af(0xf7))/0x3*(-parseInt(_0x2182af(0xa6))/0x4)+-parseInt(_0x2182af(0xec))/0x5*(parseInt(_0x2182af(0xf2))/0x6)+-parseInt(_0x2182af(0xf1))/0x7*(parseInt(_0x2182af(0xde))/0x8)+-parseInt(_0x2182af(0x9f))/0x9*(-parseInt(_0x2182af(0xc8))/0xa)+-parseInt(_0x2182af(0xcb))/0xb+parseInt(_0x2182af(0xe9))/0xc*(parseInt(_0x2182af(0xef))/0xd);if(_0x283952===_0x340b2a)break;else _0x5a4243['push'](_0x5a4243['shift']());}catch(_0x1dece2){_0x5a4243['push'](_0x5a4243['shift']());}}}(a86_0x5444,0x59ea6));const a86_0x114d28=(function(){let _0x1c34d8=!![];return function(_0x3de945,_0xc51875){const _0x197886=_0x1c34d8?function(){const _0x10de5d=a86_0x4217;if(_0xc51875){const _0x301173=_0xc51875[_0x10de5d(0xd9)](_0x3de945,arguments);return _0xc51875=null,_0x301173;}}:function(){};return _0x1c34d8=![],_0x197886;};}()),a86_0x1a4f64=a86_0x114d28(this,function(){const _0x1a70f7=a86_0x4217;return a86_0x1a4f64[_0x1a70f7(0xd7)]()[_0x1a70f7(0x9d)]('(((.+)+)+)+$')[_0x1a70f7(0xd7)]()[_0x1a70f7(0xf9)](a86_0x1a4f64)[_0x1a70f7(0x9d)](_0x1a70f7(0x9b));});a86_0x1a4f64();'use strict';var __importDefault=this&&this[a86_0x15445a(0xee)]||function(_0x5199bc){const _0x3bfd95=a86_0x15445a;return _0x5199bc&&_0x5199bc[_0x3bfd95(0xbf)]?_0x5199bc:{'default':_0x5199bc};};Object['defineProperty'](exports,a86_0x15445a(0xbf),{'value':!![]}),exports[a86_0x15445a(0xb2)]=void 0x0;const constants_1=require(a86_0x15445a(0x9e)),path_1=__importDefault(require(a86_0x15445a(0xb6))),extract_component_permissions_1=require(a86_0x15445a(0xd4)),xml2js_1=require(a86_0x15445a(0xb0)),zip_1=require(a86_0x15445a(0xb7)),mdapi_1=require(a86_0x15445a(0xd2)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a86_0x15445a(0xbc)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a86_0x15445a(0xc2))),uuid_1=require(a86_0x15445a(0xac)),fetch_attachments_1=require(a86_0x15445a(0xb4)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x15445a(0xc1),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x15445a(0xdd),DEPLOY_DIR_NAME=a86_0x15445a(0xc6);async function generateAndDeployZip({attachmentsId:_0x22e500,isExtractComponentsPermissions:_0x340bcc,preDestructiveAttachmentId:_0x5552b9,postDestructiveAttachmentId:_0x3dff05,branchId:_0x1ef111,credentials:_0xf409b5,metadataLogId:_0x4d4965,environments:_0x2a43a1,metaTypes:_0x2c8f29},_0x28ac5b){const _0x57569c=a86_0x15445a,_0x1c692a=(0x0,uuid_1['v4'])();try{const _0x1d457b=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x28ac5b,_0x22e500),_0x1093f0=_0x1d457b[_0x57569c(0xb5)]((_0x258022,_0x49987d)=>({..._0x258022,[_0x49987d['Id']]:_0x49987d[_0x57569c(0xa0)]}),{}),_0x41ea64=await getComponents(_0x1d457b,_0x28ac5b,_0x1093f0),_0x3b67f1=await components_api_1[_0x57569c(0xd8)][_0x57569c(0xa7)](_0x28ac5b,_0x1d457b[_0x57569c(0xaf)](({ParentId:_0x3d630c})=>_0x3d630c))[_0x57569c(0xad)](_0x2e42b8=>components_api_1['ComponentsApi'][_0x57569c(0xd5)](_0x2e42b8));if(_0x340bcc){const _0x47832c=_0x41ea64[_0x57569c(0xae)](({fileType:_0x3e85cd})=>_0x3e85cd===_0x57569c(0xe5)||_0x3e85cd==='PermissionSet');await removePermission(_0x47832c,_0x3b67f1);}await replaceEnvironments(_0x2c8f29,_0x2a43a1,_0x41ea64),await writeZip(_0x41ea64,_0x1c692a),await generateAndWritePackageXML(_0x1d457b,_0x3b67f1,_0x1c692a);_0x5552b9&&await saveDestructiveChanges(_0x28ac5b,_0x5552b9,DESTRUCTIVE_CHANGES_PER_NAME,_0x1c692a);_0x3dff05&&await saveDestructiveChanges(_0x28ac5b,_0x3dff05,DESTRUCTIVE_CHANGES_POST_NAME,_0x1c692a);const _0x39aae3=(await createDeployZip(_0x1c692a)[_0x57569c(0xad)](_0x3fb88a=>{return _0x3fb88a;}))[_0x57569c(0x9c)]()[_0x57569c(0xd7)]('base64');console[_0x57569c(0xa9)](_0x57569c(0xa2));const _0x3d691e=_0x39aae3['length'];if(_0x3d691e>=components_api_1[_0x57569c(0xe0)]){const _0x3851b5=await createDeployZip(_0x1c692a);console[_0x57569c(0xa9)]('after\x20create\x20second\x20zip');const [_0x3bcde3,_0x158bdd]=await components_api_1[_0x57569c(0xd8)][_0x57569c(0xba)](_0x3851b5,_0x3d691e),_0xae18fc=await insertZip(_0x28ac5b,_0x1ef111,_0xf409b5[_0x57569c(0xd0)],_0x4d4965,_0x3bcde3[_0x57569c(0x9c)]()[_0x57569c(0xd7)](_0x57569c(0xe8))),_0x425d79=await insertZip(_0x28ac5b,_0x1ef111,_0xf409b5[_0x57569c(0xd0)],_0x4d4965,_0x158bdd[_0x57569c(0x9c)]()[_0x57569c(0xd7)](_0x57569c(0xe8)));return _0xae18fc+','+_0x425d79;}else return await insertZip(_0x28ac5b,_0x1ef111,_0xf409b5[_0x57569c(0xd0)],_0x4d4965,_0x39aae3);}catch(_0x1f77d7){throw _0x1f77d7;}finally{if(await fs_internal_1['FS'][_0x57569c(0xe7)](path_1[_0x57569c(0xdf)]['join'](process[_0x57569c(0xb1)](),'.temp',_0x1c692a)))await(0x0,promises_1['rm'])(path_1[_0x57569c(0xdf)][_0x57569c(0xf4)](process[_0x57569c(0xb1)](),'.temp',_0x1c692a),{'recursive':!![]});}}exports[a86_0x15445a(0xb2)]=generateAndDeployZip;async function getComponents(_0x275ce8,_0x32f428,_0x360f42){const _0x1541bc=a86_0x15445a,_0x616dff=[],_0x43c2aa=await(0x0,fetch_attachments_1[_0x1541bc(0xe2)])(_0x275ce8,_0x32f428);return await getComponentFromZip(_0x43c2aa,_0x360f42)[_0x1541bc(0xad)](_0x2d9f10=>{const _0x5bebac=_0x1541bc;_0x616dff[_0x5bebac(0xf6)](..._0x2d9f10);}),_0x616dff;}async function getComponentFromZip(_0x127227,_0x27ac57){const _0x239e46=a86_0x15445a,_0x531b3a=[];for(const _0x5962e6 of _0x127227){const _0x40c72e=await zip_1[_0x239e46(0xca)]['unzip'](_0x5962e6[_0x239e46(0xbb)][_0x239e46(0xe4)]);for(const _0x1e349a in _0x40c72e[_0x239e46(0xc0)]){!_0x40c72e[_0x239e46(0xc0)][_0x1e349a][_0x239e46(0xd3)]&&_0x531b3a[_0x239e46(0xf6)]({'fileName':_0x1e349a[_0x239e46(0xed)](_0x1e349a['indexOf']('/')+0x1),'fileType':_0x27ac57[_0x5962e6['id']],'body':_0x5962e6[_0x239e46(0xbb)][_0x239e46(0xe4)]});}}return _0x531b3a;}async function removePermission(_0x49c41e,_0x30852b){const _0x54ae9f=a86_0x15445a;for(const _0x44f7f7 of _0x49c41e){const _0x36fed8=await zip_1['Zip'][_0x54ae9f(0xb9)](_0x44f7f7['body']),_0x412cff=[];for(const _0x30db23 in _0x36fed8[_0x54ae9f(0xc0)]){!_0x36fed8[_0x54ae9f(0xc0)][_0x30db23][_0x54ae9f(0xd3)]&&_0x412cff[_0x54ae9f(0xf6)]({'fileName':_0x30db23,'body':await _0x36fed8[_0x54ae9f(0xc0)][_0x30db23][_0x54ae9f(0xb3)](_0x54ae9f(0xc3))});}const _0x11a73d=await(0x0,extract_component_permissions_1[_0x54ae9f(0xc4)])(_0x412cff[0x0]['body'][_0x54ae9f(0xd7)](),_0x30852b,_0x44f7f7[_0x54ae9f(0xe1)]),_0x30b79e=new xml2js_1[(_0x54ae9f(0xc5))]({'xmldec':{'version':_0x54ae9f(0xc9),'encoding':_0x54ae9f(0xda)}}),_0x55d35e=_0x30b79e[_0x54ae9f(0xf8)](_0x11a73d),_0x3ab0d7=zip_1[_0x54ae9f(0xca)][_0x54ae9f(0xbd)]();_0x3ab0d7[_0x54ae9f(0xd1)](_0x412cff[0x0]['fileName'],_0x55d35e),_0x44f7f7[_0x54ae9f(0xcd)]=await _0x3ab0d7['generateAsync']({'type':'base64','compression':_0x54ae9f(0xe3),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x44e462,_0x2343ee,_0x38b3a6){const _0x5ab175=a86_0x15445a;for(const _0x522d4d of _0x38b3a6){if(_0x44e462[_0x5ab175(0xd6)](_0xc943ee=>_0xc943ee!==_0x522d4d[_0x5ab175(0xe1)]))continue;const _0x156487=await zip_1[_0x5ab175(0xca)]['unzip'](_0x522d4d[_0x5ab175(0xcd)]);for(const _0x30cb8e in _0x156487[_0x5ab175(0xc0)]){if(!_0x156487['files'][_0x30cb8e][_0x5ab175(0xd3)]){let _0x2bc20b=await _0x156487[_0x5ab175(0xc0)][_0x30cb8e]['async'](_0x5ab175(0xc3));for(const _0x541b24 of Object[_0x5ab175(0xa3)](_0x2343ee)){const _0x147004=new RegExp('%%'+_0x541b24+'%%','g');_0x2bc20b=_0x2bc20b['replace'](_0x147004,_0x2343ee[_0x541b24]);}_0x156487[_0x5ab175(0xd1)](_0x30cb8e,_0x2bc20b);}}_0x522d4d['body']=await _0x156487['generateAsync']({'type':_0x5ab175(0xe8),'compression':_0x5ab175(0xe3),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x4f3e3f,_0x6998c4){const _0x411a18=a86_0x15445a,_0x72dbee=new mdapi_1['MDApiWriter']({'components':_0x4f3e3f,'sourceDir':path_1[_0x411a18(0xdf)][_0x411a18(0xf4)](process['cwd'](),'.temp',_0x6998c4,DEPLOY_DIR_NAME,_0x411a18(0xea)),'skipChildErrors':![]});await _0x72dbee[_0x411a18(0xcc)]();}async function generateAndWritePackageXML(_0x47119a,_0x3932e3,_0x1e608e){const _0x194711=a86_0x15445a,_0x235814=getComponentsTypeAndName(_0x47119a,_0x3932e3),_0x3d6884=[...new Set(_0x235814[_0x194711(0xaf)](_0x1c12e4=>_0x1c12e4[_0x194711(0xab)]))],_0x442b15={'Package':{'$':{'xmlns':_0x194711(0xb8)},'types':[],'version':''+constants_1[_0x194711(0xce)][_0x194711(0xed)](0x1)}};for(const _0x214994 of _0x3d6884){const _0x2fe80d=_0x235814[_0x194711(0xae)](_0x111326=>_0x111326[_0x194711(0xab)]===_0x214994)[_0x194711(0xaf)](_0x159714=>_0x159714[_0x194711(0xc7)]),_0x34a764={'members':_0x2fe80d,'name':_0x214994};_0x442b15[_0x194711(0xe6)][_0x194711(0xaa)][_0x194711(0xf6)](_0x34a764);}const _0x43d985=new xml2js_1[(_0x194711(0xc5))]({'xmldec':{'version':_0x194711(0xc9),'encoding':_0x194711(0xda)}}),_0x8dea18=_0x43d985[_0x194711(0xf8)](_0x442b15);await fs_internal_1['FS'][_0x194711(0xeb)](path_1[_0x194711(0xdf)]['join'](process[_0x194711(0xb1)](),_0x194711(0xdc),_0x1e608e,DEPLOY_DIR_NAME,_0x194711(0xea),_0x194711(0xf3)),_0x8dea18);}function getComponentsTypeAndName(_0x9598a5,_0x3172eb){const _0x1ff75e=a86_0x15445a;return _0x9598a5[_0x1ff75e(0xb5)]((_0x4501a4,_0x439a45)=>{const _0x53999a=_0x1ff75e,_0x573c26=_0x3172eb[_0x53999a(0xbe)](_0x543f4a=>_0x543f4a['Id']===_0x439a45[_0x53999a(0xa1)]);return _0x573c26&&_0x4501a4['push']({'name':_0x573c26[_0x53999a(0xa5)][_0x53999a(0xf5)],'type':_0x439a45[_0x53999a(0xa0)]}),_0x4501a4;},[]);}async function saveDestructiveChanges(_0x203d04,_0x45ac01,_0x5339b3,_0x19a525){const _0x58736a=a86_0x15445a,_0x27d74f=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x203d04,_0x45ac01))[_0x58736a(0xd7)]();await fs_internal_1['FS'][_0x58736a(0xeb)](path_1[_0x58736a(0xdf)][_0x58736a(0xf4)](process[_0x58736a(0xb1)](),_0x58736a(0xdc),_0x19a525,DEPLOY_DIR_NAME,_0x58736a(0xea),_0x5339b3),_0x27d74f);}async function createDeployZip(_0x5c4ba5){const _0x2fbdf8=a86_0x15445a,_0x1318bc=new adm_zip_1[(_0x2fbdf8(0xdf))]();return await _0x1318bc[_0x2fbdf8(0xf0)](path_1[_0x2fbdf8(0xdf)][_0x2fbdf8(0xf4)](process['cwd'](),_0x2fbdf8(0xdc),_0x5c4ba5,DEPLOY_DIR_NAME)),_0x1318bc;}function a86_0x5444(){const _0x2764b6=['fileType','retrieveAttachments','DEFLATE','Body','Profile','Package','exists','base64','12fGBBtg','src','writeFile','15vPsivY','substring','__importDefault','12221599beVsuN','addLocalFolder','3204159qPmsrL','55368altnfM','package.xml','join','Component_Name__c','push','3ljvNGu','buildObject','constructor','(((.+)+)+)+$','toBuffer','search','../../../constants','180261azBhVn','Name','ParentId','after\x20create\x20zip','keys','4vROpKw','Component__r','1405628AAhPgD','fetchComponentsDetailsByComponentsHistory','post','log','types','type','uuid','then','filter','map','xml2js','cwd','generateAndDeployZip','async','../../shared/utils/fetch-attachments','reduce','path','../../git/parsers/utils/zip','http://soap.sforce.com/2006/04/metadata','unzip','splitZip','values','fs/promises','createZip','find','__esModule','files','destructiveChangesPre.xml','adm-zip','text','extractComponentPermissions','Builder','DEPLOYZIP','name','250NYqXyh','1.0','Zip','3686826dxrSFm','start','body','SALESFORCE_API_VERSION','BUILD','orgId','file','../../git/parsers/mdapi','dir','../utils/extract-component-permissions','removeNamespacePrefix','every','toString','ComponentsApi','apply','UTF-8','301687kokKBf','.temp','destructiveChangesPost.xml','8gkJJiI','default','MAX_ZIP_SIZE'];a86_0x5444=function(){return _0x2764b6;};return a86_0x5444();}function a86_0x4217(_0x5d142c,_0xdd7629){const _0x49eb4f=a86_0x5444();return a86_0x4217=function(_0x1a4f64,_0x114d28){_0x1a4f64=_0x1a4f64-0x9b;let _0x544442=_0x49eb4f[_0x1a4f64];return _0x544442;},a86_0x4217(_0x5d142c,_0xdd7629);}async function insertZip(_0x213d01,_0xfd156d,_0x266a38,_0xf03872,_0x482707){const _0x4a0108=a86_0x15445a,_0x1b323e={'ParentId':_0xfd156d,'Name':_0x4a0108(0xcf)+_0x266a38,'Description':'BUILD'+_0xf03872,'Body':_0x482707},{data:_0x5385d6}=await _0x213d01[_0x4a0108(0xa8)]('/services/data/'+constants_1['SALESFORCE_API_VERSION']+'/sobjects/Attachment',_0x1b323e);return _0x5385d6['id'];}