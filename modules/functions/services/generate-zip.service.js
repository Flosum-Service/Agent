const a86_0x5199a8=a86_0x4e5d;(function(_0x1e0f82,_0x186055){const _0x5aa4dc=a86_0x4e5d,_0xc81675=_0x1e0f82();while(!![]){try{const _0x39b12e=parseInt(_0x5aa4dc(0x201))/0x1+parseInt(_0x5aa4dc(0x23b))/0x2+-parseInt(_0x5aa4dc(0x1fc))/0x3+-parseInt(_0x5aa4dc(0x22b))/0x4*(parseInt(_0x5aa4dc(0x237))/0x5)+-parseInt(_0x5aa4dc(0x223))/0x6+-parseInt(_0x5aa4dc(0x20b))/0x7*(parseInt(_0x5aa4dc(0x1f2))/0x8)+parseInt(_0x5aa4dc(0x1fd))/0x9;if(_0x39b12e===_0x186055)break;else _0xc81675['push'](_0xc81675['shift']());}catch(_0x577836){_0xc81675['push'](_0xc81675['shift']());}}}(a86_0x232d,0x34461));const a86_0x4948f3=(function(){let _0x3f7c0d=!![];return function(_0x3d0e73,_0x1a0788){const _0x2219e5=_0x3f7c0d?function(){const _0x34d76c=a86_0x4e5d;if(_0x1a0788){const _0x2a9467=_0x1a0788[_0x34d76c(0x219)](_0x3d0e73,arguments);return _0x1a0788=null,_0x2a9467;}}:function(){};return _0x3f7c0d=![],_0x2219e5;};}()),a86_0x23d151=a86_0x4948f3(this,function(){const _0x50560f=a86_0x4e5d;return a86_0x23d151[_0x50560f(0x1f1)]()[_0x50560f(0x209)](_0x50560f(0x1ef))[_0x50560f(0x1f1)]()['constructor'](a86_0x23d151)['search'](_0x50560f(0x1ef));});a86_0x23d151();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x35c174){return _0x35c174&&_0x35c174['__esModule']?_0x35c174:{'default':_0x35c174};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a86_0x5199a8(0x208)]=void 0x0;const constants_1=require(a86_0x5199a8(0x214)),path_1=__importDefault(require(a86_0x5199a8(0x23c))),extract_component_permissions_1=require(a86_0x5199a8(0x20f)),xml2js_1=require('xml2js'),zip_1=require(a86_0x5199a8(0x235)),mdapi_1=require(a86_0x5199a8(0x20d)),fs_internal_1=require(a86_0x5199a8(0x1f9)),promises_1=require(a86_0x5199a8(0x224)),components_api_1=require(a86_0x5199a8(0x204)),adm_zip_1=__importDefault(require(a86_0x5199a8(0x220))),uuid_1=require('uuid'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x5199a8(0x1fa),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x5199a8(0x1f4),DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x1db7e0,isExtractComponentsPermissions:_0x1563e1,preDestructiveAttachmentId:_0x104c96,postDestructiveAttachmentId:_0x488794,branchId:_0x1f4c4f,credentials:_0x34dc62,metadataLogId:_0x5e8404,environments:_0xc802ea,metaTypes:_0x21bd40},_0x4df796){const _0x5d7f55=a86_0x5199a8,_0x3feb06=(0x0,uuid_1['v4'])();try{const _0x418cdd=await(0x0,fetch_attachments_1[_0x5d7f55(0x1f0)])(_0x4df796,_0x1db7e0),_0x236ef2=_0x418cdd[_0x5d7f55(0x1ff)]((_0x2eda2d,_0x345ab0)=>({..._0x2eda2d,[_0x345ab0['Id']]:_0x345ab0['Name']}),{}),_0x14e2b1=await getComponents(_0x418cdd,_0x4df796,_0x236ef2),_0x3d9d52=await components_api_1[_0x5d7f55(0x213)][_0x5d7f55(0x23e)](_0x4df796,_0x418cdd[_0x5d7f55(0x211)](({ParentId:_0x5651fa})=>_0x5651fa))[_0x5d7f55(0x225)](_0x19a4e3=>components_api_1[_0x5d7f55(0x213)]['removeNamespacePrefix'](_0x19a4e3));if(_0x1563e1){const _0x48ecf7=_0x14e2b1[_0x5d7f55(0x21d)](({fileType:_0x4a31f2})=>_0x4a31f2===_0x5d7f55(0x21e)||_0x4a31f2==='PermissionSet');await removePermission(_0x48ecf7,_0x3d9d52);}await replaceEnvironments(_0x21bd40,_0xc802ea,_0x14e2b1),await writeZip(_0x14e2b1,_0x3feb06),await generateAndWritePackageXML(_0x418cdd,_0x3d9d52,_0x3feb06);_0x104c96&&await saveDestructiveChanges(_0x4df796,_0x104c96,DESTRUCTIVE_CHANGES_PER_NAME,_0x3feb06);_0x488794&&await saveDestructiveChanges(_0x4df796,_0x488794,DESTRUCTIVE_CHANGES_POST_NAME,_0x3feb06);const _0x16dbc1=(await createDeployZip(_0x3feb06)[_0x5d7f55(0x225)](_0xa4bba9=>{return _0xa4bba9;}))[_0x5d7f55(0x230)]()['toString'](_0x5d7f55(0x232));console[_0x5d7f55(0x21f)]('after\x20create\x20zip');const _0xdf55bf=_0x16dbc1['length'];if(_0xdf55bf>=components_api_1['MAX_ZIP_SIZE']){const _0x7c6da4=await createDeployZip(_0x3feb06);console[_0x5d7f55(0x21f)](_0x5d7f55(0x1ee));const [_0x1bd26b,_0x49e06d]=await components_api_1[_0x5d7f55(0x213)]['splitZip'](_0x7c6da4,_0xdf55bf),_0x5aab3c=await insertZip(_0x4df796,_0x1f4c4f,_0x34dc62[_0x5d7f55(0x238)],_0x5e8404,_0x1bd26b[_0x5d7f55(0x230)]()[_0x5d7f55(0x1f1)](_0x5d7f55(0x232))),_0x4378f1=await insertZip(_0x4df796,_0x1f4c4f,_0x34dc62['orgId'],_0x5e8404,_0x49e06d[_0x5d7f55(0x230)]()[_0x5d7f55(0x1f1)](_0x5d7f55(0x232)));return _0x5aab3c+','+_0x4378f1;}else return await insertZip(_0x4df796,_0x1f4c4f,_0x34dc62[_0x5d7f55(0x238)],_0x5e8404,_0x16dbc1);}catch(_0x44a3f1){throw _0x44a3f1;}finally{if(await fs_internal_1['FS'][_0x5d7f55(0x240)](path_1[_0x5d7f55(0x239)][_0x5d7f55(0x23f)](process[_0x5d7f55(0x20e)](),_0x5d7f55(0x20a),_0x3feb06)))await(0x0,promises_1['rm'])(path_1[_0x5d7f55(0x239)]['join'](process[_0x5d7f55(0x20e)](),_0x5d7f55(0x20a),_0x3feb06),{'recursive':!![]});}}function a86_0x4e5d(_0x5a1246,_0x3536ad){const _0x15b571=a86_0x232d();return a86_0x4e5d=function(_0x23d151,_0x4948f3){_0x23d151=_0x23d151-0x1ee;let _0x232dc2=_0x15b571[_0x23d151];return _0x232dc2;},a86_0x4e5d(_0x5a1246,_0x3536ad);}exports[a86_0x5199a8(0x208)]=generateAndDeployZip;async function getComponents(_0x48ac1a,_0x1f775c,_0x2f09e8){const _0x21d7c0=[],_0x67f113=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x48ac1a,_0x1f775c);return await getComponentFromZip(_0x67f113,_0x2f09e8)['then'](_0x2ab54f=>{const _0x11f8ed=a86_0x4e5d;_0x21d7c0[_0x11f8ed(0x236)](..._0x2ab54f);}),_0x21d7c0;}async function getComponentFromZip(_0x5944c6,_0x5eb674){const _0x8d570=a86_0x5199a8,_0x1c1513=[];for(const _0x2fd052 of _0x5944c6){const _0x2e9c3e=await zip_1[_0x8d570(0x212)][_0x8d570(0x218)](_0x2fd052[_0x8d570(0x226)][_0x8d570(0x216)]);for(const _0x37b4ec in _0x2e9c3e['files']){!_0x2e9c3e[_0x8d570(0x21b)][_0x37b4ec][_0x8d570(0x229)]&&_0x1c1513['push']({'fileName':_0x37b4ec[_0x8d570(0x221)](_0x37b4ec[_0x8d570(0x231)]('/')+0x1),'fileType':_0x5eb674[_0x2fd052['id']],'body':_0x2fd052[_0x8d570(0x226)][_0x8d570(0x216)]});}}return _0x1c1513;}async function removePermission(_0x19e64e,_0x117b17){const _0x510065=a86_0x5199a8;for(const _0x56bb84 of _0x19e64e){const _0x56316c=await zip_1[_0x510065(0x212)]['unzip'](_0x56bb84[_0x510065(0x233)]),_0x63c929=[];for(const _0xd52827 in _0x56316c[_0x510065(0x21b)]){!_0x56316c[_0x510065(0x21b)][_0xd52827][_0x510065(0x229)]&&_0x63c929[_0x510065(0x236)]({'fileName':_0xd52827,'body':await _0x56316c['files'][_0xd52827][_0x510065(0x1f7)]('text')});}const _0x2d801e=await(0x0,extract_component_permissions_1[_0x510065(0x22f)])(_0x63c929[0x0]['body'][_0x510065(0x1f1)](),_0x117b17,_0x56bb84[_0x510065(0x1fb)]),_0x1ab240=new xml2js_1['Builder']({'xmldec':{'version':_0x510065(0x22d),'encoding':'UTF-8'}}),_0x5a35d8=_0x1ab240[_0x510065(0x241)](_0x2d801e),_0x413262=zip_1[_0x510065(0x212)]['createZip']();_0x413262[_0x510065(0x22c)](_0x63c929[0x0]['fileName'],_0x5a35d8),_0x56bb84['body']=await _0x413262['generateAsync']({'type':'base64','compression':_0x510065(0x202),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x5a4db5,_0x32f810,_0x34cd6b){const _0x54bbd2=a86_0x5199a8;for(const _0x16149b of _0x34cd6b){if(_0x5a4db5[_0x54bbd2(0x228)](_0x51349a=>_0x51349a!==_0x16149b[_0x54bbd2(0x1fb)]))continue;const _0xc38cf=await zip_1[_0x54bbd2(0x212)]['unzip'](_0x16149b[_0x54bbd2(0x233)]);for(const _0x3c5001 in _0xc38cf[_0x54bbd2(0x21b)]){if(!_0xc38cf[_0x54bbd2(0x21b)][_0x3c5001]['dir']){let _0x5bb0e6=await _0xc38cf['files'][_0x3c5001][_0x54bbd2(0x1f7)](_0x54bbd2(0x22a));for(const _0x2e10a2 of Object[_0x54bbd2(0x1fe)](_0x32f810)){const _0x21d3e=new RegExp('%%'+_0x2e10a2+'%%','g');_0x5bb0e6=_0x5bb0e6['replace'](_0x21d3e,_0x32f810[_0x2e10a2]);}_0xc38cf['file'](_0x3c5001,_0x5bb0e6);}}_0x16149b[_0x54bbd2(0x233)]=await _0xc38cf[_0x54bbd2(0x206)]({'type':'base64','compression':_0x54bbd2(0x202),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x23ae20,_0x1be028){const _0x52ec1b=a86_0x5199a8,_0x36f552=new mdapi_1['MDApiWriter']({'components':_0x23ae20,'sourceDir':path_1[_0x52ec1b(0x239)][_0x52ec1b(0x23f)](process['cwd'](),'.temp',_0x1be028,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x36f552[_0x52ec1b(0x234)]();}async function generateAndWritePackageXML(_0x475ebb,_0xb3650a,_0x51e352){const _0x5c89da=a86_0x5199a8,_0x20b15a=getComponentsTypeAndName(_0x475ebb,_0xb3650a),_0x2a014c=[...new Set(_0x20b15a[_0x5c89da(0x211)](_0x463397=>_0x463397[_0x5c89da(0x1f3)]))],_0x3f73f6={'Package':{'$':{'xmlns':_0x5c89da(0x205)},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION']['substring'](0x1)}};for(const _0xe52289 of _0x2a014c){const _0x514de9=_0x20b15a[_0x5c89da(0x21d)](_0x861f4d=>_0x861f4d[_0x5c89da(0x1f3)]===_0xe52289)['map'](_0xcdf3bc=>_0xcdf3bc[_0x5c89da(0x215)]),_0x4ab1ef={'members':_0x514de9,'name':_0xe52289};_0x3f73f6[_0x5c89da(0x203)][_0x5c89da(0x222)][_0x5c89da(0x236)](_0x4ab1ef);}const _0x12c1f7=new xml2js_1[(_0x5c89da(0x22e))]({'xmldec':{'version':_0x5c89da(0x22d),'encoding':_0x5c89da(0x1f5)}}),_0x31c41e=_0x12c1f7['buildObject'](_0x3f73f6);await fs_internal_1['FS'][_0x5c89da(0x21a)](path_1['default'][_0x5c89da(0x23f)](process[_0x5c89da(0x20e)](),'.temp',_0x51e352,DEPLOY_DIR_NAME,_0x5c89da(0x227),_0x5c89da(0x23d)),_0x31c41e);}function getComponentsTypeAndName(_0x32ea77,_0x4868ec){const _0x4c5b1b=a86_0x5199a8;return _0x32ea77[_0x4c5b1b(0x1ff)]((_0x36cc71,_0x1b9fde)=>{const _0xf852fa=_0x4c5b1b,_0x24d540=_0x4868ec[_0xf852fa(0x217)](_0x4e1388=>_0x4e1388['Id']===_0x1b9fde['ParentId']);return _0x24d540&&_0x36cc71[_0xf852fa(0x236)]({'name':_0x24d540[_0xf852fa(0x21c)][_0xf852fa(0x200)],'type':_0x1b9fde[_0xf852fa(0x23a)]}),_0x36cc71;},[]);}async function saveDestructiveChanges(_0x590e56,_0x5341c5,_0x184af7,_0x18320d){const _0x355b4c=a86_0x5199a8,_0x37ed7f=(await(0x0,fetch_attachments_1[_0x355b4c(0x1f6)])(_0x590e56,_0x5341c5))['toString']();await fs_internal_1['FS']['writeFile'](path_1[_0x355b4c(0x239)]['join'](process[_0x355b4c(0x20e)](),_0x355b4c(0x20a),_0x18320d,DEPLOY_DIR_NAME,_0x355b4c(0x227),_0x184af7),_0x37ed7f);}function a86_0x232d(){const _0x4cd722=['after\x20create\x20second\x20zip','(((.+)+)+)+$','fetchAttachmentsDetailsById','toString','16jQWcAq','type','destructiveChangesPost.xml','UTF-8','fetchAttachmentBody','async','post','../../git/internal/fs.internal','destructiveChangesPre.xml','fileType','319041rVShTu','3105108ahYdGU','keys','reduce','Component_Name__c','283380LZYkoJ','DEFLATE','Package','../utils/components-api','http://soap.sforce.com/2006/04/metadata','generateAsync','SALESFORCE_API_VERSION','generateAndDeployZip','search','.temp','928879ehYuZo','/sobjects/Attachment','../../git/parsers/mdapi','cwd','../utils/extract-component-permissions','addLocalFolder','map','Zip','ComponentsApi','../../../constants','name','Body','find','unzip','apply','writeFile','files','Component__r','filter','Profile','log','adm-zip','substring','types','1539660pTHGHR','fs/promises','then','values','src','every','dir','text','36ahWFIe','file','1.0','Builder','extractComponentPermissions','toBuffer','indexOf','base64','body','start','../../git/parsers/utils/zip','push','64585abaEgB','orgId','default','Name','660650KgqaeP','path','package.xml','fetchComponentsDetailsByComponentsHistory','join','exists','buildObject','BUILD'];a86_0x232d=function(){return _0x4cd722;};return a86_0x232d();}async function createDeployZip(_0x50ea13){const _0x257360=a86_0x5199a8,_0x5bbf0d=new adm_zip_1['default']();return await _0x5bbf0d[_0x257360(0x210)](path_1[_0x257360(0x239)]['join'](process[_0x257360(0x20e)](),_0x257360(0x20a),_0x50ea13,DEPLOY_DIR_NAME)),_0x5bbf0d;}async function insertZip(_0x35cbda,_0x5372e2,_0x3efcd1,_0x46fe00,_0x472517){const _0xe891f7=a86_0x5199a8,_0xd04bdc={'ParentId':_0x5372e2,'Name':_0xe891f7(0x242)+_0x3efcd1,'Description':'BUILD'+_0x46fe00,'Body':_0x472517},{data:_0x164cc6}=await _0x35cbda[_0xe891f7(0x1f8)]('/services/data/'+constants_1[_0xe891f7(0x207)]+_0xe891f7(0x20c),_0xd04bdc);return _0x164cc6['id'];}