const a86_0x43e194=a86_0x10f1;(function(_0x150ad1,_0x4eb30c){const _0x25fc4f=a86_0x10f1,_0x36c808=_0x150ad1();while(!![]){try{const _0x90753=-parseInt(_0x25fc4f(0x1b8))/0x1*(-parseInt(_0x25fc4f(0x17c))/0x2)+-parseInt(_0x25fc4f(0x19c))/0x3+parseInt(_0x25fc4f(0x19a))/0x4+-parseInt(_0x25fc4f(0x1a6))/0x5*(parseInt(_0x25fc4f(0x1bc))/0x6)+parseInt(_0x25fc4f(0x1a2))/0x7+-parseInt(_0x25fc4f(0x1ab))/0x8+-parseInt(_0x25fc4f(0x1bf))/0x9*(parseInt(_0x25fc4f(0x1b3))/0xa);if(_0x90753===_0x4eb30c)break;else _0x36c808['push'](_0x36c808['shift']());}catch(_0x72bfa3){_0x36c808['push'](_0x36c808['shift']());}}}(a86_0x6759,0xee1ad));const a86_0x3e591f=(function(){let _0x31dd70=!![];return function(_0x553a27,_0xa6d4f5){const _0x12c514=_0x31dd70?function(){if(_0xa6d4f5){const _0xb1ab0d=_0xa6d4f5['apply'](_0x553a27,arguments);return _0xa6d4f5=null,_0xb1ab0d;}}:function(){};return _0x31dd70=![],_0x12c514;};}()),a86_0x25b178=a86_0x3e591f(this,function(){const _0x41b0f1=a86_0x10f1;return a86_0x25b178[_0x41b0f1(0x17b)]()['search'](_0x41b0f1(0x169))[_0x41b0f1(0x17b)]()[_0x41b0f1(0x1b6)](a86_0x25b178)[_0x41b0f1(0x1a1)](_0x41b0f1(0x169));});a86_0x25b178();function a86_0x6759(){const _0x4e64cc=['join','toString','2mzYUVP','buildObject','push','__importDefault','http://soap.sforce.com/2006/04/metadata','reduce','substring','fetchAttachmentsDetailsById','Body','__esModule','file','async','DEFLATE','destructiveChangesPre.xml','log','xml2js','ParentId','extractComponentPermissions','src','default','/sobjects/Attachment','generateAndDeployZip','filter','Package','length','cwd','fetchAttachmentBody','toBuffer','values','../../../constants','7137232SArjJY','name','4082202onYWWR','keys','fetchComponentsDetailsByComponentsHistory','map','generateAsync','search','6605844dTaKPE','../../git/parsers/mdapi','Zip','removeNamespacePrefix','1199530oRbfmT','fs/promises','/services/data/','DEPLOYZIP','start','3914360wertKL','Profile','destructiveChangesPost.xml','indexOf','SALESFORCE_API_VERSION','Component_Name__c','type','orgId','10xfoipU','base64','../utils/extract-component-permissions','constructor','replace','1094627lfuuRJ','addLocalFolder','dir','MAX_ZIP_SIZE','18BlMqKW','fileType','defineProperty','2498427jHkpTk','ComponentsApi','../utils/components-api','(((.+)+)+)+$','find','BUILD','Name','unzip','PermissionSet','splitZip','after\x20create\x20zip','uuid','files','then','post','1.0','.temp','adm-zip','writeFile','body'];a86_0x6759=function(){return _0x4e64cc;};return a86_0x6759();}'use strict';var __importDefault=this&&this[a86_0x43e194(0x17f)]||function(_0x25a6b8){const _0x15a7fc=a86_0x43e194;return _0x25a6b8&&_0x25a6b8[_0x15a7fc(0x185)]?_0x25a6b8:{'default':_0x25a6b8};};Object[a86_0x43e194(0x1be)](exports,a86_0x43e194(0x185),{'value':!![]}),exports[a86_0x43e194(0x191)]=void 0x0;const constants_1=require(a86_0x43e194(0x199)),path_1=__importDefault(require('path')),extract_component_permissions_1=require(a86_0x43e194(0x1b5)),xml2js_1=require(a86_0x43e194(0x18b)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require(a86_0x43e194(0x1a3)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a86_0x43e194(0x1a7)),components_api_1=require(a86_0x43e194(0x168)),adm_zip_1=__importDefault(require(a86_0x43e194(0x177))),uuid_1=require(a86_0x43e194(0x171)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x43e194(0x189),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x43e194(0x1ad),DEPLOY_DIR_NAME=a86_0x43e194(0x1a9);async function generateAndDeployZip({attachmentsId:_0x444f4e,isExtractComponentsPermissions:_0x2e1f02,preDestructiveAttachmentId:_0x21b587,postDestructiveAttachmentId:_0x13e43b,branchId:_0x57ea8f,credentials:_0x4227ea,metadataLogId:_0x50d303,environments:_0x44c768,metaTypes:_0x288720},_0x1063d3){const _0xf810d3=a86_0x43e194,_0x37b7b1=(0x0,uuid_1['v4'])();try{const _0x39b60b=await(0x0,fetch_attachments_1[_0xf810d3(0x183)])(_0x1063d3,_0x444f4e),_0x3f70b6=_0x39b60b[_0xf810d3(0x181)]((_0x1bf7d9,_0xa11f93)=>({..._0x1bf7d9,[_0xa11f93['Id']]:_0xa11f93[_0xf810d3(0x16c)]}),{}),_0x1b2e12=await getComponents(_0x39b60b,_0x1063d3,_0x3f70b6),_0x10b237=await components_api_1['ComponentsApi'][_0xf810d3(0x19e)](_0x1063d3,_0x39b60b[_0xf810d3(0x19f)](({ParentId:_0xda2a2b})=>_0xda2a2b))['then'](_0x519ec3=>components_api_1[_0xf810d3(0x167)][_0xf810d3(0x1a5)](_0x519ec3));if(_0x2e1f02){const _0x4ebc02=_0x1b2e12[_0xf810d3(0x192)](({fileType:_0x1c7cf5})=>_0x1c7cf5===_0xf810d3(0x1ac)||_0x1c7cf5===_0xf810d3(0x16e));await removePermission(_0x4ebc02,_0x10b237);}await replaceEnvironments(_0x288720,_0x44c768,_0x1b2e12),await writeZip(_0x1b2e12,_0x37b7b1),await generateAndWritePackageXML(_0x39b60b,_0x10b237,_0x37b7b1);_0x21b587&&await saveDestructiveChanges(_0x1063d3,_0x21b587,DESTRUCTIVE_CHANGES_PER_NAME,_0x37b7b1);_0x13e43b&&await saveDestructiveChanges(_0x1063d3,_0x13e43b,DESTRUCTIVE_CHANGES_POST_NAME,_0x37b7b1);const _0x1c7e72=(await createDeployZip(_0x37b7b1)['then'](_0x10cd54=>{return _0x10cd54;}))[_0xf810d3(0x197)]()[_0xf810d3(0x17b)](_0xf810d3(0x1b4));console[_0xf810d3(0x18a)](_0xf810d3(0x170));const _0x565555=_0x1c7e72[_0xf810d3(0x194)];if(_0x565555>=components_api_1[_0xf810d3(0x1bb)]){const _0x935dfc=await createDeployZip(_0x37b7b1);console[_0xf810d3(0x18a)]('after\x20create\x20second\x20zip');const [_0x3c7cdc,_0x2b1ae0]=await components_api_1['ComponentsApi'][_0xf810d3(0x16f)](_0x935dfc,_0x565555),_0x3e55e9=await insertZip(_0x1063d3,_0x57ea8f,_0x4227ea['orgId'],_0x50d303,_0x3c7cdc[_0xf810d3(0x197)]()[_0xf810d3(0x17b)]('base64')),_0x8fa310=await insertZip(_0x1063d3,_0x57ea8f,_0x4227ea[_0xf810d3(0x1b2)],_0x50d303,_0x2b1ae0['toBuffer']()[_0xf810d3(0x17b)](_0xf810d3(0x1b4)));return _0x3e55e9+','+_0x8fa310;}else return await insertZip(_0x1063d3,_0x57ea8f,_0x4227ea['orgId'],_0x50d303,_0x1c7e72);}catch(_0x3c1de1){throw _0x3c1de1;}finally{if(await fs_internal_1['FS']['exists'](path_1['default'][_0xf810d3(0x17a)](process[_0xf810d3(0x195)](),_0xf810d3(0x176),_0x37b7b1)))await(0x0,promises_1['rm'])(path_1[_0xf810d3(0x18f)][_0xf810d3(0x17a)](process[_0xf810d3(0x195)](),_0xf810d3(0x176),_0x37b7b1),{'recursive':!![]});}}exports[a86_0x43e194(0x191)]=generateAndDeployZip;function a86_0x10f1(_0x3c2284,_0x3db1b8){const _0x12b576=a86_0x6759();return a86_0x10f1=function(_0x25b178,_0x3e591f){_0x25b178=_0x25b178-0x167;let _0x6759d3=_0x12b576[_0x25b178];return _0x6759d3;},a86_0x10f1(_0x3c2284,_0x3db1b8);}async function getComponents(_0x408cad,_0x1c4844,_0x48d4e3){const _0x522c14=a86_0x43e194,_0x2f9958=[],_0x5a50c2=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x408cad,_0x1c4844);return await getComponentFromZip(_0x5a50c2,_0x48d4e3)[_0x522c14(0x173)](_0x3c4f81=>{const _0x367300=_0x522c14;_0x2f9958[_0x367300(0x17e)](..._0x3c4f81);}),_0x2f9958;}async function getComponentFromZip(_0x3819ca,_0x1c6daf){const _0x70c324=a86_0x43e194,_0x4e2e0d=[];for(const _0x48463c of _0x3819ca){const _0x5b06ee=await zip_1[_0x70c324(0x1a4)][_0x70c324(0x16d)](_0x48463c[_0x70c324(0x198)][_0x70c324(0x184)]);for(const _0x122c3e in _0x5b06ee[_0x70c324(0x172)]){!_0x5b06ee['files'][_0x122c3e][_0x70c324(0x1ba)]&&_0x4e2e0d[_0x70c324(0x17e)]({'fileName':_0x122c3e[_0x70c324(0x182)](_0x122c3e[_0x70c324(0x1ae)]('/')+0x1),'fileType':_0x1c6daf[_0x48463c['id']],'body':_0x48463c[_0x70c324(0x198)]['Body']});}}return _0x4e2e0d;}async function removePermission(_0x5a80c5,_0x3122f1){const _0x4f3b0b=a86_0x43e194;for(const _0x173fcc of _0x5a80c5){const _0x4b7334=await zip_1['Zip'][_0x4f3b0b(0x16d)](_0x173fcc[_0x4f3b0b(0x179)]),_0x2797c9=[];for(const _0x126227 in _0x4b7334[_0x4f3b0b(0x172)]){!_0x4b7334[_0x4f3b0b(0x172)][_0x126227][_0x4f3b0b(0x1ba)]&&_0x2797c9[_0x4f3b0b(0x17e)]({'fileName':_0x126227,'body':await _0x4b7334['files'][_0x126227][_0x4f3b0b(0x187)]('text')});}const _0x534203=await(0x0,extract_component_permissions_1[_0x4f3b0b(0x18d)])(_0x2797c9[0x0][_0x4f3b0b(0x179)][_0x4f3b0b(0x17b)](),_0x3122f1,_0x173fcc[_0x4f3b0b(0x1bd)]),_0x411de0=new xml2js_1['Builder']({'xmldec':{'version':_0x4f3b0b(0x175),'encoding':'UTF-8'}}),_0x50d5a9=_0x411de0[_0x4f3b0b(0x17d)](_0x534203),_0x468458=zip_1[_0x4f3b0b(0x1a4)]['createZip']();_0x468458[_0x4f3b0b(0x186)](_0x2797c9[0x0]['fileName'],_0x50d5a9),_0x173fcc[_0x4f3b0b(0x179)]=await _0x468458[_0x4f3b0b(0x1a0)]({'type':'base64','compression':_0x4f3b0b(0x188),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x4b4b76,_0x146866,_0x2af75e){const _0x19782b=a86_0x43e194;for(const _0x574e8e of _0x2af75e){if(_0x4b4b76['every'](_0x997231=>_0x997231!==_0x574e8e[_0x19782b(0x1bd)]))continue;const _0xfe67de=await zip_1[_0x19782b(0x1a4)][_0x19782b(0x16d)](_0x574e8e['body']);for(const _0x2fddec in _0xfe67de[_0x19782b(0x172)]){if(!_0xfe67de['files'][_0x2fddec][_0x19782b(0x1ba)]){let _0x41a6fb=await _0xfe67de[_0x19782b(0x172)][_0x2fddec][_0x19782b(0x187)]('text');for(const _0x25be01 of Object[_0x19782b(0x19d)](_0x146866)){const _0x308c5b=new RegExp('%%'+_0x25be01+'%%','g');_0x41a6fb=_0x41a6fb[_0x19782b(0x1b7)](_0x308c5b,_0x146866[_0x25be01]);}_0xfe67de[_0x19782b(0x186)](_0x2fddec,_0x41a6fb);}}_0x574e8e[_0x19782b(0x179)]=await _0xfe67de[_0x19782b(0x1a0)]({'type':_0x19782b(0x1b4),'compression':_0x19782b(0x188),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x2bb28f,_0x38f258){const _0x1413ec=a86_0x43e194,_0x5cab02=new mdapi_1['MDApiWriter']({'components':_0x2bb28f,'sourceDir':path_1['default'][_0x1413ec(0x17a)](process[_0x1413ec(0x195)](),_0x1413ec(0x176),_0x38f258,DEPLOY_DIR_NAME,_0x1413ec(0x18e)),'skipChildErrors':![]});await _0x5cab02[_0x1413ec(0x1aa)]();}async function generateAndWritePackageXML(_0x4951c7,_0x51d8d6,_0x28b23e){const _0x53408a=a86_0x43e194,_0x91e60d=getComponentsTypeAndName(_0x4951c7,_0x51d8d6),_0x1c1447=[...new Set(_0x91e60d[_0x53408a(0x19f)](_0x5640bc=>_0x5640bc[_0x53408a(0x1b1)]))],_0x27217b={'Package':{'$':{'xmlns':_0x53408a(0x180)},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION']['substring'](0x1)}};for(const _0x4625ae of _0x1c1447){const _0x4a42ff=_0x91e60d['filter'](_0x2fa002=>_0x2fa002[_0x53408a(0x1b1)]===_0x4625ae)[_0x53408a(0x19f)](_0x206d6c=>_0x206d6c[_0x53408a(0x19b)]),_0x2a8bd1={'members':_0x4a42ff,'name':_0x4625ae};_0x27217b[_0x53408a(0x193)]['types'][_0x53408a(0x17e)](_0x2a8bd1);}const _0x8ea76d=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x5159ae=_0x8ea76d[_0x53408a(0x17d)](_0x27217b);await fs_internal_1['FS'][_0x53408a(0x178)](path_1[_0x53408a(0x18f)][_0x53408a(0x17a)](process[_0x53408a(0x195)](),_0x53408a(0x176),_0x28b23e,DEPLOY_DIR_NAME,'src','package.xml'),_0x5159ae);}function getComponentsTypeAndName(_0x144344,_0x4f8720){const _0x3eb1bf=a86_0x43e194;return _0x144344[_0x3eb1bf(0x181)]((_0x411ae4,_0x391a3c)=>{const _0x362883=_0x3eb1bf,_0x178c97=_0x4f8720[_0x362883(0x16a)](_0x40013a=>_0x40013a['Id']===_0x391a3c[_0x362883(0x18c)]);return _0x178c97&&_0x411ae4[_0x362883(0x17e)]({'name':_0x178c97['Component__r'][_0x362883(0x1b0)],'type':_0x391a3c['Name']}),_0x411ae4;},[]);}async function saveDestructiveChanges(_0x3fd252,_0x3e4462,_0x42a3ff,_0x495a9a){const _0x3e9960=a86_0x43e194,_0x330cb1=(await(0x0,fetch_attachments_1[_0x3e9960(0x196)])(_0x3fd252,_0x3e4462))['toString']();await fs_internal_1['FS'][_0x3e9960(0x178)](path_1[_0x3e9960(0x18f)][_0x3e9960(0x17a)](process[_0x3e9960(0x195)](),_0x3e9960(0x176),_0x495a9a,DEPLOY_DIR_NAME,_0x3e9960(0x18e),_0x42a3ff),_0x330cb1);}async function createDeployZip(_0xe32b07){const _0xb56e2d=a86_0x43e194,_0x496c34=new adm_zip_1[(_0xb56e2d(0x18f))]();return await _0x496c34[_0xb56e2d(0x1b9)](path_1[_0xb56e2d(0x18f)][_0xb56e2d(0x17a)](process['cwd'](),_0xb56e2d(0x176),_0xe32b07,DEPLOY_DIR_NAME)),_0x496c34;}async function insertZip(_0x5dce23,_0xfd844,_0x2f38a9,_0x54efac,_0x10dacf){const _0xb9d4aa=a86_0x43e194,_0x250445={'ParentId':_0xfd844,'Name':_0xb9d4aa(0x16b)+_0x2f38a9,'Description':_0xb9d4aa(0x16b)+_0x54efac,'Body':_0x10dacf},{data:_0x5f089f}=await _0x5dce23[_0xb9d4aa(0x174)](_0xb9d4aa(0x1a8)+constants_1[_0xb9d4aa(0x1af)]+_0xb9d4aa(0x190),_0x250445);return _0x5f089f['id'];}