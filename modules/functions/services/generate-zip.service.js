const a86_0x22ea39=a86_0x2ba0;(function(_0x13798c,_0x25ed8e){const _0x4c6465=a86_0x2ba0,_0x1821d1=_0x13798c();while(!![]){try{const _0x2431ea=parseInt(_0x4c6465(0x1a7))/0x1*(parseInt(_0x4c6465(0x1a9))/0x2)+parseInt(_0x4c6465(0x1bf))/0x3*(parseInt(_0x4c6465(0x1f9))/0x4)+parseInt(_0x4c6465(0x1e8))/0x5*(-parseInt(_0x4c6465(0x1c9))/0x6)+parseInt(_0x4c6465(0x1e6))/0x7*(-parseInt(_0x4c6465(0x1b4))/0x8)+parseInt(_0x4c6465(0x1ae))/0x9+-parseInt(_0x4c6465(0x1ee))/0xa+-parseInt(_0x4c6465(0x1bb))/0xb*(-parseInt(_0x4c6465(0x1fb))/0xc);if(_0x2431ea===_0x25ed8e)break;else _0x1821d1['push'](_0x1821d1['shift']());}catch(_0x2db06b){_0x1821d1['push'](_0x1821d1['shift']());}}}(a86_0x3431,0x567e3));const a86_0x1dfebe=(function(){let _0x1f7901=!![];return function(_0xac8117,_0x4daad0){const _0x3ede0d=_0x1f7901?function(){const _0x1a4fad=a86_0x2ba0;if(_0x4daad0){const _0x260af7=_0x4daad0[_0x1a4fad(0x1ed)](_0xac8117,arguments);return _0x4daad0=null,_0x260af7;}}:function(){};return _0x1f7901=![],_0x3ede0d;};}()),a86_0x53d125=a86_0x1dfebe(this,function(){const _0x1edc9a=a86_0x2ba0;return a86_0x53d125[_0x1edc9a(0x1da)]()['search'](_0x1edc9a(0x1f2))[_0x1edc9a(0x1da)]()[_0x1edc9a(0x1bc)](a86_0x53d125)[_0x1edc9a(0x1ea)](_0x1edc9a(0x1f2));});a86_0x53d125();'use strict';function a86_0x3431(){const _0x239388=['../../git/internal/fs.internal','14ZOnLov','UTF-8','46790trGjwf','then','search','writeFile','.temp','apply','2208970LoeZAU','DEPLOYZIP','values','ComponentsApi','(((.+)+)+)+$','src','base64','/sobjects/Attachment','MDApiWriter','buildObject','DEFLATE','4WAtAMF','types','708EAIinj','Builder','uuid','../utils/components-api','after\x20create\x20second\x20zip','fs/promises','xml2js','491681HRvJjp','Body','2IAhNUN','SALESFORCE_API_VERSION','orgId','push','substring','1846611JrgJQE','generateAsync','join','removeNamespacePrefix','type','filter','2150888uGSmNf','1.0','fetchAttachmentsDetailsById','Zip','after\x20create\x20zip','default','reduce','70631NdvNiY','constructor','retrieveAttachments','file','476547PQpskA','toBuffer','Name','fileName','destructiveChangesPost.xml','text','generateAndDeployZip','dir','log','../../git/parsers/mdapi','78ecqkVe','createZip','cwd','length','every','body','__esModule','adm-zip','MAX_ZIP_SIZE','unzip','../../shared/utils/fetch-attachments','Profile','Component_Name__c','replace','/services/data/','../utils/extract-component-permissions','files','toString','map','fetchAttachmentBody','path','fetchComponentsDetailsByComponentsHistory','PermissionSet','async','splitZip','fileType','indexOf','name'];a86_0x3431=function(){return _0x239388;};return a86_0x3431();}var __importDefault=this&&this['__importDefault']||function(_0x4f2a6b){const _0x42af48=a86_0x2ba0;return _0x4f2a6b&&_0x4f2a6b[_0x42af48(0x1cf)]?_0x4f2a6b:{'default':_0x4f2a6b};};Object['defineProperty'](exports,a86_0x22ea39(0x1cf),{'value':!![]}),exports[a86_0x22ea39(0x1c5)]=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require(a86_0x22ea39(0x1dd))),extract_component_permissions_1=require(a86_0x22ea39(0x1d8)),xml2js_1=require(a86_0x22ea39(0x1a6)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require(a86_0x22ea39(0x1c8)),fs_internal_1=require(a86_0x22ea39(0x1e5)),promises_1=require(a86_0x22ea39(0x1a5)),components_api_1=require(a86_0x22ea39(0x1a3)),adm_zip_1=__importDefault(require(a86_0x22ea39(0x1d0))),uuid_1=require(a86_0x22ea39(0x1fd)),fetch_attachments_1=require(a86_0x22ea39(0x1d3)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a86_0x22ea39(0x1c3),DEPLOY_DIR_NAME=a86_0x22ea39(0x1ef);async function generateAndDeployZip({attachmentsId:_0x14993a,isExtractComponentsPermissions:_0x4ea466,preDestructiveAttachmentId:_0x19b208,postDestructiveAttachmentId:_0x5047c5,branchId:_0x347c4d,credentials:_0x5d77dc,metadataLogId:_0x43ce07,environments:_0x719be,metaTypes:_0x2ec49d},_0x685050){const _0x482920=a86_0x22ea39,_0x1e9c09=(0x0,uuid_1['v4'])();try{const _0x58ba98=await(0x0,fetch_attachments_1[_0x482920(0x1b6)])(_0x685050,_0x14993a),_0x5907ba=_0x58ba98[_0x482920(0x1ba)]((_0x318e9f,_0x2c7bb2)=>({..._0x318e9f,[_0x2c7bb2['Id']]:_0x2c7bb2[_0x482920(0x1c1)]}),{}),_0x1c263b=await getComponents(_0x58ba98,_0x685050,_0x5907ba),_0x248acb=await components_api_1[_0x482920(0x1f1)][_0x482920(0x1de)](_0x685050,_0x58ba98[_0x482920(0x1db)](({ParentId:_0x2afaca})=>_0x2afaca))[_0x482920(0x1e9)](_0xa42b21=>components_api_1[_0x482920(0x1f1)][_0x482920(0x1b1)](_0xa42b21));if(_0x4ea466){const _0x59f4ee=_0x1c263b[_0x482920(0x1b3)](({fileType:_0x56fc9e})=>_0x56fc9e===_0x482920(0x1d4)||_0x56fc9e===_0x482920(0x1df));await removePermission(_0x59f4ee,_0x248acb);}await replaceEnvironments(_0x2ec49d,_0x719be,_0x1c263b),await writeZip(_0x1c263b,_0x1e9c09),await generateAndWritePackageXML(_0x58ba98,_0x248acb,_0x1e9c09);_0x19b208&&await saveDestructiveChanges(_0x685050,_0x19b208,DESTRUCTIVE_CHANGES_PER_NAME,_0x1e9c09);_0x5047c5&&await saveDestructiveChanges(_0x685050,_0x5047c5,DESTRUCTIVE_CHANGES_POST_NAME,_0x1e9c09);const _0x39dfd4=(await createDeployZip(_0x1e9c09)['then'](_0x3ea505=>{return _0x3ea505;}))['toBuffer']()['toString'](_0x482920(0x1f4));console[_0x482920(0x1c7)](_0x482920(0x1b8));const _0x417ad5=_0x39dfd4[_0x482920(0x1cc)];if(_0x417ad5>=components_api_1[_0x482920(0x1d1)]){const _0x37d689=await createDeployZip(_0x1e9c09);console[_0x482920(0x1c7)](_0x482920(0x1a4));const [_0xb6e608,_0x44a013]=await components_api_1[_0x482920(0x1f1)][_0x482920(0x1e1)](_0x37d689,_0x417ad5),_0xcaebba=await insertZip(_0x685050,_0x347c4d,_0x5d77dc['orgId'],_0x43ce07,_0xb6e608[_0x482920(0x1c0)]()[_0x482920(0x1da)]('base64')),_0x49986e=await insertZip(_0x685050,_0x347c4d,_0x5d77dc[_0x482920(0x1ab)],_0x43ce07,_0x44a013['toBuffer']()[_0x482920(0x1da)](_0x482920(0x1f4)));return _0xcaebba+','+_0x49986e;}else return await insertZip(_0x685050,_0x347c4d,_0x5d77dc[_0x482920(0x1ab)],_0x43ce07,_0x39dfd4);}catch(_0x1bc462){throw _0x1bc462;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x482920(0x1b9)]['join'](process['cwd'](),'.temp',_0x1e9c09)))await(0x0,promises_1['rm'])(path_1[_0x482920(0x1b9)][_0x482920(0x1b0)](process[_0x482920(0x1cb)](),_0x482920(0x1ec),_0x1e9c09),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x4704de,_0x27a34e,_0x56d725){const _0x2eab3f=a86_0x22ea39,_0x58b192=[],_0x345d3b=await(0x0,fetch_attachments_1[_0x2eab3f(0x1bd)])(_0x4704de,_0x27a34e);return await getComponentFromZip(_0x345d3b,_0x56d725)['then'](_0xea3f7a=>{const _0x5313de=_0x2eab3f;_0x58b192[_0x5313de(0x1ac)](..._0xea3f7a);}),_0x58b192;}async function getComponentFromZip(_0x29bc4b,_0x3d8906){const _0x3edc20=a86_0x22ea39,_0x4fc59b=[];for(const _0x25e13a of _0x29bc4b){const _0xb5151b=await zip_1[_0x3edc20(0x1b7)][_0x3edc20(0x1d2)](_0x25e13a[_0x3edc20(0x1f0)]['Body']);for(const _0x42bf2a in _0xb5151b[_0x3edc20(0x1d9)]){!_0xb5151b[_0x3edc20(0x1d9)][_0x42bf2a][_0x3edc20(0x1c6)]&&_0x4fc59b['push']({'fileName':_0x42bf2a[_0x3edc20(0x1ad)](_0x42bf2a[_0x3edc20(0x1e3)]('/')+0x1),'fileType':_0x3d8906[_0x25e13a['id']],'body':_0x25e13a[_0x3edc20(0x1f0)][_0x3edc20(0x1a8)]});}}return _0x4fc59b;}function a86_0x2ba0(_0xad8df5,_0x25d71e){const _0x46a10a=a86_0x3431();return a86_0x2ba0=function(_0x53d125,_0x1dfebe){_0x53d125=_0x53d125-0x1a3;let _0x34319a=_0x46a10a[_0x53d125];return _0x34319a;},a86_0x2ba0(_0xad8df5,_0x25d71e);}async function removePermission(_0x570e78,_0x141fa9){const _0x4003a0=a86_0x22ea39;for(const _0x55eb8d of _0x570e78){const _0x142107=await zip_1[_0x4003a0(0x1b7)]['unzip'](_0x55eb8d['body']),_0x1d3a63=[];for(const _0x4751f3 in _0x142107[_0x4003a0(0x1d9)]){!_0x142107[_0x4003a0(0x1d9)][_0x4751f3]['dir']&&_0x1d3a63['push']({'fileName':_0x4751f3,'body':await _0x142107[_0x4003a0(0x1d9)][_0x4751f3][_0x4003a0(0x1e0)](_0x4003a0(0x1c4))});}const _0x3795c8=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x1d3a63[0x0][_0x4003a0(0x1ce)][_0x4003a0(0x1da)](),_0x141fa9,_0x55eb8d[_0x4003a0(0x1e2)]),_0x4bc7a2=new xml2js_1['Builder']({'xmldec':{'version':_0x4003a0(0x1b5),'encoding':_0x4003a0(0x1e7)}}),_0x574448=_0x4bc7a2[_0x4003a0(0x1f7)](_0x3795c8),_0x3deeb8=zip_1[_0x4003a0(0x1b7)][_0x4003a0(0x1ca)]();_0x3deeb8[_0x4003a0(0x1be)](_0x1d3a63[0x0][_0x4003a0(0x1c2)],_0x574448),_0x55eb8d[_0x4003a0(0x1ce)]=await _0x3deeb8[_0x4003a0(0x1af)]({'type':_0x4003a0(0x1f4),'compression':_0x4003a0(0x1f8),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x589557,_0x560d21,_0x270b14){const _0x5013f9=a86_0x22ea39;for(const _0x1410f0 of _0x270b14){if(_0x589557[_0x5013f9(0x1cd)](_0x296ff0=>_0x296ff0!==_0x1410f0[_0x5013f9(0x1e2)]))continue;const _0x2ead34=await zip_1['Zip'][_0x5013f9(0x1d2)](_0x1410f0['body']);for(const _0x2a716b in _0x2ead34[_0x5013f9(0x1d9)]){if(!_0x2ead34['files'][_0x2a716b][_0x5013f9(0x1c6)]){let _0x22ded1=await _0x2ead34[_0x5013f9(0x1d9)][_0x2a716b][_0x5013f9(0x1e0)](_0x5013f9(0x1c4));for(const _0x40dd1a of Object['keys'](_0x560d21)){const _0x29089b=new RegExp('%%'+_0x40dd1a+'%%','g');_0x22ded1=_0x22ded1[_0x5013f9(0x1d6)](_0x29089b,_0x560d21[_0x40dd1a]);}_0x2ead34[_0x5013f9(0x1be)](_0x2a716b,_0x22ded1);}}_0x1410f0[_0x5013f9(0x1ce)]=await _0x2ead34[_0x5013f9(0x1af)]({'type':_0x5013f9(0x1f4),'compression':_0x5013f9(0x1f8),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x5a4e69,_0x57991c){const _0x513bfa=a86_0x22ea39,_0x239aa5=new mdapi_1[(_0x513bfa(0x1f6))]({'components':_0x5a4e69,'sourceDir':path_1[_0x513bfa(0x1b9)]['join'](process[_0x513bfa(0x1cb)](),_0x513bfa(0x1ec),_0x57991c,DEPLOY_DIR_NAME,_0x513bfa(0x1f3)),'skipChildErrors':![]});await _0x239aa5['start']();}async function generateAndWritePackageXML(_0xf3c2a5,_0x2cd352,_0x4ebbf8){const _0x7850d6=a86_0x22ea39,_0x4e1566=getComponentsTypeAndName(_0xf3c2a5,_0x2cd352),_0x823b89=[...new Set(_0x4e1566['map'](_0x62f5b=>_0x62f5b[_0x7850d6(0x1b2)]))],_0x521039={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1[_0x7850d6(0x1aa)][_0x7850d6(0x1ad)](0x1)}};for(const _0x580d18 of _0x823b89){const _0x5d7bde=_0x4e1566[_0x7850d6(0x1b3)](_0x1d9f32=>_0x1d9f32['type']===_0x580d18)[_0x7850d6(0x1db)](_0x4c898f=>_0x4c898f[_0x7850d6(0x1e4)]),_0x805d02={'members':_0x5d7bde,'name':_0x580d18};_0x521039['Package'][_0x7850d6(0x1fa)]['push'](_0x805d02);}const _0x4174b9=new xml2js_1[(_0x7850d6(0x1fc))]({'xmldec':{'version':_0x7850d6(0x1b5),'encoding':_0x7850d6(0x1e7)}}),_0x2f566b=_0x4174b9[_0x7850d6(0x1f7)](_0x521039);await fs_internal_1['FS']['writeFile'](path_1[_0x7850d6(0x1b9)][_0x7850d6(0x1b0)](process['cwd'](),_0x7850d6(0x1ec),_0x4ebbf8,DEPLOY_DIR_NAME,_0x7850d6(0x1f3),'package.xml'),_0x2f566b);}function getComponentsTypeAndName(_0x5b90ba,_0x5c870b){const _0x4bc8ab=a86_0x22ea39;return _0x5b90ba[_0x4bc8ab(0x1ba)]((_0x451743,_0x173b39)=>{const _0x1281e4=_0x4bc8ab,_0x518370=_0x5c870b['find'](_0x52a76f=>_0x52a76f['Id']===_0x173b39['ParentId']);return _0x518370&&_0x451743[_0x1281e4(0x1ac)]({'name':_0x518370['Component__r'][_0x1281e4(0x1d5)],'type':_0x173b39['Name']}),_0x451743;},[]);}async function saveDestructiveChanges(_0x195ddf,_0x288027,_0x5be8ac,_0x4c32df){const _0x182ff4=a86_0x22ea39,_0x664d98=(await(0x0,fetch_attachments_1[_0x182ff4(0x1dc)])(_0x195ddf,_0x288027))[_0x182ff4(0x1da)]();await fs_internal_1['FS'][_0x182ff4(0x1eb)](path_1['default'][_0x182ff4(0x1b0)](process[_0x182ff4(0x1cb)](),'.temp',_0x4c32df,DEPLOY_DIR_NAME,_0x182ff4(0x1f3),_0x5be8ac),_0x664d98);}async function createDeployZip(_0x44a965){const _0x419308=a86_0x22ea39,_0x4bfb=new adm_zip_1[(_0x419308(0x1b9))]();return await _0x4bfb['addLocalFolder'](path_1[_0x419308(0x1b9)][_0x419308(0x1b0)](process[_0x419308(0x1cb)](),_0x419308(0x1ec),_0x44a965,DEPLOY_DIR_NAME)),_0x4bfb;}async function insertZip(_0x3c909e,_0x16f3b7,_0x1b7cad,_0x134efc,_0x128e7d){const _0x4761a7=a86_0x22ea39,_0x32ae76={'ParentId':_0x16f3b7,'Name':'BUILD'+_0x1b7cad,'Description':'BUILD'+_0x134efc,'Body':_0x128e7d},{data:_0x3c1b65}=await _0x3c909e['post'](_0x4761a7(0x1d7)+constants_1[_0x4761a7(0x1aa)]+_0x4761a7(0x1f5),_0x32ae76);return _0x3c1b65['id'];}