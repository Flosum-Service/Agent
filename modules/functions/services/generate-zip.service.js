const a54_0x39ee6f=a54_0x28d8;(function(_0x466104,_0x5cc2b7){const _0x29b9cd=a54_0x28d8,_0x2d9c79=_0x466104();while(!![]){try{const _0x37e231=-parseInt(_0x29b9cd(0x87))/0x1*(-parseInt(_0x29b9cd(0x68))/0x2)+parseInt(_0x29b9cd(0x6f))/0x3+-parseInt(_0x29b9cd(0x7f))/0x4+parseInt(_0x29b9cd(0x74))/0x5+-parseInt(_0x29b9cd(0x88))/0x6+parseInt(_0x29b9cd(0x80))/0x7*(parseInt(_0x29b9cd(0x9e))/0x8)+-parseInt(_0x29b9cd(0x6c))/0x9;if(_0x37e231===_0x5cc2b7)break;else _0x2d9c79['push'](_0x2d9c79['shift']());}catch(_0x101096){_0x2d9c79['push'](_0x2d9c79['shift']());}}}(a54_0x1aa5,0x44abb));function a54_0x28d8(_0x193bac,_0x20dea2){const _0x53763b=a54_0x1aa5();return a54_0x28d8=function(_0x101cfd,_0x4e17b){_0x101cfd=_0x101cfd-0x64;let _0x1aa579=_0x53763b[_0x101cfd];return _0x1aa579;},a54_0x28d8(_0x193bac,_0x20dea2);}const a54_0x4e17b=(function(){let _0x18bc73=!![];return function(_0x1e1672,_0x48ddde){const _0x3c2765=_0x18bc73?function(){const _0x46cd39=a54_0x28d8;if(_0x48ddde){const _0x118a07=_0x48ddde[_0x46cd39(0xb8)](_0x1e1672,arguments);return _0x48ddde=null,_0x118a07;}}:function(){};return _0x18bc73=![],_0x3c2765;};}()),a54_0x101cfd=a54_0x4e17b(this,function(){const _0x1288ad=a54_0x28d8;return a54_0x101cfd[_0x1288ad(0x81)]()[_0x1288ad(0x6d)](_0x1288ad(0x9c))[_0x1288ad(0x81)]()[_0x1288ad(0xb9)](a54_0x101cfd)['search'](_0x1288ad(0x9c));});a54_0x101cfd();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3f7ee2){const _0x428940=a54_0x28d8;return _0x3f7ee2&&_0x3f7ee2[_0x428940(0xa7)]?_0x3f7ee2:{'default':_0x3f7ee2};};Object[a54_0x39ee6f(0x67)](exports,a54_0x39ee6f(0xa7),{'value':!![]}),exports[a54_0x39ee6f(0xb2)]=void 0x0;const constants_1=require(a54_0x39ee6f(0xae)),path_1=__importDefault(require(a54_0x39ee6f(0x76))),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a54_0x39ee6f(0x79)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a54_0x39ee6f(0x7c)),promises_1=require(a54_0x39ee6f(0xaf)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a54_0x39ee6f(0xab))),uuid_1=require('uuid'),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a54_0x39ee6f(0x78),DEPLOY_DIR_NAME=a54_0x39ee6f(0xa2);async function generateAndDeployZip({attachmentsId:_0x3c2461,isExtractComponentsPermissions:_0x4ece67,preDestructiveAttachmentId:_0x4922ed,postDestructiveAttachmentId:_0x2aa370,branchId:_0x5a066e,credentials:_0x11bd58,metadataLogId:_0x5b0743,environments:_0x36cf93,metaTypes:_0x418918},_0x43ece6){const _0x44f5d3=a54_0x39ee6f,_0x14acce=(0x0,uuid_1['v4'])();try{const _0x534ef=await components_api_1['ComponentsApi']['fetchAttachmentsDetails'](_0x43ece6,_0x3c2461),_0x349951=_0x534ef[_0x44f5d3(0xa5)]((_0x4e10ba,_0x52eeee)=>({..._0x4e10ba,[_0x52eeee['Id']]:_0x52eeee[_0x44f5d3(0x89)]}),{}),_0x2ce2da=await getComponents(_0x534ef,_0x43ece6,_0x349951),_0x5f2bcf=await components_api_1['ComponentsApi'][_0x44f5d3(0x91)](_0x43ece6,_0x534ef[_0x44f5d3(0x8e)](({ParentId:_0x53a373})=>_0x53a373))[_0x44f5d3(0xaa)](_0x393613=>components_api_1[_0x44f5d3(0x7e)][_0x44f5d3(0x90)](_0x393613));if(_0x4ece67){const _0x477d88=_0x2ce2da[_0x44f5d3(0x8b)](({fileType:_0x34e9ea})=>_0x34e9ea==='Profile'||_0x34e9ea===_0x44f5d3(0xb7));await removePermission(_0x477d88,_0x5f2bcf);}await replaceEnvironments(_0x418918,_0x36cf93,_0x2ce2da),await writeZip(_0x2ce2da,_0x14acce),await generateAndWritePackageXML(_0x534ef,_0x5f2bcf,_0x14acce);_0x4922ed&&await saveDestructiveChanges(_0x43ece6,_0x4922ed,DESTRUCTIVE_CHANGES_PER_NAME,_0x14acce);_0x2aa370&&await saveDestructiveChanges(_0x43ece6,_0x2aa370,DESTRUCTIVE_CHANGES_POST_NAME,_0x14acce);const _0x2208a3=(await createDeployZip(_0x14acce)[_0x44f5d3(0xaa)](_0x3740f2=>{return _0x3740f2;}))[_0x44f5d3(0xb0)]()[_0x44f5d3(0x81)]('base64');console[_0x44f5d3(0x97)](_0x44f5d3(0x93));const _0x1e85dc=_0x2208a3[_0x44f5d3(0x96)];if(_0x1e85dc>=components_api_1['MAX_ZIP_SIZE']){const _0x4e9808=await createDeployZip(_0x14acce);console[_0x44f5d3(0x97)](_0x44f5d3(0x77));const [_0x2cc3d4,_0x5b85af]=await components_api_1[_0x44f5d3(0x7e)]['splitZip'](_0x4e9808,_0x1e85dc),_0x24ae67=await insertZip(_0x43ece6,_0x5a066e,_0x11bd58[_0x44f5d3(0xb3)],_0x5b0743,_0x2cc3d4[_0x44f5d3(0xb0)]()[_0x44f5d3(0x81)](_0x44f5d3(0x6b))),_0x547c65=await insertZip(_0x43ece6,_0x5a066e,_0x11bd58[_0x44f5d3(0xb3)],_0x5b0743,_0x5b85af[_0x44f5d3(0xb0)]()[_0x44f5d3(0x81)](_0x44f5d3(0x6b)));return _0x24ae67+','+_0x547c65;}else return await insertZip(_0x43ece6,_0x5a066e,_0x11bd58[_0x44f5d3(0xb3)],_0x5b0743,_0x2208a3);}catch(_0x1a34a5){throw _0x1a34a5;}finally{if(await fs_internal_1['FS'][_0x44f5d3(0xac)](path_1[_0x44f5d3(0xad)][_0x44f5d3(0x8c)](process[_0x44f5d3(0x84)](),_0x44f5d3(0x6a),_0x14acce)))await(0x0,promises_1['rm'])(path_1[_0x44f5d3(0xad)][_0x44f5d3(0x8c)](process[_0x44f5d3(0x84)](),_0x44f5d3(0x6a),_0x14acce),{'recursive':!![]});}}exports[a54_0x39ee6f(0xb2)]=generateAndDeployZip;async function getComponents(_0x13dcc9,_0x360218,_0x19b1da){const _0x256aab=a54_0x39ee6f,_0x4bc4af=[],_0x3da874=await components_api_1[_0x256aab(0x7e)][_0x256aab(0x66)](_0x13dcc9,_0x360218);return await getComponentFromZip(_0x3da874,_0x19b1da)['then'](_0x17a4ae=>{const _0x2f1be0=_0x256aab;_0x4bc4af[_0x2f1be0(0xb6)](..._0x17a4ae);}),_0x4bc4af;}async function getComponentFromZip(_0x125648,_0x584b93){const _0x3271f6=a54_0x39ee6f,_0x2e278c=[];for(const _0x5f399d of _0x125648){const _0x1d1127=await zip_1[_0x3271f6(0x7d)][_0x3271f6(0x83)](_0x5f399d[_0x3271f6(0x7b)][_0x3271f6(0xb1)]);for(const _0x24d7c5 in _0x1d1127['files']){!_0x1d1127[_0x3271f6(0x65)][_0x24d7c5][_0x3271f6(0xa9)]&&_0x2e278c[_0x3271f6(0xb6)]({'fileName':_0x24d7c5[_0x3271f6(0x75)](_0x24d7c5['indexOf']('/')+0x1),'fileType':_0x584b93[_0x5f399d['id']],'body':_0x5f399d[_0x3271f6(0x7b)]['Body']});}}return _0x2e278c;}async function removePermission(_0x32c893,_0xd02111){const _0x2b86b1=a54_0x39ee6f;for(const _0x222257 of _0x32c893){const _0x25a821=await zip_1[_0x2b86b1(0x7d)][_0x2b86b1(0x83)](_0x222257['body']),_0x4e0fe4=[];for(const _0xbe7fed in _0x25a821[_0x2b86b1(0x65)]){!_0x25a821['files'][_0xbe7fed][_0x2b86b1(0xa9)]&&_0x4e0fe4[_0x2b86b1(0xb6)]({'fileName':_0xbe7fed,'body':await _0x25a821[_0x2b86b1(0x65)][_0xbe7fed][_0x2b86b1(0x98)](_0x2b86b1(0xa1))});}const _0xdca6f5=await(0x0,extract_component_permissions_1[_0x2b86b1(0x9f)])(_0x4e0fe4[0x0][_0x2b86b1(0x70)][_0x2b86b1(0x81)](),_0xd02111,_0x222257['fileType']),_0x129685=new xml2js_1[(_0x2b86b1(0x8d))]({'xmldec':{'version':_0x2b86b1(0xa4),'encoding':_0x2b86b1(0xa0)}}),_0x5ac8cc=_0x129685[_0x2b86b1(0xa3)](_0xdca6f5),_0x54130d=zip_1[_0x2b86b1(0x7d)]['createZip']();_0x54130d[_0x2b86b1(0x64)](_0x4e0fe4[0x0][_0x2b86b1(0x92)],_0x5ac8cc),_0x222257[_0x2b86b1(0x70)]=await _0x54130d['generateAsync']({'type':_0x2b86b1(0x6b),'compression':_0x2b86b1(0x9b),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x186f58,_0x1d4a26,_0x26e673){const _0x326c3e=a54_0x39ee6f;for(const _0x4e0b77 of _0x26e673){if(_0x186f58[_0x326c3e(0x95)](_0x539cf7=>_0x539cf7!==_0x4e0b77[_0x326c3e(0x82)]))continue;const _0x1f7519=await zip_1[_0x326c3e(0x7d)]['unzip'](_0x4e0b77[_0x326c3e(0x70)]);for(const _0x14dd2b in _0x1f7519[_0x326c3e(0x65)]){if(!_0x1f7519[_0x326c3e(0x65)][_0x14dd2b][_0x326c3e(0xa9)]){let _0x43d221=await _0x1f7519[_0x326c3e(0x65)][_0x14dd2b][_0x326c3e(0x98)]('text');for(const _0x1ff572 of Object[_0x326c3e(0x94)](_0x1d4a26)){const _0x3a822d=new RegExp('%%'+_0x1ff572+'%%','g');_0x43d221=_0x43d221[_0x326c3e(0x99)](_0x3a822d,_0x1d4a26[_0x1ff572]);}_0x1f7519[_0x326c3e(0x64)](_0x14dd2b,_0x43d221);}}_0x4e0b77[_0x326c3e(0x70)]=await _0x1f7519['generateAsync']({'type':'base64','compression':_0x326c3e(0x9b),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x3d4cd2,_0x21637a){const _0x3c3ac8=a54_0x39ee6f,_0x536a84=new mdapi_1[(_0x3c3ac8(0x72))]({'components':_0x3d4cd2,'sourceDir':path_1['default']['join'](process[_0x3c3ac8(0x84)](),_0x3c3ac8(0x6a),_0x21637a,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x536a84[_0x3c3ac8(0x85)]();}async function generateAndWritePackageXML(_0x4c342e,_0x2f4ea8,_0x368e26){const _0xc18ce7=a54_0x39ee6f,_0xabd83=getComponentsTypeAndName(_0x4c342e,_0x2f4ea8),_0x112c14=[...new Set(_0xabd83[_0xc18ce7(0x8e)](_0x765c96=>_0x765c96['type']))],_0x425c76={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION'][_0xc18ce7(0x75)](0x1)}};for(const _0x273649 of _0x112c14){const _0xfdfe1c=_0xabd83[_0xc18ce7(0x8b)](_0x1b2392=>_0x1b2392[_0xc18ce7(0xba)]===_0x273649)[_0xc18ce7(0x8e)](_0x27d74e=>_0x27d74e[_0xc18ce7(0x73)]),_0x410d13={'members':_0xfdfe1c,'name':_0x273649};_0x425c76['Package'][_0xc18ce7(0x8a)][_0xc18ce7(0xb6)](_0x410d13);}const _0x487dc2=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x4b4bf1=_0x487dc2[_0xc18ce7(0xa3)](_0x425c76);await fs_internal_1['FS'][_0xc18ce7(0x6e)](path_1['default']['join'](process[_0xc18ce7(0x84)](),'.temp',_0x368e26,DEPLOY_DIR_NAME,_0xc18ce7(0xa6),'package.xml'),_0x4b4bf1);}function getComponentsTypeAndName(_0x19b2ae,_0x3b9082){const _0x359976=a54_0x39ee6f;return _0x19b2ae[_0x359976(0xa5)]((_0x2167b7,_0x11b483)=>{const _0x100b69=_0x359976,_0xaf2fd7=_0x3b9082[_0x100b69(0xa8)](_0x2cce22=>_0x2cce22['Id']===_0x11b483[_0x100b69(0x69)]);return _0xaf2fd7&&_0x2167b7[_0x100b69(0xb6)]({'name':_0xaf2fd7[_0x100b69(0x7a)][_0x100b69(0x86)],'type':_0x11b483[_0x100b69(0x89)]}),_0x2167b7;},[]);}async function saveDestructiveChanges(_0x4d385e,_0x256154,_0x2dff95,_0x16a2e7){const _0x7cafec=a54_0x39ee6f,_0x12f6d1=(await components_api_1[_0x7cafec(0x7e)][_0x7cafec(0x8f)](_0x4d385e,_0x256154))[_0x7cafec(0x81)]();await fs_internal_1['FS']['writeFile'](path_1[_0x7cafec(0xad)][_0x7cafec(0x8c)](process[_0x7cafec(0x84)](),_0x7cafec(0x6a),_0x16a2e7,DEPLOY_DIR_NAME,_0x7cafec(0xa6),_0x2dff95),_0x12f6d1);}function a54_0x1aa5(){const _0x554eb9=['DEPLOYZIP','buildObject','1.0','reduce','src','__esModule','find','dir','then','adm-zip','exists','default','../../../constants','fs/promises','toBuffer','Body','generateAndDeployZip','orgId','/sobjects/Attachment','BUILD','push','PermissionSet','apply','constructor','type','file','files','retrieveAttachments','defineProperty','8888ozGdtW','ParentId','.temp','base64','3666132ROmQrg','search','writeFile','1469133cVVzgY','body','/services/data/','MDApiWriter','name','1756280ZpvGMV','substring','path','after\x20create\x20second\x20zip','destructiveChangesPost.xml','xml2js','Component__r','values','../../git/internal/fs.internal','Zip','ComponentsApi','570668EvOSHE','93793TZGGOh','toString','fileType','unzip','cwd','start','Component_Name__c','73zvTmPN','2647686SCqBhN','Name','types','filter','join','Builder','map','fetchAttachmentBody','removeNamespacePrefix','fetchComponentsDetailsByComponentsHistory','fileName','after\x20create\x20zip','keys','every','length','log','async','replace','post','DEFLATE','(((.+)+)+)+$','addLocalFolder','64izvAwl','extractComponentPermissions','UTF-8','text'];a54_0x1aa5=function(){return _0x554eb9;};return a54_0x1aa5();}async function createDeployZip(_0x39bc60){const _0x38533a=a54_0x39ee6f,_0x872303=new adm_zip_1['default']();return await _0x872303[_0x38533a(0x9d)](path_1[_0x38533a(0xad)][_0x38533a(0x8c)](process[_0x38533a(0x84)](),_0x38533a(0x6a),_0x39bc60,DEPLOY_DIR_NAME)),_0x872303;}async function insertZip(_0x399bf0,_0x260bb5,_0x4504b1,_0xdd67b8,_0x7c4fb0){const _0x562886=a54_0x39ee6f,_0x27371a={'ParentId':_0x260bb5,'Name':_0x562886(0xb5)+_0x4504b1,'Description':'BUILD'+_0xdd67b8,'Body':_0x7c4fb0},{data:_0x4e241e}=await _0x399bf0[_0x562886(0x9a)](_0x562886(0x71)+constants_1['SALESFORCE_API_VERSION']+_0x562886(0xb4),_0x27371a);return _0x4e241e['id'];}