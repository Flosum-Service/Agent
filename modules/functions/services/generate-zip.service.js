const a86_0x2e43f9=a86_0x3fb2;(function(_0x1e3263,_0x590bff){const _0x3a3549=a86_0x3fb2,_0x2c31b3=_0x1e3263();while(!![]){try{const _0xe27cdb=-parseInt(_0x3a3549(0x12a))/0x1*(parseInt(_0x3a3549(0x123))/0x2)+-parseInt(_0x3a3549(0x102))/0x3*(parseInt(_0x3a3549(0x149))/0x4)+-parseInt(_0x3a3549(0x11a))/0x5+-parseInt(_0x3a3549(0x14a))/0x6*(-parseInt(_0x3a3549(0x121))/0x7)+parseInt(_0x3a3549(0x14b))/0x8*(parseInt(_0x3a3549(0xfe))/0x9)+parseInt(_0x3a3549(0x122))/0xa*(-parseInt(_0x3a3549(0x14c))/0xb)+-parseInt(_0x3a3549(0x12d))/0xc*(-parseInt(_0x3a3549(0x115))/0xd);if(_0xe27cdb===_0x590bff)break;else _0x2c31b3['push'](_0x2c31b3['shift']());}catch(_0x3e85ca){_0x2c31b3['push'](_0x2c31b3['shift']());}}}(a86_0x43e2,0x984d2));const a86_0x2065de=(function(){let _0xdb3fda=!![];return function(_0xd47d2c,_0x14c6b5){const _0x43a6b6=_0xdb3fda?function(){const _0xb4c752=a86_0x3fb2;if(_0x14c6b5){const _0x39c01a=_0x14c6b5[_0xb4c752(0xfa)](_0xd47d2c,arguments);return _0x14c6b5=null,_0x39c01a;}}:function(){};return _0xdb3fda=![],_0x43a6b6;};}()),a86_0x560705=a86_0x2065de(this,function(){const _0xad41de=a86_0x3fb2;return a86_0x560705[_0xad41de(0x127)]()['search']('(((.+)+)+)+$')[_0xad41de(0x127)]()[_0xad41de(0x11c)](a86_0x560705)[_0xad41de(0x113)](_0xad41de(0x139));});a86_0x560705();'use strict';var __importDefault=this&&this[a86_0x2e43f9(0x111)]||function(_0x5dfcec){const _0x2323ac=a86_0x2e43f9;return _0x5dfcec&&_0x5dfcec[_0x2323ac(0x133)]?_0x5dfcec:{'default':_0x5dfcec};};function a86_0x3fb2(_0x5b70ff,_0x2b116e){const _0x35c13b=a86_0x43e2();return a86_0x3fb2=function(_0x560705,_0x2065de){_0x560705=_0x560705-0xf9;let _0x43e2e6=_0x35c13b[_0x560705];return _0x43e2e6;},a86_0x3fb2(_0x5b70ff,_0x2b116e);}function a86_0x43e2(){const _0x2c3f9e=['168316AXEfkC','push','dir','types','toString','package.xml','keys','2dtiFOJ','post','then','12AGczvf','execute','reduce','fetchComponentsDetailsByComponentsHistory','cwd','../utils/extract-component-permissions','__esModule','indexOf','adm-zip','toBuffer','unzip','removeNamespacePrefix','(((.+)+)+)+$','destructiveChangesPost.xml','file','@flosum/salesforce','body','default','every','/sobjects/Attachment','FOLDER_TO_METADATA_TYPE_MAP','Body','../../git/writers/mdapi.writer','values','DEFLATE','1.0','fs/promises','fileType','71844JHvggD','523710EQfvLF','8UTwMWT','1329460XvSaus','defineProperty','UTF-8','src','join','Zip','apply','../../shared/utils/fetch-attachments','Package','files','1768419UpMhbR','type','../utils/components-api','fileName','183cjbBcs','generateAsync','createZip','extractComponentPermissions','writeFile','Name','buildObject','MetadataConstants','Component_Name__c','map','length','base64','filter','ComponentsApi','http://soap.sforce.com/2006/04/metadata','__importDefault','MDApiWriter','search','splitZip','29611231ysoarn','BUILD','.temp','generateAndDeployZip','Builder','1488900OITSAX','substring','constructor','orgId','fetchAttachmentsDetailsById','destructiveChangesPre.xml','retrieveAttachments','35sIKtqz','60HStZvn'];a86_0x43e2=function(){return _0x2c3f9e;};return a86_0x43e2();}Object[a86_0x2e43f9(0x14d)](exports,'__esModule',{'value':!![]}),exports[a86_0x2e43f9(0x118)]=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require(a86_0x2e43f9(0x132)),xml2js_1=require('xml2js'),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require(a86_0x2e43f9(0x143)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a86_0x2e43f9(0x147)),components_api_1=require(a86_0x2e43f9(0x100)),adm_zip_1=__importDefault(require(a86_0x2e43f9(0x135))),uuid_1=require('uuid'),fetch_attachments_1=require(a86_0x2e43f9(0xfb)),salesforce_1=require(a86_0x2e43f9(0x13c)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x2e43f9(0x11f),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x2e43f9(0x13a),DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x5f18ff,isExtractComponentsPermissions:_0xf58769,preDestructiveAttachmentId:_0x149909,postDestructiveAttachmentId:_0x25a8b9,branchId:_0xa1324f,credentials:_0x38cee3,metadataLogId:_0x595cac,environments:_0x2db9f6,metaTypes:_0x4e5910,apiVersion:_0x341476},_0x58d725){const _0x4681ad=a86_0x2e43f9,_0x4a5e2b=(0x0,uuid_1['v4'])();try{const _0x2e8e06=await(0x0,fetch_attachments_1[_0x4681ad(0x11e)])(_0x58d725,_0x5f18ff),_0x236fbe=_0x2e8e06['reduce']((_0x43e448,_0x498871)=>({..._0x43e448,[_0x498871['Id']]:_0x498871['Name']}),{}),_0x3049bb=await getComponents(_0x2e8e06,_0x58d725,_0x236fbe),_0xd1b8e2=await components_api_1[_0x4681ad(0x10f)][_0x4681ad(0x130)](_0x58d725,_0x2e8e06[_0x4681ad(0x10b)](({ParentId:_0x5c52c4})=>_0x5c52c4),_0x341476)[_0x4681ad(0x12c)](_0x43eb77=>components_api_1[_0x4681ad(0x10f)][_0x4681ad(0x138)](_0x43eb77));if(_0xf58769){const _0x505452=_0x3049bb['filter'](({fileType:_0x9acb33})=>_0x9acb33==='Profile');await removePermission(_0x505452,_0xd1b8e2);}await replaceEnvironments(_0x4e5910,_0x2db9f6,_0x3049bb),await writeZip(_0x3049bb,_0x4a5e2b),await generateAndWritePackageXML(_0x2e8e06,_0xd1b8e2,_0x4a5e2b,_0x341476);_0x149909&&await saveDestructiveChanges(_0x58d725,_0x149909,DESTRUCTIVE_CHANGES_PER_NAME,_0x4a5e2b);_0x25a8b9&&await saveDestructiveChanges(_0x58d725,_0x25a8b9,DESTRUCTIVE_CHANGES_POST_NAME,_0x4a5e2b);const _0x3c75a9=(await createDeployZip(_0x4a5e2b)[_0x4681ad(0x12c)](_0x38f7da=>{return _0x38f7da;}))[_0x4681ad(0x136)]()[_0x4681ad(0x127)](_0x4681ad(0x10d)),_0x187ccd=_0x3c75a9[_0x4681ad(0x10c)];if(_0x187ccd>=components_api_1['MAX_ZIP_SIZE']){const _0x2b562b=await createDeployZip(_0x4a5e2b),[_0x3812a1,_0xa44079]=await components_api_1['ComponentsApi'][_0x4681ad(0x114)](_0x2b562b,_0x187ccd),_0x3508d3=await insertZip(_0x58d725,_0xa1324f,_0x38cee3['orgId'],_0x595cac,_0x3812a1[_0x4681ad(0x136)]()[_0x4681ad(0x127)](_0x4681ad(0x10d)),_0x341476),_0x4f631a=await insertZip(_0x58d725,_0xa1324f,_0x38cee3[_0x4681ad(0x11d)],_0x595cac,_0xa44079[_0x4681ad(0x136)]()[_0x4681ad(0x127)](_0x4681ad(0x10d)),_0x341476);return _0x3508d3+','+_0x4f631a;}else return await insertZip(_0x58d725,_0xa1324f,_0x38cee3['orgId'],_0x595cac,_0x3c75a9,_0x341476);}catch(_0x1dcd48){throw _0x1dcd48;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x4681ad(0x13e)][_0x4681ad(0x150)](process['cwd'](),_0x4681ad(0x117),_0x4a5e2b)))await(0x0,promises_1['rm'])(path_1['default']['join'](process[_0x4681ad(0x131)](),_0x4681ad(0x117),_0x4a5e2b),{'recursive':!![]});}}exports[a86_0x2e43f9(0x118)]=generateAndDeployZip;async function getComponents(_0x32240c,_0x42ddd7,_0x1a4164){const _0x2dd54e=a86_0x2e43f9,_0x567d0a=[],_0x391fcc=await(0x0,fetch_attachments_1[_0x2dd54e(0x120)])(_0x32240c,_0x42ddd7);return await getComponentFromZip(_0x391fcc,_0x1a4164)['then'](_0x5cce8f=>{const _0x1909c8=_0x2dd54e;_0x567d0a[_0x1909c8(0x124)](..._0x5cce8f);}),_0x567d0a;}async function getComponentFromZip(_0x566ef0,_0x3933f0){const _0x1e598f=a86_0x2e43f9,_0x4142a1=[];for(const _0x1934a5 of _0x566ef0){const _0x362b52=await zip_1[_0x1e598f(0xf9)][_0x1e598f(0x137)](_0x1934a5[_0x1e598f(0x144)][_0x1e598f(0x142)]);for(const _0x3746d6 in _0x362b52['files']){!_0x362b52[_0x1e598f(0xfd)][_0x3746d6][_0x1e598f(0x125)]&&_0x4142a1['push']({'fileName':_0x3746d6[_0x1e598f(0x11b)](_0x3746d6[_0x1e598f(0x134)]('/')+0x1),'fileType':_0x3933f0[_0x1934a5['id']],'body':_0x1934a5[_0x1e598f(0x144)]['Body']});}}return _0x4142a1;}async function removePermission(_0x47afc2,_0x2d88e2){const _0x239920=a86_0x2e43f9;for(const _0x5aecc0 of _0x47afc2){const _0xe570b3=await zip_1[_0x239920(0xf9)][_0x239920(0x137)](_0x5aecc0[_0x239920(0x13d)]),_0x1f53f6=[];for(const _0x31dda2 in _0xe570b3[_0x239920(0xfd)]){!_0xe570b3[_0x239920(0xfd)][_0x31dda2]['dir']&&_0x1f53f6[_0x239920(0x124)]({'fileName':_0x31dda2,'body':await _0xe570b3[_0x239920(0xfd)][_0x31dda2]['async']('text')});}const _0x50b332=await(0x0,extract_component_permissions_1[_0x239920(0x105)])(_0x1f53f6[0x0]['body']['toString'](),_0x2d88e2,_0x5aecc0[_0x239920(0x148)]),_0x429421=new xml2js_1[(_0x239920(0x119))]({'xmldec':{'version':_0x239920(0x146),'encoding':_0x239920(0x14e)}}),_0x4bae84=_0x429421[_0x239920(0x108)](_0x50b332),_0x26d545=zip_1['Zip'][_0x239920(0x104)]();_0x26d545[_0x239920(0x13b)](_0x1f53f6[0x0][_0x239920(0x101)],_0x4bae84),_0x5aecc0[_0x239920(0x13d)]=await _0x26d545['generateAsync']({'type':_0x239920(0x10d),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x3e7b7e,_0x3ba017,_0x1a6bc5){const _0x10b42a=a86_0x2e43f9;for(const _0x36f17e of _0x1a6bc5){if(_0x3e7b7e[_0x10b42a(0x13f)](_0x23ca02=>_0x23ca02!==_0x36f17e[_0x10b42a(0x148)]))continue;const _0x2e9692=await zip_1[_0x10b42a(0xf9)]['unzip'](_0x36f17e['body']);for(const _0x42977e in _0x2e9692[_0x10b42a(0xfd)]){if(!_0x2e9692['files'][_0x42977e][_0x10b42a(0x125)]){let _0x4f1646=await _0x2e9692[_0x10b42a(0xfd)][_0x42977e]['async']('text');for(const _0x547925 of Object[_0x10b42a(0x129)](_0x3ba017)){const _0x3607a1=new RegExp('%%'+_0x547925+'%%','g');_0x4f1646=_0x4f1646['replace'](_0x3607a1,_0x3ba017[_0x547925]);}_0x2e9692['file'](_0x42977e,_0x4f1646);}}_0x36f17e['body']=await _0x2e9692[_0x10b42a(0x103)]({'type':'base64','compression':_0x10b42a(0x145),'compressionOptions':{'level':0x6}});}}async function writeZip(_0xb8abe7,_0x314727){const _0x21afa4=a86_0x2e43f9,_0x2dec25=new mdapi_writer_1[(_0x21afa4(0x112))]({'components':_0xb8abe7,'sourceDir':path_1[_0x21afa4(0x13e)][_0x21afa4(0x150)](process['cwd'](),_0x21afa4(0x117),_0x314727,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x2dec25[_0x21afa4(0x12e)]();}async function generateAndWritePackageXML(_0x49f0a0,_0x10e836,_0x23b007,_0x912db5){const _0x469562=a86_0x2e43f9,_0x391c47=getComponentsTypeAndName(_0x49f0a0,_0x10e836),_0x61fd13=[...new Set(_0x391c47[_0x469562(0x10b)](_0x7b7d31=>_0x7b7d31[_0x469562(0xff)]))],_0x2814f6={'Package':{'$':{'xmlns':_0x469562(0x110)},'types':[],'version':''+_0x912db5}};for(const _0x4f60bb of _0x61fd13){const _0x118464=_0x391c47[_0x469562(0x10e)](_0x46220c=>_0x46220c[_0x469562(0xff)]===_0x4f60bb)[_0x469562(0x10b)](_0x41ce85=>_0x41ce85['name']),_0x3d2892={'members':_0x118464,'name':_0x4f60bb};_0x2814f6[_0x469562(0xfc)][_0x469562(0x126)]['push'](_0x3d2892);}const _0x47f099=new xml2js_1[(_0x469562(0x119))]({'xmldec':{'version':_0x469562(0x146),'encoding':_0x469562(0x14e)}}),_0x5b6763=_0x47f099[_0x469562(0x108)](_0x2814f6);await fs_internal_1['FS'][_0x469562(0x106)](path_1[_0x469562(0x13e)][_0x469562(0x150)](process[_0x469562(0x131)](),_0x469562(0x117),_0x23b007,DEPLOY_DIR_NAME,_0x469562(0x14f),_0x469562(0x128)),_0x5b6763);}function getComponentsTypeAndName(_0x2b7902,_0x29d2a9){const _0x5ce766=a86_0x2e43f9;return _0x2b7902[_0x5ce766(0x12f)]((_0xeb63f2,_0x42b6c3)=>{const _0x483f88=_0x5ce766,_0x124d76=_0x29d2a9['find'](_0x1cb81e=>_0x1cb81e['Id']===_0x42b6c3['ParentId']);return _0x124d76&&_0xeb63f2[_0x483f88(0x124)]({'name':_0x124d76['Component__r'][_0x483f88(0x10a)],'type':salesforce_1[_0x483f88(0x109)][_0x483f88(0x141)][_0x42b6c3[_0x483f88(0x107)]]||_0x42b6c3['Name']}),_0xeb63f2;},[]);}async function saveDestructiveChanges(_0xf42efe,_0x5009bf,_0x3a8214,_0x2fa060){const _0x1dfba0=a86_0x2e43f9,_0x2ec5eb=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0xf42efe,_0x5009bf))[_0x1dfba0(0x127)]();await fs_internal_1['FS'][_0x1dfba0(0x106)](path_1[_0x1dfba0(0x13e)]['join'](process[_0x1dfba0(0x131)](),'.temp',_0x2fa060,DEPLOY_DIR_NAME,_0x1dfba0(0x14f),_0x3a8214),_0x2ec5eb);}async function createDeployZip(_0x1b202b){const _0x592cf1=a86_0x2e43f9,_0x215bc2=new adm_zip_1[(_0x592cf1(0x13e))]();return await _0x215bc2['addLocalFolder'](path_1[_0x592cf1(0x13e)][_0x592cf1(0x150)](process[_0x592cf1(0x131)](),_0x592cf1(0x117),_0x1b202b,DEPLOY_DIR_NAME)),_0x215bc2;}async function insertZip(_0x4eb8b6,_0x112984,_0xc7116,_0x51c6b1,_0x353072,_0x288aaa){const _0x3d597e=a86_0x2e43f9,_0x4b92f2={'ParentId':_0x112984,'Name':'BUILD'+_0xc7116,'Description':_0x3d597e(0x116)+_0x51c6b1,'Body':_0x353072},{data:_0x3dd079}=await _0x4eb8b6[_0x3d597e(0x12b)]('/services/data/v'+_0x288aaa+_0x3d597e(0x140),_0x4b92f2);return _0x3dd079['id'];}