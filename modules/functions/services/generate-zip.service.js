const a85_0x30ea9d=a85_0x7674;function a85_0x1829(){const _0x4d0d3b=['BUILD','xml2js','destructiveChangesPre.xml','values','retrieveAttachments','MDApiWriter','(((.+)+)+)+$','Name','every','types','destructiveChangesPost.xml','start','async','156msZepe','extractComponentPermissions','DEPLOYZIP','push','body','18330idaqds','toString','name','MAX_ZIP_SIZE','../../shared/utils/fetch-attachments','12AFynJq','generateAndDeployZip','then','9vqQMIo','splitZip','buildObject','addLocalFolder','base64','createZip','file','post','1777832nzlFIK','175855qMYCJs','Package','fetchAttachmentsDetailsById','fetchAttachmentBody','package.xml','.temp','map','dir','6BmOipD','find','/sobjects/Attachment','Body','SALESFORCE_API_VERSION','../utils/extract-component-permissions','Profile','uuid','ParentId','cwd','filter','generateAsync','8230985WdvcJn','files','apply','UTF-8','orgId','37328478GqfDSu','toBuffer','default','writeFile','PermissionSet','__esModule','10566Qxdibl','1828490hkMXVO','type','fileType','exists','substring','reduce','Zip','text','1.0','Builder','ComponentsApi','../../git/parsers/utils/zip','64GeguSv','join','../../git/internal/fs.internal','indexOf','defineProperty','unzip','../utils/components-api','keys','Component_Name__c','../../git/parsers/mdapi','src'];a85_0x1829=function(){return _0x4d0d3b;};return a85_0x1829();}(function(_0x1ea989,_0x12759a){const _0x2f3321=a85_0x7674,_0x53fea7=_0x1ea989();while(!![]){try{const _0x3800c7=-parseInt(_0x2f3321(0x123))/0x1*(parseInt(_0x2f3321(0x148))/0x2)+-parseInt(_0x2f3321(0x14d))/0x3+-parseInt(_0x2f3321(0x130))/0x4*(parseInt(_0x2f3321(0x15e))/0x5)+parseInt(_0x2f3321(0x166))/0x6*(-parseInt(_0x2f3321(0x118))/0x7)+parseInt(_0x2f3321(0x15d))/0x8+parseInt(_0x2f3321(0x155))/0x9*(-parseInt(_0x2f3321(0x124))/0xa)+parseInt(_0x2f3321(0x11d))/0xb*(parseInt(_0x2f3321(0x152))/0xc);if(_0x3800c7===_0x12759a)break;else _0x53fea7['push'](_0x53fea7['shift']());}catch(_0x4e85e1){_0x53fea7['push'](_0x53fea7['shift']());}}}(a85_0x1829,0xd2f1d));const a85_0x402099=(function(){let _0x366ed2=!![];return function(_0x349222,_0x1c7fc4){const _0xf1f1dc=_0x366ed2?function(){const _0x2b2353=a85_0x7674;if(_0x1c7fc4){const _0x22eb67=_0x1c7fc4[_0x2b2353(0x11a)](_0x349222,arguments);return _0x1c7fc4=null,_0x22eb67;}}:function(){};return _0x366ed2=![],_0xf1f1dc;};}()),a85_0x5bd9aa=a85_0x402099(this,function(){const _0xe238df=a85_0x7674;return a85_0x5bd9aa['toString']()['search'](_0xe238df(0x141))[_0xe238df(0x14e)]()['constructor'](a85_0x5bd9aa)['search'](_0xe238df(0x141));});a85_0x5bd9aa();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x44134f){const _0xc1e8f0=a85_0x7674;return _0x44134f&&_0x44134f[_0xc1e8f0(0x122)]?_0x44134f:{'default':_0x44134f};};Object[a85_0x30ea9d(0x134)](exports,a85_0x30ea9d(0x122),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require('path')),extract_component_permissions_1=require(a85_0x30ea9d(0x16b)),xml2js_1=require(a85_0x30ea9d(0x13c)),zip_1=require(a85_0x30ea9d(0x12f)),mdapi_1=require(a85_0x30ea9d(0x139)),fs_internal_1=require(a85_0x30ea9d(0x132)),promises_1=require('fs/promises'),components_api_1=require(a85_0x30ea9d(0x136)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a85_0x30ea9d(0x16d)),fetch_attachments_1=require(a85_0x30ea9d(0x151)),DESTRUCTIVE_CHANGES_PER_NAME=a85_0x30ea9d(0x13d),DESTRUCTIVE_CHANGES_POST_NAME=a85_0x30ea9d(0x145),DEPLOY_DIR_NAME=a85_0x30ea9d(0x14a);async function generateAndDeployZip({attachmentsId:_0x2ab8b3,isExtractComponentsPermissions:_0x19aa5c,preDestructiveAttachmentId:_0x2c8faf,postDestructiveAttachmentId:_0x353b22,branchId:_0x11ea4e,credentials:_0x2baad6,metadataLogId:_0x487b76,environments:_0x15fd44,metaTypes:_0x3f34f6},_0x59b6d4){const _0x2d6edd=a85_0x30ea9d,_0x266082=(0x0,uuid_1['v4'])();try{const _0x11523a=await(0x0,fetch_attachments_1[_0x2d6edd(0x160)])(_0x59b6d4,_0x2ab8b3),_0x584ba9=_0x11523a[_0x2d6edd(0x129)]((_0x1761d7,_0x47228b)=>({..._0x1761d7,[_0x47228b['Id']]:_0x47228b['Name']}),{}),_0x480af1=await getComponents(_0x11523a,_0x59b6d4,_0x584ba9),_0xc745a4=await components_api_1[_0x2d6edd(0x12e)]['fetchComponentsDetailsByComponentsHistory'](_0x59b6d4,_0x11523a['map'](({ParentId:_0x44ee82})=>_0x44ee82))[_0x2d6edd(0x154)](_0x138060=>components_api_1[_0x2d6edd(0x12e)]['removeNamespacePrefix'](_0x138060));if(_0x19aa5c){const _0x1c840a=_0x480af1['filter'](({fileType:_0x484c8c})=>_0x484c8c===_0x2d6edd(0x16c)||_0x484c8c===_0x2d6edd(0x121));await removePermission(_0x1c840a,_0xc745a4);}await replaceEnvironments(_0x3f34f6,_0x15fd44,_0x480af1),await writeZip(_0x480af1,_0x266082),await generateAndWritePackageXML(_0x11523a,_0xc745a4,_0x266082);_0x2c8faf&&await saveDestructiveChanges(_0x59b6d4,_0x2c8faf,DESTRUCTIVE_CHANGES_PER_NAME,_0x266082);_0x353b22&&await saveDestructiveChanges(_0x59b6d4,_0x353b22,DESTRUCTIVE_CHANGES_POST_NAME,_0x266082);const _0x231d73=(await createDeployZip(_0x266082)[_0x2d6edd(0x154)](_0x5151ce=>{return _0x5151ce;}))[_0x2d6edd(0x11e)]()['toString']('base64');console['log']('after\x20create\x20zip');const _0x29917c=_0x231d73['length'];if(_0x29917c>=components_api_1[_0x2d6edd(0x150)]){const _0x5b2568=await createDeployZip(_0x266082);console['log']('after\x20create\x20second\x20zip');const [_0x4d07d1,_0x28450b]=await components_api_1[_0x2d6edd(0x12e)][_0x2d6edd(0x156)](_0x5b2568,_0x29917c),_0x5c47e5=await insertZip(_0x59b6d4,_0x11ea4e,_0x2baad6[_0x2d6edd(0x11c)],_0x487b76,_0x4d07d1[_0x2d6edd(0x11e)]()[_0x2d6edd(0x14e)](_0x2d6edd(0x159))),_0x19fb8d=await insertZip(_0x59b6d4,_0x11ea4e,_0x2baad6[_0x2d6edd(0x11c)],_0x487b76,_0x28450b['toBuffer']()[_0x2d6edd(0x14e)](_0x2d6edd(0x159)));return _0x5c47e5+','+_0x19fb8d;}else return await insertZip(_0x59b6d4,_0x11ea4e,_0x2baad6[_0x2d6edd(0x11c)],_0x487b76,_0x231d73);}catch(_0x3c18b7){throw _0x3c18b7;}finally{if(await fs_internal_1['FS'][_0x2d6edd(0x127)](path_1['default']['join'](process[_0x2d6edd(0x115)](),_0x2d6edd(0x163),_0x266082)))await(0x0,promises_1['rm'])(path_1[_0x2d6edd(0x11f)][_0x2d6edd(0x131)](process[_0x2d6edd(0x115)](),'.temp',_0x266082),{'recursive':!![]});}}exports[a85_0x30ea9d(0x153)]=generateAndDeployZip;async function getComponents(_0x3bb655,_0x56381e,_0x56828c){const _0x6d921d=a85_0x30ea9d,_0x4560b1=[],_0x46eb74=await(0x0,fetch_attachments_1[_0x6d921d(0x13f)])(_0x3bb655,_0x56381e);return await getComponentFromZip(_0x46eb74,_0x56828c)[_0x6d921d(0x154)](_0x766761=>{_0x4560b1['push'](..._0x766761);}),_0x4560b1;}function a85_0x7674(_0x389b04,_0x23f9a0){const _0xa405ca=a85_0x1829();return a85_0x7674=function(_0x5bd9aa,_0x402099){_0x5bd9aa=_0x5bd9aa-0x114;let _0x182916=_0xa405ca[_0x5bd9aa];return _0x182916;},a85_0x7674(_0x389b04,_0x23f9a0);}async function getComponentFromZip(_0x4d268f,_0x280604){const _0x56bf19=a85_0x30ea9d,_0x154702=[];for(const _0x2a56ba of _0x4d268f){const _0x1afb64=await zip_1[_0x56bf19(0x12a)]['unzip'](_0x2a56ba[_0x56bf19(0x13e)][_0x56bf19(0x169)]);for(const _0x19035f in _0x1afb64[_0x56bf19(0x119)]){!_0x1afb64[_0x56bf19(0x119)][_0x19035f][_0x56bf19(0x165)]&&_0x154702[_0x56bf19(0x14b)]({'fileName':_0x19035f[_0x56bf19(0x128)](_0x19035f[_0x56bf19(0x133)]('/')+0x1),'fileType':_0x280604[_0x2a56ba['id']],'body':_0x2a56ba[_0x56bf19(0x13e)][_0x56bf19(0x169)]});}}return _0x154702;}async function removePermission(_0x337748,_0x585bfe){const _0x23a8f7=a85_0x30ea9d;for(const _0x3d173a of _0x337748){const _0x3949f0=await zip_1[_0x23a8f7(0x12a)][_0x23a8f7(0x135)](_0x3d173a[_0x23a8f7(0x14c)]),_0x5515f2=[];for(const _0x509915 in _0x3949f0[_0x23a8f7(0x119)]){!_0x3949f0[_0x23a8f7(0x119)][_0x509915][_0x23a8f7(0x165)]&&_0x5515f2[_0x23a8f7(0x14b)]({'fileName':_0x509915,'body':await _0x3949f0[_0x23a8f7(0x119)][_0x509915][_0x23a8f7(0x147)](_0x23a8f7(0x12b))});}const _0x5385b6=await(0x0,extract_component_permissions_1[_0x23a8f7(0x149)])(_0x5515f2[0x0][_0x23a8f7(0x14c)][_0x23a8f7(0x14e)](),_0x585bfe,_0x3d173a[_0x23a8f7(0x126)]),_0x549906=new xml2js_1[(_0x23a8f7(0x12d))]({'xmldec':{'version':_0x23a8f7(0x12c),'encoding':_0x23a8f7(0x11b)}}),_0x362459=_0x549906[_0x23a8f7(0x157)](_0x5385b6),_0x58495d=zip_1[_0x23a8f7(0x12a)][_0x23a8f7(0x15a)]();_0x58495d[_0x23a8f7(0x15b)](_0x5515f2[0x0]['fileName'],_0x362459),_0x3d173a[_0x23a8f7(0x14c)]=await _0x58495d[_0x23a8f7(0x117)]({'type':_0x23a8f7(0x159),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x228462,_0x3a1d72,_0x484ba4){const _0x38f9ac=a85_0x30ea9d;for(const _0x27ea25 of _0x484ba4){if(_0x228462[_0x38f9ac(0x143)](_0x581eb4=>_0x581eb4!==_0x27ea25['fileType']))continue;const _0x504b6b=await zip_1['Zip'][_0x38f9ac(0x135)](_0x27ea25[_0x38f9ac(0x14c)]);for(const _0x851e85 in _0x504b6b[_0x38f9ac(0x119)]){if(!_0x504b6b['files'][_0x851e85][_0x38f9ac(0x165)]){let _0x8b8ec5=await _0x504b6b[_0x38f9ac(0x119)][_0x851e85][_0x38f9ac(0x147)]('text');for(const _0x506071 of Object[_0x38f9ac(0x137)](_0x3a1d72)){const _0x5ef972=new RegExp('%%'+_0x506071+'%%','g');_0x8b8ec5=_0x8b8ec5['replace'](_0x5ef972,_0x3a1d72[_0x506071]);}_0x504b6b[_0x38f9ac(0x15b)](_0x851e85,_0x8b8ec5);}}_0x27ea25[_0x38f9ac(0x14c)]=await _0x504b6b[_0x38f9ac(0x117)]({'type':_0x38f9ac(0x159),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x62c076,_0x337a7c){const _0x35201=a85_0x30ea9d,_0x5e9749=new mdapi_1[(_0x35201(0x140))]({'components':_0x62c076,'sourceDir':path_1[_0x35201(0x11f)][_0x35201(0x131)](process[_0x35201(0x115)](),_0x35201(0x163),_0x337a7c,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x5e9749[_0x35201(0x146)]();}async function generateAndWritePackageXML(_0x385667,_0x3c90f1,_0x28a0c6){const _0x5f7c87=a85_0x30ea9d,_0x389cd1=getComponentsTypeAndName(_0x385667,_0x3c90f1),_0x17dd6b=[...new Set(_0x389cd1[_0x5f7c87(0x164)](_0x45d66c=>_0x45d66c[_0x5f7c87(0x125)]))],_0x3c86d2={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION']['substring'](0x1)}};for(const _0xa80498 of _0x17dd6b){const _0x1263b2=_0x389cd1[_0x5f7c87(0x116)](_0x494df1=>_0x494df1['type']===_0xa80498)['map'](_0x4540d4=>_0x4540d4[_0x5f7c87(0x14f)]),_0x4811f7={'members':_0x1263b2,'name':_0xa80498};_0x3c86d2[_0x5f7c87(0x15f)][_0x5f7c87(0x144)][_0x5f7c87(0x14b)](_0x4811f7);}const _0x41be2d=new xml2js_1[(_0x5f7c87(0x12d))]({'xmldec':{'version':_0x5f7c87(0x12c),'encoding':'UTF-8'}}),_0x418e45=_0x41be2d['buildObject'](_0x3c86d2);await fs_internal_1['FS'][_0x5f7c87(0x120)](path_1[_0x5f7c87(0x11f)][_0x5f7c87(0x131)](process['cwd'](),'.temp',_0x28a0c6,DEPLOY_DIR_NAME,_0x5f7c87(0x13a),_0x5f7c87(0x162)),_0x418e45);}function getComponentsTypeAndName(_0x5a2725,_0x416ec3){const _0x113d7d=a85_0x30ea9d;return _0x5a2725[_0x113d7d(0x129)]((_0x56b877,_0x268631)=>{const _0x501657=_0x113d7d,_0x566940=_0x416ec3[_0x501657(0x167)](_0x364e45=>_0x364e45['Id']===_0x268631[_0x501657(0x114)]);return _0x566940&&_0x56b877[_0x501657(0x14b)]({'name':_0x566940['Component__r'][_0x501657(0x138)],'type':_0x268631[_0x501657(0x142)]}),_0x56b877;},[]);}async function saveDestructiveChanges(_0x55218b,_0x2b430c,_0x53881d,_0x343c7e){const _0x55087e=a85_0x30ea9d,_0x44de1f=(await(0x0,fetch_attachments_1[_0x55087e(0x161)])(_0x55218b,_0x2b430c))[_0x55087e(0x14e)]();await fs_internal_1['FS'][_0x55087e(0x120)](path_1[_0x55087e(0x11f)][_0x55087e(0x131)](process[_0x55087e(0x115)](),_0x55087e(0x163),_0x343c7e,DEPLOY_DIR_NAME,'src',_0x53881d),_0x44de1f);}async function createDeployZip(_0x1080ed){const _0x632754=a85_0x30ea9d,_0xbe976e=new adm_zip_1[(_0x632754(0x11f))]();return await _0xbe976e[_0x632754(0x158)](path_1[_0x632754(0x11f)]['join'](process['cwd'](),_0x632754(0x163),_0x1080ed,DEPLOY_DIR_NAME)),_0xbe976e;}async function insertZip(_0x8710b2,_0x13ea5b,_0x4595d1,_0x4681ec,_0x2cb4d4){const _0x4943b5=a85_0x30ea9d,_0x629f4e={'ParentId':_0x13ea5b,'Name':_0x4943b5(0x13b)+_0x4595d1,'Description':_0x4943b5(0x13b)+_0x4681ec,'Body':_0x2cb4d4},{data:_0x3939d4}=await _0x8710b2[_0x4943b5(0x15c)]('/services/data/'+constants_1[_0x4943b5(0x16a)]+_0x4943b5(0x168),_0x629f4e);return _0x3939d4['id'];}