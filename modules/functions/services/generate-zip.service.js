const a104_0x1a31c2=a104_0x25f6;(function(_0x4517c8,_0x4ce592){const _0x551488=a104_0x25f6,_0x8530a4=_0x4517c8();while(!![]){try{const _0x3d0b8a=parseInt(_0x551488(0x183))/0x1+-parseInt(_0x551488(0x1a1))/0x2+parseInt(_0x551488(0x1ac))/0x3*(-parseInt(_0x551488(0x17f))/0x4)+-parseInt(_0x551488(0x1d6))/0x5+parseInt(_0x551488(0x1b1))/0x6*(parseInt(_0x551488(0x1a3))/0x7)+-parseInt(_0x551488(0x1af))/0x8*(-parseInt(_0x551488(0x18c))/0x9)+-parseInt(_0x551488(0x189))/0xa;if(_0x3d0b8a===_0x4ce592)break;else _0x8530a4['push'](_0x8530a4['shift']());}catch(_0x40ba94){_0x8530a4['push'](_0x8530a4['shift']());}}}(a104_0x4e9f,0x43274));const a104_0x5da985=(function(){let _0x104413=!![];return function(_0x1c5445,_0x5a3524){const _0x37b30a=_0x104413?function(){const _0x3bf3c2=a104_0x25f6;if(_0x5a3524){const _0x5c9e25=_0x5a3524[_0x3bf3c2(0x1c1)](_0x1c5445,arguments);return _0x5a3524=null,_0x5c9e25;}}:function(){};return _0x104413=![],_0x37b30a;};}()),a104_0x192483=a104_0x5da985(this,function(){const _0x115b83=a104_0x25f6;return a104_0x192483[_0x115b83(0x1b8)]()[_0x115b83(0x1ce)]('(((.+)+)+)+$')[_0x115b83(0x1b8)]()['constructor'](a104_0x192483)[_0x115b83(0x1ce)](_0x115b83(0x196));});a104_0x192483();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x50c10a){const _0x1a8a17=a104_0x25f6;return _0x50c10a&&_0x50c10a[_0x1a8a17(0x1b4)]?_0x50c10a:{'default':_0x50c10a};};function a104_0x4e9f(){const _0x5e20bc=['../../git/parsers/utils/zip','ComponentsApi','find','orgId','execute','destructiveChangesPost.xml','indexOf','values','Logger','src','search','PERMISSION_SET','MDApiWriter','name','Zip','retrieveAttachments','mergeComponentPermissions','Package','378625ZvGYWu','destructiveChangesPre.xml','UTF-8','base64','writeFile','generateAndDeployZip','/services/data/v','default','MAX_ZIP_SIZE','636VzJBQt','Component_Name__c','file','replace','540226AkeILY','post','http://soap.sforce.com/2006/04/metadata','package.xml','listMetadataItem','Body','583160DCzZFm','reduce','cwd','1494AZzHrx','xml2js','types','async','generateAsync','fetchAttachmentBody','Builder','join','fileType','type','(((.+)+)+)+$','text','then','PartialRetrieve','BUILD','createZip','adm-zip','PermissionSet','length','fileName','@flosum/salesforce','910894QtzjZU','toBuffer','21QbTqEv','.temp','get','Profile','every','map','DeclarativeFilterOptions','FOLDER_TO_METADATA_TYPE_MAP','fetchAttachmentsDetailsById','627zVfPdf','unzip','MetadataType','4688TCCoCa','fetchComponentsDetailsByComponentsHistory','520554AUGQNO','1.0','body','__esModule','filter','path','substring','toString','push','Name','Component__r','DEFLATE','../utils/components-api','../../git/internal/fs.internal','../classes/logger','defineProperty','apply','buildObject','files'];a104_0x4e9f=function(){return _0x5e20bc;};return a104_0x4e9f();}Object[a104_0x1a31c2(0x1c0)](exports,a104_0x1a31c2(0x1b4),{'value':!![]}),exports[a104_0x1a31c2(0x17b)]=void 0x0;const path_1=__importDefault(require(a104_0x1a31c2(0x1b6))),extract_component_permissions_1=require('../utils/extract-component-permissions'),logger_1=require(a104_0x1a31c2(0x1bf)),xml2js_1=require(a104_0x1a31c2(0x18d)),zip_1=require(a104_0x1a31c2(0x1c4)),mdapi_writer_1=require('../../git/writers/mdapi.writer'),fs_internal_1=require(a104_0x1a31c2(0x1be)),promises_1=require('fs/promises'),components_api_1=require(a104_0x1a31c2(0x1bd)),adm_zip_1=__importDefault(require(a104_0x1a31c2(0x19c))),uuid_1=require('uuid'),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a104_0x1a31c2(0x1a0)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x1a31c2(0x1d7),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x1a31c2(0x1c9),DEPLOY_DIR_NAME='DEPLOYZIP',PERMISSION_SET_FOLDER_NAME='permissionsets';async function generateAndDeployZip({attachmentsId:_0x34e90b,isExtractComponentsPermissionSets:_0x51a854,isExtractComponentsProfiles:_0x11e7f9,preDestructiveAttachmentId:_0xed20b8,postDestructiveAttachmentId:_0x478a23,branchId:_0x3d22dd,credentials:_0x281e9a,metadataLogId:_0x34948c,environments:_0x5497ea,metaTypes:_0x42209f,apiVersion:_0x48522d},_0x4a509d,_0x5ceab8){const _0x5c7049=a104_0x1a31c2;var _0x1c4867;const _0x1dd6bb=(0x0,uuid_1['v4'])();try{const _0x3bc262=await(0x0,fetch_attachments_1[_0x5c7049(0x1ab)])(_0x4a509d,_0x34e90b),_0x2ca529=_0x3bc262['reduce']((_0x4f8bf4,_0x5e8f92)=>({..._0x4f8bf4,[_0x5e8f92['Id']]:_0x5e8f92[_0x5c7049(0x1ba)]}),{}),_0x4f37f0=await getComponents(_0x3bc262,_0x4a509d,_0x2ca529),_0x4e7ba0=await components_api_1[_0x5c7049(0x1c5)][_0x5c7049(0x1b0)](_0x4a509d,_0x3bc262[_0x5c7049(0x1a8)](({ParentId:_0x335ffb})=>_0x335ffb),_0x48522d)[_0x5c7049(0x198)](_0x599b6e=>components_api_1['ComponentsApi']['removeNamespacePrefix'](_0x599b6e));if(_0x11e7f9){const _0x4eac3b=_0x4f37f0[_0x5c7049(0x1b5)](({fileType:_0x92e4c})=>_0x92e4c===_0x5c7049(0x1a6));await removePermission(_0x4eac3b,_0x4e7ba0);}const _0x390f26=_0x4f37f0[_0x5c7049(0x1b5)](({fileType:_0x303e8c})=>_0x303e8c===_0x5c7049(0x19d));if(_0x390f26[_0x5c7049(0x19e)]&&_0x51a854){await removePermission(_0x390f26,_0x4e7ba0);const {items:_0x133ec2}=await retrieveTargetPermissionSets(_0x390f26,_0x48522d,_0x5ceab8);await mergePermissionSets(_0x390f26,((_0x1c4867=_0x133ec2['PermissionSet'])===null||_0x1c4867===void 0x0?void 0x0:_0x1c4867['components'])||[]);}await replaceEnvironments(_0x42209f,_0x5497ea,_0x4f37f0),await writeZip(_0x4f37f0,_0x1dd6bb),await generateAndWritePackageXML(_0x3bc262,_0x4e7ba0,_0x1dd6bb,_0x48522d);_0xed20b8&&await saveDestructiveChanges(_0x4a509d,_0xed20b8,DESTRUCTIVE_CHANGES_PER_NAME,_0x1dd6bb);_0x478a23&&await saveDestructiveChanges(_0x4a509d,_0x478a23,DESTRUCTIVE_CHANGES_POST_NAME,_0x1dd6bb);const _0x2437d6=(await createDeployZip(_0x1dd6bb)['then'](_0x527f33=>{return _0x527f33;}))[_0x5c7049(0x1a2)]()[_0x5c7049(0x1b8)]('base64'),_0x2655d3=_0x2437d6['length'];if(_0x2655d3>=components_api_1[_0x5c7049(0x17e)]){const _0x2443cb=await createDeployZip(_0x1dd6bb),[_0x49e719,_0x268f5e]=await components_api_1[_0x5c7049(0x1c5)]['splitZip'](_0x2443cb,_0x2655d3),_0x44171e=await insertZip(_0x4a509d,_0x3d22dd,_0x281e9a[_0x5c7049(0x1c7)],_0x34948c,_0x49e719['toBuffer']()['toString']('base64'),_0x48522d),_0x43dfb0=await insertZip(_0x4a509d,_0x3d22dd,_0x281e9a[_0x5c7049(0x1c7)],_0x34948c,_0x268f5e['toBuffer']()[_0x5c7049(0x1b8)](_0x5c7049(0x1d9)),_0x48522d);return _0x44171e+','+_0x43dfb0;}else return await insertZip(_0x4a509d,_0x3d22dd,_0x281e9a['orgId'],_0x34948c,_0x2437d6,_0x48522d);}catch(_0x180b04){throw _0x180b04;}finally{if(await fs_internal_1['FS']['exists'](path_1['default'][_0x5c7049(0x193)](process[_0x5c7049(0x18b)](),_0x5c7049(0x1a4),_0x1dd6bb)))await(0x0,promises_1['rm'])(path_1[_0x5c7049(0x17d)][_0x5c7049(0x193)](process[_0x5c7049(0x18b)](),_0x5c7049(0x1a4),_0x1dd6bb),{'recursive':!![]});}}exports[a104_0x1a31c2(0x17b)]=generateAndDeployZip;async function getComponents(_0x1c7474,_0x5c5966,_0x248b20){const _0x4803c0=a104_0x1a31c2,_0xb78918=[],_0xe92132=await(0x0,fetch_attachments_1[_0x4803c0(0x1d3)])(_0x1c7474,_0x5c5966);return await getComponentFromZip(_0xe92132,_0x248b20)[_0x4803c0(0x198)](_0x36982e=>{_0xb78918['push'](..._0x36982e);}),_0xb78918;}async function getComponentFromZip(_0x489f81,_0x8b151b){const _0x26c4d6=a104_0x1a31c2,_0x360d32=[];for(const _0x55feb6 of _0x489f81){const _0x5df103=await zip_1['Zip']['unzip'](_0x55feb6[_0x26c4d6(0x1cb)][_0x26c4d6(0x188)]);for(const _0x166b4e in _0x5df103[_0x26c4d6(0x1c3)]){!_0x5df103[_0x26c4d6(0x1c3)][_0x166b4e]['dir']&&_0x360d32['push']({'fileName':_0x166b4e[_0x26c4d6(0x1b7)](_0x166b4e[_0x26c4d6(0x1ca)]('/')+0x1),'fileType':_0x8b151b[_0x55feb6['id']],'body':_0x55feb6[_0x26c4d6(0x1cb)][_0x26c4d6(0x188)]});}}return _0x360d32;}async function removePermission(_0x400310,_0xd648aa){const _0x105b88=a104_0x1a31c2;for(const _0xefaaf3 of _0x400310){const _0x2168bc=await zip_1[_0x105b88(0x1d2)][_0x105b88(0x1ad)](_0xefaaf3[_0x105b88(0x1b3)]),_0x379c9f=[];for(const _0x4db860 in _0x2168bc[_0x105b88(0x1c3)]){!_0x2168bc[_0x105b88(0x1c3)][_0x4db860]['dir']&&_0x379c9f[_0x105b88(0x1b9)]({'fileName':_0x4db860,'body':await _0x2168bc['files'][_0x4db860]['async']('text')});}const _0x20923b=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x379c9f[0x0][_0x105b88(0x1b3)][_0x105b88(0x1b8)](),_0xd648aa,_0xefaaf3[_0x105b88(0x194)]),_0x145ebf=new xml2js_1[(_0x105b88(0x192))]({'xmldec':{'version':'1.0','encoding':_0x105b88(0x1d8)}}),_0x259ee1=_0x145ebf[_0x105b88(0x1c2)](_0x20923b),_0x3646e3=zip_1[_0x105b88(0x1d2)]['createZip']();_0x3646e3[_0x105b88(0x181)](_0x379c9f[0x0][_0x105b88(0x19f)],_0x259ee1),_0xefaaf3['body']=await _0x3646e3[_0x105b88(0x190)]({'type':_0x105b88(0x1d9),'compression':_0x105b88(0x1bc),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x2e33b0,_0x2e8e53,_0x5ac37f){const _0x113b9b=a104_0x1a31c2,_0x949807=_0x2e33b0[_0x113b9b(0x1a8)](_0x27e447=>PERMISSION_SET_FOLDER_NAME+'/'+_0x27e447[_0x113b9b(0x19f)])[_0x113b9b(0x193)](';'),_0x5ee7a8=[{'field':'fileName','option':salesforce_1[_0x113b9b(0x1a9)]['IN'],'value':_0x949807}],_0x115ef0=new logger_1[(_0x113b9b(0x1cc))]();return new salesforce_1[(_0x113b9b(0x199))](_0x2e8e53,_0x5ac37f,_0x115ef0,_0x5ee7a8,null,[salesforce_1[_0x113b9b(0x1ae)][_0x113b9b(0x1cf)]])[_0x113b9b(0x1c8)]();}async function mergePermissionSets(_0x43152f,_0x11a839){const _0x3094fb=a104_0x1a31c2,_0x497ff0=_0x11a839[_0x3094fb(0x18a)]((_0x57d80a,_0x3eabd9)=>_0x57d80a['set'](_0x3eabd9[_0x3094fb(0x187)][_0x3094fb(0x19f)],_0x3eabd9),new Map());for(const _0x4e46b6 of _0x43152f){const _0x21c007=PERMISSION_SET_FOLDER_NAME+'/'+_0x4e46b6[_0x3094fb(0x19f)],_0x30f6f1=_0x497ff0[_0x3094fb(0x1a5)](_0x21c007);if(!_0x30f6f1)continue;const _0x5d3c25=await zip_1[_0x3094fb(0x1d2)][_0x3094fb(0x1ad)](_0x4e46b6[_0x3094fb(0x1b3)]),_0xa2e4f7=await _0x5d3c25['files'][_0x21c007][_0x3094fb(0x18f)](_0x3094fb(0x197)),_0x54c1fd=_0x30f6f1[_0x3094fb(0x1c3)][_0x21c007]['toString'](),_0x4f8a45=await(0x0,extract_component_permissions_1[_0x3094fb(0x1d4)])(_0xa2e4f7,_0x54c1fd,_0x4e46b6['fileType']),_0x51a641=zip_1['Zip'][_0x3094fb(0x19b)]();_0x51a641[_0x3094fb(0x181)](_0x21c007,_0x4f8a45),_0x4e46b6[_0x3094fb(0x1b3)]=await _0x51a641[_0x3094fb(0x190)]({'type':_0x3094fb(0x1d9),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x246347,_0x4acb38,_0x3f5333){const _0x56e222=a104_0x1a31c2;for(const _0x388541 of _0x3f5333){if(_0x246347[_0x56e222(0x1a7)](_0x3354e2=>_0x3354e2!==_0x388541[_0x56e222(0x194)]))continue;const _0x431e84=await zip_1[_0x56e222(0x1d2)][_0x56e222(0x1ad)](_0x388541[_0x56e222(0x1b3)]);for(const _0x9ed205 in _0x431e84[_0x56e222(0x1c3)]){if(!_0x431e84['files'][_0x9ed205]['dir']){let _0x19ab6a=await _0x431e84[_0x56e222(0x1c3)][_0x9ed205]['async'](_0x56e222(0x197));for(const _0x23f50e of Object['keys'](_0x4acb38)){const _0x5f2b19=new RegExp('%%'+_0x23f50e+'%%','g');_0x19ab6a=_0x19ab6a[_0x56e222(0x182)](_0x5f2b19,_0x4acb38[_0x23f50e]);}_0x431e84['file'](_0x9ed205,_0x19ab6a);}}_0x388541[_0x56e222(0x1b3)]=await _0x431e84[_0x56e222(0x190)]({'type':_0x56e222(0x1d9),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}function a104_0x25f6(_0x962e07,_0x2c7c28){const _0x56066f=a104_0x4e9f();return a104_0x25f6=function(_0x192483,_0x5da985){_0x192483=_0x192483-0x17a;let _0x4e9f76=_0x56066f[_0x192483];return _0x4e9f76;},a104_0x25f6(_0x962e07,_0x2c7c28);}async function writeZip(_0x33861f,_0x59fb34){const _0x47b8cb=a104_0x1a31c2,_0x192c82=new mdapi_writer_1[(_0x47b8cb(0x1d0))]({'components':_0x33861f,'sourceDir':path_1[_0x47b8cb(0x17d)][_0x47b8cb(0x193)](process[_0x47b8cb(0x18b)](),'.temp',_0x59fb34,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x192c82[_0x47b8cb(0x1c8)]();}async function generateAndWritePackageXML(_0x13d33a,_0x55c08c,_0x277d9a,_0x305a2f){const _0x40f1ca=a104_0x1a31c2,_0x4b644b=getComponentsTypeAndName(_0x13d33a,_0x55c08c),_0x1baca5=[...new Set(_0x4b644b[_0x40f1ca(0x1a8)](_0x5208e0=>_0x5208e0[_0x40f1ca(0x195)]))],_0x5b149d={'Package':{'$':{'xmlns':_0x40f1ca(0x185)},'types':[],'version':''+_0x305a2f}};for(const _0x4ff232 of _0x1baca5){const _0x1c24e4=_0x4b644b[_0x40f1ca(0x1b5)](_0x3356b5=>_0x3356b5['type']===_0x4ff232)['map'](_0x3c510c=>_0x3c510c[_0x40f1ca(0x1d1)]),_0x3399a9={'members':_0x1c24e4,'name':_0x4ff232};_0x5b149d[_0x40f1ca(0x1d5)][_0x40f1ca(0x18e)][_0x40f1ca(0x1b9)](_0x3399a9);}const _0x2476b6=new xml2js_1['Builder']({'xmldec':{'version':_0x40f1ca(0x1b2),'encoding':_0x40f1ca(0x1d8)}}),_0x51cb67=_0x2476b6[_0x40f1ca(0x1c2)](_0x5b149d);await fs_internal_1['FS']['writeFile'](path_1['default'][_0x40f1ca(0x193)](process['cwd'](),_0x40f1ca(0x1a4),_0x277d9a,DEPLOY_DIR_NAME,_0x40f1ca(0x1cd),_0x40f1ca(0x186)),_0x51cb67);}function getComponentsTypeAndName(_0x56464f,_0x219d16){const _0x2926e3=a104_0x1a31c2;return _0x56464f[_0x2926e3(0x18a)]((_0x311e08,_0x44c5e5)=>{const _0x3cf716=_0x2926e3,_0x2f5248=_0x219d16[_0x3cf716(0x1c6)](_0x333912=>_0x333912['Id']===_0x44c5e5['ParentId']);return _0x2f5248&&_0x311e08[_0x3cf716(0x1b9)]({'name':_0x2f5248[_0x3cf716(0x1bb)][_0x3cf716(0x180)],'type':salesforce_1['MetadataConstants'][_0x3cf716(0x1aa)][_0x44c5e5[_0x3cf716(0x1ba)]]||_0x44c5e5[_0x3cf716(0x1ba)]}),_0x311e08;},[]);}async function saveDestructiveChanges(_0x9c4ff2,_0x4a128d,_0x482aca,_0x270ff9){const _0x2c18e3=a104_0x1a31c2,_0x148a30=(await(0x0,fetch_attachments_1[_0x2c18e3(0x191)])(_0x9c4ff2,_0x4a128d))[_0x2c18e3(0x1b8)]();await fs_internal_1['FS'][_0x2c18e3(0x17a)](path_1['default'][_0x2c18e3(0x193)](process['cwd'](),_0x2c18e3(0x1a4),_0x270ff9,DEPLOY_DIR_NAME,_0x2c18e3(0x1cd),_0x482aca),_0x148a30);}async function createDeployZip(_0x6becc9){const _0x3df2d3=a104_0x1a31c2,_0x250649=new adm_zip_1[(_0x3df2d3(0x17d))]();return await _0x250649['addLocalFolder'](path_1[_0x3df2d3(0x17d)]['join'](process['cwd'](),_0x3df2d3(0x1a4),_0x6becc9,DEPLOY_DIR_NAME)),_0x250649;}async function insertZip(_0x2e4c1d,_0x287118,_0x4bca27,_0x47b92a,_0x2a8ee6,_0x5c8199){const _0x436271=a104_0x1a31c2,_0x4b6cb5={'ParentId':_0x287118,'Name':_0x436271(0x19a)+_0x4bca27,'Description':_0x436271(0x19a)+_0x47b92a,'Body':_0x2a8ee6},{data:_0x5b290d}=await _0x2e4c1d[_0x436271(0x184)](_0x436271(0x17c)+_0x5c8199+'/sobjects/Attachment',_0x4b6cb5);return _0x5b290d['id'];}