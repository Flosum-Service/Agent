const a85_0x248b02=a85_0xbd92;(function(_0xdab018,_0x5a0f15){const _0x170a62=a85_0xbd92,_0x518d1c=_0xdab018();while(!![]){try{const _0x3bf487=-parseInt(_0x170a62(0x11a))/0x1*(parseInt(_0x170a62(0x121))/0x2)+-parseInt(_0x170a62(0x147))/0x3*(parseInt(_0x170a62(0x148))/0x4)+parseInt(_0x170a62(0x11c))/0x5*(-parseInt(_0x170a62(0x167))/0x6)+parseInt(_0x170a62(0x115))/0x7+-parseInt(_0x170a62(0x151))/0x8*(parseInt(_0x170a62(0x132))/0x9)+-parseInt(_0x170a62(0x14a))/0xa*(parseInt(_0x170a62(0x133))/0xb)+-parseInt(_0x170a62(0x125))/0xc*(-parseInt(_0x170a62(0x120))/0xd);if(_0x3bf487===_0x5a0f15)break;else _0x518d1c['push'](_0x518d1c['shift']());}catch(_0x7c0610){_0x518d1c['push'](_0x518d1c['shift']());}}}(a85_0x2c48,0xc2631));function a85_0x2c48(){const _0x5f432f=['search','files','MDApiWriter','330232GgKzYb','log','../../../constants','Package','file','.temp','toBuffer','fetchAttachmentsDetailsById','values','http://soap.sforce.com/2006/04/metadata','text','retrieveAttachments','Profile','Body','substring','xml2js','PermissionSet','fetchComponentsDetailsByComponentsHistory','toString','async','Zip','1.0','68142GsEmeE','generateAndDeployZip','push','fetchAttachmentBody','filter','exists','ParentId','fileName','destructiveChangesPre.xml','6237000mJhubH','createZip','../../git/parsers/mdapi','Name','constructor','627298MOXJnC','map','345MsvCzz','type','join','DEFLATE','131183sulqhS','2rnOFWV','cwd','find','Component__r','3960sRImpc','Component_Name__c','apply','every','../utils/extract-component-permissions','__importDefault','buildObject','removeNamespacePrefix','fileType','dir','generateAsync','replace','src','18SRJAEb','55737PDmckv','post','(((.+)+)+)+$','then','ComponentsApi','path','extractComponentPermissions','after\x20create\x20second\x20zip','default','base64','__esModule','unzip','SALESFORCE_API_VERSION','UTF-8','BUILD','orgId','../../git/internal/fs.internal','reduce','../utils/components-api','uuid','8133ucnRCT','1160tSioCf','writeFile','2260wOvSit','body','name','DEPLOYZIP'];a85_0x2c48=function(){return _0x5f432f;};return a85_0x2c48();}const a85_0x1762ef=(function(){let _0xad72f0=!![];return function(_0x282b55,_0x1a39fa){const _0xa0677d=_0xad72f0?function(){const _0x341832=a85_0xbd92;if(_0x1a39fa){const _0x128e45=_0x1a39fa[_0x341832(0x127)](_0x282b55,arguments);return _0x1a39fa=null,_0x128e45;}}:function(){};return _0xad72f0=![],_0xa0677d;};}()),a85_0x4a68e8=a85_0x1762ef(this,function(){const _0x24893f=a85_0xbd92;return a85_0x4a68e8['toString']()[_0x24893f(0x14e)]('(((.+)+)+)+$')[_0x24893f(0x163)]()[_0x24893f(0x119)](a85_0x4a68e8)[_0x24893f(0x14e)](_0x24893f(0x135));});a85_0x4a68e8();'use strict';var __importDefault=this&&this[a85_0x248b02(0x12a)]||function(_0x436df5){const _0x52636f=a85_0x248b02;return _0x436df5&&_0x436df5[_0x52636f(0x13d)]?_0x436df5:{'default':_0x436df5};};Object['defineProperty'](exports,a85_0x248b02(0x13d),{'value':!![]}),exports[a85_0x248b02(0x168)]=void 0x0;const constants_1=require(a85_0x248b02(0x153)),path_1=__importDefault(require(a85_0x248b02(0x138))),extract_component_permissions_1=require(a85_0x248b02(0x129)),xml2js_1=require(a85_0x248b02(0x160)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require(a85_0x248b02(0x117)),fs_internal_1=require(a85_0x248b02(0x143)),promises_1=require('fs/promises'),components_api_1=require(a85_0x248b02(0x145)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a85_0x248b02(0x146)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a85_0x248b02(0x114),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a85_0x248b02(0x14d);async function generateAndDeployZip({attachmentsId:_0x29e525,isExtractComponentsPermissions:_0x41d1ad,preDestructiveAttachmentId:_0x483ca2,postDestructiveAttachmentId:_0x1da756,branchId:_0x436403,credentials:_0x525d8a,metadataLogId:_0x47e46c,environments:_0x9cfd8d,metaTypes:_0x3dda3e},_0x16ad28){const _0x5e9602=a85_0x248b02,_0x4a9421=(0x0,uuid_1['v4'])();try{const _0x31fff2=await(0x0,fetch_attachments_1[_0x5e9602(0x158)])(_0x16ad28,_0x29e525),_0x243cde=_0x31fff2[_0x5e9602(0x144)]((_0x1fcf01,_0x716afe)=>({..._0x1fcf01,[_0x716afe['Id']]:_0x716afe[_0x5e9602(0x118)]}),{}),_0x36f0da=await getComponents(_0x31fff2,_0x16ad28,_0x243cde),_0x582ed0=await components_api_1[_0x5e9602(0x137)][_0x5e9602(0x162)](_0x16ad28,_0x31fff2[_0x5e9602(0x11b)](({ParentId:_0x1d4fd3})=>_0x1d4fd3))[_0x5e9602(0x136)](_0x4d5561=>components_api_1[_0x5e9602(0x137)][_0x5e9602(0x12c)](_0x4d5561));if(_0x41d1ad){const _0x388d7c=_0x36f0da[_0x5e9602(0x16b)](({fileType:_0x50381a})=>_0x50381a===_0x5e9602(0x15d)||_0x50381a===_0x5e9602(0x161));await removePermission(_0x388d7c,_0x582ed0);}await replaceEnvironments(_0x3dda3e,_0x9cfd8d,_0x36f0da),await writeZip(_0x36f0da,_0x4a9421),await generateAndWritePackageXML(_0x31fff2,_0x582ed0,_0x4a9421);_0x483ca2&&await saveDestructiveChanges(_0x16ad28,_0x483ca2,DESTRUCTIVE_CHANGES_PER_NAME,_0x4a9421);_0x1da756&&await saveDestructiveChanges(_0x16ad28,_0x1da756,DESTRUCTIVE_CHANGES_POST_NAME,_0x4a9421);const _0x246d60=(await createDeployZip(_0x4a9421)[_0x5e9602(0x136)](_0x41656a=>{return _0x41656a;}))[_0x5e9602(0x157)]()['toString'](_0x5e9602(0x13c));console[_0x5e9602(0x152)]('after\x20create\x20zip');const _0x5927d6=_0x246d60['length'];if(_0x5927d6>=components_api_1['MAX_ZIP_SIZE']){const _0x1a940f=await createDeployZip(_0x4a9421);console[_0x5e9602(0x152)](_0x5e9602(0x13a));const [_0x5a732e,_0x2e7a6b]=await components_api_1[_0x5e9602(0x137)]['splitZip'](_0x1a940f,_0x5927d6),_0x1c82ef=await insertZip(_0x16ad28,_0x436403,_0x525d8a[_0x5e9602(0x142)],_0x47e46c,_0x5a732e['toBuffer']()[_0x5e9602(0x163)]('base64')),_0x314898=await insertZip(_0x16ad28,_0x436403,_0x525d8a[_0x5e9602(0x142)],_0x47e46c,_0x2e7a6b[_0x5e9602(0x157)]()[_0x5e9602(0x163)]('base64'));return _0x1c82ef+','+_0x314898;}else return await insertZip(_0x16ad28,_0x436403,_0x525d8a[_0x5e9602(0x142)],_0x47e46c,_0x246d60);}catch(_0x4ba5c5){throw _0x4ba5c5;}finally{if(await fs_internal_1['FS'][_0x5e9602(0x16c)](path_1[_0x5e9602(0x13b)][_0x5e9602(0x11e)](process[_0x5e9602(0x122)](),_0x5e9602(0x156),_0x4a9421)))await(0x0,promises_1['rm'])(path_1['default']['join'](process['cwd'](),_0x5e9602(0x156),_0x4a9421),{'recursive':!![]});}}exports[a85_0x248b02(0x168)]=generateAndDeployZip;async function getComponents(_0x1d2cad,_0x3a5346,_0x1885bd){const _0x1ada99=a85_0x248b02,_0x2eac36=[],_0x1996c1=await(0x0,fetch_attachments_1[_0x1ada99(0x15c)])(_0x1d2cad,_0x3a5346);return await getComponentFromZip(_0x1996c1,_0x1885bd)['then'](_0x20278b=>{const _0x27d54b=_0x1ada99;_0x2eac36[_0x27d54b(0x169)](..._0x20278b);}),_0x2eac36;}async function getComponentFromZip(_0x59f281,_0x411593){const _0x27de8e=a85_0x248b02,_0x17999c=[];for(const _0x598ad of _0x59f281){const _0x5a3dfd=await zip_1['Zip'][_0x27de8e(0x13e)](_0x598ad[_0x27de8e(0x159)][_0x27de8e(0x15e)]);for(const _0x3d9cf8 in _0x5a3dfd[_0x27de8e(0x14f)]){!_0x5a3dfd['files'][_0x3d9cf8][_0x27de8e(0x12e)]&&_0x17999c[_0x27de8e(0x169)]({'fileName':_0x3d9cf8[_0x27de8e(0x15f)](_0x3d9cf8['indexOf']('/')+0x1),'fileType':_0x411593[_0x598ad['id']],'body':_0x598ad['values'][_0x27de8e(0x15e)]});}}return _0x17999c;}async function removePermission(_0x3fa37d,_0x416d50){const _0x4ae4f4=a85_0x248b02;for(const _0x2262e9 of _0x3fa37d){const _0x3dd4f6=await zip_1['Zip'][_0x4ae4f4(0x13e)](_0x2262e9['body']),_0x8faf4e=[];for(const _0x398398 in _0x3dd4f6['files']){!_0x3dd4f6[_0x4ae4f4(0x14f)][_0x398398]['dir']&&_0x8faf4e[_0x4ae4f4(0x169)]({'fileName':_0x398398,'body':await _0x3dd4f6[_0x4ae4f4(0x14f)][_0x398398][_0x4ae4f4(0x164)](_0x4ae4f4(0x15b))});}const _0xaba07a=await(0x0,extract_component_permissions_1[_0x4ae4f4(0x139)])(_0x8faf4e[0x0][_0x4ae4f4(0x14b)]['toString'](),_0x416d50,_0x2262e9[_0x4ae4f4(0x12d)]),_0xd1ff5b=new xml2js_1['Builder']({'xmldec':{'version':_0x4ae4f4(0x166),'encoding':_0x4ae4f4(0x140)}}),_0x54676d=_0xd1ff5b[_0x4ae4f4(0x12b)](_0xaba07a),_0x454630=zip_1[_0x4ae4f4(0x165)][_0x4ae4f4(0x116)]();_0x454630[_0x4ae4f4(0x155)](_0x8faf4e[0x0][_0x4ae4f4(0x113)],_0x54676d),_0x2262e9[_0x4ae4f4(0x14b)]=await _0x454630[_0x4ae4f4(0x12f)]({'type':'base64','compression':_0x4ae4f4(0x11f),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x5c6be1,_0x48d684,_0x1c8f80){const _0x2e3b01=a85_0x248b02;for(const _0x1c16fe of _0x1c8f80){if(_0x5c6be1[_0x2e3b01(0x128)](_0x3db205=>_0x3db205!==_0x1c16fe[_0x2e3b01(0x12d)]))continue;const _0xec7fa2=await zip_1[_0x2e3b01(0x165)][_0x2e3b01(0x13e)](_0x1c16fe[_0x2e3b01(0x14b)]);for(const _0xd6b1cd in _0xec7fa2[_0x2e3b01(0x14f)]){if(!_0xec7fa2[_0x2e3b01(0x14f)][_0xd6b1cd][_0x2e3b01(0x12e)]){let _0x4b888e=await _0xec7fa2[_0x2e3b01(0x14f)][_0xd6b1cd][_0x2e3b01(0x164)](_0x2e3b01(0x15b));for(const _0x45a2c3 of Object['keys'](_0x48d684)){const _0x501c5b=new RegExp('%%'+_0x45a2c3+'%%','g');_0x4b888e=_0x4b888e[_0x2e3b01(0x130)](_0x501c5b,_0x48d684[_0x45a2c3]);}_0xec7fa2[_0x2e3b01(0x155)](_0xd6b1cd,_0x4b888e);}}_0x1c16fe['body']=await _0xec7fa2[_0x2e3b01(0x12f)]({'type':_0x2e3b01(0x13c),'compression':_0x2e3b01(0x11f),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x298a0a,_0x4fd590){const _0x36cf1a=a85_0x248b02,_0x4401a9=new mdapi_1[(_0x36cf1a(0x150))]({'components':_0x298a0a,'sourceDir':path_1[_0x36cf1a(0x13b)][_0x36cf1a(0x11e)](process[_0x36cf1a(0x122)](),_0x36cf1a(0x156),_0x4fd590,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x4401a9['start']();}async function generateAndWritePackageXML(_0x5f64c5,_0x4649b5,_0x403f05){const _0x1dcd7e=a85_0x248b02,_0x3ea4d2=getComponentsTypeAndName(_0x5f64c5,_0x4649b5),_0x458356=[...new Set(_0x3ea4d2['map'](_0x51be52=>_0x51be52[_0x1dcd7e(0x11d)]))],_0x46e0f0={'Package':{'$':{'xmlns':_0x1dcd7e(0x15a)},'types':[],'version':''+constants_1[_0x1dcd7e(0x13f)][_0x1dcd7e(0x15f)](0x1)}};for(const _0x4b4cf0 of _0x458356){const _0x2f7870=_0x3ea4d2['filter'](_0x2a8b80=>_0x2a8b80['type']===_0x4b4cf0)[_0x1dcd7e(0x11b)](_0x2523f0=>_0x2523f0[_0x1dcd7e(0x14c)]),_0x4dbb3e={'members':_0x2f7870,'name':_0x4b4cf0};_0x46e0f0[_0x1dcd7e(0x154)]['types'][_0x1dcd7e(0x169)](_0x4dbb3e);}const _0x2ed4b5=new xml2js_1['Builder']({'xmldec':{'version':_0x1dcd7e(0x166),'encoding':'UTF-8'}}),_0x338f5c=_0x2ed4b5[_0x1dcd7e(0x12b)](_0x46e0f0);await fs_internal_1['FS'][_0x1dcd7e(0x149)](path_1['default'][_0x1dcd7e(0x11e)](process[_0x1dcd7e(0x122)](),_0x1dcd7e(0x156),_0x403f05,DEPLOY_DIR_NAME,_0x1dcd7e(0x131),'package.xml'),_0x338f5c);}function a85_0xbd92(_0x1df333,_0x48c162){const _0x50a05d=a85_0x2c48();return a85_0xbd92=function(_0x4a68e8,_0x1762ef){_0x4a68e8=_0x4a68e8-0x112;let _0x2c4874=_0x50a05d[_0x4a68e8];return _0x2c4874;},a85_0xbd92(_0x1df333,_0x48c162);}function getComponentsTypeAndName(_0x157340,_0x27ba93){const _0x300a2b=a85_0x248b02;return _0x157340[_0x300a2b(0x144)]((_0xdbc181,_0x45a650)=>{const _0x12869b=_0x300a2b,_0x1c68bc=_0x27ba93[_0x12869b(0x123)](_0x22c8ad=>_0x22c8ad['Id']===_0x45a650[_0x12869b(0x112)]);return _0x1c68bc&&_0xdbc181[_0x12869b(0x169)]({'name':_0x1c68bc[_0x12869b(0x124)][_0x12869b(0x126)],'type':_0x45a650[_0x12869b(0x118)]}),_0xdbc181;},[]);}async function saveDestructiveChanges(_0x537979,_0x529501,_0x2d477c,_0xd61db3){const _0x4f823e=a85_0x248b02,_0x1b15f2=(await(0x0,fetch_attachments_1[_0x4f823e(0x16a)])(_0x537979,_0x529501))[_0x4f823e(0x163)]();await fs_internal_1['FS'][_0x4f823e(0x149)](path_1[_0x4f823e(0x13b)][_0x4f823e(0x11e)](process[_0x4f823e(0x122)](),_0x4f823e(0x156),_0xd61db3,DEPLOY_DIR_NAME,_0x4f823e(0x131),_0x2d477c),_0x1b15f2);}async function createDeployZip(_0x104a32){const _0x165298=a85_0x248b02,_0x1edd0b=new adm_zip_1[(_0x165298(0x13b))]();return await _0x1edd0b['addLocalFolder'](path_1[_0x165298(0x13b)][_0x165298(0x11e)](process[_0x165298(0x122)](),_0x165298(0x156),_0x104a32,DEPLOY_DIR_NAME)),_0x1edd0b;}async function insertZip(_0x1b2fb8,_0x2e5e79,_0x1eda06,_0x50fe65,_0x3cc6d4){const _0x56255b=a85_0x248b02,_0x3a2079={'ParentId':_0x2e5e79,'Name':_0x56255b(0x141)+_0x1eda06,'Description':'BUILD'+_0x50fe65,'Body':_0x3cc6d4},{data:_0xbf1f9e}=await _0x1b2fb8[_0x56255b(0x134)]('/services/data/'+constants_1[_0x56255b(0x13f)]+'/sobjects/Attachment',_0x3a2079);return _0xbf1f9e['id'];}