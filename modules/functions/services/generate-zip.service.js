const a87_0x2e3df0=a87_0x56db;(function(_0x1af8da,_0x40bd78){const _0x2ad787=a87_0x56db,_0x5ba9a9=_0x1af8da();while(!![]){try{const _0x4b2f4f=parseInt(_0x2ad787(0xdd))/0x1+parseInt(_0x2ad787(0x127))/0x2+-parseInt(_0x2ad787(0xfd))/0x3*(parseInt(_0x2ad787(0x11f))/0x4)+-parseInt(_0x2ad787(0xcd))/0x5+-parseInt(_0x2ad787(0xe0))/0x6+-parseInt(_0x2ad787(0x122))/0x7*(-parseInt(_0x2ad787(0xde))/0x8)+-parseInt(_0x2ad787(0xf1))/0x9*(-parseInt(_0x2ad787(0xd0))/0xa);if(_0x4b2f4f===_0x40bd78)break;else _0x5ba9a9['push'](_0x5ba9a9['shift']());}catch(_0x594fcb){_0x5ba9a9['push'](_0x5ba9a9['shift']());}}}(a87_0x24b3,0xa1f04));const a87_0xe97194=(function(){let _0x8cf034=!![];return function(_0x3d6e3d,_0x4c136f){const _0x722d80=_0x8cf034?function(){if(_0x4c136f){const _0x3edabc=_0x4c136f['apply'](_0x3d6e3d,arguments);return _0x4c136f=null,_0x3edabc;}}:function(){};return _0x8cf034=![],_0x722d80;};}()),a87_0x202486=a87_0xe97194(this,function(){const _0x10f1a3=a87_0x56db;return a87_0x202486['toString']()['search'](_0x10f1a3(0x116))[_0x10f1a3(0x115)]()['constructor'](a87_0x202486)[_0x10f1a3(0xe5)]('(((.+)+)+)+$');});a87_0x202486();function a87_0x56db(_0x4e69e3,_0x491326){const _0x4afe2e=a87_0x24b3();return a87_0x56db=function(_0x202486,_0xe97194){_0x202486=_0x202486-0xcd;let _0x24b3aa=_0x4afe2e[_0x202486];return _0x24b3aa;},a87_0x56db(_0x4e69e3,_0x491326);}'use strict';var __importDefault=this&&this[a87_0x2e3df0(0xee)]||function(_0x58d7ab){const _0x2726c8=a87_0x2e3df0;return _0x58d7ab&&_0x58d7ab[_0x2726c8(0x111)]?_0x58d7ab:{'default':_0x58d7ab};};Object[a87_0x2e3df0(0xfa)](exports,'__esModule',{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require(a87_0x2e3df0(0x121))),extract_component_permissions_1=require('../utils/extract-component-permissions'),logger_1=require(a87_0x2e3df0(0xd6)),xml2js_1=require(a87_0x2e3df0(0xf2)),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require('../../git/writers/mdapi.writer'),fs_internal_1=require(a87_0x2e3df0(0xd8)),promises_1=require('fs/promises'),components_api_1=require(a87_0x2e3df0(0x11c)),adm_zip_1=__importDefault(require(a87_0x2e3df0(0x10c))),uuid_1=require(a87_0x2e3df0(0xfc)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a87_0x2e3df0(0xfb),PERMISSION_SET_FOLDER_NAME=a87_0x2e3df0(0x11b);async function generateAndDeployZip({attachmentsId:_0x2db2b4,isExtractComponentsPermissionSets:_0x739d96,isExtractComponentsProfiles:_0x362d65,preDestructiveAttachmentId:_0x28f86c,postDestructiveAttachmentId:_0x1d941c,branchId:_0x4adfa6,credentials:_0x3381a6,metadataLogId:_0x4d00ae,environments:_0xedfd11,metaTypes:_0x578f0d,apiVersion:_0x2c0524},_0x55572f,_0x4a1d2a){const _0x3deb53=a87_0x2e3df0;var _0x28ede9;const _0x5a0f51=(0x0,uuid_1['v4'])();try{const _0x5c4098=await(0x0,fetch_attachments_1[_0x3deb53(0xd1)])(_0x55572f,_0x2db2b4),_0x244d1c=_0x5c4098[_0x3deb53(0x105)]((_0x11618c,_0xe343b1)=>({..._0x11618c,[_0xe343b1['Id']]:_0xe343b1[_0x3deb53(0xf0)]}),{}),_0x580f40=await getComponents(_0x5c4098,_0x55572f,_0x244d1c),_0x21a47f=await components_api_1[_0x3deb53(0x124)][_0x3deb53(0xd5)](_0x55572f,_0x5c4098[_0x3deb53(0xe7)](({ParentId:_0x42b19f})=>_0x42b19f),_0x2c0524)[_0x3deb53(0xf5)](_0x4aed30=>components_api_1[_0x3deb53(0x124)]['removeNamespacePrefix'](_0x4aed30));if(_0x362d65){const _0x10e9f0=_0x580f40['filter'](({fileType:_0x163aa0})=>_0x163aa0===_0x3deb53(0x110));await removePermission(_0x10e9f0,_0x21a47f);}const _0x476940=_0x580f40['filter'](({fileType:_0x39fdfb})=>_0x39fdfb==='PermissionSet');if(_0x476940){if(_0x739d96){await removePermission(_0x476940,_0x21a47f);const {items:_0x2bd814}=await retrieveTargetPermissionSets(_0x476940,_0x2c0524,_0x4a1d2a);await mergePermissionSets(_0x476940,((_0x28ede9=_0x2bd814[_0x3deb53(0x109)])===null||_0x28ede9===void 0x0?void 0x0:_0x28ede9[_0x3deb53(0xe1)])||[]);}}await replaceEnvironments(_0x578f0d,_0xedfd11,_0x580f40),await writeZip(_0x580f40,_0x5a0f51),await generateAndWritePackageXML(_0x5c4098,_0x21a47f,_0x5a0f51,_0x2c0524);_0x28f86c&&await saveDestructiveChanges(_0x55572f,_0x28f86c,DESTRUCTIVE_CHANGES_PER_NAME,_0x5a0f51);_0x1d941c&&await saveDestructiveChanges(_0x55572f,_0x1d941c,DESTRUCTIVE_CHANGES_POST_NAME,_0x5a0f51);const _0x258c3a=(await createDeployZip(_0x5a0f51)[_0x3deb53(0xf5)](_0x466ece=>{return _0x466ece;}))['toBuffer']()[_0x3deb53(0x115)]('base64'),_0x5256c6=_0x258c3a[_0x3deb53(0x101)];if(_0x5256c6>=components_api_1[_0x3deb53(0x117)]){const _0x37b6da=await createDeployZip(_0x5a0f51),[_0x25891e,_0xfe4aea]=await components_api_1[_0x3deb53(0x124)][_0x3deb53(0xec)](_0x37b6da,_0x5256c6),_0x50bc10=await insertZip(_0x55572f,_0x4adfa6,_0x3381a6[_0x3deb53(0x10d)],_0x4d00ae,_0x25891e['toBuffer']()[_0x3deb53(0x115)](_0x3deb53(0xd7)),_0x2c0524),_0x1d1b49=await insertZip(_0x55572f,_0x4adfa6,_0x3381a6[_0x3deb53(0x10d)],_0x4d00ae,_0xfe4aea[_0x3deb53(0x10a)]()['toString'](_0x3deb53(0xd7)),_0x2c0524);return _0x50bc10+','+_0x1d1b49;}else return await insertZip(_0x55572f,_0x4adfa6,_0x3381a6[_0x3deb53(0x10d)],_0x4d00ae,_0x258c3a,_0x2c0524);}catch(_0x2215ff){throw _0x2215ff;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x3deb53(0x123)][_0x3deb53(0xff)](process[_0x3deb53(0xcf)](),_0x3deb53(0x107),_0x5a0f51)))await(0x0,promises_1['rm'])(path_1[_0x3deb53(0x123)][_0x3deb53(0xff)](process[_0x3deb53(0xcf)](),'.temp',_0x5a0f51),{'recursive':!![]});}}function a87_0x24b3(){const _0x4f5ff1=['values','Profile','__esModule','generateAndDeployZip','files','src','toString','(((.+)+)+)+$','MAX_ZIP_SIZE','file','mergeComponentPermissions','generateAsync','permissionsets','../utils/components-api','filter','unzip','8EImuiO','BUILD','path','14RazUOY','default','ComponentsApi','indexOf','set','593036XpAddG','text','5320535SvuGSa','PERMISSION_SET','cwd','220WqaAuR','fetchAttachmentsDetailsById','replace','body','/sobjects/Attachment','fetchComponentsDetailsByComponentsHistory','../classes/logger','base64','../../git/internal/fs.internal','async','substring','UTF-8','keys','109918Njgbvt','1250192XScYCA','Zip','2075106MXKeXa','components','MetadataType','Builder','retrieveAttachments','search','http://soap.sforce.com/2006/04/metadata','map','dir','Component__r','extractComponentPermissions','Body','splitZip','fileType','__importDefault','createZip','Name','701838NZueuA','xml2js','types','Package','then','1.0','FOLDER_TO_METADATA_TYPE_MAP','Logger','type','defineProperty','DEPLOYZIP','uuid','541995seaIHb','DEFLATE','join','writeFile','length','every','DeclarativeFilterOptions','post','reduce','buildObject','.temp','execute','PermissionSet','toBuffer','fileName','adm-zip','orgId','push'];a87_0x24b3=function(){return _0x4f5ff1;};return a87_0x24b3();}exports[a87_0x2e3df0(0x112)]=generateAndDeployZip;async function getComponents(_0x3ac563,_0x46a1c3,_0x33296f){const _0x1ef23e=a87_0x2e3df0,_0x107cc1=[],_0x3b3589=await(0x0,fetch_attachments_1[_0x1ef23e(0xe4)])(_0x3ac563,_0x46a1c3);return await getComponentFromZip(_0x3b3589,_0x33296f)[_0x1ef23e(0xf5)](_0x4d13a4=>{_0x107cc1['push'](..._0x4d13a4);}),_0x107cc1;}async function getComponentFromZip(_0x45132c,_0x313411){const _0x5ccfcf=a87_0x2e3df0,_0x96d35a=[];for(const _0x4fbf43 of _0x45132c){const _0x3f0df5=await zip_1[_0x5ccfcf(0xdf)]['unzip'](_0x4fbf43[_0x5ccfcf(0x10f)][_0x5ccfcf(0xeb)]);for(const _0x14dd77 in _0x3f0df5[_0x5ccfcf(0x113)]){!_0x3f0df5['files'][_0x14dd77]['dir']&&_0x96d35a[_0x5ccfcf(0x10e)]({'fileName':_0x14dd77[_0x5ccfcf(0xda)](_0x14dd77[_0x5ccfcf(0x125)]('/')+0x1),'fileType':_0x313411[_0x4fbf43['id']],'body':_0x4fbf43[_0x5ccfcf(0x10f)][_0x5ccfcf(0xeb)]});}}return _0x96d35a;}async function removePermission(_0x409b52,_0x420bf5){const _0x17b0c2=a87_0x2e3df0;for(const _0xab13e0 of _0x409b52){const _0x46cfd7=await zip_1['Zip'][_0x17b0c2(0x11e)](_0xab13e0[_0x17b0c2(0xd3)]),_0x24aea6=[];for(const _0xd89337 in _0x46cfd7[_0x17b0c2(0x113)]){!_0x46cfd7[_0x17b0c2(0x113)][_0xd89337][_0x17b0c2(0xe8)]&&_0x24aea6[_0x17b0c2(0x10e)]({'fileName':_0xd89337,'body':await _0x46cfd7[_0x17b0c2(0x113)][_0xd89337]['async'](_0x17b0c2(0x128))});}const _0xe3e6d7=await(0x0,extract_component_permissions_1[_0x17b0c2(0xea)])(_0x24aea6[0x0][_0x17b0c2(0xd3)][_0x17b0c2(0x115)](),_0x420bf5,_0xab13e0[_0x17b0c2(0xed)]),_0x38662f=new xml2js_1[(_0x17b0c2(0xe3))]({'xmldec':{'version':_0x17b0c2(0xf6),'encoding':_0x17b0c2(0xdb)}}),_0x374944=_0x38662f[_0x17b0c2(0x106)](_0xe3e6d7),_0x20d8ac=zip_1['Zip']['createZip']();_0x20d8ac[_0x17b0c2(0x118)](_0x24aea6[0x0][_0x17b0c2(0x10b)],_0x374944),_0xab13e0[_0x17b0c2(0xd3)]=await _0x20d8ac[_0x17b0c2(0x11a)]({'type':_0x17b0c2(0xd7),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x8b0ea3,_0x17a15e,_0x440240){const _0x63ad44=a87_0x2e3df0,_0x590d07=_0x8b0ea3[_0x63ad44(0xe7)](_0x54ca14=>PERMISSION_SET_FOLDER_NAME+'/'+_0x54ca14['fileName'])[_0x63ad44(0xff)](';'),_0x281771=[{'field':'fileName','option':salesforce_1[_0x63ad44(0x103)]['IN'],'value':_0x590d07}],_0xea45eb=new logger_1[(_0x63ad44(0xf8))]();return new salesforce_1['PartialRetrieve'](_0x17a15e,_0x440240,_0xea45eb,_0x281771,null,[salesforce_1[_0x63ad44(0xe2)][_0x63ad44(0xce)]])[_0x63ad44(0x108)]();}async function mergePermissionSets(_0x565b1b,_0x2843a7){const _0x4bbe36=a87_0x2e3df0,_0x22d6e4=_0x2843a7[_0x4bbe36(0x105)]((_0x361325,_0x38bf9b)=>_0x361325[_0x4bbe36(0x126)](_0x38bf9b['listMetadataItem'][_0x4bbe36(0x10b)],_0x38bf9b),new Map());for(const _0x2ea5d5 of _0x565b1b){const _0x3843ff=PERMISSION_SET_FOLDER_NAME+'/'+_0x2ea5d5[_0x4bbe36(0x10b)],_0x360626=_0x22d6e4['get'](_0x3843ff);if(!_0x360626)continue;const _0x24b4ba=await zip_1[_0x4bbe36(0xdf)][_0x4bbe36(0x11e)](_0x2ea5d5[_0x4bbe36(0xd3)]),_0x45815e=await _0x24b4ba[_0x4bbe36(0x113)][_0x3843ff][_0x4bbe36(0xd9)](_0x4bbe36(0x128)),_0x3a792b=_0x360626['files'][_0x3843ff]['toString'](),_0x4d2c2d=await(0x0,extract_component_permissions_1[_0x4bbe36(0x119)])(_0x45815e,_0x3a792b,_0x2ea5d5[_0x4bbe36(0xed)]),_0xc2dfa9=zip_1[_0x4bbe36(0xdf)][_0x4bbe36(0xef)]();_0xc2dfa9[_0x4bbe36(0x118)](_0x3843ff,_0x4d2c2d),_0x2ea5d5[_0x4bbe36(0xd3)]=await _0xc2dfa9[_0x4bbe36(0x11a)]({'type':_0x4bbe36(0xd7),'compression':_0x4bbe36(0xfe),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x3f4b30,_0x20f165,_0x4b90de){const _0x3331d8=a87_0x2e3df0;for(const _0x12e9fa of _0x4b90de){if(_0x3f4b30[_0x3331d8(0x102)](_0x3d7774=>_0x3d7774!==_0x12e9fa[_0x3331d8(0xed)]))continue;const _0x5bfdf2=await zip_1[_0x3331d8(0xdf)][_0x3331d8(0x11e)](_0x12e9fa[_0x3331d8(0xd3)]);for(const _0x26dd42 in _0x5bfdf2['files']){if(!_0x5bfdf2[_0x3331d8(0x113)][_0x26dd42][_0x3331d8(0xe8)]){let _0x227154=await _0x5bfdf2[_0x3331d8(0x113)][_0x26dd42][_0x3331d8(0xd9)]('text');for(const _0x44383a of Object[_0x3331d8(0xdc)](_0x20f165)){const _0x26a37a=new RegExp('%%'+_0x44383a+'%%','g');_0x227154=_0x227154[_0x3331d8(0xd2)](_0x26a37a,_0x20f165[_0x44383a]);}_0x5bfdf2[_0x3331d8(0x118)](_0x26dd42,_0x227154);}}_0x12e9fa['body']=await _0x5bfdf2['generateAsync']({'type':_0x3331d8(0xd7),'compression':_0x3331d8(0xfe),'compressionOptions':{'level':0x6}});}}async function writeZip(_0xddc233,_0x58aa81){const _0x54a1cd=a87_0x2e3df0,_0x1feaec=new mdapi_writer_1['MDApiWriter']({'components':_0xddc233,'sourceDir':path_1['default'][_0x54a1cd(0xff)](process['cwd'](),_0x54a1cd(0x107),_0x58aa81,DEPLOY_DIR_NAME,_0x54a1cd(0x114)),'skipChildErrors':![]});await _0x1feaec[_0x54a1cd(0x108)]();}async function generateAndWritePackageXML(_0x138246,_0x4d852c,_0x51ce87,_0x3e7e70){const _0x17940c=a87_0x2e3df0,_0x36fa21=getComponentsTypeAndName(_0x138246,_0x4d852c),_0x2632c7=[...new Set(_0x36fa21['map'](_0x1641e6=>_0x1641e6['type']))],_0x34c16b={'Package':{'$':{'xmlns':_0x17940c(0xe6)},'types':[],'version':''+_0x3e7e70}};for(const _0x509ca3 of _0x2632c7){const _0x3fb24a=_0x36fa21[_0x17940c(0x11d)](_0x2af388=>_0x2af388[_0x17940c(0xf9)]===_0x509ca3)[_0x17940c(0xe7)](_0x585d94=>_0x585d94['name']),_0xd3a185={'members':_0x3fb24a,'name':_0x509ca3};_0x34c16b[_0x17940c(0xf4)][_0x17940c(0xf3)][_0x17940c(0x10e)](_0xd3a185);}const _0x20eb6b=new xml2js_1[(_0x17940c(0xe3))]({'xmldec':{'version':_0x17940c(0xf6),'encoding':'UTF-8'}}),_0x97e99f=_0x20eb6b[_0x17940c(0x106)](_0x34c16b);await fs_internal_1['FS'][_0x17940c(0x100)](path_1[_0x17940c(0x123)]['join'](process[_0x17940c(0xcf)](),_0x17940c(0x107),_0x51ce87,DEPLOY_DIR_NAME,_0x17940c(0x114),'package.xml'),_0x97e99f);}function getComponentsTypeAndName(_0x15a0d3,_0x34acc7){return _0x15a0d3['reduce']((_0x44b976,_0x1b0db8)=>{const _0x1fb2c9=a87_0x56db,_0x14b870=_0x34acc7['find'](_0x455b4e=>_0x455b4e['Id']===_0x1b0db8['ParentId']);return _0x14b870&&_0x44b976[_0x1fb2c9(0x10e)]({'name':_0x14b870[_0x1fb2c9(0xe9)]['Component_Name__c'],'type':salesforce_1['MetadataConstants'][_0x1fb2c9(0xf7)][_0x1b0db8['Name']]||_0x1b0db8[_0x1fb2c9(0xf0)]}),_0x44b976;},[]);}async function saveDestructiveChanges(_0x46ba50,_0x4a669a,_0x137ce4,_0x325cd3){const _0xc8e455=a87_0x2e3df0,_0xe09603=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x46ba50,_0x4a669a))[_0xc8e455(0x115)]();await fs_internal_1['FS'][_0xc8e455(0x100)](path_1[_0xc8e455(0x123)]['join'](process[_0xc8e455(0xcf)](),'.temp',_0x325cd3,DEPLOY_DIR_NAME,_0xc8e455(0x114),_0x137ce4),_0xe09603);}async function createDeployZip(_0x50d2fa){const _0x262594=a87_0x2e3df0,_0x1046a2=new adm_zip_1[(_0x262594(0x123))]();return await _0x1046a2['addLocalFolder'](path_1[_0x262594(0x123)][_0x262594(0xff)](process[_0x262594(0xcf)](),'.temp',_0x50d2fa,DEPLOY_DIR_NAME)),_0x1046a2;}async function insertZip(_0x4fcab6,_0x337e33,_0xf9775b,_0x1e72d3,_0x267cae,_0xf05730){const _0x4cb2a1=a87_0x2e3df0,_0x50de4c={'ParentId':_0x337e33,'Name':_0x4cb2a1(0x120)+_0xf9775b,'Description':_0x4cb2a1(0x120)+_0x1e72d3,'Body':_0x267cae},{data:_0xd0ccbe}=await _0x4fcab6[_0x4cb2a1(0x104)]('/services/data/v'+_0xf05730+_0x4cb2a1(0xd4),_0x50de4c);return _0xd0ccbe['id'];}