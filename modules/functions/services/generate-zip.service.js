const a102_0x200eb3=a102_0x4ef1;(function(_0x120458,_0x4dc273){const _0xbe16a1=a102_0x4ef1,_0x27d884=_0x120458();while(!![]){try{const _0x283d4f=-parseInt(_0xbe16a1(0x10a))/0x1*(parseInt(_0xbe16a1(0x127))/0x2)+parseInt(_0xbe16a1(0xed))/0x3*(-parseInt(_0xbe16a1(0x113))/0x4)+-parseInt(_0xbe16a1(0x105))/0x5*(parseInt(_0xbe16a1(0xfd))/0x6)+-parseInt(_0xbe16a1(0x101))/0x7+parseInt(_0xbe16a1(0xeb))/0x8+-parseInt(_0xbe16a1(0xf2))/0x9*(-parseInt(_0xbe16a1(0xf0))/0xa)+parseInt(_0xbe16a1(0x123))/0xb*(parseInt(_0xbe16a1(0x110))/0xc);if(_0x283d4f===_0x4dc273)break;else _0x27d884['push'](_0x27d884['shift']());}catch(_0x5d9f98){_0x27d884['push'](_0x27d884['shift']());}}}(a102_0x363f,0x7646a));const a102_0x30c3e5=(function(){let _0x1e0580=!![];return function(_0x47390f,_0x157839){const _0xd1925a=_0x1e0580?function(){if(_0x157839){const _0xca8088=_0x157839['apply'](_0x47390f,arguments);return _0x157839=null,_0xca8088;}}:function(){};return _0x1e0580=![],_0xd1925a;};}()),a102_0x1fb592=a102_0x30c3e5(this,function(){const _0x1b5a5=a102_0x4ef1;return a102_0x1fb592[_0x1b5a5(0xfb)]()[_0x1b5a5(0x13a)](_0x1b5a5(0xfa))['toString']()[_0x1b5a5(0x11f)](a102_0x1fb592)[_0x1b5a5(0x13a)]('(((.+)+)+)+$');});function a102_0x363f(){const _0x1c53d2=['MAX_ZIP_SIZE','../utils/extract-component-permissions','DeclarativeFilterOptions','__importDefault','Zip','file','removeNamespacePrefix','http://soap.sforce.com/2006/04/metadata','text','files','Logger','search','createZip','join','push','adm-zip','mergeComponentPermissions','fileType','ComponentsApi','destructiveChangesPost.xml','.temp','fs/promises','../utils/components-api','Body','generateAndDeployZip','filter','UTF-8','length','listMetadataItem','fetchAttachmentBody','Profile','5094152PEuqRL','xml2js','3POcVjz','Component__r','set','40bSUizF','unzip','1318617hwuSmZ','PermissionSet','/services/data/v','../../git/parsers/utils/zip','async','package.xml','ParentId','base64','(((.+)+)+)+$','toString','indexOf','66lRPuam','MetadataConstants','generateAsync','orgId','3276637BDbXEn','destructiveChangesPre.xml','src','fileName','101185pwNdiJ','body','DEFLATE','execute','get','4274VNGkaR','then','uuid','Name','../../shared/utils/fetch-attachments','DEPLOYZIP','12CNUPJK','permissionsets','MetadataType','1557992qGLCHI','substring','Builder','post','type','dir','find','BUILD','default','writeFile','buildObject','cwd','constructor','components','exists','toBuffer','8790661ADEGNc','Package','keys','1.0','214WIkybt','map','/sobjects/Attachment','reduce','@flosum/salesforce','fetchComponentsDetailsByComponentsHistory','types','__esModule'];a102_0x363f=function(){return _0x1c53d2;};return a102_0x363f();}a102_0x1fb592();'use strict';var __importDefault=this&&this[a102_0x200eb3(0x132)]||function(_0xdf9555){const _0x4e93a4=a102_0x200eb3;return _0xdf9555&&_0xdf9555[_0x4e93a4(0x12e)]?_0xdf9555:{'default':_0xdf9555};};Object['defineProperty'](exports,a102_0x200eb3(0x12e),{'value':!![]}),exports[a102_0x200eb3(0x147)]=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require(a102_0x200eb3(0x130)),logger_1=require('../classes/logger'),xml2js_1=require(a102_0x200eb3(0xec)),zip_1=require(a102_0x200eb3(0xf5)),mdapi_writer_1=require('../../git/writers/mdapi.writer'),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a102_0x200eb3(0x144)),components_api_1=require(a102_0x200eb3(0x145)),adm_zip_1=__importDefault(require(a102_0x200eb3(0x13e))),uuid_1=require(a102_0x200eb3(0x10c)),fetch_attachments_1=require(a102_0x200eb3(0x10e)),salesforce_1=require(a102_0x200eb3(0x12b)),DESTRUCTIVE_CHANGES_PER_NAME=a102_0x200eb3(0x102),DESTRUCTIVE_CHANGES_POST_NAME=a102_0x200eb3(0x142),DEPLOY_DIR_NAME=a102_0x200eb3(0x10f),PERMISSION_SET_FOLDER_NAME=a102_0x200eb3(0x111);async function generateAndDeployZip({attachmentsId:_0x3b878e,isExtractComponentsPermissionSets:_0x5bef3f,isExtractComponentsProfiles:_0x5f46ed,preDestructiveAttachmentId:_0x54c6f6,postDestructiveAttachmentId:_0x4b0422,branchId:_0x4fb096,credentials:_0x302a8b,metadataLogId:_0x3f72ca,environments:_0xb10d25,metaTypes:_0x21df0a,apiVersion:_0x3e5f75},_0x46fcee,_0x1a3d89){const _0x3a1ab6=a102_0x200eb3;var _0x4c0e0c;const _0x50ba8a=(0x0,uuid_1['v4'])();try{const _0x1afc2d=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x46fcee,_0x3b878e),_0x27917a=_0x1afc2d[_0x3a1ab6(0x12a)]((_0x4b41c3,_0x1c72b9)=>({..._0x4b41c3,[_0x1c72b9['Id']]:_0x1c72b9['Name']}),{}),_0x3e8068=await getComponents(_0x1afc2d,_0x46fcee,_0x27917a),_0x36b63a=await components_api_1[_0x3a1ab6(0x141)][_0x3a1ab6(0x12c)](_0x46fcee,_0x1afc2d[_0x3a1ab6(0x128)](({ParentId:_0x8cef6c})=>_0x8cef6c),_0x3e5f75)[_0x3a1ab6(0x10b)](_0x5325c5=>components_api_1['ComponentsApi'][_0x3a1ab6(0x135)](_0x5325c5));if(_0x5f46ed){const _0x1716d8=_0x3e8068[_0x3a1ab6(0x148)](({fileType:_0x3ce095})=>_0x3ce095===_0x3a1ab6(0xea));await removePermission(_0x1716d8,_0x36b63a);}const _0x1e40d3=_0x3e8068['filter'](({fileType:_0x7686ef})=>_0x7686ef===_0x3a1ab6(0xf3));if(_0x1e40d3[_0x3a1ab6(0x14a)]&&_0x5bef3f){await removePermission(_0x1e40d3,_0x36b63a);const {items:_0x25ed13}=await retrieveTargetPermissionSets(_0x1e40d3,_0x3e5f75,_0x1a3d89);await mergePermissionSets(_0x1e40d3,((_0x4c0e0c=_0x25ed13['PermissionSet'])===null||_0x4c0e0c===void 0x0?void 0x0:_0x4c0e0c[_0x3a1ab6(0x120)])||[]);}await replaceEnvironments(_0x21df0a,_0xb10d25,_0x3e8068),await writeZip(_0x3e8068,_0x50ba8a),await generateAndWritePackageXML(_0x1afc2d,_0x36b63a,_0x50ba8a,_0x3e5f75);_0x54c6f6&&await saveDestructiveChanges(_0x46fcee,_0x54c6f6,DESTRUCTIVE_CHANGES_PER_NAME,_0x50ba8a);_0x4b0422&&await saveDestructiveChanges(_0x46fcee,_0x4b0422,DESTRUCTIVE_CHANGES_POST_NAME,_0x50ba8a);const _0x425bc8=(await createDeployZip(_0x50ba8a)[_0x3a1ab6(0x10b)](_0x31aad6=>{return _0x31aad6;}))[_0x3a1ab6(0x122)]()[_0x3a1ab6(0xfb)](_0x3a1ab6(0xf9)),_0x434e35=_0x425bc8[_0x3a1ab6(0x14a)];if(_0x434e35>=components_api_1[_0x3a1ab6(0x12f)]){const _0x54a0ae=await createDeployZip(_0x50ba8a),[_0x14abdd,_0x293342]=await components_api_1['ComponentsApi']['splitZip'](_0x54a0ae,_0x434e35),_0x153d0c=await insertZip(_0x46fcee,_0x4fb096,_0x302a8b[_0x3a1ab6(0x100)],_0x3f72ca,_0x14abdd[_0x3a1ab6(0x122)]()['toString']('base64'),_0x3e5f75),_0x5ced17=await insertZip(_0x46fcee,_0x4fb096,_0x302a8b['orgId'],_0x3f72ca,_0x293342[_0x3a1ab6(0x122)]()[_0x3a1ab6(0xfb)](_0x3a1ab6(0xf9)),_0x3e5f75);return _0x153d0c+','+_0x5ced17;}else return await insertZip(_0x46fcee,_0x4fb096,_0x302a8b[_0x3a1ab6(0x100)],_0x3f72ca,_0x425bc8,_0x3e5f75);}catch(_0x1f873f){throw _0x1f873f;}finally{if(await fs_internal_1['FS'][_0x3a1ab6(0x121)](path_1[_0x3a1ab6(0x11b)][_0x3a1ab6(0x13c)](process['cwd'](),_0x3a1ab6(0x143),_0x50ba8a)))await(0x0,promises_1['rm'])(path_1[_0x3a1ab6(0x11b)][_0x3a1ab6(0x13c)](process[_0x3a1ab6(0x11e)](),'.temp',_0x50ba8a),{'recursive':!![]});}}exports[a102_0x200eb3(0x147)]=generateAndDeployZip;async function getComponents(_0x55baab,_0x5c63c7,_0x3a3d8f){const _0x2fcfa3=a102_0x200eb3,_0x2f30b2=[],_0x40733d=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x55baab,_0x5c63c7);return await getComponentFromZip(_0x40733d,_0x3a3d8f)[_0x2fcfa3(0x10b)](_0xf1fdd0=>{const _0x2ee5e4=_0x2fcfa3;_0x2f30b2[_0x2ee5e4(0x13d)](..._0xf1fdd0);}),_0x2f30b2;}async function getComponentFromZip(_0x186c33,_0x20ca0c){const _0x258d01=a102_0x200eb3,_0x5c740a=[];for(const _0x4feeaa of _0x186c33){const _0x17f100=await zip_1[_0x258d01(0x133)][_0x258d01(0xf1)](_0x4feeaa['values'][_0x258d01(0x146)]);for(const _0x377248 in _0x17f100[_0x258d01(0x138)]){!_0x17f100[_0x258d01(0x138)][_0x377248]['dir']&&_0x5c740a['push']({'fileName':_0x377248[_0x258d01(0x114)](_0x377248[_0x258d01(0xfc)]('/')+0x1),'fileType':_0x20ca0c[_0x4feeaa['id']],'body':_0x4feeaa['values'][_0x258d01(0x146)]});}}return _0x5c740a;}async function removePermission(_0x6a8fbf,_0xc37001){const _0x27ec61=a102_0x200eb3;for(const _0xad72d5 of _0x6a8fbf){const _0x5e35b2=await zip_1[_0x27ec61(0x133)][_0x27ec61(0xf1)](_0xad72d5[_0x27ec61(0x106)]),_0x165ad2=[];for(const _0x2733d1 in _0x5e35b2[_0x27ec61(0x138)]){!_0x5e35b2[_0x27ec61(0x138)][_0x2733d1][_0x27ec61(0x118)]&&_0x165ad2[_0x27ec61(0x13d)]({'fileName':_0x2733d1,'body':await _0x5e35b2[_0x27ec61(0x138)][_0x2733d1][_0x27ec61(0xf6)]('text')});}const _0x5d33d1=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x165ad2[0x0][_0x27ec61(0x106)][_0x27ec61(0xfb)](),_0xc37001,_0xad72d5[_0x27ec61(0x140)]),_0x4857c6=new xml2js_1[(_0x27ec61(0x115))]({'xmldec':{'version':_0x27ec61(0x126),'encoding':'UTF-8'}}),_0x3c6ab9=_0x4857c6[_0x27ec61(0x11d)](_0x5d33d1),_0x148aa1=zip_1[_0x27ec61(0x133)][_0x27ec61(0x13b)]();_0x148aa1[_0x27ec61(0x134)](_0x165ad2[0x0][_0x27ec61(0x104)],_0x3c6ab9),_0xad72d5[_0x27ec61(0x106)]=await _0x148aa1[_0x27ec61(0xff)]({'type':_0x27ec61(0xf9),'compression':_0x27ec61(0x107),'compressionOptions':{'level':0x6}});}}function a102_0x4ef1(_0x2bfd22,_0x2ff9b7){const _0x545e89=a102_0x363f();return a102_0x4ef1=function(_0x1fb592,_0x30c3e5){_0x1fb592=_0x1fb592-0xea;let _0x363f37=_0x545e89[_0x1fb592];return _0x363f37;},a102_0x4ef1(_0x2bfd22,_0x2ff9b7);}async function retrieveTargetPermissionSets(_0x3a748e,_0x405ed9,_0x3e8ce7){const _0x13aa3d=a102_0x200eb3,_0x7750da=_0x3a748e[_0x13aa3d(0x128)](_0xe3831b=>PERMISSION_SET_FOLDER_NAME+'/'+_0xe3831b[_0x13aa3d(0x104)])[_0x13aa3d(0x13c)](';'),_0x34000f=[{'field':_0x13aa3d(0x104),'option':salesforce_1[_0x13aa3d(0x131)]['IN'],'value':_0x7750da}],_0x87c847=new logger_1[(_0x13aa3d(0x139))]();return new salesforce_1['PartialRetrieve'](_0x405ed9,_0x3e8ce7,_0x87c847,_0x34000f,null,[salesforce_1[_0x13aa3d(0x112)]['PERMISSION_SET']])[_0x13aa3d(0x108)]();}async function mergePermissionSets(_0x140fc8,_0x5cc556){const _0x29ba3e=a102_0x200eb3,_0xb75718=_0x5cc556[_0x29ba3e(0x12a)]((_0x407cd0,_0x4dbf69)=>_0x407cd0[_0x29ba3e(0xef)](_0x4dbf69[_0x29ba3e(0x14b)][_0x29ba3e(0x104)],_0x4dbf69),new Map());for(const _0x398b6c of _0x140fc8){const _0x47c9e2=PERMISSION_SET_FOLDER_NAME+'/'+_0x398b6c[_0x29ba3e(0x104)],_0x8cb50c=_0xb75718[_0x29ba3e(0x109)](_0x47c9e2);if(!_0x8cb50c)continue;const _0x4992d7=await zip_1[_0x29ba3e(0x133)]['unzip'](_0x398b6c[_0x29ba3e(0x106)]),_0x4c90e1=await _0x4992d7[_0x29ba3e(0x138)][_0x47c9e2][_0x29ba3e(0xf6)]('text'),_0x660fba=_0x8cb50c['files'][_0x47c9e2]['toString'](),_0x46f344=await(0x0,extract_component_permissions_1[_0x29ba3e(0x13f)])(_0x4c90e1,_0x660fba,_0x398b6c[_0x29ba3e(0x140)]),_0x406c9f=zip_1['Zip'][_0x29ba3e(0x13b)]();_0x406c9f[_0x29ba3e(0x134)](_0x47c9e2,_0x46f344),_0x398b6c['body']=await _0x406c9f['generateAsync']({'type':'base64','compression':_0x29ba3e(0x107),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x554135,_0x2e8be6,_0x48c98d){const _0x243924=a102_0x200eb3;for(const _0x38ed32 of _0x48c98d){if(_0x554135['every'](_0x5e7bf6=>_0x5e7bf6!==_0x38ed32[_0x243924(0x140)]))continue;const _0x74b668=await zip_1[_0x243924(0x133)]['unzip'](_0x38ed32['body']);for(const _0xbbc6d2 in _0x74b668['files']){if(!_0x74b668[_0x243924(0x138)][_0xbbc6d2][_0x243924(0x118)]){let _0x41c508=await _0x74b668[_0x243924(0x138)][_0xbbc6d2]['async'](_0x243924(0x137));for(const _0x55e6c4 of Object[_0x243924(0x125)](_0x2e8be6)){const _0x14432c=new RegExp('%%'+_0x55e6c4+'%%','g');_0x41c508=_0x41c508['replace'](_0x14432c,_0x2e8be6[_0x55e6c4]);}_0x74b668[_0x243924(0x134)](_0xbbc6d2,_0x41c508);}}_0x38ed32[_0x243924(0x106)]=await _0x74b668[_0x243924(0xff)]({'type':_0x243924(0xf9),'compression':_0x243924(0x107),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x44f6c7,_0x34621b){const _0xafd4de=a102_0x200eb3,_0x4e0e30=new mdapi_writer_1['MDApiWriter']({'components':_0x44f6c7,'sourceDir':path_1[_0xafd4de(0x11b)][_0xafd4de(0x13c)](process['cwd'](),_0xafd4de(0x143),_0x34621b,DEPLOY_DIR_NAME,_0xafd4de(0x103)),'skipChildErrors':![]});await _0x4e0e30['execute']();}async function generateAndWritePackageXML(_0x3861ca,_0x6af2be,_0x37d405,_0x443f83){const _0x308b43=a102_0x200eb3,_0x313ce1=getComponentsTypeAndName(_0x3861ca,_0x6af2be),_0x1ee71d=[...new Set(_0x313ce1[_0x308b43(0x128)](_0x3a3d17=>_0x3a3d17[_0x308b43(0x117)]))],_0x264053={'Package':{'$':{'xmlns':_0x308b43(0x136)},'types':[],'version':''+_0x443f83}};for(const _0x208cfd of _0x1ee71d){const _0x246e11=_0x313ce1[_0x308b43(0x148)](_0x42d1f8=>_0x42d1f8[_0x308b43(0x117)]===_0x208cfd)['map'](_0x43d4b4=>_0x43d4b4['name']),_0x245692={'members':_0x246e11,'name':_0x208cfd};_0x264053[_0x308b43(0x124)][_0x308b43(0x12d)][_0x308b43(0x13d)](_0x245692);}const _0x4b99e6=new xml2js_1[(_0x308b43(0x115))]({'xmldec':{'version':'1.0','encoding':_0x308b43(0x149)}}),_0x4834eb=_0x4b99e6[_0x308b43(0x11d)](_0x264053);await fs_internal_1['FS'][_0x308b43(0x11c)](path_1[_0x308b43(0x11b)][_0x308b43(0x13c)](process[_0x308b43(0x11e)](),_0x308b43(0x143),_0x37d405,DEPLOY_DIR_NAME,_0x308b43(0x103),_0x308b43(0xf7)),_0x4834eb);}function getComponentsTypeAndName(_0xda03bd,_0x47c26b){return _0xda03bd['reduce']((_0x1c6a83,_0x50f188)=>{const _0x270b7b=a102_0x4ef1,_0x272706=_0x47c26b[_0x270b7b(0x119)](_0x53df35=>_0x53df35['Id']===_0x50f188[_0x270b7b(0xf8)]);return _0x272706&&_0x1c6a83[_0x270b7b(0x13d)]({'name':_0x272706[_0x270b7b(0xee)]['Component_Name__c'],'type':salesforce_1[_0x270b7b(0xfe)]['FOLDER_TO_METADATA_TYPE_MAP'][_0x50f188[_0x270b7b(0x10d)]]||_0x50f188['Name']}),_0x1c6a83;},[]);}async function saveDestructiveChanges(_0x48b7fc,_0x2ef9f4,_0x34eb8c,_0x473d5f){const _0x2d1692=a102_0x200eb3,_0xa551b3=(await(0x0,fetch_attachments_1[_0x2d1692(0x14c)])(_0x48b7fc,_0x2ef9f4))[_0x2d1692(0xfb)]();await fs_internal_1['FS']['writeFile'](path_1[_0x2d1692(0x11b)][_0x2d1692(0x13c)](process[_0x2d1692(0x11e)](),_0x2d1692(0x143),_0x473d5f,DEPLOY_DIR_NAME,_0x2d1692(0x103),_0x34eb8c),_0xa551b3);}async function createDeployZip(_0x41559a){const _0x13beeb=a102_0x200eb3,_0x353a42=new adm_zip_1[(_0x13beeb(0x11b))]();return await _0x353a42['addLocalFolder'](path_1[_0x13beeb(0x11b)][_0x13beeb(0x13c)](process[_0x13beeb(0x11e)](),'.temp',_0x41559a,DEPLOY_DIR_NAME)),_0x353a42;}async function insertZip(_0x46eb61,_0x182ab7,_0x16284c,_0x5f44,_0x56ea9d,_0xe673cc){const _0x317653=a102_0x200eb3,_0x2a1882={'ParentId':_0x182ab7,'Name':'BUILD'+_0x16284c,'Description':_0x317653(0x11a)+_0x5f44,'Body':_0x56ea9d},{data:_0xe699f5}=await _0x46eb61[_0x317653(0x116)](_0x317653(0xf4)+_0xe673cc+_0x317653(0x129),_0x2a1882);return _0xe699f5['id'];}