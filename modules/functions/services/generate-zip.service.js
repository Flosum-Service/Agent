const a104_0x1d017d=a104_0x3327;function a104_0x30c1(){const _0x5a9af1=['MDApiWriter','Package','retrieveAttachments','27408iEhjjN','@flosum/salesforce','2233473YPyLHi','Builder','Component_Name__c','filter','DEFLATE','../../git/writers/mdapi.writer','components','exists','ComponentsApi','Logger','destructiveChangesPost.xml','then','../classes/logger','post','permissionsets','orgId','map','__importDefault','__esModule','xml2js','length','../utils/extract-component-permissions','name','12ljDQwb','get','find','destructiveChangesPre.xml','BUILD','type','async','1.0','default','Component__r','FOLDER_TO_METADATA_TYPE_MAP','.temp','PartialRetrieve','cwd','splitZip','fetchComponentsDetailsByComponentsHistory','addLocalFolder','push','1431604WnSpuh','../../git/parsers/utils/zip','mergeComponentPermissions','../../shared/utils/fetch-attachments','../utils/components-api','unzip','removeNamespacePrefix','511YgamcE','1065987pCjusO','indexOf','toString','generateAndDeployZip','src','../../git/internal/fs.internal','dir','DeclarativeFilterOptions','execute','body','file','/services/data/v','keys','MetadataType','reduce','writeFile','fileName','text','createZip','fetchAttachmentsDetailsById','900455iKmUad','base64','MetadataConstants','fileType','Name','1011OgaBms','16155570XKMlBx','538wVvdck','extractComponentPermissions','set','PermissionSet','values','constructor','apply','files','(((.+)+)+)+$','substring','listMetadataItem','types','Zip','DEPLOYZIP','join','/sobjects/Attachment','Body','UTF-8','generateAsync','defineProperty','MAX_ZIP_SIZE','search'];a104_0x30c1=function(){return _0x5a9af1;};return a104_0x30c1();}(function(_0x5140a3,_0x3d1421){const _0x42bf18=a104_0x3327,_0x59bf6a=_0x5140a3();while(!![]){try{const _0x365dad=parseInt(_0x42bf18(0x83))/0x1*(parseInt(_0x42bf18(0x85))/0x2)+-parseInt(_0x42bf18(0xa0))/0x3+-parseInt(_0x42bf18(0xc9))/0x4+parseInt(_0x42bf18(0x7e))/0x5*(-parseInt(_0x42bf18(0xb7))/0x6)+parseInt(_0x42bf18(0xd0))/0x7*(parseInt(_0x42bf18(0x9e))/0x8)+-parseInt(_0x42bf18(0xd1))/0x9+parseInt(_0x42bf18(0x84))/0xa;if(_0x365dad===_0x3d1421)break;else _0x59bf6a['push'](_0x59bf6a['shift']());}catch(_0x2f9aee){_0x59bf6a['push'](_0x59bf6a['shift']());}}}(a104_0x30c1,0x87e35));function a104_0x3327(_0x431b4b,_0x325977){const _0x1434d9=a104_0x30c1();return a104_0x3327=function(_0x5af64f,_0x549fca){_0x5af64f=_0x5af64f-0x7e;let _0x30c106=_0x1434d9[_0x5af64f];return _0x30c106;},a104_0x3327(_0x431b4b,_0x325977);}const a104_0x549fca=(function(){let _0x3d4ee3=!![];return function(_0x40ad4d,_0x537c17){const _0x2a7f99=_0x3d4ee3?function(){const _0x14f020=a104_0x3327;if(_0x537c17){const _0x1edb76=_0x537c17[_0x14f020(0x8b)](_0x40ad4d,arguments);return _0x537c17=null,_0x1edb76;}}:function(){};return _0x3d4ee3=![],_0x2a7f99;};}()),a104_0x5af64f=a104_0x549fca(this,function(){const _0x460b75=a104_0x3327;return a104_0x5af64f[_0x460b75(0xd3)]()[_0x460b75(0x9a)]('(((.+)+)+)+$')[_0x460b75(0xd3)]()[_0x460b75(0x8a)](a104_0x5af64f)[_0x460b75(0x9a)](_0x460b75(0x8d));});a104_0x5af64f();'use strict';var __importDefault=this&&this[a104_0x1d017d(0xb1)]||function(_0x390710){const _0x10e3d2=a104_0x1d017d;return _0x390710&&_0x390710[_0x10e3d2(0xb2)]?_0x390710:{'default':_0x390710};};Object[a104_0x1d017d(0x98)](exports,a104_0x1d017d(0xb2),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require(a104_0x1d017d(0xb5)),logger_1=require(a104_0x1d017d(0xac)),xml2js_1=require(a104_0x1d017d(0xb3)),zip_1=require(a104_0x1d017d(0xca)),mdapi_writer_1=require(a104_0x1d017d(0xa5)),fs_internal_1=require(a104_0x1d017d(0xd6)),promises_1=require('fs/promises'),components_api_1=require(a104_0x1d017d(0xcd)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require('uuid'),fetch_attachments_1=require(a104_0x1d017d(0xcc)),salesforce_1=require(a104_0x1d017d(0x9f)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x1d017d(0xba),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x1d017d(0xaa),DEPLOY_DIR_NAME=a104_0x1d017d(0x92),PERMISSION_SET_FOLDER_NAME=a104_0x1d017d(0xae);async function generateAndDeployZip({attachmentsId:_0xda6da4,isExtractComponentsPermissionSets:_0x3ed366,isExtractComponentsProfiles:_0x4be4c5,preDestructiveAttachmentId:_0x774622,postDestructiveAttachmentId:_0x52e3cc,branchId:_0x1c3564,credentials:_0xcbfee7,metadataLogId:_0x3d5c83,environments:_0x4e6ecb,metaTypes:_0x48cc18,apiVersion:_0x11ebb3},_0x3f5eae,_0x3a6f4e){const _0x1148e2=a104_0x1d017d;var _0x5c445f;const _0x56bb32=(0x0,uuid_1['v4'])();try{const _0x33d85e=await(0x0,fetch_attachments_1[_0x1148e2(0xe4)])(_0x3f5eae,_0xda6da4),_0xa36d08=_0x33d85e[_0x1148e2(0xdf)]((_0x14bcbf,_0x19fae4)=>({..._0x14bcbf,[_0x19fae4['Id']]:_0x19fae4[_0x1148e2(0x82)]}),{}),_0x1f1837=await getComponents(_0x33d85e,_0x3f5eae,_0xa36d08),_0x44660d=await components_api_1[_0x1148e2(0xa8)][_0x1148e2(0xc6)](_0x3f5eae,_0x33d85e[_0x1148e2(0xb0)](({ParentId:_0x3a820d})=>_0x3a820d),_0x11ebb3)[_0x1148e2(0xab)](_0xb4f093=>components_api_1[_0x1148e2(0xa8)][_0x1148e2(0xcf)](_0xb4f093));if(_0x4be4c5){const _0x310762=_0x1f1837['filter'](({fileType:_0x56cdb9})=>_0x56cdb9==='Profile');await removePermission(_0x310762,_0x44660d);}const _0x5228d0=_0x1f1837[_0x1148e2(0xa3)](({fileType:_0x5eeac0})=>_0x5eeac0===_0x1148e2(0x88));if(_0x5228d0[_0x1148e2(0xb4)]&&_0x3ed366){await removePermission(_0x5228d0,_0x44660d);const {items:_0x16f07d}=await retrieveTargetPermissionSets(_0x5228d0,_0x11ebb3,_0x3a6f4e);await mergePermissionSets(_0x5228d0,((_0x5c445f=_0x16f07d[_0x1148e2(0x88)])===null||_0x5c445f===void 0x0?void 0x0:_0x5c445f[_0x1148e2(0xa6)])||[]);}await replaceEnvironments(_0x48cc18,_0x4e6ecb,_0x1f1837),await writeZip(_0x1f1837,_0x56bb32),await generateAndWritePackageXML(_0x33d85e,_0x44660d,_0x56bb32,_0x11ebb3);_0x774622&&await saveDestructiveChanges(_0x3f5eae,_0x774622,DESTRUCTIVE_CHANGES_PER_NAME,_0x56bb32);_0x52e3cc&&await saveDestructiveChanges(_0x3f5eae,_0x52e3cc,DESTRUCTIVE_CHANGES_POST_NAME,_0x56bb32);const _0x32ee82=(await createDeployZip(_0x56bb32)[_0x1148e2(0xab)](_0x1f785a=>{return _0x1f785a;}))['toBuffer']()['toString'](_0x1148e2(0x7f)),_0x10d0c7=_0x32ee82[_0x1148e2(0xb4)];if(_0x10d0c7>=components_api_1[_0x1148e2(0x99)]){const _0x2a599b=await createDeployZip(_0x56bb32),[_0x3df879,_0x110cc1]=await components_api_1[_0x1148e2(0xa8)][_0x1148e2(0xc5)](_0x2a599b,_0x10d0c7),_0x57e8fb=await insertZip(_0x3f5eae,_0x1c3564,_0xcbfee7['orgId'],_0x3d5c83,_0x3df879['toBuffer']()[_0x1148e2(0xd3)](_0x1148e2(0x7f)),_0x11ebb3),_0x2c430b=await insertZip(_0x3f5eae,_0x1c3564,_0xcbfee7[_0x1148e2(0xaf)],_0x3d5c83,_0x110cc1['toBuffer']()[_0x1148e2(0xd3)](_0x1148e2(0x7f)),_0x11ebb3);return _0x57e8fb+','+_0x2c430b;}else return await insertZip(_0x3f5eae,_0x1c3564,_0xcbfee7[_0x1148e2(0xaf)],_0x3d5c83,_0x32ee82,_0x11ebb3);}catch(_0x5d299d){throw _0x5d299d;}finally{if(await fs_internal_1['FS'][_0x1148e2(0xa7)](path_1[_0x1148e2(0xbf)][_0x1148e2(0x93)](process[_0x1148e2(0xc4)](),_0x1148e2(0xc2),_0x56bb32)))await(0x0,promises_1['rm'])(path_1['default'][_0x1148e2(0x93)](process[_0x1148e2(0xc4)](),'.temp',_0x56bb32),{'recursive':!![]});}}exports[a104_0x1d017d(0xd4)]=generateAndDeployZip;async function getComponents(_0x201ef5,_0x26ac67,_0x46bc58){const _0x1c43fe=a104_0x1d017d,_0x54857e=[],_0x591847=await(0x0,fetch_attachments_1[_0x1c43fe(0x9d)])(_0x201ef5,_0x26ac67);return await getComponentFromZip(_0x591847,_0x46bc58)[_0x1c43fe(0xab)](_0x4e3eee=>{_0x54857e['push'](..._0x4e3eee);}),_0x54857e;}async function getComponentFromZip(_0x1cf102,_0x3905d7){const _0x48af21=a104_0x1d017d,_0x9ccfac=[];for(const _0x5b8ca4 of _0x1cf102){const _0x84a992=await zip_1[_0x48af21(0x91)][_0x48af21(0xce)](_0x5b8ca4['values'][_0x48af21(0x95)]);for(const _0x283f2f in _0x84a992[_0x48af21(0x8c)]){!_0x84a992[_0x48af21(0x8c)][_0x283f2f][_0x48af21(0xd7)]&&_0x9ccfac[_0x48af21(0xc8)]({'fileName':_0x283f2f[_0x48af21(0x8e)](_0x283f2f[_0x48af21(0xd2)]('/')+0x1),'fileType':_0x3905d7[_0x5b8ca4['id']],'body':_0x5b8ca4[_0x48af21(0x89)]['Body']});}}return _0x9ccfac;}async function removePermission(_0x1dc30f,_0x162887){const _0x14bf9a=a104_0x1d017d;for(const _0x479006 of _0x1dc30f){const _0x543372=await zip_1[_0x14bf9a(0x91)][_0x14bf9a(0xce)](_0x479006[_0x14bf9a(0xda)]),_0x403953=[];for(const _0x2f9d88 in _0x543372[_0x14bf9a(0x8c)]){!_0x543372[_0x14bf9a(0x8c)][_0x2f9d88][_0x14bf9a(0xd7)]&&_0x403953[_0x14bf9a(0xc8)]({'fileName':_0x2f9d88,'body':await _0x543372['files'][_0x2f9d88][_0x14bf9a(0xbd)](_0x14bf9a(0xe2))});}const _0x29c2f3=await(0x0,extract_component_permissions_1[_0x14bf9a(0x86)])(_0x403953[0x0]['body'][_0x14bf9a(0xd3)](),_0x162887,_0x479006[_0x14bf9a(0x81)]),_0x734583=new xml2js_1['Builder']({'xmldec':{'version':_0x14bf9a(0xbe),'encoding':_0x14bf9a(0x96)}}),_0x13ad8d=_0x734583['buildObject'](_0x29c2f3),_0x3bd94c=zip_1[_0x14bf9a(0x91)][_0x14bf9a(0xe3)]();_0x3bd94c[_0x14bf9a(0xdb)](_0x403953[0x0][_0x14bf9a(0xe1)],_0x13ad8d),_0x479006[_0x14bf9a(0xda)]=await _0x3bd94c[_0x14bf9a(0x97)]({'type':'base64','compression':_0x14bf9a(0xa4),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x4e3eb0,_0x285eb2,_0x5214ae){const _0x3d5264=a104_0x1d017d,_0x2e6b98=_0x4e3eb0[_0x3d5264(0xb0)](_0x31d542=>PERMISSION_SET_FOLDER_NAME+'/'+_0x31d542[_0x3d5264(0xe1)])[_0x3d5264(0x93)](';'),_0x3e9b87=[{'field':_0x3d5264(0xe1),'option':salesforce_1[_0x3d5264(0xd8)]['IN'],'value':_0x2e6b98}],_0x55baa5=new logger_1[(_0x3d5264(0xa9))]();return new salesforce_1[(_0x3d5264(0xc3))](_0x285eb2,_0x5214ae,_0x55baa5,_0x3e9b87,null,[salesforce_1[_0x3d5264(0xde)]['PERMISSION_SET']])[_0x3d5264(0xd9)]();}async function mergePermissionSets(_0x9cb83c,_0x44b895){const _0x8a67ac=a104_0x1d017d,_0x5de912=_0x44b895[_0x8a67ac(0xdf)]((_0x4e08ce,_0x5814ab)=>_0x4e08ce[_0x8a67ac(0x87)](_0x5814ab[_0x8a67ac(0x8f)][_0x8a67ac(0xe1)],_0x5814ab),new Map());for(const _0xd9bd95 of _0x9cb83c){const _0x1d75aa=PERMISSION_SET_FOLDER_NAME+'/'+_0xd9bd95[_0x8a67ac(0xe1)],_0x58cede=_0x5de912[_0x8a67ac(0xb8)](_0x1d75aa);if(!_0x58cede)continue;const _0x51805d=await zip_1['Zip'][_0x8a67ac(0xce)](_0xd9bd95[_0x8a67ac(0xda)]),_0x545d36=await _0x51805d[_0x8a67ac(0x8c)][_0x1d75aa]['async'](_0x8a67ac(0xe2)),_0x4360a6=_0x58cede['files'][_0x1d75aa]['toString'](),_0x3cd048=await(0x0,extract_component_permissions_1[_0x8a67ac(0xcb)])(_0x545d36,_0x4360a6,_0xd9bd95['fileType']),_0x1cbc38=zip_1['Zip'][_0x8a67ac(0xe3)]();_0x1cbc38[_0x8a67ac(0xdb)](_0x1d75aa,_0x3cd048),_0xd9bd95[_0x8a67ac(0xda)]=await _0x1cbc38['generateAsync']({'type':_0x8a67ac(0x7f),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x2ece4a,_0x3532f6,_0x17b524){const _0x50ecb1=a104_0x1d017d;for(const _0x13adc0 of _0x17b524){if(_0x2ece4a['every'](_0x592aff=>_0x592aff!==_0x13adc0[_0x50ecb1(0x81)]))continue;const _0x292b73=await zip_1[_0x50ecb1(0x91)][_0x50ecb1(0xce)](_0x13adc0[_0x50ecb1(0xda)]);for(const _0x235483 in _0x292b73[_0x50ecb1(0x8c)]){if(!_0x292b73[_0x50ecb1(0x8c)][_0x235483][_0x50ecb1(0xd7)]){let _0xfa46c1=await _0x292b73[_0x50ecb1(0x8c)][_0x235483]['async']('text');for(const _0x51c787 of Object[_0x50ecb1(0xdd)](_0x3532f6)){const _0x50af1e=new RegExp('%%'+_0x51c787+'%%','g');_0xfa46c1=_0xfa46c1['replace'](_0x50af1e,_0x3532f6[_0x51c787]);}_0x292b73['file'](_0x235483,_0xfa46c1);}}_0x13adc0[_0x50ecb1(0xda)]=await _0x292b73['generateAsync']({'type':_0x50ecb1(0x7f),'compression':_0x50ecb1(0xa4),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x3f8829,_0x561c30){const _0x3782ac=a104_0x1d017d,_0x13af23=new mdapi_writer_1[(_0x3782ac(0x9b))]({'components':_0x3f8829,'sourceDir':path_1[_0x3782ac(0xbf)][_0x3782ac(0x93)](process[_0x3782ac(0xc4)](),'.temp',_0x561c30,DEPLOY_DIR_NAME,_0x3782ac(0xd5)),'skipChildErrors':![]});await _0x13af23[_0x3782ac(0xd9)]();}async function generateAndWritePackageXML(_0x188051,_0x4f28d3,_0x28098c,_0x1f8da9){const _0x294cbb=a104_0x1d017d,_0x7ebf9=getComponentsTypeAndName(_0x188051,_0x4f28d3),_0x1af8ff=[...new Set(_0x7ebf9[_0x294cbb(0xb0)](_0xdb93=>_0xdb93['type']))],_0x3f88a0={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x1f8da9}};for(const _0x21932a of _0x1af8ff){const _0x51a832=_0x7ebf9[_0x294cbb(0xa3)](_0x7551f5=>_0x7551f5[_0x294cbb(0xbc)]===_0x21932a)['map'](_0x58f887=>_0x58f887[_0x294cbb(0xb6)]),_0x410827={'members':_0x51a832,'name':_0x21932a};_0x3f88a0[_0x294cbb(0x9c)][_0x294cbb(0x90)][_0x294cbb(0xc8)](_0x410827);}const _0x279c40=new xml2js_1[(_0x294cbb(0xa1))]({'xmldec':{'version':'1.0','encoding':_0x294cbb(0x96)}}),_0x146af9=_0x279c40['buildObject'](_0x3f88a0);await fs_internal_1['FS'][_0x294cbb(0xe0)](path_1[_0x294cbb(0xbf)][_0x294cbb(0x93)](process['cwd'](),_0x294cbb(0xc2),_0x28098c,DEPLOY_DIR_NAME,_0x294cbb(0xd5),'package.xml'),_0x146af9);}function getComponentsTypeAndName(_0x62b55a,_0x5ad565){const _0x2d2441=a104_0x1d017d;return _0x62b55a[_0x2d2441(0xdf)]((_0x53f70e,_0x370878)=>{const _0x5c1eb9=_0x2d2441,_0x3fe3f0=_0x5ad565[_0x5c1eb9(0xb9)](_0x4698e1=>_0x4698e1['Id']===_0x370878['ParentId']);return _0x3fe3f0&&_0x53f70e[_0x5c1eb9(0xc8)]({'name':_0x3fe3f0[_0x5c1eb9(0xc0)][_0x5c1eb9(0xa2)],'type':salesforce_1[_0x5c1eb9(0x80)][_0x5c1eb9(0xc1)][_0x370878[_0x5c1eb9(0x82)]]||_0x370878[_0x5c1eb9(0x82)]}),_0x53f70e;},[]);}async function saveDestructiveChanges(_0xd861d6,_0x34c8e4,_0xc07fcf,_0x426bfd){const _0x3bf29d=a104_0x1d017d,_0x50f4bc=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0xd861d6,_0x34c8e4))[_0x3bf29d(0xd3)]();await fs_internal_1['FS'][_0x3bf29d(0xe0)](path_1[_0x3bf29d(0xbf)][_0x3bf29d(0x93)](process[_0x3bf29d(0xc4)](),'.temp',_0x426bfd,DEPLOY_DIR_NAME,'src',_0xc07fcf),_0x50f4bc);}async function createDeployZip(_0x520659){const _0x44cbf4=a104_0x1d017d,_0x2a285d=new adm_zip_1[(_0x44cbf4(0xbf))]();return await _0x2a285d[_0x44cbf4(0xc7)](path_1[_0x44cbf4(0xbf)][_0x44cbf4(0x93)](process['cwd'](),'.temp',_0x520659,DEPLOY_DIR_NAME)),_0x2a285d;}async function insertZip(_0x44a894,_0x4cd66c,_0x176f0b,_0x3bd731,_0x176a25,_0x5119ef){const _0x4d2506=a104_0x1d017d,_0x10cd87={'ParentId':_0x4cd66c,'Name':'BUILD'+_0x176f0b,'Description':_0x4d2506(0xbb)+_0x3bd731,'Body':_0x176a25},{data:_0x28d541}=await _0x44a894[_0x4d2506(0xad)](_0x4d2506(0xdc)+_0x5119ef+_0x4d2506(0x94),_0x10cd87);return _0x28d541['id'];}