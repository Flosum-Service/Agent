const a104_0x2eb01d=a104_0x1dbd;function a104_0x1a1d(){const _0x1996a2=['body','/sobjects/Attachment','DEPLOYZIP','buildObject','156LfGObp','exists','join','92iGBNZa','generateAsync','3144RsNOVJ','text','dir','length','file','adm-zip','.temp','fileType','(((.+)+)+)+$','fetchAttachmentBody','Logger','defineProperty','addLocalFolder','3759cJPfzp','ParentId','package.xml','keys','2842411TYvcZK','Component_Name__c','FOLDER_TO_METADATA_TYPE_MAP','DEFLATE','post','1322630FARHgc','orgId','fileName','BUILD','../classes/logger','default','find','extractComponentPermissions','../../git/parsers/utils/zip','../../git/internal/fs.internal','Builder','../../git/writers/mdapi.writer','MDApiWriter','substring','fetchComponentsDetailsByComponentsHistory','MetadataConstants','retrieveAttachments','Name','__esModule','filter','files','MetadataType','destructiveChangesPost.xml','apply','reduce','components','126yhoHOw','__importDefault','cwd','Zip','listMetadataItem','splitZip','16Hksoxo','uuid','PermissionSet','base64','8311722aQUPiO','then','search','createZip','values','unzip','constructor','writeFile','push','168224YcZoIi','type','map','async','destructiveChangesPre.xml','execute','DeclarativeFilterOptions','6946940AFHIdm','types','ComponentsApi','permissionsets','85992rCCfOP','name','PERMISSION_SET','PartialRetrieve','/services/data/v','../utils/components-api','http://soap.sforce.com/2006/04/metadata','Body','mergeComponentPermissions','src','toBuffer','toString'];a104_0x1a1d=function(){return _0x1996a2;};return a104_0x1a1d();}(function(_0x3ed483,_0x26925e){const _0x2a0c4d=a104_0x1dbd,_0x280db2=_0x3ed483();while(!![]){try{const _0x359879=parseInt(_0x2a0c4d(0x1b7))/0x1*(parseInt(_0x2a0c4d(0x1c4))/0x2)+-parseInt(_0x2a0c4d(0x1cf))/0x3*(-parseInt(_0x2a0c4d(0x1e2))/0x4)+-parseInt(_0x2a0c4d(0x1cb))/0x5+-parseInt(_0x2a0c4d(0x1bb))/0x6+parseInt(_0x2a0c4d(0x1f1))/0x7*(parseInt(_0x2a0c4d(0x1e4))/0x8)+parseInt(_0x2a0c4d(0x214))/0x9*(-parseInt(_0x2a0c4d(0x1fa))/0xa)+-parseInt(_0x2a0c4d(0x1f5))/0xb*(-parseInt(_0x2a0c4d(0x1df))/0xc);if(_0x359879===_0x26925e)break;else _0x280db2['push'](_0x280db2['shift']());}catch(_0x9c003f){_0x280db2['push'](_0x280db2['shift']());}}}(a104_0x1a1d,0xe7ae1));const a104_0x381aee=(function(){let _0x29279d=!![];return function(_0x549517,_0x36ed24){const _0x444ac9=_0x29279d?function(){const _0x35151f=a104_0x1dbd;if(_0x36ed24){const _0x31b295=_0x36ed24[_0x35151f(0x211)](_0x549517,arguments);return _0x36ed24=null,_0x31b295;}}:function(){};return _0x29279d=![],_0x444ac9;};}()),a104_0x10729b=a104_0x381aee(this,function(){const _0x414b90=a104_0x1dbd;return a104_0x10729b[_0x414b90(0x1da)]()[_0x414b90(0x1bd)](_0x414b90(0x1ec))[_0x414b90(0x1da)]()[_0x414b90(0x1c1)](a104_0x10729b)[_0x414b90(0x1bd)]('(((.+)+)+)+$');});a104_0x10729b();'use strict';var __importDefault=this&&this[a104_0x2eb01d(0x215)]||function(_0x141438){const _0x21bd99=a104_0x2eb01d;return _0x141438&&_0x141438[_0x21bd99(0x20c)]?_0x141438:{'default':_0x141438};};Object[a104_0x2eb01d(0x1ef)](exports,a104_0x2eb01d(0x20c),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require('../utils/extract-component-permissions'),logger_1=require(a104_0x2eb01d(0x1fe)),xml2js_1=require('xml2js'),zip_1=require(a104_0x2eb01d(0x202)),mdapi_writer_1=require(a104_0x2eb01d(0x205)),fs_internal_1=require(a104_0x2eb01d(0x203)),promises_1=require('fs/promises'),components_api_1=require(a104_0x2eb01d(0x1d4)),adm_zip_1=__importDefault(require(a104_0x2eb01d(0x1e9))),uuid_1=require(a104_0x2eb01d(0x1b8)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x2eb01d(0x1c8),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x2eb01d(0x210),DEPLOY_DIR_NAME=a104_0x2eb01d(0x1dd),PERMISSION_SET_FOLDER_NAME=a104_0x2eb01d(0x1ce);function a104_0x1dbd(_0x1fb075,_0x4068d5){const _0x488984=a104_0x1a1d();return a104_0x1dbd=function(_0x10729b,_0x381aee){_0x10729b=_0x10729b-0x1b3;let _0x1a1d9e=_0x488984[_0x10729b];return _0x1a1d9e;},a104_0x1dbd(_0x1fb075,_0x4068d5);}async function generateAndDeployZip({attachmentsId:_0x283e5,isExtractComponentsPermissionSets:_0x206108,isExtractComponentsProfiles:_0x54e766,preDestructiveAttachmentId:_0x56a9d8,postDestructiveAttachmentId:_0x127e99,branchId:_0x29285f,credentials:_0x597a18,metadataLogId:_0x30bbaf,environments:_0x146124,metaTypes:_0x24e2d6,apiVersion:_0x3fb9f5},_0x3ff353,_0x24a095){const _0x588d64=a104_0x2eb01d;var _0x6b60f4;const _0x316c07=(0x0,uuid_1['v4'])();try{const _0x15e32f=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x3ff353,_0x283e5),_0x17eca7=_0x15e32f[_0x588d64(0x212)]((_0x68031c,_0x7c02bf)=>({..._0x68031c,[_0x7c02bf['Id']]:_0x7c02bf[_0x588d64(0x20b)]}),{}),_0x5a346c=await getComponents(_0x15e32f,_0x3ff353,_0x17eca7),_0x1fb68b=await components_api_1[_0x588d64(0x1cd)][_0x588d64(0x208)](_0x3ff353,_0x15e32f[_0x588d64(0x1c6)](({ParentId:_0x428e3f})=>_0x428e3f),_0x3fb9f5)[_0x588d64(0x1bc)](_0xc76400=>components_api_1[_0x588d64(0x1cd)]['removeNamespacePrefix'](_0xc76400));if(_0x54e766){const _0x33abd8=_0x5a346c[_0x588d64(0x20d)](({fileType:_0x548f87})=>_0x548f87==='Profile');await removePermission(_0x33abd8,_0x1fb68b);}const _0x36c6e1=_0x5a346c[_0x588d64(0x20d)](({fileType:_0x57a994})=>_0x57a994===_0x588d64(0x1b9));if(_0x36c6e1['length']&&_0x206108){await removePermission(_0x36c6e1,_0x1fb68b);const {items:_0x319cdf}=await retrieveTargetPermissionSets(_0x36c6e1,_0x3fb9f5,_0x24a095);await mergePermissionSets(_0x36c6e1,((_0x6b60f4=_0x319cdf[_0x588d64(0x1b9)])===null||_0x6b60f4===void 0x0?void 0x0:_0x6b60f4[_0x588d64(0x213)])||[]);}await replaceEnvironments(_0x24e2d6,_0x146124,_0x5a346c),await writeZip(_0x5a346c,_0x316c07),await generateAndWritePackageXML(_0x15e32f,_0x1fb68b,_0x316c07,_0x3fb9f5);_0x56a9d8&&await saveDestructiveChanges(_0x3ff353,_0x56a9d8,DESTRUCTIVE_CHANGES_PER_NAME,_0x316c07);_0x127e99&&await saveDestructiveChanges(_0x3ff353,_0x127e99,DESTRUCTIVE_CHANGES_POST_NAME,_0x316c07);const _0x96c10=(await createDeployZip(_0x316c07)['then'](_0x2ee9a3=>{return _0x2ee9a3;}))[_0x588d64(0x1d9)]()[_0x588d64(0x1da)]('base64'),_0x3839e1=_0x96c10[_0x588d64(0x1e7)];if(_0x3839e1>=components_api_1['MAX_ZIP_SIZE']){const _0x51f1de=await createDeployZip(_0x316c07),[_0x40d80f,_0x5937d1]=await components_api_1['ComponentsApi'][_0x588d64(0x1b6)](_0x51f1de,_0x3839e1),_0xa38728=await insertZip(_0x3ff353,_0x29285f,_0x597a18['orgId'],_0x30bbaf,_0x40d80f[_0x588d64(0x1d9)]()['toString']('base64'),_0x3fb9f5),_0x3111a6=await insertZip(_0x3ff353,_0x29285f,_0x597a18[_0x588d64(0x1fb)],_0x30bbaf,_0x5937d1[_0x588d64(0x1d9)]()[_0x588d64(0x1da)](_0x588d64(0x1ba)),_0x3fb9f5);return _0xa38728+','+_0x3111a6;}else return await insertZip(_0x3ff353,_0x29285f,_0x597a18[_0x588d64(0x1fb)],_0x30bbaf,_0x96c10,_0x3fb9f5);}catch(_0x4ffdf9){throw _0x4ffdf9;}finally{if(await fs_internal_1['FS'][_0x588d64(0x1e0)](path_1[_0x588d64(0x1ff)][_0x588d64(0x1e1)](process[_0x588d64(0x1b3)](),_0x588d64(0x1ea),_0x316c07)))await(0x0,promises_1['rm'])(path_1[_0x588d64(0x1ff)][_0x588d64(0x1e1)](process[_0x588d64(0x1b3)](),'.temp',_0x316c07),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x1910b3,_0x1e6cda,_0x3da97d){const _0x553ddf=a104_0x2eb01d,_0x1c97be=[],_0x52b613=await(0x0,fetch_attachments_1[_0x553ddf(0x20a)])(_0x1910b3,_0x1e6cda);return await getComponentFromZip(_0x52b613,_0x3da97d)['then'](_0x5d1f4f=>{_0x1c97be['push'](..._0x5d1f4f);}),_0x1c97be;}async function getComponentFromZip(_0x56ac21,_0x283f80){const _0x5c6a59=a104_0x2eb01d,_0x12a5ae=[];for(const _0x481dc8 of _0x56ac21){const _0x5c47b1=await zip_1['Zip']['unzip'](_0x481dc8['values'][_0x5c6a59(0x1d6)]);for(const _0x491734 in _0x5c47b1[_0x5c6a59(0x20e)]){!_0x5c47b1[_0x5c6a59(0x20e)][_0x491734]['dir']&&_0x12a5ae[_0x5c6a59(0x1c3)]({'fileName':_0x491734[_0x5c6a59(0x207)](_0x491734['indexOf']('/')+0x1),'fileType':_0x283f80[_0x481dc8['id']],'body':_0x481dc8[_0x5c6a59(0x1bf)][_0x5c6a59(0x1d6)]});}}return _0x12a5ae;}async function removePermission(_0x1c2519,_0x26a167){const _0x3ac91c=a104_0x2eb01d;for(const _0x1dcee4 of _0x1c2519){const _0x38b5a8=await zip_1[_0x3ac91c(0x1b4)][_0x3ac91c(0x1c0)](_0x1dcee4['body']),_0x462d69=[];for(const _0x27c1be in _0x38b5a8[_0x3ac91c(0x20e)]){!_0x38b5a8[_0x3ac91c(0x20e)][_0x27c1be][_0x3ac91c(0x1e6)]&&_0x462d69[_0x3ac91c(0x1c3)]({'fileName':_0x27c1be,'body':await _0x38b5a8['files'][_0x27c1be][_0x3ac91c(0x1c7)](_0x3ac91c(0x1e5))});}const _0xcfab19=await(0x0,extract_component_permissions_1[_0x3ac91c(0x201)])(_0x462d69[0x0][_0x3ac91c(0x1db)][_0x3ac91c(0x1da)](),_0x26a167,_0x1dcee4[_0x3ac91c(0x1eb)]),_0x2afaa8=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x11e192=_0x2afaa8[_0x3ac91c(0x1de)](_0xcfab19),_0x4a15a7=zip_1[_0x3ac91c(0x1b4)][_0x3ac91c(0x1be)]();_0x4a15a7[_0x3ac91c(0x1e8)](_0x462d69[0x0][_0x3ac91c(0x1fc)],_0x11e192),_0x1dcee4[_0x3ac91c(0x1db)]=await _0x4a15a7[_0x3ac91c(0x1e3)]({'type':_0x3ac91c(0x1ba),'compression':_0x3ac91c(0x1f8),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0xa1b068,_0x20435d,_0x23132d){const _0x1868d0=a104_0x2eb01d,_0x9b9d8a=_0xa1b068['map'](_0x2a4df3=>PERMISSION_SET_FOLDER_NAME+'/'+_0x2a4df3[_0x1868d0(0x1fc)])[_0x1868d0(0x1e1)](';'),_0x4a2d56=[{'field':_0x1868d0(0x1fc),'option':salesforce_1[_0x1868d0(0x1ca)]['IN'],'value':_0x9b9d8a}],_0x511fa3=new logger_1[(_0x1868d0(0x1ee))]();return new salesforce_1[(_0x1868d0(0x1d2))](_0x20435d,_0x23132d,_0x511fa3,_0x4a2d56,null,[salesforce_1[_0x1868d0(0x20f)][_0x1868d0(0x1d1)]])[_0x1868d0(0x1c9)]();}async function mergePermissionSets(_0x321d1e,_0x3176e5){const _0x1bb0c6=a104_0x2eb01d,_0x4ee9aa=_0x3176e5['reduce']((_0x2a372c,_0x5ec156)=>_0x2a372c['set'](_0x5ec156[_0x1bb0c6(0x1b5)]['fileName'],_0x5ec156),new Map());for(const _0x484b47 of _0x321d1e){const _0x296576=PERMISSION_SET_FOLDER_NAME+'/'+_0x484b47['fileName'],_0x557997=_0x4ee9aa['get'](_0x296576);if(!_0x557997)continue;const _0x5e496f=await zip_1[_0x1bb0c6(0x1b4)]['unzip'](_0x484b47[_0x1bb0c6(0x1db)]),_0x49ee73=await _0x5e496f[_0x1bb0c6(0x20e)][_0x296576][_0x1bb0c6(0x1c7)](_0x1bb0c6(0x1e5)),_0x260a21=_0x557997[_0x1bb0c6(0x20e)][_0x296576][_0x1bb0c6(0x1da)](),_0x209830=await(0x0,extract_component_permissions_1[_0x1bb0c6(0x1d7)])(_0x49ee73,_0x260a21,_0x484b47[_0x1bb0c6(0x1eb)]),_0x2e139b=zip_1[_0x1bb0c6(0x1b4)]['createZip']();_0x2e139b[_0x1bb0c6(0x1e8)](_0x296576,_0x209830),_0x484b47[_0x1bb0c6(0x1db)]=await _0x2e139b[_0x1bb0c6(0x1e3)]({'type':'base64','compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x1245fa,_0x96f855,_0xd65992){const _0x176892=a104_0x2eb01d;for(const _0x12f8c7 of _0xd65992){if(_0x1245fa['every'](_0xc58b2b=>_0xc58b2b!==_0x12f8c7[_0x176892(0x1eb)]))continue;const _0x6fc3f6=await zip_1['Zip']['unzip'](_0x12f8c7['body']);for(const _0x5bbbfe in _0x6fc3f6['files']){if(!_0x6fc3f6['files'][_0x5bbbfe][_0x176892(0x1e6)]){let _0x5e8111=await _0x6fc3f6[_0x176892(0x20e)][_0x5bbbfe][_0x176892(0x1c7)]('text');for(const _0x20b681 of Object[_0x176892(0x1f4)](_0x96f855)){const _0x2a0b4c=new RegExp('%%'+_0x20b681+'%%','g');_0x5e8111=_0x5e8111['replace'](_0x2a0b4c,_0x96f855[_0x20b681]);}_0x6fc3f6['file'](_0x5bbbfe,_0x5e8111);}}_0x12f8c7[_0x176892(0x1db)]=await _0x6fc3f6[_0x176892(0x1e3)]({'type':_0x176892(0x1ba),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x2e092c,_0xc19438){const _0x634565=a104_0x2eb01d,_0x2edd67=new mdapi_writer_1[(_0x634565(0x206))]({'components':_0x2e092c,'sourceDir':path_1[_0x634565(0x1ff)][_0x634565(0x1e1)](process[_0x634565(0x1b3)](),_0x634565(0x1ea),_0xc19438,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x2edd67[_0x634565(0x1c9)]();}async function generateAndWritePackageXML(_0x20650c,_0x375a81,_0x3eadcc,_0x39ef8c){const _0x54e504=a104_0x2eb01d,_0x2997bc=getComponentsTypeAndName(_0x20650c,_0x375a81),_0x152aee=[...new Set(_0x2997bc[_0x54e504(0x1c6)](_0x115640=>_0x115640[_0x54e504(0x1c5)]))],_0x1fb2f0={'Package':{'$':{'xmlns':_0x54e504(0x1d5)},'types':[],'version':''+_0x39ef8c}};for(const _0xfc8b00 of _0x152aee){const _0x172ab2=_0x2997bc['filter'](_0x3ca105=>_0x3ca105['type']===_0xfc8b00)[_0x54e504(0x1c6)](_0x5a3afb=>_0x5a3afb[_0x54e504(0x1d0)]),_0x369c97={'members':_0x172ab2,'name':_0xfc8b00};_0x1fb2f0['Package'][_0x54e504(0x1cc)][_0x54e504(0x1c3)](_0x369c97);}const _0x50db13=new xml2js_1[(_0x54e504(0x204))]({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x336a44=_0x50db13[_0x54e504(0x1de)](_0x1fb2f0);await fs_internal_1['FS'][_0x54e504(0x1c2)](path_1[_0x54e504(0x1ff)][_0x54e504(0x1e1)](process['cwd'](),_0x54e504(0x1ea),_0x3eadcc,DEPLOY_DIR_NAME,_0x54e504(0x1d8),_0x54e504(0x1f3)),_0x336a44);}function getComponentsTypeAndName(_0x329f75,_0x35e507){const _0x4cf2b1=a104_0x2eb01d;return _0x329f75[_0x4cf2b1(0x212)]((_0xa5ce4d,_0x5ee4a2)=>{const _0x23d1e7=_0x4cf2b1,_0x5e5f65=_0x35e507[_0x23d1e7(0x200)](_0x25fbde=>_0x25fbde['Id']===_0x5ee4a2[_0x23d1e7(0x1f2)]);return _0x5e5f65&&_0xa5ce4d['push']({'name':_0x5e5f65['Component__r'][_0x23d1e7(0x1f6)],'type':salesforce_1[_0x23d1e7(0x209)][_0x23d1e7(0x1f7)][_0x5ee4a2[_0x23d1e7(0x20b)]]||_0x5ee4a2[_0x23d1e7(0x20b)]}),_0xa5ce4d;},[]);}async function saveDestructiveChanges(_0x9d2ddb,_0x3c622b,_0x260a81,_0x122246){const _0x14f2f0=a104_0x2eb01d,_0x2e725f=(await(0x0,fetch_attachments_1[_0x14f2f0(0x1ed)])(_0x9d2ddb,_0x3c622b))['toString']();await fs_internal_1['FS'][_0x14f2f0(0x1c2)](path_1[_0x14f2f0(0x1ff)]['join'](process[_0x14f2f0(0x1b3)](),_0x14f2f0(0x1ea),_0x122246,DEPLOY_DIR_NAME,'src',_0x260a81),_0x2e725f);}async function createDeployZip(_0x22aadc){const _0x5b578f=a104_0x2eb01d,_0x578ded=new adm_zip_1[(_0x5b578f(0x1ff))]();return await _0x578ded[_0x5b578f(0x1f0)](path_1[_0x5b578f(0x1ff)][_0x5b578f(0x1e1)](process['cwd'](),_0x5b578f(0x1ea),_0x22aadc,DEPLOY_DIR_NAME)),_0x578ded;}async function insertZip(_0x31da20,_0x5c3964,_0x4315f3,_0x41533c,_0x28dd15,_0x52800e){const _0x2c4a5f=a104_0x2eb01d,_0xff7fb6={'ParentId':_0x5c3964,'Name':_0x2c4a5f(0x1fd)+_0x4315f3,'Description':_0x2c4a5f(0x1fd)+_0x41533c,'Body':_0x28dd15},{data:_0x10ba8a}=await _0x31da20[_0x2c4a5f(0x1f9)](_0x2c4a5f(0x1d3)+_0x52800e+_0x2c4a5f(0x1dc),_0xff7fb6);return _0x10ba8a['id'];}