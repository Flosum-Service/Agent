const a102_0x1d9e34=a102_0x16ba;(function(_0x52fb81,_0x48fce9){const _0xc3c6c8=a102_0x16ba,_0x4eec59=_0x52fb81();while(!![]){try{const _0x3a21ab=parseInt(_0xc3c6c8(0x18b))/0x1*(-parseInt(_0xc3c6c8(0x1c2))/0x2)+parseInt(_0xc3c6c8(0x1a2))/0x3+-parseInt(_0xc3c6c8(0x18a))/0x4+-parseInt(_0xc3c6c8(0x1b7))/0x5+-parseInt(_0xc3c6c8(0x1be))/0x6*(parseInt(_0xc3c6c8(0x1af))/0x7)+parseInt(_0xc3c6c8(0x184))/0x8+parseInt(_0xc3c6c8(0x197))/0x9;if(_0x3a21ab===_0x48fce9)break;else _0x4eec59['push'](_0x4eec59['shift']());}catch(_0x14e78){_0x4eec59['push'](_0x4eec59['shift']());}}}(a102_0x3009,0x6cb1a));const a102_0x356bfa=(function(){let _0x264610=!![];return function(_0x4e45bd,_0x6a98c3){const _0x18d152=_0x264610?function(){if(_0x6a98c3){const _0x53a497=_0x6a98c3['apply'](_0x4e45bd,arguments);return _0x6a98c3=null,_0x53a497;}}:function(){};return _0x264610=![],_0x18d152;};}()),a102_0x16c7e4=a102_0x356bfa(this,function(){const _0x1c353f=a102_0x16ba;return a102_0x16c7e4[_0x1c353f(0x1ad)]()['search'](_0x1c353f(0x18c))[_0x1c353f(0x1ad)]()['constructor'](a102_0x16c7e4)['search'](_0x1c353f(0x18c));});a102_0x16c7e4();'use strict';function a102_0x16ba(_0x400045,_0xa2903f){const _0x5420af=a102_0x3009();return a102_0x16ba=function(_0x16c7e4,_0x356bfa){_0x16c7e4=_0x16c7e4-0x16a;let _0x300985=_0x5420af[_0x16c7e4];return _0x300985;},a102_0x16ba(_0x400045,_0xa2903f);}var __importDefault=this&&this[a102_0x1d9e34(0x191)]||function(_0x43ab87){const _0xac69f3=a102_0x1d9e34;return _0x43ab87&&_0x43ab87[_0xac69f3(0x19e)]?_0x43ab87:{'default':_0x43ab87};};Object[a102_0x1d9e34(0x1c9)](exports,a102_0x1d9e34(0x19e),{'value':!![]}),exports[a102_0x1d9e34(0x199)]=void 0x0;const path_1=__importDefault(require(a102_0x1d9e34(0x1c4))),extract_component_permissions_1=require('../utils/extract-component-permissions'),logger_1=require('../classes/logger'),xml2js_1=require(a102_0x1d9e34(0x196)),zip_1=require(a102_0x1d9e34(0x1a0)),mdapi_writer_1=require('../../git/writers/mdapi.writer'),fs_internal_1=require(a102_0x1d9e34(0x1b9)),promises_1=require(a102_0x1d9e34(0x179)),components_api_1=require(a102_0x1d9e34(0x1c1)),adm_zip_1=__importDefault(require(a102_0x1d9e34(0x195))),uuid_1=require(a102_0x1d9e34(0x1a1)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a102_0x1d9e34(0x170)),DESTRUCTIVE_CHANGES_PER_NAME=a102_0x1d9e34(0x19d),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a102_0x1d9e34(0x1b2),PERMISSION_SET_FOLDER_NAME=a102_0x1d9e34(0x17c);async function generateAndDeployZip({attachmentsId:_0x420ece,isExtractComponentsPermissionSets:_0x163acd,isExtractComponentsProfiles:_0x315fbf,preDestructiveAttachmentId:_0x36d81c,postDestructiveAttachmentId:_0x517484,branchId:_0x118230,credentials:_0x695316,metadataLogId:_0x33b7ef,environments:_0xaa4e1b,metaTypes:_0x969324,apiVersion:_0x25324d},_0x4cf518,_0x1a158d){const _0x215849=a102_0x1d9e34;var _0x1843bb;const _0x33abdd=(0x0,uuid_1['v4'])();try{const _0x3f7272=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x4cf518,_0x420ece),_0x1bc229=_0x3f7272[_0x215849(0x16e)]((_0x269124,_0x2b725e)=>({..._0x269124,[_0x2b725e['Id']]:_0x2b725e['Name']}),{}),_0x273614=await getComponents(_0x3f7272,_0x4cf518,_0x1bc229),_0x1f24d7=await components_api_1[_0x215849(0x18e)]['fetchComponentsDetailsByComponentsHistory'](_0x4cf518,_0x3f7272[_0x215849(0x188)](({ParentId:_0x93c392})=>_0x93c392),_0x25324d)[_0x215849(0x1c5)](_0x3bd8e0=>components_api_1['ComponentsApi'][_0x215849(0x182)](_0x3bd8e0));if(_0x315fbf){const _0x509d65=_0x273614[_0x215849(0x16f)](({fileType:_0x382221})=>_0x382221===_0x215849(0x174));await removePermission(_0x509d65,_0x1f24d7);}const _0xe5354f=_0x273614[_0x215849(0x16f)](({fileType:_0x50babc})=>_0x50babc===_0x215849(0x193));if(_0xe5354f[_0x215849(0x198)]&&_0x163acd){await removePermission(_0xe5354f,_0x1f24d7);const {items:_0x4d773e}=await retrieveTargetPermissionSets(_0xe5354f,_0x25324d,_0x1a158d);await mergePermissionSets(_0xe5354f,((_0x1843bb=_0x4d773e[_0x215849(0x193)])===null||_0x1843bb===void 0x0?void 0x0:_0x1843bb['components'])||[]);}await replaceEnvironments(_0x969324,_0xaa4e1b,_0x273614),await writeZip(_0x273614,_0x33abdd),await generateAndWritePackageXML(_0x3f7272,_0x1f24d7,_0x33abdd,_0x25324d);_0x36d81c&&await saveDestructiveChanges(_0x4cf518,_0x36d81c,DESTRUCTIVE_CHANGES_PER_NAME,_0x33abdd);_0x517484&&await saveDestructiveChanges(_0x4cf518,_0x517484,DESTRUCTIVE_CHANGES_POST_NAME,_0x33abdd);const _0x16fcc0=(await createDeployZip(_0x33abdd)[_0x215849(0x1c5)](_0xc440b=>{return _0xc440b;}))[_0x215849(0x19b)]()['toString']('base64'),_0x24b05c=_0x16fcc0[_0x215849(0x198)];if(_0x24b05c>=components_api_1[_0x215849(0x183)]){const _0x53339c=await createDeployZip(_0x33abdd),[_0xbb82dc,_0x1f2ed2]=await components_api_1[_0x215849(0x18e)][_0x215849(0x1b3)](_0x53339c,_0x24b05c),_0x390748=await insertZip(_0x4cf518,_0x118230,_0x695316['orgId'],_0x33b7ef,_0xbb82dc[_0x215849(0x19b)]()[_0x215849(0x1ad)](_0x215849(0x180)),_0x25324d),_0x29d24f=await insertZip(_0x4cf518,_0x118230,_0x695316[_0x215849(0x1b8)],_0x33b7ef,_0x1f2ed2[_0x215849(0x19b)]()[_0x215849(0x1ad)]('base64'),_0x25324d);return _0x390748+','+_0x29d24f;}else return await insertZip(_0x4cf518,_0x118230,_0x695316[_0x215849(0x1b8)],_0x33b7ef,_0x16fcc0,_0x25324d);}catch(_0x3adc5d){throw _0x3adc5d;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x215849(0x181)][_0x215849(0x186)](process['cwd'](),_0x215849(0x1bd),_0x33abdd)))await(0x0,promises_1['rm'])(path_1[_0x215849(0x181)][_0x215849(0x186)](process[_0x215849(0x1a3)](),_0x215849(0x1bd),_0x33abdd),{'recursive':!![]});}}exports[a102_0x1d9e34(0x199)]=generateAndDeployZip;async function getComponents(_0xbc5cb4,_0x362184,_0x1324e1){const _0x2009e4=a102_0x1d9e34,_0x4bf4f0=[],_0x5ca79d=await(0x0,fetch_attachments_1[_0x2009e4(0x189)])(_0xbc5cb4,_0x362184);return await getComponentFromZip(_0x5ca79d,_0x1324e1)['then'](_0x1da137=>{const _0x1e8950=_0x2009e4;_0x4bf4f0[_0x1e8950(0x1a5)](..._0x1da137);}),_0x4bf4f0;}async function getComponentFromZip(_0x583a14,_0xca42ca){const _0x2706db=a102_0x1d9e34,_0x4bd842=[];for(const _0x44d99c of _0x583a14){const _0x2a261=await zip_1[_0x2706db(0x190)][_0x2706db(0x185)](_0x44d99c[_0x2706db(0x1a6)][_0x2706db(0x1ac)]);for(const _0x593474 in _0x2a261['files']){!_0x2a261[_0x2706db(0x16c)][_0x593474][_0x2706db(0x19c)]&&_0x4bd842['push']({'fileName':_0x593474[_0x2706db(0x1b0)](_0x593474[_0x2706db(0x176)]('/')+0x1),'fileType':_0xca42ca[_0x44d99c['id']],'body':_0x44d99c[_0x2706db(0x1a6)][_0x2706db(0x1ac)]});}}return _0x4bd842;}async function removePermission(_0x20b94b,_0x4b8aa1){const _0x3f13d8=a102_0x1d9e34;for(const _0x54f748 of _0x20b94b){const _0x6ae9d2=await zip_1[_0x3f13d8(0x190)][_0x3f13d8(0x185)](_0x54f748[_0x3f13d8(0x171)]),_0x381860=[];for(const _0x4b0eb4 in _0x6ae9d2[_0x3f13d8(0x16c)]){!_0x6ae9d2[_0x3f13d8(0x16c)][_0x4b0eb4][_0x3f13d8(0x19c)]&&_0x381860[_0x3f13d8(0x1a5)]({'fileName':_0x4b0eb4,'body':await _0x6ae9d2[_0x3f13d8(0x16c)][_0x4b0eb4][_0x3f13d8(0x1aa)](_0x3f13d8(0x1bf))});}const _0x376724=await(0x0,extract_component_permissions_1[_0x3f13d8(0x177)])(_0x381860[0x0][_0x3f13d8(0x171)][_0x3f13d8(0x1ad)](),_0x4b8aa1,_0x54f748['fileType']),_0x467ee9=new xml2js_1[(_0x3f13d8(0x1bc))]({'xmldec':{'version':_0x3f13d8(0x1c6),'encoding':_0x3f13d8(0x18d)}}),_0x3a52f2=_0x467ee9['buildObject'](_0x376724),_0x1f7825=zip_1[_0x3f13d8(0x190)][_0x3f13d8(0x1ba)]();_0x1f7825[_0x3f13d8(0x17b)](_0x381860[0x0][_0x3f13d8(0x1c3)],_0x3a52f2),_0x54f748[_0x3f13d8(0x171)]=await _0x1f7825[_0x3f13d8(0x17a)]({'type':_0x3f13d8(0x180),'compression':_0x3f13d8(0x1c8),'compressionOptions':{'level':0x6}});}}function a102_0x3009(){const _0x25493f=['UTF-8','ComponentsApi','fileType','Zip','__importDefault','addLocalFolder','PermissionSet','every','adm-zip','xml2js','18414774VzBSAK','length','generateAndDeployZip','FOLDER_TO_METADATA_TYPE_MAP','toBuffer','dir','destructiveChangesPre.xml','__esModule','MetadataType','../../git/parsers/utils/zip','uuid','438537HgiyQc','cwd','replace','push','values','Package','PERMISSION_SET','package.xml','async','set','Body','toString','ParentId','2107Sevrtv','substring','fetchAttachmentBody','DEPLOYZIP','splitZip','listMetadataItem','MetadataConstants','writeFile','2778370wmUCJI','orgId','../../git/internal/fs.internal','createZip','post','Builder','.temp','10470cQEEKx','text','src','../utils/components-api','231894lcGHet','fileName','path','then','1.0','BUILD','DEFLATE','defineProperty','get','Name','files','execute','reduce','filter','@flosum/salesforce','body','DeclarativeFilterOptions','buildObject','Profile','Component_Name__c','indexOf','extractComponentPermissions','/sobjects/Attachment','fs/promises','generateAsync','file','permissionsets','/services/data/v','mergeComponentPermissions','type','base64','default','removeNamespacePrefix','MAX_ZIP_SIZE','6111176uqXNtY','unzip','join','types','map','retrieveAttachments','2473616LyraYc','7RDsHCV','(((.+)+)+)+$'];a102_0x3009=function(){return _0x25493f;};return a102_0x3009();}async function retrieveTargetPermissionSets(_0x48f3e3,_0x5754c0,_0x27b915){const _0x7c390d=a102_0x1d9e34,_0x19fb67=_0x48f3e3[_0x7c390d(0x188)](_0x176ac7=>PERMISSION_SET_FOLDER_NAME+'/'+_0x176ac7[_0x7c390d(0x1c3)])[_0x7c390d(0x186)](';'),_0x52b597=[{'field':_0x7c390d(0x1c3),'option':salesforce_1[_0x7c390d(0x172)]['IN'],'value':_0x19fb67}],_0x4da402=new logger_1['Logger']();return new salesforce_1['PartialRetrieve'](_0x5754c0,_0x27b915,_0x4da402,_0x52b597,null,[salesforce_1[_0x7c390d(0x19f)][_0x7c390d(0x1a8)]])[_0x7c390d(0x16d)]();}async function mergePermissionSets(_0x3453eb,_0x560d5c){const _0x23fa37=a102_0x1d9e34,_0xa8a0f0=_0x560d5c[_0x23fa37(0x16e)]((_0x53e75e,_0x12def6)=>_0x53e75e[_0x23fa37(0x1ab)](_0x12def6[_0x23fa37(0x1b4)][_0x23fa37(0x1c3)],_0x12def6),new Map());for(const _0x4cf221 of _0x3453eb){const _0x32c1da=PERMISSION_SET_FOLDER_NAME+'/'+_0x4cf221[_0x23fa37(0x1c3)],_0x295217=_0xa8a0f0[_0x23fa37(0x16a)](_0x32c1da);if(!_0x295217)continue;const _0x5a9dc4=await zip_1[_0x23fa37(0x190)]['unzip'](_0x4cf221[_0x23fa37(0x171)]),_0x5f19b6=await _0x5a9dc4[_0x23fa37(0x16c)][_0x32c1da][_0x23fa37(0x1aa)](_0x23fa37(0x1bf)),_0x3cd740=_0x295217[_0x23fa37(0x16c)][_0x32c1da][_0x23fa37(0x1ad)](),_0x3fef74=await(0x0,extract_component_permissions_1[_0x23fa37(0x17e)])(_0x5f19b6,_0x3cd740,_0x4cf221[_0x23fa37(0x18f)]),_0x3d2fad=zip_1[_0x23fa37(0x190)]['createZip']();_0x3d2fad[_0x23fa37(0x17b)](_0x32c1da,_0x3fef74),_0x4cf221[_0x23fa37(0x171)]=await _0x3d2fad['generateAsync']({'type':_0x23fa37(0x180),'compression':_0x23fa37(0x1c8),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x347619,_0xbd905f,_0x338e73){const _0x29aa50=a102_0x1d9e34;for(const _0x234ac4 of _0x338e73){if(_0x347619[_0x29aa50(0x194)](_0x6bb4c7=>_0x6bb4c7!==_0x234ac4[_0x29aa50(0x18f)]))continue;const _0x528ac5=await zip_1['Zip'][_0x29aa50(0x185)](_0x234ac4[_0x29aa50(0x171)]);for(const _0x3bf623 in _0x528ac5[_0x29aa50(0x16c)]){if(!_0x528ac5[_0x29aa50(0x16c)][_0x3bf623]['dir']){let _0x13aeb5=await _0x528ac5['files'][_0x3bf623]['async']('text');for(const _0x8f9b7e of Object['keys'](_0xbd905f)){const _0x1de5ea=new RegExp('%%'+_0x8f9b7e+'%%','g');_0x13aeb5=_0x13aeb5[_0x29aa50(0x1a4)](_0x1de5ea,_0xbd905f[_0x8f9b7e]);}_0x528ac5[_0x29aa50(0x17b)](_0x3bf623,_0x13aeb5);}}_0x234ac4['body']=await _0x528ac5[_0x29aa50(0x17a)]({'type':_0x29aa50(0x180),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x23966c,_0x530775){const _0x1b5a04=a102_0x1d9e34,_0x2bddb0=new mdapi_writer_1['MDApiWriter']({'components':_0x23966c,'sourceDir':path_1[_0x1b5a04(0x181)]['join'](process[_0x1b5a04(0x1a3)](),'.temp',_0x530775,DEPLOY_DIR_NAME,_0x1b5a04(0x1c0)),'skipChildErrors':![]});await _0x2bddb0[_0x1b5a04(0x16d)]();}async function generateAndWritePackageXML(_0x4cb9a7,_0x1b1160,_0x294bb4,_0x328a4c){const _0x2d6e23=a102_0x1d9e34,_0x3579e7=getComponentsTypeAndName(_0x4cb9a7,_0x1b1160),_0x5836bc=[...new Set(_0x3579e7['map'](_0x4f2b50=>_0x4f2b50[_0x2d6e23(0x17f)]))],_0x4b21ba={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x328a4c}};for(const _0x41ba0a of _0x5836bc){const _0x37a341=_0x3579e7[_0x2d6e23(0x16f)](_0x5dff30=>_0x5dff30[_0x2d6e23(0x17f)]===_0x41ba0a)[_0x2d6e23(0x188)](_0x28fd49=>_0x28fd49['name']),_0x292490={'members':_0x37a341,'name':_0x41ba0a};_0x4b21ba[_0x2d6e23(0x1a7)][_0x2d6e23(0x187)][_0x2d6e23(0x1a5)](_0x292490);}const _0x53ea18=new xml2js_1[(_0x2d6e23(0x1bc))]({'xmldec':{'version':'1.0','encoding':_0x2d6e23(0x18d)}}),_0x378487=_0x53ea18[_0x2d6e23(0x173)](_0x4b21ba);await fs_internal_1['FS'][_0x2d6e23(0x1b6)](path_1[_0x2d6e23(0x181)][_0x2d6e23(0x186)](process[_0x2d6e23(0x1a3)](),'.temp',_0x294bb4,DEPLOY_DIR_NAME,'src',_0x2d6e23(0x1a9)),_0x378487);}function getComponentsTypeAndName(_0x13b276,_0x20c784){const _0x1eb182=a102_0x1d9e34;return _0x13b276[_0x1eb182(0x16e)]((_0x11ce3a,_0x4f4d80)=>{const _0x24f4bc=_0x1eb182,_0x503963=_0x20c784['find'](_0x3df20c=>_0x3df20c['Id']===_0x4f4d80[_0x24f4bc(0x1ae)]);return _0x503963&&_0x11ce3a[_0x24f4bc(0x1a5)]({'name':_0x503963['Component__r'][_0x24f4bc(0x175)],'type':salesforce_1[_0x24f4bc(0x1b5)][_0x24f4bc(0x19a)][_0x4f4d80[_0x24f4bc(0x16b)]]||_0x4f4d80[_0x24f4bc(0x16b)]}),_0x11ce3a;},[]);}async function saveDestructiveChanges(_0xc9fb51,_0x1b8b7e,_0x4c6c11,_0x129d71){const _0x325abe=a102_0x1d9e34,_0x35568b=(await(0x0,fetch_attachments_1[_0x325abe(0x1b1)])(_0xc9fb51,_0x1b8b7e))[_0x325abe(0x1ad)]();await fs_internal_1['FS'][_0x325abe(0x1b6)](path_1['default'][_0x325abe(0x186)](process[_0x325abe(0x1a3)](),_0x325abe(0x1bd),_0x129d71,DEPLOY_DIR_NAME,_0x325abe(0x1c0),_0x4c6c11),_0x35568b);}async function createDeployZip(_0x34db63){const _0x4b6a4c=a102_0x1d9e34,_0x1151c3=new adm_zip_1[(_0x4b6a4c(0x181))]();return await _0x1151c3[_0x4b6a4c(0x192)](path_1[_0x4b6a4c(0x181)][_0x4b6a4c(0x186)](process[_0x4b6a4c(0x1a3)](),'.temp',_0x34db63,DEPLOY_DIR_NAME)),_0x1151c3;}async function insertZip(_0x428984,_0x473b30,_0x51583a,_0x965ff8,_0x43d7fd,_0x121771){const _0x1ba692=a102_0x1d9e34,_0x36f0b2={'ParentId':_0x473b30,'Name':_0x1ba692(0x1c7)+_0x51583a,'Description':_0x1ba692(0x1c7)+_0x965ff8,'Body':_0x43d7fd},{data:_0x35239f}=await _0x428984[_0x1ba692(0x1bb)](_0x1ba692(0x17d)+_0x121771+_0x1ba692(0x178),_0x36f0b2);return _0x35239f['id'];}