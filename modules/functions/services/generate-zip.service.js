const a86_0x2e881c=a86_0x3977;(function(_0x2cc835,_0x2dbcfa){const _0x1b4230=a86_0x3977,_0x42233b=_0x2cc835();while(!![]){try{const _0x4c4bae=-parseInt(_0x1b4230(0x1eb))/0x1+parseInt(_0x1b4230(0x210))/0x2+parseInt(_0x1b4230(0x1fb))/0x3*(parseInt(_0x1b4230(0x1fd))/0x4)+-parseInt(_0x1b4230(0x202))/0x5*(parseInt(_0x1b4230(0x1f4))/0x6)+-parseInt(_0x1b4230(0x1b5))/0x7+parseInt(_0x1b4230(0x1b8))/0x8+parseInt(_0x1b4230(0x1e4))/0x9*(parseInt(_0x1b4230(0x1f9))/0xa);if(_0x4c4bae===_0x2dbcfa)break;else _0x42233b['push'](_0x42233b['shift']());}catch(_0x7c27de){_0x42233b['push'](_0x42233b['shift']());}}}(a86_0x1410,0x558f8));const a86_0x147eb2=(function(){let _0x4d256d=!![];return function(_0x2ff598,_0x39717a){const _0x1327a6=_0x4d256d?function(){const _0x3ad425=a86_0x3977;if(_0x39717a){const _0x5b2699=_0x39717a[_0x3ad425(0x206)](_0x2ff598,arguments);return _0x39717a=null,_0x5b2699;}}:function(){};return _0x4d256d=![],_0x1327a6;};}()),a86_0x359951=a86_0x147eb2(this,function(){const _0x3d604e=a86_0x3977;return a86_0x359951[_0x3d604e(0x1b6)]()[_0x3d604e(0x1ef)]('(((.+)+)+)+$')['toString']()[_0x3d604e(0x1da)](a86_0x359951)['search']('(((.+)+)+)+$');});a86_0x359951();'use strict';var __importDefault=this&&this[a86_0x2e881c(0x213)]||function(_0x79ef1){const _0x8f7e3e=a86_0x2e881c;return _0x79ef1&&_0x79ef1[_0x8f7e3e(0x1de)]?_0x79ef1:{'default':_0x79ef1};};Object[a86_0x2e881c(0x1f8)](exports,'__esModule',{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require(a86_0x2e881c(0x208))),extract_component_permissions_1=require(a86_0x2e881c(0x1f2)),xml2js_1=require('xml2js'),zip_1=require(a86_0x2e881c(0x1c7)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a86_0x2e881c(0x201)),promises_1=require(a86_0x2e881c(0x1fc)),components_api_1=require(a86_0x2e881c(0x1e9)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a86_0x2e881c(0x209)),fetch_attachments_1=require(a86_0x2e881c(0x1b9)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a86_0x2e881c(0x1cb),DEPLOY_DIR_NAME=a86_0x2e881c(0x1d9);async function generateAndDeployZip({attachmentsId:_0x487601,isExtractComponentsPermissions:_0x578e48,preDestructiveAttachmentId:_0x32d62a,postDestructiveAttachmentId:_0x2bc015,branchId:_0x8ebd8c,credentials:_0x207857,metadataLogId:_0x146efa,environments:_0x209d50,metaTypes:_0x5609da},_0x46032a){const _0x53b480=a86_0x2e881c,_0x4ef07e=(0x0,uuid_1['v4'])();try{const _0x1811b2=await(0x0,fetch_attachments_1[_0x53b480(0x1e2)])(_0x46032a,_0x487601),_0x11452f=_0x1811b2[_0x53b480(0x1ff)]((_0x177180,_0x5c02e9)=>({..._0x177180,[_0x5c02e9['Id']]:_0x5c02e9[_0x53b480(0x20c)]}),{}),_0x4b9fcd=await getComponents(_0x1811b2,_0x46032a,_0x11452f),_0x3b35ed=await components_api_1[_0x53b480(0x1ec)][_0x53b480(0x1b7)](_0x46032a,_0x1811b2['map'](({ParentId:_0x463e1c})=>_0x463e1c))[_0x53b480(0x1be)](_0x12c6ae=>components_api_1[_0x53b480(0x1ec)]['removeNamespacePrefix'](_0x12c6ae));if(_0x578e48){const _0x5a0c9d=_0x4b9fcd[_0x53b480(0x1e0)](({fileType:_0x370903})=>_0x370903===_0x53b480(0x1c3)||_0x370903===_0x53b480(0x1fe));await removePermission(_0x5a0c9d,_0x3b35ed);}await replaceEnvironments(_0x5609da,_0x209d50,_0x4b9fcd),await writeZip(_0x4b9fcd,_0x4ef07e),await generateAndWritePackageXML(_0x1811b2,_0x3b35ed,_0x4ef07e);_0x32d62a&&await saveDestructiveChanges(_0x46032a,_0x32d62a,DESTRUCTIVE_CHANGES_PER_NAME,_0x4ef07e);_0x2bc015&&await saveDestructiveChanges(_0x46032a,_0x2bc015,DESTRUCTIVE_CHANGES_POST_NAME,_0x4ef07e);const _0x2fc6d0=(await createDeployZip(_0x4ef07e)[_0x53b480(0x1be)](_0x292c26=>{return _0x292c26;}))[_0x53b480(0x1c4)]()[_0x53b480(0x1b6)](_0x53b480(0x20d));console[_0x53b480(0x207)](_0x53b480(0x1ed));const _0x3981c0=_0x2fc6d0[_0x53b480(0x203)];if(_0x3981c0>=components_api_1[_0x53b480(0x205)]){const _0x4dcc23=await createDeployZip(_0x4ef07e);console[_0x53b480(0x207)](_0x53b480(0x20f));const [_0x549180,_0x77a5d2]=await components_api_1[_0x53b480(0x1ec)][_0x53b480(0x1fa)](_0x4dcc23,_0x3981c0),_0x337fef=await insertZip(_0x46032a,_0x8ebd8c,_0x207857['orgId'],_0x146efa,_0x549180['toBuffer']()['toString'](_0x53b480(0x20d))),_0x285955=await insertZip(_0x46032a,_0x8ebd8c,_0x207857[_0x53b480(0x1ce)],_0x146efa,_0x77a5d2[_0x53b480(0x1c4)]()['toString']('base64'));return _0x337fef+','+_0x285955;}else return await insertZip(_0x46032a,_0x8ebd8c,_0x207857[_0x53b480(0x1ce)],_0x146efa,_0x2fc6d0);}catch(_0x33fcf0){throw _0x33fcf0;}finally{if(await fs_internal_1['FS'][_0x53b480(0x1ba)](path_1[_0x53b480(0x1ea)][_0x53b480(0x1d8)](process[_0x53b480(0x1d2)](),_0x53b480(0x200),_0x4ef07e)))await(0x0,promises_1['rm'])(path_1[_0x53b480(0x1ea)][_0x53b480(0x1d8)](process[_0x53b480(0x1d2)](),_0x53b480(0x200),_0x4ef07e),{'recursive':!![]});}}exports[a86_0x2e881c(0x1d3)]=generateAndDeployZip;async function getComponents(_0x5647bc,_0x54605b,_0x3270c0){const _0x41602d=a86_0x2e881c,_0x36990a=[],_0x21f5ed=await(0x0,fetch_attachments_1[_0x41602d(0x204)])(_0x5647bc,_0x54605b);return await getComponentFromZip(_0x21f5ed,_0x3270c0)['then'](_0xed67e1=>{const _0x5217bd=_0x41602d;_0x36990a[_0x5217bd(0x1cd)](..._0xed67e1);}),_0x36990a;}async function getComponentFromZip(_0x404062,_0x586808){const _0x10324f=a86_0x2e881c,_0x4e9149=[];for(const _0x5272b1 of _0x404062){const _0x4bf841=await zip_1[_0x10324f(0x1c6)][_0x10324f(0x1f5)](_0x5272b1[_0x10324f(0x1e1)]['Body']);for(const _0x1deaf1 in _0x4bf841[_0x10324f(0x1c9)]){!_0x4bf841[_0x10324f(0x1c9)][_0x1deaf1]['dir']&&_0x4e9149['push']({'fileName':_0x1deaf1['substring'](_0x1deaf1[_0x10324f(0x1bf)]('/')+0x1),'fileType':_0x586808[_0x5272b1['id']],'body':_0x5272b1[_0x10324f(0x1e1)][_0x10324f(0x1e7)]});}}return _0x4e9149;}async function removePermission(_0x2ab98f,_0x57e880){const _0x2a5674=a86_0x2e881c;for(const _0x26c4c6 of _0x2ab98f){const _0x1059fb=await zip_1[_0x2a5674(0x1c6)][_0x2a5674(0x1f5)](_0x26c4c6['body']),_0x50b709=[];for(const _0x337237 in _0x1059fb[_0x2a5674(0x1c9)]){!_0x1059fb[_0x2a5674(0x1c9)][_0x337237][_0x2a5674(0x1d7)]&&_0x50b709[_0x2a5674(0x1cd)]({'fileName':_0x337237,'body':await _0x1059fb['files'][_0x337237][_0x2a5674(0x1d1)](_0x2a5674(0x1dd))});}const _0x12a7c1=await(0x0,extract_component_permissions_1[_0x2a5674(0x1cc)])(_0x50b709[0x0][_0x2a5674(0x1dc)][_0x2a5674(0x1b6)](),_0x57e880,_0x26c4c6[_0x2a5674(0x1ca)]),_0x49b2fc=new xml2js_1[(_0x2a5674(0x212))]({'xmldec':{'version':_0x2a5674(0x1c5),'encoding':_0x2a5674(0x1cf)}}),_0x4e5852=_0x49b2fc[_0x2a5674(0x1f0)](_0x12a7c1),_0x54fd7d=zip_1['Zip']['createZip']();_0x54fd7d['file'](_0x50b709[0x0][_0x2a5674(0x1c0)],_0x4e5852),_0x26c4c6[_0x2a5674(0x1dc)]=await _0x54fd7d[_0x2a5674(0x1f1)]({'type':_0x2a5674(0x20d),'compression':_0x2a5674(0x1df),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x57c041,_0x5ea6ad,_0x119643){const _0x418657=a86_0x2e881c;for(const _0x2451ef of _0x119643){if(_0x57c041['every'](_0x245a7e=>_0x245a7e!==_0x2451ef[_0x418657(0x1ca)]))continue;const _0xdacb69=await zip_1[_0x418657(0x1c6)]['unzip'](_0x2451ef[_0x418657(0x1dc)]);for(const _0x1ccc79 in _0xdacb69[_0x418657(0x1c9)]){if(!_0xdacb69[_0x418657(0x1c9)][_0x1ccc79][_0x418657(0x1d7)]){let _0x5708ff=await _0xdacb69['files'][_0x1ccc79][_0x418657(0x1d1)](_0x418657(0x1dd));for(const _0x247ef0 of Object[_0x418657(0x20a)](_0x5ea6ad)){const _0x58b650=new RegExp('%%'+_0x247ef0+'%%','g');_0x5708ff=_0x5708ff[_0x418657(0x1bc)](_0x58b650,_0x5ea6ad[_0x247ef0]);}_0xdacb69[_0x418657(0x1d5)](_0x1ccc79,_0x5708ff);}}_0x2451ef[_0x418657(0x1dc)]=await _0xdacb69['generateAsync']({'type':_0x418657(0x20d),'compression':_0x418657(0x1df),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x4e8c1f,_0x1d357d){const _0x4fbf27=a86_0x2e881c,_0x3f2c85=new mdapi_1[(_0x4fbf27(0x1e8))]({'components':_0x4e8c1f,'sourceDir':path_1[_0x4fbf27(0x1ea)][_0x4fbf27(0x1d8)](process[_0x4fbf27(0x1d2)](),_0x4fbf27(0x200),_0x1d357d,DEPLOY_DIR_NAME,_0x4fbf27(0x1db)),'skipChildErrors':![]});await _0x3f2c85[_0x4fbf27(0x211)]();}async function generateAndWritePackageXML(_0x575f9e,_0x344890,_0x6c2a4a){const _0x31c421=a86_0x2e881c,_0x2520d6=getComponentsTypeAndName(_0x575f9e,_0x344890),_0x5f29ed=[...new Set(_0x2520d6[_0x31c421(0x1bd)](_0x9a6a1b=>_0x9a6a1b[_0x31c421(0x214)]))],_0x38a477={'Package':{'$':{'xmlns':_0x31c421(0x1c8)},'types':[],'version':''+constants_1[_0x31c421(0x1f6)][_0x31c421(0x1f3)](0x1)}};for(const _0x5996db of _0x5f29ed){const _0x294478=_0x2520d6['filter'](_0x2b1402=>_0x2b1402[_0x31c421(0x214)]===_0x5996db)[_0x31c421(0x1bd)](_0x423d98=>_0x423d98[_0x31c421(0x1f7)]),_0x3d304b={'members':_0x294478,'name':_0x5996db};_0x38a477[_0x31c421(0x1c1)][_0x31c421(0x1e3)]['push'](_0x3d304b);}const _0x3ba111=new xml2js_1[(_0x31c421(0x212))]({'xmldec':{'version':_0x31c421(0x1c5),'encoding':'UTF-8'}}),_0x23f3e0=_0x3ba111[_0x31c421(0x1f0)](_0x38a477);await fs_internal_1['FS'][_0x31c421(0x1d6)](path_1[_0x31c421(0x1ea)][_0x31c421(0x1d8)](process[_0x31c421(0x1d2)](),_0x31c421(0x200),_0x6c2a4a,DEPLOY_DIR_NAME,'src','package.xml'),_0x23f3e0);}function getComponentsTypeAndName(_0x31ba0d,_0x19a2f1){const _0x3531d2=a86_0x2e881c;return _0x31ba0d[_0x3531d2(0x1ff)]((_0x39e67a,_0x505b8b)=>{const _0x2419a9=_0x3531d2,_0x31d67c=_0x19a2f1[_0x2419a9(0x1d0)](_0x557d5a=>_0x557d5a['Id']===_0x505b8b[_0x2419a9(0x1d4)]);return _0x31d67c&&_0x39e67a[_0x2419a9(0x1cd)]({'name':_0x31d67c[_0x2419a9(0x1e5)][_0x2419a9(0x20b)],'type':_0x505b8b[_0x2419a9(0x20c)]}),_0x39e67a;},[]);}async function saveDestructiveChanges(_0x30950d,_0x4be2fb,_0x4e659a,_0x4f4587){const _0x3cc451=a86_0x2e881c,_0x4adce3=(await(0x0,fetch_attachments_1[_0x3cc451(0x1ee)])(_0x30950d,_0x4be2fb))[_0x3cc451(0x1b6)]();await fs_internal_1['FS'][_0x3cc451(0x1d6)](path_1[_0x3cc451(0x1ea)][_0x3cc451(0x1d8)](process[_0x3cc451(0x1d2)](),'.temp',_0x4f4587,DEPLOY_DIR_NAME,_0x3cc451(0x1db),_0x4e659a),_0x4adce3);}function a86_0x1410(){const _0x3c8caa=['toBuffer','1.0','Zip','../../git/parsers/utils/zip','http://soap.sforce.com/2006/04/metadata','files','fileType','destructiveChangesPost.xml','extractComponentPermissions','push','orgId','UTF-8','find','async','cwd','generateAndDeployZip','ParentId','file','writeFile','dir','join','DEPLOYZIP','constructor','src','body','text','__esModule','DEFLATE','filter','values','fetchAttachmentsDetailsById','types','1431oSwpMv','Component__r','post','Body','MDApiWriter','../utils/components-api','default','255890OxXGJq','ComponentsApi','after\x20create\x20zip','fetchAttachmentBody','search','buildObject','generateAsync','../utils/extract-component-permissions','substring','12hpbnvh','unzip','SALESFORCE_API_VERSION','name','defineProperty','6210crrzSY','splitZip','9bAcvQO','fs/promises','56712TbQZRH','PermissionSet','reduce','.temp','../../git/internal/fs.internal','213430TYnSjp','length','retrieveAttachments','MAX_ZIP_SIZE','apply','log','path','uuid','keys','Component_Name__c','Name','base64','/services/data/','after\x20create\x20second\x20zip','1005756oVPkBz','start','Builder','__importDefault','type','BUILD','4137098DHZaoN','toString','fetchComponentsDetailsByComponentsHistory','5108648PaJjEj','../../shared/utils/fetch-attachments','exists','/sobjects/Attachment','replace','map','then','indexOf','fileName','Package','addLocalFolder','Profile'];a86_0x1410=function(){return _0x3c8caa;};return a86_0x1410();}async function createDeployZip(_0x194b36){const _0x47799f=a86_0x2e881c,_0x3c1d3c=new adm_zip_1[(_0x47799f(0x1ea))]();return await _0x3c1d3c[_0x47799f(0x1c2)](path_1[_0x47799f(0x1ea)][_0x47799f(0x1d8)](process['cwd'](),_0x47799f(0x200),_0x194b36,DEPLOY_DIR_NAME)),_0x3c1d3c;}function a86_0x3977(_0x79f458,_0x435520){const _0x4c812e=a86_0x1410();return a86_0x3977=function(_0x359951,_0x147eb2){_0x359951=_0x359951-0x1b5;let _0x141017=_0x4c812e[_0x359951];return _0x141017;},a86_0x3977(_0x79f458,_0x435520);}async function insertZip(_0x1851db,_0x3a5385,_0x6e78af,_0x40f13e,_0x5b855c){const _0x315be0=a86_0x2e881c,_0xf4c1d2={'ParentId':_0x3a5385,'Name':_0x315be0(0x215)+_0x6e78af,'Description':_0x315be0(0x215)+_0x40f13e,'Body':_0x5b855c},{data:_0x1f0062}=await _0x1851db[_0x315be0(0x1e6)](_0x315be0(0x20e)+constants_1[_0x315be0(0x1f6)]+_0x315be0(0x1bb),_0xf4c1d2);return _0x1f0062['id'];}