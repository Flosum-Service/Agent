const a104_0x187942=a104_0x141d;(function(_0x426258,_0x5102ae){const _0x3be658=a104_0x141d,_0x541217=_0x426258();while(!![]){try{const _0x3a92cd=-parseInt(_0x3be658(0x13d))/0x1*(-parseInt(_0x3be658(0x101))/0x2)+-parseInt(_0x3be658(0x15a))/0x3+parseInt(_0x3be658(0x116))/0x4+-parseInt(_0x3be658(0x14e))/0x5*(-parseInt(_0x3be658(0x15e))/0x6)+parseInt(_0x3be658(0x11b))/0x7*(-parseInt(_0x3be658(0x159))/0x8)+parseInt(_0x3be658(0x108))/0x9+-parseInt(_0x3be658(0x155))/0xa*(parseInt(_0x3be658(0x13f))/0xb);if(_0x3a92cd===_0x5102ae)break;else _0x541217['push'](_0x541217['shift']());}catch(_0x1460ba){_0x541217['push'](_0x541217['shift']());}}}(a104_0x265e,0x62b67));const a104_0x2ae613=(function(){let _0x390d0f=!![];return function(_0x4a968c,_0x350e1b){const _0x39e88c=_0x390d0f?function(){const _0x586779=a104_0x141d;if(_0x350e1b){const _0x439a9e=_0x350e1b[_0x586779(0x150)](_0x4a968c,arguments);return _0x350e1b=null,_0x439a9e;}}:function(){};return _0x390d0f=![],_0x39e88c;};}()),a104_0xa2f72d=a104_0x2ae613(this,function(){const _0x148c89=a104_0x141d;return a104_0xa2f72d[_0x148c89(0x102)]()[_0x148c89(0x114)](_0x148c89(0x161))[_0x148c89(0x102)]()['constructor'](a104_0xa2f72d)[_0x148c89(0x114)](_0x148c89(0x161));});a104_0xa2f72d();'use strict';var __importDefault=this&&this[a104_0x187942(0x160)]||function(_0x126223){const _0x3d0b0d=a104_0x187942;return _0x126223&&_0x126223[_0x3d0b0d(0x146)]?_0x126223:{'default':_0x126223};};function a104_0x265e(){const _0x50540f=['PERMISSION_SET','length','path','join','30TkMKpX','base64','destructiveChangesPost.xml','PermissionSet','125408LWZhcD','463467JidChY','filter','then','1.0','12qEzWAc','ComponentsApi','__importDefault','(((.+)+)+)+$','push','fetchComponentsDetailsByComponentsHistory','374280uFBCwi','toString','ParentId','Builder','Package','@flosum/salesforce','permissionsets','5683005xXYiep','fetchAttachmentsDetailsById','keys','destructiveChangesPre.xml','fetchAttachmentBody','buildObject','xml2js','removeNamespacePrefix','PartialRetrieve','map','Component_Name__c','type','search','Zip','2667596MyTruJ','values','toBuffer','generateAndDeployZip','mergeComponentPermissions','287gBxvsB','DeclarativeFilterOptions','reduce','FOLDER_TO_METADATA_TYPE_MAP','unzip','.temp','replace','files','MetadataConstants','../classes/logger','indexOf','../utils/extract-component-permissions','DEFLATE','orgId','http://soap.sforce.com/2006/04/metadata','generateAsync','BUILD','defineProperty','components','get','MAX_ZIP_SIZE','splitZip','MDApiWriter','writeFile','file','Name','UTF-8','Body','../../git/internal/fs.internal','find','dir','async','fileType','/services/data/v','4gaXZUL','/sobjects/Attachment','6043246KRhjwA','body','../../shared/utils/fetch-attachments','types','substring','createZip','cwd','__esModule','Component__r','src','post','default','text','package.xml','fileName','2006965cfsPpq','execute','apply'];a104_0x265e=function(){return _0x50540f;};return a104_0x265e();}Object[a104_0x187942(0x12c)](exports,a104_0x187942(0x146),{'value':!![]}),exports[a104_0x187942(0x119)]=void 0x0;const path_1=__importDefault(require(a104_0x187942(0x153))),extract_component_permissions_1=require(a104_0x187942(0x126)),logger_1=require(a104_0x187942(0x124)),xml2js_1=require(a104_0x187942(0x10e)),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require('../../git/writers/mdapi.writer'),fs_internal_1=require(a104_0x187942(0x137)),promises_1=require('fs/promises'),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require('uuid'),fetch_attachments_1=require(a104_0x187942(0x141)),salesforce_1=require(a104_0x187942(0x106)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x187942(0x10b),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x187942(0x157),DEPLOY_DIR_NAME='DEPLOYZIP',PERMISSION_SET_FOLDER_NAME=a104_0x187942(0x107);async function generateAndDeployZip({attachmentsId:_0x156941,isExtractComponentsPermissionSets:_0x36dc83,isExtractComponentsProfiles:_0x5e98b3,preDestructiveAttachmentId:_0x5b606a,postDestructiveAttachmentId:_0x1db321,branchId:_0x33548a,credentials:_0x19ddf8,metadataLogId:_0x48522e,environments:_0x438cf4,metaTypes:_0x10f842,apiVersion:_0x26ed80},_0x1ca622,_0x2fcb71){const _0x3169c5=a104_0x187942;var _0x42754f;const _0x281953=(0x0,uuid_1['v4'])();try{const _0x28d65b=await(0x0,fetch_attachments_1[_0x3169c5(0x109)])(_0x1ca622,_0x156941),_0x547b60=_0x28d65b[_0x3169c5(0x11d)]((_0x1b85f7,_0x185fed)=>({..._0x1b85f7,[_0x185fed['Id']]:_0x185fed[_0x3169c5(0x134)]}),{}),_0x251ede=await getComponents(_0x28d65b,_0x1ca622,_0x547b60),_0x158073=await components_api_1[_0x3169c5(0x15f)][_0x3169c5(0x100)](_0x1ca622,_0x28d65b[_0x3169c5(0x111)](({ParentId:_0x4c0e36})=>_0x4c0e36),_0x26ed80)['then'](_0x19c654=>components_api_1[_0x3169c5(0x15f)][_0x3169c5(0x10f)](_0x19c654));if(_0x5e98b3){const _0x58cdc=_0x251ede['filter'](({fileType:_0x463104})=>_0x463104==='Profile');await removePermission(_0x58cdc,_0x158073);}const _0x2af76a=_0x251ede['filter'](({fileType:_0xdf84})=>_0xdf84==='PermissionSet');if(_0x2af76a['length']&&_0x36dc83){await removePermission(_0x2af76a,_0x158073);const {items:_0xc860f}=await retrieveTargetPermissionSets(_0x2af76a,_0x26ed80,_0x2fcb71);await mergePermissionSets(_0x2af76a,((_0x42754f=_0xc860f[_0x3169c5(0x158)])===null||_0x42754f===void 0x0?void 0x0:_0x42754f[_0x3169c5(0x12d)])||[]);}await replaceEnvironments(_0x10f842,_0x438cf4,_0x251ede),await writeZip(_0x251ede,_0x281953),await generateAndWritePackageXML(_0x28d65b,_0x158073,_0x281953,_0x26ed80);_0x5b606a&&await saveDestructiveChanges(_0x1ca622,_0x5b606a,DESTRUCTIVE_CHANGES_PER_NAME,_0x281953);_0x1db321&&await saveDestructiveChanges(_0x1ca622,_0x1db321,DESTRUCTIVE_CHANGES_POST_NAME,_0x281953);const _0x51fb25=(await createDeployZip(_0x281953)[_0x3169c5(0x15c)](_0x4916ff=>{return _0x4916ff;}))[_0x3169c5(0x118)]()[_0x3169c5(0x102)](_0x3169c5(0x156)),_0xc64e30=_0x51fb25[_0x3169c5(0x152)];if(_0xc64e30>=components_api_1[_0x3169c5(0x12f)]){const _0x445e3e=await createDeployZip(_0x281953),[_0x4def86,_0x2cd462]=await components_api_1[_0x3169c5(0x15f)][_0x3169c5(0x130)](_0x445e3e,_0xc64e30),_0x300123=await insertZip(_0x1ca622,_0x33548a,_0x19ddf8['orgId'],_0x48522e,_0x4def86[_0x3169c5(0x118)]()[_0x3169c5(0x102)](_0x3169c5(0x156)),_0x26ed80),_0x274c40=await insertZip(_0x1ca622,_0x33548a,_0x19ddf8[_0x3169c5(0x128)],_0x48522e,_0x2cd462[_0x3169c5(0x118)]()[_0x3169c5(0x102)]('base64'),_0x26ed80);return _0x300123+','+_0x274c40;}else return await insertZip(_0x1ca622,_0x33548a,_0x19ddf8[_0x3169c5(0x128)],_0x48522e,_0x51fb25,_0x26ed80);}catch(_0x41be62){throw _0x41be62;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x3169c5(0x14a)]['join'](process[_0x3169c5(0x145)](),'.temp',_0x281953)))await(0x0,promises_1['rm'])(path_1[_0x3169c5(0x14a)][_0x3169c5(0x154)](process[_0x3169c5(0x145)](),_0x3169c5(0x120),_0x281953),{'recursive':!![]});}}exports[a104_0x187942(0x119)]=generateAndDeployZip;function a104_0x141d(_0x514a80,_0x5357e8){const _0x3da22b=a104_0x265e();return a104_0x141d=function(_0xa2f72d,_0x2ae613){_0xa2f72d=_0xa2f72d-0xff;let _0x265e3e=_0x3da22b[_0xa2f72d];return _0x265e3e;},a104_0x141d(_0x514a80,_0x5357e8);}async function getComponents(_0x3b02a7,_0x1215c2,_0x41bf37){const _0x478184=a104_0x187942,_0x6e9a02=[],_0x56ffed=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x3b02a7,_0x1215c2);return await getComponentFromZip(_0x56ffed,_0x41bf37)[_0x478184(0x15c)](_0x32978c=>{const _0x34cfd8=_0x478184;_0x6e9a02[_0x34cfd8(0xff)](..._0x32978c);}),_0x6e9a02;}async function getComponentFromZip(_0x55f3af,_0xc126ab){const _0x5470f9=a104_0x187942,_0x15235b=[];for(const _0x162994 of _0x55f3af){const _0x9d4913=await zip_1[_0x5470f9(0x115)][_0x5470f9(0x11f)](_0x162994[_0x5470f9(0x117)][_0x5470f9(0x136)]);for(const _0x4197fa in _0x9d4913[_0x5470f9(0x122)]){!_0x9d4913['files'][_0x4197fa][_0x5470f9(0x139)]&&_0x15235b['push']({'fileName':_0x4197fa[_0x5470f9(0x143)](_0x4197fa[_0x5470f9(0x125)]('/')+0x1),'fileType':_0xc126ab[_0x162994['id']],'body':_0x162994['values'][_0x5470f9(0x136)]});}}return _0x15235b;}async function removePermission(_0xcaae20,_0x2dfc8b){const _0x4ab463=a104_0x187942;for(const _0x57453d of _0xcaae20){const _0x2821ef=await zip_1[_0x4ab463(0x115)][_0x4ab463(0x11f)](_0x57453d[_0x4ab463(0x140)]),_0x2802be=[];for(const _0x16e7da in _0x2821ef['files']){!_0x2821ef[_0x4ab463(0x122)][_0x16e7da][_0x4ab463(0x139)]&&_0x2802be[_0x4ab463(0xff)]({'fileName':_0x16e7da,'body':await _0x2821ef['files'][_0x16e7da][_0x4ab463(0x13a)](_0x4ab463(0x14b))});}const _0x51b436=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x2802be[0x0]['body']['toString'](),_0x2dfc8b,_0x57453d['fileType']),_0x1339e7=new xml2js_1[(_0x4ab463(0x104))]({'xmldec':{'version':_0x4ab463(0x15d),'encoding':_0x4ab463(0x135)}}),_0xeaeb86=_0x1339e7[_0x4ab463(0x10d)](_0x51b436),_0x546a17=zip_1['Zip'][_0x4ab463(0x144)]();_0x546a17[_0x4ab463(0x133)](_0x2802be[0x0][_0x4ab463(0x14d)],_0xeaeb86),_0x57453d[_0x4ab463(0x140)]=await _0x546a17[_0x4ab463(0x12a)]({'type':'base64','compression':_0x4ab463(0x127),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x119b90,_0x47e01e,_0x2553de){const _0x18eefb=a104_0x187942,_0x1e1599=_0x119b90[_0x18eefb(0x111)](_0x497ab5=>PERMISSION_SET_FOLDER_NAME+'/'+_0x497ab5[_0x18eefb(0x14d)])[_0x18eefb(0x154)](';'),_0x46dd6b=[{'field':_0x18eefb(0x14d),'option':salesforce_1[_0x18eefb(0x11c)]['IN'],'value':_0x1e1599}],_0x5ee2e0=new logger_1['Logger']();return new salesforce_1[(_0x18eefb(0x110))](_0x47e01e,_0x2553de,_0x5ee2e0,_0x46dd6b,null,[salesforce_1['MetadataType'][_0x18eefb(0x151)]])[_0x18eefb(0x14f)]();}async function mergePermissionSets(_0x27fa84,_0x46f948){const _0x2b8efc=a104_0x187942,_0x181a21=_0x46f948['reduce']((_0x402482,_0x5b0410)=>_0x402482['set'](_0x5b0410['listMetadataItem'][_0x2b8efc(0x14d)],_0x5b0410),new Map());for(const _0x294844 of _0x27fa84){const _0xcfbd53=PERMISSION_SET_FOLDER_NAME+'/'+_0x294844[_0x2b8efc(0x14d)],_0x2523e5=_0x181a21[_0x2b8efc(0x12e)](_0xcfbd53);if(!_0x2523e5)continue;const _0x2c3a8d=await zip_1['Zip'][_0x2b8efc(0x11f)](_0x294844['body']),_0x4fc89b=await _0x2c3a8d[_0x2b8efc(0x122)][_0xcfbd53]['async'](_0x2b8efc(0x14b)),_0x3fed91=_0x2523e5['files'][_0xcfbd53][_0x2b8efc(0x102)](),_0x546f25=await(0x0,extract_component_permissions_1[_0x2b8efc(0x11a)])(_0x4fc89b,_0x3fed91,_0x294844['fileType']),_0x4eb5ee=zip_1[_0x2b8efc(0x115)][_0x2b8efc(0x144)]();_0x4eb5ee['file'](_0xcfbd53,_0x546f25),_0x294844['body']=await _0x4eb5ee[_0x2b8efc(0x12a)]({'type':_0x2b8efc(0x156),'compression':_0x2b8efc(0x127),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x430634,_0x539236,_0x222fd1){const _0xb44302=a104_0x187942;for(const _0x5941e8 of _0x222fd1){if(_0x430634['every'](_0x587b72=>_0x587b72!==_0x5941e8[_0xb44302(0x13b)]))continue;const _0x5a2b3e=await zip_1[_0xb44302(0x115)]['unzip'](_0x5941e8[_0xb44302(0x140)]);for(const _0x42985e in _0x5a2b3e['files']){if(!_0x5a2b3e[_0xb44302(0x122)][_0x42985e][_0xb44302(0x139)]){let _0x5bb03c=await _0x5a2b3e[_0xb44302(0x122)][_0x42985e][_0xb44302(0x13a)]('text');for(const _0x3a6043 of Object[_0xb44302(0x10a)](_0x539236)){const _0x5cc5ed=new RegExp('%%'+_0x3a6043+'%%','g');_0x5bb03c=_0x5bb03c[_0xb44302(0x121)](_0x5cc5ed,_0x539236[_0x3a6043]);}_0x5a2b3e[_0xb44302(0x133)](_0x42985e,_0x5bb03c);}}_0x5941e8[_0xb44302(0x140)]=await _0x5a2b3e['generateAsync']({'type':'base64','compression':_0xb44302(0x127),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x4700af,_0x292fd4){const _0x3289d7=a104_0x187942,_0x17e4b7=new mdapi_writer_1[(_0x3289d7(0x131))]({'components':_0x4700af,'sourceDir':path_1['default'][_0x3289d7(0x154)](process['cwd'](),_0x3289d7(0x120),_0x292fd4,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x17e4b7[_0x3289d7(0x14f)]();}async function generateAndWritePackageXML(_0x2033d8,_0x489081,_0x37a36b,_0x64e5e1){const _0x118df4=a104_0x187942,_0xd631cc=getComponentsTypeAndName(_0x2033d8,_0x489081),_0x2f9065=[...new Set(_0xd631cc[_0x118df4(0x111)](_0x252169=>_0x252169[_0x118df4(0x113)]))],_0x2debdd={'Package':{'$':{'xmlns':_0x118df4(0x129)},'types':[],'version':''+_0x64e5e1}};for(const _0x45ceea of _0x2f9065){const _0x546e9f=_0xd631cc[_0x118df4(0x15b)](_0x15be6c=>_0x15be6c[_0x118df4(0x113)]===_0x45ceea)[_0x118df4(0x111)](_0x57edaa=>_0x57edaa['name']),_0x1de103={'members':_0x546e9f,'name':_0x45ceea};_0x2debdd[_0x118df4(0x105)][_0x118df4(0x142)][_0x118df4(0xff)](_0x1de103);}const _0x4dce7f=new xml2js_1[(_0x118df4(0x104))]({'xmldec':{'version':_0x118df4(0x15d),'encoding':_0x118df4(0x135)}}),_0x4aab8c=_0x4dce7f[_0x118df4(0x10d)](_0x2debdd);await fs_internal_1['FS'][_0x118df4(0x132)](path_1[_0x118df4(0x14a)][_0x118df4(0x154)](process['cwd'](),'.temp',_0x37a36b,DEPLOY_DIR_NAME,'src',_0x118df4(0x14c)),_0x4aab8c);}function getComponentsTypeAndName(_0x2f081b,_0x481072){return _0x2f081b['reduce']((_0x27a3c5,_0x4c120f)=>{const _0x3e4cd6=a104_0x141d,_0x32cc83=_0x481072[_0x3e4cd6(0x138)](_0x3bd949=>_0x3bd949['Id']===_0x4c120f[_0x3e4cd6(0x103)]);return _0x32cc83&&_0x27a3c5[_0x3e4cd6(0xff)]({'name':_0x32cc83[_0x3e4cd6(0x147)][_0x3e4cd6(0x112)],'type':salesforce_1[_0x3e4cd6(0x123)][_0x3e4cd6(0x11e)][_0x4c120f[_0x3e4cd6(0x134)]]||_0x4c120f[_0x3e4cd6(0x134)]}),_0x27a3c5;},[]);}async function saveDestructiveChanges(_0x3adc92,_0x36bda0,_0x4e428a,_0x72c53b){const _0x5c39eb=a104_0x187942,_0x5bc6b1=(await(0x0,fetch_attachments_1[_0x5c39eb(0x10c)])(_0x3adc92,_0x36bda0))[_0x5c39eb(0x102)]();await fs_internal_1['FS']['writeFile'](path_1[_0x5c39eb(0x14a)]['join'](process[_0x5c39eb(0x145)](),_0x5c39eb(0x120),_0x72c53b,DEPLOY_DIR_NAME,_0x5c39eb(0x148),_0x4e428a),_0x5bc6b1);}async function createDeployZip(_0x3f1f0f){const _0x3be913=a104_0x187942,_0x5ee294=new adm_zip_1['default']();return await _0x5ee294['addLocalFolder'](path_1[_0x3be913(0x14a)][_0x3be913(0x154)](process[_0x3be913(0x145)](),_0x3be913(0x120),_0x3f1f0f,DEPLOY_DIR_NAME)),_0x5ee294;}async function insertZip(_0x4797fd,_0x3a02cd,_0x1de678,_0x5a4540,_0x35ffa8,_0x652d1){const _0x185b8a=a104_0x187942,_0x55eacc={'ParentId':_0x3a02cd,'Name':_0x185b8a(0x12b)+_0x1de678,'Description':'BUILD'+_0x5a4540,'Body':_0x35ffa8},{data:_0x56cf7d}=await _0x4797fd[_0x185b8a(0x149)](_0x185b8a(0x13c)+_0x652d1+_0x185b8a(0x13e),_0x55eacc);return _0x56cf7d['id'];}