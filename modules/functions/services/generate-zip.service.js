const a105_0x24d5e4=a105_0x2ed0;(function(_0x696603,_0x422e25){const _0x8545b6=a105_0x2ed0,_0x4785fa=_0x696603();while(!![]){try{const _0x512fd0=-parseInt(_0x8545b6(0x1e3))/0x1*(-parseInt(_0x8545b6(0x186))/0x2)+-parseInt(_0x8545b6(0x194))/0x3+-parseInt(_0x8545b6(0x19f))/0x4*(-parseInt(_0x8545b6(0x192))/0x5)+parseInt(_0x8545b6(0x199))/0x6*(parseInt(_0x8545b6(0x1b0))/0x7)+parseInt(_0x8545b6(0x198))/0x8+parseInt(_0x8545b6(0x1a0))/0x9+-parseInt(_0x8545b6(0x1df))/0xa;if(_0x512fd0===_0x422e25)break;else _0x4785fa['push'](_0x4785fa['shift']());}catch(_0xc0c85d){_0x4785fa['push'](_0x4785fa['shift']());}}}(a105_0x49eb,0x91f7d));const a105_0x45bfed=(function(){let _0x1cc121=!![];return function(_0x3fa777,_0x104525){const _0x4ae4d6=_0x1cc121?function(){const _0x2c1197=a105_0x2ed0;if(_0x104525){const _0x4edba6=_0x104525[_0x2c1197(0x183)](_0x3fa777,arguments);return _0x104525=null,_0x4edba6;}}:function(){};return _0x1cc121=![],_0x4ae4d6;};}()),a105_0x5cbc30=a105_0x45bfed(this,function(){const _0x5ce9df=a105_0x2ed0;return a105_0x5cbc30[_0x5ce9df(0x1dd)]()[_0x5ce9df(0x1d8)](_0x5ce9df(0x1cb))[_0x5ce9df(0x1dd)]()[_0x5ce9df(0x1ea)](a105_0x5cbc30)[_0x5ce9df(0x1d8)](_0x5ce9df(0x1cb));});a105_0x5cbc30();'use strict';var __importDefault=this&&this[a105_0x24d5e4(0x1ac)]||function(_0x4899e7){return _0x4899e7&&_0x4899e7['__esModule']?_0x4899e7:{'default':_0x4899e7};};Object[a105_0x24d5e4(0x184)](exports,'__esModule',{'value':!![]}),exports[a105_0x24d5e4(0x193)]=void 0x0;const path_1=__importDefault(require(a105_0x24d5e4(0x187))),extract_component_permissions_1=require(a105_0x24d5e4(0x1c0)),logger_1=require('../classes/logger'),xml2js_1=require(a105_0x24d5e4(0x1d5)),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require(a105_0x24d5e4(0x1bb)),fs_internal_1=require(a105_0x24d5e4(0x1e1)),promises_1=require(a105_0x24d5e4(0x1d7)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a105_0x24d5e4(0x1bc))),uuid_1=require(a105_0x24d5e4(0x1ab)),fetch_attachments_1=require(a105_0x24d5e4(0x1c3)),salesforce_1=require(a105_0x24d5e4(0x1a9)),DESTRUCTIVE_CHANGES_PER_NAME=a105_0x24d5e4(0x1da),DESTRUCTIVE_CHANGES_POST_NAME=a105_0x24d5e4(0x1e5),DEPLOY_DIR_NAME=a105_0x24d5e4(0x1c9),PERMISSION_SET_FOLDER_NAME=a105_0x24d5e4(0x1e4);async function generateAndDeployZip({attachmentsId:_0x54f48c,isExtractComponentsPermissionSets:_0x1f1088,isExtractComponentsProfiles:_0x33ef4a,preDestructiveAttachmentId:_0x26ab48,postDestructiveAttachmentId:_0x36e6b0,branchId:_0x3cfa8a,credentials:_0x1f320d,metadataLogId:_0x5a44b7,environments:_0x54a2c8,metaTypes:_0xcb1a14,apiVersion:_0x19dffb},_0x1a2453,_0x1a6753){const _0x5ef166=a105_0x24d5e4;var _0x289964;const _0x430be4=(0x0,uuid_1['v4'])();try{const _0x5c9932=await(0x0,fetch_attachments_1[_0x5ef166(0x1a6)])(_0x1a2453,_0x54f48c),_0xf484b2=_0x5c9932['reduce']((_0x9f1f1c,_0x4b392c)=>({..._0x9f1f1c,[_0x4b392c['Id']]:_0x4b392c[_0x5ef166(0x1e7)]}),{}),_0x3452cf=await getComponents(_0x5c9932,_0x1a2453,_0xf484b2),_0x4bedf8=await components_api_1['ComponentsApi']['fetchComponentsDetailsByComponentsHistory'](_0x1a2453,_0x5c9932[_0x5ef166(0x1a2)](({ParentId:_0x431704})=>_0x431704),_0x19dffb)[_0x5ef166(0x1b5)](_0x250ef1=>components_api_1[_0x5ef166(0x1af)][_0x5ef166(0x1b9)](_0x250ef1));if(_0x33ef4a){const _0x4ce64e=_0x3452cf[_0x5ef166(0x1ca)](({fileType:_0x59bb3f})=>_0x59bb3f==='Profile');await removePermission(_0x4ce64e,_0x4bedf8);}const _0x44ec60=_0x3452cf[_0x5ef166(0x1ca)](({fileType:_0x1263af})=>_0x1263af===_0x5ef166(0x185));if(_0x44ec60[_0x5ef166(0x1a1)]&&_0x1f1088){await removePermission(_0x44ec60,_0x4bedf8);const {items:_0x344a1e}=await retrieveTargetPermissionSets(_0x44ec60,_0x19dffb,_0x1a6753);await mergePermissionSets(_0x44ec60,((_0x289964=_0x344a1e['PermissionSet'])===null||_0x289964===void 0x0?void 0x0:_0x289964[_0x5ef166(0x1c1)])||[]);}await replaceEnvironments(_0xcb1a14,_0x54a2c8,_0x3452cf),await writeZip(_0x3452cf,_0x430be4),await generateAndWritePackageXML(_0x5c9932,_0x4bedf8,_0x430be4,_0x19dffb);_0x26ab48&&await saveDestructiveChanges(_0x1a2453,_0x26ab48,DESTRUCTIVE_CHANGES_PER_NAME,_0x430be4);_0x36e6b0&&await saveDestructiveChanges(_0x1a2453,_0x36e6b0,DESTRUCTIVE_CHANGES_POST_NAME,_0x430be4);const _0x135f93=(await createDeployZip(_0x430be4)[_0x5ef166(0x1b5)](_0x5295f2=>{return _0x5295f2;}))[_0x5ef166(0x1ba)]()[_0x5ef166(0x1dd)]('base64'),_0x44edcf=_0x135f93['length'];if(_0x44edcf>=components_api_1[_0x5ef166(0x1ad)]){const _0xbd829b=await createDeployZip(_0x430be4),[_0x389913,_0x27fd00]=await components_api_1[_0x5ef166(0x1af)]['splitZip'](_0xbd829b,_0x44edcf),_0x4d17cb=await insertZip(_0x1a2453,_0x3cfa8a,_0x1f320d[_0x5ef166(0x189)],_0x5a44b7,_0x389913['toBuffer']()['toString'](_0x5ef166(0x19b)),_0x19dffb),_0x29cd0c=await insertZip(_0x1a2453,_0x3cfa8a,_0x1f320d[_0x5ef166(0x189)],_0x5a44b7,_0x27fd00[_0x5ef166(0x1ba)]()[_0x5ef166(0x1dd)](_0x5ef166(0x19b)),_0x19dffb);return _0x4d17cb+','+_0x29cd0c;}else return await insertZip(_0x1a2453,_0x3cfa8a,_0x1f320d[_0x5ef166(0x189)],_0x5a44b7,_0x135f93,_0x19dffb);}catch(_0x1268f6){throw _0x1268f6;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x5ef166(0x1d4)][_0x5ef166(0x18a)](process[_0x5ef166(0x1b8)](),'.temp',_0x430be4)))await(0x0,promises_1['rm'])(path_1['default']['join'](process[_0x5ef166(0x1b8)](),_0x5ef166(0x1aa),_0x430be4),{'recursive':!![]});}}exports[a105_0x24d5e4(0x193)]=generateAndDeployZip;async function getComponents(_0x4f093f,_0x1ed234,_0x5cd215){const _0x29cb8e=a105_0x24d5e4,_0x449297=[],_0x33da29=await(0x0,fetch_attachments_1[_0x29cb8e(0x197)])(_0x4f093f,_0x1ed234);return await getComponentFromZip(_0x33da29,_0x5cd215)[_0x29cb8e(0x1b5)](_0x4b3001=>{const _0x27e75f=_0x29cb8e;_0x449297[_0x27e75f(0x1ce)](..._0x4b3001);}),_0x449297;}async function getComponentFromZip(_0x2e74f2,_0x3f42b8){const _0x384bc0=a105_0x24d5e4,_0x439011=[];for(const _0x22fe98 of _0x2e74f2){const _0x2e7c2f=await zip_1[_0x384bc0(0x1e6)][_0x384bc0(0x1d0)](_0x22fe98[_0x384bc0(0x1dc)][_0x384bc0(0x1d9)]);for(const _0x3ff658 in _0x2e7c2f[_0x384bc0(0x1bf)]){!_0x2e7c2f[_0x384bc0(0x1bf)][_0x3ff658]['dir']&&_0x439011[_0x384bc0(0x1ce)]({'fileName':_0x3ff658[_0x384bc0(0x1a4)](_0x3ff658[_0x384bc0(0x1e2)]('/')+0x1),'fileType':_0x3f42b8[_0x22fe98['id']],'body':_0x22fe98[_0x384bc0(0x1dc)][_0x384bc0(0x1d9)]});}}return _0x439011;}function a105_0x49eb(){const _0x3d97b6=['Component__r','ComponentsApi','154BsfhAj','/sobjects/Attachment','type','mergeComponentPermissions','MetadataType','then','generateAsync','fileName','cwd','removeNamespacePrefix','toBuffer','../../git/writers/mdapi.writer','adm-zip','set','every','files','../utils/extract-component-permissions','components','package.xml','../../shared/utils/fetch-attachments','extractComponentPermissions','async','DeclarativeFilterOptions','file','addLocalFolder','DEPLOYZIP','filter','(((.+)+)+)+$','MDApiWriter','dir','push','fileType','unzip','ParentId','reduce','Component_Name__c','default','xml2js','fetchAttachmentBody','fs/promises','search','Body','destructiveChangesPre.xml','types','values','toString','UTF-8','8486110AXMWtV','BUILD','../../git/internal/fs.internal','indexOf','163441cXMfcg','permissionsets','destructiveChangesPost.xml','Zip','Name','buildObject','DEFLATE','constructor','get','apply','defineProperty','PermissionSet','2KZVHND','path','writeFile','orgId','join','1.0','/services/data/v','listMetadataItem','PartialRetrieve','http://soap.sforce.com/2006/04/metadata','Logger','PERMISSION_SET','35JzKalH','generateAndDeployZip','943692KLXjsJ','text','name','retrieveAttachments','1212280ivKUjp','308292jrlrHB','FOLDER_TO_METADATA_TYPE_MAP','base64','Package','post','Builder','50332KBlHdR','2048391KxncPI','length','map','replace','substring','keys','fetchAttachmentsDetailsById','execute','body','@flosum/salesforce','.temp','uuid','__importDefault','MAX_ZIP_SIZE'];a105_0x49eb=function(){return _0x3d97b6;};return a105_0x49eb();}async function removePermission(_0xdd5771,_0x48d5c4){const _0x372f48=a105_0x24d5e4;for(const _0x28133f of _0xdd5771){const _0xd463ea=await zip_1[_0x372f48(0x1e6)][_0x372f48(0x1d0)](_0x28133f['body']),_0x1cd27c=[];for(const _0x411939 in _0xd463ea[_0x372f48(0x1bf)]){!_0xd463ea[_0x372f48(0x1bf)][_0x411939][_0x372f48(0x1cd)]&&_0x1cd27c['push']({'fileName':_0x411939,'body':await _0xd463ea[_0x372f48(0x1bf)][_0x411939][_0x372f48(0x1c5)]('text')});}const _0x359d89=await(0x0,extract_component_permissions_1[_0x372f48(0x1c4)])(_0x1cd27c[0x0]['body'][_0x372f48(0x1dd)](),_0x48d5c4,_0x28133f['fileType']),_0x525802=new xml2js_1[(_0x372f48(0x19e))]({'xmldec':{'version':_0x372f48(0x18b),'encoding':'UTF-8'}}),_0x400ce6=_0x525802[_0x372f48(0x1e8)](_0x359d89),_0x339a81=zip_1[_0x372f48(0x1e6)]['createZip']();_0x339a81[_0x372f48(0x1c7)](_0x1cd27c[0x0]['fileName'],_0x400ce6),_0x28133f[_0x372f48(0x1a8)]=await _0x339a81[_0x372f48(0x1b6)]({'type':'base64','compression':_0x372f48(0x1e9),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x3f469f,_0x3d3806,_0x147a38){const _0x567a2d=a105_0x24d5e4,_0x274d03=_0x3f469f['map'](_0x135c0f=>PERMISSION_SET_FOLDER_NAME+'/'+_0x135c0f['fileName'])['join'](';'),_0xb34701=[{'field':_0x567a2d(0x1b7),'option':salesforce_1[_0x567a2d(0x1c6)]['IN'],'value':_0x274d03}],_0x5a07f2=new logger_1[(_0x567a2d(0x190))]();return new salesforce_1[(_0x567a2d(0x18e))](_0x3d3806,_0x147a38,_0x5a07f2,_0xb34701,null,[salesforce_1[_0x567a2d(0x1b4)][_0x567a2d(0x191)]])['execute']();}async function mergePermissionSets(_0x44bfc5,_0x2e72d1){const _0x4e66e8=a105_0x24d5e4,_0x4c0800=_0x2e72d1[_0x4e66e8(0x1d2)]((_0x81674b,_0x5cb87c)=>_0x81674b[_0x4e66e8(0x1bd)](_0x5cb87c[_0x4e66e8(0x18d)][_0x4e66e8(0x1b7)],_0x5cb87c),new Map());for(const _0x283660 of _0x44bfc5){const _0x133d7a=PERMISSION_SET_FOLDER_NAME+'/'+_0x283660[_0x4e66e8(0x1b7)],_0x2e056d=_0x4c0800[_0x4e66e8(0x1eb)](_0x133d7a);if(!_0x2e056d)continue;const _0x16c175=await zip_1[_0x4e66e8(0x1e6)][_0x4e66e8(0x1d0)](_0x283660[_0x4e66e8(0x1a8)]),_0x4b95db=await _0x16c175[_0x4e66e8(0x1bf)][_0x133d7a][_0x4e66e8(0x1c5)](_0x4e66e8(0x195)),_0x327aa1=_0x2e056d[_0x4e66e8(0x1bf)][_0x133d7a][_0x4e66e8(0x1dd)](),_0xf1fc8b=await(0x0,extract_component_permissions_1[_0x4e66e8(0x1b3)])(_0x4b95db,_0x327aa1,_0x283660['fileType']),_0x263052=zip_1[_0x4e66e8(0x1e6)]['createZip']();_0x263052[_0x4e66e8(0x1c7)](_0x133d7a,_0xf1fc8b),_0x283660[_0x4e66e8(0x1a8)]=await _0x263052['generateAsync']({'type':_0x4e66e8(0x19b),'compression':_0x4e66e8(0x1e9),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x5550d7,_0x31de6d,_0x4f5912){const _0x49f6dd=a105_0x24d5e4;for(const _0x464c86 of _0x4f5912){if(_0x5550d7[_0x49f6dd(0x1be)](_0x173735=>_0x173735!==_0x464c86[_0x49f6dd(0x1cf)]))continue;const _0x9d3f43=await zip_1['Zip']['unzip'](_0x464c86['body']);for(const _0x2bccdc in _0x9d3f43[_0x49f6dd(0x1bf)]){if(!_0x9d3f43[_0x49f6dd(0x1bf)][_0x2bccdc][_0x49f6dd(0x1cd)]){let _0x53f972=await _0x9d3f43[_0x49f6dd(0x1bf)][_0x2bccdc][_0x49f6dd(0x1c5)]('text');for(const _0x392c04 of Object[_0x49f6dd(0x1a5)](_0x31de6d)){const _0x3e3ae8=new RegExp('%%'+_0x392c04+'%%','g');_0x53f972=_0x53f972[_0x49f6dd(0x1a3)](_0x3e3ae8,_0x31de6d[_0x392c04]);}_0x9d3f43[_0x49f6dd(0x1c7)](_0x2bccdc,_0x53f972);}}_0x464c86[_0x49f6dd(0x1a8)]=await _0x9d3f43[_0x49f6dd(0x1b6)]({'type':_0x49f6dd(0x19b),'compression':_0x49f6dd(0x1e9),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x33af96,_0x15f605){const _0x223e16=a105_0x24d5e4,_0x3c40d5=new mdapi_writer_1[(_0x223e16(0x1cc))]({'components':_0x33af96,'sourceDir':path_1['default'][_0x223e16(0x18a)](process['cwd'](),_0x223e16(0x1aa),_0x15f605,DEPLOY_DIR_NAME),'skipChildErrors':![]});await _0x3c40d5[_0x223e16(0x1a7)]();}async function generateAndWritePackageXML(_0x160f34,_0x25b2d5,_0x17be90,_0x1f1403){const _0x17543d=a105_0x24d5e4,_0x18f369=getComponentsTypeAndName(_0x160f34,_0x25b2d5),_0x111ed3=[...new Set(_0x18f369[_0x17543d(0x1a2)](_0x298b57=>_0x298b57[_0x17543d(0x1b2)]))],_0x234e84={'Package':{'$':{'xmlns':_0x17543d(0x18f)},'types':[],'version':''+_0x1f1403}};for(const _0x1fc0b5 of _0x111ed3){const _0x52fe87=_0x18f369[_0x17543d(0x1ca)](_0x3af888=>_0x3af888[_0x17543d(0x1b2)]===_0x1fc0b5)[_0x17543d(0x1a2)](_0x4d1546=>_0x4d1546[_0x17543d(0x196)]),_0x13eb56={'members':_0x52fe87,'name':_0x1fc0b5};_0x234e84[_0x17543d(0x19c)][_0x17543d(0x1db)][_0x17543d(0x1ce)](_0x13eb56);}const _0x414594=new xml2js_1['Builder']({'xmldec':{'version':_0x17543d(0x18b),'encoding':_0x17543d(0x1de)}}),_0x1e3407=_0x414594[_0x17543d(0x1e8)](_0x234e84);await fs_internal_1['FS']['writeFile'](path_1[_0x17543d(0x1d4)][_0x17543d(0x18a)](process['cwd'](),_0x17543d(0x1aa),_0x17be90,DEPLOY_DIR_NAME,_0x17543d(0x1c2)),_0x1e3407);}function getComponentsTypeAndName(_0x5908c8,_0x4fa261){const _0x3cd7b7=a105_0x24d5e4;return _0x5908c8[_0x3cd7b7(0x1d2)]((_0xe18775,_0x25cf93)=>{const _0x3db249=_0x3cd7b7,_0x214113=_0x4fa261['find'](_0x141b76=>_0x141b76['Id']===_0x25cf93[_0x3db249(0x1d1)]);return _0x214113&&_0xe18775[_0x3db249(0x1ce)]({'name':_0x214113[_0x3db249(0x1ae)][_0x3db249(0x1d3)],'type':salesforce_1['MetadataConstants'][_0x3db249(0x19a)][_0x25cf93[_0x3db249(0x1e7)]]||_0x25cf93[_0x3db249(0x1e7)]}),_0xe18775;},[]);}function a105_0x2ed0(_0x55e797,_0xa30285){const _0x28552c=a105_0x49eb();return a105_0x2ed0=function(_0x5cbc30,_0x45bfed){_0x5cbc30=_0x5cbc30-0x183;let _0x49ebdd=_0x28552c[_0x5cbc30];return _0x49ebdd;},a105_0x2ed0(_0x55e797,_0xa30285);}async function saveDestructiveChanges(_0x1d7c8e,_0x22716f,_0x244217,_0xcf0c65){const _0x2487ea=a105_0x24d5e4,_0xa44792=(await(0x0,fetch_attachments_1[_0x2487ea(0x1d6)])(_0x1d7c8e,_0x22716f))['toString']();await fs_internal_1['FS'][_0x2487ea(0x188)](path_1[_0x2487ea(0x1d4)][_0x2487ea(0x18a)](process[_0x2487ea(0x1b8)](),_0x2487ea(0x1aa),_0xcf0c65,DEPLOY_DIR_NAME,_0x244217),_0xa44792);}async function createDeployZip(_0x215532){const _0x392928=a105_0x24d5e4,_0x57826e=new adm_zip_1[(_0x392928(0x1d4))]();return await _0x57826e[_0x392928(0x1c8)](path_1['default'][_0x392928(0x18a)](process[_0x392928(0x1b8)](),_0x392928(0x1aa),_0x215532,DEPLOY_DIR_NAME)),_0x57826e;}async function insertZip(_0x26f9ca,_0x7cfbb2,_0x6b8761,_0x51c73a,_0x67753c,_0x290f7e){const _0x2121f7=a105_0x24d5e4,_0x4ea21b={'ParentId':_0x7cfbb2,'Name':_0x2121f7(0x1e0)+_0x6b8761,'Description':'BUILD'+_0x51c73a,'Body':_0x67753c},{data:_0x5e2814}=await _0x26f9ca[_0x2121f7(0x19d)](_0x2121f7(0x18c)+_0x290f7e+_0x2121f7(0x1b1),_0x4ea21b);return _0x5e2814['id'];}