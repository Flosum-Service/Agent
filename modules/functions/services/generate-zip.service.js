function a54_0xcd35(_0x5e913b,_0x2cb020){const _0x21834d=a54_0x202d();return a54_0xcd35=function(_0x101e5b,_0x572713){_0x101e5b=_0x101e5b-0xa3;let _0x202dfd=_0x21834d[_0x101e5b];return _0x202dfd;},a54_0xcd35(_0x5e913b,_0x2cb020);}const a54_0x38c992=a54_0xcd35;(function(_0x5761de,_0x319705){const _0x50ca90=a54_0xcd35,_0x44c292=_0x5761de();while(!![]){try{const _0x4eca30=parseInt(_0x50ca90(0xd9))/0x1*(-parseInt(_0x50ca90(0xc2))/0x2)+-parseInt(_0x50ca90(0xa6))/0x3*(-parseInt(_0x50ca90(0xe0))/0x4)+parseInt(_0x50ca90(0xc0))/0x5*(-parseInt(_0x50ca90(0xdd))/0x6)+parseInt(_0x50ca90(0xc5))/0x7+parseInt(_0x50ca90(0xe8))/0x8*(-parseInt(_0x50ca90(0xf7))/0x9)+-parseInt(_0x50ca90(0xcd))/0xa+-parseInt(_0x50ca90(0xcb))/0xb*(-parseInt(_0x50ca90(0xd3))/0xc);if(_0x4eca30===_0x319705)break;else _0x44c292['push'](_0x44c292['shift']());}catch(_0x594b58){_0x44c292['push'](_0x44c292['shift']());}}}(a54_0x202d,0x6336b));const a54_0x572713=(function(){let _0x4adf6=!![];return function(_0x32f887,_0x264746){const _0x495afa=_0x4adf6?function(){const _0x67482c=a54_0xcd35;if(_0x264746){const _0x5f0747=_0x264746[_0x67482c(0xb2)](_0x32f887,arguments);return _0x264746=null,_0x5f0747;}}:function(){};return _0x4adf6=![],_0x495afa;};}()),a54_0x101e5b=a54_0x572713(this,function(){const _0x436ea2=a54_0xcd35;return a54_0x101e5b[_0x436ea2(0xc4)]()['search'](_0x436ea2(0xd4))[_0x436ea2(0xc4)]()[_0x436ea2(0xa9)](a54_0x101e5b)['search']('(((.+)+)+)+$');});a54_0x101e5b();'use strict';var __importDefault=this&&this[a54_0x38c992(0xf2)]||function(_0x1d020b){const _0x55e9ea=a54_0x38c992;return _0x1d020b&&_0x1d020b[_0x55e9ea(0xc6)]?_0x1d020b:{'default':_0x1d020b};};Object[a54_0x38c992(0xcf)](exports,a54_0x38c992(0xc6),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require(a54_0x38c992(0xa8)),path_1=__importDefault(require(a54_0x38c992(0xcc))),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require('xml2js'),zip_1=require(a54_0x38c992(0xd0)),mdapi_1=require(a54_0x38c992(0xdf)),fs_internal_1=require(a54_0x38c992(0xfb)),promises_1=require(a54_0x38c992(0xc9)),components_api_1=require(a54_0x38c992(0xbb)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require('uuid'),DESTRUCTIVE_CHANGES_PER_NAME=a54_0x38c992(0xb8),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a54_0x38c992(0xd2);async function generateAndDeployZip({attachmentsId:_0x56dd49,isExtractComponentsPermissions:_0x515829,preDestructiveAttachmentId:_0x529f5b,postDestructiveAttachmentId:_0x3d5d0e,branchId:_0x5a12df,credentials:_0x40aeb4,metadataLogId:_0x4544e7,environments:_0x3c9fa0,metaTypes:_0x408911},_0x4eab37){const _0x5e03e4=a54_0x38c992,_0xe0b45c=(0x0,uuid_1['v4'])();try{const _0xa99267=await components_api_1['ComponentsApi']['fetchAttachmentsDetails'](_0x4eab37,_0x56dd49),_0x210927=_0xa99267[_0x5e03e4(0xd1)]((_0x1c6372,_0x2ad86e)=>({..._0x1c6372,[_0x2ad86e['Id']]:_0x2ad86e[_0x5e03e4(0xb9)]}),{}),_0x1fe89d=await getComponents(_0xa99267,_0x4eab37,_0x210927),_0x375d92=await components_api_1[_0x5e03e4(0xf6)]['fetchComponentsDetailsByComponentsHistory'](_0x4eab37,_0xa99267[_0x5e03e4(0xf0)](({ParentId:_0x5acd10})=>_0x5acd10))[_0x5e03e4(0xfc)](_0x4f23db=>components_api_1[_0x5e03e4(0xf6)][_0x5e03e4(0xb7)](_0x4f23db));if(_0x515829){const _0x584316=_0x1fe89d['filter'](({fileType:_0x5712dc})=>_0x5712dc===_0x5e03e4(0xbe)||_0x5712dc==='PermissionSet');await removePermission(_0x584316,_0x375d92);}await replaceEnvironments(_0x408911,_0x3c9fa0,_0x1fe89d),await writeZip(_0x1fe89d,_0xe0b45c),await generateAndWritePackageXML(_0xa99267,_0x375d92,_0xe0b45c);_0x529f5b&&await saveDestructiveChanges(_0x4eab37,_0x529f5b,DESTRUCTIVE_CHANGES_PER_NAME,_0xe0b45c);_0x3d5d0e&&await saveDestructiveChanges(_0x4eab37,_0x3d5d0e,DESTRUCTIVE_CHANGES_POST_NAME,_0xe0b45c);const _0xc1941b=(await createDeployZip(_0xe0b45c)[_0x5e03e4(0xfc)](_0x268426=>{return _0x268426;}))[_0x5e03e4(0xce)]()[_0x5e03e4(0xc4)](_0x5e03e4(0xac));console[_0x5e03e4(0xe2)]('after\x20create\x20zip');const _0x26aff0=_0xc1941b[_0x5e03e4(0xd7)];if(_0x26aff0>=components_api_1[_0x5e03e4(0xea)]){const _0x4d2de1=await createDeployZip(_0xe0b45c);console[_0x5e03e4(0xe2)](_0x5e03e4(0xe7));const [_0x376d03,_0x5c3a61]=await components_api_1[_0x5e03e4(0xf6)][_0x5e03e4(0xf5)](_0x4d2de1,_0x26aff0),_0xa0ff80=await insertZip(_0x4eab37,_0x5a12df,_0x40aeb4[_0x5e03e4(0xd6)],_0x4544e7,_0x376d03[_0x5e03e4(0xce)]()['toString'](_0x5e03e4(0xac))),_0x5d3934=await insertZip(_0x4eab37,_0x5a12df,_0x40aeb4[_0x5e03e4(0xd6)],_0x4544e7,_0x5c3a61['toBuffer']()[_0x5e03e4(0xc4)](_0x5e03e4(0xac)));return _0xa0ff80+','+_0x5d3934;}else return await insertZip(_0x4eab37,_0x5a12df,_0x40aeb4[_0x5e03e4(0xd6)],_0x4544e7,_0xc1941b);}catch(_0x46647f){throw _0x46647f;}finally{if(await fs_internal_1['FS']['exists'](path_1['default'][_0x5e03e4(0xf1)](process[_0x5e03e4(0xef)](),_0x5e03e4(0xe9),_0xe0b45c)))await(0x0,promises_1['rm'])(path_1[_0x5e03e4(0xb4)]['join'](process['cwd'](),'.temp',_0xe0b45c),{'recursive':!![]});}}exports[a54_0x38c992(0xf3)]=generateAndDeployZip;async function getComponents(_0x3aebc9,_0x252084,_0x19cb62){const _0x46739d=a54_0x38c992,_0xcc5c23=[],_0x539a65=await components_api_1[_0x46739d(0xf6)][_0x46739d(0xde)](_0x3aebc9,_0x252084);return await getComponentFromZip(_0x539a65,_0x19cb62)[_0x46739d(0xfc)](_0x21aedd=>{_0xcc5c23['push'](..._0x21aedd);}),_0xcc5c23;}async function getComponentFromZip(_0x14a514,_0x1eb48a){const _0x56e5e0=a54_0x38c992,_0xaaf509=[];for(const _0x2cca19 of _0x14a514){const _0x230b58=await zip_1[_0x56e5e0(0xc7)][_0x56e5e0(0xae)](_0x2cca19['values'][_0x56e5e0(0xe3)]);for(const _0x48f85c in _0x230b58[_0x56e5e0(0xe6)]){!_0x230b58[_0x56e5e0(0xe6)][_0x48f85c][_0x56e5e0(0xed)]&&_0xaaf509[_0x56e5e0(0xb6)]({'fileName':_0x48f85c['substring'](_0x48f85c[_0x56e5e0(0xba)]('/')+0x1),'fileType':_0x1eb48a[_0x2cca19['id']],'body':_0x2cca19[_0x56e5e0(0xe5)][_0x56e5e0(0xe3)]});}}return _0xaaf509;}async function removePermission(_0x4eed1c,_0x107b8e){const _0x1ee382=a54_0x38c992;for(const _0x22d781 of _0x4eed1c){const _0x1ed901=await zip_1['Zip'][_0x1ee382(0xae)](_0x22d781[_0x1ee382(0xc3)]),_0x3761bd=[];for(const _0x21aa78 in _0x1ed901[_0x1ee382(0xe6)]){!_0x1ed901[_0x1ee382(0xe6)][_0x21aa78][_0x1ee382(0xed)]&&_0x3761bd['push']({'fileName':_0x21aa78,'body':await _0x1ed901['files'][_0x21aa78][_0x1ee382(0xec)]('text')});}const _0x4d6895=await(0x0,extract_component_permissions_1[_0x1ee382(0xdc)])(_0x3761bd[0x0][_0x1ee382(0xc3)][_0x1ee382(0xc4)](),_0x107b8e,_0x22d781[_0x1ee382(0xc8)]),_0xbfb5c3=new xml2js_1[(_0x1ee382(0xb0))]({'xmldec':{'version':_0x1ee382(0xbd),'encoding':_0x1ee382(0xee)}}),_0x3229d8=_0xbfb5c3['buildObject'](_0x4d6895),_0x14f0a1=zip_1[_0x1ee382(0xc7)][_0x1ee382(0xda)]();_0x14f0a1[_0x1ee382(0xbc)](_0x3761bd[0x0][_0x1ee382(0xd8)],_0x3229d8),_0x22d781['body']=await _0x14f0a1[_0x1ee382(0xb1)]({'type':_0x1ee382(0xac),'compression':_0x1ee382(0xa3),'compressionOptions':{'level':0x6}});}}function a54_0x202d(){const _0x3a1f57=['9BXEVGh','name','http://soap.sforce.com/2006/04/metadata','fetchAttachmentBody','../../git/internal/fs.internal','then','DEFLATE','find','/sobjects/Attachment','18138SyotCo','src','../../../constants','constructor','writeFile','SALESFORCE_API_VERSION','base64','Component__r','unzip','ParentId','Builder','generateAsync','apply','Component_Name__c','default','BUILD','push','removeNamespacePrefix','destructiveChangesPre.xml','Name','indexOf','../utils/components-api','file','1.0','Profile','text','993640nfDDcy','type','514644DkKBwh','body','toString','1608999IqNIfz','__esModule','Zip','fileType','fs/promises','replace','10770221NvlnxL','path','3986590OJSeqX','toBuffer','defineProperty','../../git/parsers/utils/zip','reduce','DEPLOYZIP','12rkyeUm','(((.+)+)+)+$','types','orgId','length','fileName','1TDyIwY','createZip','keys','extractComponentPermissions','18GLylap','retrieveAttachments','../../git/parsers/mdapi','332NFmEKy','MDApiWriter','log','Body','filter','values','files','after\x20create\x20second\x20zip','417936cVWbyg','.temp','MAX_ZIP_SIZE','Package','async','dir','UTF-8','cwd','map','join','__importDefault','generateAndDeployZip','addLocalFolder','splitZip','ComponentsApi'];a54_0x202d=function(){return _0x3a1f57;};return a54_0x202d();}async function replaceEnvironments(_0x1e8441,_0x1284d8,_0x339f9d){const _0x586fbb=a54_0x38c992;for(const _0x2687ce of _0x339f9d){if(_0x1e8441['every'](_0x19244a=>_0x19244a!==_0x2687ce[_0x586fbb(0xc8)]))continue;const _0x471893=await zip_1[_0x586fbb(0xc7)][_0x586fbb(0xae)](_0x2687ce[_0x586fbb(0xc3)]);for(const _0x2fe34c in _0x471893[_0x586fbb(0xe6)]){if(!_0x471893[_0x586fbb(0xe6)][_0x2fe34c][_0x586fbb(0xed)]){let _0x4d1312=await _0x471893[_0x586fbb(0xe6)][_0x2fe34c]['async'](_0x586fbb(0xbf));for(const _0x4425d7 of Object[_0x586fbb(0xdb)](_0x1284d8)){const _0x24affd=new RegExp('%%'+_0x4425d7+'%%','g');_0x4d1312=_0x4d1312[_0x586fbb(0xca)](_0x24affd,_0x1284d8[_0x4425d7]);}_0x471893[_0x586fbb(0xbc)](_0x2fe34c,_0x4d1312);}}_0x2687ce[_0x586fbb(0xc3)]=await _0x471893['generateAsync']({'type':'base64','compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x16c76f,_0x3faf89){const _0x2fe36e=a54_0x38c992,_0x4c9ef4=new mdapi_1[(_0x2fe36e(0xe1))]({'components':_0x16c76f,'sourceDir':path_1[_0x2fe36e(0xb4)][_0x2fe36e(0xf1)](process[_0x2fe36e(0xef)](),_0x2fe36e(0xe9),_0x3faf89,DEPLOY_DIR_NAME,_0x2fe36e(0xa7)),'skipChildErrors':![]});await _0x4c9ef4['start']();}async function generateAndWritePackageXML(_0x1f42cd,_0x29803e,_0x319800){const _0x77e65b=a54_0x38c992,_0x255330=getComponentsTypeAndName(_0x1f42cd,_0x29803e),_0x30ea1d=[...new Set(_0x255330[_0x77e65b(0xf0)](_0x11264c=>_0x11264c['type']))],_0x28ff37={'Package':{'$':{'xmlns':_0x77e65b(0xf9)},'types':[],'version':''+constants_1[_0x77e65b(0xab)]['substring'](0x1)}};for(const _0x109b83 of _0x30ea1d){const _0x1d39fb=_0x255330[_0x77e65b(0xe4)](_0x20310d=>_0x20310d[_0x77e65b(0xc1)]===_0x109b83)[_0x77e65b(0xf0)](_0x291768=>_0x291768[_0x77e65b(0xf8)]),_0xbd7b94={'members':_0x1d39fb,'name':_0x109b83};_0x28ff37[_0x77e65b(0xeb)][_0x77e65b(0xd5)][_0x77e65b(0xb6)](_0xbd7b94);}const _0x28cd91=new xml2js_1[(_0x77e65b(0xb0))]({'xmldec':{'version':'1.0','encoding':_0x77e65b(0xee)}}),_0x3b686f=_0x28cd91['buildObject'](_0x28ff37);await fs_internal_1['FS'][_0x77e65b(0xaa)](path_1[_0x77e65b(0xb4)][_0x77e65b(0xf1)](process[_0x77e65b(0xef)](),'.temp',_0x319800,DEPLOY_DIR_NAME,_0x77e65b(0xa7),'package.xml'),_0x3b686f);}function getComponentsTypeAndName(_0x1bc9c8,_0x8617a7){const _0x1bd15f=a54_0x38c992;return _0x1bc9c8[_0x1bd15f(0xd1)]((_0x48edb8,_0x5abbd0)=>{const _0x2acfd6=_0x1bd15f,_0x457f8a=_0x8617a7[_0x2acfd6(0xa4)](_0x443544=>_0x443544['Id']===_0x5abbd0[_0x2acfd6(0xaf)]);return _0x457f8a&&_0x48edb8[_0x2acfd6(0xb6)]({'name':_0x457f8a[_0x2acfd6(0xad)][_0x2acfd6(0xb3)],'type':_0x5abbd0[_0x2acfd6(0xb9)]}),_0x48edb8;},[]);}async function saveDestructiveChanges(_0x54751f,_0x301347,_0x5bd691,_0x20eff3){const _0x3a2703=a54_0x38c992,_0x3f54df=(await components_api_1[_0x3a2703(0xf6)][_0x3a2703(0xfa)](_0x54751f,_0x301347))['toString']();await fs_internal_1['FS'][_0x3a2703(0xaa)](path_1[_0x3a2703(0xb4)][_0x3a2703(0xf1)](process[_0x3a2703(0xef)](),_0x3a2703(0xe9),_0x20eff3,DEPLOY_DIR_NAME,_0x3a2703(0xa7),_0x5bd691),_0x3f54df);}async function createDeployZip(_0x2425f1){const _0x4bdf92=a54_0x38c992,_0x5029ed=new adm_zip_1[(_0x4bdf92(0xb4))]();return await _0x5029ed[_0x4bdf92(0xf4)](path_1['default'][_0x4bdf92(0xf1)](process[_0x4bdf92(0xef)](),_0x4bdf92(0xe9),_0x2425f1,DEPLOY_DIR_NAME)),_0x5029ed;}async function insertZip(_0x414730,_0x58fdc6,_0x31646e,_0x3e4333,_0x290526){const _0x2d1478=a54_0x38c992,_0x48cf9c={'ParentId':_0x58fdc6,'Name':'BUILD'+_0x31646e,'Description':_0x2d1478(0xb5)+_0x3e4333,'Body':_0x290526},{data:_0x3ce7ee}=await _0x414730['post']('/services/data/'+constants_1[_0x2d1478(0xab)]+_0x2d1478(0xa5),_0x48cf9c);return _0x3ce7ee['id'];}