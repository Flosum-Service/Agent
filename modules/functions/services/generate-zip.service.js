const a104_0x548169=a104_0x3777;(function(_0x129639,_0x1811ec){const _0x428dd3=a104_0x3777,_0x479aac=_0x129639();while(!![]){try{const _0x413e80=parseInt(_0x428dd3(0x1de))/0x1*(parseInt(_0x428dd3(0x1d5))/0x2)+-parseInt(_0x428dd3(0x1b5))/0x3+-parseInt(_0x428dd3(0x1f5))/0x4*(-parseInt(_0x428dd3(0x1dd))/0x5)+parseInt(_0x428dd3(0x1b0))/0x6+-parseInt(_0x428dd3(0x1eb))/0x7*(-parseInt(_0x428dd3(0x1bf))/0x8)+parseInt(_0x428dd3(0x1ba))/0x9*(parseInt(_0x428dd3(0x190))/0xa)+-parseInt(_0x428dd3(0x1e3))/0xb*(parseInt(_0x428dd3(0x1e0))/0xc);if(_0x413e80===_0x1811ec)break;else _0x479aac['push'](_0x479aac['shift']());}catch(_0x52ae5e){_0x479aac['push'](_0x479aac['shift']());}}}(a104_0x3613,0xddda0));const a104_0x109fee=(function(){let _0x2f2c2a=!![];return function(_0x781dec,_0x47e4bf){const _0x30b5a8=_0x2f2c2a?function(){const _0x1cfc9a=a104_0x3777;if(_0x47e4bf){const _0x55c2c9=_0x47e4bf[_0x1cfc9a(0x1e7)](_0x781dec,arguments);return _0x47e4bf=null,_0x55c2c9;}}:function(){};return _0x2f2c2a=![],_0x30b5a8;};}()),a104_0x43e895=a104_0x109fee(this,function(){const _0x29f9d9=a104_0x3777;return a104_0x43e895['toString']()[_0x29f9d9(0x1ce)]('(((.+)+)+)+$')[_0x29f9d9(0x1a4)]()[_0x29f9d9(0x1e1)](a104_0x43e895)[_0x29f9d9(0x1ce)](_0x29f9d9(0x199));});function a104_0x3613(){const _0x52f9b8=['replace','destructiveChangesPost.xml','7218QXMAYW','splitZip','Profile','/sobjects/Attachment','DeclarativeFilterOptions','3984808ETsRAT','unzip','toBuffer','xml2js','buildObject','defineProperty','push','MAX_ZIP_SIZE','then','join','../classes/logger','get','../../git/internal/fs.internal','exists','set','search','MDApiWriter','../utils/components-api','fetchComponentsDetailsByComponentsHistory','orgId','BUILD','__esModule','18442OgsyDi','ComponentsApi','map','Name','post','retrieveAttachments','package.xml','../../shared/utils/fetch-attachments','5VzZBnl','17ftFpHY','fileType','80556jHLHuQ','constructor','indexOf','1991QsbWZy','every','__importDefault','find','apply','text','default','values','14bfprOP','fileName','MetadataConstants','path','UTF-8','writeFile','ParentId','Builder','Body','addLocalFolder','607720nRqMSA','PartialRetrieve','1.0','PermissionSet','reduce','8000tflETq','mergeComponentPermissions','generateAsync','uuid','DEPLOYZIP','MetadataType','destructiveChangesPre.xml','dir','base64','(((.+)+)+)+$','extractComponentPermissions','DEFLATE','length','../../git/writers/mdapi.writer','cwd','fs/promises','name','Component__r','src','Logger','toString','createZip','generateAndDeployZip','async','execute','.temp','../utils/extract-component-permissions','Zip','Component_Name__c','components','body','adm-zip','6531228WpYkpk','types','/services/data/v','fetchAttachmentBody','../../git/parsers/utils/zip','2733810MGJtba','files','filter'];a104_0x3613=function(){return _0x52f9b8;};return a104_0x3613();}a104_0x43e895();'use strict';var __importDefault=this&&this[a104_0x548169(0x1e5)]||function(_0x672b2f){const _0x31f3a2=a104_0x548169;return _0x672b2f&&_0x672b2f[_0x31f3a2(0x1d4)]?_0x672b2f:{'default':_0x672b2f};};Object[a104_0x548169(0x1c4)](exports,'__esModule',{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const path_1=__importDefault(require(a104_0x548169(0x1ee))),extract_component_permissions_1=require(a104_0x548169(0x1aa)),logger_1=require(a104_0x548169(0x1c9)),xml2js_1=require(a104_0x548169(0x1c2)),zip_1=require(a104_0x548169(0x1b4)),mdapi_writer_1=require(a104_0x548169(0x19d)),fs_internal_1=require(a104_0x548169(0x1cb)),promises_1=require(a104_0x548169(0x19f)),components_api_1=require(a104_0x548169(0x1d0)),adm_zip_1=__importDefault(require(a104_0x548169(0x1af))),uuid_1=require(a104_0x548169(0x193)),fetch_attachments_1=require(a104_0x548169(0x1dc)),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x548169(0x196),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x548169(0x1b9),DEPLOY_DIR_NAME=a104_0x548169(0x194),PERMISSION_SET_FOLDER_NAME='permissionsets';async function generateAndDeployZip({attachmentsId:_0xe7837c,isExtractComponentsPermissionSets:_0x375599,isExtractComponentsProfiles:_0x48a50b,preDestructiveAttachmentId:_0x16ef57,postDestructiveAttachmentId:_0x30fbbb,branchId:_0x3a5cf8,credentials:_0x3df180,metadataLogId:_0x2d743a,environments:_0x4986e9,metaTypes:_0x3d9280,apiVersion:_0x338cbd},_0x234c80,_0x6ef5fb){const _0x4014ab=a104_0x548169;var _0x4e36de;const _0x5dce05=(0x0,uuid_1['v4'])();try{const _0x1b6fa7=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x234c80,_0xe7837c),_0x2f68e2=_0x1b6fa7['reduce']((_0x3fccd1,_0x30d2e9)=>({..._0x3fccd1,[_0x30d2e9['Id']]:_0x30d2e9['Name']}),{}),_0x1f9684=await getComponents(_0x1b6fa7,_0x234c80,_0x2f68e2),_0xe780a=await components_api_1[_0x4014ab(0x1d6)][_0x4014ab(0x1d1)](_0x234c80,_0x1b6fa7['map'](({ParentId:_0x2fc20b})=>_0x2fc20b),_0x338cbd)[_0x4014ab(0x1c7)](_0x2281ac=>components_api_1[_0x4014ab(0x1d6)]['removeNamespacePrefix'](_0x2281ac));if(_0x48a50b){const _0x1165dd=_0x1f9684[_0x4014ab(0x1b7)](({fileType:_0x1b74fc})=>_0x1b74fc===_0x4014ab(0x1bc));await removePermission(_0x1165dd,_0xe780a);}const _0x4841f2=_0x1f9684[_0x4014ab(0x1b7)](({fileType:_0x1cd814})=>_0x1cd814===_0x4014ab(0x1f8));if(_0x4841f2[_0x4014ab(0x19c)]&&_0x375599){await removePermission(_0x4841f2,_0xe780a);const {items:_0x504ebd}=await retrieveTargetPermissionSets(_0x4841f2,_0x338cbd,_0x6ef5fb);await mergePermissionSets(_0x4841f2,((_0x4e36de=_0x504ebd['PermissionSet'])===null||_0x4e36de===void 0x0?void 0x0:_0x4e36de[_0x4014ab(0x1ad)])||[]);}await replaceEnvironments(_0x3d9280,_0x4986e9,_0x1f9684),await writeZip(_0x1f9684,_0x5dce05),await generateAndWritePackageXML(_0x1b6fa7,_0xe780a,_0x5dce05,_0x338cbd);_0x16ef57&&await saveDestructiveChanges(_0x234c80,_0x16ef57,DESTRUCTIVE_CHANGES_PER_NAME,_0x5dce05);_0x30fbbb&&await saveDestructiveChanges(_0x234c80,_0x30fbbb,DESTRUCTIVE_CHANGES_POST_NAME,_0x5dce05);const _0x4783ea=(await createDeployZip(_0x5dce05)['then'](_0x2a12e6=>{return _0x2a12e6;}))[_0x4014ab(0x1c1)]()[_0x4014ab(0x1a4)]('base64'),_0x4b5ba9=_0x4783ea[_0x4014ab(0x19c)];if(_0x4b5ba9>=components_api_1[_0x4014ab(0x1c6)]){const _0x3d358c=await createDeployZip(_0x5dce05),[_0x3fa010,_0x321d6b]=await components_api_1[_0x4014ab(0x1d6)][_0x4014ab(0x1bb)](_0x3d358c,_0x4b5ba9),_0x13437a=await insertZip(_0x234c80,_0x3a5cf8,_0x3df180[_0x4014ab(0x1d2)],_0x2d743a,_0x3fa010[_0x4014ab(0x1c1)]()[_0x4014ab(0x1a4)]('base64'),_0x338cbd),_0x295530=await insertZip(_0x234c80,_0x3a5cf8,_0x3df180[_0x4014ab(0x1d2)],_0x2d743a,_0x321d6b[_0x4014ab(0x1c1)]()[_0x4014ab(0x1a4)](_0x4014ab(0x198)),_0x338cbd);return _0x13437a+','+_0x295530;}else return await insertZip(_0x234c80,_0x3a5cf8,_0x3df180['orgId'],_0x2d743a,_0x4783ea,_0x338cbd);}catch(_0x25402c){throw _0x25402c;}finally{if(await fs_internal_1['FS'][_0x4014ab(0x1cc)](path_1[_0x4014ab(0x1e9)][_0x4014ab(0x1c8)](process[_0x4014ab(0x19e)](),'.temp',_0x5dce05)))await(0x0,promises_1['rm'])(path_1[_0x4014ab(0x1e9)][_0x4014ab(0x1c8)](process[_0x4014ab(0x19e)](),_0x4014ab(0x1a9),_0x5dce05),{'recursive':!![]});}}exports[a104_0x548169(0x1a6)]=generateAndDeployZip;async function getComponents(_0x3a24aa,_0x82ebcd,_0x1266ce){const _0x43a0f2=a104_0x548169,_0x286bb6=[],_0x4d6675=await(0x0,fetch_attachments_1[_0x43a0f2(0x1da)])(_0x3a24aa,_0x82ebcd);return await getComponentFromZip(_0x4d6675,_0x1266ce)[_0x43a0f2(0x1c7)](_0x5a12bc=>{const _0x2cb468=_0x43a0f2;_0x286bb6[_0x2cb468(0x1c5)](..._0x5a12bc);}),_0x286bb6;}function a104_0x3777(_0x5a3f82,_0x30e7df){const _0x126607=a104_0x3613();return a104_0x3777=function(_0x43e895,_0x109fee){_0x43e895=_0x43e895-0x18f;let _0x361313=_0x126607[_0x43e895];return _0x361313;},a104_0x3777(_0x5a3f82,_0x30e7df);}async function getComponentFromZip(_0x1ca89b,_0x32afec){const _0x15f623=a104_0x548169,_0x473c3e=[];for(const _0x20b3da of _0x1ca89b){const _0x29a073=await zip_1[_0x15f623(0x1ab)][_0x15f623(0x1c0)](_0x20b3da[_0x15f623(0x1ea)][_0x15f623(0x1f3)]);for(const _0x3f0656 in _0x29a073[_0x15f623(0x1b6)]){!_0x29a073[_0x15f623(0x1b6)][_0x3f0656][_0x15f623(0x197)]&&_0x473c3e[_0x15f623(0x1c5)]({'fileName':_0x3f0656['substring'](_0x3f0656[_0x15f623(0x1e2)]('/')+0x1),'fileType':_0x32afec[_0x20b3da['id']],'body':_0x20b3da[_0x15f623(0x1ea)][_0x15f623(0x1f3)]});}}return _0x473c3e;}async function removePermission(_0x424b4a,_0x1f1fa0){const _0x12520b=a104_0x548169;for(const _0x30da66 of _0x424b4a){const _0x16047d=await zip_1[_0x12520b(0x1ab)]['unzip'](_0x30da66[_0x12520b(0x1ae)]),_0x29dae3=[];for(const _0x196a6 in _0x16047d[_0x12520b(0x1b6)]){!_0x16047d['files'][_0x196a6]['dir']&&_0x29dae3[_0x12520b(0x1c5)]({'fileName':_0x196a6,'body':await _0x16047d[_0x12520b(0x1b6)][_0x196a6][_0x12520b(0x1a7)]('text')});}const _0x2862f5=await(0x0,extract_component_permissions_1[_0x12520b(0x19a)])(_0x29dae3[0x0]['body']['toString'](),_0x1f1fa0,_0x30da66['fileType']),_0x47067a=new xml2js_1['Builder']({'xmldec':{'version':_0x12520b(0x1f7),'encoding':_0x12520b(0x1ef)}}),_0x251862=_0x47067a[_0x12520b(0x1c3)](_0x2862f5),_0x21e0c0=zip_1[_0x12520b(0x1ab)][_0x12520b(0x1a5)]();_0x21e0c0['file'](_0x29dae3[0x0][_0x12520b(0x1ec)],_0x251862),_0x30da66[_0x12520b(0x1ae)]=await _0x21e0c0[_0x12520b(0x192)]({'type':_0x12520b(0x198),'compression':_0x12520b(0x19b),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x1b1383,_0xda9c05,_0x2ae0f4){const _0x432d78=a104_0x548169,_0x5dad82=_0x1b1383[_0x432d78(0x1d7)](_0x22a83d=>PERMISSION_SET_FOLDER_NAME+'/'+_0x22a83d[_0x432d78(0x1ec)])['join'](';'),_0x2ff609=[{'field':_0x432d78(0x1ec),'option':salesforce_1[_0x432d78(0x1be)]['IN'],'value':_0x5dad82}],_0x263a5a=new logger_1[(_0x432d78(0x1a3))]();return new salesforce_1[(_0x432d78(0x1f6))](_0xda9c05,_0x2ae0f4,_0x263a5a,_0x2ff609,null,[salesforce_1[_0x432d78(0x195)]['PERMISSION_SET']])['execute']();}async function mergePermissionSets(_0x4ca25c,_0x56532c){const _0x1d45d2=a104_0x548169,_0xf55f68=_0x56532c[_0x1d45d2(0x18f)]((_0x477aff,_0xb9140c)=>_0x477aff[_0x1d45d2(0x1cd)](_0xb9140c['listMetadataItem'][_0x1d45d2(0x1ec)],_0xb9140c),new Map());for(const _0x28457a of _0x4ca25c){const _0x552766=PERMISSION_SET_FOLDER_NAME+'/'+_0x28457a[_0x1d45d2(0x1ec)],_0x10a342=_0xf55f68[_0x1d45d2(0x1ca)](_0x552766);if(!_0x10a342)continue;const _0x599f8a=await zip_1['Zip'][_0x1d45d2(0x1c0)](_0x28457a[_0x1d45d2(0x1ae)]),_0x452363=await _0x599f8a['files'][_0x552766][_0x1d45d2(0x1a7)](_0x1d45d2(0x1e8)),_0x5ab21e=_0x10a342['files'][_0x552766][_0x1d45d2(0x1a4)](),_0x280998=await(0x0,extract_component_permissions_1[_0x1d45d2(0x191)])(_0x452363,_0x5ab21e,_0x28457a[_0x1d45d2(0x1df)]),_0x2bbb95=zip_1['Zip'][_0x1d45d2(0x1a5)]();_0x2bbb95['file'](_0x552766,_0x280998),_0x28457a[_0x1d45d2(0x1ae)]=await _0x2bbb95[_0x1d45d2(0x192)]({'type':_0x1d45d2(0x198),'compression':_0x1d45d2(0x19b),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x46d6ae,_0xb64bbd,_0x5ad6d6){const _0x480ec7=a104_0x548169;for(const _0x27c8e4 of _0x5ad6d6){if(_0x46d6ae[_0x480ec7(0x1e4)](_0x176e0d=>_0x176e0d!==_0x27c8e4[_0x480ec7(0x1df)]))continue;const _0x81c67c=await zip_1[_0x480ec7(0x1ab)][_0x480ec7(0x1c0)](_0x27c8e4['body']);for(const _0x5bbd1b in _0x81c67c[_0x480ec7(0x1b6)]){if(!_0x81c67c['files'][_0x5bbd1b][_0x480ec7(0x197)]){let _0x50ee79=await _0x81c67c[_0x480ec7(0x1b6)][_0x5bbd1b][_0x480ec7(0x1a7)](_0x480ec7(0x1e8));for(const _0x2b82aa of Object['keys'](_0xb64bbd)){const _0x1f7d63=new RegExp('%%'+_0x2b82aa+'%%','g');_0x50ee79=_0x50ee79[_0x480ec7(0x1b8)](_0x1f7d63,_0xb64bbd[_0x2b82aa]);}_0x81c67c['file'](_0x5bbd1b,_0x50ee79);}}_0x27c8e4[_0x480ec7(0x1ae)]=await _0x81c67c[_0x480ec7(0x192)]({'type':'base64','compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x23cdcd,_0x95c20c){const _0x1c4d7c=a104_0x548169,_0x11b5fb=new mdapi_writer_1[(_0x1c4d7c(0x1cf))]({'components':_0x23cdcd,'sourceDir':path_1[_0x1c4d7c(0x1e9)]['join'](process[_0x1c4d7c(0x19e)](),_0x1c4d7c(0x1a9),_0x95c20c,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x11b5fb[_0x1c4d7c(0x1a8)]();}async function generateAndWritePackageXML(_0x400259,_0x326909,_0x1043c3,_0x3d70fc){const _0xab1e42=a104_0x548169,_0x506968=getComponentsTypeAndName(_0x400259,_0x326909),_0x3ab0de=[...new Set(_0x506968[_0xab1e42(0x1d7)](_0x227a5d=>_0x227a5d['type']))],_0x185f18={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x3d70fc}};for(const _0x3e8c9c of _0x3ab0de){const _0x15ac9f=_0x506968[_0xab1e42(0x1b7)](_0x436f5a=>_0x436f5a['type']===_0x3e8c9c)[_0xab1e42(0x1d7)](_0x3a8ba6=>_0x3a8ba6[_0xab1e42(0x1a0)]),_0x59110c={'members':_0x15ac9f,'name':_0x3e8c9c};_0x185f18['Package'][_0xab1e42(0x1b1)][_0xab1e42(0x1c5)](_0x59110c);}const _0x2e7dbe=new xml2js_1[(_0xab1e42(0x1f2))]({'xmldec':{'version':_0xab1e42(0x1f7),'encoding':_0xab1e42(0x1ef)}}),_0xf56bbc=_0x2e7dbe[_0xab1e42(0x1c3)](_0x185f18);await fs_internal_1['FS'][_0xab1e42(0x1f0)](path_1[_0xab1e42(0x1e9)][_0xab1e42(0x1c8)](process[_0xab1e42(0x19e)](),_0xab1e42(0x1a9),_0x1043c3,DEPLOY_DIR_NAME,_0xab1e42(0x1a2),_0xab1e42(0x1db)),_0xf56bbc);}function getComponentsTypeAndName(_0x59feb4,_0x569931){const _0xfc5393=a104_0x548169;return _0x59feb4[_0xfc5393(0x18f)]((_0x5a864e,_0x35c078)=>{const _0x3611e7=_0xfc5393,_0x48a626=_0x569931[_0x3611e7(0x1e6)](_0xefef82=>_0xefef82['Id']===_0x35c078[_0x3611e7(0x1f1)]);return _0x48a626&&_0x5a864e[_0x3611e7(0x1c5)]({'name':_0x48a626[_0x3611e7(0x1a1)][_0x3611e7(0x1ac)],'type':salesforce_1[_0x3611e7(0x1ed)]['FOLDER_TO_METADATA_TYPE_MAP'][_0x35c078[_0x3611e7(0x1d8)]]||_0x35c078['Name']}),_0x5a864e;},[]);}async function saveDestructiveChanges(_0x365a4d,_0xa4b357,_0x553c95,_0x30dab6){const _0x38fcbb=a104_0x548169,_0xf4a588=(await(0x0,fetch_attachments_1[_0x38fcbb(0x1b3)])(_0x365a4d,_0xa4b357))['toString']();await fs_internal_1['FS'][_0x38fcbb(0x1f0)](path_1[_0x38fcbb(0x1e9)][_0x38fcbb(0x1c8)](process['cwd'](),'.temp',_0x30dab6,DEPLOY_DIR_NAME,'src',_0x553c95),_0xf4a588);}async function createDeployZip(_0x518baf){const _0x1ff44e=a104_0x548169,_0x393b72=new adm_zip_1[(_0x1ff44e(0x1e9))]();return await _0x393b72[_0x1ff44e(0x1f4)](path_1['default']['join'](process[_0x1ff44e(0x19e)](),'.temp',_0x518baf,DEPLOY_DIR_NAME)),_0x393b72;}async function insertZip(_0x24c19e,_0x2b4ddc,_0x308b0b,_0x210185,_0x351506,_0x30bad7){const _0x9d89d6=a104_0x548169,_0x43f4c1={'ParentId':_0x2b4ddc,'Name':_0x9d89d6(0x1d3)+_0x308b0b,'Description':_0x9d89d6(0x1d3)+_0x210185,'Body':_0x351506},{data:_0x117f9a}=await _0x24c19e[_0x9d89d6(0x1d9)](_0x9d89d6(0x1b2)+_0x30bad7+_0x9d89d6(0x1bd),_0x43f4c1);return _0x117f9a['id'];}