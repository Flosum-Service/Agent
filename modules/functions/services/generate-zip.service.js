const a86_0xcc6b26=a86_0x2d19;(function(_0xd48ae,_0x29befa){const _0x94716b=a86_0x2d19,_0x57a04c=_0xd48ae();while(!![]){try{const _0x377cef=parseInt(_0x94716b(0x1d6))/0x1+-parseInt(_0x94716b(0x203))/0x2+-parseInt(_0x94716b(0x218))/0x3*(parseInt(_0x94716b(0x1d5))/0x4)+-parseInt(_0x94716b(0x1d9))/0x5*(-parseInt(_0x94716b(0x1d4))/0x6)+parseInt(_0x94716b(0x1ec))/0x7+-parseInt(_0x94716b(0x1ed))/0x8*(parseInt(_0x94716b(0x227))/0x9)+parseInt(_0x94716b(0x21a))/0xa;if(_0x377cef===_0x29befa)break;else _0x57a04c['push'](_0x57a04c['shift']());}catch(_0x35860f){_0x57a04c['push'](_0x57a04c['shift']());}}}(a86_0x1619,0x99c38));function a86_0x1619(){const _0x5946d7=['length','fetchAttachmentsDetailsById','fileType','Body','files','UTF-8','ComponentsApi','cwd','toString','xml2js','__esModule','../../shared/utils/fetch-attachments','unzip','type','default','fileName','/sobjects/Attachment','after\x20create\x20zip','async','DEPLOYZIP','1590604XeUnCY','join','dir','fetchComponentsDetailsByComponentsHistory','indexOf','filter','generateAndDeployZip','package.xml','adm-zip','../utils/components-api','after\x20create\x20second\x20zip','createZip','substring','constructor','../utils/extract-component-permissions','file','defineProperty','buildObject','BUILD','then','MDApiWriter','6UMnVMS','__importDefault','16563040VODTwN','apply','toBuffer','every','Component__r','start','../../../constants','1.0','generateAsync','MAX_ZIP_SIZE','fs/promises','log','types','7698879RsJTvT','exists','Name','Zip','fetchAttachmentBody','keys','DEFLATE','replace','push','destructiveChangesPre.xml','(((.+)+)+)+$','src','1998jFLkwQ','1156088tmZYoO','657463mKcnPx','Component_Name__c','../../git/parsers/mdapi','5845kargZH','search','text','name','body','writeFile','values','reduce','Builder','base64','find','map','../../git/internal/fs.internal','http://soap.sforce.com/2006/04/metadata','extractComponentPermissions','.temp','uuid','ParentId','removeNamespacePrefix','1088843XGbyiD','8yJEQGZ','SALESFORCE_API_VERSION'];a86_0x1619=function(){return _0x5946d7;};return a86_0x1619();}const a86_0x42d648=(function(){let _0x31e8c4=!![];return function(_0x182afc,_0xc357a6){const _0x2cd5e0=_0x31e8c4?function(){const _0x959d32=a86_0x2d19;if(_0xc357a6){const _0x26f093=_0xc357a6[_0x959d32(0x21b)](_0x182afc,arguments);return _0xc357a6=null,_0x26f093;}}:function(){};return _0x31e8c4=![],_0x2cd5e0;};}()),a86_0x5274e3=a86_0x42d648(this,function(){const _0xeac94b=a86_0x2d19;return a86_0x5274e3['toString']()[_0xeac94b(0x1da)](_0xeac94b(0x1d2))[_0xeac94b(0x1f7)]()[_0xeac94b(0x210)](a86_0x5274e3)[_0xeac94b(0x1da)]('(((.+)+)+)+$');});a86_0x5274e3();'use strict';var __importDefault=this&&this[a86_0xcc6b26(0x219)]||function(_0x433037){const _0x139a2d=a86_0xcc6b26;return _0x433037&&_0x433037[_0x139a2d(0x1f9)]?_0x433037:{'default':_0x433037};};Object[a86_0xcc6b26(0x213)](exports,a86_0xcc6b26(0x1f9),{'value':!![]}),exports[a86_0xcc6b26(0x209)]=void 0x0;const constants_1=require(a86_0xcc6b26(0x220)),path_1=__importDefault(require('path')),extract_component_permissions_1=require(a86_0xcc6b26(0x211)),xml2js_1=require(a86_0xcc6b26(0x1f8)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require(a86_0xcc6b26(0x1d8)),fs_internal_1=require(a86_0xcc6b26(0x1e5)),promises_1=require(a86_0xcc6b26(0x224)),components_api_1=require(a86_0xcc6b26(0x20c)),adm_zip_1=__importDefault(require(a86_0xcc6b26(0x20b))),uuid_1=require(a86_0xcc6b26(0x1e9)),fetch_attachments_1=require(a86_0xcc6b26(0x1fa)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0xcc6b26(0x1d1),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a86_0xcc6b26(0x202);function a86_0x2d19(_0x3d4217,_0x1d995f){const _0x515405=a86_0x1619();return a86_0x2d19=function(_0x5274e3,_0x42d648){_0x5274e3=_0x5274e3-0x1ce;let _0x16196e=_0x515405[_0x5274e3];return _0x16196e;},a86_0x2d19(_0x3d4217,_0x1d995f);}async function generateAndDeployZip({attachmentsId:_0x245eb0,isExtractComponentsPermissions:_0x2fad03,preDestructiveAttachmentId:_0x7cd41f,postDestructiveAttachmentId:_0x44e76e,branchId:_0x3ee100,credentials:_0x568f66,metadataLogId:_0x2059ec,environments:_0x2f077a,metaTypes:_0x173652},_0x394faf){const _0x4b6121=a86_0xcc6b26,_0x43437c=(0x0,uuid_1['v4'])();try{const _0x168d3b=await(0x0,fetch_attachments_1[_0x4b6121(0x1f0)])(_0x394faf,_0x245eb0),_0x4fb3dc=_0x168d3b[_0x4b6121(0x1e0)]((_0x4035ea,_0x3d908d)=>({..._0x4035ea,[_0x3d908d['Id']]:_0x3d908d[_0x4b6121(0x229)]}),{}),_0x1d6b07=await getComponents(_0x168d3b,_0x394faf,_0x4fb3dc),_0xb00816=await components_api_1[_0x4b6121(0x1f5)][_0x4b6121(0x206)](_0x394faf,_0x168d3b[_0x4b6121(0x1e4)](({ParentId:_0x52aaae})=>_0x52aaae))['then'](_0x36a3bd=>components_api_1[_0x4b6121(0x1f5)][_0x4b6121(0x1eb)](_0x36a3bd));if(_0x2fad03){const _0x1eb917=_0x1d6b07[_0x4b6121(0x208)](({fileType:_0x294528})=>_0x294528==='Profile'||_0x294528==='PermissionSet');await removePermission(_0x1eb917,_0xb00816);}await replaceEnvironments(_0x173652,_0x2f077a,_0x1d6b07),await writeZip(_0x1d6b07,_0x43437c),await generateAndWritePackageXML(_0x168d3b,_0xb00816,_0x43437c);_0x7cd41f&&await saveDestructiveChanges(_0x394faf,_0x7cd41f,DESTRUCTIVE_CHANGES_PER_NAME,_0x43437c);_0x44e76e&&await saveDestructiveChanges(_0x394faf,_0x44e76e,DESTRUCTIVE_CHANGES_POST_NAME,_0x43437c);const _0x49aab1=(await createDeployZip(_0x43437c)['then'](_0x66ccc1=>{return _0x66ccc1;}))[_0x4b6121(0x21c)]()[_0x4b6121(0x1f7)](_0x4b6121(0x1e2));console[_0x4b6121(0x225)](_0x4b6121(0x200));const _0x92d6ae=_0x49aab1[_0x4b6121(0x1ef)];if(_0x92d6ae>=components_api_1[_0x4b6121(0x223)]){const _0x121f8c=await createDeployZip(_0x43437c);console[_0x4b6121(0x225)](_0x4b6121(0x20d));const [_0x18f62f,_0x377cb1]=await components_api_1[_0x4b6121(0x1f5)]['splitZip'](_0x121f8c,_0x92d6ae),_0x4b1830=await insertZip(_0x394faf,_0x3ee100,_0x568f66['orgId'],_0x2059ec,_0x18f62f[_0x4b6121(0x21c)]()['toString'](_0x4b6121(0x1e2))),_0xd24553=await insertZip(_0x394faf,_0x3ee100,_0x568f66['orgId'],_0x2059ec,_0x377cb1[_0x4b6121(0x21c)]()[_0x4b6121(0x1f7)](_0x4b6121(0x1e2)));return _0x4b1830+','+_0xd24553;}else return await insertZip(_0x394faf,_0x3ee100,_0x568f66['orgId'],_0x2059ec,_0x49aab1);}catch(_0x2946ac){throw _0x2946ac;}finally{if(await fs_internal_1['FS'][_0x4b6121(0x228)](path_1[_0x4b6121(0x1fd)][_0x4b6121(0x204)](process['cwd'](),'.temp',_0x43437c)))await(0x0,promises_1['rm'])(path_1['default']['join'](process[_0x4b6121(0x1f6)](),'.temp',_0x43437c),{'recursive':!![]});}}exports[a86_0xcc6b26(0x209)]=generateAndDeployZip;async function getComponents(_0x4a82c9,_0x33892e,_0x46c7e9){const _0x5b35ad=a86_0xcc6b26,_0x240d51=[],_0x2db9fe=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x4a82c9,_0x33892e);return await getComponentFromZip(_0x2db9fe,_0x46c7e9)[_0x5b35ad(0x216)](_0x2bc2a6=>{const _0x1d061b=_0x5b35ad;_0x240d51[_0x1d061b(0x1d0)](..._0x2bc2a6);}),_0x240d51;}async function getComponentFromZip(_0x2a016b,_0x4faa92){const _0x11a2d6=a86_0xcc6b26,_0x50f88c=[];for(const _0x1714f6 of _0x2a016b){const _0x57f5ad=await zip_1[_0x11a2d6(0x22a)]['unzip'](_0x1714f6[_0x11a2d6(0x1df)][_0x11a2d6(0x1f2)]);for(const _0x3c9328 in _0x57f5ad[_0x11a2d6(0x1f3)]){!_0x57f5ad[_0x11a2d6(0x1f3)][_0x3c9328]['dir']&&_0x50f88c[_0x11a2d6(0x1d0)]({'fileName':_0x3c9328[_0x11a2d6(0x20f)](_0x3c9328[_0x11a2d6(0x207)]('/')+0x1),'fileType':_0x4faa92[_0x1714f6['id']],'body':_0x1714f6[_0x11a2d6(0x1df)][_0x11a2d6(0x1f2)]});}}return _0x50f88c;}async function removePermission(_0x4a56be,_0x338db7){const _0x36ade0=a86_0xcc6b26;for(const _0xbfba14 of _0x4a56be){const _0xb81730=await zip_1[_0x36ade0(0x22a)][_0x36ade0(0x1fb)](_0xbfba14[_0x36ade0(0x1dd)]),_0x86934d=[];for(const _0xfa86e1 in _0xb81730['files']){!_0xb81730[_0x36ade0(0x1f3)][_0xfa86e1][_0x36ade0(0x205)]&&_0x86934d[_0x36ade0(0x1d0)]({'fileName':_0xfa86e1,'body':await _0xb81730[_0x36ade0(0x1f3)][_0xfa86e1][_0x36ade0(0x201)](_0x36ade0(0x1db))});}const _0x46ad9d=await(0x0,extract_component_permissions_1[_0x36ade0(0x1e7)])(_0x86934d[0x0]['body'][_0x36ade0(0x1f7)](),_0x338db7,_0xbfba14['fileType']),_0x7d7b68=new xml2js_1[(_0x36ade0(0x1e1))]({'xmldec':{'version':_0x36ade0(0x221),'encoding':_0x36ade0(0x1f4)}}),_0x5584f8=_0x7d7b68[_0x36ade0(0x214)](_0x46ad9d),_0x2bbcc4=zip_1[_0x36ade0(0x22a)][_0x36ade0(0x20e)]();_0x2bbcc4[_0x36ade0(0x212)](_0x86934d[0x0][_0x36ade0(0x1fe)],_0x5584f8),_0xbfba14['body']=await _0x2bbcc4['generateAsync']({'type':_0x36ade0(0x1e2),'compression':_0x36ade0(0x1ce),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x3dd3b8,_0x268d19,_0x4a49ca){const _0x2ebfa8=a86_0xcc6b26;for(const _0x33a9f4 of _0x4a49ca){if(_0x3dd3b8[_0x2ebfa8(0x21d)](_0x9d3e58=>_0x9d3e58!==_0x33a9f4[_0x2ebfa8(0x1f1)]))continue;const _0xd87f49=await zip_1[_0x2ebfa8(0x22a)][_0x2ebfa8(0x1fb)](_0x33a9f4['body']);for(const _0x45d29c in _0xd87f49[_0x2ebfa8(0x1f3)]){if(!_0xd87f49[_0x2ebfa8(0x1f3)][_0x45d29c][_0x2ebfa8(0x205)]){let _0x49d5a5=await _0xd87f49[_0x2ebfa8(0x1f3)][_0x45d29c][_0x2ebfa8(0x201)](_0x2ebfa8(0x1db));for(const _0x1f9561 of Object[_0x2ebfa8(0x22c)](_0x268d19)){const _0x1eae5c=new RegExp('%%'+_0x1f9561+'%%','g');_0x49d5a5=_0x49d5a5[_0x2ebfa8(0x1cf)](_0x1eae5c,_0x268d19[_0x1f9561]);}_0xd87f49[_0x2ebfa8(0x212)](_0x45d29c,_0x49d5a5);}}_0x33a9f4[_0x2ebfa8(0x1dd)]=await _0xd87f49[_0x2ebfa8(0x222)]({'type':_0x2ebfa8(0x1e2),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x4e91fe,_0xd274c1){const _0x2050af=a86_0xcc6b26,_0x480beb=new mdapi_1[(_0x2050af(0x217))]({'components':_0x4e91fe,'sourceDir':path_1[_0x2050af(0x1fd)][_0x2050af(0x204)](process['cwd'](),_0x2050af(0x1e8),_0xd274c1,DEPLOY_DIR_NAME,_0x2050af(0x1d3)),'skipChildErrors':![]});await _0x480beb[_0x2050af(0x21f)]();}async function generateAndWritePackageXML(_0x524a2f,_0x3e0bf9,_0x1129c4){const _0x228fc5=a86_0xcc6b26,_0x20ffe1=getComponentsTypeAndName(_0x524a2f,_0x3e0bf9),_0x1e5226=[...new Set(_0x20ffe1[_0x228fc5(0x1e4)](_0x33b08c=>_0x33b08c[_0x228fc5(0x1fc)]))],_0x37666f={'Package':{'$':{'xmlns':_0x228fc5(0x1e6)},'types':[],'version':''+constants_1[_0x228fc5(0x1ee)][_0x228fc5(0x20f)](0x1)}};for(const _0x3ff2dd of _0x1e5226){const _0x295a9a=_0x20ffe1[_0x228fc5(0x208)](_0x2269e0=>_0x2269e0[_0x228fc5(0x1fc)]===_0x3ff2dd)[_0x228fc5(0x1e4)](_0x47b11a=>_0x47b11a[_0x228fc5(0x1dc)]),_0x59605b={'members':_0x295a9a,'name':_0x3ff2dd};_0x37666f['Package'][_0x228fc5(0x226)][_0x228fc5(0x1d0)](_0x59605b);}const _0x37e616=new xml2js_1[(_0x228fc5(0x1e1))]({'xmldec':{'version':_0x228fc5(0x221),'encoding':_0x228fc5(0x1f4)}}),_0x58b33a=_0x37e616[_0x228fc5(0x214)](_0x37666f);await fs_internal_1['FS'][_0x228fc5(0x1de)](path_1['default']['join'](process['cwd'](),_0x228fc5(0x1e8),_0x1129c4,DEPLOY_DIR_NAME,'src',_0x228fc5(0x20a)),_0x58b33a);}function getComponentsTypeAndName(_0x2d68a0,_0x285517){const _0x50b301=a86_0xcc6b26;return _0x2d68a0[_0x50b301(0x1e0)]((_0x2fa63f,_0x27fe01)=>{const _0x193230=_0x50b301,_0x3e6c18=_0x285517[_0x193230(0x1e3)](_0x338bdb=>_0x338bdb['Id']===_0x27fe01[_0x193230(0x1ea)]);return _0x3e6c18&&_0x2fa63f['push']({'name':_0x3e6c18[_0x193230(0x21e)][_0x193230(0x1d7)],'type':_0x27fe01['Name']}),_0x2fa63f;},[]);}async function saveDestructiveChanges(_0x55580a,_0x14c325,_0x1e0f39,_0x4ac069){const _0x271def=a86_0xcc6b26,_0x1460ae=(await(0x0,fetch_attachments_1[_0x271def(0x22b)])(_0x55580a,_0x14c325))[_0x271def(0x1f7)]();await fs_internal_1['FS']['writeFile'](path_1[_0x271def(0x1fd)][_0x271def(0x204)](process[_0x271def(0x1f6)](),_0x271def(0x1e8),_0x4ac069,DEPLOY_DIR_NAME,_0x271def(0x1d3),_0x1e0f39),_0x1460ae);}async function createDeployZip(_0x5db265){const _0x51f2fa=a86_0xcc6b26,_0x5404df=new adm_zip_1[(_0x51f2fa(0x1fd))]();return await _0x5404df['addLocalFolder'](path_1[_0x51f2fa(0x1fd)][_0x51f2fa(0x204)](process[_0x51f2fa(0x1f6)](),'.temp',_0x5db265,DEPLOY_DIR_NAME)),_0x5404df;}async function insertZip(_0x54d035,_0x361bf8,_0x44288b,_0x327bef,_0x130a11){const _0x53d20e=a86_0xcc6b26,_0x35ed3f={'ParentId':_0x361bf8,'Name':_0x53d20e(0x215)+_0x44288b,'Description':'BUILD'+_0x327bef,'Body':_0x130a11},{data:_0x18df86}=await _0x54d035['post']('/services/data/'+constants_1['SALESFORCE_API_VERSION']+_0x53d20e(0x1ff),_0x35ed3f);return _0x18df86['id'];}