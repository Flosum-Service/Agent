const a86_0x6bf071=a86_0x17d8;(function(_0x3c530c,_0x4b874e){const _0x2b047c=a86_0x17d8,_0x1cb746=_0x3c530c();while(!![]){try{const _0x3d46d4=parseInt(_0x2b047c(0x174))/0x1*(parseInt(_0x2b047c(0x16a))/0x2)+parseInt(_0x2b047c(0x160))/0x3*(parseInt(_0x2b047c(0x141))/0x4)+-parseInt(_0x2b047c(0x13e))/0x5*(parseInt(_0x2b047c(0x16c))/0x6)+parseInt(_0x2b047c(0x18e))/0x7*(parseInt(_0x2b047c(0x18a))/0x8)+-parseInt(_0x2b047c(0x172))/0x9+parseInt(_0x2b047c(0x155))/0xa*(-parseInt(_0x2b047c(0x177))/0xb)+parseInt(_0x2b047c(0x166))/0xc;if(_0x3d46d4===_0x4b874e)break;else _0x1cb746['push'](_0x1cb746['shift']());}catch(_0x4f7b7a){_0x1cb746['push'](_0x1cb746['shift']());}}}(a86_0x3acf,0xab964));const a86_0x4f0151=(function(){let _0x33300b=!![];return function(_0x3c0535,_0x415d40){const _0x318a82=_0x33300b?function(){if(_0x415d40){const _0x53c76b=_0x415d40['apply'](_0x3c0535,arguments);return _0x415d40=null,_0x53c76b;}}:function(){};return _0x33300b=![],_0x318a82;};}()),a86_0x3e8cfc=a86_0x4f0151(this,function(){const _0x43ab74=a86_0x17d8;return a86_0x3e8cfc[_0x43ab74(0x13d)]()['search'](_0x43ab74(0x162))[_0x43ab74(0x13d)]()[_0x43ab74(0x136)](a86_0x3e8cfc)[_0x43ab74(0x13b)](_0x43ab74(0x162));});a86_0x3e8cfc();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x503b86){const _0x3b325f=a86_0x17d8;return _0x503b86&&_0x503b86[_0x3b325f(0x15a)]?_0x503b86:{'default':_0x503b86};};Object[a86_0x6bf071(0x185)](exports,a86_0x6bf071(0x15a),{'value':!![]}),exports[a86_0x6bf071(0x163)]=void 0x0;const constants_1=require(a86_0x6bf071(0x15d)),path_1=__importDefault(require(a86_0x6bf071(0x178))),extract_component_permissions_1=require(a86_0x6bf071(0x16d)),xml2js_1=require(a86_0x6bf071(0x158)),zip_1=require(a86_0x6bf071(0x17d)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require(a86_0x6bf071(0x14d)),promises_1=require(a86_0x6bf071(0x151)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a86_0x6bf071(0x165))),uuid_1=require(a86_0x6bf071(0x17c)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x6bf071(0x16f),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME=a86_0x6bf071(0x138);async function generateAndDeployZip({attachmentsId:_0x36be54,isExtractComponentsPermissions:_0x1026a4,preDestructiveAttachmentId:_0x507d92,postDestructiveAttachmentId:_0x4fef4a,branchId:_0x338882,credentials:_0x17622d,metadataLogId:_0x2dc959,environments:_0x7a33d0,metaTypes:_0x151585},_0x183efe){const _0x2b878b=a86_0x6bf071,_0x2a68b1=(0x0,uuid_1['v4'])();try{const _0x51ae9b=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x183efe,_0x36be54),_0xf69cd6=_0x51ae9b['reduce']((_0xab7c8e,_0x517c4b)=>({..._0xab7c8e,[_0x517c4b['Id']]:_0x517c4b[_0x2b878b(0x167)]}),{}),_0x1eb958=await getComponents(_0x51ae9b,_0x183efe,_0xf69cd6),_0x543a2b=await components_api_1[_0x2b878b(0x152)][_0x2b878b(0x142)](_0x183efe,_0x51ae9b[_0x2b878b(0x179)](({ParentId:_0x517e6a})=>_0x517e6a))['then'](_0x556aca=>components_api_1['ComponentsApi'][_0x2b878b(0x148)](_0x556aca));if(_0x1026a4){const _0x1e6e8a=_0x1eb958[_0x2b878b(0x164)](({fileType:_0x373ed5})=>_0x373ed5===_0x2b878b(0x189)||_0x373ed5==='PermissionSet');await removePermission(_0x1e6e8a,_0x543a2b);}await replaceEnvironments(_0x151585,_0x7a33d0,_0x1eb958),await writeZip(_0x1eb958,_0x2a68b1),await generateAndWritePackageXML(_0x51ae9b,_0x543a2b,_0x2a68b1);_0x507d92&&await saveDestructiveChanges(_0x183efe,_0x507d92,DESTRUCTIVE_CHANGES_PER_NAME,_0x2a68b1);_0x4fef4a&&await saveDestructiveChanges(_0x183efe,_0x4fef4a,DESTRUCTIVE_CHANGES_POST_NAME,_0x2a68b1);const _0x1941fc=(await createDeployZip(_0x2a68b1)[_0x2b878b(0x15e)](_0x4f2767=>{return _0x4f2767;}))['toBuffer']()['toString'](_0x2b878b(0x146));console[_0x2b878b(0x168)](_0x2b878b(0x173));const _0x2ab273=_0x1941fc['length'];if(_0x2ab273>=components_api_1[_0x2b878b(0x154)]){const _0x251c1e=await createDeployZip(_0x2a68b1);console[_0x2b878b(0x168)](_0x2b878b(0x13a));const [_0x7e2a58,_0x8ac84a]=await components_api_1['ComponentsApi'][_0x2b878b(0x150)](_0x251c1e,_0x2ab273),_0x4f71ea=await insertZip(_0x183efe,_0x338882,_0x17622d['orgId'],_0x2dc959,_0x7e2a58[_0x2b878b(0x14e)]()[_0x2b878b(0x13d)]('base64')),_0x15aef8=await insertZip(_0x183efe,_0x338882,_0x17622d['orgId'],_0x2dc959,_0x8ac84a['toBuffer']()[_0x2b878b(0x13d)]('base64'));return _0x4f71ea+','+_0x15aef8;}else return await insertZip(_0x183efe,_0x338882,_0x17622d['orgId'],_0x2dc959,_0x1941fc);}catch(_0x3bd2b5){throw _0x3bd2b5;}finally{if(await fs_internal_1['FS'][_0x2b878b(0x169)](path_1[_0x2b878b(0x159)][_0x2b878b(0x188)](process[_0x2b878b(0x16e)](),_0x2b878b(0x18d),_0x2a68b1)))await(0x0,promises_1['rm'])(path_1[_0x2b878b(0x159)]['join'](process[_0x2b878b(0x16e)](),'.temp',_0x2a68b1),{'recursive':!![]});}}exports[a86_0x6bf071(0x163)]=generateAndDeployZip;async function getComponents(_0x462db7,_0x2f33c8,_0x2aad97){const _0x3f19b7=a86_0x6bf071,_0x5904c4=[],_0x3fd319=await(0x0,fetch_attachments_1[_0x3f19b7(0x17e)])(_0x462db7,_0x2f33c8);return await getComponentFromZip(_0x3fd319,_0x2aad97)[_0x3f19b7(0x15e)](_0x4da12a=>{_0x5904c4['push'](..._0x4da12a);}),_0x5904c4;}async function getComponentFromZip(_0x2fd53f,_0x1c327d){const _0x891067=a86_0x6bf071,_0x4db60a=[];for(const _0x9d1c58 of _0x2fd53f){const _0x4efca9=await zip_1['Zip'][_0x891067(0x15c)](_0x9d1c58[_0x891067(0x16b)][_0x891067(0x156)]);for(const _0x326e16 in _0x4efca9['files']){!_0x4efca9[_0x891067(0x17b)][_0x326e16][_0x891067(0x137)]&&_0x4db60a[_0x891067(0x149)]({'fileName':_0x326e16['substring'](_0x326e16[_0x891067(0x17a)]('/')+0x1),'fileType':_0x1c327d[_0x9d1c58['id']],'body':_0x9d1c58['values'][_0x891067(0x156)]});}}return _0x4db60a;}async function removePermission(_0x57d2b0,_0xb54bb3){const _0x2ac13c=a86_0x6bf071;for(const _0x46947d of _0x57d2b0){const _0x4f1681=await zip_1[_0x2ac13c(0x14c)][_0x2ac13c(0x15c)](_0x46947d[_0x2ac13c(0x145)]),_0x556ebd=[];for(const _0x3d3d0c in _0x4f1681['files']){!_0x4f1681[_0x2ac13c(0x17b)][_0x3d3d0c][_0x2ac13c(0x137)]&&_0x556ebd[_0x2ac13c(0x149)]({'fileName':_0x3d3d0c,'body':await _0x4f1681[_0x2ac13c(0x17b)][_0x3d3d0c]['async']('text')});}const _0x289217=await(0x0,extract_component_permissions_1[_0x2ac13c(0x147)])(_0x556ebd[0x0][_0x2ac13c(0x145)][_0x2ac13c(0x13d)](),_0xb54bb3,_0x46947d[_0x2ac13c(0x186)]),_0x249d41=new xml2js_1[(_0x2ac13c(0x161))]({'xmldec':{'version':_0x2ac13c(0x139),'encoding':_0x2ac13c(0x13c)}}),_0x41adb8=_0x249d41[_0x2ac13c(0x176)](_0x289217),_0xf3cd1d=zip_1[_0x2ac13c(0x14c)][_0x2ac13c(0x182)]();_0xf3cd1d[_0x2ac13c(0x15b)](_0x556ebd[0x0][_0x2ac13c(0x181)],_0x41adb8),_0x46947d[_0x2ac13c(0x145)]=await _0xf3cd1d[_0x2ac13c(0x18b)]({'type':_0x2ac13c(0x146),'compression':_0x2ac13c(0x144),'compressionOptions':{'level':0x6}});}}function a86_0x3acf(){const _0x2eb78a=['createZip','Package','package.xml','defineProperty','fileType','start','join','Profile','8pqEdYD','generateAsync','replace','.temp','6340201SqaNAn','fetchAttachmentBody','constructor','dir','DEPLOYZIP','1.0','after\x20create\x20second\x20zip','search','UTF-8','toString','60565PHDuUT','src','keys','26188zoSwQV','fetchComponentsDetailsByComponentsHistory','async','DEFLATE','body','base64','extractComponentPermissions','removeNamespacePrefix','push','types','substring','Zip','../../git/internal/fs.internal','toBuffer','/services/data/','splitZip','fs/promises','ComponentsApi','Component__r','MAX_ZIP_SIZE','10SZYKnX','Body','Component_Name__c','xml2js','default','__esModule','file','unzip','../../../constants','then','/sobjects/Attachment','102kzjdYt','Builder','(((.+)+)+)+$','generateAndDeployZip','filter','adm-zip','10048584xZSSjt','Name','log','exists','5414FtqykP','values','414MDFSat','../utils/extract-component-permissions','cwd','destructiveChangesPre.xml','SALESFORCE_API_VERSION','type','98280QFHspg','after\x20create\x20zip','89LGsCWj','writeFile','buildObject','7228199waViPt','path','map','indexOf','files','uuid','../../git/parsers/utils/zip','retrieveAttachments','http://soap.sforce.com/2006/04/metadata','ParentId','fileName'];a86_0x3acf=function(){return _0x2eb78a;};return a86_0x3acf();}function a86_0x17d8(_0x3d2b50,_0x4066bb){const _0x3d466d=a86_0x3acf();return a86_0x17d8=function(_0x3e8cfc,_0x4f0151){_0x3e8cfc=_0x3e8cfc-0x135;let _0x3acf83=_0x3d466d[_0x3e8cfc];return _0x3acf83;},a86_0x17d8(_0x3d2b50,_0x4066bb);}async function replaceEnvironments(_0x3871fb,_0x2b6883,_0x48e9fd){const _0x5f38a6=a86_0x6bf071;for(const _0x590f33 of _0x48e9fd){if(_0x3871fb['every'](_0x2af15b=>_0x2af15b!==_0x590f33[_0x5f38a6(0x186)]))continue;const _0x4ff64d=await zip_1['Zip'][_0x5f38a6(0x15c)](_0x590f33['body']);for(const _0x4de7dd in _0x4ff64d[_0x5f38a6(0x17b)]){if(!_0x4ff64d['files'][_0x4de7dd][_0x5f38a6(0x137)]){let _0x4cd910=await _0x4ff64d[_0x5f38a6(0x17b)][_0x4de7dd][_0x5f38a6(0x143)]('text');for(const _0x126d2e of Object[_0x5f38a6(0x140)](_0x2b6883)){const _0x3e834e=new RegExp('%%'+_0x126d2e+'%%','g');_0x4cd910=_0x4cd910[_0x5f38a6(0x18c)](_0x3e834e,_0x2b6883[_0x126d2e]);}_0x4ff64d['file'](_0x4de7dd,_0x4cd910);}}_0x590f33[_0x5f38a6(0x145)]=await _0x4ff64d[_0x5f38a6(0x18b)]({'type':_0x5f38a6(0x146),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x1bb4c5,_0x1817d8){const _0x2460d6=a86_0x6bf071,_0x565ec3=new mdapi_1['MDApiWriter']({'components':_0x1bb4c5,'sourceDir':path_1[_0x2460d6(0x159)]['join'](process[_0x2460d6(0x16e)](),_0x2460d6(0x18d),_0x1817d8,DEPLOY_DIR_NAME,'src'),'skipChildErrors':![]});await _0x565ec3[_0x2460d6(0x187)]();}async function generateAndWritePackageXML(_0x229561,_0x3bb365,_0x3aebfb){const _0x5952a5=a86_0x6bf071,_0x1388fb=getComponentsTypeAndName(_0x229561,_0x3bb365),_0x3eea08=[...new Set(_0x1388fb[_0x5952a5(0x179)](_0x513f32=>_0x513f32[_0x5952a5(0x171)]))],_0x45f0a8={'Package':{'$':{'xmlns':_0x5952a5(0x17f)},'types':[],'version':''+constants_1[_0x5952a5(0x170)][_0x5952a5(0x14b)](0x1)}};for(const _0x51e777 of _0x3eea08){const _0x5ab50a=_0x1388fb[_0x5952a5(0x164)](_0x5bf4ab=>_0x5bf4ab[_0x5952a5(0x171)]===_0x51e777)[_0x5952a5(0x179)](_0x2425b8=>_0x2425b8['name']),_0x4885d8={'members':_0x5ab50a,'name':_0x51e777};_0x45f0a8[_0x5952a5(0x183)][_0x5952a5(0x14a)][_0x5952a5(0x149)](_0x4885d8);}const _0x4b11f7=new xml2js_1[(_0x5952a5(0x161))]({'xmldec':{'version':_0x5952a5(0x139),'encoding':_0x5952a5(0x13c)}}),_0x2f0e20=_0x4b11f7[_0x5952a5(0x176)](_0x45f0a8);await fs_internal_1['FS'][_0x5952a5(0x175)](path_1['default'][_0x5952a5(0x188)](process['cwd'](),_0x5952a5(0x18d),_0x3aebfb,DEPLOY_DIR_NAME,_0x5952a5(0x13f),_0x5952a5(0x184)),_0x2f0e20);}function getComponentsTypeAndName(_0x2a2ad2,_0x2ca383){return _0x2a2ad2['reduce']((_0x25b750,_0x1e99ea)=>{const _0x1df267=a86_0x17d8,_0x26d825=_0x2ca383['find'](_0x3b02ac=>_0x3b02ac['Id']===_0x1e99ea[_0x1df267(0x180)]);return _0x26d825&&_0x25b750[_0x1df267(0x149)]({'name':_0x26d825[_0x1df267(0x153)][_0x1df267(0x157)],'type':_0x1e99ea[_0x1df267(0x167)]}),_0x25b750;},[]);}async function saveDestructiveChanges(_0x69bf97,_0x1f1e5a,_0x38c02c,_0x4590ea){const _0x4f1e7=a86_0x6bf071,_0x2f524c=(await(0x0,fetch_attachments_1[_0x4f1e7(0x135)])(_0x69bf97,_0x1f1e5a))[_0x4f1e7(0x13d)]();await fs_internal_1['FS'][_0x4f1e7(0x175)](path_1[_0x4f1e7(0x159)][_0x4f1e7(0x188)](process[_0x4f1e7(0x16e)](),_0x4f1e7(0x18d),_0x4590ea,DEPLOY_DIR_NAME,_0x4f1e7(0x13f),_0x38c02c),_0x2f524c);}async function createDeployZip(_0x46c173){const _0x22b0bd=a86_0x6bf071,_0x5853fc=new adm_zip_1[(_0x22b0bd(0x159))]();return await _0x5853fc['addLocalFolder'](path_1[_0x22b0bd(0x159)]['join'](process[_0x22b0bd(0x16e)](),_0x22b0bd(0x18d),_0x46c173,DEPLOY_DIR_NAME)),_0x5853fc;}async function insertZip(_0x474b27,_0x4b7077,_0xe33774,_0x1433db,_0x5342b2){const _0x5ddb8c=a86_0x6bf071,_0x25ea2a={'ParentId':_0x4b7077,'Name':'BUILD'+_0xe33774,'Description':'BUILD'+_0x1433db,'Body':_0x5342b2},{data:_0x4de7c2}=await _0x474b27['post'](_0x5ddb8c(0x14f)+constants_1[_0x5ddb8c(0x170)]+_0x5ddb8c(0x15f),_0x25ea2a);return _0x4de7c2['id'];}