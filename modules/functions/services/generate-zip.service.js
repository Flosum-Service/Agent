const a86_0x3c870d=a86_0x374c;(function(_0x51d363,_0x5620d9){const _0x4d266e=a86_0x374c,_0x25fe10=_0x51d363();while(!![]){try{const _0x5ac248=-parseInt(_0x4d266e(0x181))/0x1+-parseInt(_0x4d266e(0x171))/0x2*(-parseInt(_0x4d266e(0x18a))/0x3)+-parseInt(_0x4d266e(0x15b))/0x4*(parseInt(_0x4d266e(0x18c))/0x5)+-parseInt(_0x4d266e(0x184))/0x6*(parseInt(_0x4d266e(0x189))/0x7)+-parseInt(_0x4d266e(0x155))/0x8*(-parseInt(_0x4d266e(0x176))/0x9)+-parseInt(_0x4d266e(0x13e))/0xa*(parseInt(_0x4d266e(0x186))/0xb)+parseInt(_0x4d266e(0x14e))/0xc;if(_0x5ac248===_0x5620d9)break;else _0x25fe10['push'](_0x25fe10['shift']());}catch(_0x29e8f2){_0x25fe10['push'](_0x25fe10['shift']());}}}(a86_0x5269,0xc0073));const a86_0x558e45=(function(){let _0x444584=!![];return function(_0x229957,_0x52a415){const _0x552616=_0x444584?function(){const _0x3a71a7=a86_0x374c;if(_0x52a415){const _0x207fd2=_0x52a415[_0x3a71a7(0x13b)](_0x229957,arguments);return _0x52a415=null,_0x207fd2;}}:function(){};return _0x444584=![],_0x552616;};}()),a86_0x4e5053=a86_0x558e45(this,function(){const _0x34e221=a86_0x374c;return a86_0x4e5053[_0x34e221(0x135)]()['search'](_0x34e221(0x15c))[_0x34e221(0x135)]()[_0x34e221(0x14c)](a86_0x4e5053)[_0x34e221(0x15d)]('(((.+)+)+)+$');});a86_0x4e5053();'use strict';var __importDefault=this&&this[a86_0x3c870d(0x191)]||function(_0x295126){const _0x332c19=a86_0x3c870d;return _0x295126&&_0x295126[_0x332c19(0x17a)]?_0x295126:{'default':_0x295126};};Object[a86_0x3c870d(0x157)](exports,a86_0x3c870d(0x17a),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require(a86_0x3c870d(0x192)),path_1=__importDefault(require(a86_0x3c870d(0x160))),extract_component_permissions_1=require(a86_0x3c870d(0x187)),xml2js_1=require(a86_0x3c870d(0x146)),zip_1=require(a86_0x3c870d(0x13c)),mdapi_1=require(a86_0x3c870d(0x179)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a86_0x3c870d(0x143)),components_api_1=require(a86_0x3c870d(0x185)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a86_0x3c870d(0x139)),fetch_attachments_1=require(a86_0x3c870d(0x165)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a86_0x3c870d(0x148),DEPLOY_DIR_NAME=a86_0x3c870d(0x17e);async function generateAndDeployZip({attachmentsId:_0x224906,isExtractComponentsPermissions:_0x1a300e,preDestructiveAttachmentId:_0x16d794,postDestructiveAttachmentId:_0x4e1424,branchId:_0x4a0307,credentials:_0x1ccd56,metadataLogId:_0x2b00c1,environments:_0x4980c6,metaTypes:_0x138fba},_0x5471ac){const _0x1483bb=a86_0x3c870d,_0x25b61a=(0x0,uuid_1['v4'])();try{const _0x490173=await(0x0,fetch_attachments_1[_0x1483bb(0x178)])(_0x5471ac,_0x224906),_0x465d52=_0x490173['reduce']((_0x25ea2b,_0x41a543)=>({..._0x25ea2b,[_0x41a543['Id']]:_0x41a543[_0x1483bb(0x147)]}),{}),_0x287d18=await getComponents(_0x490173,_0x5471ac,_0x465d52),_0x4b2234=await components_api_1[_0x1483bb(0x16e)]['fetchComponentsDetailsByComponentsHistory'](_0x5471ac,_0x490173['map'](({ParentId:_0xd7d8ba})=>_0xd7d8ba))[_0x1483bb(0x16c)](_0x4e9dd0=>components_api_1[_0x1483bb(0x16e)][_0x1483bb(0x17c)](_0x4e9dd0));if(_0x1a300e){const _0x453a77=_0x287d18[_0x1483bb(0x16f)](({fileType:_0xfbc24b})=>_0xfbc24b===_0x1483bb(0x162)||_0xfbc24b==='PermissionSet');await removePermission(_0x453a77,_0x4b2234);}await replaceEnvironments(_0x138fba,_0x4980c6,_0x287d18),await writeZip(_0x287d18,_0x25b61a),await generateAndWritePackageXML(_0x490173,_0x4b2234,_0x25b61a);_0x16d794&&await saveDestructiveChanges(_0x5471ac,_0x16d794,DESTRUCTIVE_CHANGES_PER_NAME,_0x25b61a);_0x4e1424&&await saveDestructiveChanges(_0x5471ac,_0x4e1424,DESTRUCTIVE_CHANGES_POST_NAME,_0x25b61a);const _0x3b44aa=(await createDeployZip(_0x25b61a)[_0x1483bb(0x16c)](_0x25b907=>{return _0x25b907;}))[_0x1483bb(0x137)]()['toString'](_0x1483bb(0x14f));console[_0x1483bb(0x13f)](_0x1483bb(0x17f));const _0xcbdb45=_0x3b44aa[_0x1483bb(0x18e)];if(_0xcbdb45>=components_api_1[_0x1483bb(0x15e)]){const _0x352755=await createDeployZip(_0x25b61a);console[_0x1483bb(0x13f)]('after\x20create\x20second\x20zip');const [_0x90924b,_0x52397e]=await components_api_1[_0x1483bb(0x16e)][_0x1483bb(0x134)](_0x352755,_0xcbdb45),_0x3824b5=await insertZip(_0x5471ac,_0x4a0307,_0x1ccd56['orgId'],_0x2b00c1,_0x90924b['toBuffer']()[_0x1483bb(0x135)](_0x1483bb(0x14f))),_0x46a9f3=await insertZip(_0x5471ac,_0x4a0307,_0x1ccd56[_0x1483bb(0x163)],_0x2b00c1,_0x52397e['toBuffer']()[_0x1483bb(0x135)](_0x1483bb(0x14f)));return _0x3824b5+','+_0x46a9f3;}else return await insertZip(_0x5471ac,_0x4a0307,_0x1ccd56[_0x1483bb(0x163)],_0x2b00c1,_0x3b44aa);}catch(_0x3688de){throw _0x3688de;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x1483bb(0x170)]['join'](process[_0x1483bb(0x168)](),_0x1483bb(0x18b),_0x25b61a)))await(0x0,promises_1['rm'])(path_1[_0x1483bb(0x170)][_0x1483bb(0x173)](process[_0x1483bb(0x168)](),'.temp',_0x25b61a),{'recursive':!![]});}}exports[a86_0x3c870d(0x15f)]=generateAndDeployZip;async function getComponents(_0x3f1c96,_0x34d0b4,_0xe46a12){const _0x1b79ec=a86_0x3c870d,_0x3bd6f0=[],_0x2c2674=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x3f1c96,_0x34d0b4);return await getComponentFromZip(_0x2c2674,_0xe46a12)[_0x1b79ec(0x16c)](_0x408e94=>{_0x3bd6f0['push'](..._0x408e94);}),_0x3bd6f0;}async function getComponentFromZip(_0x548cb0,_0x3da89f){const _0x3ac4ab=a86_0x3c870d,_0x13c550=[];for(const _0xa8692b of _0x548cb0){const _0x979d06=await zip_1[_0x3ac4ab(0x152)]['unzip'](_0xa8692b[_0x3ac4ab(0x166)][_0x3ac4ab(0x156)]);for(const _0x36eb18 in _0x979d06[_0x3ac4ab(0x144)]){!_0x979d06[_0x3ac4ab(0x144)][_0x36eb18][_0x3ac4ab(0x175)]&&_0x13c550[_0x3ac4ab(0x151)]({'fileName':_0x36eb18['substring'](_0x36eb18[_0x3ac4ab(0x138)]('/')+0x1),'fileType':_0x3da89f[_0xa8692b['id']],'body':_0xa8692b[_0x3ac4ab(0x166)][_0x3ac4ab(0x156)]});}}return _0x13c550;}async function removePermission(_0x4bbb5e,_0x4fe8bf){const _0xd2d83e=a86_0x3c870d;for(const _0x39f51c of _0x4bbb5e){const _0x36de43=await zip_1['Zip'][_0xd2d83e(0x167)](_0x39f51c[_0xd2d83e(0x15a)]),_0x2198f7=[];for(const _0x30565a in _0x36de43[_0xd2d83e(0x144)]){!_0x36de43[_0xd2d83e(0x144)][_0x30565a][_0xd2d83e(0x175)]&&_0x2198f7[_0xd2d83e(0x151)]({'fileName':_0x30565a,'body':await _0x36de43[_0xd2d83e(0x144)][_0x30565a][_0xd2d83e(0x145)](_0xd2d83e(0x14b))});}const _0x30482e=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x2198f7[0x0]['body'][_0xd2d83e(0x135)](),_0x4fe8bf,_0x39f51c[_0xd2d83e(0x180)]),_0x9c5ae4=new xml2js_1[(_0xd2d83e(0x14a))]({'xmldec':{'version':_0xd2d83e(0x17d),'encoding':'UTF-8'}}),_0x7bb3f=_0x9c5ae4[_0xd2d83e(0x174)](_0x30482e),_0x101f5b=zip_1['Zip']['createZip']();_0x101f5b[_0xd2d83e(0x142)](_0x2198f7[0x0][_0xd2d83e(0x140)],_0x7bb3f),_0x39f51c[_0xd2d83e(0x15a)]=await _0x101f5b[_0xd2d83e(0x182)]({'type':_0xd2d83e(0x14f),'compression':_0xd2d83e(0x153),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x5e683d,_0xa6941d,_0x16ec29){const _0x46649b=a86_0x3c870d;for(const _0x2d1b95 of _0x16ec29){if(_0x5e683d[_0x46649b(0x188)](_0x1f5a67=>_0x1f5a67!==_0x2d1b95[_0x46649b(0x180)]))continue;const _0x455867=await zip_1['Zip'][_0x46649b(0x167)](_0x2d1b95[_0x46649b(0x15a)]);for(const _0x1449e4 in _0x455867[_0x46649b(0x144)]){if(!_0x455867[_0x46649b(0x144)][_0x1449e4][_0x46649b(0x175)]){let _0x1c436c=await _0x455867[_0x46649b(0x144)][_0x1449e4][_0x46649b(0x145)](_0x46649b(0x14b));for(const _0x2780c8 of Object[_0x46649b(0x14d)](_0xa6941d)){const _0x1330e3=new RegExp('%%'+_0x2780c8+'%%','g');_0x1c436c=_0x1c436c[_0x46649b(0x18d)](_0x1330e3,_0xa6941d[_0x2780c8]);}_0x455867[_0x46649b(0x142)](_0x1449e4,_0x1c436c);}}_0x2d1b95[_0x46649b(0x15a)]=await _0x455867[_0x46649b(0x182)]({'type':_0x46649b(0x14f),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x4adf93,_0x19f413){const _0x5a714f=a86_0x3c870d,_0x5f11e2=new mdapi_1['MDApiWriter']({'components':_0x4adf93,'sourceDir':path_1[_0x5a714f(0x170)]['join'](process[_0x5a714f(0x168)](),_0x5a714f(0x18b),_0x19f413,DEPLOY_DIR_NAME,_0x5a714f(0x183)),'skipChildErrors':![]});await _0x5f11e2[_0x5a714f(0x169)]();}function a86_0x374c(_0x30601a,_0x2a2b64){const _0x8dfa1a=a86_0x5269();return a86_0x374c=function(_0x4e5053,_0x558e45){_0x4e5053=_0x4e5053-0x134;let _0x5269ea=_0x8dfa1a[_0x4e5053];return _0x5269ea;},a86_0x374c(_0x30601a,_0x2a2b64);}async function generateAndWritePackageXML(_0xb4fd25,_0x17405c,_0x15fb2f){const _0x413b9f=a86_0x3c870d,_0x3b6fb7=getComponentsTypeAndName(_0xb4fd25,_0x17405c),_0x28167f=[...new Set(_0x3b6fb7[_0x413b9f(0x13d)](_0x219db9=>_0x219db9['type']))],_0x45dda4={'Package':{'$':{'xmlns':_0x413b9f(0x158)},'types':[],'version':''+constants_1[_0x413b9f(0x154)][_0x413b9f(0x17b)](0x1)}};for(const _0x26ee32 of _0x28167f){const _0xef55e9=_0x3b6fb7['filter'](_0x3524cb=>_0x3524cb[_0x413b9f(0x190)]===_0x26ee32)[_0x413b9f(0x13d)](_0x463b0e=>_0x463b0e[_0x413b9f(0x141)]),_0xbdb49f={'members':_0xef55e9,'name':_0x26ee32};_0x45dda4[_0x413b9f(0x161)][_0x413b9f(0x136)][_0x413b9f(0x151)](_0xbdb49f);}const _0x546b03=new xml2js_1[(_0x413b9f(0x14a))]({'xmldec':{'version':'1.0','encoding':_0x413b9f(0x149)}}),_0x3eeb03=_0x546b03[_0x413b9f(0x174)](_0x45dda4);await fs_internal_1['FS'][_0x413b9f(0x16d)](path_1[_0x413b9f(0x170)][_0x413b9f(0x173)](process[_0x413b9f(0x168)](),'.temp',_0x15fb2f,DEPLOY_DIR_NAME,'src',_0x413b9f(0x16a)),_0x3eeb03);}function getComponentsTypeAndName(_0x388fe6,_0x5d25a7){const _0xf98132=a86_0x3c870d;return _0x388fe6[_0xf98132(0x18f)]((_0x1dea25,_0x2b2855)=>{const _0x12778e=_0xf98132,_0x127b72=_0x5d25a7['find'](_0x4a35fd=>_0x4a35fd['Id']===_0x2b2855[_0x12778e(0x13a)]);return _0x127b72&&_0x1dea25[_0x12778e(0x151)]({'name':_0x127b72[_0x12778e(0x150)][_0x12778e(0x164)],'type':_0x2b2855['Name']}),_0x1dea25;},[]);}function a86_0x5269(){const _0x569dba=['substring','removeNamespacePrefix','1.0','DEPLOYZIP','after\x20create\x20zip','fileType','291424OUYqkg','generateAsync','src','479922UwZLGI','../utils/components-api','781055xcYpfv','../utils/extract-component-permissions','every','77DnJSpi','30yfYNSm','.temp','1308190fDfCUe','replace','length','reduce','type','__importDefault','../../../constants','splitZip','toString','types','toBuffer','indexOf','uuid','ParentId','apply','../../git/parsers/utils/zip','map','90NOvSWL','log','fileName','name','file','fs/promises','files','async','xml2js','Name','destructiveChangesPost.xml','UTF-8','Builder','text','constructor','keys','8312688MmtKTx','base64','Component__r','push','Zip','DEFLATE','SALESFORCE_API_VERSION','376kustUJ','Body','defineProperty','http://soap.sforce.com/2006/04/metadata','post','body','4VhWMbz','(((.+)+)+)+$','search','MAX_ZIP_SIZE','generateAndDeployZip','path','Package','Profile','orgId','Component_Name__c','../../shared/utils/fetch-attachments','values','unzip','cwd','start','package.xml','fetchAttachmentBody','then','writeFile','ComponentsApi','filter','default','161300TEMgaF','addLocalFolder','join','buildObject','dir','260289WQSkXA','BUILD','fetchAttachmentsDetailsById','../../git/parsers/mdapi','__esModule'];a86_0x5269=function(){return _0x569dba;};return a86_0x5269();}async function saveDestructiveChanges(_0x47300c,_0x446de7,_0x227a8a,_0x457fc3){const _0x4a146b=a86_0x3c870d,_0x4cabf1=(await(0x0,fetch_attachments_1[_0x4a146b(0x16b)])(_0x47300c,_0x446de7))[_0x4a146b(0x135)]();await fs_internal_1['FS'][_0x4a146b(0x16d)](path_1[_0x4a146b(0x170)]['join'](process[_0x4a146b(0x168)](),'.temp',_0x457fc3,DEPLOY_DIR_NAME,_0x4a146b(0x183),_0x227a8a),_0x4cabf1);}async function createDeployZip(_0xf35695){const _0x548b76=a86_0x3c870d,_0x483b25=new adm_zip_1[(_0x548b76(0x170))]();return await _0x483b25[_0x548b76(0x172)](path_1['default']['join'](process['cwd'](),_0x548b76(0x18b),_0xf35695,DEPLOY_DIR_NAME)),_0x483b25;}async function insertZip(_0x15dcc0,_0x32ac6a,_0x43ea4b,_0x50d671,_0x5e9daa){const _0x21c09d=a86_0x3c870d,_0x1624e9={'ParentId':_0x32ac6a,'Name':'BUILD'+_0x43ea4b,'Description':_0x21c09d(0x177)+_0x50d671,'Body':_0x5e9daa},{data:_0x5baad2}=await _0x15dcc0[_0x21c09d(0x159)]('/services/data/'+constants_1['SALESFORCE_API_VERSION']+'/sobjects/Attachment',_0x1624e9);return _0x5baad2['id'];}