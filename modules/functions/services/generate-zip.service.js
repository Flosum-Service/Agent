const a86_0x27169d=a86_0x191d;(function(_0x5a0256,_0x1a4617){const _0x4947dc=a86_0x191d,_0x32331e=_0x5a0256();while(!![]){try{const _0xda98dd=-parseInt(_0x4947dc(0x1ab))/0x1*(parseInt(_0x4947dc(0x186))/0x2)+parseInt(_0x4947dc(0x1c8))/0x3+parseInt(_0x4947dc(0x1bd))/0x4*(-parseInt(_0x4947dc(0x1aa))/0x5)+-parseInt(_0x4947dc(0x1cd))/0x6*(-parseInt(_0x4947dc(0x1b7))/0x7)+parseInt(_0x4947dc(0x18b))/0x8+parseInt(_0x4947dc(0x192))/0x9+parseInt(_0x4947dc(0x1b6))/0xa;if(_0xda98dd===_0x1a4617)break;else _0x32331e['push'](_0x32331e['shift']());}catch(_0x24c519){_0x32331e['push'](_0x32331e['shift']());}}}(a86_0x83ce,0xba695));const a86_0x33fbe2=(function(){let _0x38133c=!![];return function(_0x359f14,_0x5f0f22){const _0x3467df=_0x38133c?function(){const _0x2d1fd3=a86_0x191d;if(_0x5f0f22){const _0x1612bc=_0x5f0f22[_0x2d1fd3(0x183)](_0x359f14,arguments);return _0x5f0f22=null,_0x1612bc;}}:function(){};return _0x38133c=![],_0x3467df;};}()),a86_0x3006e0=a86_0x33fbe2(this,function(){const _0x192dde=a86_0x191d;return a86_0x3006e0[_0x192dde(0x1d3)]()[_0x192dde(0x193)]('(((.+)+)+)+$')[_0x192dde(0x1d3)]()[_0x192dde(0x199)](a86_0x3006e0)[_0x192dde(0x193)](_0x192dde(0x1be));});function a86_0x83ce(){const _0x312a01=['destructiveChangesPre.xml','body','PermissionSet','fileType','constructor','file','writeFile','MAX_ZIP_SIZE','UTF-8','text','../../git/internal/fs.internal','adm-zip','DEPLOYZIP','start','after\x20create\x20second\x20zip','generateAsync','name','ComponentsApi','Profile','length','dir','70315oJtDlD','1PpVzLE','base64','DEFLATE','MDApiWriter','removeNamespacePrefix','path','orgId','Zip','buildObject','find','fileName','18594130JNkpKd','1769369cJVUhc','values','package.xml','post','map','/services/data/','284qJbVBG','(((.+)+)+)+$','fetchAttachmentsDetailsById','createZip','../../git/parsers/utils/zip','.temp','/sobjects/Attachment','xml2js','destructiveChangesPost.xml','Body','toBuffer','56301neftiO','replace','substring','fetchComponentsDetailsByComponentsHistory','src','6qaJBJE','Name','unzip','Builder','push','cwd','toString','SALESFORCE_API_VERSION','../../git/parsers/mdapi','async','then','type','Component_Name__c','uuid','retrieveAttachments','apply','default','1.0','2376006kwUOwW','generateAndDeployZip','http://soap.sforce.com/2006/04/metadata','reduce','filter','591944SeTWNG','addLocalFolder','log','BUILD','../utils/components-api','join','Component__r','6705693yEHGLH','search','files'];a86_0x83ce=function(){return _0x312a01;};return a86_0x83ce();}a86_0x3006e0();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2ede29){return _0x2ede29&&_0x2ede29['__esModule']?_0x2ede29:{'default':_0x2ede29};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a86_0x27169d(0x187)]=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require(a86_0x27169d(0x1b0))),extract_component_permissions_1=require('../utils/extract-component-permissions'),xml2js_1=require(a86_0x27169d(0x1c4)),zip_1=require(a86_0x27169d(0x1c1)),mdapi_1=require(a86_0x27169d(0x1d5)),fs_internal_1=require(a86_0x27169d(0x19f)),promises_1=require('fs/promises'),components_api_1=require(a86_0x27169d(0x18f)),adm_zip_1=__importDefault(require(a86_0x27169d(0x1a0))),uuid_1=require(a86_0x27169d(0x1da)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x27169d(0x195),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x27169d(0x1c5),DEPLOY_DIR_NAME=a86_0x27169d(0x1a1);async function generateAndDeployZip({attachmentsId:_0x21e611,isExtractComponentsPermissions:_0x506131,preDestructiveAttachmentId:_0x5cbd13,postDestructiveAttachmentId:_0x29d773,branchId:_0x5422aa,credentials:_0x3a486b,metadataLogId:_0x47eeb3,environments:_0x43c6f1,metaTypes:_0x4248f3},_0x5f4743){const _0x44fc28=a86_0x27169d,_0x5aa28a=(0x0,uuid_1['v4'])();try{const _0x29b789=await(0x0,fetch_attachments_1[_0x44fc28(0x1bf)])(_0x5f4743,_0x21e611),_0x3a3cf0=_0x29b789[_0x44fc28(0x189)]((_0x346cd3,_0x1ba433)=>({..._0x346cd3,[_0x1ba433['Id']]:_0x1ba433[_0x44fc28(0x1ce)]}),{}),_0x48c3b3=await getComponents(_0x29b789,_0x5f4743,_0x3a3cf0),_0x592bfa=await components_api_1[_0x44fc28(0x1a6)][_0x44fc28(0x1cb)](_0x5f4743,_0x29b789[_0x44fc28(0x1bb)](({ParentId:_0x4acf4b})=>_0x4acf4b))['then'](_0x37f1f2=>components_api_1[_0x44fc28(0x1a6)][_0x44fc28(0x1af)](_0x37f1f2));if(_0x506131){const _0x587643=_0x48c3b3[_0x44fc28(0x18a)](({fileType:_0x2ca31d})=>_0x2ca31d===_0x44fc28(0x1a7)||_0x2ca31d===_0x44fc28(0x197));await removePermission(_0x587643,_0x592bfa);}await replaceEnvironments(_0x4248f3,_0x43c6f1,_0x48c3b3),await writeZip(_0x48c3b3,_0x5aa28a),await generateAndWritePackageXML(_0x29b789,_0x592bfa,_0x5aa28a);_0x5cbd13&&await saveDestructiveChanges(_0x5f4743,_0x5cbd13,DESTRUCTIVE_CHANGES_PER_NAME,_0x5aa28a);_0x29d773&&await saveDestructiveChanges(_0x5f4743,_0x29d773,DESTRUCTIVE_CHANGES_POST_NAME,_0x5aa28a);const _0x246ce3=(await createDeployZip(_0x5aa28a)['then'](_0x562684=>{return _0x562684;}))['toBuffer']()[_0x44fc28(0x1d3)](_0x44fc28(0x1ac));console[_0x44fc28(0x18d)]('after\x20create\x20zip');const _0x18ce7e=_0x246ce3[_0x44fc28(0x1a8)];if(_0x18ce7e>=components_api_1[_0x44fc28(0x19c)]){const _0x15c995=await createDeployZip(_0x5aa28a);console['log'](_0x44fc28(0x1a3));const [_0x223c09,_0x557f64]=await components_api_1['ComponentsApi']['splitZip'](_0x15c995,_0x18ce7e),_0x19037a=await insertZip(_0x5f4743,_0x5422aa,_0x3a486b[_0x44fc28(0x1b1)],_0x47eeb3,_0x223c09[_0x44fc28(0x1c7)]()[_0x44fc28(0x1d3)]('base64')),_0x21f598=await insertZip(_0x5f4743,_0x5422aa,_0x3a486b[_0x44fc28(0x1b1)],_0x47eeb3,_0x557f64[_0x44fc28(0x1c7)]()[_0x44fc28(0x1d3)](_0x44fc28(0x1ac)));return _0x19037a+','+_0x21f598;}else return await insertZip(_0x5f4743,_0x5422aa,_0x3a486b['orgId'],_0x47eeb3,_0x246ce3);}catch(_0x45f60f){throw _0x45f60f;}finally{if(await fs_internal_1['FS']['exists'](path_1[_0x44fc28(0x184)][_0x44fc28(0x190)](process['cwd'](),_0x44fc28(0x1c2),_0x5aa28a)))await(0x0,promises_1['rm'])(path_1[_0x44fc28(0x184)][_0x44fc28(0x190)](process[_0x44fc28(0x1d2)](),'.temp',_0x5aa28a),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x1ec8dd,_0x16eab4,_0xcfc65b){const _0x1ea49c=a86_0x27169d,_0x49e91e=[],_0x156f5d=await(0x0,fetch_attachments_1[_0x1ea49c(0x182)])(_0x1ec8dd,_0x16eab4);return await getComponentFromZip(_0x156f5d,_0xcfc65b)[_0x1ea49c(0x1d7)](_0x462256=>{_0x49e91e['push'](..._0x462256);}),_0x49e91e;}async function getComponentFromZip(_0x584289,_0x542755){const _0xe1889b=a86_0x27169d,_0x3cb74a=[];for(const _0x935a1d of _0x584289){const _0x408989=await zip_1[_0xe1889b(0x1b2)][_0xe1889b(0x1cf)](_0x935a1d[_0xe1889b(0x1b8)][_0xe1889b(0x1c6)]);for(const _0xce247c in _0x408989['files']){!_0x408989[_0xe1889b(0x194)][_0xce247c][_0xe1889b(0x1a9)]&&_0x3cb74a[_0xe1889b(0x1d1)]({'fileName':_0xce247c[_0xe1889b(0x1ca)](_0xce247c['indexOf']('/')+0x1),'fileType':_0x542755[_0x935a1d['id']],'body':_0x935a1d[_0xe1889b(0x1b8)]['Body']});}}return _0x3cb74a;}function a86_0x191d(_0x51c0c2,_0x1df82f){const _0x2d9293=a86_0x83ce();return a86_0x191d=function(_0x3006e0,_0x33fbe2){_0x3006e0=_0x3006e0-0x182;let _0x83ce41=_0x2d9293[_0x3006e0];return _0x83ce41;},a86_0x191d(_0x51c0c2,_0x1df82f);}async function removePermission(_0x320568,_0x1a63f1){const _0x4c9397=a86_0x27169d;for(const _0x47ad02 of _0x320568){const _0xb7b487=await zip_1[_0x4c9397(0x1b2)]['unzip'](_0x47ad02[_0x4c9397(0x196)]),_0x61e409=[];for(const _0x3a897f in _0xb7b487['files']){!_0xb7b487['files'][_0x3a897f][_0x4c9397(0x1a9)]&&_0x61e409[_0x4c9397(0x1d1)]({'fileName':_0x3a897f,'body':await _0xb7b487['files'][_0x3a897f]['async'](_0x4c9397(0x19e))});}const _0x25a14d=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x61e409[0x0][_0x4c9397(0x196)]['toString'](),_0x1a63f1,_0x47ad02[_0x4c9397(0x198)]),_0xcfa08=new xml2js_1[(_0x4c9397(0x1d0))]({'xmldec':{'version':_0x4c9397(0x185),'encoding':'UTF-8'}}),_0x1e1855=_0xcfa08[_0x4c9397(0x1b3)](_0x25a14d),_0x1972d7=zip_1[_0x4c9397(0x1b2)][_0x4c9397(0x1c0)]();_0x1972d7['file'](_0x61e409[0x0][_0x4c9397(0x1b5)],_0x1e1855),_0x47ad02['body']=await _0x1972d7[_0x4c9397(0x1a4)]({'type':_0x4c9397(0x1ac),'compression':_0x4c9397(0x1ad),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x276b83,_0x1d05e1,_0xd81322){const _0x550655=a86_0x27169d;for(const _0x1ab518 of _0xd81322){if(_0x276b83['every'](_0x4a5b80=>_0x4a5b80!==_0x1ab518['fileType']))continue;const _0x5c9e3=await zip_1['Zip'][_0x550655(0x1cf)](_0x1ab518[_0x550655(0x196)]);for(const _0x2609bc in _0x5c9e3[_0x550655(0x194)]){if(!_0x5c9e3['files'][_0x2609bc][_0x550655(0x1a9)]){let _0x132f8c=await _0x5c9e3[_0x550655(0x194)][_0x2609bc][_0x550655(0x1d6)](_0x550655(0x19e));for(const _0x5dfac3 of Object['keys'](_0x1d05e1)){const _0x5bb860=new RegExp('%%'+_0x5dfac3+'%%','g');_0x132f8c=_0x132f8c[_0x550655(0x1c9)](_0x5bb860,_0x1d05e1[_0x5dfac3]);}_0x5c9e3[_0x550655(0x19a)](_0x2609bc,_0x132f8c);}}_0x1ab518['body']=await _0x5c9e3[_0x550655(0x1a4)]({'type':_0x550655(0x1ac),'compression':_0x550655(0x1ad),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x3f1dbe,_0x15bd03){const _0x267fb5=a86_0x27169d,_0x1d5056=new mdapi_1[(_0x267fb5(0x1ae))]({'components':_0x3f1dbe,'sourceDir':path_1[_0x267fb5(0x184)][_0x267fb5(0x190)](process[_0x267fb5(0x1d2)](),'.temp',_0x15bd03,DEPLOY_DIR_NAME,_0x267fb5(0x1cc)),'skipChildErrors':![]});await _0x1d5056[_0x267fb5(0x1a2)]();}async function generateAndWritePackageXML(_0x15b516,_0x1899dc,_0x1bc67c){const _0x3c97f4=a86_0x27169d,_0x389437=getComponentsTypeAndName(_0x15b516,_0x1899dc),_0x321390=[...new Set(_0x389437[_0x3c97f4(0x1bb)](_0x30a3ef=>_0x30a3ef['type']))],_0x489e40={'Package':{'$':{'xmlns':_0x3c97f4(0x188)},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION'][_0x3c97f4(0x1ca)](0x1)}};for(const _0x4fd46a of _0x321390){const _0x38c839=_0x389437[_0x3c97f4(0x18a)](_0x2cee6d=>_0x2cee6d[_0x3c97f4(0x1d8)]===_0x4fd46a)['map'](_0x219fab=>_0x219fab[_0x3c97f4(0x1a5)]),_0x4ea9b5={'members':_0x38c839,'name':_0x4fd46a};_0x489e40['Package']['types'][_0x3c97f4(0x1d1)](_0x4ea9b5);}const _0x437742=new xml2js_1['Builder']({'xmldec':{'version':_0x3c97f4(0x185),'encoding':_0x3c97f4(0x19d)}}),_0x253e3d=_0x437742[_0x3c97f4(0x1b3)](_0x489e40);await fs_internal_1['FS'][_0x3c97f4(0x19b)](path_1[_0x3c97f4(0x184)]['join'](process[_0x3c97f4(0x1d2)](),_0x3c97f4(0x1c2),_0x1bc67c,DEPLOY_DIR_NAME,_0x3c97f4(0x1cc),_0x3c97f4(0x1b9)),_0x253e3d);}function getComponentsTypeAndName(_0x4b2da4,_0x1afee9){const _0x399f2d=a86_0x27169d;return _0x4b2da4[_0x399f2d(0x189)]((_0x46d4b0,_0x1c5545)=>{const _0x512f33=_0x399f2d,_0x53b0fa=_0x1afee9[_0x512f33(0x1b4)](_0x55e5c3=>_0x55e5c3['Id']===_0x1c5545['ParentId']);return _0x53b0fa&&_0x46d4b0[_0x512f33(0x1d1)]({'name':_0x53b0fa[_0x512f33(0x191)][_0x512f33(0x1d9)],'type':_0x1c5545['Name']}),_0x46d4b0;},[]);}async function saveDestructiveChanges(_0xeb164a,_0x577cae,_0x57a910,_0x4a1c5d){const _0x2b44cd=a86_0x27169d,_0x2df0bd=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0xeb164a,_0x577cae))['toString']();await fs_internal_1['FS'][_0x2b44cd(0x19b)](path_1[_0x2b44cd(0x184)][_0x2b44cd(0x190)](process[_0x2b44cd(0x1d2)](),'.temp',_0x4a1c5d,DEPLOY_DIR_NAME,'src',_0x57a910),_0x2df0bd);}async function createDeployZip(_0xde94f0){const _0x53cf86=a86_0x27169d,_0x3b6616=new adm_zip_1[(_0x53cf86(0x184))]();return await _0x3b6616[_0x53cf86(0x18c)](path_1[_0x53cf86(0x184)]['join'](process[_0x53cf86(0x1d2)](),'.temp',_0xde94f0,DEPLOY_DIR_NAME)),_0x3b6616;}async function insertZip(_0x6a648d,_0x3a7fa4,_0x2ab040,_0x360c0e,_0x5ae68c){const _0x1daae9=a86_0x27169d,_0x530876={'ParentId':_0x3a7fa4,'Name':_0x1daae9(0x18e)+_0x2ab040,'Description':'BUILD'+_0x360c0e,'Body':_0x5ae68c},{data:_0x57bc18}=await _0x6a648d[_0x1daae9(0x1ba)](_0x1daae9(0x1bc)+constants_1[_0x1daae9(0x1d4)]+_0x1daae9(0x1c3),_0x530876);return _0x57bc18['id'];}