const a87_0x2fca2b=a87_0x2592;(function(_0x2faed2,_0x128226){const _0xd99ad6=a87_0x2592,_0xb81161=_0x2faed2();while(!![]){try{const _0x37366e=parseInt(_0xd99ad6(0xbc))/0x1*(-parseInt(_0xd99ad6(0xfc))/0x2)+parseInt(_0xd99ad6(0xf2))/0x3+parseInt(_0xd99ad6(0xfb))/0x4*(parseInt(_0xd99ad6(0x11c))/0x5)+parseInt(_0xd99ad6(0xf7))/0x6*(-parseInt(_0xd99ad6(0xe6))/0x7)+-parseInt(_0xd99ad6(0xce))/0x8+parseInt(_0xd99ad6(0x115))/0x9+parseInt(_0xd99ad6(0x103))/0xa;if(_0x37366e===_0x128226)break;else _0xb81161['push'](_0xb81161['shift']());}catch(_0x10cc33){_0xb81161['push'](_0xb81161['shift']());}}}(a87_0x50c2,0xb0a51));const a87_0x1f9dd6=(function(){let _0x468819=!![];return function(_0x24cbf3,_0x202f11){const _0x20c15d=_0x468819?function(){const _0x5c3300=a87_0x2592;if(_0x202f11){const _0x679254=_0x202f11[_0x5c3300(0xe2)](_0x24cbf3,arguments);return _0x202f11=null,_0x679254;}}:function(){};return _0x468819=![],_0x20c15d;};}()),a87_0x4d91e9=a87_0x1f9dd6(this,function(){const _0x423885=a87_0x2592;return a87_0x4d91e9[_0x423885(0xca)]()[_0x423885(0xde)](_0x423885(0xeb))['toString']()[_0x423885(0x105)](a87_0x4d91e9)[_0x423885(0xde)](_0x423885(0xeb));});a87_0x4d91e9();'use strict';var __importDefault=this&&this[a87_0x2fca2b(0xd0)]||function(_0x46c454){const _0xfabd32=a87_0x2fca2b;return _0x46c454&&_0x46c454[_0xfabd32(0xc7)]?_0x46c454:{'default':_0x46c454};};Object[a87_0x2fca2b(0x102)](exports,'__esModule',{'value':!![]}),exports[a87_0x2fca2b(0xd1)]=void 0x0;function a87_0x2592(_0x1005a8,_0x58e484){const _0x500c57=a87_0x50c2();return a87_0x2592=function(_0x4d91e9,_0x1f9dd6){_0x4d91e9=_0x4d91e9-0xb9;let _0x50c217=_0x500c57[_0x4d91e9];return _0x50c217;},a87_0x2592(_0x1005a8,_0x58e484);}const path_1=__importDefault(require(a87_0x2fca2b(0xbb))),extract_component_permissions_1=require(a87_0x2fca2b(0xdd)),logger_1=require(a87_0x2fca2b(0xee)),xml2js_1=require('xml2js'),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require(a87_0x2fca2b(0xc8)),fs_internal_1=require(a87_0x2fca2b(0xcc)),promises_1=require(a87_0x2fca2b(0xd9)),components_api_1=require(a87_0x2fca2b(0xd2)),adm_zip_1=__importDefault(require(a87_0x2fca2b(0x10e))),uuid_1=require(a87_0x2fca2b(0x107)),fetch_attachments_1=require(a87_0x2fca2b(0xe3)),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME=a87_0x2fca2b(0xf3),DESTRUCTIVE_CHANGES_POST_NAME=a87_0x2fca2b(0xf9),DEPLOY_DIR_NAME='DEPLOYZIP',PERMISSION_SET_FOLDER_NAME=a87_0x2fca2b(0xe0);async function generateAndDeployZip({attachmentsId:_0x58cc73,isExtractComponentsPermissionSets:_0x45539b,isExtractComponentsProfiles:_0x26f75e,preDestructiveAttachmentId:_0x187882,postDestructiveAttachmentId:_0x16791f,branchId:_0x2fdbfe,credentials:_0x2bc49c,metadataLogId:_0x4a2aa8,environments:_0x569879,metaTypes:_0x17cb76,apiVersion:_0x2d4d60},_0x4a3832,_0x2b0b5b){const _0xdf9cae=a87_0x2fca2b,_0x48bbc2=(0x0,uuid_1['v4'])();try{const _0x4e6569=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x4a3832,_0x58cc73),_0x32aeb0=_0x4e6569[_0xdf9cae(0xc1)]((_0x265be5,_0x43be9e)=>({..._0x265be5,[_0x43be9e['Id']]:_0x43be9e[_0xdf9cae(0x109)]}),{}),_0x550522=await getComponents(_0x4e6569,_0x4a3832,_0x32aeb0),_0x46d214=await components_api_1[_0xdf9cae(0xe9)]['fetchComponentsDetailsByComponentsHistory'](_0x4a3832,_0x4e6569[_0xdf9cae(0xc3)](({ParentId:_0x2fe851})=>_0x2fe851),_0x2d4d60)['then'](_0x4b18c7=>components_api_1['ComponentsApi'][_0xdf9cae(0xc5)](_0x4b18c7));if(_0x26f75e){const _0x9bdd70=_0x550522['filter'](({fileType:_0x216d6e})=>_0x216d6e===_0xdf9cae(0xea));await removePermission(_0x9bdd70,_0x46d214);}const _0x4ddf06=_0x550522[_0xdf9cae(0x118)](({fileType:_0x1c5e5e})=>_0x1c5e5e===_0xdf9cae(0x117));if(_0x4ddf06){if(_0x45539b){await removePermission(_0x4ddf06,_0x46d214);const {items:{PermissionSet:{components:_0x29183d}}}=await retrieveTargetPermissionSets(_0x4ddf06,_0x2d4d60,_0x2b0b5b);await mergePermissionSets(_0x4ddf06,_0x29183d);}}await replaceEnvironments(_0x17cb76,_0x569879,_0x550522),await writeZip(_0x550522,_0x48bbc2),await generateAndWritePackageXML(_0x4e6569,_0x46d214,_0x48bbc2,_0x2d4d60);_0x187882&&await saveDestructiveChanges(_0x4a3832,_0x187882,DESTRUCTIVE_CHANGES_PER_NAME,_0x48bbc2);_0x16791f&&await saveDestructiveChanges(_0x4a3832,_0x16791f,DESTRUCTIVE_CHANGES_POST_NAME,_0x48bbc2);const _0x3e5aa3=(await createDeployZip(_0x48bbc2)[_0xdf9cae(0xbf)](_0x431a3f=>{return _0x431a3f;}))[_0xdf9cae(0xd4)]()[_0xdf9cae(0xca)]('base64'),_0x1fa624=_0x3e5aa3['length'];if(_0x1fa624>=components_api_1[_0xdf9cae(0x111)]){const _0x57d1db=await createDeployZip(_0x48bbc2),[_0x3fce63,_0x54e6e5]=await components_api_1[_0xdf9cae(0xe9)][_0xdf9cae(0x113)](_0x57d1db,_0x1fa624),_0x169eb7=await insertZip(_0x4a3832,_0x2fdbfe,_0x2bc49c[_0xdf9cae(0xc0)],_0x4a2aa8,_0x3fce63[_0xdf9cae(0xd4)]()['toString'](_0xdf9cae(0x10a)),_0x2d4d60),_0x392b0a=await insertZip(_0x4a3832,_0x2fdbfe,_0x2bc49c[_0xdf9cae(0xc0)],_0x4a2aa8,_0x54e6e5[_0xdf9cae(0xd4)]()[_0xdf9cae(0xca)](_0xdf9cae(0x10a)),_0x2d4d60);return _0x169eb7+','+_0x392b0a;}else return await insertZip(_0x4a3832,_0x2fdbfe,_0x2bc49c[_0xdf9cae(0xc0)],_0x4a2aa8,_0x3e5aa3,_0x2d4d60);}catch(_0x3c1a47){throw _0x3c1a47;}finally{if(await fs_internal_1['FS'][_0xdf9cae(0x119)](path_1[_0xdf9cae(0xda)]['join'](process['cwd'](),_0xdf9cae(0xff),_0x48bbc2)))await(0x0,promises_1['rm'])(path_1['default']['join'](process['cwd'](),_0xdf9cae(0xff),_0x48bbc2),{'recursive':!![]});}}function a87_0x50c2(){const _0x59fb53=['PERMISSION_SET','MetadataConstants','fs/promises','default','UTF-8','/sobjects/Attachment','../utils/extract-component-permissions','search','ParentId','permissionsets','Zip','apply','../../shared/utils/fetch-attachments','values','find','245dJxFjZ','indexOf','fileType','ComponentsApi','Profile','(((.+)+)+)+$','mergeComponentPermissions','set','../classes/logger','package.xml','types','addLocalFolder','1348347BwsCbn','destructiveChangesPre.xml','keys','fileName','push','93552otUBKM','BUILD','destructiveChangesPost.xml','unzip','390972AJXGuH','2aPuoJD','every','generateAsync','.temp','Builder','retrieveAttachments','defineProperty','64670oUgzBF','join','constructor','type','uuid','PartialRetrieve','Name','base64','dir','DEFLATE','substring','adm-zip','Logger','Component__r','MAX_ZIP_SIZE','files','splitZip','1.0','9784782ROqBUu','async','PermissionSet','filter','exists','Component_Name__c','body','25EbLiRT','get','cwd','path','143119DqzwRR','buildObject','DeclarativeFilterOptions','then','orgId','reduce','execute','map','file','removeNamespacePrefix','extractComponentPermissions','__esModule','../../git/writers/mdapi.writer','src','toString','writeFile','../../git/internal/fs.internal','text','4955624caYwDy','createZip','__importDefault','generateAndDeployZip','../utils/components-api','name','toBuffer','post','MDApiWriter'];a87_0x50c2=function(){return _0x59fb53;};return a87_0x50c2();}exports[a87_0x2fca2b(0xd1)]=generateAndDeployZip;async function getComponents(_0x289f65,_0x5bc1b9,_0x2fd849){const _0x51abeb=a87_0x2fca2b,_0x574cc3=[],_0x2e5817=await(0x0,fetch_attachments_1[_0x51abeb(0x101)])(_0x289f65,_0x5bc1b9);return await getComponentFromZip(_0x2e5817,_0x2fd849)[_0x51abeb(0xbf)](_0x8d4854=>{const _0x249621=_0x51abeb;_0x574cc3[_0x249621(0xf6)](..._0x8d4854);}),_0x574cc3;}async function getComponentFromZip(_0xbfb0a5,_0x564322){const _0x37c545=a87_0x2fca2b,_0x16e1ef=[];for(const _0x4d2309 of _0xbfb0a5){const _0x461264=await zip_1[_0x37c545(0xe1)][_0x37c545(0xfa)](_0x4d2309[_0x37c545(0xe4)]['Body']);for(const _0x1ee74c in _0x461264[_0x37c545(0x112)]){!_0x461264[_0x37c545(0x112)][_0x1ee74c]['dir']&&_0x16e1ef[_0x37c545(0xf6)]({'fileName':_0x1ee74c[_0x37c545(0x10d)](_0x1ee74c[_0x37c545(0xe7)]('/')+0x1),'fileType':_0x564322[_0x4d2309['id']],'body':_0x4d2309[_0x37c545(0xe4)]['Body']});}}return _0x16e1ef;}async function removePermission(_0xfac0b5,_0x36662f){const _0x149aaf=a87_0x2fca2b;for(const _0x35908e of _0xfac0b5){const _0x365c09=await zip_1[_0x149aaf(0xe1)][_0x149aaf(0xfa)](_0x35908e[_0x149aaf(0x11b)]),_0x5a8241=[];for(const _0x385597 in _0x365c09[_0x149aaf(0x112)]){!_0x365c09[_0x149aaf(0x112)][_0x385597][_0x149aaf(0x10b)]&&_0x5a8241[_0x149aaf(0xf6)]({'fileName':_0x385597,'body':await _0x365c09[_0x149aaf(0x112)][_0x385597][_0x149aaf(0x116)](_0x149aaf(0xcd))});}const _0x1bcb36=await(0x0,extract_component_permissions_1[_0x149aaf(0xc6)])(_0x5a8241[0x0][_0x149aaf(0x11b)][_0x149aaf(0xca)](),_0x36662f,_0x35908e['fileType']),_0x94fd8b=new xml2js_1[(_0x149aaf(0x100))]({'xmldec':{'version':_0x149aaf(0x114),'encoding':_0x149aaf(0xdb)}}),_0x15bece=_0x94fd8b[_0x149aaf(0xbd)](_0x1bcb36),_0x508254=zip_1[_0x149aaf(0xe1)][_0x149aaf(0xcf)]();_0x508254[_0x149aaf(0xc4)](_0x5a8241[0x0]['fileName'],_0x15bece),_0x35908e[_0x149aaf(0x11b)]=await _0x508254[_0x149aaf(0xfe)]({'type':_0x149aaf(0x10a),'compression':_0x149aaf(0x10c),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x401b53,_0x2b6206,_0x3cbbcc){const _0x5771e1=a87_0x2fca2b,_0x288239=_0x401b53[_0x5771e1(0xc3)](_0x30d081=>PERMISSION_SET_FOLDER_NAME+'/'+_0x30d081[_0x5771e1(0xf5)])[_0x5771e1(0x104)](';'),_0x2f2710=[{'field':_0x5771e1(0xf5),'option':salesforce_1[_0x5771e1(0xbe)]['IN'],'value':_0x288239}],_0x29d2ec=new logger_1[(_0x5771e1(0x10f))]();return new salesforce_1[(_0x5771e1(0x108))](_0x2b6206,_0x3cbbcc,_0x29d2ec,_0x2f2710,null,[salesforce_1['MetadataType'][_0x5771e1(0xd7)]])[_0x5771e1(0xc2)]();}async function mergePermissionSets(_0x55da37,_0x2620c3){const _0x4c70cd=a87_0x2fca2b,_0x906903=_0x2620c3[_0x4c70cd(0xc1)]((_0x5aacec,_0x4a96e9)=>_0x5aacec[_0x4c70cd(0xed)](_0x4a96e9['listMetadataItem'][_0x4c70cd(0xf5)],_0x4a96e9),new Map());for(const _0x7d4718 of _0x55da37){const _0x117cf8=PERMISSION_SET_FOLDER_NAME+'/'+_0x7d4718['fileName'],_0x25de02=_0x906903[_0x4c70cd(0xb9)](_0x117cf8);if(!_0x25de02)continue;const _0x471977=await zip_1[_0x4c70cd(0xe1)][_0x4c70cd(0xfa)](_0x7d4718[_0x4c70cd(0x11b)]),_0x1a99f9=await _0x471977[_0x4c70cd(0x112)][_0x117cf8][_0x4c70cd(0x116)](_0x4c70cd(0xcd)),_0x141ce7=_0x25de02[_0x4c70cd(0x112)][_0x117cf8][_0x4c70cd(0xca)](),_0x3ebc72=await(0x0,extract_component_permissions_1[_0x4c70cd(0xec)])(_0x1a99f9,_0x141ce7,_0x7d4718[_0x4c70cd(0xe8)]),_0x192926=zip_1['Zip'][_0x4c70cd(0xcf)]();_0x192926[_0x4c70cd(0xc4)](_0x117cf8,_0x3ebc72),_0x7d4718['body']=await _0x192926[_0x4c70cd(0xfe)]({'type':'base64','compression':_0x4c70cd(0x10c),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x1bc47a,_0x401019,_0x3c101c){const _0x5d5293=a87_0x2fca2b;for(const _0x3e6e69 of _0x3c101c){if(_0x1bc47a[_0x5d5293(0xfd)](_0x493d8f=>_0x493d8f!==_0x3e6e69['fileType']))continue;const _0x5c2232=await zip_1[_0x5d5293(0xe1)]['unzip'](_0x3e6e69[_0x5d5293(0x11b)]);for(const _0x387ed6 in _0x5c2232[_0x5d5293(0x112)]){if(!_0x5c2232[_0x5d5293(0x112)][_0x387ed6]['dir']){let _0x1c6cc1=await _0x5c2232['files'][_0x387ed6][_0x5d5293(0x116)](_0x5d5293(0xcd));for(const _0x370834 of Object[_0x5d5293(0xf4)](_0x401019)){const _0x549a4e=new RegExp('%%'+_0x370834+'%%','g');_0x1c6cc1=_0x1c6cc1['replace'](_0x549a4e,_0x401019[_0x370834]);}_0x5c2232['file'](_0x387ed6,_0x1c6cc1);}}_0x3e6e69[_0x5d5293(0x11b)]=await _0x5c2232[_0x5d5293(0xfe)]({'type':_0x5d5293(0x10a),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x492731,_0xf282af){const _0x5d06a0=a87_0x2fca2b,_0x10db98=new mdapi_writer_1[(_0x5d06a0(0xd6))]({'components':_0x492731,'sourceDir':path_1['default'][_0x5d06a0(0x104)](process[_0x5d06a0(0xba)](),_0x5d06a0(0xff),_0xf282af,DEPLOY_DIR_NAME,_0x5d06a0(0xc9)),'skipChildErrors':![]});await _0x10db98['execute']();}async function generateAndWritePackageXML(_0x342946,_0x15a8ae,_0x4f972c,_0x42c7af){const _0x446255=a87_0x2fca2b,_0x573f6e=getComponentsTypeAndName(_0x342946,_0x15a8ae),_0x158c5c=[...new Set(_0x573f6e[_0x446255(0xc3)](_0x2886bf=>_0x2886bf[_0x446255(0x106)]))],_0x4d9612={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x42c7af}};for(const _0x5b130d of _0x158c5c){const _0x17df71=_0x573f6e[_0x446255(0x118)](_0x4dcfba=>_0x4dcfba[_0x446255(0x106)]===_0x5b130d)[_0x446255(0xc3)](_0x1a6d0f=>_0x1a6d0f[_0x446255(0xd3)]),_0x296b90={'members':_0x17df71,'name':_0x5b130d};_0x4d9612['Package'][_0x446255(0xf0)]['push'](_0x296b90);}const _0x4e5069=new xml2js_1[(_0x446255(0x100))]({'xmldec':{'version':_0x446255(0x114),'encoding':_0x446255(0xdb)}}),_0x28bd76=_0x4e5069[_0x446255(0xbd)](_0x4d9612);await fs_internal_1['FS'][_0x446255(0xcb)](path_1[_0x446255(0xda)][_0x446255(0x104)](process['cwd'](),_0x446255(0xff),_0x4f972c,DEPLOY_DIR_NAME,_0x446255(0xc9),_0x446255(0xef)),_0x28bd76);}function getComponentsTypeAndName(_0x45bfd4,_0x143ed2){const _0x2bf08a=a87_0x2fca2b;return _0x45bfd4[_0x2bf08a(0xc1)]((_0x2c9eb5,_0xdb5f7e)=>{const _0x465a88=_0x2bf08a,_0x23bab6=_0x143ed2[_0x465a88(0xe5)](_0x121f72=>_0x121f72['Id']===_0xdb5f7e[_0x465a88(0xdf)]);return _0x23bab6&&_0x2c9eb5[_0x465a88(0xf6)]({'name':_0x23bab6[_0x465a88(0x110)][_0x465a88(0x11a)],'type':salesforce_1[_0x465a88(0xd8)]['FOLDER_TO_METADATA_TYPE_MAP'][_0xdb5f7e[_0x465a88(0x109)]]||_0xdb5f7e[_0x465a88(0x109)]}),_0x2c9eb5;},[]);}async function saveDestructiveChanges(_0x50e924,_0x1c035f,_0x1225cb,_0x2215ad){const _0x3fc29a=a87_0x2fca2b,_0x1da74c=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x50e924,_0x1c035f))['toString']();await fs_internal_1['FS'][_0x3fc29a(0xcb)](path_1[_0x3fc29a(0xda)][_0x3fc29a(0x104)](process[_0x3fc29a(0xba)](),_0x3fc29a(0xff),_0x2215ad,DEPLOY_DIR_NAME,_0x3fc29a(0xc9),_0x1225cb),_0x1da74c);}async function createDeployZip(_0x5bcb62){const _0x2ddf28=a87_0x2fca2b,_0x5191bd=new adm_zip_1[(_0x2ddf28(0xda))]();return await _0x5191bd[_0x2ddf28(0xf1)](path_1[_0x2ddf28(0xda)]['join'](process[_0x2ddf28(0xba)](),_0x2ddf28(0xff),_0x5bcb62,DEPLOY_DIR_NAME)),_0x5191bd;}async function insertZip(_0xe284af,_0x2824eb,_0x46abd8,_0x3e0c76,_0x13a879,_0x28366e){const _0x3bf8d4=a87_0x2fca2b,_0x27068a={'ParentId':_0x2824eb,'Name':_0x3bf8d4(0xf8)+_0x46abd8,'Description':_0x3bf8d4(0xf8)+_0x3e0c76,'Body':_0x13a879},{data:_0x4a941a}=await _0xe284af[_0x3bf8d4(0xd5)]('/services/data/v'+_0x28366e+_0x3bf8d4(0xdc),_0x27068a);return _0x4a941a['id'];}