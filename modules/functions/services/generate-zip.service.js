const a104_0x4a78c5=a104_0x328c;(function(_0x32478d,_0x59711e){const _0x544bcd=a104_0x328c,_0x454cc8=_0x32478d();while(!![]){try{const _0x2d7a6f=-parseInt(_0x544bcd(0x13e))/0x1+parseInt(_0x544bcd(0x174))/0x2+parseInt(_0x544bcd(0x163))/0x3+-parseInt(_0x544bcd(0x144))/0x4*(-parseInt(_0x544bcd(0x145))/0x5)+parseInt(_0x544bcd(0x15d))/0x6*(parseInt(_0x544bcd(0x13c))/0x7)+-parseInt(_0x544bcd(0x131))/0x8*(-parseInt(_0x544bcd(0x17b))/0x9)+-parseInt(_0x544bcd(0x187))/0xa;if(_0x2d7a6f===_0x59711e)break;else _0x454cc8['push'](_0x454cc8['shift']());}catch(_0x4fdfe0){_0x454cc8['push'](_0x454cc8['shift']());}}}(a104_0x2f28,0x6d47f));const a104_0x3abc02=(function(){let _0x1914cc=!![];return function(_0x135065,_0x1032d3){const _0x1d14cc=_0x1914cc?function(){const _0x1bee8d=a104_0x328c;if(_0x1032d3){const _0x3e1b07=_0x1032d3[_0x1bee8d(0x179)](_0x135065,arguments);return _0x1032d3=null,_0x3e1b07;}}:function(){};return _0x1914cc=![],_0x1d14cc;};}()),a104_0x1baa85=a104_0x3abc02(this,function(){const _0x49e7fe=a104_0x328c;return a104_0x1baa85[_0x49e7fe(0x16c)]()[_0x49e7fe(0x142)]('(((.+)+)+)+$')[_0x49e7fe(0x16c)]()[_0x49e7fe(0x18b)](a104_0x1baa85)[_0x49e7fe(0x142)]('(((.+)+)+)+$');});a104_0x1baa85();'use strict';var __importDefault=this&&this[a104_0x4a78c5(0x17e)]||function(_0x3135c1){return _0x3135c1&&_0x3135c1['__esModule']?_0x3135c1:{'default':_0x3135c1};};Object['defineProperty'](exports,a104_0x4a78c5(0x158),{'value':!![]}),exports[a104_0x4a78c5(0x134)]=void 0x0;const path_1=__importDefault(require('path')),extract_component_permissions_1=require('../utils/extract-component-permissions'),logger_1=require(a104_0x4a78c5(0x170)),xml2js_1=require(a104_0x4a78c5(0x18f)),zip_1=require(a104_0x4a78c5(0x185)),mdapi_writer_1=require(a104_0x4a78c5(0x156)),fs_internal_1=require(a104_0x4a78c5(0x14f)),promises_1=require('fs/promises'),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a104_0x4a78c5(0x15e))),uuid_1=require(a104_0x4a78c5(0x151)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require(a104_0x4a78c5(0x15c)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x4a78c5(0x132),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x4a78c5(0x150),DEPLOY_DIR_NAME=a104_0x4a78c5(0x160),PERMISSION_SET_FOLDER_NAME=a104_0x4a78c5(0x154);async function generateAndDeployZip({attachmentsId:_0x488514,isExtractComponentsPermissionSets:_0x581676,isExtractComponentsProfiles:_0x25d71c,preDestructiveAttachmentId:_0x4f09d9,postDestructiveAttachmentId:_0x314f05,branchId:_0x536c11,credentials:_0x4e2173,metadataLogId:_0x4c5d2f,environments:_0x471091,metaTypes:_0x14d692,apiVersion:_0x46aca4},_0x26be1f,_0x3afb4d){const _0x1b4dcd=a104_0x4a78c5;var _0x289187;const _0x22d71e=(0x0,uuid_1['v4'])();try{const _0x8f768a=await(0x0,fetch_attachments_1[_0x1b4dcd(0x18c)])(_0x26be1f,_0x488514),_0x15158e=_0x8f768a[_0x1b4dcd(0x14b)]((_0x9e7d81,_0x2ba722)=>({..._0x9e7d81,[_0x2ba722['Id']]:_0x2ba722['Name']}),{}),_0x1a3e7e=await getComponents(_0x8f768a,_0x26be1f,_0x15158e),_0x43400b=await components_api_1[_0x1b4dcd(0x176)][_0x1b4dcd(0x166)](_0x26be1f,_0x8f768a[_0x1b4dcd(0x137)](({ParentId:_0x28ffa9})=>_0x28ffa9),_0x46aca4)[_0x1b4dcd(0x13d)](_0x56c7c9=>components_api_1[_0x1b4dcd(0x176)]['removeNamespacePrefix'](_0x56c7c9));if(_0x25d71c){const _0x3de0e7=_0x1a3e7e[_0x1b4dcd(0x13a)](({fileType:_0x112a89})=>_0x112a89===_0x1b4dcd(0x183));await removePermission(_0x3de0e7,_0x43400b);}const _0x355d26=_0x1a3e7e[_0x1b4dcd(0x13a)](({fileType:_0x532f0f})=>_0x532f0f===_0x1b4dcd(0x167));if(_0x355d26[_0x1b4dcd(0x12e)]&&_0x581676){await removePermission(_0x355d26,_0x43400b);const {items:_0x44aebb}=await retrieveTargetPermissionSets(_0x355d26,_0x46aca4,_0x3afb4d);await mergePermissionSets(_0x355d26,((_0x289187=_0x44aebb[_0x1b4dcd(0x167)])===null||_0x289187===void 0x0?void 0x0:_0x289187[_0x1b4dcd(0x162)])||[]);}await replaceEnvironments(_0x14d692,_0x471091,_0x1a3e7e),await writeZip(_0x1a3e7e,_0x22d71e),await generateAndWritePackageXML(_0x8f768a,_0x43400b,_0x22d71e,_0x46aca4);_0x4f09d9&&await saveDestructiveChanges(_0x26be1f,_0x4f09d9,DESTRUCTIVE_CHANGES_PER_NAME,_0x22d71e);_0x314f05&&await saveDestructiveChanges(_0x26be1f,_0x314f05,DESTRUCTIVE_CHANGES_POST_NAME,_0x22d71e);const _0x17143e=(await createDeployZip(_0x22d71e)[_0x1b4dcd(0x13d)](_0x2727ec=>{return _0x2727ec;}))[_0x1b4dcd(0x141)]()[_0x1b4dcd(0x16c)](_0x1b4dcd(0x135)),_0x348358=_0x17143e[_0x1b4dcd(0x12e)];if(_0x348358>=components_api_1[_0x1b4dcd(0x16b)]){const _0x7371bf=await createDeployZip(_0x22d71e),[_0x26dcce,_0x2292cc]=await components_api_1[_0x1b4dcd(0x176)][_0x1b4dcd(0x186)](_0x7371bf,_0x348358),_0x93b752=await insertZip(_0x26be1f,_0x536c11,_0x4e2173['orgId'],_0x4c5d2f,_0x26dcce[_0x1b4dcd(0x141)]()[_0x1b4dcd(0x16c)]('base64'),_0x46aca4),_0x50df93=await insertZip(_0x26be1f,_0x536c11,_0x4e2173[_0x1b4dcd(0x15b)],_0x4c5d2f,_0x2292cc[_0x1b4dcd(0x141)]()[_0x1b4dcd(0x16c)](_0x1b4dcd(0x135)),_0x46aca4);return _0x93b752+','+_0x50df93;}else return await insertZip(_0x26be1f,_0x536c11,_0x4e2173[_0x1b4dcd(0x15b)],_0x4c5d2f,_0x17143e,_0x46aca4);}catch(_0x3b2797){throw _0x3b2797;}finally{if(await fs_internal_1['FS'][_0x1b4dcd(0x140)](path_1[_0x1b4dcd(0x146)][_0x1b4dcd(0x15a)](process[_0x1b4dcd(0x14d)](),'.temp',_0x22d71e)))await(0x0,promises_1['rm'])(path_1['default']['join'](process[_0x1b4dcd(0x14d)](),_0x1b4dcd(0x153),_0x22d71e),{'recursive':!![]});}}exports[a104_0x4a78c5(0x134)]=generateAndDeployZip;async function getComponents(_0x593daa,_0x135cf0,_0x13ae61){const _0x4e5fd5=a104_0x4a78c5,_0x47171f=[],_0x550b77=await(0x0,fetch_attachments_1[_0x4e5fd5(0x130)])(_0x593daa,_0x135cf0);return await getComponentFromZip(_0x550b77,_0x13ae61)[_0x4e5fd5(0x13d)](_0x4155cf=>{const _0x1bee8c=_0x4e5fd5;_0x47171f[_0x1bee8c(0x136)](..._0x4155cf);}),_0x47171f;}async function getComponentFromZip(_0xa0d26,_0x590401){const _0x30763f=a104_0x4a78c5,_0xf363dc=[];for(const _0x23bee9 of _0xa0d26){const _0x367e5f=await zip_1[_0x30763f(0x178)]['unzip'](_0x23bee9[_0x30763f(0x17c)][_0x30763f(0x190)]);for(const _0x109455 in _0x367e5f[_0x30763f(0x168)]){!_0x367e5f[_0x30763f(0x168)][_0x109455]['dir']&&_0xf363dc[_0x30763f(0x136)]({'fileName':_0x109455[_0x30763f(0x181)](_0x109455[_0x30763f(0x182)]('/')+0x1),'fileType':_0x590401[_0x23bee9['id']],'body':_0x23bee9[_0x30763f(0x17c)][_0x30763f(0x190)]});}}return _0xf363dc;}async function removePermission(_0x11dc1a,_0x310cb9){const _0x24456e=a104_0x4a78c5;for(const _0x22fff9 of _0x11dc1a){const _0x56ec7e=await zip_1[_0x24456e(0x178)][_0x24456e(0x189)](_0x22fff9[_0x24456e(0x177)]),_0x1dca2d=[];for(const _0x15f839 in _0x56ec7e[_0x24456e(0x168)]){!_0x56ec7e[_0x24456e(0x168)][_0x15f839][_0x24456e(0x149)]&&_0x1dca2d[_0x24456e(0x136)]({'fileName':_0x15f839,'body':await _0x56ec7e[_0x24456e(0x168)][_0x15f839][_0x24456e(0x188)](_0x24456e(0x12d))});}const _0x4d144f=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x1dca2d[0x0][_0x24456e(0x177)][_0x24456e(0x16c)](),_0x310cb9,_0x22fff9[_0x24456e(0x16e)]),_0x39afbe=new xml2js_1[(_0x24456e(0x13f))]({'xmldec':{'version':'1.0','encoding':_0x24456e(0x180)}}),_0x475151=_0x39afbe[_0x24456e(0x157)](_0x4d144f),_0x37bc72=zip_1[_0x24456e(0x178)][_0x24456e(0x18d)]();_0x37bc72['file'](_0x1dca2d[0x0][_0x24456e(0x12f)],_0x475151),_0x22fff9['body']=await _0x37bc72['generateAsync']({'type':_0x24456e(0x135),'compression':_0x24456e(0x172),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x87eb19,_0x4c03ce,_0x423769){const _0x487d74=a104_0x4a78c5,_0x4d480b=_0x87eb19['map'](_0x518d80=>PERMISSION_SET_FOLDER_NAME+'/'+_0x518d80[_0x487d74(0x12f)])[_0x487d74(0x15a)](';'),_0x3f408e=[{'field':'fileName','option':salesforce_1[_0x487d74(0x155)]['IN'],'value':_0x4d480b}],_0x4ba0bd=new logger_1[(_0x487d74(0x169))]();return new salesforce_1[(_0x487d74(0x147))](_0x4c03ce,_0x423769,_0x4ba0bd,_0x3f408e,null,[salesforce_1[_0x487d74(0x18e)]['PERMISSION_SET']])[_0x487d74(0x17f)]();}async function mergePermissionSets(_0x19926a,_0x8f410f){const _0x295f86=a104_0x4a78c5,_0x26c4b1=_0x8f410f[_0x295f86(0x14b)]((_0x6af42d,_0x5a5b7b)=>_0x6af42d[_0x295f86(0x15f)](_0x5a5b7b[_0x295f86(0x175)][_0x295f86(0x12f)],_0x5a5b7b),new Map());for(const _0x102db8 of _0x19926a){const _0x218755=PERMISSION_SET_FOLDER_NAME+'/'+_0x102db8[_0x295f86(0x12f)],_0x5e4084=_0x26c4b1[_0x295f86(0x164)](_0x218755);if(!_0x5e4084)continue;const _0x23e021=await zip_1['Zip'][_0x295f86(0x189)](_0x102db8[_0x295f86(0x177)]),_0x43f0a5=await _0x23e021[_0x295f86(0x168)][_0x218755][_0x295f86(0x188)]('text'),_0x46e60c=_0x5e4084[_0x295f86(0x168)][_0x218755][_0x295f86(0x16c)](),_0xcf0a81=await(0x0,extract_component_permissions_1['mergeComponentPermissions'])(_0x43f0a5,_0x46e60c,_0x102db8['fileType']),_0x5ddffe=zip_1[_0x295f86(0x178)][_0x295f86(0x18d)]();_0x5ddffe[_0x295f86(0x159)](_0x218755,_0xcf0a81),_0x102db8[_0x295f86(0x177)]=await _0x5ddffe[_0x295f86(0x14a)]({'type':_0x295f86(0x135),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x12e86f,_0x3698de,_0x1b1921){const _0x5431d5=a104_0x4a78c5;for(const _0xa771c5 of _0x1b1921){if(_0x12e86f[_0x5431d5(0x133)](_0x2c079c=>_0x2c079c!==_0xa771c5[_0x5431d5(0x16e)]))continue;const _0x18964c=await zip_1['Zip'][_0x5431d5(0x189)](_0xa771c5['body']);for(const _0x51358b in _0x18964c[_0x5431d5(0x168)]){if(!_0x18964c[_0x5431d5(0x168)][_0x51358b][_0x5431d5(0x149)]){let _0x5c9fc2=await _0x18964c[_0x5431d5(0x168)][_0x51358b][_0x5431d5(0x188)](_0x5431d5(0x12d));for(const _0x10ba42 of Object['keys'](_0x3698de)){const _0x424629=new RegExp('%%'+_0x10ba42+'%%','g');_0x5c9fc2=_0x5c9fc2[_0x5431d5(0x17d)](_0x424629,_0x3698de[_0x10ba42]);}_0x18964c['file'](_0x51358b,_0x5c9fc2);}}_0xa771c5[_0x5431d5(0x177)]=await _0x18964c[_0x5431d5(0x14a)]({'type':_0x5431d5(0x135),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x323b02,_0x2180b0){const _0x48c028=a104_0x4a78c5,_0x5b38f6=new mdapi_writer_1[(_0x48c028(0x14e))]({'components':_0x323b02,'sourceDir':path_1['default'][_0x48c028(0x15a)](process[_0x48c028(0x14d)](),_0x48c028(0x153),_0x2180b0,DEPLOY_DIR_NAME,_0x48c028(0x13b)),'skipChildErrors':![]});await _0x5b38f6[_0x48c028(0x17f)]();}async function generateAndWritePackageXML(_0x125d01,_0x49a3bb,_0x41cbd8,_0x50de42){const _0x211295=a104_0x4a78c5,_0x1e6f6e=getComponentsTypeAndName(_0x125d01,_0x49a3bb),_0x3d0eea=[...new Set(_0x1e6f6e[_0x211295(0x137)](_0x1b0372=>_0x1b0372[_0x211295(0x171)]))],_0x221686={'Package':{'$':{'xmlns':_0x211295(0x12b)},'types':[],'version':''+_0x50de42}};for(const _0x280cfe of _0x3d0eea){const _0x24ad0f=_0x1e6f6e[_0x211295(0x13a)](_0x3e5196=>_0x3e5196[_0x211295(0x171)]===_0x280cfe)['map'](_0x12bdf9=>_0x12bdf9[_0x211295(0x12c)]),_0x2dab8d={'members':_0x24ad0f,'name':_0x280cfe};_0x221686[_0x211295(0x16f)][_0x211295(0x143)][_0x211295(0x136)](_0x2dab8d);}const _0x1ad8cc=new xml2js_1[(_0x211295(0x13f))]({'xmldec':{'version':_0x211295(0x184),'encoding':_0x211295(0x180)}}),_0x44a384=_0x1ad8cc[_0x211295(0x157)](_0x221686);await fs_internal_1['FS'][_0x211295(0x148)](path_1['default']['join'](process[_0x211295(0x14d)](),_0x211295(0x153),_0x41cbd8,DEPLOY_DIR_NAME,_0x211295(0x13b),_0x211295(0x138)),_0x44a384);}function getComponentsTypeAndName(_0xade95b,_0x4e8796){const _0x1482d4=a104_0x4a78c5;return _0xade95b[_0x1482d4(0x14b)]((_0x2fa372,_0x597758)=>{const _0x219756=_0x1482d4,_0x3f793b=_0x4e8796[_0x219756(0x16d)](_0x92bf59=>_0x92bf59['Id']===_0x597758[_0x219756(0x161)]);return _0x3f793b&&_0x2fa372['push']({'name':_0x3f793b[_0x219756(0x152)][_0x219756(0x139)],'type':salesforce_1[_0x219756(0x165)][_0x219756(0x17a)][_0x597758['Name']]||_0x597758['Name']}),_0x2fa372;},[]);}async function saveDestructiveChanges(_0x380004,_0x350ec8,_0x34504b,_0x5bdc20){const _0x48300e=a104_0x4a78c5,_0x1b73e1=(await(0x0,fetch_attachments_1[_0x48300e(0x173)])(_0x380004,_0x350ec8))['toString']();await fs_internal_1['FS'][_0x48300e(0x148)](path_1[_0x48300e(0x146)][_0x48300e(0x15a)](process['cwd'](),'.temp',_0x5bdc20,DEPLOY_DIR_NAME,_0x48300e(0x13b),_0x34504b),_0x1b73e1);}function a104_0x2f28(){const _0x17b7c3=['UTF-8','substring','indexOf','Profile','1.0','../../git/parsers/utils/zip','splitZip','10526890XyPzUI','async','unzip','addLocalFolder','constructor','fetchAttachmentsDetailsById','createZip','MetadataType','xml2js','Body','http://soap.sforce.com/2006/04/metadata','name','text','length','fileName','retrieveAttachments','117616eAqdEL','destructiveChangesPre.xml','every','generateAndDeployZip','base64','push','map','package.xml','Component_Name__c','filter','src','5978FuZUyn','then','190579llQKOW','Builder','exists','toBuffer','search','types','4eajVWt','678105EamEQk','default','PartialRetrieve','writeFile','dir','generateAsync','reduce','BUILD','cwd','MDApiWriter','../../git/internal/fs.internal','destructiveChangesPost.xml','uuid','Component__r','.temp','permissionsets','DeclarativeFilterOptions','../../git/writers/mdapi.writer','buildObject','__esModule','file','join','orgId','@flosum/salesforce','60SSIbnK','adm-zip','set','DEPLOYZIP','ParentId','components','1178694sOYmUN','get','MetadataConstants','fetchComponentsDetailsByComponentsHistory','PermissionSet','files','Logger','/sobjects/Attachment','MAX_ZIP_SIZE','toString','find','fileType','Package','../classes/logger','type','DEFLATE','fetchAttachmentBody','1719568FwUhmY','listMetadataItem','ComponentsApi','body','Zip','apply','FOLDER_TO_METADATA_TYPE_MAP','180ywobit','values','replace','__importDefault','execute'];a104_0x2f28=function(){return _0x17b7c3;};return a104_0x2f28();}function a104_0x328c(_0x45255c,_0x5f5412){const _0xeb2757=a104_0x2f28();return a104_0x328c=function(_0x1baa85,_0x3abc02){_0x1baa85=_0x1baa85-0x12b;let _0x2f282a=_0xeb2757[_0x1baa85];return _0x2f282a;},a104_0x328c(_0x45255c,_0x5f5412);}async function createDeployZip(_0x75e2c6){const _0x58f5ea=a104_0x4a78c5,_0x56379f=new adm_zip_1[(_0x58f5ea(0x146))]();return await _0x56379f[_0x58f5ea(0x18a)](path_1['default'][_0x58f5ea(0x15a)](process[_0x58f5ea(0x14d)](),_0x58f5ea(0x153),_0x75e2c6,DEPLOY_DIR_NAME)),_0x56379f;}async function insertZip(_0x4b9eb2,_0x2b3750,_0x68b76b,_0x3d4e54,_0x73ae2c,_0xb9d3dd){const _0x36e9be=a104_0x4a78c5,_0x2b6ce1={'ParentId':_0x2b3750,'Name':'BUILD'+_0x68b76b,'Description':_0x36e9be(0x14c)+_0x3d4e54,'Body':_0x73ae2c},{data:_0x2aaeeb}=await _0x4b9eb2['post']('/services/data/v'+_0xb9d3dd+_0x36e9be(0x16a),_0x2b6ce1);return _0x2aaeeb['id'];}