const a103_0x4d8233=a103_0x3741;(function(_0x171c7b,_0x165e0a){const _0x40f03d=a103_0x3741,_0x410a92=_0x171c7b();while(!![]){try{const _0x187c79=-parseInt(_0x40f03d(0x145))/0x1*(parseInt(_0x40f03d(0x123))/0x2)+-parseInt(_0x40f03d(0x122))/0x3+parseInt(_0x40f03d(0x17b))/0x4+-parseInt(_0x40f03d(0x165))/0x5+-parseInt(_0x40f03d(0x12d))/0x6+-parseInt(_0x40f03d(0x13f))/0x7*(-parseInt(_0x40f03d(0x12b))/0x8)+parseInt(_0x40f03d(0x127))/0x9;if(_0x187c79===_0x165e0a)break;else _0x410a92['push'](_0x410a92['shift']());}catch(_0x907f3f){_0x410a92['push'](_0x410a92['shift']());}}}(a103_0xd68c,0xd81d1));function a103_0x3741(_0x4ab5a9,_0x44deff){const _0x3fb640=a103_0xd68c();return a103_0x3741=function(_0x61286c,_0x3b0054){_0x61286c=_0x61286c-0x116;let _0xd68c26=_0x3fb640[_0x61286c];return _0xd68c26;},a103_0x3741(_0x4ab5a9,_0x44deff);}const a103_0x3b0054=(function(){let _0x4e4903=!![];return function(_0x382689,_0x472c69){const _0xce55a0=_0x4e4903?function(){const _0x50a744=a103_0x3741;if(_0x472c69){const _0x34365c=_0x472c69[_0x50a744(0x163)](_0x382689,arguments);return _0x472c69=null,_0x34365c;}}:function(){};return _0x4e4903=![],_0xce55a0;};}()),a103_0x61286c=a103_0x3b0054(this,function(){const _0x3c81f6=a103_0x3741;return a103_0x61286c[_0x3c81f6(0x142)]()[_0x3c81f6(0x168)](_0x3c81f6(0x15b))[_0x3c81f6(0x142)]()[_0x3c81f6(0x16c)](a103_0x61286c)[_0x3c81f6(0x168)](_0x3c81f6(0x15b));});a103_0x61286c();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x44c825){const _0x3f0c25=a103_0x3741;return _0x44c825&&_0x44c825[_0x3f0c25(0x175)]?_0x44c825:{'default':_0x44c825};};Object[a103_0x4d8233(0x13d)](exports,'__esModule',{'value':!![]}),exports[a103_0x4d8233(0x131)]=void 0x0;const path_1=__importDefault(require(a103_0x4d8233(0x124))),extract_component_permissions_1=require(a103_0x4d8233(0x173)),logger_1=require(a103_0x4d8233(0x151)),xml2js_1=require('xml2js'),zip_1=require(a103_0x4d8233(0x126)),mdapi_writer_1=require(a103_0x4d8233(0x16b)),fs_internal_1=require(a103_0x4d8233(0x120)),promises_1=require(a103_0x4d8233(0x176)),components_api_1=require(a103_0x4d8233(0x118)),adm_zip_1=__importDefault(require(a103_0x4d8233(0x17a))),uuid_1=require(a103_0x4d8233(0x162)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),salesforce_1=require('@flosum/salesforce'),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME='DEPLOYZIP',PERMISSION_SET_FOLDER_NAME=a103_0x4d8233(0x129);async function generateAndDeployZip({attachmentsId:_0x42558e,isExtractComponentsPermissionSets:_0x3f704a,isExtractComponentsProfiles:_0x1ad01f,preDestructiveAttachmentId:_0xa13463,postDestructiveAttachmentId:_0x1a487f,branchId:_0x542f14,credentials:_0x3d33b7,metadataLogId:_0x9443d8,environments:_0x18bad4,metaTypes:_0x5a46ce,apiVersion:_0x2c23f1},_0x273fd4,_0x6310b1){const _0x565d9a=a103_0x4d8233;var _0x319867;const _0x8240ee=(0x0,uuid_1['v4'])();try{const _0x40159a=await(0x0,fetch_attachments_1[_0x565d9a(0x166)])(_0x273fd4,_0x42558e),_0x33c4ed=_0x40159a[_0x565d9a(0x140)]((_0x49d2f1,_0x338d6a)=>({..._0x49d2f1,[_0x338d6a['Id']]:_0x338d6a['Name']}),{}),_0x432ea7=await getComponents(_0x40159a,_0x273fd4,_0x33c4ed),_0x51e770=await components_api_1[_0x565d9a(0x15a)][_0x565d9a(0x169)](_0x273fd4,_0x40159a[_0x565d9a(0x156)](({ParentId:_0x4cd3f6})=>_0x4cd3f6),_0x2c23f1)['then'](_0x49028f=>components_api_1['ComponentsApi']['removeNamespacePrefix'](_0x49028f));if(_0x1ad01f){const _0x5c687d=_0x432ea7[_0x565d9a(0x161)](({fileType:_0x431b86})=>_0x431b86===_0x565d9a(0x11a));await removePermission(_0x5c687d,_0x51e770);}const _0x5a3d34=_0x432ea7[_0x565d9a(0x161)](({fileType:_0xe7fcaa})=>_0xe7fcaa===_0x565d9a(0x153));if(_0x5a3d34){if(_0x3f704a){await removePermission(_0x5a3d34,_0x51e770);const {items:_0x1aef6d}=await retrieveTargetPermissionSets(_0x5a3d34,_0x2c23f1,_0x6310b1);await mergePermissionSets(_0x5a3d34,((_0x319867=_0x1aef6d[_0x565d9a(0x153)])===null||_0x319867===void 0x0?void 0x0:_0x319867['components'])||[]);}}await replaceEnvironments(_0x5a46ce,_0x18bad4,_0x432ea7),await writeZip(_0x432ea7,_0x8240ee),await generateAndWritePackageXML(_0x40159a,_0x51e770,_0x8240ee,_0x2c23f1);_0xa13463&&await saveDestructiveChanges(_0x273fd4,_0xa13463,DESTRUCTIVE_CHANGES_PER_NAME,_0x8240ee);_0x1a487f&&await saveDestructiveChanges(_0x273fd4,_0x1a487f,DESTRUCTIVE_CHANGES_POST_NAME,_0x8240ee);const _0x40f73b=(await createDeployZip(_0x8240ee)[_0x565d9a(0x15d)](_0x1ce388=>{return _0x1ce388;}))['toBuffer']()[_0x565d9a(0x142)](_0x565d9a(0x11b)),_0x501956=_0x40f73b[_0x565d9a(0x11e)];if(_0x501956>=components_api_1['MAX_ZIP_SIZE']){const _0x39104d=await createDeployZip(_0x8240ee),[_0x9e4426,_0xc4850c]=await components_api_1[_0x565d9a(0x15a)][_0x565d9a(0x179)](_0x39104d,_0x501956),_0x88ba60=await insertZip(_0x273fd4,_0x542f14,_0x3d33b7[_0x565d9a(0x132)],_0x9443d8,_0x9e4426['toBuffer']()[_0x565d9a(0x142)](_0x565d9a(0x11b)),_0x2c23f1),_0x156527=await insertZip(_0x273fd4,_0x542f14,_0x3d33b7[_0x565d9a(0x132)],_0x9443d8,_0xc4850c[_0x565d9a(0x147)]()['toString'](_0x565d9a(0x11b)),_0x2c23f1);return _0x88ba60+','+_0x156527;}else return await insertZip(_0x273fd4,_0x542f14,_0x3d33b7['orgId'],_0x9443d8,_0x40f73b,_0x2c23f1);}catch(_0x313984){throw _0x313984;}finally{if(await fs_internal_1['FS'][_0x565d9a(0x119)](path_1[_0x565d9a(0x137)][_0x565d9a(0x158)](process[_0x565d9a(0x16d)](),_0x565d9a(0x13c),_0x8240ee)))await(0x0,promises_1['rm'])(path_1['default'][_0x565d9a(0x158)](process['cwd'](),_0x565d9a(0x13c),_0x8240ee),{'recursive':!![]});}}exports['generateAndDeployZip']=generateAndDeployZip;async function getComponents(_0x2be574,_0x5e3f74,_0x4dcd3d){const _0x388e8d=a103_0x4d8233,_0x59df2a=[],_0x2f119b=await(0x0,fetch_attachments_1[_0x388e8d(0x135)])(_0x2be574,_0x5e3f74);return await getComponentFromZip(_0x2f119b,_0x4dcd3d)[_0x388e8d(0x15d)](_0x5e6bc7=>{const _0x198cb7=_0x388e8d;_0x59df2a[_0x198cb7(0x13e)](..._0x5e6bc7);}),_0x59df2a;}async function getComponentFromZip(_0x3799b8,_0x272958){const _0x3a36d6=a103_0x4d8233,_0x5dc044=[];for(const _0x324a75 of _0x3799b8){const _0x4483e8=await zip_1[_0x3a36d6(0x178)][_0x3a36d6(0x15c)](_0x324a75[_0x3a36d6(0x159)][_0x3a36d6(0x11f)]);for(const _0x48a464 in _0x4483e8[_0x3a36d6(0x157)]){!_0x4483e8[_0x3a36d6(0x157)][_0x48a464][_0x3a36d6(0x14d)]&&_0x5dc044[_0x3a36d6(0x13e)]({'fileName':_0x48a464[_0x3a36d6(0x14c)](_0x48a464['indexOf']('/')+0x1),'fileType':_0x272958[_0x324a75['id']],'body':_0x324a75[_0x3a36d6(0x159)][_0x3a36d6(0x11f)]});}}return _0x5dc044;}async function removePermission(_0x84250d,_0xea0dfd){const _0x177ec0=a103_0x4d8233;for(const _0x2edcce of _0x84250d){const _0x462117=await zip_1[_0x177ec0(0x178)]['unzip'](_0x2edcce['body']),_0x55bb36=[];for(const _0xf51711 in _0x462117[_0x177ec0(0x157)]){!_0x462117[_0x177ec0(0x157)][_0xf51711][_0x177ec0(0x14d)]&&_0x55bb36[_0x177ec0(0x13e)]({'fileName':_0xf51711,'body':await _0x462117[_0x177ec0(0x157)][_0xf51711][_0x177ec0(0x13b)]('text')});}const _0x4eabf1=await(0x0,extract_component_permissions_1[_0x177ec0(0x172)])(_0x55bb36[0x0][_0x177ec0(0x116)][_0x177ec0(0x142)](),_0xea0dfd,_0x2edcce['fileType']),_0x1cc7fd=new xml2js_1[(_0x177ec0(0x16f))]({'xmldec':{'version':_0x177ec0(0x12f),'encoding':_0x177ec0(0x143)}}),_0x36f105=_0x1cc7fd['buildObject'](_0x4eabf1),_0x48c834=zip_1['Zip'][_0x177ec0(0x139)]();_0x48c834['file'](_0x55bb36[0x0][_0x177ec0(0x16e)],_0x36f105),_0x2edcce[_0x177ec0(0x116)]=await _0x48c834[_0x177ec0(0x133)]({'type':'base64','compression':_0x177ec0(0x149),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x8f2c94,_0x3ccbdc,_0x2b6d67){const _0x36d388=a103_0x4d8233,_0x473931=_0x8f2c94['map'](_0x352f3b=>PERMISSION_SET_FOLDER_NAME+'/'+_0x352f3b[_0x36d388(0x16e)])[_0x36d388(0x158)](';'),_0x37efc5=[{'field':_0x36d388(0x16e),'option':salesforce_1[_0x36d388(0x154)]['IN'],'value':_0x473931}],_0x216dcc=new logger_1[(_0x36d388(0x136))]();return new salesforce_1[(_0x36d388(0x146))](_0x3ccbdc,_0x2b6d67,_0x216dcc,_0x37efc5,null,[salesforce_1[_0x36d388(0x15f)][_0x36d388(0x12a)]])[_0x36d388(0x125)]();}async function mergePermissionSets(_0x120ace,_0x415893){const _0x42f438=a103_0x4d8233,_0x361e9a=_0x415893['reduce']((_0x3fb667,_0x9ffb96)=>_0x3fb667[_0x42f438(0x150)](_0x9ffb96[_0x42f438(0x121)][_0x42f438(0x16e)],_0x9ffb96),new Map());for(const _0x14ba6d of _0x120ace){const _0x27147e=PERMISSION_SET_FOLDER_NAME+'/'+_0x14ba6d[_0x42f438(0x16e)],_0x365ba3=_0x361e9a[_0x42f438(0x13a)](_0x27147e);if(!_0x365ba3)continue;const _0x507a15=await zip_1[_0x42f438(0x178)][_0x42f438(0x15c)](_0x14ba6d['body']),_0x452ca2=await _0x507a15[_0x42f438(0x157)][_0x27147e][_0x42f438(0x13b)]('text'),_0xc14c7c=_0x365ba3[_0x42f438(0x157)][_0x27147e][_0x42f438(0x142)](),_0x26e15a=await(0x0,extract_component_permissions_1[_0x42f438(0x144)])(_0x452ca2,_0xc14c7c,_0x14ba6d[_0x42f438(0x128)]),_0x1f6f62=zip_1[_0x42f438(0x178)][_0x42f438(0x139)]();_0x1f6f62[_0x42f438(0x14a)](_0x27147e,_0x26e15a),_0x14ba6d[_0x42f438(0x116)]=await _0x1f6f62['generateAsync']({'type':_0x42f438(0x11b),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x3aaa71,_0x52304a,_0x131996){const _0x7df989=a103_0x4d8233;for(const _0x143be3 of _0x131996){if(_0x3aaa71[_0x7df989(0x16a)](_0x3e84ab=>_0x3e84ab!==_0x143be3[_0x7df989(0x128)]))continue;const _0x465c11=await zip_1[_0x7df989(0x178)][_0x7df989(0x15c)](_0x143be3[_0x7df989(0x116)]);for(const _0x42f153 in _0x465c11['files']){if(!_0x465c11['files'][_0x42f153][_0x7df989(0x14d)]){let _0x21125b=await _0x465c11[_0x7df989(0x157)][_0x42f153][_0x7df989(0x13b)](_0x7df989(0x152));for(const _0x4bc7eb of Object[_0x7df989(0x12e)](_0x52304a)){const _0x3008a1=new RegExp('%%'+_0x4bc7eb+'%%','g');_0x21125b=_0x21125b[_0x7df989(0x167)](_0x3008a1,_0x52304a[_0x4bc7eb]);}_0x465c11['file'](_0x42f153,_0x21125b);}}_0x143be3[_0x7df989(0x116)]=await _0x465c11[_0x7df989(0x133)]({'type':_0x7df989(0x11b),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x1b38e5,_0x3299d8){const _0x3e05c6=a103_0x4d8233,_0x13e54c=new mdapi_writer_1[(_0x3e05c6(0x14e))]({'components':_0x1b38e5,'sourceDir':path_1['default']['join'](process[_0x3e05c6(0x16d)](),_0x3e05c6(0x13c),_0x3299d8,DEPLOY_DIR_NAME,_0x3e05c6(0x14f)),'skipChildErrors':![]});await _0x13e54c['execute']();}function a103_0xd68c(){const _0x32c7b1=['/services/data/v','generateAndDeployZip','orgId','generateAsync','post','retrieveAttachments','Logger','default','Name','createZip','get','async','.temp','defineProperty','push','7LhOqnw','reduce','/sobjects/Attachment','toString','UTF-8','mergeComponentPermissions','2bkNBAR','PartialRetrieve','toBuffer','ParentId','DEFLATE','file','Component__r','substring','dir','MDApiWriter','src','set','../classes/logger','text','PermissionSet','DeclarativeFilterOptions','writeFile','map','files','join','values','ComponentsApi','(((.+)+)+)+$','unzip','then','types','MetadataType','Package','filter','uuid','apply','http://soap.sforce.com/2006/04/metadata','1540905GpnaxU','fetchAttachmentsDetailsById','replace','search','fetchComponentsDetailsByComponentsHistory','every','../../git/writers/mdapi.writer','constructor','cwd','fileName','Builder','name','buildObject','extractComponentPermissions','../utils/extract-component-permissions','FOLDER_TO_METADATA_TYPE_MAP','__esModule','fs/promises','find','Zip','splitZip','adm-zip','2248832zGcTNR','body','package.xml','../utils/components-api','exists','Profile','base64','type','BUILD','length','Body','../../git/internal/fs.internal','listMetadataItem','3624564ITKtgp','1231220WhurAb','path','execute','../../git/parsers/utils/zip','20033424FXgvBJ','fileType','permissionsets','PERMISSION_SET','7328424xPQbTf','MetadataConstants','428442RFqXUw','keys','1.0'];a103_0xd68c=function(){return _0x32c7b1;};return a103_0xd68c();}async function generateAndWritePackageXML(_0x4878ab,_0x3794bb,_0x3288f1,_0x58b6f2){const _0x9e1097=a103_0x4d8233,_0x563a77=getComponentsTypeAndName(_0x4878ab,_0x3794bb),_0x3904ff=[...new Set(_0x563a77[_0x9e1097(0x156)](_0x8dd6b1=>_0x8dd6b1[_0x9e1097(0x11c)]))],_0x3c67fa={'Package':{'$':{'xmlns':_0x9e1097(0x164)},'types':[],'version':''+_0x58b6f2}};for(const _0x14f620 of _0x3904ff){const _0x411293=_0x563a77[_0x9e1097(0x161)](_0xa1597f=>_0xa1597f[_0x9e1097(0x11c)]===_0x14f620)[_0x9e1097(0x156)](_0x24da46=>_0x24da46[_0x9e1097(0x170)]),_0xd956e9={'members':_0x411293,'name':_0x14f620};_0x3c67fa[_0x9e1097(0x160)][_0x9e1097(0x15e)][_0x9e1097(0x13e)](_0xd956e9);}const _0x3c6983=new xml2js_1[(_0x9e1097(0x16f))]({'xmldec':{'version':'1.0','encoding':'UTF-8'}}),_0x55d9b6=_0x3c6983[_0x9e1097(0x171)](_0x3c67fa);await fs_internal_1['FS'][_0x9e1097(0x155)](path_1['default']['join'](process[_0x9e1097(0x16d)](),_0x9e1097(0x13c),_0x3288f1,DEPLOY_DIR_NAME,_0x9e1097(0x14f),_0x9e1097(0x117)),_0x55d9b6);}function getComponentsTypeAndName(_0x1b7b9f,_0x4df098){const _0x472ffa=a103_0x4d8233;return _0x1b7b9f[_0x472ffa(0x140)]((_0x3f2aca,_0x2c461f)=>{const _0x5022b4=_0x472ffa,_0xab6669=_0x4df098[_0x5022b4(0x177)](_0x4c7269=>_0x4c7269['Id']===_0x2c461f[_0x5022b4(0x148)]);return _0xab6669&&_0x3f2aca[_0x5022b4(0x13e)]({'name':_0xab6669[_0x5022b4(0x14b)]['Component_Name__c'],'type':salesforce_1[_0x5022b4(0x12c)][_0x5022b4(0x174)][_0x2c461f[_0x5022b4(0x138)]]||_0x2c461f[_0x5022b4(0x138)]}),_0x3f2aca;},[]);}async function saveDestructiveChanges(_0x49abe7,_0x5aaad9,_0x459a58,_0x1f3b4d){const _0x404f99=a103_0x4d8233,_0x26e77b=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x49abe7,_0x5aaad9))['toString']();await fs_internal_1['FS'][_0x404f99(0x155)](path_1[_0x404f99(0x137)]['join'](process[_0x404f99(0x16d)](),_0x404f99(0x13c),_0x1f3b4d,DEPLOY_DIR_NAME,_0x404f99(0x14f),_0x459a58),_0x26e77b);}async function createDeployZip(_0x5950d3){const _0x4b4c0a=a103_0x4d8233,_0x1b7b52=new adm_zip_1['default']();return await _0x1b7b52['addLocalFolder'](path_1[_0x4b4c0a(0x137)][_0x4b4c0a(0x158)](process[_0x4b4c0a(0x16d)](),_0x4b4c0a(0x13c),_0x5950d3,DEPLOY_DIR_NAME)),_0x1b7b52;}async function insertZip(_0x1496e8,_0x7b4e71,_0x4f0c9e,_0x49159a,_0x176976,_0xfc00e2){const _0x169266=a103_0x4d8233,_0x139b9f={'ParentId':_0x7b4e71,'Name':'BUILD'+_0x4f0c9e,'Description':_0x169266(0x11d)+_0x49159a,'Body':_0x176976},{data:_0x170818}=await _0x1496e8[_0x169266(0x134)](_0x169266(0x130)+_0xfc00e2+_0x169266(0x141),_0x139b9f);return _0x170818['id'];}