const a85_0xc6f2ce=a85_0x42af;(function(_0x2197d7,_0x25b1cf){const _0xcff9b7=a85_0x42af,_0x3d41a9=_0x2197d7();while(!![]){try{const _0x2fc5d4=-parseInt(_0xcff9b7(0x196))/0x1+-parseInt(_0xcff9b7(0x1c2))/0x2*(-parseInt(_0xcff9b7(0x1a1))/0x3)+parseInt(_0xcff9b7(0x1c8))/0x4+parseInt(_0xcff9b7(0x1bb))/0x5*(-parseInt(_0xcff9b7(0x198))/0x6)+-parseInt(_0xcff9b7(0x1f4))/0x7+parseInt(_0xcff9b7(0x1a7))/0x8*(parseInt(_0xcff9b7(0x1b5))/0x9)+parseInt(_0xcff9b7(0x1c5))/0xa;if(_0x2fc5d4===_0x25b1cf)break;else _0x3d41a9['push'](_0x3d41a9['shift']());}catch(_0x5b1113){_0x3d41a9['push'](_0x3d41a9['shift']());}}}(a85_0x5576,0xd17f1));const a85_0x2b8380=(function(){let _0x2a6196=!![];return function(_0x375190,_0xde6345){const _0x23ae9a=_0x2a6196?function(){const _0x317271=a85_0x42af;if(_0xde6345){const _0x247182=_0xde6345[_0x317271(0x1d8)](_0x375190,arguments);return _0xde6345=null,_0x247182;}}:function(){};return _0x2a6196=![],_0x23ae9a;};}()),a85_0x623d4d=a85_0x2b8380(this,function(){const _0x150fc1=a85_0x42af;return a85_0x623d4d[_0x150fc1(0x1d3)]()[_0x150fc1(0x1e8)](_0x150fc1(0x1af))[_0x150fc1(0x1d3)]()[_0x150fc1(0x1c1)](a85_0x623d4d)[_0x150fc1(0x1e8)](_0x150fc1(0x1af));});a85_0x623d4d();'use strict';var __importDefault=this&&this[a85_0xc6f2ce(0x197)]||function(_0x34f2ac){return _0x34f2ac&&_0x34f2ac['__esModule']?_0x34f2ac:{'default':_0x34f2ac};};Object[a85_0xc6f2ce(0x1ba)](exports,a85_0xc6f2ce(0x19e),{'value':!![]}),exports[a85_0xc6f2ce(0x1c3)]=void 0x0;const constants_1=require(a85_0xc6f2ce(0x1c0)),path_1=__importDefault(require(a85_0xc6f2ce(0x1d6))),extract_component_permissions_1=require(a85_0xc6f2ce(0x1e4)),xml2js_1=require(a85_0xc6f2ce(0x1aa)),zip_1=require(a85_0xc6f2ce(0x1e6)),mdapi_1=require(a85_0xc6f2ce(0x1c7)),fs_internal_1=require(a85_0xc6f2ce(0x1a0)),promises_1=require(a85_0xc6f2ce(0x19b)),components_api_1=require(a85_0xc6f2ce(0x1ac)),adm_zip_1=__importDefault(require(a85_0xc6f2ce(0x1f0))),uuid_1=require(a85_0xc6f2ce(0x1d7)),fetch_attachments_1=require('../../shared/utils/fetch-attachments'),DESTRUCTIVE_CHANGES_PER_NAME=a85_0xc6f2ce(0x1d9),DESTRUCTIVE_CHANGES_POST_NAME=a85_0xc6f2ce(0x1b1),DEPLOY_DIR_NAME=a85_0xc6f2ce(0x19d);async function generateAndDeployZip({attachmentsId:_0x1a6f44,isExtractComponentsPermissions:_0x9afc09,preDestructiveAttachmentId:_0x2aaf23,postDestructiveAttachmentId:_0x27291a,branchId:_0x3fe409,credentials:_0x10b55f,metadataLogId:_0x641922,environments:_0x566515,metaTypes:_0x52a788},_0x5d6d60){const _0x569c4e=a85_0xc6f2ce,_0x359f92=(0x0,uuid_1['v4'])();try{const _0x23bc26=await(0x0,fetch_attachments_1[_0x569c4e(0x1b8)])(_0x5d6d60,_0x1a6f44),_0x259f9e=_0x23bc26['reduce']((_0x57ac82,_0x550b07)=>({..._0x57ac82,[_0x550b07['Id']]:_0x550b07[_0x569c4e(0x1ae)]}),{}),_0x3a295a=await getComponents(_0x23bc26,_0x5d6d60,_0x259f9e),_0x32f1c0=await components_api_1[_0x569c4e(0x1e1)][_0x569c4e(0x1a9)](_0x5d6d60,_0x23bc26[_0x569c4e(0x1c4)](({ParentId:_0x2e9b17})=>_0x2e9b17))['then'](_0x1aeb2e=>components_api_1[_0x569c4e(0x1e1)][_0x569c4e(0x1ce)](_0x1aeb2e));if(_0x9afc09){const _0xab10f1=_0x3a295a['filter'](({fileType:_0x3eca59})=>_0x3eca59==='Profile'||_0x3eca59===_0x569c4e(0x1c6));await removePermission(_0xab10f1,_0x32f1c0);}await replaceEnvironments(_0x52a788,_0x566515,_0x3a295a),await writeZip(_0x3a295a,_0x359f92),await generateAndWritePackageXML(_0x23bc26,_0x32f1c0,_0x359f92);_0x2aaf23&&await saveDestructiveChanges(_0x5d6d60,_0x2aaf23,DESTRUCTIVE_CHANGES_PER_NAME,_0x359f92);_0x27291a&&await saveDestructiveChanges(_0x5d6d60,_0x27291a,DESTRUCTIVE_CHANGES_POST_NAME,_0x359f92);const _0x1e1824=(await createDeployZip(_0x359f92)[_0x569c4e(0x1cc)](_0x43ebe3=>{return _0x43ebe3;}))[_0x569c4e(0x1ea)]()[_0x569c4e(0x1d3)](_0x569c4e(0x1e7));console['log'](_0x569c4e(0x1e0));const _0x4f26af=_0x1e1824[_0x569c4e(0x1be)];if(_0x4f26af>=components_api_1['MAX_ZIP_SIZE']){const _0x4172d9=await createDeployZip(_0x359f92);console[_0x569c4e(0x1e5)](_0x569c4e(0x1cb));const [_0xcbb695,_0x3c4aa7]=await components_api_1[_0x569c4e(0x1e1)][_0x569c4e(0x1d2)](_0x4172d9,_0x4f26af),_0x1a6acd=await insertZip(_0x5d6d60,_0x3fe409,_0x10b55f[_0x569c4e(0x1f1)],_0x641922,_0xcbb695['toBuffer']()[_0x569c4e(0x1d3)](_0x569c4e(0x1e7))),_0x1e4a8c=await insertZip(_0x5d6d60,_0x3fe409,_0x10b55f[_0x569c4e(0x1f1)],_0x641922,_0x3c4aa7[_0x569c4e(0x1ea)]()[_0x569c4e(0x1d3)](_0x569c4e(0x1e7)));return _0x1a6acd+','+_0x1e4a8c;}else return await insertZip(_0x5d6d60,_0x3fe409,_0x10b55f['orgId'],_0x641922,_0x1e1824);}catch(_0x232a82){throw _0x232a82;}finally{if(await fs_internal_1['FS'][_0x569c4e(0x1b9)](path_1[_0x569c4e(0x1da)][_0x569c4e(0x1ad)](process[_0x569c4e(0x1ed)](),_0x569c4e(0x19a),_0x359f92)))await(0x0,promises_1['rm'])(path_1[_0x569c4e(0x1da)][_0x569c4e(0x1ad)](process[_0x569c4e(0x1ed)](),_0x569c4e(0x19a),_0x359f92),{'recursive':!![]});}}exports[a85_0xc6f2ce(0x1c3)]=generateAndDeployZip;async function getComponents(_0x5daf8a,_0xad35f2,_0x42206f){const _0x4332cf=a85_0xc6f2ce,_0x4bc745=[],_0x1380a0=await(0x0,fetch_attachments_1[_0x4332cf(0x1b7)])(_0x5daf8a,_0xad35f2);return await getComponentFromZip(_0x1380a0,_0x42206f)[_0x4332cf(0x1cc)](_0x5663e5=>{const _0x226dd6=_0x4332cf;_0x4bc745[_0x226dd6(0x1f6)](..._0x5663e5);}),_0x4bc745;}async function getComponentFromZip(_0x4c8bd3,_0x39fc3b){const _0x48fc6f=a85_0xc6f2ce,_0x11e74b=[];for(const _0x98521b of _0x4c8bd3){const _0x413074=await zip_1['Zip'][_0x48fc6f(0x1df)](_0x98521b['values'][_0x48fc6f(0x1f8)]);for(const _0x5e68c8 in _0x413074[_0x48fc6f(0x1e9)]){!_0x413074['files'][_0x5e68c8][_0x48fc6f(0x1b0)]&&_0x11e74b[_0x48fc6f(0x1f6)]({'fileName':_0x5e68c8['substring'](_0x5e68c8[_0x48fc6f(0x1d5)]('/')+0x1),'fileType':_0x39fc3b[_0x98521b['id']],'body':_0x98521b[_0x48fc6f(0x1ca)]['Body']});}}return _0x11e74b;}async function removePermission(_0x47a3a0,_0x336dfa){const _0x37ed32=a85_0xc6f2ce;for(const _0x4477c9 of _0x47a3a0){const _0x586a8e=await zip_1[_0x37ed32(0x1ee)][_0x37ed32(0x1df)](_0x4477c9[_0x37ed32(0x1c9)]),_0x12a19f=[];for(const _0x25a2d2 in _0x586a8e[_0x37ed32(0x1e9)]){!_0x586a8e[_0x37ed32(0x1e9)][_0x25a2d2][_0x37ed32(0x1b0)]&&_0x12a19f[_0x37ed32(0x1f6)]({'fileName':_0x25a2d2,'body':await _0x586a8e[_0x37ed32(0x1e9)][_0x25a2d2][_0x37ed32(0x1de)]('text')});}const _0x1b89d5=await(0x0,extract_component_permissions_1[_0x37ed32(0x1e3)])(_0x12a19f[0x0][_0x37ed32(0x1c9)][_0x37ed32(0x1d3)](),_0x336dfa,_0x4477c9[_0x37ed32(0x1d1)]),_0x2e6f1b=new xml2js_1[(_0x37ed32(0x1eb))]({'xmldec':{'version':_0x37ed32(0x1bc),'encoding':_0x37ed32(0x1e2)}}),_0x15f11d=_0x2e6f1b[_0x37ed32(0x1f7)](_0x1b89d5),_0x39976b=zip_1[_0x37ed32(0x1ee)][_0x37ed32(0x1ef)]();_0x39976b['file'](_0x12a19f[0x0][_0x37ed32(0x1cd)],_0x15f11d),_0x4477c9[_0x37ed32(0x1c9)]=await _0x39976b[_0x37ed32(0x1a5)]({'type':_0x37ed32(0x1e7),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x418180,_0x3b9bcb,_0x4be301){const _0xe2432e=a85_0xc6f2ce;for(const _0x275d00 of _0x4be301){if(_0x418180[_0xe2432e(0x1a3)](_0x4a9589=>_0x4a9589!==_0x275d00['fileType']))continue;const _0x268781=await zip_1[_0xe2432e(0x1ee)][_0xe2432e(0x1df)](_0x275d00[_0xe2432e(0x1c9)]);for(const _0x349837 in _0x268781[_0xe2432e(0x1e9)]){if(!_0x268781['files'][_0x349837][_0xe2432e(0x1b0)]){let _0x33e5c9=await _0x268781[_0xe2432e(0x1e9)][_0x349837]['async'](_0xe2432e(0x1dc));for(const _0x467c2f of Object[_0xe2432e(0x1a4)](_0x3b9bcb)){const _0x385ddd=new RegExp('%%'+_0x467c2f+'%%','g');_0x33e5c9=_0x33e5c9[_0xe2432e(0x1b4)](_0x385ddd,_0x3b9bcb[_0x467c2f]);}_0x268781[_0xe2432e(0x1d0)](_0x349837,_0x33e5c9);}}_0x275d00['body']=await _0x268781[_0xe2432e(0x1a5)]({'type':_0xe2432e(0x1e7),'compression':_0xe2432e(0x1dd),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x28f14c,_0x233f03){const _0x5d33df=a85_0xc6f2ce,_0x1f311e=new mdapi_1[(_0x5d33df(0x1a8))]({'components':_0x28f14c,'sourceDir':path_1[_0x5d33df(0x1da)][_0x5d33df(0x1ad)](process[_0x5d33df(0x1ed)](),_0x5d33df(0x19a),_0x233f03,DEPLOY_DIR_NAME,_0x5d33df(0x19c)),'skipChildErrors':![]});await _0x1f311e[_0x5d33df(0x199)]();}async function generateAndWritePackageXML(_0x18f620,_0x592fa5,_0x10b7b4){const _0x1aaf36=a85_0xc6f2ce,_0x3445a6=getComponentsTypeAndName(_0x18f620,_0x592fa5),_0x23fc09=[...new Set(_0x3445a6[_0x1aaf36(0x1c4)](_0x3449e7=>_0x3449e7['type']))],_0x33cf4c={'Package':{'$':{'xmlns':_0x1aaf36(0x1b2)},'types':[],'version':''+constants_1['SALESFORCE_API_VERSION'][_0x1aaf36(0x1f5)](0x1)}};for(const _0xe0d90b of _0x23fc09){const _0x50c003=_0x3445a6[_0x1aaf36(0x1cf)](_0x38931c=>_0x38931c['type']===_0xe0d90b)['map'](_0xe91eda=>_0xe91eda[_0x1aaf36(0x1ec)]),_0x1dde84={'members':_0x50c003,'name':_0xe0d90b};_0x33cf4c[_0x1aaf36(0x1b6)][_0x1aaf36(0x1f2)][_0x1aaf36(0x1f6)](_0x1dde84);}const _0x5a8e2f=new xml2js_1['Builder']({'xmldec':{'version':_0x1aaf36(0x1bc),'encoding':_0x1aaf36(0x1e2)}}),_0x27103d=_0x5a8e2f['buildObject'](_0x33cf4c);await fs_internal_1['FS']['writeFile'](path_1['default']['join'](process[_0x1aaf36(0x1ed)](),_0x1aaf36(0x19a),_0x10b7b4,DEPLOY_DIR_NAME,_0x1aaf36(0x19c),_0x1aaf36(0x1bf)),_0x27103d);}function a85_0x42af(_0xcbd10f,_0x266191){const _0x510ae5=a85_0x5576();return a85_0x42af=function(_0x623d4d,_0x2b8380){_0x623d4d=_0x623d4d-0x196;let _0x557653=_0x510ae5[_0x623d4d];return _0x557653;},a85_0x42af(_0xcbd10f,_0x266191);}function a85_0x5576(){const _0xde2c7d=['filter','file','fileType','splitZip','toString','writeFile','indexOf','path','uuid','apply','destructiveChangesPre.xml','default','/services/data/','text','DEFLATE','async','unzip','after\x20create\x20zip','ComponentsApi','UTF-8','extractComponentPermissions','../utils/extract-component-permissions','log','../../git/parsers/utils/zip','base64','search','files','toBuffer','Builder','name','cwd','Zip','createZip','adm-zip','orgId','types','reduce','5790631GlTeZR','substring','push','buildObject','Body','591901abcoSY','__importDefault','78yqjRjQ','start','.temp','fs/promises','src','DEPLOYZIP','__esModule','BUILD','../../git/internal/fs.internal','1788cgJmPq','addLocalFolder','every','keys','generateAsync','/sobjects/Attachment','24JXIudB','MDApiWriter','fetchComponentsDetailsByComponentsHistory','xml2js','Component_Name__c','../utils/components-api','join','Name','(((.+)+)+)+$','dir','destructiveChangesPost.xml','http://soap.sforce.com/2006/04/metadata','ParentId','replace','3627909PDLzHA','Package','retrieveAttachments','fetchAttachmentsDetailsById','exists','defineProperty','549170XzwHva','1.0','Component__r','length','package.xml','../../../constants','constructor','5354tUIBYC','generateAndDeployZip','map','175480jmlDZH','PermissionSet','../../git/parsers/mdapi','3530920EKFBnh','body','values','after\x20create\x20second\x20zip','then','fileName','removeNamespacePrefix'];a85_0x5576=function(){return _0xde2c7d;};return a85_0x5576();}function getComponentsTypeAndName(_0x3e08e4,_0xbf7faf){const _0x55104c=a85_0xc6f2ce;return _0x3e08e4[_0x55104c(0x1f3)]((_0x853057,_0x42450f)=>{const _0x307c15=_0x55104c,_0x3f6bb4=_0xbf7faf['find'](_0x2d2026=>_0x2d2026['Id']===_0x42450f[_0x307c15(0x1b3)]);return _0x3f6bb4&&_0x853057[_0x307c15(0x1f6)]({'name':_0x3f6bb4[_0x307c15(0x1bd)][_0x307c15(0x1ab)],'type':_0x42450f[_0x307c15(0x1ae)]}),_0x853057;},[]);}async function saveDestructiveChanges(_0x505e7c,_0x1fad15,_0x9e243f,_0x107341){const _0x25f535=a85_0xc6f2ce,_0x5e2b19=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x505e7c,_0x1fad15))[_0x25f535(0x1d3)]();await fs_internal_1['FS'][_0x25f535(0x1d4)](path_1[_0x25f535(0x1da)][_0x25f535(0x1ad)](process[_0x25f535(0x1ed)](),_0x25f535(0x19a),_0x107341,DEPLOY_DIR_NAME,_0x25f535(0x19c),_0x9e243f),_0x5e2b19);}async function createDeployZip(_0x3306ec){const _0x428dac=a85_0xc6f2ce,_0x472c0f=new adm_zip_1[(_0x428dac(0x1da))]();return await _0x472c0f[_0x428dac(0x1a2)](path_1['default'][_0x428dac(0x1ad)](process[_0x428dac(0x1ed)](),_0x428dac(0x19a),_0x3306ec,DEPLOY_DIR_NAME)),_0x472c0f;}async function insertZip(_0x3c184a,_0x551e36,_0x34cb42,_0x35a5a3,_0x8f03ce){const _0x198775=a85_0xc6f2ce,_0x46ed32={'ParentId':_0x551e36,'Name':_0x198775(0x19f)+_0x34cb42,'Description':_0x198775(0x19f)+_0x35a5a3,'Body':_0x8f03ce},{data:_0x2cfd18}=await _0x3c184a['post'](_0x198775(0x1db)+constants_1['SALESFORCE_API_VERSION']+_0x198775(0x1a6),_0x46ed32);return _0x2cfd18['id'];}