const a85_0x191a8e=a85_0x1081;(function(_0x244339,_0x2575df){const _0x194a2e=a85_0x1081,_0x132c9a=_0x244339();while(!![]){try{const _0x58da4c=parseInt(_0x194a2e(0x1de))/0x1*(parseInt(_0x194a2e(0x1df))/0x2)+-parseInt(_0x194a2e(0x1fe))/0x3+parseInt(_0x194a2e(0x1ff))/0x4+-parseInt(_0x194a2e(0x1d3))/0x5+parseInt(_0x194a2e(0x1dd))/0x6*(-parseInt(_0x194a2e(0x1f4))/0x7)+parseInt(_0x194a2e(0x1ef))/0x8*(-parseInt(_0x194a2e(0x1e0))/0x9)+-parseInt(_0x194a2e(0x1bd))/0xa*(-parseInt(_0x194a2e(0x1d4))/0xb);if(_0x58da4c===_0x2575df)break;else _0x132c9a['push'](_0x132c9a['shift']());}catch(_0x285ffc){_0x132c9a['push'](_0x132c9a['shift']());}}}(a85_0x4d85,0x36b10));const a85_0x3c947e=(function(){let _0x5287c5=!![];return function(_0x2a66fd,_0x153ded){const _0x3ce716=_0x5287c5?function(){const _0x3b3e4f=a85_0x1081;if(_0x153ded){const _0x39c1c5=_0x153ded[_0x3b3e4f(0x1c6)](_0x2a66fd,arguments);return _0x153ded=null,_0x39c1c5;}}:function(){};return _0x5287c5=![],_0x3ce716;};}()),a85_0x21e7c8=a85_0x3c947e(this,function(){const _0x7d72e5=a85_0x1081;return a85_0x21e7c8['toString']()['search'](_0x7d72e5(0x1da))['toString']()[_0x7d72e5(0x1c3)](a85_0x21e7c8)[_0x7d72e5(0x1f3)](_0x7d72e5(0x1da));});a85_0x21e7c8();'use strict';function a85_0x1081(_0x1b82ae,_0x2e7b73){const _0x22ea9d=a85_0x4d85();return a85_0x1081=function(_0x21e7c8,_0x3c947e){_0x21e7c8=_0x21e7c8-0x1ad;let _0x4d851e=_0x22ea9d[_0x21e7c8];return _0x4d851e;},a85_0x1081(_0x1b82ae,_0x2e7b73);}var __importDefault=this&&this[a85_0x191a8e(0x1dc)]||function(_0x3cadc8){const _0x59e179=a85_0x191a8e;return _0x3cadc8&&_0x3cadc8[_0x59e179(0x1e2)]?_0x3cadc8:{'default':_0x3cadc8};};function a85_0x4d85(){const _0x505a5e=['Component__r','Package','types','retrieveAttachments','src','type','destructiveChangesPre.xml','../utils/extract-component-permissions','DEFLATE','start','unzip','buildObject','../utils/components-api','after\x20create\x20zip','336790Jxnzbi','fileName','file','UTF-8','cwd','PermissionSet','constructor','join','log','apply','async','../../shared/utils/fetch-attachments','1.0','path','find','filter','Body','SALESFORCE_API_VERSION','then','text','MDApiWriter','push','1319250wPSpfn','176SzMpJi','Profile','every','fetchAttachmentBody','dir','.temp','(((.+)+)+)+$','../../git/parsers/mdapi','__importDefault','1548duGXZn','5HCiPXi','1190lYTCJD','291978oLjgbd','writeFile','__esModule','indexOf','map','base64','ParentId','values','default','../../git/parsers/utils/zip','body','Name','Builder','exists','generateAsync','32DCYXug','files','Zip','xml2js','search','4095KYOxYW','substring','Component_Name__c','fileType','length','ComponentsApi','defineProperty','extractComponentPermissions','BUILD','/services/data/','450564DRmNKY','1507652EYdSHi','../../../constants','reduce','toString','splitZip','toBuffer','keys','generateAndDeployZip','addLocalFolder'];a85_0x4d85=function(){return _0x505a5e;};return a85_0x4d85();}Object[a85_0x191a8e(0x1fa)](exports,a85_0x191a8e(0x1e2),{'value':!![]}),exports[a85_0x191a8e(0x1ad)]=void 0x0;const constants_1=require(a85_0x191a8e(0x200)),path_1=__importDefault(require(a85_0x191a8e(0x1ca))),extract_component_permissions_1=require(a85_0x191a8e(0x1b6)),xml2js_1=require(a85_0x191a8e(0x1f2)),zip_1=require(a85_0x191a8e(0x1e9)),mdapi_1=require(a85_0x191a8e(0x1db)),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require('fs/promises'),components_api_1=require(a85_0x191a8e(0x1bb)),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require('uuid'),fetch_attachments_1=require(a85_0x191a8e(0x1c8)),DESTRUCTIVE_CHANGES_PER_NAME=a85_0x191a8e(0x1b5),DESTRUCTIVE_CHANGES_POST_NAME='destructiveChangesPost.xml',DEPLOY_DIR_NAME='DEPLOYZIP';async function generateAndDeployZip({attachmentsId:_0x51ac4f,isExtractComponentsPermissions:_0x344587,preDestructiveAttachmentId:_0x37fc3b,postDestructiveAttachmentId:_0x19a672,branchId:_0x3d1969,credentials:_0x1bf4fa,metadataLogId:_0xcec795,environments:_0x5af3c5,metaTypes:_0x4c9e33},_0x3574ca){const _0x2b0daa=a85_0x191a8e,_0x52a557=(0x0,uuid_1['v4'])();try{const _0x11a651=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x3574ca,_0x51ac4f),_0x37214b=_0x11a651[_0x2b0daa(0x201)]((_0x253b91,_0x2a79b5)=>({..._0x253b91,[_0x2a79b5['Id']]:_0x2a79b5[_0x2b0daa(0x1eb)]}),{}),_0x4ef665=await getComponents(_0x11a651,_0x3574ca,_0x37214b),_0x30fecf=await components_api_1[_0x2b0daa(0x1f9)]['fetchComponentsDetailsByComponentsHistory'](_0x3574ca,_0x11a651[_0x2b0daa(0x1e4)](({ParentId:_0x58ddf6})=>_0x58ddf6))['then'](_0x42ddc0=>components_api_1[_0x2b0daa(0x1f9)]['removeNamespacePrefix'](_0x42ddc0));if(_0x344587){const _0x419dc8=_0x4ef665[_0x2b0daa(0x1cc)](({fileType:_0x712dcc})=>_0x712dcc===_0x2b0daa(0x1d5)||_0x712dcc===_0x2b0daa(0x1c2));await removePermission(_0x419dc8,_0x30fecf);}await replaceEnvironments(_0x4c9e33,_0x5af3c5,_0x4ef665),await writeZip(_0x4ef665,_0x52a557),await generateAndWritePackageXML(_0x11a651,_0x30fecf,_0x52a557);_0x37fc3b&&await saveDestructiveChanges(_0x3574ca,_0x37fc3b,DESTRUCTIVE_CHANGES_PER_NAME,_0x52a557);_0x19a672&&await saveDestructiveChanges(_0x3574ca,_0x19a672,DESTRUCTIVE_CHANGES_POST_NAME,_0x52a557);const _0x51c5ae=(await createDeployZip(_0x52a557)[_0x2b0daa(0x1cf)](_0x404dda=>{return _0x404dda;}))[_0x2b0daa(0x204)]()[_0x2b0daa(0x202)](_0x2b0daa(0x1e5));console[_0x2b0daa(0x1c5)](_0x2b0daa(0x1bc));const _0x2af2f3=_0x51c5ae[_0x2b0daa(0x1f8)];if(_0x2af2f3>=components_api_1['MAX_ZIP_SIZE']){const _0x57cca4=await createDeployZip(_0x52a557);console[_0x2b0daa(0x1c5)]('after\x20create\x20second\x20zip');const [_0x4d339d,_0x1db3ea]=await components_api_1[_0x2b0daa(0x1f9)][_0x2b0daa(0x203)](_0x57cca4,_0x2af2f3),_0x37a50a=await insertZip(_0x3574ca,_0x3d1969,_0x1bf4fa['orgId'],_0xcec795,_0x4d339d['toBuffer']()[_0x2b0daa(0x202)]('base64')),_0x59667c=await insertZip(_0x3574ca,_0x3d1969,_0x1bf4fa['orgId'],_0xcec795,_0x1db3ea[_0x2b0daa(0x204)]()['toString'](_0x2b0daa(0x1e5)));return _0x37a50a+','+_0x59667c;}else return await insertZip(_0x3574ca,_0x3d1969,_0x1bf4fa['orgId'],_0xcec795,_0x51c5ae);}catch(_0xcc9f9c){throw _0xcc9f9c;}finally{if(await fs_internal_1['FS'][_0x2b0daa(0x1ed)](path_1[_0x2b0daa(0x1e8)][_0x2b0daa(0x1c4)](process[_0x2b0daa(0x1c1)](),_0x2b0daa(0x1d9),_0x52a557)))await(0x0,promises_1['rm'])(path_1[_0x2b0daa(0x1e8)][_0x2b0daa(0x1c4)](process['cwd'](),_0x2b0daa(0x1d9),_0x52a557),{'recursive':!![]});}}exports[a85_0x191a8e(0x1ad)]=generateAndDeployZip;async function getComponents(_0x3d33f4,_0x45b332,_0x3f20f8){const _0x4eef01=a85_0x191a8e,_0x148feb=[],_0x38a31f=await(0x0,fetch_attachments_1[_0x4eef01(0x1b2)])(_0x3d33f4,_0x45b332);return await getComponentFromZip(_0x38a31f,_0x3f20f8)['then'](_0x208741=>{const _0x16c14e=_0x4eef01;_0x148feb[_0x16c14e(0x1d2)](..._0x208741);}),_0x148feb;}async function getComponentFromZip(_0x1794ca,_0x1d40b4){const _0x44c003=a85_0x191a8e,_0x2f822e=[];for(const _0x6e90c9 of _0x1794ca){const _0x42b90c=await zip_1[_0x44c003(0x1f1)][_0x44c003(0x1b9)](_0x6e90c9[_0x44c003(0x1e7)][_0x44c003(0x1cd)]);for(const _0x5e8633 in _0x42b90c[_0x44c003(0x1f0)]){!_0x42b90c['files'][_0x5e8633][_0x44c003(0x1d8)]&&_0x2f822e[_0x44c003(0x1d2)]({'fileName':_0x5e8633['substring'](_0x5e8633[_0x44c003(0x1e3)]('/')+0x1),'fileType':_0x1d40b4[_0x6e90c9['id']],'body':_0x6e90c9[_0x44c003(0x1e7)][_0x44c003(0x1cd)]});}}return _0x2f822e;}async function removePermission(_0x20fd4d,_0x4b6189){const _0x16a719=a85_0x191a8e;for(const _0x3bc80d of _0x20fd4d){const _0x3f7506=await zip_1[_0x16a719(0x1f1)][_0x16a719(0x1b9)](_0x3bc80d[_0x16a719(0x1ea)]),_0x2b471f=[];for(const _0x3dc2e8 in _0x3f7506['files']){!_0x3f7506[_0x16a719(0x1f0)][_0x3dc2e8][_0x16a719(0x1d8)]&&_0x2b471f['push']({'fileName':_0x3dc2e8,'body':await _0x3f7506['files'][_0x3dc2e8][_0x16a719(0x1c7)](_0x16a719(0x1d0))});}const _0x5c443d=await(0x0,extract_component_permissions_1[_0x16a719(0x1fb)])(_0x2b471f[0x0]['body']['toString'](),_0x4b6189,_0x3bc80d[_0x16a719(0x1f7)]),_0x260171=new xml2js_1[(_0x16a719(0x1ec))]({'xmldec':{'version':_0x16a719(0x1c9),'encoding':'UTF-8'}}),_0x53fb22=_0x260171[_0x16a719(0x1ba)](_0x5c443d),_0x1c3f2c=zip_1[_0x16a719(0x1f1)]['createZip']();_0x1c3f2c['file'](_0x2b471f[0x0][_0x16a719(0x1be)],_0x53fb22),_0x3bc80d[_0x16a719(0x1ea)]=await _0x1c3f2c[_0x16a719(0x1ee)]({'type':_0x16a719(0x1e5),'compression':_0x16a719(0x1b7),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0xaee98c,_0x460d78,_0x546573){const _0x49d80f=a85_0x191a8e;for(const _0x48b932 of _0x546573){if(_0xaee98c[_0x49d80f(0x1d6)](_0x57ced8=>_0x57ced8!==_0x48b932['fileType']))continue;const _0x27a408=await zip_1['Zip']['unzip'](_0x48b932[_0x49d80f(0x1ea)]);for(const _0x1ba40f in _0x27a408[_0x49d80f(0x1f0)]){if(!_0x27a408[_0x49d80f(0x1f0)][_0x1ba40f]['dir']){let _0x25f9c1=await _0x27a408['files'][_0x1ba40f][_0x49d80f(0x1c7)](_0x49d80f(0x1d0));for(const _0x54dd58 of Object[_0x49d80f(0x205)](_0x460d78)){const _0x2d2430=new RegExp('%%'+_0x54dd58+'%%','g');_0x25f9c1=_0x25f9c1['replace'](_0x2d2430,_0x460d78[_0x54dd58]);}_0x27a408[_0x49d80f(0x1bf)](_0x1ba40f,_0x25f9c1);}}_0x48b932[_0x49d80f(0x1ea)]=await _0x27a408[_0x49d80f(0x1ee)]({'type':_0x49d80f(0x1e5),'compression':_0x49d80f(0x1b7),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x41ebe2,_0x489e4a){const _0x431b31=a85_0x191a8e,_0x2e5004=new mdapi_1[(_0x431b31(0x1d1))]({'components':_0x41ebe2,'sourceDir':path_1[_0x431b31(0x1e8)]['join'](process[_0x431b31(0x1c1)](),_0x431b31(0x1d9),_0x489e4a,DEPLOY_DIR_NAME,_0x431b31(0x1b3)),'skipChildErrors':![]});await _0x2e5004[_0x431b31(0x1b8)]();}async function generateAndWritePackageXML(_0x472cb6,_0x4eca13,_0x2851ef){const _0x363da1=a85_0x191a8e,_0x2dfe28=getComponentsTypeAndName(_0x472cb6,_0x4eca13),_0x2bb09c=[...new Set(_0x2dfe28[_0x363da1(0x1e4)](_0x702345=>_0x702345['type']))],_0xba1ff4={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+constants_1[_0x363da1(0x1ce)][_0x363da1(0x1f5)](0x1)}};for(const _0x8300e6 of _0x2bb09c){const _0x46022f=_0x2dfe28[_0x363da1(0x1cc)](_0x2cd757=>_0x2cd757[_0x363da1(0x1b4)]===_0x8300e6)[_0x363da1(0x1e4)](_0x1cd491=>_0x1cd491['name']),_0x35e546={'members':_0x46022f,'name':_0x8300e6};_0xba1ff4[_0x363da1(0x1b0)][_0x363da1(0x1b1)]['push'](_0x35e546);}const _0x28bfba=new xml2js_1[(_0x363da1(0x1ec))]({'xmldec':{'version':_0x363da1(0x1c9),'encoding':_0x363da1(0x1c0)}}),_0x380e06=_0x28bfba[_0x363da1(0x1ba)](_0xba1ff4);await fs_internal_1['FS'][_0x363da1(0x1e1)](path_1['default'][_0x363da1(0x1c4)](process[_0x363da1(0x1c1)](),_0x363da1(0x1d9),_0x2851ef,DEPLOY_DIR_NAME,_0x363da1(0x1b3),'package.xml'),_0x380e06);}function getComponentsTypeAndName(_0x24689c,_0x3cbdca){return _0x24689c['reduce']((_0x36777a,_0x2ebc53)=>{const _0x3dccb5=a85_0x1081,_0x478116=_0x3cbdca[_0x3dccb5(0x1cb)](_0x50d8df=>_0x50d8df['Id']===_0x2ebc53[_0x3dccb5(0x1e6)]);return _0x478116&&_0x36777a[_0x3dccb5(0x1d2)]({'name':_0x478116[_0x3dccb5(0x1af)][_0x3dccb5(0x1f6)],'type':_0x2ebc53[_0x3dccb5(0x1eb)]}),_0x36777a;},[]);}async function saveDestructiveChanges(_0xefa395,_0xb40eb4,_0xeb022f,_0x4c4562){const _0x502298=a85_0x191a8e,_0x52ff27=(await(0x0,fetch_attachments_1[_0x502298(0x1d7)])(_0xefa395,_0xb40eb4))[_0x502298(0x202)]();await fs_internal_1['FS'][_0x502298(0x1e1)](path_1[_0x502298(0x1e8)][_0x502298(0x1c4)](process[_0x502298(0x1c1)](),_0x502298(0x1d9),_0x4c4562,DEPLOY_DIR_NAME,_0x502298(0x1b3),_0xeb022f),_0x52ff27);}async function createDeployZip(_0x588b39){const _0x3f25b0=a85_0x191a8e,_0x569724=new adm_zip_1[(_0x3f25b0(0x1e8))]();return await _0x569724[_0x3f25b0(0x1ae)](path_1[_0x3f25b0(0x1e8)]['join'](process['cwd'](),_0x3f25b0(0x1d9),_0x588b39,DEPLOY_DIR_NAME)),_0x569724;}async function insertZip(_0x326c1e,_0x543ffd,_0x145fae,_0x34596c,_0x386b56){const _0x4b7f99=a85_0x191a8e,_0x3b9adc={'ParentId':_0x543ffd,'Name':'BUILD'+_0x145fae,'Description':_0x4b7f99(0x1fc)+_0x34596c,'Body':_0x386b56},{data:_0x3eac9d}=await _0x326c1e['post'](_0x4b7f99(0x1fd)+constants_1[_0x4b7f99(0x1ce)]+'/sobjects/Attachment',_0x3b9adc);return _0x3eac9d['id'];}