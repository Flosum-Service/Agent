const a105_0x226ad8=a105_0x5be6;(function(_0x275660,_0x4707ce){const _0x9ca981=a105_0x5be6,_0x4e0543=_0x275660();while(!![]){try{const _0x3edcc4=parseInt(_0x9ca981(0x202))/0x1+parseInt(_0x9ca981(0x1d4))/0x2+-parseInt(_0x9ca981(0x1de))/0x3+-parseInt(_0x9ca981(0x1f1))/0x4+parseInt(_0x9ca981(0x1d9))/0x5+parseInt(_0x9ca981(0x1c7))/0x6+-parseInt(_0x9ca981(0x1d3))/0x7*(parseInt(_0x9ca981(0x1db))/0x8);if(_0x3edcc4===_0x4707ce)break;else _0x4e0543['push'](_0x4e0543['shift']());}catch(_0x1742fd){_0x4e0543['push'](_0x4e0543['shift']());}}}(a105_0x4b75,0x43328));const a105_0x5e2815=(function(){let _0x23bd7d=!![];return function(_0x181c9c,_0x5771a3){const _0x35f3de=_0x23bd7d?function(){const _0x369813=a105_0x5be6;if(_0x5771a3){const _0x45a41a=_0x5771a3[_0x369813(0x1e8)](_0x181c9c,arguments);return _0x5771a3=null,_0x45a41a;}}:function(){};return _0x23bd7d=![],_0x35f3de;};}()),a105_0x38a7fd=a105_0x5e2815(this,function(){const _0x5705e3=a105_0x5be6;return a105_0x38a7fd[_0x5705e3(0x1fd)]()[_0x5705e3(0x1b1)]('(((.+)+)+)+$')[_0x5705e3(0x1fd)]()['constructor'](a105_0x38a7fd)[_0x5705e3(0x1b1)](_0x5705e3(0x1fc));});function a105_0x5be6(_0x49456d,_0x44b0f6){const _0xda30c6=a105_0x4b75();return a105_0x5be6=function(_0x38a7fd,_0x5e2815){_0x38a7fd=_0x38a7fd-0x1b0;let _0x4b75db=_0xda30c6[_0x38a7fd];return _0x4b75db;},a105_0x5be6(_0x49456d,_0x44b0f6);}a105_0x38a7fd();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x4e5561){const _0x374e72=a105_0x5be6;return _0x4e5561&&_0x4e5561[_0x374e72(0x1f7)]?_0x4e5561:{'default':_0x4e5561};};Object[a105_0x226ad8(0x1b2)](exports,a105_0x226ad8(0x1f7),{'value':!![]}),exports[a105_0x226ad8(0x20a)]=void 0x0;function a105_0x4b75(){const _0x3aa9df=['fetchComponentsDetailsByComponentsHistory','permissionsets','filter','type','Zip','get','51552VwowzC','ComponentsApi','xml2js','extractComponentPermissions','adm-zip','length','name','replace','1.0','createZip','files','base64','175rsqajE','761460tMPFUs','join','Name','components','generateAsync','1259055hgBsJL','dir','77816LblLWB','Body','fs/promises','912696fdWnpL','fetchAttachmentBody','../../git/writers/mdapi.writer','Component_Name__c','MetadataConstants','DEFLATE','Builder','substring','every','@flosum/salesforce','apply','../utils/extract-component-permissions','fileType','MetadataType','destructiveChangesPost.xml','splitZip','text','addLocalFolder','destructiveChangesPre.xml','66244FsHwqt','../utils/components-api','package.xml','PermissionSet','listMetadataItem','FOLDER_TO_METADATA_TYPE_MAP','__esModule','DeclarativeFilterOptions','post','toBuffer','../../git/internal/fs.internal','(((.+)+)+)+$','toString','fetchAttachmentsDetailsById','../../shared/utils/fetch-attachments','then','types','198075dTwJwQ','DEPLOYZIP','uuid','file','values','.temp','reduce','Logger','generateAndDeployZip','PartialRetrieve','orgId','default','fileName','/services/data/v','unzip','PERMISSION_SET','search','defineProperty','async','map','buildObject','body','exists','push','BUILD','MDApiWriter','writeFile','retrieveAttachments','cwd','keys','ParentId','UTF-8'];a105_0x4b75=function(){return _0x3aa9df;};return a105_0x4b75();}const path_1=__importDefault(require('path')),extract_component_permissions_1=require(a105_0x226ad8(0x1e9)),logger_1=require('../classes/logger'),xml2js_1=require(a105_0x226ad8(0x1c9)),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require(a105_0x226ad8(0x1e0)),fs_internal_1=require(a105_0x226ad8(0x1fb)),promises_1=require(a105_0x226ad8(0x1dd)),components_api_1=require(a105_0x226ad8(0x1f2)),adm_zip_1=__importDefault(require(a105_0x226ad8(0x1cb))),uuid_1=require(a105_0x226ad8(0x204)),fetch_attachments_1=require(a105_0x226ad8(0x1ff)),salesforce_1=require(a105_0x226ad8(0x1e7)),DESTRUCTIVE_CHANGES_PER_NAME=a105_0x226ad8(0x1f0),DESTRUCTIVE_CHANGES_POST_NAME=a105_0x226ad8(0x1ec),DEPLOY_DIR_NAME=a105_0x226ad8(0x203),PERMISSION_SET_FOLDER_NAME=a105_0x226ad8(0x1c2);async function generateAndDeployZip({attachmentsId:_0xfb602e,isExtractComponentsPermissionSets:_0x3f1002,isExtractComponentsProfiles:_0x5a969b,preDestructiveAttachmentId:_0x2ee689,postDestructiveAttachmentId:_0x2062bb,branchId:_0x119dbd,credentials:_0x222888,metadataLogId:_0x5dcbcc,environments:_0x531ac0,metaTypes:_0xc92027,apiVersion:_0x4d83ef},_0x25525f,_0x3bbeae){const _0x5cb91c=a105_0x226ad8;var _0x4b93b2;const _0x9b471a=(0x0,uuid_1['v4'])();try{const _0x41adaf=await(0x0,fetch_attachments_1[_0x5cb91c(0x1fe)])(_0x25525f,_0xfb602e),_0x2a962f=_0x41adaf[_0x5cb91c(0x208)]((_0x49826b,_0x28a428)=>({..._0x49826b,[_0x28a428['Id']]:_0x28a428['Name']}),{}),_0x6f7b4d=await getComponents(_0x41adaf,_0x25525f,_0x2a962f),_0x2cc555=await components_api_1[_0x5cb91c(0x1c8)][_0x5cb91c(0x1c1)](_0x25525f,_0x41adaf[_0x5cb91c(0x1b4)](({ParentId:_0x4448a6})=>_0x4448a6),_0x4d83ef)['then'](_0x30fe49=>components_api_1[_0x5cb91c(0x1c8)]['removeNamespacePrefix'](_0x30fe49));if(_0x5a969b){const _0x4c7ac1=_0x6f7b4d[_0x5cb91c(0x1c3)](({fileType:_0x196747})=>_0x196747==='Profile');await removePermission(_0x4c7ac1,_0x2cc555);}const _0x244cca=_0x6f7b4d[_0x5cb91c(0x1c3)](({fileType:_0x1286f9})=>_0x1286f9===_0x5cb91c(0x1f4));if(_0x244cca[_0x5cb91c(0x1cc)]&&_0x3f1002){await removePermission(_0x244cca,_0x2cc555);const {items:_0x4bfcaf}=await retrieveTargetPermissionSets(_0x244cca,_0x4d83ef,_0x3bbeae);await mergePermissionSets(_0x244cca,((_0x4b93b2=_0x4bfcaf[_0x5cb91c(0x1f4)])===null||_0x4b93b2===void 0x0?void 0x0:_0x4b93b2[_0x5cb91c(0x1d7)])||[]);}await replaceEnvironments(_0xc92027,_0x531ac0,_0x6f7b4d),await writeZip(_0x6f7b4d,_0x9b471a),await generateAndWritePackageXML(_0x41adaf,_0x2cc555,_0x9b471a,_0x4d83ef);_0x2ee689&&await saveDestructiveChanges(_0x25525f,_0x2ee689,DESTRUCTIVE_CHANGES_PER_NAME,_0x9b471a);_0x2062bb&&await saveDestructiveChanges(_0x25525f,_0x2062bb,DESTRUCTIVE_CHANGES_POST_NAME,_0x9b471a);const _0x16bc6d=(await createDeployZip(_0x9b471a)['then'](_0x2fd7ec=>{return _0x2fd7ec;}))[_0x5cb91c(0x1fa)]()[_0x5cb91c(0x1fd)](_0x5cb91c(0x1d2)),_0x38bb5e=_0x16bc6d[_0x5cb91c(0x1cc)];if(_0x38bb5e>=components_api_1['MAX_ZIP_SIZE']){const _0x2a3116=await createDeployZip(_0x9b471a),[_0x51ef55,_0x419d27]=await components_api_1[_0x5cb91c(0x1c8)][_0x5cb91c(0x1ed)](_0x2a3116,_0x38bb5e),_0x39db47=await insertZip(_0x25525f,_0x119dbd,_0x222888['orgId'],_0x5dcbcc,_0x51ef55['toBuffer']()['toString']('base64'),_0x4d83ef),_0x3b5622=await insertZip(_0x25525f,_0x119dbd,_0x222888[_0x5cb91c(0x20c)],_0x5dcbcc,_0x419d27[_0x5cb91c(0x1fa)]()[_0x5cb91c(0x1fd)](_0x5cb91c(0x1d2)),_0x4d83ef);return _0x39db47+','+_0x3b5622;}else return await insertZip(_0x25525f,_0x119dbd,_0x222888['orgId'],_0x5dcbcc,_0x16bc6d,_0x4d83ef);}catch(_0x3d11a6){throw _0x3d11a6;}finally{if(await fs_internal_1['FS'][_0x5cb91c(0x1b7)](path_1[_0x5cb91c(0x20d)][_0x5cb91c(0x1d5)](process['cwd'](),_0x5cb91c(0x207),_0x9b471a)))await(0x0,promises_1['rm'])(path_1[_0x5cb91c(0x20d)]['join'](process[_0x5cb91c(0x1bd)](),_0x5cb91c(0x207),_0x9b471a),{'recursive':!![]});}}exports[a105_0x226ad8(0x20a)]=generateAndDeployZip;async function getComponents(_0x3f8b4e,_0x28ce01,_0x11a4b8){const _0x2eca8c=a105_0x226ad8,_0xc336a5=[],_0x4d380e=await(0x0,fetch_attachments_1[_0x2eca8c(0x1bc)])(_0x3f8b4e,_0x28ce01);return await getComponentFromZip(_0x4d380e,_0x11a4b8)[_0x2eca8c(0x200)](_0xbae4be=>{const _0x21c78b=_0x2eca8c;_0xc336a5[_0x21c78b(0x1b8)](..._0xbae4be);}),_0xc336a5;}async function getComponentFromZip(_0x172e7e,_0x5ce747){const _0xaec6af=a105_0x226ad8,_0x5ed6b2=[];for(const _0x28722c of _0x172e7e){const _0x30a02e=await zip_1[_0xaec6af(0x1c5)][_0xaec6af(0x210)](_0x28722c[_0xaec6af(0x206)][_0xaec6af(0x1dc)]);for(const _0x5ca40b in _0x30a02e[_0xaec6af(0x1d1)]){!_0x30a02e['files'][_0x5ca40b][_0xaec6af(0x1da)]&&_0x5ed6b2['push']({'fileName':_0x5ca40b[_0xaec6af(0x1e5)](_0x5ca40b['indexOf']('/')+0x1),'fileType':_0x5ce747[_0x28722c['id']],'body':_0x28722c[_0xaec6af(0x206)][_0xaec6af(0x1dc)]});}}return _0x5ed6b2;}async function removePermission(_0x431bd6,_0x44ceaa){const _0x23c8d7=a105_0x226ad8;for(const _0x2a3a81 of _0x431bd6){const _0x400c83=await zip_1[_0x23c8d7(0x1c5)]['unzip'](_0x2a3a81['body']),_0x476e59=[];for(const _0x55c47c in _0x400c83['files']){!_0x400c83[_0x23c8d7(0x1d1)][_0x55c47c][_0x23c8d7(0x1da)]&&_0x476e59[_0x23c8d7(0x1b8)]({'fileName':_0x55c47c,'body':await _0x400c83['files'][_0x55c47c][_0x23c8d7(0x1b3)](_0x23c8d7(0x1ee))});}const _0x18192d=await(0x0,extract_component_permissions_1[_0x23c8d7(0x1ca)])(_0x476e59[0x0][_0x23c8d7(0x1b6)]['toString'](),_0x44ceaa,_0x2a3a81['fileType']),_0x46e317=new xml2js_1[(_0x23c8d7(0x1e4))]({'xmldec':{'version':_0x23c8d7(0x1cf),'encoding':'UTF-8'}}),_0x52acf2=_0x46e317[_0x23c8d7(0x1b5)](_0x18192d),_0x401dfb=zip_1[_0x23c8d7(0x1c5)][_0x23c8d7(0x1d0)]();_0x401dfb['file'](_0x476e59[0x0][_0x23c8d7(0x20e)],_0x52acf2),_0x2a3a81[_0x23c8d7(0x1b6)]=await _0x401dfb[_0x23c8d7(0x1d8)]({'type':_0x23c8d7(0x1d2),'compression':_0x23c8d7(0x1e3),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x1467c0,_0x5b7ff6,_0x5013ba){const _0x421d94=a105_0x226ad8,_0xd13ee7=_0x1467c0['map'](_0x3b0161=>PERMISSION_SET_FOLDER_NAME+'/'+_0x3b0161[_0x421d94(0x20e)])['join'](';'),_0x336aae=[{'field':_0x421d94(0x20e),'option':salesforce_1[_0x421d94(0x1f8)]['IN'],'value':_0xd13ee7}],_0x39fb0a=new logger_1[(_0x421d94(0x209))]();return new salesforce_1[(_0x421d94(0x20b))](_0x5b7ff6,_0x5013ba,_0x39fb0a,_0x336aae,null,[salesforce_1[_0x421d94(0x1eb)][_0x421d94(0x1b0)]])['execute']();}async function mergePermissionSets(_0x4599b3,_0xc1907f){const _0x2a696e=a105_0x226ad8,_0x410068=_0xc1907f['reduce']((_0x4d62e4,_0x12a81a)=>_0x4d62e4['set'](_0x12a81a[_0x2a696e(0x1f5)]['fileName'],_0x12a81a),new Map());for(const _0x523a6c of _0x4599b3){const _0x499293=PERMISSION_SET_FOLDER_NAME+'/'+_0x523a6c[_0x2a696e(0x20e)],_0x45290a=_0x410068[_0x2a696e(0x1c6)](_0x499293);if(!_0x45290a)continue;const _0x1276a2=await zip_1[_0x2a696e(0x1c5)][_0x2a696e(0x210)](_0x523a6c[_0x2a696e(0x1b6)]),_0x5e3e76=await _0x1276a2[_0x2a696e(0x1d1)][_0x499293][_0x2a696e(0x1b3)]('text'),_0x553441=_0x45290a[_0x2a696e(0x1d1)][_0x499293][_0x2a696e(0x1fd)](),_0x5c081e=await(0x0,extract_component_permissions_1['mergeComponentPermissions'])(_0x5e3e76,_0x553441,_0x523a6c[_0x2a696e(0x1ea)]),_0x352ced=zip_1[_0x2a696e(0x1c5)][_0x2a696e(0x1d0)]();_0x352ced[_0x2a696e(0x205)](_0x499293,_0x5c081e),_0x523a6c[_0x2a696e(0x1b6)]=await _0x352ced[_0x2a696e(0x1d8)]({'type':_0x2a696e(0x1d2),'compression':_0x2a696e(0x1e3),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x90e770,_0x3d1616,_0x502a2e){const _0x17a4bc=a105_0x226ad8;for(const _0x31cf14 of _0x502a2e){if(_0x90e770[_0x17a4bc(0x1e6)](_0x32371a=>_0x32371a!==_0x31cf14[_0x17a4bc(0x1ea)]))continue;const _0xf540e5=await zip_1[_0x17a4bc(0x1c5)][_0x17a4bc(0x210)](_0x31cf14[_0x17a4bc(0x1b6)]);for(const _0x208127 in _0xf540e5[_0x17a4bc(0x1d1)]){if(!_0xf540e5[_0x17a4bc(0x1d1)][_0x208127][_0x17a4bc(0x1da)]){let _0x5b91cc=await _0xf540e5[_0x17a4bc(0x1d1)][_0x208127]['async'](_0x17a4bc(0x1ee));for(const _0x535003 of Object[_0x17a4bc(0x1be)](_0x3d1616)){const _0x25d132=new RegExp('%%'+_0x535003+'%%','g');_0x5b91cc=_0x5b91cc[_0x17a4bc(0x1ce)](_0x25d132,_0x3d1616[_0x535003]);}_0xf540e5[_0x17a4bc(0x205)](_0x208127,_0x5b91cc);}}_0x31cf14[_0x17a4bc(0x1b6)]=await _0xf540e5[_0x17a4bc(0x1d8)]({'type':_0x17a4bc(0x1d2),'compression':_0x17a4bc(0x1e3),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x512be0,_0x2829ee){const _0x2082cc=a105_0x226ad8,_0x47f0c4=new mdapi_writer_1[(_0x2082cc(0x1ba))]({'components':_0x512be0,'sourceDir':path_1[_0x2082cc(0x20d)][_0x2082cc(0x1d5)](process['cwd'](),_0x2082cc(0x207),_0x2829ee,DEPLOY_DIR_NAME),'skipChildErrors':![]});await _0x47f0c4['execute']();}async function generateAndWritePackageXML(_0x18913f,_0xb37cdc,_0x482457,_0x523322){const _0x12982f=a105_0x226ad8,_0x564921=getComponentsTypeAndName(_0x18913f,_0xb37cdc),_0x2947f2=[...new Set(_0x564921[_0x12982f(0x1b4)](_0x20046d=>_0x20046d[_0x12982f(0x1c4)]))],_0x1c0a36={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x523322}};for(const _0x2d8d57 of _0x2947f2){const _0x5b9ef5=_0x564921['filter'](_0x31d4eb=>_0x31d4eb[_0x12982f(0x1c4)]===_0x2d8d57)[_0x12982f(0x1b4)](_0x1c4a74=>_0x1c4a74[_0x12982f(0x1cd)]),_0x6fb94d={'members':_0x5b9ef5,'name':_0x2d8d57};_0x1c0a36['Package'][_0x12982f(0x201)]['push'](_0x6fb94d);}const _0x281b7c=new xml2js_1[(_0x12982f(0x1e4))]({'xmldec':{'version':_0x12982f(0x1cf),'encoding':_0x12982f(0x1c0)}}),_0xdbe1eb=_0x281b7c['buildObject'](_0x1c0a36);await fs_internal_1['FS'][_0x12982f(0x1bb)](path_1['default']['join'](process['cwd'](),_0x12982f(0x207),_0x482457,DEPLOY_DIR_NAME,_0x12982f(0x1f3)),_0xdbe1eb);}function getComponentsTypeAndName(_0x25b0e9,_0x1b5eb8){const _0x504c29=a105_0x226ad8;return _0x25b0e9[_0x504c29(0x208)]((_0x1f1591,_0x3cd670)=>{const _0x57f6b4=_0x504c29,_0x5447bc=_0x1b5eb8['find'](_0x551823=>_0x551823['Id']===_0x3cd670[_0x57f6b4(0x1bf)]);return _0x5447bc&&_0x1f1591[_0x57f6b4(0x1b8)]({'name':_0x5447bc['Component__r'][_0x57f6b4(0x1e1)],'type':salesforce_1[_0x57f6b4(0x1e2)][_0x57f6b4(0x1f6)][_0x3cd670['Name']]||_0x3cd670[_0x57f6b4(0x1d6)]}),_0x1f1591;},[]);}async function saveDestructiveChanges(_0x5ad4c5,_0x16b8e0,_0x2b700e,_0xaed550){const _0x16519f=a105_0x226ad8,_0x165cc6=(await(0x0,fetch_attachments_1[_0x16519f(0x1df)])(_0x5ad4c5,_0x16b8e0))[_0x16519f(0x1fd)]();await fs_internal_1['FS'][_0x16519f(0x1bb)](path_1[_0x16519f(0x20d)][_0x16519f(0x1d5)](process[_0x16519f(0x1bd)](),_0x16519f(0x207),_0xaed550,DEPLOY_DIR_NAME,_0x2b700e),_0x165cc6);}async function createDeployZip(_0x5354cd){const _0x1f84d4=a105_0x226ad8,_0x551fbc=new adm_zip_1[(_0x1f84d4(0x20d))]();return await _0x551fbc[_0x1f84d4(0x1ef)](path_1[_0x1f84d4(0x20d)][_0x1f84d4(0x1d5)](process['cwd'](),_0x1f84d4(0x207),_0x5354cd,DEPLOY_DIR_NAME)),_0x551fbc;}async function insertZip(_0x3a6b0e,_0xc84663,_0x237f51,_0x58d503,_0x2f6b84,_0x36a86f){const _0x32a8ce=a105_0x226ad8,_0x345800={'ParentId':_0xc84663,'Name':_0x32a8ce(0x1b9)+_0x237f51,'Description':_0x32a8ce(0x1b9)+_0x58d503,'Body':_0x2f6b84},{data:_0x337777}=await _0x3a6b0e[_0x32a8ce(0x1f9)](_0x32a8ce(0x20f)+_0x36a86f+'/sobjects/Attachment',_0x345800);return _0x337777['id'];}