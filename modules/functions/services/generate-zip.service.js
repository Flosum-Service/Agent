const a105_0x438023=a105_0x3890;(function(_0x53e7a5,_0x3b1594){const _0x4763c8=a105_0x3890,_0x26f88b=_0x53e7a5();while(!![]){try{const _0x231043=parseInt(_0x4763c8(0x1e2))/0x1*(-parseInt(_0x4763c8(0x201))/0x2)+-parseInt(_0x4763c8(0x21f))/0x3+-parseInt(_0x4763c8(0x225))/0x4*(-parseInt(_0x4763c8(0x21d))/0x5)+parseInt(_0x4763c8(0x1ec))/0x6+-parseInt(_0x4763c8(0x228))/0x7+-parseInt(_0x4763c8(0x214))/0x8*(-parseInt(_0x4763c8(0x22a))/0x9)+-parseInt(_0x4763c8(0x1e3))/0xa;if(_0x231043===_0x3b1594)break;else _0x26f88b['push'](_0x26f88b['shift']());}catch(_0x2e568f){_0x26f88b['push'](_0x26f88b['shift']());}}}(a105_0x4b48,0x85231));const a105_0x4fd534=(function(){let _0x2daa55=!![];return function(_0x1e57bd,_0x471d2f){const _0x165bbd=_0x2daa55?function(){const _0x121d54=a105_0x3890;if(_0x471d2f){const _0x4b093f=_0x471d2f[_0x121d54(0x1d6)](_0x1e57bd,arguments);return _0x471d2f=null,_0x4b093f;}}:function(){};return _0x2daa55=![],_0x165bbd;};}()),a105_0x501336=a105_0x4fd534(this,function(){const _0x26cd4d=a105_0x3890;return a105_0x501336[_0x26cd4d(0x1df)]()['search'](_0x26cd4d(0x1fc))['toString']()[_0x26cd4d(0x1e5)](a105_0x501336)[_0x26cd4d(0x1ed)](_0x26cd4d(0x1fc));});a105_0x501336();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x12a1c9){const _0x9ceb0c=a105_0x3890;return _0x12a1c9&&_0x12a1c9[_0x9ceb0c(0x1d9)]?_0x12a1c9:{'default':_0x12a1c9};};Object[a105_0x438023(0x21e)](exports,a105_0x438023(0x1d9),{'value':!![]}),exports[a105_0x438023(0x215)]=void 0x0;const path_1=__importDefault(require(a105_0x438023(0x20b))),extract_component_permissions_1=require(a105_0x438023(0x1f0)),logger_1=require(a105_0x438023(0x21b)),xml2js_1=require(a105_0x438023(0x20c)),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require(a105_0x438023(0x208)),fs_internal_1=require(a105_0x438023(0x1cd)),promises_1=require(a105_0x438023(0x209)),components_api_1=require(a105_0x438023(0x1fd)),adm_zip_1=__importDefault(require(a105_0x438023(0x1cc))),uuid_1=require(a105_0x438023(0x1fe)),fetch_attachments_1=require(a105_0x438023(0x20e)),salesforce_1=require(a105_0x438023(0x1e8)),DESTRUCTIVE_CHANGES_PER_NAME=a105_0x438023(0x1d2),DESTRUCTIVE_CHANGES_POST_NAME=a105_0x438023(0x1e0),DEPLOY_DIR_NAME=a105_0x438023(0x223),PERMISSION_SET_FOLDER_NAME=a105_0x438023(0x1dd);function a105_0x3890(_0x2aaf11,_0x428373){const _0xf52490=a105_0x4b48();return a105_0x3890=function(_0x501336,_0x4fd534){_0x501336=_0x501336-0x1c9;let _0x4b48a1=_0xf52490[_0x501336];return _0x4b48a1;},a105_0x3890(_0x2aaf11,_0x428373);}async function generateAndDeployZip({attachmentsId:_0x93d13a,isExtractComponentsPermissionSets:_0x41a83f,isExtractComponentsProfiles:_0x31ce6f,preDestructiveAttachmentId:_0x700b29,postDestructiveAttachmentId:_0x41a73a,branchId:_0x129aea,credentials:_0x46a637,metadataLogId:_0x549278,environments:_0x4c2088,metaTypes:_0x1bb876,apiVersion:_0xa07b68},_0xab839a,_0x3fee82){const _0x19e77c=a105_0x438023;var _0x138dc1;const _0x1a905f=(0x0,uuid_1['v4'])();try{const _0x3ac607=await(0x0,fetch_attachments_1[_0x19e77c(0x211)])(_0xab839a,_0x93d13a),_0x52b7ce=_0x3ac607['reduce']((_0x3b62f5,_0xb556bd)=>({..._0x3b62f5,[_0xb556bd['Id']]:_0xb556bd[_0x19e77c(0x1d0)]}),{}),_0xcb9919=await getComponents(_0x3ac607,_0xab839a,_0x52b7ce),_0x6e1e52=await components_api_1[_0x19e77c(0x204)][_0x19e77c(0x1f9)](_0xab839a,_0x3ac607[_0x19e77c(0x1de)](({ParentId:_0x58a01d})=>_0x58a01d),_0xa07b68)['then'](_0x49fba9=>components_api_1['ComponentsApi'][_0x19e77c(0x1f1)](_0x49fba9));if(_0x31ce6f){const _0xd94d90=_0xcb9919[_0x19e77c(0x1f4)](({fileType:_0xce78aa})=>_0xce78aa===_0x19e77c(0x212));await removePermission(_0xd94d90,_0x6e1e52);}const _0x449311=_0xcb9919[_0x19e77c(0x1f4)](({fileType:_0x3f1a12})=>_0x3f1a12===_0x19e77c(0x1f5));if(_0x449311[_0x19e77c(0x224)]&&_0x41a83f){await removePermission(_0x449311,_0x6e1e52);const {items:_0x1993a3}=await retrieveTargetPermissionSets(_0x449311,_0xa07b68,_0x3fee82);await mergePermissionSets(_0x449311,((_0x138dc1=_0x1993a3[_0x19e77c(0x1f5)])===null||_0x138dc1===void 0x0?void 0x0:_0x138dc1[_0x19e77c(0x1d1)])||[]);}await replaceEnvironments(_0x1bb876,_0x4c2088,_0xcb9919),await writeZip(_0xcb9919,_0x1a905f),await generateAndWritePackageXML(_0x3ac607,_0x6e1e52,_0x1a905f,_0xa07b68);_0x700b29&&await saveDestructiveChanges(_0xab839a,_0x700b29,DESTRUCTIVE_CHANGES_PER_NAME,_0x1a905f);_0x41a73a&&await saveDestructiveChanges(_0xab839a,_0x41a73a,DESTRUCTIVE_CHANGES_POST_NAME,_0x1a905f);const _0x7993d0=(await createDeployZip(_0x1a905f)['then'](_0x2979e0=>{return _0x2979e0;}))[_0x19e77c(0x1d4)]()[_0x19e77c(0x1df)]('base64'),_0x5a9c12=_0x7993d0['length'];if(_0x5a9c12>=components_api_1[_0x19e77c(0x229)]){const _0x3928c6=await createDeployZip(_0x1a905f),[_0x2a6594,_0x48aed5]=await components_api_1['ComponentsApi']['splitZip'](_0x3928c6,_0x5a9c12),_0x27e780=await insertZip(_0xab839a,_0x129aea,_0x46a637['orgId'],_0x549278,_0x2a6594['toBuffer']()['toString'](_0x19e77c(0x203)),_0xa07b68),_0x4259ea=await insertZip(_0xab839a,_0x129aea,_0x46a637[_0x19e77c(0x220)],_0x549278,_0x48aed5[_0x19e77c(0x1d4)]()[_0x19e77c(0x1df)](_0x19e77c(0x203)),_0xa07b68);return _0x27e780+','+_0x4259ea;}else return await insertZip(_0xab839a,_0x129aea,_0x46a637[_0x19e77c(0x220)],_0x549278,_0x7993d0,_0xa07b68);}catch(_0x3db479){throw _0x3db479;}finally{if(await fs_internal_1['FS'][_0x19e77c(0x216)](path_1['default'][_0x19e77c(0x1ef)](process[_0x19e77c(0x202)](),_0x19e77c(0x227),_0x1a905f)))await(0x0,promises_1['rm'])(path_1[_0x19e77c(0x1ce)][_0x19e77c(0x1ef)](process[_0x19e77c(0x202)](),_0x19e77c(0x227),_0x1a905f),{'recursive':!![]});}}exports[a105_0x438023(0x215)]=generateAndDeployZip;function a105_0x4b48(){const _0x5132a4=['@flosum/salesforce','name','async','package.xml','6258792mmukQu','search','Component__r','join','../utils/extract-component-permissions','removeNamespacePrefix','MetadataConstants','UTF-8','filter','PermissionSet','push','FOLDER_TO_METADATA_TYPE_MAP','Logger','fetchComponentsDetailsByComponentsHistory','Zip','substring','(((.+)+)+)+$','../utils/components-api','uuid','every','fileType','4RrndoV','cwd','base64','ComponentsApi','retrieveAttachments','fileName','MDApiWriter','../../git/writers/mdapi.writer','fs/promises','file','path','xml2js','get','../../shared/utils/fetch-attachments','types','fetchAttachmentBody','fetchAttachmentsDetailsById','Profile','reduce','419360xYxNtc','generateAndDeployZip','exists','extractComponentPermissions','DeclarativeFilterOptions','files','dir','../classes/logger','/sobjects/Attachment','15nXpBwG','defineProperty','717099OvOYYU','orgId','post','execute','DEPLOYZIP','length','758220JTzdpw','Body','.temp','680519FYMshV','MAX_ZIP_SIZE','144YAQgsL','values','DEFLATE','indexOf','replace','adm-zip','../../git/internal/fs.internal','default','1.0','Name','components','destructiveChangesPre.xml','generateAsync','toBuffer','mergeComponentPermissions','apply','unzip','buildObject','__esModule','text','body','ParentId','permissionsets','map','toString','destructiveChangesPost.xml','createZip','349427oemsmL','8700840TrFbcB','type','constructor','/services/data/v','PERMISSION_SET'];a105_0x4b48=function(){return _0x5132a4;};return a105_0x4b48();}async function getComponents(_0x39c91b,_0x2d6c97,_0x44ee81){const _0x55d26e=a105_0x438023,_0x329564=[],_0x52ee32=await(0x0,fetch_attachments_1[_0x55d26e(0x205)])(_0x39c91b,_0x2d6c97);return await getComponentFromZip(_0x52ee32,_0x44ee81)['then'](_0x239cec=>{_0x329564['push'](..._0x239cec);}),_0x329564;}async function getComponentFromZip(_0x41a4fd,_0x4b0a45){const _0x3191ed=a105_0x438023,_0x12d5a0=[];for(const _0xab07bb of _0x41a4fd){const _0x14f0fc=await zip_1[_0x3191ed(0x1fa)][_0x3191ed(0x1d7)](_0xab07bb[_0x3191ed(0x22b)][_0x3191ed(0x226)]);for(const _0x4a6432 in _0x14f0fc[_0x3191ed(0x219)]){!_0x14f0fc[_0x3191ed(0x219)][_0x4a6432][_0x3191ed(0x21a)]&&_0x12d5a0[_0x3191ed(0x1f6)]({'fileName':_0x4a6432[_0x3191ed(0x1fb)](_0x4a6432[_0x3191ed(0x1ca)]('/')+0x1),'fileType':_0x4b0a45[_0xab07bb['id']],'body':_0xab07bb[_0x3191ed(0x22b)][_0x3191ed(0x226)]});}}return _0x12d5a0;}async function removePermission(_0x33aa3a,_0x2936fe){const _0x28ef7f=a105_0x438023;for(const _0x1f78cc of _0x33aa3a){const _0x46c254=await zip_1['Zip'][_0x28ef7f(0x1d7)](_0x1f78cc[_0x28ef7f(0x1db)]),_0x4c5710=[];for(const _0x1fa4d5 in _0x46c254[_0x28ef7f(0x219)]){!_0x46c254[_0x28ef7f(0x219)][_0x1fa4d5]['dir']&&_0x4c5710[_0x28ef7f(0x1f6)]({'fileName':_0x1fa4d5,'body':await _0x46c254[_0x28ef7f(0x219)][_0x1fa4d5][_0x28ef7f(0x1ea)](_0x28ef7f(0x1da))});}const _0x59a6bb=await(0x0,extract_component_permissions_1[_0x28ef7f(0x217)])(_0x4c5710[0x0][_0x28ef7f(0x1db)][_0x28ef7f(0x1df)](),_0x2936fe,_0x1f78cc[_0x28ef7f(0x200)]),_0x1e58e0=new xml2js_1['Builder']({'xmldec':{'version':'1.0','encoding':_0x28ef7f(0x1f3)}}),_0x53508a=_0x1e58e0[_0x28ef7f(0x1d8)](_0x59a6bb),_0x134d79=zip_1[_0x28ef7f(0x1fa)][_0x28ef7f(0x1e1)]();_0x134d79[_0x28ef7f(0x20a)](_0x4c5710[0x0][_0x28ef7f(0x206)],_0x53508a),_0x1f78cc['body']=await _0x134d79['generateAsync']({'type':_0x28ef7f(0x203),'compression':_0x28ef7f(0x1c9),'compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x158a29,_0x48fbaf,_0x345c6c){const _0x317e03=a105_0x438023,_0x57c75e=_0x158a29[_0x317e03(0x1de)](_0x4d87fa=>PERMISSION_SET_FOLDER_NAME+'/'+_0x4d87fa[_0x317e03(0x206)])['join'](';'),_0x1e056c=[{'field':'fileName','option':salesforce_1[_0x317e03(0x218)]['IN'],'value':_0x57c75e}],_0x1c8a61=new logger_1[(_0x317e03(0x1f8))]();return new salesforce_1['PartialRetrieve'](_0x48fbaf,_0x345c6c,_0x1c8a61,_0x1e056c,null,[salesforce_1['MetadataType'][_0x317e03(0x1e7)]])[_0x317e03(0x222)]();}async function mergePermissionSets(_0x52352d,_0x478060){const _0x478c87=a105_0x438023,_0x19d6f9=_0x478060['reduce']((_0xf94736,_0x1c150c)=>_0xf94736['set'](_0x1c150c['listMetadataItem'][_0x478c87(0x206)],_0x1c150c),new Map());for(const _0x471b60 of _0x52352d){const _0xadf263=PERMISSION_SET_FOLDER_NAME+'/'+_0x471b60['fileName'],_0x17d635=_0x19d6f9[_0x478c87(0x20d)](_0xadf263);if(!_0x17d635)continue;const _0x3aafaa=await zip_1[_0x478c87(0x1fa)]['unzip'](_0x471b60[_0x478c87(0x1db)]),_0x4e7744=await _0x3aafaa[_0x478c87(0x219)][_0xadf263][_0x478c87(0x1ea)](_0x478c87(0x1da)),_0x5f1a77=_0x17d635['files'][_0xadf263]['toString'](),_0x290806=await(0x0,extract_component_permissions_1[_0x478c87(0x1d5)])(_0x4e7744,_0x5f1a77,_0x471b60[_0x478c87(0x200)]),_0x1f3c7f=zip_1['Zip'][_0x478c87(0x1e1)]();_0x1f3c7f[_0x478c87(0x20a)](_0xadf263,_0x290806),_0x471b60[_0x478c87(0x1db)]=await _0x1f3c7f[_0x478c87(0x1d3)]({'type':_0x478c87(0x203),'compression':_0x478c87(0x1c9),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x54ba9a,_0x5c006d,_0x1a2b45){const _0x3bde54=a105_0x438023;for(const _0x431d16 of _0x1a2b45){if(_0x54ba9a[_0x3bde54(0x1ff)](_0x4d0773=>_0x4d0773!==_0x431d16['fileType']))continue;const _0x132fdc=await zip_1[_0x3bde54(0x1fa)]['unzip'](_0x431d16[_0x3bde54(0x1db)]);for(const _0x201466 in _0x132fdc[_0x3bde54(0x219)]){if(!_0x132fdc[_0x3bde54(0x219)][_0x201466][_0x3bde54(0x21a)]){let _0x16eaa4=await _0x132fdc['files'][_0x201466][_0x3bde54(0x1ea)](_0x3bde54(0x1da));for(const _0x41eea6 of Object['keys'](_0x5c006d)){const _0xd1731b=new RegExp('%%'+_0x41eea6+'%%','g');_0x16eaa4=_0x16eaa4[_0x3bde54(0x1cb)](_0xd1731b,_0x5c006d[_0x41eea6]);}_0x132fdc['file'](_0x201466,_0x16eaa4);}}_0x431d16[_0x3bde54(0x1db)]=await _0x132fdc['generateAsync']({'type':_0x3bde54(0x203),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x4e8465,_0x573db8){const _0xaeab7c=a105_0x438023,_0x4341e3=new mdapi_writer_1[(_0xaeab7c(0x207))]({'components':_0x4e8465,'sourceDir':path_1[_0xaeab7c(0x1ce)][_0xaeab7c(0x1ef)](process[_0xaeab7c(0x202)](),_0xaeab7c(0x227),_0x573db8,DEPLOY_DIR_NAME),'skipChildErrors':![]});await _0x4341e3[_0xaeab7c(0x222)]();}async function generateAndWritePackageXML(_0x10fbbd,_0x223ccb,_0x3d1390,_0x43fa52){const _0x18bf35=a105_0x438023,_0x43896e=getComponentsTypeAndName(_0x10fbbd,_0x223ccb),_0x344316=[...new Set(_0x43896e[_0x18bf35(0x1de)](_0x382122=>_0x382122[_0x18bf35(0x1e4)]))],_0xe34a37={'Package':{'$':{'xmlns':'http://soap.sforce.com/2006/04/metadata'},'types':[],'version':''+_0x43fa52}};for(const _0x4bd577 of _0x344316){const _0x1d8e21=_0x43896e['filter'](_0x48fc5b=>_0x48fc5b[_0x18bf35(0x1e4)]===_0x4bd577)[_0x18bf35(0x1de)](_0x2b09d7=>_0x2b09d7[_0x18bf35(0x1e9)]),_0x2eb197={'members':_0x1d8e21,'name':_0x4bd577};_0xe34a37['Package'][_0x18bf35(0x20f)][_0x18bf35(0x1f6)](_0x2eb197);}const _0x443232=new xml2js_1['Builder']({'xmldec':{'version':_0x18bf35(0x1cf),'encoding':_0x18bf35(0x1f3)}}),_0x5ca32c=_0x443232[_0x18bf35(0x1d8)](_0xe34a37);await fs_internal_1['FS']['writeFile'](path_1['default'][_0x18bf35(0x1ef)](process[_0x18bf35(0x202)](),_0x18bf35(0x227),_0x3d1390,DEPLOY_DIR_NAME,_0x18bf35(0x1eb)),_0x5ca32c);}function getComponentsTypeAndName(_0x2302c4,_0x535552){const _0x2f97ea=a105_0x438023;return _0x2302c4[_0x2f97ea(0x213)]((_0x136f98,_0x2d24a4)=>{const _0x1f5348=_0x2f97ea,_0x40d6de=_0x535552['find'](_0x733b3d=>_0x733b3d['Id']===_0x2d24a4[_0x1f5348(0x1dc)]);return _0x40d6de&&_0x136f98['push']({'name':_0x40d6de[_0x1f5348(0x1ee)]['Component_Name__c'],'type':salesforce_1[_0x1f5348(0x1f2)][_0x1f5348(0x1f7)][_0x2d24a4[_0x1f5348(0x1d0)]]||_0x2d24a4[_0x1f5348(0x1d0)]}),_0x136f98;},[]);}async function saveDestructiveChanges(_0xfb446b,_0x3f7a49,_0x252d52,_0x595ece){const _0x2a69b3=a105_0x438023,_0x5bfbcd=(await(0x0,fetch_attachments_1[_0x2a69b3(0x210)])(_0xfb446b,_0x3f7a49))[_0x2a69b3(0x1df)]();await fs_internal_1['FS']['writeFile'](path_1['default'][_0x2a69b3(0x1ef)](process[_0x2a69b3(0x202)](),_0x2a69b3(0x227),_0x595ece,DEPLOY_DIR_NAME,_0x252d52),_0x5bfbcd);}async function createDeployZip(_0x30e2fb){const _0x5c88d0=a105_0x438023,_0x3f14e6=new adm_zip_1['default']();return await _0x3f14e6['addLocalFolder'](path_1[_0x5c88d0(0x1ce)][_0x5c88d0(0x1ef)](process['cwd'](),'.temp',_0x30e2fb,DEPLOY_DIR_NAME)),_0x3f14e6;}async function insertZip(_0xed1759,_0x451186,_0x2fa6ae,_0x128a33,_0x281103,_0x554c2f){const _0x2a3739=a105_0x438023,_0x5cbd34={'ParentId':_0x451186,'Name':'BUILD'+_0x2fa6ae,'Description':'BUILD'+_0x128a33,'Body':_0x281103},{data:_0x277f27}=await _0xed1759[_0x2a3739(0x221)](_0x2a3739(0x1e6)+_0x554c2f+_0x2a3739(0x21c),_0x5cbd34);return _0x277f27['id'];}