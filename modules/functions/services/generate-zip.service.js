const a86_0x4e4887=a86_0x1f0b;(function(_0x1f1385,_0x3448ad){const _0x59dc5e=a86_0x1f0b,_0x315d56=_0x1f1385();while(!![]){try{const _0x34b606=-parseInt(_0x59dc5e(0xf0))/0x1+-parseInt(_0x59dc5e(0xdf))/0x2*(-parseInt(_0x59dc5e(0xaf))/0x3)+-parseInt(_0x59dc5e(0xb7))/0x4*(parseInt(_0x59dc5e(0xb4))/0x5)+-parseInt(_0x59dc5e(0xf1))/0x6+-parseInt(_0x59dc5e(0xdd))/0x7+-parseInt(_0x59dc5e(0xc4))/0x8+parseInt(_0x59dc5e(0xe1))/0x9*(parseInt(_0x59dc5e(0xeb))/0xa);if(_0x34b606===_0x3448ad)break;else _0x315d56['push'](_0x315d56['shift']());}catch(_0x519cac){_0x315d56['push'](_0x315d56['shift']());}}}(a86_0x59ba,0xcf8b5));const a86_0x305754=(function(){let _0x350182=!![];return function(_0x168e5b,_0x56ab94){const _0x420b03=_0x350182?function(){const _0x5cf726=a86_0x1f0b;if(_0x56ab94){const _0x543889=_0x56ab94[_0x5cf726(0xe9)](_0x168e5b,arguments);return _0x56ab94=null,_0x543889;}}:function(){};return _0x350182=![],_0x420b03;};}()),a86_0x1fabf4=a86_0x305754(this,function(){const _0x2f0e0b=a86_0x1f0b;return a86_0x1fabf4[_0x2f0e0b(0xbf)]()['search'](_0x2f0e0b(0xb3))['toString']()['constructor'](a86_0x1fabf4)['search'](_0x2f0e0b(0xb3));});a86_0x1fabf4();function a86_0x1f0b(_0x3f50f7,_0x434349){const _0x3c942c=a86_0x59ba();return a86_0x1f0b=function(_0x1fabf4,_0x305754){_0x1fabf4=_0x1fabf4-0x9b;let _0x59bac2=_0x3c942c[_0x1fabf4];return _0x59bac2;},a86_0x1f0b(_0x3f50f7,_0x434349);}'use strict';var __importDefault=this&&this[a86_0x4e4887(0xc5)]||function(_0x3ef74d){const _0x54c87d=a86_0x4e4887;return _0x3ef74d&&_0x3ef74d[_0x54c87d(0xa6)]?_0x3ef74d:{'default':_0x3ef74d};};Object[a86_0x4e4887(0xdc)](exports,a86_0x4e4887(0xa6),{'value':!![]}),exports[a86_0x4e4887(0xee)]=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require(a86_0x4e4887(0xa3))),extract_component_permissions_1=require(a86_0x4e4887(0xa8)),xml2js_1=require('xml2js'),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require(a86_0x4e4887(0xd4)),fs_internal_1=require(a86_0x4e4887(0xd6)),promises_1=require(a86_0x4e4887(0xa7)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require(a86_0x4e4887(0xb0))),uuid_1=require(a86_0x4e4887(0xe6)),fetch_attachments_1=require(a86_0x4e4887(0xcd)),DESTRUCTIVE_CHANGES_PER_NAME=a86_0x4e4887(0xa4),DESTRUCTIVE_CHANGES_POST_NAME=a86_0x4e4887(0xbe),DEPLOY_DIR_NAME=a86_0x4e4887(0xd0);async function generateAndDeployZip({attachmentsId:_0x5e7dc7,isExtractComponentsPermissions:_0x201d72,preDestructiveAttachmentId:_0x3e4c89,postDestructiveAttachmentId:_0x442ef0,branchId:_0x3649be,credentials:_0x524d72,metadataLogId:_0x4aae30,environments:_0xe86f3d,metaTypes:_0x345161},_0x5b482e){const _0x1ad9c6=a86_0x4e4887,_0x366861=(0x0,uuid_1['v4'])();try{const _0x1a818c=await(0x0,fetch_attachments_1['fetchAttachmentsDetailsById'])(_0x5b482e,_0x5e7dc7),_0x17fb23=_0x1a818c[_0x1ad9c6(0xda)]((_0x4da780,_0x291fad)=>({..._0x4da780,[_0x291fad['Id']]:_0x291fad['Name']}),{}),_0x3b1d47=await getComponents(_0x1a818c,_0x5b482e,_0x17fb23),_0x43c464=await components_api_1[_0x1ad9c6(0xc2)][_0x1ad9c6(0xce)](_0x5b482e,_0x1a818c[_0x1ad9c6(0xea)](({ParentId:_0x4fd99f})=>_0x4fd99f))['then'](_0x38c6f8=>components_api_1['ComponentsApi'][_0x1ad9c6(0xad)](_0x38c6f8));if(_0x201d72){const _0x5621dd=_0x3b1d47[_0x1ad9c6(0xdb)](({fileType:_0x35aaae})=>_0x35aaae==='Profile'||_0x35aaae===_0x1ad9c6(0xbc));await removePermission(_0x5621dd,_0x43c464);}await replaceEnvironments(_0x345161,_0xe86f3d,_0x3b1d47),await writeZip(_0x3b1d47,_0x366861),await generateAndWritePackageXML(_0x1a818c,_0x43c464,_0x366861);_0x3e4c89&&await saveDestructiveChanges(_0x5b482e,_0x3e4c89,DESTRUCTIVE_CHANGES_PER_NAME,_0x366861);_0x442ef0&&await saveDestructiveChanges(_0x5b482e,_0x442ef0,DESTRUCTIVE_CHANGES_POST_NAME,_0x366861);const _0x1040d2=(await createDeployZip(_0x366861)['then'](_0x22045d=>{return _0x22045d;}))['toBuffer']()['toString'](_0x1ad9c6(0xde));console[_0x1ad9c6(0xca)](_0x1ad9c6(0xf2));const _0x451442=_0x1040d2[_0x1ad9c6(0xb9)];if(_0x451442>=components_api_1[_0x1ad9c6(0xaa)]){const _0x3ec036=await createDeployZip(_0x366861);console[_0x1ad9c6(0xca)](_0x1ad9c6(0xe7));const [_0x1aa931,_0x5b1652]=await components_api_1[_0x1ad9c6(0xc2)][_0x1ad9c6(0x9b)](_0x3ec036,_0x451442),_0x2b596b=await insertZip(_0x5b482e,_0x3649be,_0x524d72['orgId'],_0x4aae30,_0x1aa931[_0x1ad9c6(0xa2)]()[_0x1ad9c6(0xbf)](_0x1ad9c6(0xde))),_0x4bd58=await insertZip(_0x5b482e,_0x3649be,_0x524d72[_0x1ad9c6(0xe4)],_0x4aae30,_0x5b1652[_0x1ad9c6(0xa2)]()[_0x1ad9c6(0xbf)]('base64'));return _0x2b596b+','+_0x4bd58;}else return await insertZip(_0x5b482e,_0x3649be,_0x524d72[_0x1ad9c6(0xe4)],_0x4aae30,_0x1040d2);}catch(_0xaba4da){throw _0xaba4da;}finally{if(await fs_internal_1['FS'][_0x1ad9c6(0xb6)](path_1['default']['join'](process[_0x1ad9c6(0x9c)](),'.temp',_0x366861)))await(0x0,promises_1['rm'])(path_1[_0x1ad9c6(0xef)][_0x1ad9c6(0xac)](process['cwd'](),_0x1ad9c6(0xc6),_0x366861),{'recursive':!![]});}}exports[a86_0x4e4887(0xee)]=generateAndDeployZip;async function getComponents(_0x200ade,_0x3b0ad0,_0x8c90df){const _0x2f0841=a86_0x4e4887,_0x3a28d6=[],_0x7fc70d=await(0x0,fetch_attachments_1[_0x2f0841(0xd3)])(_0x200ade,_0x3b0ad0);return await getComponentFromZip(_0x7fc70d,_0x8c90df)['then'](_0x29b14c=>{const _0x811db0=_0x2f0841;_0x3a28d6[_0x811db0(0xbd)](..._0x29b14c);}),_0x3a28d6;}async function getComponentFromZip(_0x4d3a74,_0x59bdbc){const _0x4a874b=a86_0x4e4887,_0x27dfc0=[];for(const _0x4cd10a of _0x4d3a74){const _0x5dfd65=await zip_1[_0x4a874b(0xec)][_0x4a874b(0xa9)](_0x4cd10a['values'][_0x4a874b(0xd1)]);for(const _0x4b82f4 in _0x5dfd65[_0x4a874b(0xa5)]){!_0x5dfd65[_0x4a874b(0xa5)][_0x4b82f4]['dir']&&_0x27dfc0['push']({'fileName':_0x4b82f4[_0x4a874b(0xa0)](_0x4b82f4[_0x4a874b(0x9d)]('/')+0x1),'fileType':_0x59bdbc[_0x4cd10a['id']],'body':_0x4cd10a[_0x4a874b(0xc9)][_0x4a874b(0xd1)]});}}return _0x27dfc0;}async function removePermission(_0x1c57d9,_0x3af7b1){const _0x3830d8=a86_0x4e4887;for(const _0x5eea87 of _0x1c57d9){const _0x3388b6=await zip_1[_0x3830d8(0xec)][_0x3830d8(0xa9)](_0x5eea87['body']),_0x18da5e=[];for(const _0x569021 in _0x3388b6[_0x3830d8(0xa5)]){!_0x3388b6[_0x3830d8(0xa5)][_0x569021]['dir']&&_0x18da5e[_0x3830d8(0xbd)]({'fileName':_0x569021,'body':await _0x3388b6[_0x3830d8(0xa5)][_0x569021][_0x3830d8(0xab)]('text')});}const _0x375363=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x18da5e[0x0][_0x3830d8(0xe0)][_0x3830d8(0xbf)](),_0x3af7b1,_0x5eea87['fileType']),_0x4ed7cb=new xml2js_1[(_0x3830d8(0xc1))]({'xmldec':{'version':_0x3830d8(0xd5),'encoding':'UTF-8'}}),_0x3da034=_0x4ed7cb[_0x3830d8(0xc3)](_0x375363),_0x41d598=zip_1['Zip'][_0x3830d8(0xa1)]();_0x41d598[_0x3830d8(0xb1)](_0x18da5e[0x0][_0x3830d8(0x9f)],_0x3da034),_0x5eea87[_0x3830d8(0xe0)]=await _0x41d598[_0x3830d8(0xcc)]({'type':'base64','compression':_0x3830d8(0xe2),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x664140,_0x4829e7,_0x5658d5){const _0x51be47=a86_0x4e4887;for(const _0x504cbd of _0x5658d5){if(_0x664140['every'](_0x1046a9=>_0x1046a9!==_0x504cbd['fileType']))continue;const _0x320f97=await zip_1[_0x51be47(0xec)]['unzip'](_0x504cbd[_0x51be47(0xe0)]);for(const _0x158b39 in _0x320f97['files']){if(!_0x320f97['files'][_0x158b39][_0x51be47(0xd7)]){let _0x5041b5=await _0x320f97[_0x51be47(0xa5)][_0x158b39]['async'](_0x51be47(0xcb));for(const _0x158db1 of Object[_0x51be47(0xbb)](_0x4829e7)){const _0x4b25f6=new RegExp('%%'+_0x158db1+'%%','g');_0x5041b5=_0x5041b5[_0x51be47(0xd8)](_0x4b25f6,_0x4829e7[_0x158db1]);}_0x320f97['file'](_0x158b39,_0x5041b5);}}_0x504cbd[_0x51be47(0xe0)]=await _0x320f97['generateAsync']({'type':_0x51be47(0xde),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function writeZip(_0x121416,_0x24ba00){const _0x12a250=a86_0x4e4887,_0x101282=new mdapi_1[(_0x12a250(0xd9))]({'components':_0x121416,'sourceDir':path_1['default']['join'](process[_0x12a250(0x9c)](),'.temp',_0x24ba00,DEPLOY_DIR_NAME,_0x12a250(0xae)),'skipChildErrors':![]});await _0x101282['start']();}async function generateAndWritePackageXML(_0x512466,_0x21ce22,_0x1cdce0){const _0x599621=a86_0x4e4887,_0x8a29d6=getComponentsTypeAndName(_0x512466,_0x21ce22),_0x4c4ef6=[...new Set(_0x8a29d6[_0x599621(0xea)](_0x388998=>_0x388998['type']))],_0x1df2d7={'Package':{'$':{'xmlns':_0x599621(0xd2)},'types':[],'version':''+constants_1[_0x599621(0xcf)][_0x599621(0xa0)](0x1)}};for(const _0x186be1 of _0x4c4ef6){const _0x4dba24=_0x8a29d6[_0x599621(0xdb)](_0x240b5b=>_0x240b5b[_0x599621(0xe3)]===_0x186be1)[_0x599621(0xea)](_0x3235ca=>_0x3235ca[_0x599621(0xc0)]),_0x367abf={'members':_0x4dba24,'name':_0x186be1};_0x1df2d7[_0x599621(0xb5)][_0x599621(0xe8)][_0x599621(0xbd)](_0x367abf);}const _0x537503=new xml2js_1[(_0x599621(0xc1))]({'xmldec':{'version':_0x599621(0xd5),'encoding':'UTF-8'}}),_0x5ce662=_0x537503['buildObject'](_0x1df2d7);await fs_internal_1['FS'][_0x599621(0xb8)](path_1[_0x599621(0xef)][_0x599621(0xac)](process[_0x599621(0x9c)](),'.temp',_0x1cdce0,DEPLOY_DIR_NAME,_0x599621(0xae),'package.xml'),_0x5ce662);}function getComponentsTypeAndName(_0x24a54b,_0x2d5149){const _0x4202b3=a86_0x4e4887;return _0x24a54b[_0x4202b3(0xda)]((_0x451a7b,_0x3cc3e2)=>{const _0x322f7b=_0x4202b3,_0x524270=_0x2d5149['find'](_0x18498f=>_0x18498f['Id']===_0x3cc3e2[_0x322f7b(0xe5)]);return _0x524270&&_0x451a7b['push']({'name':_0x524270[_0x322f7b(0xb2)][_0x322f7b(0xba)],'type':_0x3cc3e2['Name']}),_0x451a7b;},[]);}function a86_0x59ba(){const _0x3454e5=['Body','http://soap.sforce.com/2006/04/metadata','retrieveAttachments','../../git/parsers/mdapi','1.0','../../git/internal/fs.internal','dir','replace','MDApiWriter','reduce','filter','defineProperty','11668363QChZMU','base64','4ERwslc','body','603pAxkQt','DEFLATE','type','orgId','ParentId','uuid','after\x20create\x20second\x20zip','types','apply','map','847190NPReyO','Zip','BUILD','generateAndDeployZip','default','1067128vVGVpX','4035636UJzNPh','after\x20create\x20zip','splitZip','cwd','indexOf','post','fileName','substring','createZip','toBuffer','path','destructiveChangesPre.xml','files','__esModule','fs/promises','../utils/extract-component-permissions','unzip','MAX_ZIP_SIZE','async','join','removeNamespacePrefix','src','1386069VXzEdP','adm-zip','file','Component__r','(((.+)+)+)+$','10DswUNe','Package','exists','1361684nNkUFI','writeFile','length','Component_Name__c','keys','PermissionSet','push','destructiveChangesPost.xml','toString','name','Builder','ComponentsApi','buildObject','13301064YQIVcA','__importDefault','.temp','fetchAttachmentBody','/services/data/','values','log','text','generateAsync','../../shared/utils/fetch-attachments','fetchComponentsDetailsByComponentsHistory','SALESFORCE_API_VERSION','DEPLOYZIP'];a86_0x59ba=function(){return _0x3454e5;};return a86_0x59ba();}async function saveDestructiveChanges(_0x1a0651,_0x23a1f9,_0x5f1f7a,_0x3e1e11){const _0x2bb87c=a86_0x4e4887,_0x3b7620=(await(0x0,fetch_attachments_1[_0x2bb87c(0xc7)])(_0x1a0651,_0x23a1f9))['toString']();await fs_internal_1['FS'][_0x2bb87c(0xb8)](path_1['default'][_0x2bb87c(0xac)](process['cwd'](),'.temp',_0x3e1e11,DEPLOY_DIR_NAME,'src',_0x5f1f7a),_0x3b7620);}async function createDeployZip(_0x21aa07){const _0x1bdb81=a86_0x4e4887,_0x21dfe4=new adm_zip_1[(_0x1bdb81(0xef))]();return await _0x21dfe4['addLocalFolder'](path_1[_0x1bdb81(0xef)]['join'](process[_0x1bdb81(0x9c)](),_0x1bdb81(0xc6),_0x21aa07,DEPLOY_DIR_NAME)),_0x21dfe4;}async function insertZip(_0x46b518,_0x105394,_0x46c889,_0x4da5d8,_0x4e1649){const _0x586257=a86_0x4e4887,_0xbaee55={'ParentId':_0x105394,'Name':'BUILD'+_0x46c889,'Description':_0x586257(0xed)+_0x4da5d8,'Body':_0x4e1649},{data:_0x3f4c4d}=await _0x46b518[_0x586257(0x9e)](_0x586257(0xc8)+constants_1['SALESFORCE_API_VERSION']+'/sobjects/Attachment',_0xbaee55);return _0x3f4c4d['id'];}