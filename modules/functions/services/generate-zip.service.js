const a104_0x20b4fa=a104_0x4482;(function(_0x3e3baa,_0x5ca796){const _0x195c41=a104_0x4482,_0x1db017=_0x3e3baa();while(!![]){try{const _0x9a28a1=-parseInt(_0x195c41(0xff))/0x1+parseInt(_0x195c41(0x10f))/0x2*(-parseInt(_0x195c41(0x111))/0x3)+parseInt(_0x195c41(0x10d))/0x4*(parseInt(_0x195c41(0xf1))/0x5)+-parseInt(_0x195c41(0x11c))/0x6+-parseInt(_0x195c41(0x108))/0x7*(parseInt(_0x195c41(0x141))/0x8)+-parseInt(_0x195c41(0x107))/0x9+parseInt(_0x195c41(0xef))/0xa;if(_0x9a28a1===_0x5ca796)break;else _0x1db017['push'](_0x1db017['shift']());}catch(_0xd77011){_0x1db017['push'](_0x1db017['shift']());}}}(a104_0x5490,0x3b9f0));const a104_0x5cb6ae=(function(){let _0x3b5ba6=!![];return function(_0x249dbb,_0xacd05f){const _0x593e52=_0x3b5ba6?function(){const _0x21d5d0=a104_0x4482;if(_0xacd05f){const _0x1d9f6e=_0xacd05f[_0x21d5d0(0x151)](_0x249dbb,arguments);return _0xacd05f=null,_0x1d9f6e;}}:function(){};return _0x3b5ba6=![],_0x593e52;};}()),a104_0x124fe1=a104_0x5cb6ae(this,function(){const _0x19c7cd=a104_0x4482;return a104_0x124fe1[_0x19c7cd(0x12a)]()[_0x19c7cd(0x125)](_0x19c7cd(0x10a))[_0x19c7cd(0x12a)]()[_0x19c7cd(0x149)](a104_0x124fe1)[_0x19c7cd(0x125)](_0x19c7cd(0x10a));});a104_0x124fe1();'use strict';var __importDefault=this&&this[a104_0x20b4fa(0x135)]||function(_0x400b2b){const _0x9744af=a104_0x20b4fa;return _0x400b2b&&_0x400b2b[_0x9744af(0x104)]?_0x400b2b:{'default':_0x400b2b};};Object[a104_0x20b4fa(0x112)](exports,a104_0x20b4fa(0x104),{'value':!![]}),exports[a104_0x20b4fa(0x123)]=void 0x0;const path_1=__importDefault(require(a104_0x20b4fa(0xf9))),extract_component_permissions_1=require(a104_0x20b4fa(0x140)),logger_1=require(a104_0x20b4fa(0x137)),xml2js_1=require(a104_0x20b4fa(0x150)),zip_1=require('../../git/parsers/utils/zip'),mdapi_writer_1=require(a104_0x20b4fa(0x14d)),fs_internal_1=require(a104_0x20b4fa(0xf8)),promises_1=require(a104_0x20b4fa(0x10c)),components_api_1=require(a104_0x20b4fa(0x106)),adm_zip_1=__importDefault(require(a104_0x20b4fa(0x113))),uuid_1=require(a104_0x20b4fa(0x101)),fetch_attachments_1=require(a104_0x20b4fa(0x13e)),salesforce_1=require(a104_0x20b4fa(0x14e)),DESTRUCTIVE_CHANGES_PER_NAME=a104_0x20b4fa(0x100),DESTRUCTIVE_CHANGES_POST_NAME=a104_0x20b4fa(0x156),DEPLOY_DIR_NAME=a104_0x20b4fa(0xfd),PERMISSION_SET_FOLDER_NAME=a104_0x20b4fa(0x136);async function generateAndDeployZip({attachmentsId:_0xe51112,isExtractComponentsPermissionSets:_0x5df548,isExtractComponentsProfiles:_0x516e96,preDestructiveAttachmentId:_0x10f225,postDestructiveAttachmentId:_0x2626b2,branchId:_0x3b723a,credentials:_0x5bec4d,metadataLogId:_0x149333,environments:_0x2c50e8,metaTypes:_0x4f0a80,apiVersion:_0x32c62c},_0x4ceb22,_0x116874){const _0x2563d7=a104_0x20b4fa;var _0x836cc7;const _0x1ee79d=(0x0,uuid_1['v4'])();try{const _0x1ad02d=await(0x0,fetch_attachments_1[_0x2563d7(0xf0)])(_0x4ceb22,_0xe51112),_0x2ee189=_0x1ad02d[_0x2563d7(0x145)]((_0x4c8ffe,_0x1b8dee)=>({..._0x4c8ffe,[_0x1b8dee['Id']]:_0x1b8dee[_0x2563d7(0x14c)]}),{}),_0x5c8199=await getComponents(_0x1ad02d,_0x4ceb22,_0x2ee189),_0x5886ce=await components_api_1[_0x2563d7(0x155)][_0x2563d7(0x11f)](_0x4ceb22,_0x1ad02d[_0x2563d7(0x132)](({ParentId:_0x1eb8bf})=>_0x1eb8bf),_0x32c62c)[_0x2563d7(0x117)](_0x359a42=>components_api_1['ComponentsApi'][_0x2563d7(0x13f)](_0x359a42));if(_0x516e96){const _0x154946=_0x5c8199['filter'](({fileType:_0x417d8b})=>_0x417d8b==='Profile');await removePermission(_0x154946,_0x5886ce);}const _0x45c9f2=_0x5c8199[_0x2563d7(0x119)](({fileType:_0x307e26})=>_0x307e26===_0x2563d7(0x138));if(_0x45c9f2[_0x2563d7(0xfc)]&&_0x5df548){await removePermission(_0x45c9f2,_0x5886ce);const {items:_0x2d3f7a}=await retrieveTargetPermissionSets(_0x45c9f2,_0x32c62c,_0x116874);await mergePermissionSets(_0x45c9f2,((_0x836cc7=_0x2d3f7a[_0x2563d7(0x138)])===null||_0x836cc7===void 0x0?void 0x0:_0x836cc7['components'])||[]);}await replaceEnvironments(_0x4f0a80,_0x2c50e8,_0x5c8199),await writeZip(_0x5c8199,_0x1ee79d),await generateAndWritePackageXML(_0x1ad02d,_0x5886ce,_0x1ee79d,_0x32c62c);_0x10f225&&await saveDestructiveChanges(_0x4ceb22,_0x10f225,DESTRUCTIVE_CHANGES_PER_NAME,_0x1ee79d);_0x2626b2&&await saveDestructiveChanges(_0x4ceb22,_0x2626b2,DESTRUCTIVE_CHANGES_POST_NAME,_0x1ee79d);const _0x31b2fc=(await createDeployZip(_0x1ee79d)['then'](_0x57acbf=>{return _0x57acbf;}))['toBuffer']()[_0x2563d7(0x12a)]('base64'),_0x393bf6=_0x31b2fc['length'];if(_0x393bf6>=components_api_1[_0x2563d7(0xee)]){const _0x21f350=await createDeployZip(_0x1ee79d),[_0x42198f,_0x11e287]=await components_api_1[_0x2563d7(0x155)][_0x2563d7(0x122)](_0x21f350,_0x393bf6),_0x2830da=await insertZip(_0x4ceb22,_0x3b723a,_0x5bec4d['orgId'],_0x149333,_0x42198f[_0x2563d7(0x12d)]()['toString'](_0x2563d7(0x139)),_0x32c62c),_0x2f1b5f=await insertZip(_0x4ceb22,_0x3b723a,_0x5bec4d[_0x2563d7(0x11d)],_0x149333,_0x11e287['toBuffer']()['toString']('base64'),_0x32c62c);return _0x2830da+','+_0x2f1b5f;}else return await insertZip(_0x4ceb22,_0x3b723a,_0x5bec4d['orgId'],_0x149333,_0x31b2fc,_0x32c62c);}catch(_0x193a62){throw _0x193a62;}finally{if(await fs_internal_1['FS'][_0x2563d7(0x129)](path_1[_0x2563d7(0x121)][_0x2563d7(0x13b)](process[_0x2563d7(0x124)](),_0x2563d7(0x12c),_0x1ee79d)))await(0x0,promises_1['rm'])(path_1[_0x2563d7(0x121)][_0x2563d7(0x13b)](process[_0x2563d7(0x124)](),_0x2563d7(0x12c),_0x1ee79d),{'recursive':!![]});}}exports[a104_0x20b4fa(0x123)]=generateAndDeployZip;async function getComponents(_0x2a523e,_0x1e5024,_0x24e8c6){const _0x4c0419=[],_0xd0eb62=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x2a523e,_0x1e5024);return await getComponentFromZip(_0xd0eb62,_0x24e8c6)['then'](_0x295b2c=>{const _0x2b7d6c=a104_0x4482;_0x4c0419[_0x2b7d6c(0x143)](..._0x295b2c);}),_0x4c0419;}async function getComponentFromZip(_0x421d4d,_0x443f38){const _0xa77245=a104_0x20b4fa,_0x63dfb5=[];for(const _0x5d7362 of _0x421d4d){const _0x565174=await zip_1[_0xa77245(0x115)][_0xa77245(0x142)](_0x5d7362[_0xa77245(0x114)][_0xa77245(0x109)]);for(const _0x229372 in _0x565174['files']){!_0x565174['files'][_0x229372][_0xa77245(0x110)]&&_0x63dfb5['push']({'fileName':_0x229372[_0xa77245(0x116)](_0x229372[_0xa77245(0x13a)]('/')+0x1),'fileType':_0x443f38[_0x5d7362['id']],'body':_0x5d7362[_0xa77245(0x114)][_0xa77245(0x109)]});}}return _0x63dfb5;}async function removePermission(_0x324971,_0x3f0741){const _0x48465a=a104_0x20b4fa;for(const _0x351a76 of _0x324971){const _0x37d86e=await zip_1[_0x48465a(0x115)][_0x48465a(0x142)](_0x351a76[_0x48465a(0x11a)]),_0x5430aa=[];for(const _0x2ef81e in _0x37d86e[_0x48465a(0x127)]){!_0x37d86e[_0x48465a(0x127)][_0x2ef81e][_0x48465a(0x110)]&&_0x5430aa[_0x48465a(0x143)]({'fileName':_0x2ef81e,'body':await _0x37d86e[_0x48465a(0x127)][_0x2ef81e][_0x48465a(0x133)](_0x48465a(0x10e))});}const _0x19fb3a=await(0x0,extract_component_permissions_1[_0x48465a(0x134)])(_0x5430aa[0x0]['body'][_0x48465a(0x12a)](),_0x3f0741,_0x351a76[_0x48465a(0x130)]),_0x21ab8d=new xml2js_1[(_0x48465a(0xed))]({'xmldec':{'version':'1.0','encoding':_0x48465a(0x153)}}),_0x1fd0e2=_0x21ab8d[_0x48465a(0x12f)](_0x19fb3a),_0x2e4183=zip_1[_0x48465a(0x115)][_0x48465a(0x12e)]();_0x2e4183[_0x48465a(0xfe)](_0x5430aa[0x0][_0x48465a(0x148)],_0x1fd0e2),_0x351a76[_0x48465a(0x11a)]=await _0x2e4183[_0x48465a(0xf6)]({'type':_0x48465a(0x139),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}async function retrieveTargetPermissionSets(_0x306e3f,_0x9dc61e,_0x5ac944){const _0x1c86d5=a104_0x20b4fa,_0xebe6d9=_0x306e3f[_0x1c86d5(0x132)](_0x256a77=>PERMISSION_SET_FOLDER_NAME+'/'+_0x256a77[_0x1c86d5(0x148)])[_0x1c86d5(0x13b)](';'),_0x1f8dc7=[{'field':'fileName','option':salesforce_1[_0x1c86d5(0xf7)]['IN'],'value':_0xebe6d9}],_0x33fd2b=new logger_1['Logger']();return new salesforce_1[(_0x1c86d5(0xf3))](_0x9dc61e,_0x5ac944,_0x33fd2b,_0x1f8dc7,null,[salesforce_1['MetadataType'][_0x1c86d5(0xf4)]])[_0x1c86d5(0xfa)]();}async function mergePermissionSets(_0x321a5a,_0x2efa9a){const _0x46a50d=a104_0x20b4fa,_0xfbb726=_0x2efa9a[_0x46a50d(0x145)]((_0x204c50,_0x4496cd)=>_0x204c50[_0x46a50d(0x103)](_0x4496cd[_0x46a50d(0x154)][_0x46a50d(0x148)],_0x4496cd),new Map());for(const _0x321aaa of _0x321a5a){const _0xd9253c=PERMISSION_SET_FOLDER_NAME+'/'+_0x321aaa[_0x46a50d(0x148)],_0x1204ba=_0xfbb726[_0x46a50d(0x120)](_0xd9253c);if(!_0x1204ba)continue;const _0x5de6aa=await zip_1[_0x46a50d(0x115)][_0x46a50d(0x142)](_0x321aaa[_0x46a50d(0x11a)]),_0xad3cb6=await _0x5de6aa[_0x46a50d(0x127)][_0xd9253c][_0x46a50d(0x133)](_0x46a50d(0x10e)),_0x6d40a4=_0x1204ba[_0x46a50d(0x127)][_0xd9253c][_0x46a50d(0x12a)](),_0x50739c=await(0x0,extract_component_permissions_1[_0x46a50d(0x144)])(_0xad3cb6,_0x6d40a4,_0x321aaa[_0x46a50d(0x130)]),_0x5e4977=zip_1['Zip']['createZip']();_0x5e4977['file'](_0xd9253c,_0x50739c),_0x321aaa['body']=await _0x5e4977['generateAsync']({'type':_0x46a50d(0x139),'compression':'DEFLATE','compressionOptions':{'level':0x6}});}}function a104_0x4482(_0x36164c,_0x12e78b){const _0x4f539c=a104_0x5490();return a104_0x4482=function(_0x124fe1,_0x5cb6ae){_0x124fe1=_0x124fe1-0xed;let _0x5490a5=_0x4f539c[_0x124fe1];return _0x5490a5;},a104_0x4482(_0x36164c,_0x12e78b);}async function replaceEnvironments(_0x2b8da7,_0x5d0387,_0x32bfd2){const _0xeca4e0=a104_0x20b4fa;for(const _0x4064f1 of _0x32bfd2){if(_0x2b8da7[_0xeca4e0(0xfb)](_0x32fde4=>_0x32fde4!==_0x4064f1[_0xeca4e0(0x130)]))continue;const _0x1791b4=await zip_1[_0xeca4e0(0x115)][_0xeca4e0(0x142)](_0x4064f1[_0xeca4e0(0x11a)]);for(const _0x1c7b27 in _0x1791b4[_0xeca4e0(0x127)]){if(!_0x1791b4[_0xeca4e0(0x127)][_0x1c7b27]['dir']){let _0x5c32d3=await _0x1791b4[_0xeca4e0(0x127)][_0x1c7b27]['async'](_0xeca4e0(0x10e));for(const _0x25fa69 of Object[_0xeca4e0(0x11e)](_0x5d0387)){const _0x3c501c=new RegExp('%%'+_0x25fa69+'%%','g');_0x5c32d3=_0x5c32d3[_0xeca4e0(0x12b)](_0x3c501c,_0x5d0387[_0x25fa69]);}_0x1791b4[_0xeca4e0(0xfe)](_0x1c7b27,_0x5c32d3);}}_0x4064f1[_0xeca4e0(0x11a)]=await _0x1791b4[_0xeca4e0(0xf6)]({'type':'base64','compression':_0xeca4e0(0x146),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x2c9fa1,_0x36af44){const _0x190f5f=a104_0x20b4fa,_0x17971c=new mdapi_writer_1[(_0x190f5f(0x128))]({'components':_0x2c9fa1,'sourceDir':path_1[_0x190f5f(0x121)][_0x190f5f(0x13b)](process[_0x190f5f(0x124)](),'.temp',_0x36af44,DEPLOY_DIR_NAME,_0x190f5f(0x152)),'skipChildErrors':![]});await _0x17971c[_0x190f5f(0xfa)]();}async function generateAndWritePackageXML(_0x5264a4,_0x38f912,_0x214209,_0x306d25){const _0x17f149=a104_0x20b4fa,_0x4efd56=getComponentsTypeAndName(_0x5264a4,_0x38f912),_0x3c2d03=[...new Set(_0x4efd56[_0x17f149(0x132)](_0x5b1bf7=>_0x5b1bf7[_0x17f149(0x131)]))],_0x3e9416={'Package':{'$':{'xmlns':_0x17f149(0x102)},'types':[],'version':''+_0x306d25}};for(const _0x3e0cc8 of _0x3c2d03){const _0x28b47c=_0x4efd56[_0x17f149(0x119)](_0x3c1bd1=>_0x3c1bd1['type']===_0x3e0cc8)[_0x17f149(0x132)](_0x244a99=>_0x244a99['name']),_0x3a9c7d={'members':_0x28b47c,'name':_0x3e0cc8};_0x3e9416[_0x17f149(0x13c)]['types'][_0x17f149(0x143)](_0x3a9c7d);}const _0x1b9cbe=new xml2js_1[(_0x17f149(0xed))]({'xmldec':{'version':_0x17f149(0x126),'encoding':_0x17f149(0x153)}}),_0x44ecb0=_0x1b9cbe['buildObject'](_0x3e9416);await fs_internal_1['FS'][_0x17f149(0x14a)](path_1[_0x17f149(0x121)][_0x17f149(0x13b)](process['cwd'](),_0x17f149(0x12c),_0x214209,DEPLOY_DIR_NAME,'src','package.xml'),_0x44ecb0);}function getComponentsTypeAndName(_0x283258,_0x320fc0){const _0x313fcb=a104_0x20b4fa;return _0x283258[_0x313fcb(0x145)]((_0x223594,_0x5b4573)=>{const _0x7f240e=_0x313fcb,_0x5ece83=_0x320fc0[_0x7f240e(0x14f)](_0x33519f=>_0x33519f['Id']===_0x5b4573[_0x7f240e(0x14b)]);return _0x5ece83&&_0x223594[_0x7f240e(0x143)]({'name':_0x5ece83[_0x7f240e(0x10b)][_0x7f240e(0xf2)],'type':salesforce_1['MetadataConstants'][_0x7f240e(0x105)][_0x5b4573[_0x7f240e(0x14c)]]||_0x5b4573[_0x7f240e(0x14c)]}),_0x223594;},[]);}async function saveDestructiveChanges(_0x35c669,_0x3415ff,_0x6c4d87,_0x703f64){const _0x3456b7=a104_0x20b4fa,_0x566fa7=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x35c669,_0x3415ff))[_0x3456b7(0x12a)]();await fs_internal_1['FS']['writeFile'](path_1[_0x3456b7(0x121)]['join'](process[_0x3456b7(0x124)](),_0x3456b7(0x12c),_0x703f64,DEPLOY_DIR_NAME,_0x3456b7(0x152),_0x6c4d87),_0x566fa7);}async function createDeployZip(_0x1a2e05){const _0xcbd03e=a104_0x20b4fa,_0xfd35f5=new adm_zip_1[(_0xcbd03e(0x121))]();return await _0xfd35f5[_0xcbd03e(0x118)](path_1[_0xcbd03e(0x121)][_0xcbd03e(0x13b)](process[_0xcbd03e(0x124)](),'.temp',_0x1a2e05,DEPLOY_DIR_NAME)),_0xfd35f5;}function a104_0x5490(){const _0x174f0b=['PERMISSION_SET','BUILD','generateAsync','DeclarativeFilterOptions','../../git/internal/fs.internal','path','execute','every','length','DEPLOYZIP','file','19849lwBikd','destructiveChangesPre.xml','uuid','http://soap.sforce.com/2006/04/metadata','set','__esModule','FOLDER_TO_METADATA_TYPE_MAP','../utils/components-api','3229677CVyyXW','658fpfCfa','Body','(((.+)+)+)+$','Component__r','fs/promises','28AuoCYb','text','28BQlTZB','dir','22221Wcuwzk','defineProperty','adm-zip','values','Zip','substring','then','addLocalFolder','filter','body','/sobjects/Attachment','1520484yLnZqk','orgId','keys','fetchComponentsDetailsByComponentsHistory','get','default','splitZip','generateAndDeployZip','cwd','search','1.0','files','MDApiWriter','exists','toString','replace','.temp','toBuffer','createZip','buildObject','fileType','type','map','async','extractComponentPermissions','__importDefault','permissionsets','../classes/logger','PermissionSet','base64','indexOf','join','Package','/services/data/v','../../shared/utils/fetch-attachments','removeNamespacePrefix','../utils/extract-component-permissions','34696LUPKyf','unzip','push','mergeComponentPermissions','reduce','DEFLATE','post','fileName','constructor','writeFile','ParentId','Name','../../git/writers/mdapi.writer','@flosum/salesforce','find','xml2js','apply','src','UTF-8','listMetadataItem','ComponentsApi','destructiveChangesPost.xml','Builder','MAX_ZIP_SIZE','13669660ilYRvW','fetchAttachmentsDetailsById','14810MpYEjT','Component_Name__c','PartialRetrieve'];a104_0x5490=function(){return _0x174f0b;};return a104_0x5490();}async function insertZip(_0xa51df4,_0x1b5657,_0x19370a,_0x44bbcd,_0x18bb35,_0x5e3756){const _0x52bdd2=a104_0x20b4fa,_0x59f437={'ParentId':_0x1b5657,'Name':_0x52bdd2(0xf5)+_0x19370a,'Description':_0x52bdd2(0xf5)+_0x44bbcd,'Body':_0x18bb35},{data:_0x25889d}=await _0xa51df4[_0x52bdd2(0x147)](_0x52bdd2(0x13d)+_0x5e3756+_0x52bdd2(0x11b),_0x59f437);return _0x25889d['id'];}