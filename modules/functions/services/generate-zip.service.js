const a85_0x1f736b=a85_0x1ee3;(function(_0x21b914,_0x1fba29){const _0x245f71=a85_0x1ee3,_0x2663ca=_0x21b914();while(!![]){try{const _0x12836f=-parseInt(_0x245f71(0x209))/0x1+-parseInt(_0x245f71(0x1fe))/0x2*(parseInt(_0x245f71(0x206))/0x3)+-parseInt(_0x245f71(0x1f8))/0x4*(-parseInt(_0x245f71(0x1fc))/0x5)+-parseInt(_0x245f71(0x231))/0x6+-parseInt(_0x245f71(0x207))/0x7*(parseInt(_0x245f71(0x211))/0x8)+-parseInt(_0x245f71(0x21f))/0x9*(-parseInt(_0x245f71(0x1f6))/0xa)+-parseInt(_0x245f71(0x234))/0xb*(-parseInt(_0x245f71(0x24f))/0xc);if(_0x12836f===_0x1fba29)break;else _0x2663ca['push'](_0x2663ca['shift']());}catch(_0x5cf8b8){_0x2663ca['push'](_0x2663ca['shift']());}}}(a85_0x1fe6,0xab1e2));const a85_0x8a3747=(function(){let _0x4f43f6=!![];return function(_0x3cd4f0,_0x1e53ba){const _0x33ea9f=_0x4f43f6?function(){const _0x9f6724=a85_0x1ee3;if(_0x1e53ba){const _0x3db6b9=_0x1e53ba[_0x9f6724(0x21a)](_0x3cd4f0,arguments);return _0x1e53ba=null,_0x3db6b9;}}:function(){};return _0x4f43f6=![],_0x33ea9f;};}()),a85_0x598aff=a85_0x8a3747(this,function(){const _0x44680d=a85_0x1ee3;return a85_0x598aff[_0x44680d(0x205)]()[_0x44680d(0x1f1)](_0x44680d(0x23d))[_0x44680d(0x205)]()[_0x44680d(0x233)](a85_0x598aff)['search'](_0x44680d(0x23d));});a85_0x598aff();'use strict';var __importDefault=this&&this[a85_0x1f736b(0x200)]||function(_0x224ec0){const _0x5dc95c=a85_0x1f736b;return _0x224ec0&&_0x224ec0[_0x5dc95c(0x1f5)]?_0x224ec0:{'default':_0x224ec0};};Object[a85_0x1f736b(0x23e)](exports,a85_0x1f736b(0x1f5),{'value':!![]}),exports[a85_0x1f736b(0x22e)]=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require('path')),extract_component_permissions_1=require(a85_0x1f736b(0x203)),xml2js_1=require('xml2js'),zip_1=require(a85_0x1f736b(0x239)),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require(a85_0x1f736b(0x21b)),components_api_1=require('../utils/components-api'),adm_zip_1=__importDefault(require('adm-zip')),uuid_1=require(a85_0x1f736b(0x212)),fetch_attachments_1=require(a85_0x1f736b(0x220)),DESTRUCTIVE_CHANGES_PER_NAME=a85_0x1f736b(0x24d),DESTRUCTIVE_CHANGES_POST_NAME=a85_0x1f736b(0x22c),DEPLOY_DIR_NAME=a85_0x1f736b(0x245);async function generateAndDeployZip({attachmentsId:_0x58cf99,isExtractComponentsPermissions:_0x5e23fc,preDestructiveAttachmentId:_0x3b488c,postDestructiveAttachmentId:_0x338f6d,branchId:_0x2ac2e0,credentials:_0x59bdc3,metadataLogId:_0x5a0aff,environments:_0x20f859,metaTypes:_0x253691},_0x2762c4){const _0x4b7d97=a85_0x1f736b,_0x1460af=(0x0,uuid_1['v4'])();try{const _0x54ffb0=await(0x0,fetch_attachments_1[_0x4b7d97(0x23a)])(_0x2762c4,_0x58cf99),_0x99c897=_0x54ffb0[_0x4b7d97(0x243)]((_0x3dbf2d,_0x3062f8)=>({..._0x3dbf2d,[_0x3062f8['Id']]:_0x3062f8[_0x4b7d97(0x244)]}),{}),_0x189d8e=await getComponents(_0x54ffb0,_0x2762c4,_0x99c897),_0x351a2d=await components_api_1[_0x4b7d97(0x22a)]['fetchComponentsDetailsByComponentsHistory'](_0x2762c4,_0x54ffb0['map'](({ParentId:_0x1f29af})=>_0x1f29af))['then'](_0x59cb81=>components_api_1[_0x4b7d97(0x22a)][_0x4b7d97(0x222)](_0x59cb81));if(_0x5e23fc){const _0x4a2dc6=_0x189d8e[_0x4b7d97(0x221)](({fileType:_0x576092})=>_0x576092==='Profile'||_0x576092===_0x4b7d97(0x232));await removePermission(_0x4a2dc6,_0x351a2d);}await replaceEnvironments(_0x253691,_0x20f859,_0x189d8e),await writeZip(_0x189d8e,_0x1460af),await generateAndWritePackageXML(_0x54ffb0,_0x351a2d,_0x1460af);_0x3b488c&&await saveDestructiveChanges(_0x2762c4,_0x3b488c,DESTRUCTIVE_CHANGES_PER_NAME,_0x1460af);_0x338f6d&&await saveDestructiveChanges(_0x2762c4,_0x338f6d,DESTRUCTIVE_CHANGES_POST_NAME,_0x1460af);const _0x2321c7=(await createDeployZip(_0x1460af)[_0x4b7d97(0x240)](_0x23f443=>{return _0x23f443;}))[_0x4b7d97(0x21c)]()[_0x4b7d97(0x205)](_0x4b7d97(0x242));console[_0x4b7d97(0x223)](_0x4b7d97(0x23f));const _0xc1b550=_0x2321c7[_0x4b7d97(0x217)];if(_0xc1b550>=components_api_1[_0x4b7d97(0x228)]){const _0x44c4ac=await createDeployZip(_0x1460af);console[_0x4b7d97(0x223)](_0x4b7d97(0x208));const [_0x1fd65c,_0x238737]=await components_api_1['ComponentsApi'][_0x4b7d97(0x24a)](_0x44c4ac,_0xc1b550),_0x2714d9=await insertZip(_0x2762c4,_0x2ac2e0,_0x59bdc3[_0x4b7d97(0x219)],_0x5a0aff,_0x1fd65c[_0x4b7d97(0x21c)]()[_0x4b7d97(0x205)](_0x4b7d97(0x242))),_0x170bf3=await insertZip(_0x2762c4,_0x2ac2e0,_0x59bdc3[_0x4b7d97(0x219)],_0x5a0aff,_0x238737[_0x4b7d97(0x21c)]()[_0x4b7d97(0x205)]('base64'));return _0x2714d9+','+_0x170bf3;}else return await insertZip(_0x2762c4,_0x2ac2e0,_0x59bdc3['orgId'],_0x5a0aff,_0x2321c7);}catch(_0x2b992a){throw _0x2b992a;}finally{if(await fs_internal_1['FS'][_0x4b7d97(0x1f3)](path_1['default'][_0x4b7d97(0x1f4)](process[_0x4b7d97(0x23b)](),_0x4b7d97(0x229),_0x1460af)))await(0x0,promises_1['rm'])(path_1[_0x4b7d97(0x20e)]['join'](process['cwd'](),_0x4b7d97(0x229),_0x1460af),{'recursive':!![]});}}exports[a85_0x1f736b(0x22e)]=generateAndDeployZip;function a85_0x1fe6(){const _0x50f301=['log','fileName','DEFLATE','post','dir','MAX_ZIP_SIZE','.temp','ComponentsApi','async','destructiveChangesPost.xml','createZip','generateAndDeployZip','push','extractComponentPermissions','7121982rBIUfJ','PermissionSet','constructor','5225IeOubL','writeFile','fetchAttachmentBody','SALESFORCE_API_VERSION','ParentId','../../git/parsers/utils/zip','fetchAttachmentsDetailsById','cwd','Body','(((.+)+)+)+$','defineProperty','after\x20create\x20zip','then','Zip','base64','reduce','Name','DEPLOYZIP','body','start','files','type','splitZip','Component__r','MDApiWriter','destructiveChangesPre.xml','BUILD','88344DLSupb','values','search','name','exists','join','__esModule','1367890RnNwpT','file','20QtASxa','Package','replace','text','126510hrlFqz','keys','43526tQALXh','indexOf','__importDefault','generateAsync','package.xml','../utils/extract-component-permissions','Builder','toString','111XtHijk','105427ROtjzg','after\x20create\x20second\x20zip','654095WdpzTg','src','unzip','every','fileType','default','http://soap.sforce.com/2006/04/metadata','1.0','728fuLHHT','uuid','buildObject','/services/data/','substring','types','length','find','orgId','apply','fs/promises','toBuffer','addLocalFolder','/sobjects/Attachment','72WncWNC','../../shared/utils/fetch-attachments','filter','removeNamespacePrefix'];a85_0x1fe6=function(){return _0x50f301;};return a85_0x1fe6();}function a85_0x1ee3(_0x5574bf,_0x35ad84){const _0x2dc411=a85_0x1fe6();return a85_0x1ee3=function(_0x598aff,_0x8a3747){_0x598aff=_0x598aff-0x1f1;let _0x1fe60f=_0x2dc411[_0x598aff];return _0x1fe60f;},a85_0x1ee3(_0x5574bf,_0x35ad84);}async function getComponents(_0x157472,_0x2cfc5a,_0x5f236e){const _0x5aae72=a85_0x1f736b,_0x335b97=[],_0x482036=await(0x0,fetch_attachments_1['retrieveAttachments'])(_0x157472,_0x2cfc5a);return await getComponentFromZip(_0x482036,_0x5f236e)[_0x5aae72(0x240)](_0x3dbcc9=>{_0x335b97['push'](..._0x3dbcc9);}),_0x335b97;}async function getComponentFromZip(_0x57267c,_0x3c2e61){const _0x128471=a85_0x1f736b,_0x38851c=[];for(const _0x98f91e of _0x57267c){const _0x5bf8c9=await zip_1[_0x128471(0x241)][_0x128471(0x20b)](_0x98f91e[_0x128471(0x250)][_0x128471(0x23c)]);for(const _0x1f83d9 in _0x5bf8c9['files']){!_0x5bf8c9[_0x128471(0x248)][_0x1f83d9]['dir']&&_0x38851c[_0x128471(0x22f)]({'fileName':_0x1f83d9[_0x128471(0x215)](_0x1f83d9[_0x128471(0x1ff)]('/')+0x1),'fileType':_0x3c2e61[_0x98f91e['id']],'body':_0x98f91e['values'][_0x128471(0x23c)]});}}return _0x38851c;}async function removePermission(_0x3a9c91,_0x2f96f5){const _0x8c8c2=a85_0x1f736b;for(const _0x4b4211 of _0x3a9c91){const _0x24a497=await zip_1['Zip'][_0x8c8c2(0x20b)](_0x4b4211[_0x8c8c2(0x246)]),_0x291e1c=[];for(const _0x3390c4 in _0x24a497[_0x8c8c2(0x248)]){!_0x24a497[_0x8c8c2(0x248)][_0x3390c4][_0x8c8c2(0x227)]&&_0x291e1c['push']({'fileName':_0x3390c4,'body':await _0x24a497[_0x8c8c2(0x248)][_0x3390c4][_0x8c8c2(0x22b)](_0x8c8c2(0x1fb))});}const _0x13d4d4=await(0x0,extract_component_permissions_1[_0x8c8c2(0x230)])(_0x291e1c[0x0][_0x8c8c2(0x246)]['toString'](),_0x2f96f5,_0x4b4211[_0x8c8c2(0x20d)]),_0x3018fc=new xml2js_1[(_0x8c8c2(0x204))]({'xmldec':{'version':_0x8c8c2(0x210),'encoding':'UTF-8'}}),_0x54ee53=_0x3018fc[_0x8c8c2(0x213)](_0x13d4d4),_0x1af594=zip_1[_0x8c8c2(0x241)][_0x8c8c2(0x22d)]();_0x1af594[_0x8c8c2(0x1f7)](_0x291e1c[0x0][_0x8c8c2(0x224)],_0x54ee53),_0x4b4211['body']=await _0x1af594['generateAsync']({'type':'base64','compression':_0x8c8c2(0x225),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x18dd9d,_0x17c699,_0x4fe337){const _0x24c8e8=a85_0x1f736b;for(const _0x578092 of _0x4fe337){if(_0x18dd9d[_0x24c8e8(0x20c)](_0x4f66ce=>_0x4f66ce!==_0x578092[_0x24c8e8(0x20d)]))continue;const _0x2df0e8=await zip_1[_0x24c8e8(0x241)]['unzip'](_0x578092['body']);for(const _0x4ee173 in _0x2df0e8[_0x24c8e8(0x248)]){if(!_0x2df0e8[_0x24c8e8(0x248)][_0x4ee173][_0x24c8e8(0x227)]){let _0x1ca887=await _0x2df0e8['files'][_0x4ee173][_0x24c8e8(0x22b)](_0x24c8e8(0x1fb));for(const _0x227007 of Object[_0x24c8e8(0x1fd)](_0x17c699)){const _0x41352a=new RegExp('%%'+_0x227007+'%%','g');_0x1ca887=_0x1ca887[_0x24c8e8(0x1fa)](_0x41352a,_0x17c699[_0x227007]);}_0x2df0e8[_0x24c8e8(0x1f7)](_0x4ee173,_0x1ca887);}}_0x578092[_0x24c8e8(0x246)]=await _0x2df0e8[_0x24c8e8(0x201)]({'type':_0x24c8e8(0x242),'compression':_0x24c8e8(0x225),'compressionOptions':{'level':0x6}});}}async function writeZip(_0x101112,_0x30d619){const _0x30592d=a85_0x1f736b,_0x23e16b=new mdapi_1[(_0x30592d(0x24c))]({'components':_0x101112,'sourceDir':path_1['default']['join'](process['cwd'](),_0x30592d(0x229),_0x30d619,DEPLOY_DIR_NAME,_0x30592d(0x20a)),'skipChildErrors':![]});await _0x23e16b[_0x30592d(0x247)]();}async function generateAndWritePackageXML(_0x48db19,_0x503fe8,_0x5f2d80){const _0x183a18=a85_0x1f736b,_0x53bfeb=getComponentsTypeAndName(_0x48db19,_0x503fe8),_0xb07f01=[...new Set(_0x53bfeb['map'](_0x5d240f=>_0x5d240f[_0x183a18(0x249)]))],_0x2c52c3={'Package':{'$':{'xmlns':_0x183a18(0x20f)},'types':[],'version':''+constants_1[_0x183a18(0x237)][_0x183a18(0x215)](0x1)}};for(const _0x5a552a of _0xb07f01){const _0xc2478c=_0x53bfeb['filter'](_0x279d51=>_0x279d51[_0x183a18(0x249)]===_0x5a552a)['map'](_0x5ae48b=>_0x5ae48b[_0x183a18(0x1f2)]),_0x4f5071={'members':_0xc2478c,'name':_0x5a552a};_0x2c52c3[_0x183a18(0x1f9)][_0x183a18(0x216)][_0x183a18(0x22f)](_0x4f5071);}const _0x343cb6=new xml2js_1[(_0x183a18(0x204))]({'xmldec':{'version':_0x183a18(0x210),'encoding':'UTF-8'}}),_0x3e7fca=_0x343cb6[_0x183a18(0x213)](_0x2c52c3);await fs_internal_1['FS'][_0x183a18(0x235)](path_1[_0x183a18(0x20e)][_0x183a18(0x1f4)](process[_0x183a18(0x23b)](),_0x183a18(0x229),_0x5f2d80,DEPLOY_DIR_NAME,_0x183a18(0x20a),_0x183a18(0x202)),_0x3e7fca);}function getComponentsTypeAndName(_0x3e2c7a,_0x326de7){const _0x16ff29=a85_0x1f736b;return _0x3e2c7a[_0x16ff29(0x243)]((_0x3d6fbc,_0x52307d)=>{const _0x33617e=_0x16ff29,_0x2f067d=_0x326de7[_0x33617e(0x218)](_0x142c20=>_0x142c20['Id']===_0x52307d[_0x33617e(0x238)]);return _0x2f067d&&_0x3d6fbc[_0x33617e(0x22f)]({'name':_0x2f067d[_0x33617e(0x24b)]['Component_Name__c'],'type':_0x52307d[_0x33617e(0x244)]}),_0x3d6fbc;},[]);}async function saveDestructiveChanges(_0xeeb1e3,_0x2f7fc1,_0x4b969f,_0x4023f9){const _0x484ec4=a85_0x1f736b,_0x2ae1ac=(await(0x0,fetch_attachments_1[_0x484ec4(0x236)])(_0xeeb1e3,_0x2f7fc1))[_0x484ec4(0x205)]();await fs_internal_1['FS'][_0x484ec4(0x235)](path_1[_0x484ec4(0x20e)][_0x484ec4(0x1f4)](process[_0x484ec4(0x23b)](),_0x484ec4(0x229),_0x4023f9,DEPLOY_DIR_NAME,_0x484ec4(0x20a),_0x4b969f),_0x2ae1ac);}async function createDeployZip(_0x2c4dc1){const _0x5220bd=a85_0x1f736b,_0x40ef76=new adm_zip_1[(_0x5220bd(0x20e))]();return await _0x40ef76[_0x5220bd(0x21d)](path_1['default'][_0x5220bd(0x1f4)](process[_0x5220bd(0x23b)](),_0x5220bd(0x229),_0x2c4dc1,DEPLOY_DIR_NAME)),_0x40ef76;}async function insertZip(_0x35e834,_0x12a3ce,_0x321c94,_0x40b39c,_0x3dbb60){const _0xc03ac=a85_0x1f736b,_0x14152d={'ParentId':_0x12a3ce,'Name':_0xc03ac(0x24e)+_0x321c94,'Description':_0xc03ac(0x24e)+_0x40b39c,'Body':_0x3dbb60},{data:_0x26f253}=await _0x35e834[_0xc03ac(0x226)](_0xc03ac(0x214)+constants_1['SALESFORCE_API_VERSION']+_0xc03ac(0x21e),_0x14152d);return _0x26f253['id'];}