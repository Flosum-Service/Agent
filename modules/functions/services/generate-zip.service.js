const a86_0x4e81bd=a86_0x1005;(function(_0x5814fd,_0x533d8c){const _0x47df85=a86_0x1005,_0x34e0db=_0x5814fd();while(!![]){try{const _0x34e981=-parseInt(_0x47df85(0x114))/0x1*(parseInt(_0x47df85(0xe6))/0x2)+-parseInt(_0x47df85(0x11c))/0x3*(-parseInt(_0x47df85(0x11f))/0x4)+parseInt(_0x47df85(0xf8))/0x5+parseInt(_0x47df85(0x12a))/0x6*(parseInt(_0x47df85(0x102))/0x7)+parseInt(_0x47df85(0x111))/0x8+parseInt(_0x47df85(0xde))/0x9+-parseInt(_0x47df85(0x10c))/0xa;if(_0x34e981===_0x533d8c)break;else _0x34e0db['push'](_0x34e0db['shift']());}catch(_0x5ac452){_0x34e0db['push'](_0x34e0db['shift']());}}}(a86_0x38a4,0xe13e7));const a86_0x4d8401=(function(){let _0x16d78d=!![];return function(_0x2340cb,_0x25fdbc){const _0x363486=_0x16d78d?function(){const _0x5d37c1=a86_0x1005;if(_0x25fdbc){const _0x590a2f=_0x25fdbc[_0x5d37c1(0x10e)](_0x2340cb,arguments);return _0x25fdbc=null,_0x590a2f;}}:function(){};return _0x16d78d=![],_0x363486;};}()),a86_0x477573=a86_0x4d8401(this,function(){const _0xf4feb9=a86_0x1005;return a86_0x477573[_0xf4feb9(0x11b)]()[_0xf4feb9(0x126)](_0xf4feb9(0x131))['toString']()[_0xf4feb9(0xfe)](a86_0x477573)[_0xf4feb9(0x126)](_0xf4feb9(0x131));});a86_0x477573();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x154e0f){const _0x34946f=a86_0x1005;return _0x154e0f&&_0x154e0f[_0x34946f(0x110)]?_0x154e0f:{'default':_0x154e0f};};Object[a86_0x4e81bd(0xff)](exports,a86_0x4e81bd(0x110),{'value':!![]}),exports['generateAndDeployZip']=void 0x0;const constants_1=require('../../../constants'),path_1=__importDefault(require(a86_0x4e81bd(0xee))),extract_component_permissions_1=require(a86_0x4e81bd(0xe3)),xml2js_1=require(a86_0x4e81bd(0x128)),zip_1=require('../../git/parsers/utils/zip'),mdapi_1=require('../../git/parsers/mdapi'),fs_internal_1=require('../../git/internal/fs.internal'),promises_1=require('fs/promises'),components_api_1=require(a86_0x4e81bd(0x115)),adm_zip_1=__importDefault(require(a86_0x4e81bd(0x124))),uuid_1=require(a86_0x4e81bd(0x101)),fetch_attachments_1=require(a86_0x4e81bd(0xea)),DESTRUCTIVE_CHANGES_PER_NAME='destructiveChangesPre.xml',DESTRUCTIVE_CHANGES_POST_NAME=a86_0x4e81bd(0x105),DEPLOY_DIR_NAME=a86_0x4e81bd(0x10a);function a86_0x38a4(){const _0x5bc47b=['UTF-8','push','default','constructor','defineProperty','after\x20create\x20second\x20zip','uuid','721iLGfMK','generateAndDeployZip','reduce','destructiveChangesPost.xml','/sobjects/Attachment','Zip','dir','Package','DEPLOYZIP','MAX_ZIP_SIZE','49633940wbOiuK','body','apply','unzip','__esModule','14402760XjnfZx','fileType','Component__r','281KcdLpd','../utils/components-api','.temp','writeFile','package.xml','buildObject','splitZip','toString','9RBeENj','log','PermissionSet','1938588pGuNCJ','filter','join','file','http://soap.sforce.com/2006/04/metadata','adm-zip','/services/data/','search','Body','xml2js','type','28446nQWPMI','createZip','cwd','async','BUILD','after\x20create\x20zip','1.0','(((.+)+)+)+$','values','Builder','fetchAttachmentsDetailsById','base64','5813928truxGY','retrieveAttachments','then','MDApiWriter','src','../utils/extract-component-permissions','orgId','replace','52YNhGGo','addLocalFolder','ComponentsApi','ParentId','../../shared/utils/fetch-attachments','fetchComponentsDetailsByComponentsHistory','map','text','path','generateAsync','Name','post','exists','fileName','every','keys','SALESFORCE_API_VERSION','files','7523490abXINx','DEFLATE','name'];a86_0x38a4=function(){return _0x5bc47b;};return a86_0x38a4();}async function generateAndDeployZip({attachmentsId:_0x4a28a0,isExtractComponentsPermissions:_0x354c9e,preDestructiveAttachmentId:_0x3fc23b,postDestructiveAttachmentId:_0xde8e07,branchId:_0xf5c55d,credentials:_0x2f12f2,metadataLogId:_0x4411b6,environments:_0x26fb42,metaTypes:_0x3a3801},_0x46e83b){const _0x1369f6=a86_0x4e81bd,_0x3761e1=(0x0,uuid_1['v4'])();try{const _0x398756=await(0x0,fetch_attachments_1[_0x1369f6(0x134)])(_0x46e83b,_0x4a28a0),_0x1aa7ec=_0x398756[_0x1369f6(0x104)]((_0x3d32a3,_0x42b6a1)=>({..._0x3d32a3,[_0x42b6a1['Id']]:_0x42b6a1['Name']}),{}),_0x5b89bf=await getComponents(_0x398756,_0x46e83b,_0x1aa7ec),_0x57842e=await components_api_1[_0x1369f6(0xe8)][_0x1369f6(0xeb)](_0x46e83b,_0x398756['map'](({ParentId:_0x35d43b})=>_0x35d43b))['then'](_0x493e10=>components_api_1[_0x1369f6(0xe8)]['removeNamespacePrefix'](_0x493e10));if(_0x354c9e){const _0x491174=_0x5b89bf[_0x1369f6(0x120)](({fileType:_0x1b929d})=>_0x1b929d==='Profile'||_0x1b929d===_0x1369f6(0x11e));await removePermission(_0x491174,_0x57842e);}await replaceEnvironments(_0x3a3801,_0x26fb42,_0x5b89bf),await writeZip(_0x5b89bf,_0x3761e1),await generateAndWritePackageXML(_0x398756,_0x57842e,_0x3761e1);_0x3fc23b&&await saveDestructiveChanges(_0x46e83b,_0x3fc23b,DESTRUCTIVE_CHANGES_PER_NAME,_0x3761e1);_0xde8e07&&await saveDestructiveChanges(_0x46e83b,_0xde8e07,DESTRUCTIVE_CHANGES_POST_NAME,_0x3761e1);const _0x3e8485=(await createDeployZip(_0x3761e1)['then'](_0x5bf307=>{return _0x5bf307;}))['toBuffer']()['toString'](_0x1369f6(0x135));console[_0x1369f6(0x11d)](_0x1369f6(0x12f));const _0x28f17b=_0x3e8485['length'];if(_0x28f17b>=components_api_1[_0x1369f6(0x10b)]){const _0x4d9f56=await createDeployZip(_0x3761e1);console['log'](_0x1369f6(0x100));const [_0x33e9b4,_0x19c426]=await components_api_1[_0x1369f6(0xe8)][_0x1369f6(0x11a)](_0x4d9f56,_0x28f17b),_0x575794=await insertZip(_0x46e83b,_0xf5c55d,_0x2f12f2['orgId'],_0x4411b6,_0x33e9b4['toBuffer']()[_0x1369f6(0x11b)](_0x1369f6(0x135))),_0x2464d8=await insertZip(_0x46e83b,_0xf5c55d,_0x2f12f2[_0x1369f6(0xe4)],_0x4411b6,_0x19c426['toBuffer']()['toString'](_0x1369f6(0x135)));return _0x575794+','+_0x2464d8;}else return await insertZip(_0x46e83b,_0xf5c55d,_0x2f12f2['orgId'],_0x4411b6,_0x3e8485);}catch(_0x2423d4){throw _0x2423d4;}finally{if(await fs_internal_1['FS'][_0x1369f6(0xf2)](path_1[_0x1369f6(0xfd)]['join'](process[_0x1369f6(0x12c)](),_0x1369f6(0x116),_0x3761e1)))await(0x0,promises_1['rm'])(path_1[_0x1369f6(0xfd)][_0x1369f6(0x121)](process['cwd'](),_0x1369f6(0x116),_0x3761e1),{'recursive':!![]});}}exports[a86_0x4e81bd(0x103)]=generateAndDeployZip;async function getComponents(_0x43f0aa,_0x2811e7,_0x3dbf6d){const _0x84409f=a86_0x4e81bd,_0x28f65a=[],_0xad3b80=await(0x0,fetch_attachments_1[_0x84409f(0xdf)])(_0x43f0aa,_0x2811e7);return await getComponentFromZip(_0xad3b80,_0x3dbf6d)[_0x84409f(0xe0)](_0x13b19c=>{const _0xd74601=_0x84409f;_0x28f65a[_0xd74601(0xfc)](..._0x13b19c);}),_0x28f65a;}async function getComponentFromZip(_0x5f07ea,_0x307171){const _0x24dd0b=a86_0x4e81bd,_0x134c10=[];for(const _0x1f07dd of _0x5f07ea){const _0x306b2f=await zip_1[_0x24dd0b(0x107)][_0x24dd0b(0x10f)](_0x1f07dd['values'][_0x24dd0b(0x127)]);for(const _0x4f399e in _0x306b2f[_0x24dd0b(0xf7)]){!_0x306b2f[_0x24dd0b(0xf7)][_0x4f399e][_0x24dd0b(0x108)]&&_0x134c10[_0x24dd0b(0xfc)]({'fileName':_0x4f399e['substring'](_0x4f399e['indexOf']('/')+0x1),'fileType':_0x307171[_0x1f07dd['id']],'body':_0x1f07dd[_0x24dd0b(0x132)][_0x24dd0b(0x127)]});}}return _0x134c10;}async function removePermission(_0x225aa5,_0xdb7558){const _0x1ef953=a86_0x4e81bd;for(const _0x1598b2 of _0x225aa5){const _0x303d02=await zip_1[_0x1ef953(0x107)][_0x1ef953(0x10f)](_0x1598b2['body']),_0x26b657=[];for(const _0x45be5f in _0x303d02[_0x1ef953(0xf7)]){!_0x303d02[_0x1ef953(0xf7)][_0x45be5f][_0x1ef953(0x108)]&&_0x26b657[_0x1ef953(0xfc)]({'fileName':_0x45be5f,'body':await _0x303d02[_0x1ef953(0xf7)][_0x45be5f]['async'](_0x1ef953(0xed))});}const _0x456ea4=await(0x0,extract_component_permissions_1['extractComponentPermissions'])(_0x26b657[0x0]['body'][_0x1ef953(0x11b)](),_0xdb7558,_0x1598b2['fileType']),_0x93e686=new xml2js_1[(_0x1ef953(0x133))]({'xmldec':{'version':'1.0','encoding':_0x1ef953(0xfb)}}),_0x176477=_0x93e686[_0x1ef953(0x119)](_0x456ea4),_0x3e6511=zip_1[_0x1ef953(0x107)][_0x1ef953(0x12b)]();_0x3e6511[_0x1ef953(0x122)](_0x26b657[0x0][_0x1ef953(0xf3)],_0x176477),_0x1598b2[_0x1ef953(0x10d)]=await _0x3e6511[_0x1ef953(0xef)]({'type':_0x1ef953(0x135),'compression':_0x1ef953(0xf9),'compressionOptions':{'level':0x6}});}}async function replaceEnvironments(_0x4940bd,_0x4e6f25,_0x4fb713){const _0x2159e8=a86_0x4e81bd;for(const _0x4137ea of _0x4fb713){if(_0x4940bd[_0x2159e8(0xf4)](_0x2e57f7=>_0x2e57f7!==_0x4137ea[_0x2159e8(0x112)]))continue;const _0x28cbf2=await zip_1[_0x2159e8(0x107)][_0x2159e8(0x10f)](_0x4137ea[_0x2159e8(0x10d)]);for(const _0x1bd43d in _0x28cbf2[_0x2159e8(0xf7)]){if(!_0x28cbf2[_0x2159e8(0xf7)][_0x1bd43d][_0x2159e8(0x108)]){let _0x527396=await _0x28cbf2[_0x2159e8(0xf7)][_0x1bd43d][_0x2159e8(0x12d)](_0x2159e8(0xed));for(const _0xa81fa6 of Object[_0x2159e8(0xf5)](_0x4e6f25)){const _0x16aa32=new RegExp('%%'+_0xa81fa6+'%%','g');_0x527396=_0x527396[_0x2159e8(0xe5)](_0x16aa32,_0x4e6f25[_0xa81fa6]);}_0x28cbf2[_0x2159e8(0x122)](_0x1bd43d,_0x527396);}}_0x4137ea['body']=await _0x28cbf2[_0x2159e8(0xef)]({'type':_0x2159e8(0x135),'compression':_0x2159e8(0xf9),'compressionOptions':{'level':0x6}});}}function a86_0x1005(_0x3bc070,_0x494ab9){const _0x787717=a86_0x38a4();return a86_0x1005=function(_0x477573,_0x4d8401){_0x477573=_0x477573-0xde;let _0x38a479=_0x787717[_0x477573];return _0x38a479;},a86_0x1005(_0x3bc070,_0x494ab9);}async function writeZip(_0x2dc8b9,_0x491b27){const _0x1ff0f9=a86_0x4e81bd,_0x12b4a8=new mdapi_1[(_0x1ff0f9(0xe1))]({'components':_0x2dc8b9,'sourceDir':path_1[_0x1ff0f9(0xfd)][_0x1ff0f9(0x121)](process[_0x1ff0f9(0x12c)](),'.temp',_0x491b27,DEPLOY_DIR_NAME,_0x1ff0f9(0xe2)),'skipChildErrors':![]});await _0x12b4a8['start']();}async function generateAndWritePackageXML(_0x2a9e45,_0x14a65d,_0x39378f){const _0x53f915=a86_0x4e81bd,_0x2765ea=getComponentsTypeAndName(_0x2a9e45,_0x14a65d),_0x11d367=[...new Set(_0x2765ea[_0x53f915(0xec)](_0x320dc0=>_0x320dc0['type']))],_0x57b96b={'Package':{'$':{'xmlns':_0x53f915(0x123)},'types':[],'version':''+constants_1[_0x53f915(0xf6)]['substring'](0x1)}};for(const _0x390dec of _0x11d367){const _0x277a6f=_0x2765ea[_0x53f915(0x120)](_0x5b1004=>_0x5b1004[_0x53f915(0x129)]===_0x390dec)['map'](_0x2c5069=>_0x2c5069[_0x53f915(0xfa)]),_0x233694={'members':_0x277a6f,'name':_0x390dec};_0x57b96b[_0x53f915(0x109)]['types'][_0x53f915(0xfc)](_0x233694);}const _0x43885b=new xml2js_1[(_0x53f915(0x133))]({'xmldec':{'version':_0x53f915(0x130),'encoding':_0x53f915(0xfb)}}),_0x52cee0=_0x43885b['buildObject'](_0x57b96b);await fs_internal_1['FS'][_0x53f915(0x117)](path_1[_0x53f915(0xfd)][_0x53f915(0x121)](process[_0x53f915(0x12c)](),'.temp',_0x39378f,DEPLOY_DIR_NAME,'src',_0x53f915(0x118)),_0x52cee0);}function getComponentsTypeAndName(_0x3f02df,_0x19c361){const _0x4051ec=a86_0x4e81bd;return _0x3f02df[_0x4051ec(0x104)]((_0x51039f,_0x11aa45)=>{const _0x567a06=_0x4051ec,_0x557f9c=_0x19c361['find'](_0x3ebd7c=>_0x3ebd7c['Id']===_0x11aa45[_0x567a06(0xe9)]);return _0x557f9c&&_0x51039f[_0x567a06(0xfc)]({'name':_0x557f9c[_0x567a06(0x113)]['Component_Name__c'],'type':_0x11aa45[_0x567a06(0xf0)]}),_0x51039f;},[]);}async function saveDestructiveChanges(_0x348ff9,_0x5299a0,_0x2ca2ad,_0xb8d525){const _0x57fb4f=a86_0x4e81bd,_0x3af5b5=(await(0x0,fetch_attachments_1['fetchAttachmentBody'])(_0x348ff9,_0x5299a0))[_0x57fb4f(0x11b)]();await fs_internal_1['FS'][_0x57fb4f(0x117)](path_1[_0x57fb4f(0xfd)][_0x57fb4f(0x121)](process[_0x57fb4f(0x12c)](),_0x57fb4f(0x116),_0xb8d525,DEPLOY_DIR_NAME,_0x57fb4f(0xe2),_0x2ca2ad),_0x3af5b5);}async function createDeployZip(_0x1a73fe){const _0x28d64a=a86_0x4e81bd,_0x2acc66=new adm_zip_1[(_0x28d64a(0xfd))]();return await _0x2acc66[_0x28d64a(0xe7)](path_1[_0x28d64a(0xfd)][_0x28d64a(0x121)](process[_0x28d64a(0x12c)](),_0x28d64a(0x116),_0x1a73fe,DEPLOY_DIR_NAME)),_0x2acc66;}async function insertZip(_0x18aa65,_0x262810,_0x418351,_0x217908,_0x525b78){const _0x2f953a=a86_0x4e81bd,_0x1c2efc={'ParentId':_0x262810,'Name':_0x2f953a(0x12e)+_0x418351,'Description':_0x2f953a(0x12e)+_0x217908,'Body':_0x525b78},{data:_0x2274ca}=await _0x18aa65[_0x2f953a(0xf1)](_0x2f953a(0x125)+constants_1[_0x2f953a(0xf6)]+_0x2f953a(0x106),_0x1c2efc);return _0x2274ca['id'];}